# 系统架构设计

> **文档版本**: v3.1.0
> **最后更新**: 2025-07-10

## 1. 架构总览

本系统采用分层微服务架构，核心组件包括：

- **pingora-proxy**：高性能API网关，统一入口。
- **oauth-service**：认证授权API服务，实现OAuth2.1、OIDC、RBAC，仅提供API，不渲染任何页面。
- **admin-portal**：管理后台+认证中心UI，负责所有认证相关页面（登录、同意、错误等），与oauth-service配合完成完整认证授权流程。
- **packages/**：共享数据库、UI组件、工具库。

## 2. 页面与API分工

- **oauth-service 只提供API，不渲染页面**：
  - 包括 /authorize、/token、/userinfo、/consent 等所有OAuth2.1相关端点，均为API接口。
  - 任何需要用户交互的场景（如未登录、同意授权、错误提示等），oauth-service应重定向到admin-portal提供的对应页面（如 /auth/login、/oauth/consent、/error），并带上必要的query参数。

- **admin-portal 作为认证中心UI，负责所有认证相关页面**：
  - 实现 /auth/login（登录）、/oauth/consent（同意授权）、/error（错误提示）等页面。
  - 根据oauth-service传递的参数渲染页面，收集用户输入/同意后再调用oauth-service API完成后续流程。
  - 兼容管理后台与认证中心UI双重角色。

## 3. 服务协作流程

1. 用户访问受保护资源，跳转到oauth-service /authorize。
2. oauth-service发现未登录，重定向到admin-portal /auth/login。
3. 登录后，admin-portal回调oauth-service继续授权流程。
4. 需要同意授权时，oauth-service重定向到admin-portal /oauth/consent。
5. 用户同意/拒绝后，admin-portal回调oauth-service API。
6. oauth-service完成token颁发等后续流程。

## 4. 其它架构要点

- **安全机制**：详见详细设计文档。
- **权限模型**：RBAC，详见权限设计文档。
- **数据库模型**：详见数据库设计文档。
- **API规范**：详见API设计规范。

---

> 本文档已同步最新架构分工，确保oauth-service与admin-portal解耦协作，admin-portal负责所有认证相关页面体验。