# 系统架构设计

**文档版本**: v3.1.0
**创建日期**: 2025-01-28
**最后更新**: 2025-07-07
**作者**: 系统架构师
**状态**: 正式版

## 1. 概述

本文档描述了基于 **Turborepo** 的 **OAuth2.1 认证授权中心与微服务平台**的系统架构。该架构旨在提供一个安全、高可用、可扩展的企业级身份解决方案。

## 2. 技术栈核心

- **Monorepo 管理**: Turborepo
- **包管理器**: PNPM
- **前端框架**: Next.js 15, React 19
- **后端框架**: Next.js (API Routes), Node.js
- **开发语言**: TypeScript 5
- **API 网关**: Rust, Pingora
- **数据库与 ORM**: Prisma 6, MySQL/SQLite
- **认证与安全**: OAuth 2.1, OIDC, JWT (jose), bcrypt
- **测试**: Jest, Playwright
- **部署**: Docker, Kubernetes (K8s)

*详细的版本信息请参考 [技术栈版本对照表-2025-07-08.md](../技术栈版本对照表-2025-07-08.md)。*

## 3. 宏观架构

系统采用分层架构，包括 **API网关层**、**微服务应用层** 和 **共享包层**，所有这些都在一个 Turborepo 管理的 Monorepo 中。

```mermaid
graph TD
    subgraph "外部用户与系统"
        U[🌐 最终用户]
        C[📱 第三方客户端应用]
        M[📊 监控系统<br/>(Prometheus/Grafana)]
    end

    subgraph "项目架构"
        subgraph "Gateway Layer (API 网关层)"
            GW["🚀 pingora-proxy<br/>统一入口、路由、认证、限流"]
        end

        subgraph "Apps Layer (微服务应用层)"
            OAUTH["🔐 oauth-service<br/>认证授权核心"]
            ADMIN["🎛️ admin-portal<br/>系统管理后台"]
            KLINE["📈 kline-service<br/>K线图表服务"]
            FLOW["🔄 flow-service<br/>可视化流程引擎"]
            TEST["🧪 test-service<br/>测试与示例服务"]
        end

        subgraph "Packages Layer (共享包层)"
            UI["@repo/ui<br/>UI组件库"]
            LIB["@repo/lib<br/>核心逻辑与安全库"]
            DB_PKG["@repo/database<br/>数据库(Prisma)"]
            CONFIGS["@repo/config/*<br/>ESLint, TSConfig等"]
        end

        subgraph "Data & Infrastructure (数据与基础设施)"
            DB[("🗄️ 数据库<br/>MySQL/SQLite")]
        end
    end

    %% 流量与依赖关系
    U --> GW
    C --> GW
    GW --> OAUTH
    GW --> ADMIN
    GW --> KLINE
    GW --> FLOW
    GW --> TEST

    OAUTH --- LIB & DB_PKG
    ADMIN --- UI & LIB & DB_PKG
    KLINE --- LIB
    FLOW --- LIB
    TEST --- LIB & DB_PKG

    DB_PKG --> DB

    GW --> M
    OAUTH --> M
    ADMIN --> M

    %% 样式
    classDef gatewayNode fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef appNode fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef pkgNode fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dataNode fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px

    class GW gatewayNode
    class OAUTH,ADMIN,KLINE,FLOW,TEST appNode
    class UI,LIB,DB_PKG,CONFIGS pkgNode
    class DB,M,U,C dataNode
```

## 4. 服务详细说明

### 4.1. `pingora-proxy` (API 网关)

- **职责**: 作为整个系统的统一入口，负责请求路由、负载均衡、SSL终止和初步的认证拦截。
- **技术**: 基于 Rust 和 Pingora 构建，保证高性能和高并发处理能力。
- **认证流程**:
    1.  拦截传入请求，提取 `Authorization: Bearer` 头中的 JWT。
    2.  **不直接验证令牌**，而是将令牌验证的职责委托给 `oauth-service`。
    3.  可以将验证过的用户信息（如用户ID）注入到转发给下游服务的请求头中。
- **监控**: 暴露 Prometheus 指���，用于监控请求延迟、状态码和上游服务健康状况。

### 4.2. `oauth-service` (认证授权核心)

- **职责**: 实现完整的 OAuth 2.1 和 OIDC 协议，是系统的安全基石。
- **核心功能**:
    - **用户认证**: 处理用户登录请求。
    - **令牌颁发**: 颁发、刷新和撤销 JWT（访问令牌和刷新令牌）。
    - **客户端管理**: 管理注册的第三方应用。
    - **权限管理**: 提供 RBAC 相关的 API。
    - **元数据发布**: 通过 `/.well-known/jwks.json` 发布公钥。
- **API**: 详细的 API 端点请参考 [OAuth 服务 API 索引](../oauth-service-api-index.md)。

### 4.3. `admin-portal` (系统管理后台)

- **职责**: 为系统管理员提供一个可视化的管理界面。
- **核心功能**: 用户管理、角色与权限分配、客户端应用配置、查看审计日志等。
- **认证**: 本身作为一个 OAuth 客户端，通过 `oauth-service` 进行登录认证，并使用获取的 JWT 访问受保护的 API。

### 4.4. 其他业务服务 (`kline-service`, `flow-service`)

- **职责**: 实现具体的业务逻辑。
- **认证**: 作为资源服务器，依赖 `pingora-proxy` 和 `oauth-service` 提供的认证信息。它们通过验证请求头中的 JWT 来保护自己的 API 端点。

## 5. 共享包 (`packages/*`) 架构

- **`@repo/ui`**: 统一的 React UI 组件库，基于 `shadcn/ui` 和 `TailwindCSS`，确保所有前端应用界面风格一致。
- **`@repo/lib`**: 核心共享库。
    - **安全模块**: 封装了密码哈希 (`bcrypt`)、JWT处理 (`jose`)、密码策略验证 (`zod`) 等所有核心安全逻辑。**所有应用都必须通过此包消费安全能力**。
    - **工具函数**: 提供跨应用复用的通用工具。
- **`@repo/database`**: 统一的数据库访问层，使用 Prisma 定义数据模型（Schema）并管理数据库迁移。
- **`@repo/config/*`**: 集中管理整个项目的开发配置，如 ESLint、TypeScript、Prettier 等，确保代码质量和风格的一致性。

## 6. 安全设计核心

- **认证机制**: 严格遵循 **OAuth 2.1** 和 **OIDC** 标准，强制所有公共客户端使用 **PKCE**。
- **令牌安全**:
    - **签名**: JWT 使用 **RS256** 非对称加密算法签名，公钥通过 `jwks.json` 端点动态发布。
    - **生命周期**: 访问令牌生命周期短（如15分钟），刷新令牌生命周期长（如30天），并支持令牌撤销。
- **密码安全**:
    - **存储**: 使用 `bcrypt` 对密码进行加盐哈希。
    - **策略**: 强制执行密码复杂度策略，并防止密码重用。
- **访问控制**: 实现细粒度的 **RBAC** 模型，遵循最小��限原则。
- **传输安全**: 在生产环境中强制使用 **HTTPS**。

## 7. 服务间通信

- **同步通信**: 主要通过 RESTful API 进行。服务间的调用也需要携带由 `oauth-service` 签发的 JWT 进行认证。
- **异步通信**: 对于审计日志记录、事件通知等非核心路径操作，未来可以引入消息队列（如 RabbitMQ 或 Kafka）来解耦服务，提高系统的弹性和性能。

---