# 管理页面详细设计文档

> **文档版本**: v8.0.0  
> **创建日期**: 2025-07-08
> **最后更新**: 2025-07-17  
> **文档状态**: 正式版 - 适配OAuth 2.1 + OIDC架构  
> **维护团队**: 前端团队

## 1. 概述

本文档为 `admin-portal`（管理后台 + OAuth客户端）提供了一份全面的、可直接用于开发的详细设计说明。基于最新的OAuth 2.1 + OIDC架构，admin-portal同时承担两个角色：

- **OAuth客户端**：client_id="admin-portal"，通过标准PKCE流程获取访问令牌
- **认证中心UI**：提供所有认证相关页面（登录、授权同意、错误处理）

文档整合了无状态JWT架构、PKCE强制要求、JWKS密钥轮换等生产级安全特性。

## 2. 前端技术与数据流架构

为保证与项目现有实践一致，所有页面开发必须遵循以下技术架构：

### 2.1 认证架构集成

- **OAuth 2.1客户端**: admin-portal作为标准OAuth客户端，client_id="admin-portal"
- **PKCE实现**: 所有授权码流程必须实现PKCE (code_challenge + code_verifier)
- **无状态JWT**: 不依赖服务器session，令牌存储在浏览器localStorage
- **令牌生命周期**: Access Token 15分钟，Refresh Token 30天
- **JWKS集成**: 通过/.well-known/jwks.json动态验证JWT签名

### 2.2 核心技术栈

- **核心技术**: Next.js 15, React 19, Tailwind CSS, **shadcn/ui**
- **认证库**: 自定义OAuth客户端库，支持PKCE和令牌刷新
- **状态管理**:
  - **服务端状态**: 使用 **`@tanstack/react-query`** 管理所有与API交互的数据
  - **客户端状态**: 使用 **`Zustand`** 管理全局UI状态和认证状态
  - **认证状态**: 使用 **`useAuth`** 钩子管理JWT令牌、用户权限、登录状态
- **表单处理**: 使用 **`react-hook-form`** + **`zod`** 进行类型安全验证
- **表格处理**: 使用 **`@tanstack/react-table`** 构建可复用数据表格

### 2.3 数据流架构

基于OAuth 2.1的单向数据流：

1. **认证检查**: 每个受保护页面加载时检查JWT有效性
2. **令牌刷新**: 自动使用refresh_token获取新的access_token
3. **权限验证**: 从JWT中解析用户权限信息
4. **API调用**: 所有API请求携带Bearer Token
5. **错误处理**: 401错误触发重新认证流程

### 2.4 安全存储策略

- **access_token**: 存储在localStorage，15分钟有效期
- **refresh_token**: 存储在localStorage，30天有效期
- **权限缓存**: 从JWT中提取的权限信息缓存在内存中
- **CSRF防护**: 使用state参数防止CSRF攻击

---

## 3. 核心功能页面详细设计

### 3.1 用户管理 (`/admin/users`)

- **功能概述**: 提供对系统所有用户的增删改查（CRUD）功能，并能为用户分配角色。
- **数据实体与字段**:
  - **主要实体**: `User`, `Role`
  - **表格展示字段**: `username`, `displayName`, `organization`, `department`, `isActive`, `createdAt`。
  - **表单字段 (创建)**: `username`, `password`, `displayName`, `organization`, `department`, `isActive`, `mustChangePassword`。
  - **表单字段 (编辑)**: `displayName`, `organization`, `department`, `isActive`, `mustChangePassword`。`username` 在编辑时为只读。
- **核心API端点**:
  - `GET /api/v2/users`: 获取用户列表。
  - `POST /api/v2/users`: 创建新用户。
  - `GET /api/v2/users/{id}`: 获取单个用户详情（包括其角色）。
  - `PUT /api/v2/users/{id}`: 更新用户信息。
  - `DELETE /api/v2/users/{id}`: 删除用户。
  - `GET /api/v2/roles`: 获取所有可用角色列表，用于分配。
  - `PUT /api/v2/users/{id}/roles`: 为用户批量更新角色。
- **所需权限**:
  - **页面访问**: `menu:system:user:view`
  - **查看列表**: `user:list`
  - **创建用户**: `user:create`
  - **编辑用户**: `user:update`
  - **删除用户**: `user:delete`
  - **分配角色**: `user:manage_roles` (建议新增此权限以实现更细粒度控制)
- **搜索与过滤字段**:
  - **全局搜索**: `username`, `displayName`。
  - **过滤**: `isActive` (激活/禁用), `organization` (组织)。
- **表单校验规则 (使用 `zod`)**:
  - `username`: 必填，3-20个字符，仅限字母、数字、下划线。
  - `password`: 必填（仅创建时），满足 `@repo/lib` 中定义的密码复杂度策略。
  - `displayName`: 必填，2-50个字符。
- **主要交互与组件**:
  - `UserDataTable`: 基于通用 `DataTable` 组件实现，包含搜索、过滤和操作列（编辑、删除、分配角色）。
  - `UserFormDialog`: 用于创建和编辑用户的弹窗。在编辑模式下，包含一个**角色分配组件**（如多选下拉框），数据源为 `GET /api/v2/roles`。
  - `DeleteConfirmationDialog`: 删除用户前显示认对话框。
- **操作用例**:
  1.  **创建用户**: 管理员点击“创建用户”，在弹窗中填写信息，提交后列表刷新。
  2.  **编辑用户角色**: 管理员在用户行点击“编辑”，在弹窗中修改用户的角色分配，保存后生效。
  3.  **搜索用户**: 管理员在搜索框输入 "john"，表格中只显示用户名或显示名称包含 "john" 的用户。

### 3.2 角色管理 (`/admin/system/roles`)

- **功能概述**: 提供对角色及其关联权限的增删改查功能。
- **数据实体与字段**:
  - **主要实体**: `Role`, `Permission`
  - **表格展示字段**: `name`, `displayName`, `isSystemRole`, `isActive`。
  - **表单字段**: `name` (创建时), `displayName`, `isActive`。`name` 在编辑时为只读。
- **核心API端点**:
  - `GET /api/v2/roles`: 获取角色列表。
  - `POST /api/v2/roles`: 创建新角色。
  - `PUT /api/v2/roles/{id}`: 更新角色信息。
  - `DELETE /api/v2/roles/{id}`: 删除角色（系统角色 `isSystemRole=true` 不可删除）。
  - `GET /api/v2/permissions`: 获取所有权限点列表。
  - `GET /api/v2/roles/{id}/permissions`: 获取指定角色已拥有的权限。
  - `POST /api/v2/roles/{id}/permissions`: 为角色批量分配权限。
- **所需权限**:
  - **页面访问**: `menu:system:role:view`
  - **查看列表**: `role:list`
  - **创建角色**: `role:create`
  - **编辑角色**: `role:update`
  - **删除角色**: `role:delete`
  - **分配权限**: `roles:permissions:assign`
- **搜索与过滤字段**:
  - **全局搜索**: `name`, `displayName`。
- **表单校验规则 (使用 `zod`)**:
  - `name`: 必填，3-30个字符，大写字母和下划线 (e.g., `USER_ADMIN`)。
  - `displayName`: 必填，2-50个字符。
- **主要交互与组件**:
  - `RoleDataTable`: 展示角色列表。系统角色的“删除”按钮应被禁用。
  - `RoleFormDialog`: 创建和编辑角色的弹窗。
  - `PermissionAssignment`: 一个核心组件，通常在编辑角色的弹窗内。它会获取所有权限 (`GET /api/v2/permissions`)，并以树形或分组列表（按 `resource` 分组）展示，使用复选框进行选择。
- **操作用例**:
  1.  **编辑权限**: 管理员点击“安全管理员”角色的“编辑权限”按钮，在弹窗中看到按“用户管理”、“角色管理”等资源分组的权限树，勾选 `user:delete` 权限并保存。

### 3.3 客户端管理 (`/admin/system/clients`)

- **功能概述**: 管理所有接入本认证中心的OAuth客户端应用。
- **数据实体与段**:
  - **主要实体**: `OAuthClient`
  - **表格展示字段**: `clientId`, `clientType`, `redirectUris`。
  - **表单字段**: `clientId` (创建时可自动生成), `clientSecret` (创建后显示一次), `clientType`, `redirectUris` (可动态增删的输入框列表), `allowedScopes` (多选), `grantTypes` (多选), `requirePkce`。
- **核心API端点**:
  - `GET /api/v2/clients`: 获取客户端列表。
  - `POST /api/v2/clients`: 创建新客户端。
  - `PUT /api/v2/clients/{id}`: 更新客户端。
  - `DELETE /api/v2/clients/{id}`: 删除客户端。
  - `POST /api/v2/clients/{id}/secret`: 重置客户端密钥。
- **所需权限**:
  - **页面访问**: `menu:system:client:view`
  - **查看列表**: `client:list`
  - **创建客户端**: `client:create`
  - **编辑客户端**: `client:update`
  - **删除客户端**: `client:delete`
  - **重置密钥**: `oauth:clients:manage`
- **搜索与过滤字段**:
  - **全局搜索**: `clientId`。
- **表单校验规则 (使用 `zod`)**:
  - `redirectUris`: 必填，且必须是合法的 HTTPS URI。
  - `allowedScopes`: 必填，至少选择一个。
- **主要交互与组件**:
  - `ClientDataTable`: 展示客户端列表。
  - `ClientFormDialog`: 创建和编辑客户端的窗。
  - `RotateSecretDialog`: 点击“重置密钥”后，调用API，然后在弹窗中**仅显示一次**新生成的 `clientSecret`，并提供一个“复制”按钮。
- **操作用例**:
  1.  **创建新客户端**: 管理员点击“创建客户端”，填写重定向URI，选择授权类型为 `authorization_code` 和 `refresh_token`，保存后系统生成 `clientId` 和 `clientSecret` 并显示给管理员。

### 客户端管理 UI 字段支持说明

- allowedScopes 字段已支持，前端表单和 API 交互均已覆盖。
- requirePkce 字段尚未在 UI 层暴露，建议补充“Require PKCE”开关，并在 API payload 中传递 requirePkce 字段，确保前后端一致。

### 3.4 审计日志 (`/admin/system/audits`)

- **功能概述**: 查看系统记录的所有关键操作日志，用于安全审计和问题排查。

### 3.5 认证相关页面设计

#### 3.5.1 登录页面 (`/auth/login`)

- **功能概述**: OAuth 2.1授权流程的登录入口，作为认证中心UI的一部分
- **页面路径**: `/auth/login`
- **URL参数**:
  - `redirect_uri`: 认证成功后重定向的地址
  - `state`: CSRF防护参数
  - `scope`: 请求的权限范围
- **UI元素**:
  - 用户名输入框
  - 密码输入框
  - 登录按钮
  - 错误提示区域
  - 忘记密码链接
- **OAuth 2.1集成流程**:
  1. 用户从未认证状态访问受保护资源
  2. oauth-service重定向到 `/auth/login` 并携带授权参数
  3. 用户输入凭据并提交
  4. 验证成功后重定向回oauth-service继续授权流程
  5. 最终携带授权码重定向到原始redirect_uri
- **API端点**:
  - `POST /api/v2/auth/login` (oauth-service内部使用)

#### 3.5.2 OAuth授权同意页面 (`/oauth/consent`)

- **功能概述**: 用户登录后，确认admin-portal作为OAuth客户端请求的权限范围
- **页面路径**: `/oauth/consent`
- **URL参数**:
  - `client_id`: 固定为"admin-portal"
  - `scope`: 请求的权限列表（如"openid profile admin:read"）
  - `state`: OAuth state参数
- **UI元素**:
  - 客户端信息展示（admin-portal自身信息）
  - 请求的权限范围详细说明
  - 授权同意/拒绝按钮
  - 用户当前登录状态提示
- **权限展示**:
  - 每个scope的详细描述和图标
  - 权限级别可视化（读取/写入/管理等）
- **交互流程**:
  1. 用户登录成功后自动跳转
  2. 显示admin-portal请求的权限详情
  3. 用户确认后调用oauth-service API完成授权
  4. 成功后重定向到回调地址

#### 3.5.3 认证错误页面 (`/auth/error`)

- **功能概述**: 统一处理OAuth认证过程中的各种错误情况
- **页面路径**: `/auth/error`
- **URL参数**:
  - `error`: 错误类型（invalid_client, access_denied, invalid_scope等）
  - `error_description`: 详细错误描述
  - `error_uri`: 可选的错误文档链接
- **UI元素**:
  - 错误图标和状态码
  - 用户友好的错误消息
  - 返回登录按钮
  - 联系管理员提示
- **错误场景覆盖**:
  - 无效客户端配置
  - 用户拒绝授权
  - 权限范围冲突
  - 令牌过期或无效
- **数据实体与字段**:
  - **主要实体**: `AuditLog`
  - **表格展示字段**: `timestamp`, `userId`, `action`, `resourceType`, `status`, `ipAddress`。
- **核心API端点**: `GET /api/v2/audit-logs`。
- **所需权限**:
  - **页面访问**: `menu:system:audit:view`
  - **查看列表**: `audit:list`
- **搜索与过滤字段**:
  - **过滤**: `userId` (可输入用户ID或名称搜索), `action`, `resourceType`, `status` (成功/失败), `timestamp` (日期范围选择器)。
- **主要交互与组件**:
  - `AuditLogDataTable`: 展示审计日志列表。
  - `AuditLogFilterBar`: 一个包含多个输入框和下拉选择框的过滤栏，用于按上述字段进行精确筛选。
  - `LogDetailsView`: 点击某条日志的“详情”按钮，弹窗或在侧边栏显示其完整的 `details` JSON内容，并进行格式化展示。
- **操作用例**:
  1.  **追踪失败登录**: 管理员在过滤栏中选择 `action` 为 `user:login`，`status` 为 `failure`，并选择过去24小时的日期范围，以查看所有失败的登录尝试。

### 用户信息接口返回结构说明

- 接口路径：GET /api/v2/users/me
- 返回字段：
  - id: string
  - username: string
  - displayName: string
  - organization: string
  - department: string
  - isActive: boolean
  - mustChangePassword: boolean
  - createdAt: string
  - updatedAt: string
  - permissions: string[]
- 说明：permissions 字段为当前用户所有去重后的权限点名，便于前端权限校验与动态渲染。

### API 错误码说明

- 400 Bad Request：参数校验失败、请求格式错误
- 401 Unauthorized：未认证或认证信息无效
- 403 Forbidden：无权限访问
- 404 Not Found：资源不存在
- 409 Conflict：资源冲突（如唯一键冲突）
- 500 Internal Server Error：服务器内部错误

---

## 4. 通用组件设计

- **`PermissionGuard`**:
  - **实现**: 一个高阶组件（HOC）或自定义钩子 (`usePermission`)。
  - **逻辑**: 接收一个或多个权限点字符串（如 `user:create`）。组件内部从用户状态（Zustand/React Query）中获取当前用户的权限列表，进行比对。
  - **用途**:
    - 包裹页面级组件，无权限则显示403页面。
    - 包裹按钮等操作元素，无权限则不渲染该元素。
- **`DataTable`**:
  - **实现**: 基于 `@tanstack/react-table` 的可复用表格组件。
  - **Props**: 接收 `columns` 定义、`data`、分页状态、排序状态等。
  - **功能**: 内置分页控件、列表头排序、全局搜索框、列可见性切换等功能。
- **`FormDialog`**:
  - **实现**: 结合 `shadcn/ui` 的 `Dialog`、`Form` 组件和 `react-hook-form`。
  - **逻辑**: 封装了表单的创建、提交、重置逻辑，以及与 `zod` 结合的错误提示。
  - **用途**: 作为所有创建和编辑操作的基础弹窗。

### 5. 测试策略与质量保证

#### 5.1 基于OAuth 2.1的测试架构

测试策略围绕admin-portal的双重角色设计：

- **OAuth客户端测试**: 验证PKCE流程、令牌管理、权限解析
- **认证中心UI测试**: 验证登录页面、授权同意页面、错误处理
- **集成测试**: 验证与oauth-service的完整交互流程

#### 5.2 核心测试场景

**首次认证流程测试**:
1. 用户访问dashboard（无token）
2. 重定向到/oauth/authorize
3. 未认证 → 重定向到/auth/login
4. 登录成功 → 重定向到/oauth/consent
5. 授权确认 → 令牌交换 → 返回dashboard

**令牌管理测试**:
- access_token自动刷新（15分钟过期）
- refresh_token失效处理（30天过期）
- 令牌撤销和重新认证

**权限验证测试**:
- JWT权限解析准确性
- 权限变更实时生效
- 权限不足友好提示

#### 5.3 测试数据与配置

```typescript
// 测试OAuth配置
const testConfig = {
  client_id: 'admin-portal',
  redirect_uri: 'http://localhost:3000/auth/callback',
  scope: 'openid profile admin:read admin:write',
  response_type: 'code',
  code_challenge_method: 'S256'
}

// 测试用户权限
const testUsers = {
  admin: { permissions: ['*.*'], roles: ['SYSTEM_ADMIN'] },
  userAdmin: { permissions: ['user:*', 'role:list'], roles: ['USER_ADMIN'] }
}
```

#### 5.4 测试覆盖率目标

- **单元测试**: 组件90%，工具函数100%
- **集成测试**: OAuth流程85%，API集成80%
- **E2E测试**: 完整认证流程100%
- **安全测试**: PKCE验证、JWT签名、权限检查100%
