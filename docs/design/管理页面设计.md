# 管理页面详细设计文档

> **文档版本**: v7.0.0  
> **创建日期**: 2025-07-08
> **最后更新**: 2025-07-08  
> **文档状态**: 正式版 - 可用于开发指导  
> **维护团队**: 前端团队

## 1. 概述

本文档为 `admin-portal`（管理后台）提供了一份全面的、可直接用于开发的详细设计说明。它整合了系统架构、数据库模型、权限体系和API规范，旨在确保前端实现与后端能力和设计目标完全对齐。

## 2. 前端技术与数据流架构

为保证与项目现有实践一致，所有页面开发必须遵循以下技术架构：

- **核心技术**: Next.js 15, React 19, Tailwind CSS, **shadcn/ui**。
- **状态管理**:
  - **服务端状态**: 使用 **`@tanstack/react-query`** 管理所有与API交互的数据，包括获取、缓存、同步和更新。
  - **客户端状态**: 使用 **`Zustand`** 管理全局UI状态，如侧边栏的折叠状态、通知等。
- **表单处理**: 使用 **`react-hook-form`** 进行表单状态管理，并结合 **`zod`** 进行类型安全的数据校验。
- **表格处理**: ��用 **`@tanstack/react-table`** 构建功能丰富、可复用的数据表格。
- **数据流**: 严格遵循单向数据流。
  1.  **UI展现层**: 用户交互触发。
  2.  **业务逻辑层 (Hooks)**: 调用相应的数据查询钩子。
  3.  **数据查询层 (`@tanstack/react-query`)**: 发起API请求。
  4.  **API层 (`fetch`)**: 与后端 `oauth-service` 通信。

---

## 3. 核心功能页面详细设计

### 3.1 用户管理 (`/admin/users`)

- **功能概述**: 提供对系统所有用户的增删改查（CRUD）功能，并能为用户分配角色。
- **数据实体与字段**:
  - **主要实体**: `User`, `Role`
  - **表格展示字段**: `username`, `displayName`, `organization`, `department`, `isActive`, `createdAt`。
  - **表单字段 (创建)**: `username`, `password`, `displayName`, `organization`, `department`, `isActive`, `mustChangePassword`。
  - **表单字段 (编辑)**: `displayName`, `organization`, `department`, `isActive`, `mustChangePassword`。`username` 在编辑时为只读。
- **核心API端点**:
  - `GET /api/v2/users`: 获取用户列表。
  - `POST /api/v2/users`: 创建新用户。
  - `GET /api/v2/users/{id}`: 获取单个用户详情（包括其角色）。
  - `PUT /api/v2/users/{id}`: 更新用户信息。
  - `DELETE /api/v2/users/{id}`: 删除用户。
  - `GET /api/v2/roles`: 获取所有可用角色列表，用于分配。
  - `PUT /api/v2/users/{id}/roles`: 为用户批量更新角色。
- **所需权限**:
  - **页面访问**: `menu:system:user:view`
  - **查看列表**: `user:list`
  - **创建用户**: `user:create`
  - **编辑用户**: `user:update`
  - **删除用户**: `user:delete`
  - **分配角色**: `user:manage_roles` (建议新增此权限以实现更细粒度控制)
- **搜索与过滤字段**:
  - **全局搜索**: `username`, `displayName`。
  - **过滤**: `isActive` (激活/禁用), `organization` (组织)。
- **表单校验规则 (使用 `zod`)**:
  - `username`: 必填，3-20个字符，仅限字母、数字、下划线。
  - `password`: 必填（仅创建时），满足 `@repo/lib` 中定义的密码复杂度策略。
  - `displayName`: 必填，2-50个字符。
- **主要交互与组件**:
  - `UserDataTable`: 基于通用 `DataTable` 组件实现，包含搜索、过滤和操作列（编辑、删除、分配角色）。
  - `UserFormDialog`: 用于创建和编辑用户的弹窗。在编辑模式下，包含一个**角色分配组件**（如多选下拉框），数据源为 `GET /api/v2/roles`。
  - `DeleteConfirmationDialog`: 删除用户前显示认对话框。
- **操作用例**:
  1.  **创建用户**: 管理员点击“创建用户”，在弹窗中填写信息，提交后列表刷新。
  2.  **编辑用户角色**: 管理员在用户行点击“编辑”，在弹窗中修改用户的角色分配，保存后生效。
  3.  **搜索用户**: 管理员在搜索框输入 "john"，表格中只显示用户名或显示名称包含 "john" 的用户。

### 3.2 角色管理 (`/admin/system/roles`)

- **功能概述**: 提供对角色及其关联权限的增删改查功能。
- **数据实体与字段**:
  - **主要实体**: `Role`, `Permission`
  - **表格展示字段**: `name`, `displayName`, `isSystemRole`, `isActive`。
  - **表单字段**: `name` (创建时), `displayName`, `isActive`。`name` 在编辑时为只读。
- **核心API端点**:
  - `GET /api/v2/roles`: 获取角色列表。
  - `POST /api/v2/roles`: 创建新角色。
  - `PUT /api/v2/roles/{id}`: 更新角色信息。
  - `DELETE /api/v2/roles/{id}`: 删除角色（系统角色 `isSystemRole=true` 不可删除）。
  - `GET /api/v2/permissions`: 获取所有权限点列表。
  - `GET /api/v2/roles/{id}/permissions`: 获取指定角色已拥有的权限。
  - `POST /api/v2/roles/{id}/permissions`: 为角色批量分配权限。
- **所需权限**:
  - **页面访问**: `menu:system:role:view`
  - **查看列表**: `role:list`
  - **创建角色**: `role:create`
  - **编辑角色**: `role:update`
  - **删除角色**: `role:delete`
  - **分配权限**: `roles:permissions:assign`
- **搜索与过滤字段**:
  - **全局搜索**: `name`, `displayName`。
- **表单校验规则 (使用 `zod`)**:
  - `name`: 必填，3-30个字符，大写字母和下划线 (e.g., `USER_ADMIN`)。
  - `displayName`: 必填，2-50个字符。
- **主要交互与组件**:
  - `RoleDataTable`: 展示角色列表。系统角色的“删除”按钮应被禁用。
  - `RoleFormDialog`: 创建和编辑角色的弹窗。
  - `PermissionAssignment`: 一个核心组件，通常在编辑角色的弹窗内。它会获取所有权限 (`GET /api/v2/permissions`)，并以树形或分组列表（按 `resource` 分组）展示，使用复选框进行选择。
- **操作用例**:
  1.  **编辑权限**: 管理员点击“安全管理员”角色的“编辑权限”按钮，在弹窗中看到按“用户管理”、“角色管理”等资源分组的权限树，勾选 `user:delete` 权限并保存。

### 3.3 客户端管理 (`/admin/system/clients`)

- **功能概述**: 管理所有接入本认证中心的OAuth客户端应用。
- **数据实体与段**:
  - **主要实体**: `OAuthClient`
  - **表格展示字段**: `clientId`, `clientType`, `redirectUris`。
  - **表单字段**: `clientId` (创建时可自动生成), `clientSecret` (创建后显示一次), `clientType`, `redirectUris` (可动态增删的输入框列表), `allowedScopes` (多选), `grantTypes` (多选), `requirePkce`。
- **核心API端点**:
  - `GET /api/v2/clients`: 获取客户端列表。
  - `POST /api/v2/clients`: 创建新客户端。
  - `PUT /api/v2/clients/{id}`: 更新客户端。
  - `DELETE /api/v2/clients/{id}`: 删除客户端。
  - `POST /api/v2/clients/{id}/secret`: 重置客户端密钥。
- **所需权限**:
  - **页面访问**: `menu:system:client:view`
  - **查看列表**: `client:list`
  - **创建客户端**: `client:create`
  - **编辑客户端**: `client:update`
  - **删除客户端**: `client:delete`
  - **重置密钥**: `oauth:clients:manage`
- **搜索与过滤字段**:
  - **全局搜索**: `clientId`。
- **表单校验规则 (使用 `zod`)**:
  - `redirectUris`: 必填，且必须是合法的 HTTPS URI。
  - `allowedScopes`: 必填，至少选择一个。
- **主要交互与组件**:
  - `ClientDataTable`: 展示客户端列表。
  - `ClientFormDialog`: 创建和编辑客户端的窗。
  - `RotateSecretDialog`: 点击“重置密钥”后，调用API，然后在弹窗中**仅显示一次**新生成的 `clientSecret`，并提供一个“复制”按钮。
- **操作用例**:
  1.  **创建新客户端**: 管理员点击“创建客户端”，填写重定向URI，选择授权类型为 `authorization_code` 和 `refresh_token`，保存后系统生成 `clientId` 和 `clientSecret` 并显示给管理员。

### 客户端管理 UI 字段支持说明

- allowedScopes 字段已支持，前端表单和 API 交互均已覆盖。
- requirePkce 字段尚未在 UI 层暴露，建议补充“Require PKCE”开关，并在 API payload 中传递 requirePkce 字段，确保前后端一致。

### 3.4 审计日志 (`/admin/system/audits`)

- **功能概述**: 查看系统记录的所有关键操作日志，用于安全审计和问题排查。

### 3.5 登录页面 (`/auth/login`)

- **功能概述**: 用户输入用户名密码进行身份认证
- **页面路径**: `/auth/login`
- **UI元素**:
  - 用户名输入框
  - 密码输入框
  - 登录按钮
  - 错误提示区域
- **交互流程**:
  1. 用户输入用户名密码
  2. 提交表单到oauth-service验证
  3. 验证成功则重定向回原请求
  4. 验证失败则显示错误信息
- **API端点**:
  - `POST /api/v2/auth/login` (oauth-service)
- **数据实体与字段**:
  - **主要实体**: `AuditLog`
  - **表格展示字段**: `timestamp`, `userId`, `action`, `resourceType`, `status`, `ipAddress`。
- **核心API端点**: `GET /api/v2/audit-logs`。
- **所需权限**:
  - **页面访问**: `menu:system:audit:view`
  - **查看列表**: `audit:list`
- **搜索与过滤字段**:
  - **过滤**: `userId` (可输入用户ID或名称搜索), `action`, `resourceType`, `status` (成功/失败), `timestamp` (日期范围选择器)。
- **主要交互与组件**:
  - `AuditLogDataTable`: 展示审计日志列表。
  - `AuditLogFilterBar`: 一个包含多个输入框和下拉选择框的过滤栏，用于按上述字段进行精确筛选。
  - `LogDetailsView`: 点击某条日志的“详情”按钮，弹窗或在侧边栏显示其完整的 `details` JSON内容，并进行格式化展示。
- **操作用例**:
  1.  **追踪失败登录**: 管理员在过滤栏中选择 `action` 为 `user:login`，`status` 为 `failure`，并选择过去24小时的日期范围，以查看所有失败的登录尝试。

### 用户信息接口返回结构说明

- 接口路径：GET /api/v2/users/me
- 返回字段：
  - id: string
  - username: string
  - displayName: string
  - organization: string
  - department: string
  - isActive: boolean
  - mustChangePassword: boolean
  - createdAt: string
  - updatedAt: string
  - permissions: string[]
- 说明：permissions 字段为当前用户所有去重后的权限点名，便于前端权限校验与动态渲染。

### API 错误码说明

- 400 Bad Request：参数校验失败、请求格式错误
- 401 Unauthorized：未认证或认证信息无效
- 403 Forbidden：无权限访问
- 404 Not Found：资源不存在
- 409 Conflict：资源冲突（如唯一键冲突）
- 500 Internal Server Error：服务器内部错误

---

## 4. 通用组件设计

- **`PermissionGuard`**:
  - **实现**: 一个高阶组件（HOC）或自定义钩子 (`usePermission`)。
  - **逻辑**: 接收一个或多个权限点字符串（如 `user:create`）。组件内部从用户状态（Zustand/React Query）中获取当前用户的权限列表，进行比对。
  - **用途**:
    - 包裹页面级组件，无权限则显示403页面。
    - 包裹按钮等操作元素，无权限则不渲染该元素。
- **`DataTable`**:
  - **实现**: 基于 `@tanstack/react-table` 的可复用表格组件。
  - **Props**: 接收 `columns` 定义、`data`、分页状态、排序状态等。
  - **功能**: 内置分页控件、列表头排序、全局搜索框、列可见性切换等功能。
- **`FormDialog`**:
  - **实现**: 结合 `shadcn/ui` 的 `Dialog`、`Form` 组件和 `react-hook-form`。
  - **逻辑**: 封装了表单的创建、提交、重置逻辑，以及与 `zod` 结合的错误提示。
  - **用途**: 作为所有创建和编辑操作的基础弹窗。

### 单元测试与覆盖率说明

- UserService 已有详细单元测试，覆盖用户创建、更新、删除、查询、校验等核心路径。
- 其他服务和 API（如角色、权限、客户端管理等）需补全测试用例和覆盖率报告，确保所有关键路径均有测试。
