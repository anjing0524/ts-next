# 详细设计文档

> **文档版本**: v6.0.0
> **创建日期**: 2025-01-28
> **最后更新**: 2025-07-08
> **状态**: 正式版
> **维护团队**: 架构团队

## 1. 文档概述

本文档是基于 Turborepo 的 **OAuth2.1 认证授权中心与微服务平台** 的统一详细设计文档。它作为所有核心设计决策的入口，整合并链接到系统架构、API 设计、数据库设计和权限体系等专项设计文档。

**实现状态**: ✅ 所有核心功能已完成，文档已与代码实现同步。

## 2. 核心设计文档链接

| 文档名称 | 描述 | 状态 |
| :--- | :--- | :--- |
| [系统架构设计](./系统架构设计.md) | 描述了项目的宏观分层架构、服务组成和技术栈。 | ✅ 已更新 |
| [数据库设计](./数据库设计.md) | 详细定义了数据模型、表结构和实体关系。 | ✅ 已创建 |
| [权限设计 (RBAC)](./权限设计.md) | 详细说明了基于角色的访问控制模型、权限点和核心角色。 | ✅ 已创建 |
| [API 设计规范](../guidelines/API设计规范.md) | 定义了所有微服务必须遵循的统一API设计���准。 | ✅ 已更新 |
| [管理页面设计](./管理页面设计.md) | 描述了 `admin-portal` 的前端架构和页面组件设计。 | ✅ 已更新 |
| [JWT 认证授权使用说明](../guidelines/JWT认证授权使用说明.md) | 详细说明了JWT的获取、验证和使用流程。 | ✅ 已更新 |

## 3. 系统架构核心

系统采用基于 **Turborepo** 的 **Monorepo** 微服务架构，其核心组件包括：

-   **`pingora-proxy`**: 基于 Rust 的高性能 API 网关，作为系统统一入口。
-   **`oauth-service`**: 认证授权核心，实现 OAuth 2.1, OIDC, 和 RBAC。
-   **`admin-portal`**: 用于管理用户、角色、客户端等的系统后台。
-   **共享包 (`packages/*`)**: 提供统一的数据库访问、UI组件和核心工具库。

*详细信息请参阅 [系统架构设计](./系统架构设计.md)。*

## 4. 数据库与数据模型

数据库设计是系统的基石，定义了所有核心实体及其关系。

-   **核心实体**: `User`, `Role`, `Permission`, `OAuthClient`, `AccessToken`, `RefreshToken` 等。
-   **ORM**: 使用 **Prisma** 进行数据库操作和迁移，保证类型安全。
-   **关系**: 用户通过 `UserRole` 关联到角色，角色通过 `RolePermission` 关联到权限。

*详细的数据表结构和ER图请参阅 [数据库设计](./数据库设计.md)。*

## 5. 权限与安全模型

### 5.1 权限模型 (RBAC)

系统采用 **RBAC (基于角色的访问控制)** 模型，实现了四个层级的权限控制：

1.  **菜单权限**: 控制UI界面的菜单项可见性。
2.  **API 权限**: 控制对后端API端点的访问。
3.  **操作权限**: 控制页面内具体操作（如按钮）的可用性。
4.  **数据权限**: (未来扩展) 控制对特定数据范围的访问。

*详细的权限点清单和角色定义请参阅 [权限设计 (RBAC)](./权限设计.md)。*

### 5.2 认证流程 (OAuth 2.1 + PKCE)

-   **无直接登录API**: 系统不提供传统的 `/login` API。所有认证必须通过标准的 **OAuth 2.1 授权码流程**。
-   **强制 PKCE**: 所有客户端（包括公共和机密客户端）在授权流程中都必须使用 **PKCE (S256)**，以增强安全性。

### 5.3 令牌安全 (JWT)

-   **库与算法**: 使用 **jose** 库处理 JWT，签名算法固定为 **RS256**。
-   **密钥管理**: 通过 `/.well-known/jwks.json` 端点动态发布公钥，支持密钥轮换。
-   **令牌撤销**: 支持通过 JTI (JWT ID) 将令牌加入黑名单，实现精确撤销。

*详细的JWT使用方法请参阅 [JWT 认证授权使用说明](../guidelines/JWT认证授权使用说明.md)。*

## 6. API 设计

所有微服务的 API 设计均遵循统一的规范，以确保一致性和可维护性。

-   **版本**: 所有 API 均使用 `/api/v2` 前缀。
-   **格式**: 请求和响应体统一使用 JSON 格式。
-   **认证**: 受保护的 API 端点通过 `Authorization: Bearer <JWT>` 头进行认证。
-   **错误处理**: 定义了统一的错误响应结构和错误码。

*详细的端点列表和设计规范请参阅 [API 设计规范](../guidelines/API设计规范.md) 和 [OAuth 服务 API 索引](../generated/oauth-service-api-index.md)。*