# 详细设计文档

> **文档版本**: v6.1.0
> **最后更新**: 2025-07-10

## 1. 文档概述

本文档是基于 Turborepo 的 **OAuth2.1 认证授权中心与微服务平台** 的统一详细设计文档。它作为所有核心设计决策的入口，整合并链接到系统架构、API 设计、数据库设计和权限体系等专项设计文档。

**实现状态**: ✅ 所有核心功能已完成，文档已与代码实现同步。

## 2. 核心设计文档链接

| 文档名称                                                     | 描述                                                 | 状态      |
| :----------------------------------------------------------- | :--------------------------------------------------- | :-------- |
| [系统架构设计](./系统架构设计.md)                            | 描述了项目的宏观分层架构、服务组成和技术栈。         | ✅ 已更新 |
| [数据库设计](./数据库设计.md)                                | 详细定义了数据模型、表结构和实体关系。               | ✅ 已创建 |
| [权限设计 (RBAC)](./权限设计.md)                             | 详细说明了基于角色的访问控制模型、权限点和核心角色。 | ✅ 已创建 |
| [API 设计规范](../guidelines/API设计规范.md)                 | 定义了所有微服务必须遵循的统一API设计标准。          | ✅ 已更新 |
| [管理页面设计](./管理页面设计.md)                            | 描述了 `admin-portal` 的前端架构和页面组件设计。     | ✅ 已更新 |
| [JWT 认证授权使用说明](../guidelines/JWT认证授权使用说明.md) | 详细说明了JWT的获取、验证和使用流程。                | ✅ 已更新 |

## 3. 系统架构核心

系统采用基于 **Turborepo** 的 **Monorepo** 微服务架构，其核心组件包括：

- **`pingora-proxy`**: 基于 Rust 的高性能 API 网关，作为系统统一入口。
- **`oauth-service`**: 认证授权核心，实现 OAuth 2.1, OIDC, 和 RBAC，仅提供API服务，不渲染任何页面。
- **`admin-portal`**: 用于管理用户、角色、客户端等的系统后台，同时作为认证中心UI，负责所有认证相关页面（登录、同意、错误等）。
- **共享包 (`packages/*`)**: 提供统一的数据库访问、UI组件和核心工具库。

_详细信息请参阅 [系统架构设计](./系统架构设计.md)。_

## 4. 页面与API分工原则

- **oauth-service 只提供API，不渲染任何页面**：
  - 包括 /authorize、/token、/userinfo、/consent 等所有OAuth2.1相关端点，均为API接口。
  - 任何需要用户交互的场景（如未登录、同意授权、错误提示等），oauth-service应重定向到admin-portal提供的对应页面（如 /auth/login、/oauth/consent、/error），并带上必要的query参数。

- **admin-portal 作为认证中心UI，负责所有认证相关页面**：
  - 实现 /auth/login（登录）、/oauth/consent（同意授权）、/error（错误提示）等页面。
  - 根据oauth-service传递的参数渲染页面，收集用户输入/同意后再调用oauth-service API完成后续流程。
  - 兼容管理后台与认证中心UI双重角色。

- **两者协作流程**：
  1. 用户访问受保护资源，跳转到oauth-service /authorize。
  2. oauth-service发现未登录，重定向到admin-portal /auth/login。
  3. 登录后，admin-portal回调oauth-service继续授权流程。
  4. 需要同意授权时，oauth-service重定向到admin-portal /oauth/consent。
  5. 用户同意/拒绝后，admin-portal回调oauth-service API。
  6. oauth-service完成token颁发等后续流程。

## 5. 数据库与数据模型

数据库设计是系统的基石，定义了所有核心实体及其关系。

- **核心实体**: `User`, `Role`, `Permission`, `OAuthClient`, `AccessToken`, `RefreshToken` 等。
- **ORM**: 使用 **Prisma** 进行数据库操作和迁移，保证类型安全。
- **关系**: 用户通过 `UserRole` 关联到角色，角色通过 `RolePermission` 关联到权限。

_详细的数据表结构和ER图请参阅 [数据库设计](./数据库设计.md)。_

## 6. 权限与安全模型

### 6.1 权限模型 (RBAC)

系统采用 **RBAC (基于角色的访问控制)** 模型，实现了四个层级的权限控制：

1.  **菜单权限**: 控制UI界面的菜单项可见性。
2.  **API 权限**: 控制对后端API端点的访问。
3.  **操作权限**: 控制页面内具体操作（如按钮）的可用性。
4.  **数据权限**: (未来扩展) 控制对特定数据范围的访问。

_详细的权限点清单和角色定义请参阅 [权限设计 (RBAC)](./权限设计.md)。_

### 6.2 认证流程 (OAuth 2.1 + PKCE)

- **无直接登录API**: 系统不提供传统的 `/login` API。所有认证必须通过标准的 **OAuth 2.1 授权码流程**。
- **强制 PKCE**: 所有客户端（包括公共和机密客户端）在授权流程中都必须使用 **PKCE (S256)**，以增强安全性。
- **页面交互全部由admin-portal负责**：oauth-service所有需要页面的场景均重定向到admin-portal。

### 6.3 令牌安全 (JWT)

- **库与算法**: 使用 **jose** 库处理 JWT，签名算法固定为 **RS256**。
- **密钥管理**: 通过 `/.well-known/jwks.json` 端点动态发布公钥，支持密钥轮换。
- **令牌撤销**: 支持通过 JTI (JWT ID) 将令牌加入黑名单，实现精确撤销。

_详细的JWT使用方法请参阅 [JWT 认证授权使用说明](../guidelines/JWT认证授权使用说明.md)。_

## 7. API 设计

所有微服务的 API 设计均遵循统一的规范，以确保一致性和可维护性。

_详细API规范请参阅 [API 设计规范](../guidelines/API设计规范.md)。_
