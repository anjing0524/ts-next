# OAuth 2.1 å®Œæ•´ä¸šåŠ¡æµç¨‹æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-17
> **é€‚ç”¨ç³»ç»Ÿ**: OAuth Service Rust + Admin Portal + Pingora Proxy

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æ•´ä¸ª OAuth 2.1 è®¤è¯æˆæƒç³»ç»Ÿçš„å®Œæ•´ä¸šåŠ¡æµç¨‹,åŒ…æ‹¬æ‰€æœ‰å‚ä¸ç»„ä»¶çš„äº¤äº’ã€‚

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„ä¸ç»„ä»¶è§’è‰²](#ç³»ç»Ÿæ¶æ„ä¸ç»„ä»¶è§’è‰²)
2. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
3. [OAuth 2.1 æˆæƒç æµç¨‹ (Authorization Code Flow with PKCE)](#oauth-21-æˆæƒç æµç¨‹)
4. [ç”¨æˆ·ç™»å½•æµç¨‹](#ç”¨æˆ·ç™»å½•æµç¨‹-oauth-service-ä¸­å¿ƒåŒ–è®¤è¯)
5. [åŒæ„é¡µé¢æµç¨‹](#åŒæ„é¡µé¢æµç¨‹-ç”¨æˆ·æˆæƒç¡®è®¤)
6. [Token åˆ·æ–°æµç¨‹](#token-åˆ·æ–°æµç¨‹)
7. [å®¢æˆ·ç«¯å‡­è¯æµç¨‹](#å®¢æˆ·ç«¯å‡­è¯æµç¨‹)
8. [Token å†…çœå’Œæ’¤é”€](#token-å†…çœå’Œæ’¤é”€)
9. [å—ä¿æŠ¤èµ„æºè®¿é—®æµç¨‹](#å—ä¿æŠ¤èµ„æºè®¿é—®æµç¨‹)
10. [æƒé™éªŒè¯æµç¨‹](#æƒé™éªŒè¯æµç¨‹)
11. [å®Œæ•´è¯·æ±‚é“¾è·¯](#å®Œæ•´è¯·æ±‚é“¾è·¯)
12. [é”™è¯¯å¤„ç†æµç¨‹](#é”™è¯¯å¤„ç†æµç¨‹)

---

## ç³»ç»Ÿæ¶æ„èƒŒæ™¯

> ğŸ“Œ **é‡è¦è¯´æ˜**: æœ¬æ–‡æ¡£æè¿°çš„æ˜¯ OAuth 2.1 æ ‡å‡†æµç¨‹åœ¨æœ¬ç³»ç»Ÿä¸­çš„å®Œæ•´å®ç°ã€‚æ›´è¯¦ç»†çš„æ¶æ„è®¾è®¡å†³ç­–å’Œç†ç”±ï¼Œè¯·å‚è€ƒ [`00-ARCHITECTURE_DECISION.md`](./00-ARCHITECTURE_DECISION.md)ã€‚

### æ ¸å¿ƒç»„ä»¶è§’è‰²

| ç»„ä»¶ | è§’è‰² | è´£ä»» |
|------|------|------|
| **OAuth Service (Rust)** | Authorization Server | å‡­è¯éªŒè¯ã€Token ç­¾å‘ã€æƒé™ç®¡ç†ã€ä¼šè¯æ§åˆ¶ |
| **Admin Portal (Next.js)** | OAuth 2.1 å®¢æˆ·ç«¯ + Web UI | ç”Ÿæˆ PKCEã€æä¾›ç™»å½•/åŒæ„é¡µé¢ã€å¤„ç†æˆæƒå›è°ƒ |
| **Pingora** | åå‘ä»£ç† | è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€å¥åº·æ£€æŸ¥ |

### å…³é”®æ¶æ„ç‰¹ç‚¹

**æ ¸å¿ƒå®‰å…¨ä¿è¯**:
- âœ… **å‡­è¯éªŒè¯**: OAuth Service å®Œå…¨è´Ÿè´£ï¼ˆAdmin Portal ä¸æ¥è§¦å¯†ç ï¼‰
- âœ… **Token ç®¡ç†**: OAuth Service å®Œå…¨è´Ÿè´£ï¼ˆç”Ÿæˆã€ç­¾å‘ã€éªŒè¯ã€æ’¤é”€ï¼‰
- âœ… **ä¼šè¯ç®¡ç†**: OAuth Service å®Œå…¨è´Ÿè´£ï¼ˆSession Token å­˜å‚¨ã€æ£€æŸ¥ï¼‰
- âœ… **æƒé™å†³ç­–**: OAuth Service å®Œå…¨è´Ÿè´£ï¼ˆæ‰€æœ‰æˆæƒå†³å®šï¼‰

**ä¸æ ‡å‡† OAuth çš„ä¸»è¦å·®å¼‚**:
- âš ï¸ **éæ ‡å‡†è®¾è®¡**: ç™»å½•/åŒæ„é¡µé¢ç”± Admin Portal æä¾›ï¼Œè€Œé OAuth Serviceï¼ˆåŸå› è§ [00-ARCHITECTURE_DECISION.md](./00-ARCHITECTURE_DECISION.md)ï¼‰
- âš ï¸ **è·¨åŸŸ API è°ƒç”¨**: Admin Portal å‰ç«¯éœ€è¦å‘ OAuth Service æäº¤å‡­è¯å’ŒåŒæ„å†³å®š

### ä¸¤ä¸ªå…¸å‹åœºæ™¯

#### åœºæ™¯ 1ï¸âƒ£: ç”¨æˆ·ç›´æ¥è®¿é—® Admin Portal

```
1. ç”¨æˆ·è®¿é—® Admin Portal â†’ Admin Portal æ£€æŸ¥ Token
2. æ—  Token â†’ Admin Portal å¯åŠ¨ OAuth æˆæƒæµç¨‹
   - ç”Ÿæˆ PKCE (code_verifier + code_challenge)
   - é‡å®šå‘åˆ° OAuth Service /authorize
3. OAuth Service å¤„ç† /authorize
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½• (æ£€æŸ¥ session_token Cookie)
   - å¦‚æœªç™»å½• â†’ é‡å®šå‘å› Admin Portal /login
4. Admin Portal /login é¡µé¢
   - æ˜¾ç¤ºç™»å½•è¡¨å•ï¼ˆHTML è¡¨å•ï¼‰
5. ç”¨æˆ·è¾“å…¥å‡­è¯ï¼Œå‰ç«¯æäº¤ç»™ OAuth Service /api/v2/auth/login
   - POST /api/v2/auth/login { username, password }
6. OAuth Service éªŒè¯å‡­è¯
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   - bcrypt éªŒè¯å¯†ç 
   - åˆ›å»º session_token
   - è¿”å› session_token (å­˜å…¥ HttpOnly Cookie)
7. Admin Portal é‡å®šå‘å› OAuth Service /authorize
   - å¸¦ä¸ŠåŸå§‹çš„ state å’Œ PKCE
8. OAuth Service å¤„ç† /authorizeï¼ˆç¬¬äºŒæ¬¡ï¼‰
   - æ£€æŸ¥ session_token âœ… (å·²ç™»å½•)
   - æ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨æˆ·åŒæ„
   - å¦‚éœ€åŒæ„ â†’ é‡å®šå‘å› Admin Portal /oauth/consent
   - å¦‚ä¸éœ€åŒæ„ â†’ ç”Ÿæˆ authorization code â†’ é‡å®šå‘å› Admin Portal /callback
9. [å¦‚éœ€åŒæ„] Admin Portal /oauth/consent é¡µé¢
   - è°ƒç”¨ OAuth Service /consent/info è·å–æƒé™åˆ—è¡¨
   - æ˜¾ç¤ºåŒæ„å¯¹è¯æ¡†
10. ç”¨æˆ·ç‚¹å‡»"å…è®¸"ï¼Œå‰ç«¯æäº¤ç»™ OAuth Service /consent/submit
    - POST /consent/submit { authorized_scopes: [...] }
11. OAuth Service å¤„ç† /consent/submit
    - éªŒè¯ session_token âœ…
    - ç”Ÿæˆ authorization code
    - è¿”å› codeï¼ŒAdmin Portal é‡å®šå‘ /callback?code=...&state=...
12. Admin Portal /callback
    - éªŒè¯ state å‚æ•°ï¼ˆCSRF ä¿æŠ¤ï¼‰
    - äº¤æ¢ code ä¸º access_token
    - POST /api/v2/token { code, code_verifier, client_id, client_secret }
13. OAuth Service /token ç«¯ç‚¹
    - éªŒè¯ authorization codeï¼ˆå•æ¬¡ä½¿ç”¨ï¼‰
    - éªŒè¯ PKCE (code_challenge vs code_verifier)
    - ç­¾å‘ access_token å’Œ refresh_token
14. Admin Portal è·å¾— Token
    - å­˜å‚¨ access_tokenï¼ˆå†…å­˜æˆ– sessionStorageï¼‰
    - å­˜å‚¨ refresh_tokenï¼ˆHttpOnly Cookieï¼‰
    - é‡å®šå‘åˆ° Dashboard
15. Dashboard åŠ è½½
    - ä½¿ç”¨ access_token è°ƒç”¨ Admin API
    - æ˜¾ç¤ºç”¨æˆ·ç®¡ç†/è§’è‰²ç®¡ç†ç•Œé¢
```

#### åœºæ™¯ 2ï¸âƒ£: OAuth Service é©±åŠ¨çš„äº¤äº’

> å½“å…¶ä»–å®¢æˆ·ç«¯å‘èµ·æˆæƒè¯·æ±‚æ—¶ï¼Œæˆ–ç”¨æˆ·ç›´æ¥è®¿é—® OAuth Service æ—¶

**ç™»å½•å’ŒåŒæ„é¡µé¢ä¸ºä»€ä¹ˆç”± Admin Portal æä¾›ï¼Ÿ**

1. **æŠ€æœ¯èƒ½åŠ›**: Next.js/React åœ¨æ„å»ºç°ä»£ Web UI æ–¹é¢æ›´å¼º
2. **ä»£ç å¤ç”¨**: Admin Portal çš„ UI ç»„ä»¶å¯ä»¥ç›´æ¥å¤ç”¨
3. **ç‹¬ç«‹è¿­ä»£**: UI æ›´æ–°æ— éœ€é‡æ–°ç¼–è¯‘ Rust äºŒè¿›åˆ¶
4. **å®‰å…¨æ€§**:  ç”± OAuth Service å®Œå…¨é©±åŠ¨é€»è¾‘ï¼ŒAdmin Portal åªè´Ÿè´£æ˜¾ç¤º

**æ•°æ®æµ**:
- ç”¨æˆ·è¾“å…¥çš„å¯†ç  â†’ ç›´æ¥å‘é€ç»™ OAuth Serviceï¼Œä¸æµç» Admin Portal åç«¯
- OAuth Service éªŒè¯å¯†ç ï¼Œç­¾å‘ session_token
- Admin Portal æ— æ³•è®¿é—®å¯†ç ï¼Œä¹Ÿæ— æ³•ä¼ªé€  session_token

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### ç»„ä»¶èŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æµè§ˆå™¨/å®¢æˆ·ç«¯   â”‚
â”‚   (User Agent)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Pingora Proxy (0.0.0.0:6188)      â”‚
â”‚  - åå‘ä»£ç†                              â”‚
â”‚  - è·¯ç”±åˆ†å‘                              â”‚
â”‚  - è´Ÿè½½å‡è¡¡                              â”‚
â”‚  - å¥åº·æ£€æŸ¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â”‚ /api/v2/*            â”‚ /* (é»˜è®¤)
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OAuth Service Rust  â”‚   â”‚   Admin Portal     â”‚
â”‚   (127.0.0.1:3001)   â”‚   â”‚  (127.0.0.1:3002)  â”‚
â”‚                      â”‚   â”‚                    â”‚
â”‚  - æˆæƒæœåŠ¡å™¨        â”‚   â”‚  - ç®¡ç†ç•Œé¢        â”‚
â”‚  - Token ç­¾å‘        â”‚   â”‚  - OAuth å®¢æˆ·ç«¯    â”‚
â”‚  - ç”¨æˆ·è®¤è¯          â”‚   â”‚  - èµ„æºç®¡ç†        â”‚
â”‚  - RBAC æƒé™         â”‚   â”‚                    â”‚
â”‚  - å®¡è®¡æ—¥å¿—          â”‚   â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   SQLite    â”‚
    â”‚  Database   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç«¯å£å’Œè·¯ç”±é…ç½®

| æœåŠ¡ | ç›‘å¬åœ°å€ | è®¿é—®è·¯å¾„ | åç«¯åœ°å€ |
|------|----------|----------|----------|
| Pingora Proxy | 0.0.0.0:6188 | æ‰€æœ‰è¯·æ±‚ | - |
| OAuth Service | 127.0.0.1:3001 | `/api/v2/*` | é€šè¿‡ Pingora |
| Admin Portal | 127.0.0.1:3002 | `/*` (é»˜è®¤) | é€šè¿‡ Pingora |

---

## OAuth 2.1 æˆæƒç æµç¨‹ (PKCE)

OAuth 2.1 çš„æˆæƒç æµç¨‹æ˜¯æœ€å®‰å…¨çš„æˆæƒæ–¹å¼,**å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ PKCE** æ¥é˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»ã€‚æœ¬æµç¨‹å±•ç¤ºäº†**å»ä¸­å¿ƒåŒ–**çš„ OAuth 2.1 è®¾è®¡åŸåˆ™:
- **OAuth Service** æ˜¯å”¯ä¸€çš„è®¤è¯æˆæƒä¸­å¿ƒ,å¤„ç†æ‰€æœ‰å‡­è¯ç›¸å…³çš„æ“ä½œ
- **Admin Portal** æ˜¯ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯åº”ç”¨,ä¸å¤„ç†ä»»ä½•ç”¨æˆ·å‡­è¯,ä»…è´Ÿè´£ç”Ÿæˆ PKCE å‚æ•°å’Œæ¥æ”¶æˆæƒç 

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨   â”‚                    â”‚ Admin Portal â”‚                    â”‚ OAuth Serviceâ”‚
â”‚          â”‚                    â”‚ (ç¬¬ä¸‰æ–¹åº”ç”¨)  â”‚                    â”‚   (è®¤è¯ä¸­å¿ƒ)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                 â”‚                                   â”‚
     â”‚ 1. ç”¨æˆ·è®¿é—® Admin Portal        â”‚                                   â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>       â”‚                                   â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚ 2. Admin Portal æ£€æŸ¥ token      â”‚                                   â”‚
     â”‚     (localStorage/cookie)        â”‚                                   â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚ 3a. æœ‰æœ‰æ•ˆçš„ token               â”‚
     â”‚                                 â”‚     â†’ åŠ è½½ Dashboard              â”‚
     â”‚                                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>            â”‚
     â”‚ 4. æ˜¾ç¤ºä»ªè¡¨æ¿                   â”‚                                   â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
     â”‚                                                                     â”‚
     â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
     â”‚ å¦‚æœæ²¡æœ‰ token æˆ– token è¿‡æœŸ â†’ å¼€å§‹ OAuth è®¤è¯æµç¨‹                  â”‚
     â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
     â”‚                                                                     â”‚
     â”‚                                 â”‚ 3b. æ—  token                      â”‚
     â”‚                                 â”‚     ç”Ÿæˆ PKCE å‚æ•°                â”‚
     â”‚                                 â”‚     - code_verifier (éšæœºå­—ç¬¦ä¸²)  â”‚
     â”‚                                 â”‚     - code_challenge = SHA256(v)â”‚
     â”‚                                 â”‚     - state (CSRF ä¿æŠ¤)           â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚ 5. 302 é‡å®šå‘åˆ° OAuth Service   â”‚                                   â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    Location: /api/v2/oauth/authorize?                             â”‚
     â”‚      client_id=admin-portal-client&                               â”‚
     â”‚      redirect_uri=http://localhost:6188/auth/callback&            â”‚
     â”‚      response_type=code&                                          â”‚
     â”‚      scope=openid profile email&                                  â”‚
     â”‚      code_challenge=<hash>&                                       â”‚
     â”‚      code_challenge_method=S256&                                  â”‚
     â”‚      state=<csrf_token>&                                          â”‚
     â”‚      nonce=<random>                                               â”‚
     â”‚                                                                     â”‚
     â”‚ 6. GET /api/v2/oauth/authorize?...                                â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                                                     â”‚
     â”‚                                                    7. éªŒè¯è¯·æ±‚å‚æ•°  â”‚
     â”‚                                                       - client_id  â”‚
     â”‚                                                       - redirect_uriâ”‚
     â”‚                                                       - scope      â”‚
     â”‚                                                       - PKCE æ ¼å¼   â”‚
     â”‚                                                                     â”‚
     â”‚                                                    8. æ£€æŸ¥ session â”‚
     â”‚                                                       (æ˜¯å¦å·²ç™»å½•)  â”‚
     â”‚                                                                     â”‚
     â”‚ 9. å¦‚æœæœªç™»å½•,302 é‡å®šå‘åˆ°ç™»å½•é¡µ (OAuth Service è§¦å‘)              â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    Location: http://localhost:6188/login?redirect=<authorize>    â”‚
     â”‚    (æ³¨æ„: ç™»å½•é¡µé¢ç”± Admin Portal æä¾›,                         â”‚
     â”‚           ä½†é‡å®šå‘å’Œæµç¨‹æ§åˆ¶ç”± OAuth Service å®Œå…¨æŒæ§)           â”‚
     â”‚                                                                     â”‚
     â”‚ 10. GET /login?redirect=...                                        â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                                                     â”‚
     â”‚                                                    10.5 Admin Portalâ”‚
     â”‚                                                       è¿”å›ç™»å½•é¡µé¢  â”‚
     â”‚                                                       HTML/Form    â”‚
     â”‚                                                                     â”‚
     â”‚ 12. æ˜¾ç¤ºç™»å½•è¡¨å• (åœ¨ Admin Portal, ä½†å— OAuth Service æ§åˆ¶)      â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚     (Admin Portal ä»…æä¾› UI, OAuth Service æ§åˆ¶æµç¨‹)              â”‚
     â”‚                                                                     â”‚
     â”‚ 13. ç”¨æˆ·è¾“å…¥å‡­è¯ (åœ¨ Admin Portal /login é¡µé¢)                   â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚     (ä½†å‡­è¯éªŒè¯é€»è¾‘ç”± OAuth Service å®Œæˆ)                         â”‚
     â”‚                                                                     â”‚
     â”‚ 14. POST /api/v2/auth/login (å‡­è¯å‘é€åˆ° OAuth Service)           â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚    {username, password, redirect}                                  â”‚
     â”‚                                                                     â”‚
     â”‚                                                    15. éªŒè¯å‡­è¯      â”‚
     â”‚                                                        - æŸ¥è¯¢ usersâ”‚
     â”‚                                                        - bcrypt    â”‚
     â”‚                                                        - æ£€æŸ¥çŠ¶æ€   â”‚
     â”‚                                                                     â”‚
     â”‚                                                    16. ç­¾å‘ session_token â”‚
     â”‚                                                        (å†…éƒ¨ JWT)   â”‚
     â”‚                                                                     â”‚
     â”‚ 17. è¿”å›æˆåŠŸ + Set-Cookie                                          â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    Set-Cookie: session_token=<jwt>; HttpOnly; Secure; SameSite   â”‚
     â”‚    {success: true, redirect_url: "<authorize>"}                  â”‚
     â”‚                                                                     â”‚
     â”‚ 18. å‰ç«¯è·³è½¬åˆ° redirect (authorize)                               â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚    (æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ session_token cookie)                          â”‚
     â”‚                                                                     â”‚
     â”‚                                                    19. éªŒè¯ session â”‚
     â”‚                                                        æå– user_id â”‚
     â”‚                                                                     â”‚
     â”‚                                                    20. æ£€æŸ¥ require_consent â”‚
     â”‚                                                        (å¯é€‰)       â”‚
     â”‚                                                                     â”‚
     â”‚ 20a. å¦‚æœ require_consent=true â†’ è½¬å‘åŒæ„é¡µé¢ (è§"åŒæ„é¡µé¢æµç¨‹") â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    Location: /oauth/consent?...                                   â”‚
     â”‚                                                                     â”‚
     â”‚ 20b. å¦‚æœ require_consent=false â†’ ç»§ç»­ç”Ÿæˆæˆæƒç                   â”‚
     â”‚                                                                     â”‚
     â”‚                                                    21. ç”Ÿæˆæˆæƒç    â”‚
     â”‚                                                        - ä¿å­˜ user_idâ”‚
     â”‚                                                        - ä¿å­˜ code_challengeâ”‚
     â”‚                                                        - æœ‰æ•ˆæœŸ 10åˆ†â”‚
     â”‚                                                                     â”‚
     â”‚ 22. 302 é‡å®šå‘å› Admin Portal                                      â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    Location: /auth/callback?code=<auth_code>&state=<state>       â”‚
     â”‚                                                                     â”‚
     â”‚ 23. GET /auth/callback?code=xxx&state=xxx                         â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                                                     â”‚
     â”‚ (Admin Portal å¤„ç† callback - ä¸æ¶‰åŠå‡­è¯)                          â”‚
     â”‚                                                                     â”‚
     â”‚ 24. Admin Portal éªŒè¯ state (CSRF ä¿æŠ¤)                           â”‚
     â”‚                                                                     â”‚
     â”‚ 25. POST /api/v2/oauth/token (ä»£ç äº¤æ¢)                           â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚    {grant_type, code, code_verifier, client_id, client_secret}   â”‚
     â”‚                                                                     â”‚
     â”‚                                                    26. éªŒè¯æˆæƒç    â”‚
     â”‚                                                        - å­˜åœ¨æ€§     â”‚
     â”‚                                                        - è¿‡æœŸæ£€æŸ¥   â”‚
     â”‚                                                        - clientåŒ¹é… â”‚
     â”‚                                                                     â”‚
     â”‚                                                    27. éªŒè¯ PKCE    â”‚
     â”‚                                                        SHA256(v)==câ”‚
     â”‚                                                                     â”‚
     â”‚                                                    28. åŠ è½½ç”¨æˆ·æƒé™ â”‚
     â”‚                                                        RBAC æŸ¥è¯¢    â”‚
     â”‚                                                                     â”‚
     â”‚                                                    29. ç­¾å‘ Token   â”‚
     â”‚                                                        - access_token â”‚
     â”‚                                                        - refresh_tokenâ”‚
     â”‚                                                        - id_token    â”‚
     â”‚                                                                     â”‚
     â”‚ 30. è¿”å› Token Response                                            â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    {access_token, refresh_token, id_token, expires_in}            â”‚
     â”‚                                                                     â”‚
     â”‚ 31. Admin Portal å­˜å‚¨ tokens (localStorage/HttpOnly)               â”‚
     â”‚                                                                     â”‚
     â”‚ 32. é‡å®šå‘åˆ° Dashboard                                             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                                     â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚ 33. Dashboard åŠ è½½å®Œæˆ            â”‚                                   â”‚
     â”‚     (ä½¿ç”¨ access_token è°ƒç”¨ API) â”‚                                   â”‚
```

### å…³é”®æ¶æ„åŸåˆ™ (OAuth 2.1 éæ ‡å‡†å®ç° - Admin Portal æä¾› UI)

**OAuth Service èŒè´£** (è®¤è¯æˆæƒä¸­å¿ƒ - å®Œå…¨æŒæ§):
- âœ… æ§åˆ¶å®Œæ•´çš„æˆæƒæµç¨‹ (/api/v2/oauth/authorize)
- âœ… è§¦å‘ç™»å½•/åŒæ„é¡µé¢çš„å±•ç¤º (é‡å®šå‘åˆ° Admin Portal)
- âœ… å¤„ç†å’ŒéªŒè¯ç”¨æˆ·å‡­è¯ (/api/v2/auth/login)
- âœ… éªŒè¯ç”¨æˆ·èº«ä»½
- âœ… ç­¾å‘ session_token (HTTP-Only Cookie)
- âœ… éªŒè¯ PKCE å‚æ•°å’Œæˆæƒç 
- âœ… ç­¾å‘ access_token/refresh_token (/api/v2/oauth/token)
- âœ… ç®¡ç†æƒé™å’Œ scope
- âœ… æ‰€æœ‰æˆæƒå†³ç­– (approve/deny consent)

**Admin Portal èŒè´£** (OAuth 2.1 æ ‡å‡†å®¢æˆ·ç«¯ + Web UI æä¾›æ–¹):
- âœ… æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ access_token
- âœ… ç”Ÿæˆ PKCE å‚æ•° (code_verifier + code_challenge)
- âœ… å‘èµ·æˆæƒæµç¨‹ (é‡å®šå‘åˆ° /api/v2/oauth/authorize)
- âœ… æä¾›ç™»å½•é¡µé¢ HTML (ä»…æ˜¾ç¤ºè¡¨å•ï¼Œæ— éªŒè¯é€»è¾‘)
  - æ”¶é›†ç”¨æˆ·è¾“å…¥ (ä¸éªŒè¯)
  - è½¬å‘å‡­è¯ç»™ OAuth Service (ä¸å¤„ç†)
- âœ… æä¾›åŒæ„ç¡®è®¤é¡µé¢ HTML (ä»…æ˜¾ç¤ºï¼Œæ— å†³ç­–é€»è¾‘)
  - æ˜¾ç¤ºæƒé™åˆ—è¡¨ (ä» OAuth Service è·å–)
  - è½¬å‘ç”¨æˆ·å†³å®šç»™ OAuth Service
- âœ… å¤„ç†æˆæƒç å›è°ƒ (/auth/callback)
- âœ… ä½¿ç”¨ code_verifier äº¤æ¢ token
- âœ… å­˜å‚¨å’Œä½¿ç”¨ access_token è°ƒç”¨ API
- âŒ **ä¸éªŒè¯å‡­è¯** - ä»…è½¬å‘ç»™ OAuth Service
- âŒ **ä¸å­˜å‚¨å‡­è¯** - ç«‹å³æ¸…é™¤ç”¨æˆ·è¾“å…¥
- âŒ **ä¸éªŒè¯å¯†ç ** - å®Œå…¨ç”± OAuth Service è´Ÿè´£
- âŒ **ä¸åšæƒé™å†³ç­–** - ä»…è½¬å‘ç”¨æˆ·é€‰æ‹©ç»™ OAuth Service

### å…³é”®å®‰å…¨ç‰¹æ€§

#### 1. PKCE (Proof Key for Code Exchange)

**ç›®çš„**: é˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»

**å®ç°** (Admin Portal):
```typescript
// ç”Ÿæˆ code_verifier (43-128 å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²)
const codeVerifier = generateRandomString(128);

// è®¡ç®— code_challenge
const codeChallenge = await sha256(codeVerifier);

// å­˜å‚¨ code_verifier ç”¨äºåç»­ token äº¤æ¢
sessionStorage.setItem('pkce_code_verifier', codeVerifier);
```

**éªŒè¯** (OAuth Service - `/home/user/ts-next/apps/oauth-service-rust/src/utils/pkce.rs`):
```rust
pub fn verify_pkce(code_verifier: &str, code_challenge: &str) -> Result<(), PkceError> {
    // è®¡ç®— code_verifier çš„ SHA256
    let computed_challenge = sha256_base64url(code_verifier);

    // å¸¸é‡æ—¶é—´æ¯”è¾ƒ,é˜²æ­¢æ—¶åºæ”»å‡»
    if computed_challenge != code_challenge {
        return Err(PkceError::ChallengeMismatch);
    }
    Ok(())
}
```

#### 2. State å‚æ•° (CSRF ä¿æŠ¤)

**å®ç°** (Admin Portal):
```typescript
// ç”Ÿæˆéšæœº state
const state = generateRandomString(32);
sessionStorage.setItem('oauth_state', state);

// åœ¨ callback ä¸­éªŒè¯
const returnedState = params.get('state');
if (returnedState !== storedState) {
    throw new Error('Invalid state parameter - CSRF attack detected');
}
```

#### 3. Nonce (é‡æ”¾æ”»å‡»ä¿æŠ¤)

**ç”¨é€”**: ç”¨äº ID Token çš„éªŒè¯,ç¡®ä¿ token çš„æ–°é²œæ€§

```typescript
const nonce = generateRandomString(32);
sessionStorage.setItem('oauth_nonce', nonce);

// éªŒè¯ ID Token ä¸­çš„ nonce claim
if (idToken.nonce !== storedNonce) {
    throw new Error('Invalid nonce - replay attack detected');
}
```

### Token ç»“æ„

#### Access Token (JWT)

```json
{
  "header": {
    "alg": "HS256",  // æˆ– RS256 (ç”Ÿäº§ç¯å¢ƒ)
    "typ": "JWT"
  },
  "payload": {
    "sub": "user-uuid",              // ç”¨æˆ· ID
    "client_id": "admin-portal-client",
    "scope": "openid profile email",
    "permissions": [                  // RBAC æƒé™åˆ—è¡¨
      "users:list",
      "users:create",
      "users:read",
      "roles:manage"
    ],
    "iat": 1700000000,               // ç­¾å‘æ—¶é—´
    "exp": 1700000900,               // è¿‡æœŸæ—¶é—´ (15åˆ†é’Ÿå)
    "jti": "token-uuid",             // Token ID (ç”¨äºæ’¤é”€)
    "iss": "http://127.0.0.1:3001"   // ç­¾å‘è€…
  }
}
```

#### Refresh Token

- **æ ¼å¼**: UUID v4 (é JWT)
- **å­˜å‚¨**: æ•°æ®åº“ `refresh_tokens` è¡¨
- **æœ‰æ•ˆæœŸ**: 30 å¤©
- **ç‰¹æ€§**:
  - å¯æ’¤é”€
  - å•æ¬¡ä½¿ç”¨ (å¯é…ç½®)
  - ä¸åŒ…å«æƒé™ä¿¡æ¯ (æƒé™åœ¨åˆ·æ–°æ—¶é‡æ–°åŠ è½½)

#### ID Token (OIDC)

```json
{
  "sub": "user-uuid",
  "aud": "admin-portal-client",
  "iss": "http://127.0.0.1:3001",
  "iat": 1700000000,
  "exp": 1700003600,
  "nonce": "random-nonce-value",
  "email": "admin@example.com",     // å¦‚æœ scope åŒ…å« email
  "name": "Administrator"            // å¦‚æœ scope åŒ…å« profile
}
```

---

## ç”¨æˆ·ç™»å½•æµç¨‹ (OAuth Service ä¸­å¿ƒåŒ–è®¤è¯)

æœ¬æµç¨‹å±•ç¤ºäº†ç”¨æˆ·åœ¨ **OAuth Service** è¿›è¡Œè®¤è¯çš„å®Œæ•´è¿‡ç¨‹ã€‚é‡è¦çš„æ˜¯:
- ç™»å½•é¡µé¢å®Œå…¨ç”± **OAuth Service** æä¾›å’Œæ§åˆ¶
- ç”¨æˆ·å‡­è¯åªå‘é€åˆ° **OAuth Service**,Admin Portal ä¸å‚ä¸ä»»ä½•è®¤è¯è¿‡ç¨‹
- Admin Portal ä»…åœ¨è·å¾—æˆæƒç åæ‰ä¸ OAuth Service äº¤äº’

### æµç¨‹æ­¥éª¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨   â”‚         â”‚Admin Portal â”‚         â”‚OAuth Service â”‚
â”‚          â”‚         â”‚(ç¬¬ä¸‰æ–¹åº”ç”¨)  â”‚         â”‚  (è®¤è¯ä¸­å¿ƒ)   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                      â”‚                       â”‚
     â”‚ 1. è®¿é—® Admin Portal â”‚                       â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                       â”‚
     â”‚                      â”‚                       â”‚
     â”‚ 2. Admin Portal æ£€æŸ¥ â”‚                       â”‚
     â”‚    access_token      â”‚                       â”‚
     â”‚                      â”‚                       â”‚
     â”‚ 3. æ—  token,æ‰§è¡Œ    â”‚ 4. ç”Ÿæˆ PKCE + state â”‚
     â”‚    OAuth æµç¨‹        â”‚ é‡å®šå‘åˆ° OAuth æœåŠ¡  â”‚
     â”‚                      â”‚                       â”‚
     â”‚ 5. 302 â†’ /api/v2/oauth/authorize?...         â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚    (æºå¸¦ PKCE + state å‚æ•°)                  â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 6. æ£€æŸ¥ session
     â”‚                      â”‚                    (cookie)
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 7. æœªç™»å½• â†’ 302
     â”‚                      â”‚                    åˆ°ç™»å½•é¡µ
     â”‚                      â”‚                       â”‚
     â”‚ 8. GET /login?redirect=...                   â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 9. è¿”å›ç™»å½•é¡µé¢
     â”‚                      â”‚                    HTML è¡¨å•
     â”‚                      â”‚                       â”‚
     â”‚ 10. æ˜¾ç¤ºç™»å½•è¡¨å•                              â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚     (æ³¨æ„: æ¥è‡ª OAuth Service)                â”‚
     â”‚                      â”‚                       â”‚
     â”‚ 11. ç”¨æˆ·è¾“å…¥å‡­è¯                              â”‚
     â”‚ (ä»…åœ¨ OAuth Service é¡µé¢ä¸Š)                  â”‚
     â”‚                      â”‚                       â”‚
     â”‚ 12. POST /api/v2/auth/login                  â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚    Content-Type: application/json             â”‚
     â”‚    {                                          â”‚
     â”‚      "username": "admin",                     â”‚
     â”‚      "password": "admin123",                  â”‚
     â”‚      "redirect": "/oauth/authorize?..."      â”‚
     â”‚    }                                          â”‚
     â”‚    æ³¨æ„: ç”¨æˆ·å‡­è¯ç›´æ¥å‘é€ç»™ OAuth Service   â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 13. éªŒè¯å‡­è¯
     â”‚                      â”‚                     - æŸ¥è¯¢ users
     â”‚                      â”‚                     - bcrypt éªŒè¯
     â”‚                      â”‚                     - æ£€æŸ¥çŠ¶æ€
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 14. åŠ è½½æƒé™
     â”‚                      â”‚                     RBAC æŸ¥è¯¢
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 15. ç­¾å‘ token
     â”‚                      â”‚                     session_token
     â”‚                      â”‚                     (å†…éƒ¨ JWT)
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 16. æ›´æ–°ç™»å½•æ—¶é—´
     â”‚                      â”‚                       â”‚
     â”‚ 17. HTTP 200 + Set-Cookie                    â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚    Set-Cookie: session_token=<jwt>;          â”‚
     â”‚      HttpOnly; Secure; SameSite=Lax;         â”‚
     â”‚      Path=/; Max-Age=3600                    â”‚
     â”‚    {                                          â”‚
     â”‚      "success": true,                        â”‚
     â”‚      "redirect_url": "/oauth/authorize?..."  â”‚
     â”‚    }                                          â”‚
     â”‚                      â”‚                       â”‚
     â”‚ 18. JavaScript é‡å®šå‘                        â”‚
     â”‚     window.location = redirect_url           â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚     (è‡ªåŠ¨æºå¸¦ session_token cookie)          â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                 19. ç»§ç»­æˆæƒæµç¨‹
     â”‚                      â”‚                     (è§ä¸Šæ–‡)
```

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡

**æ ¸å¿ƒåŸåˆ™ - OAuth 2.1 å»ä¸­å¿ƒåŒ–**:
1. **å•ä¸€è´£ä»»**: OAuth Service æ˜¯å”¯ä¸€å¤„ç†å‡­è¯çš„åœ°æ–¹
2. **å®‰å…¨éš”ç¦»**: Admin Portal æ°¸è¿œä¸æ¥è§¦ç”¨æˆ·å¯†ç 
3. **æ ‡å‡†åˆè§„**: ç¬¦åˆ OAuth 2.1 å’Œ OIDC è§„èŒƒ
4. **æ˜“äºæ‰©å±•**: æ–°çš„ç¬¬ä¸‰æ–¹åº”ç”¨æ— éœ€ä¿®æ”¹ OAuth Service

**ç±»æ¯” Google è®¤è¯**:
```
ç”¨æˆ·è®¿é—® Gmail
  â†“
Gmail æ£€æµ‹æ— ç™»å½•
  â†“
Gmail é‡å®šå‘åˆ° accounts.google.com (Google çš„è®¤è¯ä¸­å¿ƒ)
  â†“
ç”¨æˆ·åœ¨ Google ç™»å½•é¡µé¢è¾“å…¥å‡­è¯
  â†“
Google éªŒè¯,è¿”å›æˆæƒç 
  â†“
Gmail ä½¿ç”¨æˆæƒç äº¤æ¢ token
  â†“
ç”¨æˆ·å›åˆ° Gmail,å·²ç™»å½•
```

æœ¬ç³»ç»Ÿå®Œå…¨éµå¾ªæ­¤æ¨¡å¼:
- OAuth Service = Google çš„ accounts.google.com
- Admin Portal = Gmail (ç¬¬ä¸‰æ–¹åº”ç”¨)

### Session Token çš„å®‰å…¨ç‰¹æ€§

**Cookie å±æ€§** (`/home/user/ts-next/apps/oauth-service-rust/src/routes/oauth.rs`, lines 156-162):

```rust
let session_cookie = Cookie::build(("session_token", token_pair.access_token))
    .path("/")                       // å…¨ç«™å¯è®¿é—®
    // .domain() æ•…æ„ä¸è®¾ç½® - è®©æµè§ˆå™¨ä½¿ç”¨å½“å‰ host
    .http_only(true)                 // âœ… é˜²æ­¢ XSS - JavaScript æ— æ³•è®¿é—®
    .secure(is_production)           // âœ… ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ HTTPS
    .same_site(SameSite::Lax)        // âœ… CSRF ä¿æŠ¤ - å…è®¸é¡¶çº§å¯¼èˆª
    .max_age(time::Duration::hours(1)); // 1 å°æ—¶è¿‡æœŸ
```

**ä¸ºä»€ä¹ˆä¸è®¾ç½® domain å±æ€§?**
- è®©æµè§ˆå™¨è‡ªåŠ¨ä½¿ç”¨å½“å‰è¯·æ±‚çš„ host
- ç¡®ä¿é€šè¿‡ Pingora ä»£ç†æ—¶ cookie æ­£ç¡®å·¥ä½œ
- é¿å…è·¨åŸŸ cookie çš„å®‰å…¨é£é™©

---

## åŒæ„é¡µé¢æµç¨‹ (ç”¨æˆ·æˆæƒç¡®è®¤)

æœ¬æµç¨‹å±•ç¤ºäº†ç”¨æˆ·åœ¨åŒæ„é¡µé¢ç¡®è®¤æˆ–æ‹’ç»æˆæƒè¯·æ±‚çš„è¿‡ç¨‹ã€‚è¿™æ˜¯ OAuth 2.1 æˆæƒç æµç¨‹ä¸­çš„å…³é”®æ­¥éª¤ï¼Œç¡®ä¿ç”¨æˆ·æ˜ç¡®çŸ¥é“ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚äº†å“ªäº›æƒé™ã€‚

### æµç¨‹æ¦‚è§ˆ

åŒæ„é¡µé¢åœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ï¼š
- ç”¨æˆ·å·²ç™»å½•ï¼ˆæœ‰ session_tokenï¼‰
- OAuth Service æ£€æŸ¥å®¢æˆ·ç«¯é…ç½®çš„ `require_consent` æ ‡å¿—
- å¦‚æœéœ€è¦åŒæ„ï¼Œé‡å®šå‘åˆ° Admin Portal çš„ `/oauth/consent` é¡µé¢

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨   â”‚         â”‚Admin Portal â”‚         â”‚OAuth Service â”‚
â”‚          â”‚         â”‚(ç¬¬ä¸‰æ–¹åº”ç”¨)  â”‚         â”‚  (è®¤è¯ä¸­å¿ƒ)   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                      â”‚                       â”‚
     â”‚ (ç”¨æˆ·å·²ç™»å½•ï¼Œè¿”å›åˆ° authorize è¯·æ±‚)         â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚ 1. GET /authorize?... â”‚
     â”‚                      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                      â”‚    (æºå¸¦ PKCE å‚æ•°)   â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚    2. æ£€æŸ¥ session_token
     â”‚                      â”‚       æœ‰æ•ˆ âœ“          â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚    3. æ£€æŸ¥ require_consent
     â”‚                      â”‚       æ ‡å¿—            â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚ 4. é‡å®šå‘åˆ°åŒæ„é¡µé¢   â”‚
     â”‚ GET /oauth/consent?client_id=...             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚    (æºå¸¦æ‰€æœ‰ OAuth å‚æ•°)                     â”‚
     â”‚                                               â”‚
     â”‚ 5. æ˜¾ç¤ºåŒæ„é¡µé¢                              â”‚
     â”‚    - åº”ç”¨åç§°å’Œ Logo                         â”‚
     â”‚    - è¯·æ±‚çš„æƒé™èŒƒå›´                         â”‚
     â”‚    - å½“å‰ç™»å½•ç”¨æˆ·                           â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
     â”‚                                               â”‚
     â”‚    6. è·å–åŒæ„ä¿¡æ¯                           â”‚
     â”‚ è°ƒç”¨ GET /api/v2/oauth/consent/info?...      â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚    (æºå¸¦æ‰€æœ‰ OAuth å‚æ•°)                     â”‚
     â”‚                                               â”‚
     â”‚                      â”‚                   7. éªŒè¯ç”¨æˆ·
     â”‚                      â”‚                      (session_token)
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                   8. éªŒè¯ client_id
     â”‚                      â”‚                      å’Œ redirect_uri
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚                   9. åŠ è½½æƒé™ä¿¡æ¯
     â”‚                      â”‚                      (scopes)
     â”‚                      â”‚                       â”‚
     â”‚ è¿”å› ConsentApiData                          â”‚
     â”‚ {                                            â”‚
     â”‚   client: { id, name, logoUri },            â”‚
     â”‚   requested_scopes: [{name, desc}],         â”‚
     â”‚   user: { id, username },                   â”‚
     â”‚   ...OAuth å‚æ•°...                          â”‚
     â”‚ }                                            â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚                                               â”‚
     â”‚ 10. æ˜¾ç¤ºåŒæ„ç¡®è®¤å¯¹è¯æ¡†                       â”‚
     â”‚     (åŒ…å«è¯¦ç»†çš„æƒé™ä¿¡æ¯)                    â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚                                               â”‚
     â”‚ 11. ç”¨æˆ·é€‰æ‹©"å…è®¸"æˆ–"æ‹’ç»"                  â”‚
     â”‚                                               â”‚
     â”‚ 12. POST /api/v2/oauth/consent/submit        â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚    {                                         â”‚
     â”‚      "decision": "allow"|"deny"             â”‚
     â”‚      "client_id": "...",                     â”‚
     â”‚      "redirect_uri": "...",                  â”‚
     â”‚      "scope": "...",                         â”‚
     â”‚      ...å…¶ä»– OAuth å‚æ•°...                  â”‚
     â”‚    }                                         â”‚
     â”‚                                               â”‚
     â”‚                      â”‚                  13. éªŒè¯ç”¨æˆ·
     â”‚                      â”‚                     (session_token)
     â”‚                      â”‚                       â”‚
     â”‚ 14a. ç”¨æˆ·æ‹’ç» (decision=deny):               â”‚
     â”‚    è¿”å›: {                                   â”‚
     â”‚      "redirect_uri":                         â”‚
     â”‚      "https://client.com?error=access_denied" â”‚
     â”‚    }                                         â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚                                               â”‚
     â”‚ 14b. ç”¨æˆ·å…è®¸ (decision=allow):              â”‚
     â”‚    - ç”Ÿæˆæˆæƒç  (auth_code)                 â”‚
     â”‚    è¿”å›: {                                   â”‚
     â”‚      "redirect_uri":                         â”‚
     â”‚      "https://client.com?code=<code>&state=..." â”‚
     â”‚    }                                         â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚                                               â”‚
     â”‚ 15. JavaScript é‡å®šå‘åˆ° redirect_uri        â”‚
     â”‚     window.location = response.redirect_uri  â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                                               â”‚
     â”‚ 16. æµè§ˆå™¨è·³è½¬åˆ°å®¢æˆ·ç«¯åº”ç”¨                   â”‚
     â”‚     (è¿”å›åˆ°åŸå§‹çš„ OAuth æˆæƒæµç¨‹)           â”‚
```

### å…³é”®æ­¥éª¤è¯¦è§£

#### 1. è§¦å‘åŒæ„é¡µé¢ (OAuth Service)

å½“ç”¨æˆ·ç™»å½•åè¿”å›åˆ° `/authorize` è¯·æ±‚æ—¶ï¼š

```rust
// OAuth Service - æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºåŒæ„é¡µé¢
if client_details.client.require_consent {
    // é‡å®šå‘åˆ° Admin Portal çš„åŒæ„é¡µé¢
    let consent_url = format!(
        "{}/oauth/consent?client_id={}&redirect_uri={}&...",
        admin_portal_url,
        request.client_id,
        request.redirect_uri
    );
    return Ok(Redirect::to(&consent_url).into_response());
}
```

#### 2. è·å–åŒæ„ä¿¡æ¯ (GET /api/v2/oauth/consent/info)

Admin Portal è°ƒç”¨æ­¤ç«¯ç‚¹è·å–æ˜¾ç¤ºåŒæ„å¯¹è¯æ¡†æ‰€éœ€çš„ä¿¡æ¯ï¼š

**è¯·æ±‚å‚æ•°**ï¼š
- `client_id`: è¯·æ±‚æˆæƒçš„å®¢æˆ·ç«¯ ID
- `redirect_uri`: å®¢æˆ·ç«¯çš„é‡å®šå‘ URI
- `response_type`: å“åº”ç±»å‹ï¼ˆé€šå¸¸ä¸º "code"ï¼‰
- `scope`: è¯·æ±‚çš„æƒé™èŒƒå›´
- `code_challenge`: PKCE ä»£ç æŒ‘æˆ˜
- `code_challenge_method`: PKCE æ–¹æ³•ï¼ˆé€šå¸¸ä¸º "S256"ï¼‰
- `state`: CSRF ä¿æŠ¤å‚æ•°ï¼ˆå¯é€‰ï¼‰
- `nonce`: OpenID Connect å‚æ•°ï¼ˆå¯é€‰ï¼‰

**å“åº”å†…å®¹**ï¼š
```json
{
  "client": {
    "id": "admin-portal-client",
    "name": "Admin Portal",
    "logo_uri": "https://example.com/logo.png"
  },
  "requested_scopes": [
    {
      "name": "read",
      "description": "è¯»å–ç”¨æˆ·ä¿¡æ¯çš„æƒé™"
    },
    {
      "name": "write",
      "description": "ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯çš„æƒé™"
    }
  ],
  "user": {
    "id": "user-123",
    "username": "admin"
  },
  "client_id": "admin-portal-client",
  "redirect_uri": "https://example.com/callback",
  "scope": "read write",
  "response_type": "code",
  "code_challenge": "...",
  "code_challenge_method": "S256",
  "state": "...",
  "nonce": null,
  "consent_form_action_url": "http://localhost:3001/api/v2/oauth/consent/submit"
}
```

**å®‰å…¨è€ƒè™‘**ï¼š
- âœ… å¿…é¡»éªŒè¯ç”¨æˆ·å·²è®¤è¯ï¼ˆsession_tokenï¼‰
- âœ… å¿…é¡»éªŒè¯ client_id å’Œ redirect_uri
- âœ… å¿…é¡»éªŒè¯ scope åœ¨å®¢æˆ·ç«¯çš„å…è®¸èŒƒå›´å†…

#### 3. æäº¤åŒæ„å†³å®š (POST /api/v2/oauth/consent/submit)

Admin Portal ä½¿ç”¨æ­¤ç«¯ç‚¹æäº¤ç”¨æˆ·çš„åŒæ„å†³å®šï¼š

**è¯·æ±‚å†…å®¹**ï¼š
```json
{
  "decision": "allow",
  "client_id": "admin-portal-client",
  "redirect_uri": "https://example.com/callback",
  "response_type": "code",
  "scope": "read write",
  "state": "...",
  "code_challenge": "...",
  "code_challenge_method": "S256",
  "nonce": null
}
```

**å“åº” (å…è®¸)**ï¼š
```json
{
  "redirect_uri": "https://example.com/callback?code=AUTH_CODE_VALUE&state=..."
}
```

**å“åº” (æ‹’ç»)**ï¼š
```json
{
  "redirect_uri": "https://example.com/callback?error=access_denied&state=..."
}
```

**å®‰å…¨è€ƒè™‘**ï¼š
- âœ… éªŒè¯ç”¨æˆ·è®¤è¯çŠ¶æ€
- âœ… éªŒè¯ client_id å’Œ redirect_uri
- âœ… éªŒè¯ scope çš„æœ‰æ•ˆæ€§
- âœ… å¦‚æœç”¨æˆ·æ‹’ç»ï¼Œè¿”å›æ ‡å‡† OAuth error
- âœ… å¦‚æœç”¨æˆ·å…è®¸ï¼Œç”Ÿæˆæˆæƒç 

### å·¥ä½œæµç¨‹ç¤ºä¾‹

**ç”¨æˆ·å…è®¸çš„å®Œæ•´æµç¨‹**ï¼š

1. **ç¬¬ 1 æ­¥**: ç”¨æˆ·è®¿é—® Admin Portal
2. **ç¬¬ 2 æ­¥**: Admin Portal å‘èµ· OAuth authorize è¯·æ±‚
3. **ç¬¬ 3 æ­¥**: OAuth Service æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ (æœ‰ session_token)
4. **ç¬¬ 4 æ­¥**: OAuth Service æ£€æŸ¥ `require_consent=true`
5. **ç¬¬ 5 æ­¥**: OAuth Service é‡å®šå‘åˆ° Admin Portal çš„ `/oauth/consent?...`
6. **ç¬¬ 6 æ­¥**: Admin Portal è°ƒç”¨ GET `/api/v2/oauth/consent/info` è·å–ä¿¡æ¯
7. **ç¬¬ 7 æ­¥**: Admin Portal æ˜¾ç¤ºåŒæ„å¯¹è¯æ¡†ï¼Œåˆ—å‡ºæƒé™èŒƒå›´
8. **ç¬¬ 8 æ­¥**: ç”¨æˆ·æŸ¥çœ‹æƒé™åç‚¹å‡»"å…è®¸"æŒ‰é’®
9. **ç¬¬ 9 æ­¥**: Admin Portal è°ƒç”¨ POST `/api/v2/oauth/consent/submit?decision=allow`
10. **ç¬¬ 10 æ­¥**: OAuth Service éªŒè¯ç”¨æˆ·å’Œæƒé™ï¼Œç”Ÿæˆæˆæƒç 
11. **ç¬¬ 11 æ­¥**: OAuth Service è¿”å› `redirect_uri=https://client.com?code=CODE&state=...`
12. **ç¬¬ 12 æ­¥**: Admin Portal é‡å®šå‘æµè§ˆå™¨åˆ°æˆæƒç å›è°ƒ URL
13. **ç¬¬ 13 æ­¥**: å®¢æˆ·ç«¯åº”ç”¨ä½¿ç”¨æˆæƒç äº¤æ¢ access_token

### å®‰å…¨æœ€ä½³å®è·µ

#### ç”¨æˆ·éªŒè¯

åœ¨åŒæ„æµç¨‹ä¸­ï¼ŒOAuth Service å¿…é¡»ï¼š
- âœ… éªŒè¯è¯·æ±‚ä¸­çš„ session_token
- âœ… ç¡®ä¿ session_token æœªè¿‡æœŸï¼ˆ1 å°æ—¶ï¼‰
- âœ… ä» token ä¸­æå– user_id

#### å®¢æˆ·ç«¯éªŒè¯

- âœ… éªŒè¯ client_id å­˜åœ¨ä¸”å¤„äºæ´»è·ƒçŠ¶æ€
- âœ… éªŒè¯ redirect_uri åœ¨å®¢æˆ·ç«¯çš„ç™½åå•ä¸­
- âœ… éªŒè¯ scope åœ¨å®¢æˆ·ç«¯çš„å…è®¸èŒƒå›´å†…

#### æƒé™èŒƒå›´éªŒè¯

- âœ… è§£æ scope å­—ç¬¦ä¸²ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰
- âœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¯·æ±‚çš„æƒé™
- âœ… å¦‚æœç”¨æˆ·ç¼ºå°‘æƒé™ï¼Œåº”è¯¥ï¼š
  - è¿”å› error ä¿¡æ¯ï¼Œæˆ–
  - åªè¿”å›ç”¨æˆ·æ‹¥æœ‰çš„æƒé™ï¼ˆdownscopingï¼‰

#### æ‹’ç»å¤„ç†

å½“ç”¨æˆ·æ‹’ç»æ—¶ï¼š
- âœ… è¿”å› error=access_deniedï¼ˆæ ‡å‡† OAuth é”™è¯¯ï¼‰
- âœ… ä¿ç•™ state å‚æ•°ï¼ˆCSRF ä¿æŠ¤ï¼‰
- âœ… **ä¸é‡å®šå‘åˆ° Admin Portal çš„é”™è¯¯é¡µé¢**
- âœ… **ç›´æ¥è¿”å›åŒ…å« error çš„ redirect_uri**

#### æˆæƒç ç”Ÿæˆ

å½“ç”¨æˆ·å…è®¸æ—¶ï¼š
- âœ… ç”ŸæˆçŸ­æœŸçš„æˆæƒç ï¼ˆ10 åˆ†é’Ÿè¿‡æœŸï¼‰
- âœ… å­˜å‚¨æˆæƒç ä¸ user_idã€client_idã€scope çš„å…³è”
- âœ… ä¿ç•™ PKCE code_challenge ç”¨äºåç»­éªŒè¯
- âœ… è¿”å›å¸¦ code å’Œ state çš„é‡å®šå‘ URI

### å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆéœ€è¦åŒæ„é¡µé¢ï¼Ÿ**

A: åŒæ„é¡µé¢æ˜¯ OAuth çš„æ ¸å¿ƒå®‰å…¨ç‰¹æ€§ã€‚å®ƒç¡®ä¿ï¼š
- ç”¨æˆ·æ˜ç¡®çŸ¥é“ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚äº†å“ªäº›æƒé™
- ç”¨æˆ·å¯ä»¥é€‰æ‹©æ‹’ç»ä¸åˆç†çš„æƒé™è¯·æ±‚
- ç¬¦åˆ GDPR ç­‰éšç§æ³•è§„è¦æ±‚

**Q: å¦‚æœç”¨æˆ·æ‹’ç»ä¼šæ€æ ·ï¼Ÿ**

A: OAuth Service è¿”å› error=access_deniedï¼Œå®¢æˆ·ç«¯åº”ç”¨åº”è¯¥ï¼š
- æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- å…è®¸ç”¨æˆ·é‡æ–°å°è¯•
- **ä¸åº”è¯¥** é‡å®šå‘åˆ°ç™»å½•é¡µé¢

**Q: åŒæ„ä¿¡æ¯ä¼šè¢«ç¼“å­˜å—ï¼Ÿ**

A: ä¸ä¼šã€‚åŒæ„ä¿¡æ¯ç”± Admin Portal æ¯æ¬¡è°ƒç”¨æ—¶ä» OAuth Service è·å–ï¼Œç¡®ä¿å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚

---

## Token åˆ·æ–°æµç¨‹

å½“ access token è¿‡æœŸå,å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ refresh token è·å–æ–°çš„ access token,è€Œæ— éœ€ç”¨æˆ·é‡æ–°ç™»å½•ã€‚

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯   â”‚                    â”‚Admin Portal â”‚                    â”‚OAuth Service â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                 â”‚                                   â”‚
     â”‚ 1. API è°ƒç”¨è¿”å› 401              â”‚                                   â”‚
     â”‚    (access_token è¿‡æœŸ)           â”‚                                   â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                   â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚ 2. æ£€æµ‹åˆ° 401 é”™è¯¯                â”‚
     â”‚                                 â”‚    - æ£€æŸ¥æ˜¯å¦æœ‰ refresh_token     â”‚
     â”‚                                 â”‚    - è§¦å‘è‡ªåŠ¨åˆ·æ–°                 â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚ 3. POST /api/v2/oauth/token       â”‚
     â”‚                                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                 â”‚    {                               â”‚
     â”‚                                 â”‚      "grant_type": "refresh_token",â”‚
     â”‚                                 â”‚      "refresh_token": "<uuid>",    â”‚
     â”‚                                 â”‚      "client_id": "admin-portal-client", â”‚
     â”‚                                 â”‚      "client_secret": "<secret>"   â”‚
     â”‚                                 â”‚    }                               â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚                    4. éªŒè¯å®¢æˆ·ç«¯  â”‚
     â”‚                                 â”‚                       - client_id + secret â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚                    5. éªŒè¯ refresh token â”‚
     â”‚                                 â”‚                       - æŸ¥è¯¢ refresh_tokens è¡¨ â”‚
     â”‚                                 â”‚                       - æ£€æŸ¥æ˜¯å¦å·²æ’¤é”€ â”‚
     â”‚                                 â”‚                       - æ£€æŸ¥æ˜¯å¦è¿‡æœŸ â”‚
     â”‚                                 â”‚                       - æ£€æŸ¥ client_id åŒ¹é… â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚                    6. æå– user_id â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚                    7. é‡æ–°åŠ è½½ç”¨æˆ·æƒé™ â”‚
     â”‚                                 â”‚                       - æŸ¥è¯¢æœ€æ–°çš„ RBAC â”‚
     â”‚                                 â”‚                       - æ›´æ–°æƒé™ç¼“å­˜ â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚                    8. ç­¾å‘æ–° Token Pair â”‚
     â”‚                                 â”‚                       - æ–° access_token â”‚
     â”‚                                 â”‚                       - æ–° refresh_token (token rotation) â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚                    9. æ’¤é”€æ—§ refresh token â”‚
     â”‚                                 â”‚                       (å¯é€‰,å–å†³äºé…ç½®) â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚ 10. è¿”å›æ–° tokens                 â”‚
     â”‚                                 â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                 â”‚    {                               â”‚
     â”‚                                 â”‚      "access_token": "<new_jwt>",  â”‚
     â”‚                                 â”‚      "token_type": "Bearer",       â”‚
     â”‚                                 â”‚      "expires_in": 3600,           â”‚
     â”‚                                 â”‚      "refresh_token": "<new_uuid>",â”‚
     â”‚                                 â”‚      "scope": "openid profile email" â”‚
     â”‚                                 â”‚    }                               â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚ 11. æ›´æ–°æœ¬åœ°å­˜å‚¨                  â”‚
     â”‚                                 â”‚     - æ›¿æ¢æ—§ tokens               â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚                                 â”‚ 12. é‡è¯•åŸå§‹ API è¯·æ±‚             â”‚
     â”‚                                 â”‚     - ä½¿ç”¨æ–° access_token         â”‚
     â”‚                                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                 â”‚                                   â”‚
     â”‚ 13. è¯·æ±‚æˆåŠŸ                    â”‚                                   â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### Refresh Token Rotation

**ä¸ºä»€ä¹ˆéœ€è¦ Token Rotation?**
- **å®‰å…¨æ€§**: å³ä½¿ refresh token æ³„éœ²,çª—å£æœŸä¹Ÿå¾ˆçŸ­
- **æ£€æµ‹ç›—ç”¨**: å¦‚æœæ—§ token è¢«é‡å¤ä½¿ç”¨,å¯èƒ½è¡¨ç¤º token è¢«ç›—

**å®ç°** (`/home/user/ts-next/apps/oauth-service-rust/src/services/token_service.rs`):

```rust
// æ¯æ¬¡åˆ·æ–°éƒ½ç”Ÿæˆæ–°çš„ refresh token
let new_refresh_token = Uuid::new_v4().to_string();

// ä¿å­˜æ–° token,æ ‡è®° previous_token_id
sqlx::query(
    "INSERT INTO refresh_tokens (token, user_id, client_id, previous_token_id, ...)
     VALUES (?, ?, ?, ?, ...)"
)
.bind(&new_refresh_token)
.bind(&old_token.user_id)
.bind(&old_token.client_id)
.bind(&old_refresh_token)  // é“¾å¼è¿½è¸ª
.execute(pool)
.await?;

// æ’¤é”€æ—§ refresh token
sqlx::query("UPDATE refresh_tokens SET is_revoked = 1 WHERE token = ?")
    .bind(&old_refresh_token)
    .execute(pool)
    .await?;
```

---

## å®¢æˆ·ç«¯å‡­è¯æµç¨‹

ç”¨äº**æœåŠ¡é—´è°ƒç”¨**(Machine-to-Machine),ä¸æ¶‰åŠç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯æœåŠ¡    â”‚                                  â”‚OAuth Service â”‚
â”‚  (Client)   â”‚                                  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                â”‚
       â”‚ 1. POST /api/v2/oauth/token                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚    {                                           â”‚
       â”‚      "grant_type": "client_credentials",       â”‚
       â”‚      "client_id": "backend-service-client",    â”‚
       â”‚      "client_secret": "<secret>",              â”‚
       â”‚      "scope": "api:read api:write"             â”‚
       â”‚    }                                           â”‚
       â”‚                                                â”‚
       â”‚                                 2. éªŒè¯å®¢æˆ·ç«¯  â”‚
       â”‚                                    - client_id â”‚
       â”‚                                    - client_secret â”‚
       â”‚                                    - å¿…é¡»æ˜¯ CONFIDENTIAL ç±»å‹ â”‚
       â”‚                                                â”‚
       â”‚                                 3. éªŒè¯ scope  â”‚
       â”‚                                    - æ£€æŸ¥ allowed_scopes â”‚
       â”‚                                                â”‚
       â”‚                                 4. è·å–å®¢æˆ·ç«¯æƒé™ â”‚
       â”‚                                    - client_permissions (é¢„é…ç½®) â”‚
       â”‚                                    - ä¸å…³è”ç”¨æˆ· (sub = null) â”‚
       â”‚                                                â”‚
       â”‚                                 5. ç­¾å‘ access_token â”‚
       â”‚                                    - æ—  refresh_token â”‚
       â”‚                                    - æ—  id_token      â”‚
       â”‚                                    - è¾ƒçŸ­çš„ TTL       â”‚
       â”‚                                                â”‚
       â”‚ 6. è¿”å› token                                  â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    {                                           â”‚
       â”‚      "access_token": "<jwt>",                  â”‚
       â”‚      "token_type": "Bearer",                   â”‚
       â”‚      "expires_in": 3600,                       â”‚
       â”‚      "scope": "api:read api:write"             â”‚
       â”‚    }                                           â”‚
```

### å®¢æˆ·ç«¯å‡­è¯ Token ç»“æ„

```json
{
  "sub": null,                         // æ²¡æœ‰ç”¨æˆ·ä¸Šä¸‹æ–‡
  "client_id": "backend-service-client",
  "scope": "api:read api:write",
  "permissions": [                     // å®¢æˆ·ç«¯çº§åˆ«çš„æƒé™
    "api:access",
    "data:read"
  ],
  "iat": 1700000000,
  "exp": 1700003600,
  "jti": "token-uuid",
  "iss": "http://127.0.0.1:3001"
}
```

### ä½¿ç”¨åœºæ™¯

- åç«¯æœåŠ¡è°ƒç”¨ API
- å®šæ—¶ä»»åŠ¡è®¿é—®èµ„æº
- æœåŠ¡é—´è®¤è¯
- Webhook å›è°ƒ

---

## Token å†…çœå’Œæ’¤é”€

### Token å†…çœ (Introspection)

ç”¨äºéªŒè¯ token çš„æœ‰æ•ˆæ€§å¹¶è·å– token çš„å…ƒæ•°æ®ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resource    â”‚                                  â”‚OAuth Service â”‚
â”‚ Server      â”‚                                  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                â”‚
       â”‚ 1. POST /api/v2/oauth/introspect               â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚    Form: token=<access_or_refresh_token>       â”‚
       â”‚                                                â”‚
       â”‚                                 2. è§£æ token  â”‚
       â”‚                                    - JWT éªŒè¯ç­¾å â”‚
       â”‚                                    - æ£€æŸ¥è¿‡æœŸæ—¶é—´ â”‚
       â”‚                                    - æŸ¥è¯¢æ’¤é”€åˆ—è¡¨ â”‚
       â”‚                                                â”‚
       â”‚ 3. è¿”å› introspection response                 â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    {                                           â”‚
       â”‚      "active": true,                           â”‚
       â”‚      "scope": "openid profile",                â”‚
       â”‚      "client_id": "admin-portal-client",       â”‚
       â”‚      "username": null,                         â”‚
       â”‚      "sub": "user-uuid",                       â”‚
       â”‚      "exp": 1700003600                         â”‚
       â”‚    }                                           â”‚
```

**å®ç°** (`/home/user/ts-next/apps/oauth-service-rust/src/services/token_service.rs`):

```rust
pub async fn introspect_token(&self, token: &str) -> Result<TokenClaims, ServiceError> {
    // 1. è§£ç å¹¶éªŒè¯ JWT
    let token_data = decode::<TokenClaims>(
        token,
        &self.decoding_key,
        &Validation::new(self.algorithm)
    )?;

    // 2. æ£€æŸ¥æ˜¯å¦è¢«æ’¤é”€
    if self.is_token_revoked(&token_data.claims.jti).await? {
        return Err(ServiceError::Unauthorized("Token has been revoked".to_string()));
    }

    Ok(token_data.claims)
}
```

### Token æ’¤é”€ (Revocation)

ç¬¦åˆ **RFC 7009** æ ‡å‡†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯      â”‚                                  â”‚OAuth Service â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                â”‚
       â”‚ 1. POST /api/v2/oauth/revoke                   â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚    Form:                                       â”‚
       â”‚      token=<token_to_revoke>                   â”‚
       â”‚      client_id=<client_id>                     â”‚
       â”‚      client_secret=<secret>                    â”‚
       â”‚      token_type_hint=refresh_token (optional)  â”‚
       â”‚                                                â”‚
       â”‚                                 2. éªŒè¯å®¢æˆ·ç«¯  â”‚
       â”‚                                                â”‚
       â”‚                                 3. æ’¤é”€ token  â”‚
       â”‚                                    - å¦‚æœæ˜¯ refresh_token: â”‚
       â”‚                                      UPDATE is_revoked = 1 â”‚
       â”‚                                    - å¦‚æœæ˜¯ access_token:  â”‚
       â”‚                                      INSERT INTO revoked_access_tokens â”‚
       â”‚                                                â”‚
       â”‚ 4. è¿”å›æˆåŠŸ (RFC 7009: å³ä½¿å¤±è´¥ä¹Ÿè¿”å› 200)      â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    200 OK                                      â”‚
```

**å®ç°** (`/home/user/ts-next/apps/oauth-service-rust/src/services/token_service.rs`):

```rust
pub async fn revoke_token(&self, token: &str, token_type_hint: Option<&str>)
    -> Result<(), ServiceError> {

    match token_type_hint {
        Some("refresh_token") | None => {
            // å°è¯•æ’¤é”€ refresh token
            sqlx::query("UPDATE refresh_tokens SET is_revoked = 1 WHERE token = ?")
                .bind(token)
                .execute(&*self.pool)
                .await?;
        }
        Some("access_token") => {
            // è§£æ JWT è·å– jti
            let claims = self.introspect_token(token).await?;

            // å°† jti åŠ å…¥æ’¤é”€åˆ—è¡¨
            sqlx::query("INSERT INTO revoked_access_tokens (jti, revoked_at) VALUES (?, ?)")
                .bind(&claims.jti)
                .bind(Utc::now())
                .execute(&*self.pool)
                .await?;
        }
        _ => return Err(ServiceError::ValidationError("Invalid token_type_hint".to_string())),
    }

    Ok(())
}
```

---

## å—ä¿æŠ¤èµ„æºè®¿é—®æµç¨‹

å±•ç¤ºå®¢æˆ·ç«¯å¦‚ä½•ä½¿ç”¨ access token è®¿é—®å—ä¿æŠ¤çš„ API èµ„æºã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯   â”‚         â”‚   Pingora   â”‚         â”‚OAuth Service â”‚         â”‚   Database   â”‚
â”‚          â”‚         â”‚    Proxy    â”‚         â”‚  (Middleware)â”‚         â”‚              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚ 1. GET /api/v2/admin/users                   â”‚                        â”‚
     â”‚    Authorization: Bearer <access_token>      â”‚                        â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚ 2. è·¯ç”±åˆ° OAuth Service                        â”‚
     â”‚                      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                        â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚ 3. Rate Limit Middleware â”‚
     â”‚                      â”‚                       â”‚    - æ£€æŸ¥ IP è¯·æ±‚é¢‘ç‡   â”‚
     â”‚                      â”‚                       â”‚    - 100 req/min        â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚ 4. Auth Middleware      â”‚
     â”‚                      â”‚                       â”‚    - æå– Bearer token  â”‚
     â”‚                      â”‚                       â”‚    - JWT éªŒè¯ç­¾å       â”‚
     â”‚                      â”‚                       â”‚    - æ£€æŸ¥è¿‡æœŸæ—¶é—´       â”‚
     â”‚                      â”‚                       â”‚    - æ£€æŸ¥æ’¤é”€çŠ¶æ€       â”‚
     â”‚                      â”‚                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                      â”‚                       â”‚    æŸ¥è¯¢ revoked_access_tokens â”‚
     â”‚                      â”‚                       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚    - æå– claims:       â”‚
     â”‚                      â”‚                       â”‚      * sub (user_id)    â”‚
     â”‚                      â”‚                       â”‚      * client_id        â”‚
     â”‚                      â”‚                       â”‚      * permissions[]    â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚    - æ³¨å…¥ AuthContext   â”‚
     â”‚                      â”‚                       â”‚      åˆ° request extensions â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚ 5. Permission Middleware â”‚
     â”‚                      â”‚                       â”‚    - æå– AuthContext   â”‚
     â”‚                      â”‚                       â”‚    - è·å–è·¯ç”±æƒé™è¦æ±‚   â”‚
     â”‚                      â”‚                       â”‚      GET /api/v2/admin/users â”‚
     â”‚                      â”‚                       â”‚      â†’ éœ€è¦ "users:list" â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚    - æ£€æŸ¥ç”¨æˆ·æƒé™       â”‚
     â”‚                      â”‚                       â”‚      "users:list" in permissions? â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚    âœ… æƒé™éªŒè¯é€šè¿‡      â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚ 6. Route Handler        â”‚
     â”‚                      â”‚                       â”‚    - æ‰§è¡Œä¸šåŠ¡é€»è¾‘       â”‚
     â”‚                      â”‚                       â”‚    - æŸ¥è¯¢ users è¡¨      â”‚
     â”‚                      â”‚                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                      â”‚                       â”‚    SELECT * FROM users  â”‚
     â”‚                      â”‚                       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚                      â”‚                       â”‚ 7. Audit Middleware     â”‚
     â”‚                      â”‚                       â”‚    - è®°å½•è¯·æ±‚æ—¥å¿—       â”‚
     â”‚                      â”‚                       â”‚    - user_id, path, status â”‚
     â”‚                      â”‚                       â”‚    - å¤„ç†æ—¶é—´           â”‚
     â”‚                      â”‚                       â”‚                        â”‚
     â”‚ 8. è¿”å›å“åº”          â”‚                       â”‚                        â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚
     â”‚    {                                         â”‚                        â”‚
     â”‚      "users": [...],                         â”‚                        â”‚
     â”‚      "total": 100,                           â”‚                        â”‚
     â”‚      "page": 1                               â”‚                        â”‚
     â”‚    }                                         â”‚                        â”‚
```

### ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº

**è¯·æ±‚å¤„ç†é“¾** (`/home/user/ts-next/apps/oauth-service-rust/src/app.rs`, lines 101-126):

```
è¯·æ±‚è¿›å…¥
  â†“
[1] Rate Limit Middleware â”€â”€â”€â”€â†’ 429 Too Many Requests (å¦‚æœè¶…é™)
  â†“
[2] Auth Middleware â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ 401 Unauthorized (å¦‚æœ token æ— æ•ˆ)
  â†“  (æ³¨å…¥ AuthContext)
[3] Permission Middleware â”€â”€â”€â”€â†’ 403 Forbidden (å¦‚æœæƒé™ä¸è¶³)
  â†“
[4] CORS Layer
  â†“
[5] Tracing Layer
  â†“
[6] Route Handler (ä¸šåŠ¡é€»è¾‘)
  â†“
[7] Audit Middleware (å“åº”åè®°å½•)
  â†“
å“åº”è¿”å›
```

---

## æƒé™éªŒè¯æµç¨‹

å±•ç¤º RBAC (Role-Based Access Control) çš„å®Œæ•´å·¥ä½œæµç¨‹ã€‚

### æƒé™åŠ è½½æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token Serviceâ”‚         â”‚ RBAC Service â”‚         â”‚ Permission   â”‚         â”‚ Database â”‚
â”‚              â”‚         â”‚              â”‚         â”‚   Cache      â”‚         â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚ 1. issue_tokens()      â”‚                        â”‚                      â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚                      â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚                        â”‚ 2. get_user_permissions(user_id)               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚                        â”‚                        â”‚ 3. æ£€æŸ¥ç¼“å­˜          â”‚
       â”‚                        â”‚                        â”‚    Key: user:<user_id> â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚                        â”‚                        â”‚ 4. ç¼“å­˜æœªå‘½ä¸­        â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚                        â”‚ 5. æŸ¥è¯¢æ•°æ®åº“          â”‚                      â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
       â”‚                        â”‚    SELECT p.name                               â”‚
       â”‚                        â”‚    FROM permissions p                          â”‚
       â”‚                        â”‚    JOIN role_permissions rp ON p.id = rp.permission_id â”‚
       â”‚                        â”‚    JOIN user_roles ur ON rp.role_id = ur.role_id â”‚
       â”‚                        â”‚    WHERE ur.user_id = ?                        â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚                        â”‚    ["users:list", "users:create", ...]         â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚                        â”‚ 6. å­˜å…¥ç¼“å­˜ (TTL: 5åˆ†é’Ÿ)                       â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚                        â”‚ 7. è¿”å›æƒé™åˆ—è¡¨         â”‚                      â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚ 8. è¿”å›æƒé™            â”‚                        â”‚                      â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚                      â”‚
       â”‚                        â”‚                        â”‚                      â”‚
       â”‚ 9. å°†æƒé™åµŒå…¥ JWT claims                        â”‚                      â”‚
       â”‚    {                   â”‚                        â”‚                      â”‚
       â”‚      ...               â”‚                        â”‚                      â”‚
       â”‚      "permissions": ["users:list", ...]         â”‚                      â”‚
       â”‚    }                   â”‚                        â”‚                      â”‚
```

### æƒé™æ£€æŸ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Permission       â”‚         â”‚ Route Permissionâ”‚
â”‚ Middleware       â”‚         â”‚   Configuration â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
         â”‚ 1. æå–è¯·æ±‚è·¯å¾„å’Œæ–¹æ³•       â”‚
         â”‚    GET /api/v2/admin/users  â”‚
         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                            â”‚
         â”‚ 2. æŸ¥æ‰¾æ‰€éœ€æƒé™            â”‚
         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚    ["users:list"]          â”‚
         â”‚                            â”‚
         â”‚ 3. æå– AuthContext         â”‚
         â”‚    (ä» request extensions)  â”‚
         â”‚    permissions = [          â”‚
         â”‚      "users:list",          â”‚
         â”‚      "users:create",        â”‚
         â”‚      "roles:manage"         â”‚
         â”‚    ]                        â”‚
         â”‚                            â”‚
         â”‚ 4. æƒé™åŒ¹é…æ£€æŸ¥            â”‚
         â”‚    required: ["users:list"] â”‚
         â”‚    has: ["users:list", ...]â”‚
         â”‚                            â”‚
         â”‚ 5. åŒ¹é…æˆåŠŸ âœ…             â”‚
         â”‚    - å…è®¸è¯·æ±‚ç»§ç»­          â”‚
         â”‚                            â”‚
         â”‚ 6. è®°å½•æ—¥å¿—                â”‚
         â”‚    INFO: User <user_id> accessed â”‚
         â”‚          GET /api/v2/admin/users â”‚
         â”‚          with permission users:list â”‚
```

### æƒé™å‘½åè§„èŒƒ

**æ ¼å¼**: `<resource>:<action>`

**ç¤ºä¾‹**:
- `users:list` - åˆ—å‡ºç”¨æˆ·
- `users:create` - åˆ›å»ºç”¨æˆ·
- `users:read` - è¯»å–å•ä¸ªç”¨æˆ·
- `users:update` - æ›´æ–°ç”¨æˆ·
- `users:delete` - åˆ é™¤ç”¨æˆ·
- `roles:manage` - ç®¡ç†è§’è‰²
- `menu:system:user:view` - æŸ¥çœ‹ç”¨æˆ·ç®¡ç†èœå•

### æƒé™ç¼“å­˜æœºåˆ¶

**å®ç°** (`/home/user/ts-next/apps/oauth-service-rust/src/cache/permission_cache.rs`):

```rust
pub struct InMemoryPermissionCache {
    cache: Arc<RwLock<HashMap<String, CacheEntry>>>,
    hits: Arc<RwLock<u64>>,
    misses: Arc<RwLock<u64>>,
}

struct CacheEntry {
    permissions: Vec<String>,
    created_at: DateTime<Utc>,
    ttl_seconds: i64,  // é»˜è®¤ 300 ç§’ (5 åˆ†é’Ÿ)
}
```

**ç¼“å­˜ç­–ç•¥**:
- **Cache Key**: `user:<user_id>`
- **TTL**: 5 åˆ†é’Ÿ
- **é©±é€ç­–ç•¥**: æ‡’æƒ°åˆ é™¤ (è®¿é—®æ—¶æ£€æŸ¥è¿‡æœŸ)
- **ä¸€è‡´æ€§**: ç”¨æˆ·è§’è‰²å˜æ›´æ—¶æ‰‹åŠ¨å¤±æ•ˆ

**ç¼“å­˜å¤±æ•ˆæ—¶æœº**:
1. ç”¨æˆ·è§’è‰²è¢«ä¿®æ”¹
2. è§’è‰²æƒé™è¢«ä¿®æ”¹
3. ç”¨æˆ·è¢«åˆ é™¤
4. TTL è¿‡æœŸ

---

## å®Œæ•´è¯·æ±‚é“¾è·¯

å±•ç¤ºä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·è®¿é—® Admin Portal â†’ OAuth Service è®¤è¯ â†’ æŸ¥çœ‹èµ„æºçš„ç«¯åˆ°ç«¯æµç¨‹(å»ä¸­å¿ƒåŒ–è®¾è®¡)ã€‚

### åœºæ™¯: ç”¨æˆ·é¦–æ¬¡è®¿é—® Admin Portal,ç™»å½•åæŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµè§ˆå™¨   â”‚  â”‚ Pingora â”‚  â”‚  Admin   â”‚  â”‚  OAuth   â”‚  â”‚Database â”‚
â”‚         â”‚  â”‚  Proxy  â”‚  â”‚  Portal  â”‚  â”‚  Service â”‚  â”‚         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 1. è®¿é—® http://localhost:6188/        â”‚             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚ 2. è·¯ç”±åˆ° Admin Portal (é»˜è®¤åç«¯)       â”‚
     â”‚            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 3. è¿”å› HTML (React åº”ç”¨)  â”‚             â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 4. Admin Portal æ£€æŸ¥ access_token    â”‚             â”‚
     â”‚    (localStorage/sessionStorage)    â”‚             â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚ 5. æ— æœ‰æ•ˆ token â†’ ç”Ÿæˆ PKCE + state â”‚             â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚ 6. 302 é‡å®šå‘åˆ° OAuth Service        â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
     â”‚    /api/v2/oauth/authorize?...      â”‚             â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚ 7. GET /api/v2/oauth/authorize      â”‚             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 8. éªŒè¯è¯·æ±‚å‚æ•°â”‚
     â”‚            â”‚            â”‚             â”‚    (client_idç­‰)â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 9. æ£€æŸ¥ session_token â”‚
     â”‚            â”‚            â”‚             â”‚    (ä¸å­˜åœ¨-æœªç™»å½•)     â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 10. 302 â†’ /login?redirect=authorize  â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
     â”‚    (æ³¨æ„: OAuth Service è¿”å›ç™»å½• URL)            â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 11. GET /login?redirect=...          â”‚             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 12. OAuth Service è¿”å›ç™»å½•é¡µé¢ HTML â”‚
     â”‚            â”‚            â”‚             â”‚     (OAuth Service å®Œå…¨æ§åˆ¶)         â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 13. æ˜¾ç¤ºç™»å½•è¡¨å• (æ¥è‡ª OAuth Service)â”‚             â”‚
     â”‚     æ³¨æ„: NOT from Admin Portal!     â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 14. ç”¨æˆ·è¾“å…¥å‡­è¯ (ä»…åœ¨ OAuth Service é¡µé¢) â”‚        â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                        â”‚             â”‚             â”‚
     â”‚ 15. POST /api/v2/auth/login          â”‚             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚    {username, password, redirect}   â”‚             â”‚
     â”‚    æ³¨æ„: Admin Portal å®Œå…¨ä¸å‚ä¸    â”‚             â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚                        â”‚             â”‚ 16. æŸ¥è¯¢ users è¡¨ â”‚
     â”‚                        â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                        â”‚             â”‚  bcrypt::verify() â”‚
     â”‚                        â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚                        â”‚             â”‚ 17. åŠ è½½æƒé™ â”‚
     â”‚                        â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                        â”‚             â”‚  RBAC æŸ¥è¯¢   â”‚
     â”‚                        â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚             â”‚  ["users:*", "roles:*", ...] â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚                        â”‚             â”‚ 18. ç­¾å‘ session_token â”‚
     â”‚                        â”‚             â”‚     (JWT, 1å°æ—¶)       â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚ 19. HTTP 200 + Set-Cookie           â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
     â”‚    Set-Cookie: session_token=<jwt>;              â”‚
     â”‚      HttpOnly; Secure; SameSite=Lax             â”‚
     â”‚    {success: true, redirect: "..."}              â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚ 20. JavaScript é‡å®šå‘åˆ° redirect    â”‚             â”‚
     â”‚    (authorize ç«¯ç‚¹)                 â”‚             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚    (æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ session_token)   â”‚             â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚                        â”‚             â”‚ 21. éªŒè¯ session_token â”‚
     â”‚                        â”‚             â”‚     æå– user_id       â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚                        â”‚             â”‚ 22. ç”Ÿæˆæˆæƒç          â”‚
     â”‚                        â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                        â”‚             â”‚  INSERT auth_codes â”‚
     â”‚                        â”‚             â”‚  + code_challenge   â”‚
     â”‚                        â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚             â”‚             â”‚
     â”‚ 23. 302 â†’ /auth/callback?code=xxx&state=xxx     â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
     â”‚    (é‡å®šå‘å› Admin Portal)           â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 24. GET /auth/callback?code=xxx      â”‚             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚ 25. éªŒè¯ state (CSRF)    â”‚
     â”‚            â”‚            â”‚     (sessionStorage)    â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚ 26. POST /api/v2/oauth/token â”‚
     â”‚            â”‚            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚            â”‚  {grant_type: "authorization_code", â”‚
     â”‚            â”‚            â”‚   code, code_verifier,     â”‚
     â”‚            â”‚            â”‚   client_id, client_secret} â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 27. éªŒè¯æˆæƒç â”‚
     â”‚            â”‚            â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚            â”‚             â”‚  auth_codesè¡¨ â”‚
     â”‚            â”‚            â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 28. éªŒè¯ PKCE â”‚
     â”‚            â”‚            â”‚             â”‚  SHA256(verifier) == challenge â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 29. ç­¾å‘ Token Pair â”‚
     â”‚            â”‚            â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚            â”‚             â”‚  - access_token (JWT) â”‚
     â”‚            â”‚            â”‚             â”‚  - refresh_token(UUID) â”‚
     â”‚            â”‚            â”‚             â”‚  - id_token (JWT)     â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 30. ä¿å­˜ refresh_token â”‚
     â”‚            â”‚            â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 31. HTTP 200 + Token Response        â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
     â”‚    {access_token, refresh_token,    â”‚             â”‚
     â”‚     id_token, expires_in}           â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 32. Admin Portal å­˜å‚¨ tokens         â”‚             â”‚
     â”‚    (localStorage/sessionStorage)    â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 33. é‡å®šå‘åˆ° /dashboard              â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 34. GET /dashboard      â”‚             â”‚             â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 35. æ˜¾ç¤º Dashboard (å·²ç™»å½•)           â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 36. API è°ƒç”¨: GET /api/v2/admin/usersâ”‚             â”‚
     â”‚     Authorization: Bearer <access_token>          â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚            â”‚            â”‚             â”‚ 37. Rate Limit æ£€æŸ¥ â”‚
     â”‚            â”‚            â”‚             â”‚ 38. Auth Middleware  â”‚
     â”‚            â”‚            â”‚             â”‚     éªŒè¯ JWT ç­¾å    â”‚
     â”‚            â”‚            â”‚             â”‚     æ£€æŸ¥è¿‡æœŸ         â”‚
     â”‚            â”‚            â”‚             â”‚     æ£€æŸ¥æ’¤é”€         â”‚
     â”‚            â”‚            â”‚             â”‚                      â”‚
     â”‚            â”‚            â”‚             â”‚ 39. Permission MW    â”‚
     â”‚            â”‚            â”‚             â”‚     æ£€æŸ¥æƒé™         â”‚
     â”‚            â”‚            â”‚             â”‚     éœ€è¦: users:list  â”‚
     â”‚            â”‚            â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚            â”‚             â”‚  permission_cache â”‚
     â”‚            â”‚            â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚            â”‚            â”‚             â”‚  ["users:list", ...] â”‚
     â”‚            â”‚            â”‚             â”‚                      â”‚
     â”‚            â”‚            â”‚             â”‚ 40. æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨     â”‚
     â”‚            â”‚            â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚            â”‚             â”‚  SELECT * FROM users â”‚
     â”‚            â”‚            â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚            â”‚            â”‚             â”‚                      â”‚
     â”‚            â”‚            â”‚             â”‚ 41. Audit Log        â”‚
     â”‚            â”‚            â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚            â”‚             â”‚  INSERT audit_logs   â”‚
     â”‚            â”‚            â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚            â”‚            â”‚             â”‚                      â”‚
     â”‚ 42. HTTP 200 + JSON (ç”¨æˆ·åˆ—è¡¨)       â”‚             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
     â”‚            â”‚            â”‚             â”‚             â”‚
     â”‚ 43. Admin Portal æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼         â”‚             â”‚
     â”‚     (å·²æˆåŠŸè®¤è¯å’Œæˆæƒ)                â”‚             â”‚
```

### å…³é”®è·¯å¾„æ—¶åº

| æ­¥éª¤ | æè¿° | è€—æ—¶ä¼°ç®— |
|------|------|----------|
| 1-3 | é¦–æ¬¡è®¿é—®,åŠ è½½å‰ç«¯åº”ç”¨ | ~100ms |
| 4-11 | OAuth æˆæƒè¯·æ±‚é‡å®šå‘åˆ°ç™»å½•é¡µ | ~50ms |
| 12-14 | åŠ è½½ç™»å½•è¡¨å• | ~50ms |
| 15-20 | ç”¨æˆ·è®¤è¯ + æƒé™åŠ è½½ | ~200ms (bcrypt + DB) |
| 21-24 | æˆæƒç ç”Ÿæˆ | ~50ms |
| 25-32 | Token äº¤æ¢ | ~100ms (PKCE éªŒè¯ + JWT ç­¾å‘) |
| 33-36 | è·³è½¬åˆ° Dashboard | ~50ms |
| 37-41 | API è°ƒç”¨ (ç”¨æˆ·åˆ—è¡¨) | ~100ms (å«ä¸­é—´ä»¶ + DB) |
| **æ€»è®¡** | ä»ç‚¹å‡»ç™»å½•åˆ°çœ‹åˆ°æ•°æ® | **~700ms** |

---

## é”™è¯¯å¤„ç†æµç¨‹

### è®¤è¯é”™è¯¯

```
é”™è¯¯ç±»å‹                    HTTP çŠ¶æ€ç    è¿”å›å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ—  Authorization header      401         {"error": "Invalid token"}
Token æ ¼å¼é”™è¯¯               401         {"error": "Invalid token"}
Token ç­¾åæ— æ•ˆ               401         {"error": "Invalid token"}
Token å·²è¿‡æœŸ                 401         {"error": "Invalid token"}
Token å·²æ’¤é”€                 401         {"error": "Token has been revoked"}
ç”¨æˆ·ä¸å­˜åœ¨                   401         {"error": "Invalid credentials"}
å¯†ç é”™è¯¯                     401         {"error": "Invalid credentials"}
è´¦æˆ·è¢«é”å®š                   401         {"error": "Account is locked"}
```

### æˆæƒé”™è¯¯

```
é”™è¯¯ç±»å‹                    HTTP çŠ¶æ€ç    è¿”å›å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æƒé™ä¸è¶³                     403         {"error": "Missing required permissions"}
è®¿é—®å·²ç¦ç”¨çš„èµ„æº             403         {"error": "Forbidden"}
Client ç±»å‹ä¸å…è®¸è¯¥æ“ä½œ      403         {"error": "Operation not allowed for this client type"}
```

### éªŒè¯é”™è¯¯

```
é”™è¯¯ç±»å‹                    HTTP çŠ¶æ€ç    è¿”å›å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¼ºå°‘å¿…éœ€å‚æ•°                 400         {"error": "Missing required parameter: <param>"}
æ— æ•ˆçš„ grant_type            400         {"error": "Unsupported grant type"}
æ— æ•ˆçš„ redirect_uri          400         {"error": "Invalid redirect_uri"}
æ— æ•ˆçš„ scope                 400         {"error": "Invalid scope"}
PKCE éªŒè¯å¤±è´¥                400         {"error": "PKCE verification failed"}
State ä¸åŒ¹é… (CSRF)          400         {"error": "Invalid state parameter"}
```

### èµ„æºé”™è¯¯

```
é”™è¯¯ç±»å‹                    HTTP çŠ¶æ€ç    è¿”å›å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client ä¸å­˜åœ¨                404         {"error": "Invalid client_id"}
User ä¸å­˜åœ¨                  404         {"error": "User not found"}
Authorization Code ä¸å­˜åœ¨    404         {"error": "Invalid authorization code"}
èµ„æºä¸å­˜åœ¨                   404         {"error": "<Resource> not found"}
```

### å†²çªé”™è¯¯

```
é”™è¯¯ç±»å‹                    HTTP çŠ¶æ€ç    è¿”å›å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·åå·²å­˜åœ¨                 409         {"error": "Username already exists"}
Client ID å·²å­˜åœ¨             409         {"error": "Client ID already exists"}
é‡å¤æ“ä½œ                     409         {"error": "Resource already exists"}
```

### æœåŠ¡å™¨é”™è¯¯

```
é”™è¯¯ç±»å‹                    HTTP çŠ¶æ€ç    è¿”å›å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ•°æ®åº“é”™è¯¯                   500         {"error": "Database error: <details>"}
JWT ç­¾åå¤±è´¥                 500         {"error": "JWT error: <details>"}
å¯†ç å“ˆå¸Œå¤±è´¥                 500         {"error": "Password hashing error"}
å†…éƒ¨é”™è¯¯                     500         {"error": "Internal server error"}
```

### é”™è¯¯å¤„ç†å®ç°

**é”™è¯¯ä¼ æ’­é“¾**:

```
Business Logic Error
  â†“
ServiceError
  â†“
AppError::Service(ServiceError)
  â†“
IntoResponse Implementation
  â†“
HTTP Response {status, JSON}
```

**ç¤ºä¾‹** (`/home/user/ts-next/apps/oauth-service-rust/src/error.rs`):

```rust
impl IntoResponse for AppError {
    fn into_response(self) -> Response {
        let (status, error_message) = match self {
            AppError::Auth(AuthError::InvalidCredentials) => {
                (StatusCode::UNAUTHORIZED, "Invalid credentials".to_string())
            }
            AppError::Auth(AuthError::InvalidToken) => {
                (StatusCode::UNAUTHORIZED, "Invalid token".to_string())
            }
            AppError::Auth(AuthError::InsufficientPermissions) => {
                (StatusCode::FORBIDDEN, "Missing required permissions".to_string())
            }
            AppError::Service(ServiceError::NotFound(msg)) => {
                (StatusCode::NOT_FOUND, msg)
            }
            AppError::Service(ServiceError::Conflict(msg)) => {
                (StatusCode::CONFLICT, msg)
            }
            AppError::Service(ServiceError::ValidationError(msg)) => {
                (StatusCode::BAD_REQUEST, msg)
            }
            _ => {
                (StatusCode::INTERNAL_SERVER_ERROR, "Internal server error".to_string())
            }
        };

        let body = Json(serde_json::json!({
            "error": error_message
        }));

        (status, body).into_response()
    }
}
```

---

## å®‰å…¨æœ€ä½³å®è·µæ€»ç»“

### å·²å®æ–½çš„å®‰å…¨æªæ–½

| å®‰å…¨ç‰¹æ€§ | å®ç°ä½ç½® | ä¿æŠ¤ç›®æ ‡ |
|----------|----------|----------|
| **PKCE (å¼ºåˆ¶)** | OAuth Service | æˆæƒç æ‹¦æˆªæ”»å‡» |
| **State å‚æ•°** | Admin Portal | CSRF æ”»å‡» |
| **Nonce** | OAuth Service | ID Token é‡æ”¾æ”»å‡» |
| **HttpOnly Cookie** | OAuth Service | XSS æ”»å‡» |
| **SameSite=Lax** | OAuth Service | CSRF æ”»å‡» |
| **Secure Cookie (ç”Ÿäº§)** | OAuth Service | ä¸­é—´äººæ”»å‡» |
| **bcrypt å¯†ç å“ˆå¸Œ** | OAuth Service | å¯†ç æ³„éœ² |
| **JWT ç­¾åéªŒè¯** | OAuth Service | Token ä¼ªé€  |
| **Token æ’¤é”€** | OAuth Service | Token æ³„éœ² |
| **Rate Limiting** | OAuth Service | DoS æ”»å‡» |
| **å®¡è®¡æ—¥å¿—** | OAuth Service | å®‰å…¨è¿½è¸ª |
| **æ•æ„Ÿæ•°æ®è„±æ•** | Audit Middleware | æ—¥å¿—æ³„éœ² |
| **æƒé™ç¼“å­˜** | RBAC Service | æ€§èƒ½ä¼˜åŒ– |
| **å¸¸é‡æ—¶é—´æ¯”è¾ƒ** | PKCE Utils | æ—¶åºæ”»å‡» |

### å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•

**ç”Ÿäº§ç¯å¢ƒå¿…é¡»**:
- [ ] ä½¿ç”¨ RS256 JWT ç®—æ³• (RSA å¯†é’¥å¯¹)
- [ ] å¯ç”¨ HTTPS (Secure Cookie)
- [ ] é…ç½®æ­£ç¡®çš„ redirect_uri ç™½åå•
- [ ] ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
- [ ] å®šæœŸè½®æ¢ JWT å¯†é’¥
- [ ] ç›‘æ§å®¡è®¡æ—¥å¿—
- [ ] é…ç½® Token è¿‡æœŸæ—¶é—´ (access: 1h, refresh: 30d)
- [ ] å¯ç”¨ refresh token rotation
- [ ] é™åˆ¶å¤±è´¥ç™»å½•å°è¯•
- [ ] é…ç½® CORS ç™½åå•

---

## é™„å½•

### ç¯å¢ƒå˜é‡é…ç½®

**OAuth Service** (`.env`):
```bash
# æ•°æ®åº“
DATABASE_URL=sqlite:./oauth.db

# JWT é…ç½®
JWT_ALGORITHM=RS256                          # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ RS256
JWT_PRIVATE_KEY_PATH=./keys/private_key.pem
JWT_PUBLIC_KEY_PATH=./keys/public_key.pem
# JWT_SECRET=<secret>                        # ä»…ç”¨äº HS256

# ç­¾å‘è€…
ISSUER=https://auth.yourdomain.com           # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®åŸŸå

# åº”ç”¨ URL
NEXT_PUBLIC_OAUTH_SERVICE_URL=http://localhost:6188  # é€šè¿‡ Pingora
NEXT_PUBLIC_ADMIN_PORTAL_URL=http://localhost:6188   # é€šè¿‡ Pingora

# ç¯å¢ƒ
NODE_ENV=production

# æ•°æ®åº“åˆå§‹åŒ–
SKIP_DB_INIT=false  # é¦–æ¬¡å¯åŠ¨è®¾ä¸º false,åç»­å¯è®¾ä¸º true
```

**Admin Portal** (`.env.local`):
```bash
# OAuth é…ç½®
NEXT_PUBLIC_OAUTH_CLIENT_ID=admin-portal-client
NEXT_PUBLIC_OAUTH_CLIENT_SECRET=<secret>
NEXT_PUBLIC_OAUTH_REDIRECT_URI=http://localhost:6188/auth/callback
NEXT_PUBLIC_OAUTH_SCOPE=openid profile email

# API ç«¯ç‚¹ (é€šè¿‡ Pingora)
NEXT_PUBLIC_API_BASE_URL=http://localhost:6188/api/v2

# OAuth æœåŠ¡ URL
NEXT_PUBLIC_OAUTH_SERVICE_URL=http://localhost:6188/api/v2

# ç¯å¢ƒ
NODE_ENV=production
```

### æ•°æ®åº“è¡¨å…³ç³»

```
users â”€â”€â”
        â”œâ”€â”€â”€ user_roles â”€â”€â”
                          â”œâ”€â”€â”€ roles â”€â”€â”
                                       â”œâ”€â”€â”€ role_permissions â”€â”€â”
                                                                â”œâ”€â”€â”€ permissions

oauth_clients â”€â”€â”
                â”œâ”€â”€â”€ authorization_codes
                â”œâ”€â”€â”€ access_tokens
                â””â”€â”€â”€ refresh_tokens

audit_logs (ç‹¬ç«‹)
password_histories (å…³è” users)
password_reset_requests (å…³è” users)
consent_grants (å…³è” users + oauth_clients)
scopes (ç‹¬ç«‹)
scope_permissions (å…³è” scopes + permissions)
```

---

## æ–‡æ¡£ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 1.0 | 2025-11-17 | åˆå§‹ç‰ˆæœ¬,å®Œæ•´ä¸šåŠ¡æµç¨‹æ–‡æ¡£ | Claude |

---

**æ–‡æ¡£ç»“æŸ**
