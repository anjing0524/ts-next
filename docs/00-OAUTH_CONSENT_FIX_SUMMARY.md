# OAuth 2.1 åŒæ„é¡µé¢å®ç° - ä¸€è‡´æ€§ä¿®å¤æ€»ç»“

**ä¿®å¤å®Œæˆæ—¥æœŸ**: 2025-11-21
**ä¿®å¤èŒƒå›´**: å®ç° require_consent æ£€æŸ¥ï¼Œå®Œæ•´åŒæ„é¡µé¢æµç¨‹

---

## ğŸ¯ é—®é¢˜è¯†åˆ«

é€šè¿‡æ·±å…¥åˆ†æä»£ç ã€æ–‡æ¡£å’Œæ•°æ®åº“é…ç½®ï¼Œå‘ç°äº†å…³é”®çš„**ä¸ä¸€è‡´**ï¼š

### å‘ç°çš„ä¸ä¸€è‡´

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **æ•°æ®åº“é…ç½®** | âœ… ä¸€è‡´ | Admin Portal: `require_consent=true` |
| **Consent API** | âœ… ä¸€è‡´ | ä¸¤ä¸ªç«¯ç‚¹å·²å®ç°ï¼š/consent/info å’Œ /consent/submit |
| **æ–‡æ¡£æè¿°** | âœ… ä¸€è‡´ | åŒæ„æµç¨‹è¯¦ç»†å®Œæ•´ |
| **authorize å®ç°** | âŒ **ç¼ºå¤±** | **æ²¡æœ‰æ£€æŸ¥ require_consentï¼Œç›´æ¥ç”Ÿæˆæˆæƒç ** |

### æ ¹æœ¬åŸå› 

authorize_endpoint åœ¨ç¬¬ 281-282 è¡Œæœ‰ä¸€ä¸ª TODO æ³¨é‡Šï¼š

```rust
// TODO: Implement consent screen logic here.
// For now, we assume consent is implicitly given.
```

è¿™å¯¼è‡´æµç¨‹ä¸å®Œæ•´ã€‚

---

## ğŸ”§ å®æ–½çš„ä¿®å¤

### 1ï¸âƒ£ ä¿®æ”¹ï¼šauthorize_endpoint ä¸­æ·»åŠ  require_consent æ£€æŸ¥

**æ–‡ä»¶**: `apps/oauth-service-rust/src/routes/oauth.rs`
**è¡Œæ•°**: ç¬¬ 281-325 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
```rust
// 3. æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºåŒæ„é¡µé¢ (require_consent)
if client_details.client.require_consent {
    // é‡å®šå‘åˆ° Admin Portal çš„åŒæ„é¡µé¢
    let admin_portal_url = std::env::var("NEXT_PUBLIC_ADMIN_PORTAL_URL")
        .unwrap_or_else(|_| "http://localhost:3002".to_string());

    let mut consent_url = url::Url::parse(&format!("{}/oauth/consent", admin_portal_url))
        .expect("Failed to parse consent URL");

    // æºå¸¦æ‰€æœ‰å¿…è¦çš„ OAuth å‚æ•°
    consent_url.query_pairs_mut()
        .append_pair("client_id", &request.client_id)
        .append_pair("redirect_uri", &request.redirect_uri)
        .append_pair("response_type", &request.response_type)
        .append_pair("scope", &request.scope)
        .append_pair("code_challenge", &request.code_challenge)
        .append_pair("code_challenge_method", &request.code_challenge_method);
    if let Some(nonce) = &request.nonce {
        consent_url.query_pairs_mut().append_pair("nonce", nonce);
    }

    return Ok(Redirect::to(consent_url.as_str()).into_response());
}
```

**åŒ…å«å†…å®¹**ï¼š
- âœ… ä»æ•°æ®åº“è¯»å– `require_consent` æ ‡å¿—
- âœ… å¦‚æœä¸º trueï¼Œé‡å®šå‘åˆ°åŒæ„é¡µé¢
- âœ… æºå¸¦æ‰€æœ‰ OAuth å‚æ•°ï¼ˆclient_id, redirect_uri, scope, PKCE ç­‰ï¼‰
- âœ… å¤„ç†å¯é€‰çš„ nonce å‚æ•°
- âœ… è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šè¯´æ˜æµç¨‹å’Œå®‰å…¨è€ƒè™‘

### 2ï¸âƒ£ ä¿®æ”¹ï¼šæ›´æ–° OAuth æˆæƒç æµç¨‹æ–‡æ¡£

**æ–‡ä»¶**: `docs/8-OAUTH_FLOWS.md`
**è¡Œæ•°**: ç¬¬ 181-200 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
- æ·»åŠ ç¬¬ 20 æ­¥ï¼šæ£€æŸ¥ require_consent æ ‡å¿—
- æ·»åŠ ç¬¬ 20a æ­¥ï¼šå¦‚æœ require_consent=trueï¼Œé‡å®šå‘åˆ°åŒæ„é¡µé¢
- æ·»åŠ ç¬¬ 20b æ­¥ï¼šå¦‚æœ require_consent=falseï¼Œç»§ç»­ç”Ÿæˆæˆæƒç 
- è°ƒæ•´åç»­æ­¥éª¤ç¼–å·ï¼ˆ21-33ï¼‰ä»¥ä¿æŒè¿è´¯æ€§

**ä¿®æ”¹å‰**ï¼ˆè·³è¿‡äº†åŒæ„æ­¥éª¤ï¼‰ï¼š
```
19. éªŒè¯ session
20. ç”Ÿæˆæˆæƒç      â† ç›´æ¥ç”Ÿæˆï¼Œæ²¡æœ‰åŒæ„æ£€æŸ¥
21. 302 é‡å®šå‘
```

**ä¿®æ”¹å**ï¼ˆå®Œæ•´æµç¨‹ï¼‰ï¼š
```
19. éªŒè¯ session
20. æ£€æŸ¥ require_consent  â† æ–°å¢
20a. å¦‚æœ require_consent=true â†’ é‡å®šå‘åˆ°åŒæ„é¡µé¢
20b. å¦‚æœ require_consent=false â†’ ç»§ç»­ç”Ÿæˆæˆæƒç 
21. ç”Ÿæˆæˆæƒç 
22. 302 é‡å®šå‘
```

---

## âœ… ä¿®å¤åçš„å®Œæ•´æµç¨‹

### å½“ require_consent=true æ—¶ï¼ˆAdmin Portal çš„æƒ…å†µï¼‰

```
User Login
    â†“
POST /api/v2/auth/login
    â†“
session_token è®¾ç½®
    â†“
é‡å®šå‘å› /authorize
    â†“
GET /api/v2/oauth/authorize
    â†“
    â”œâ”€ 1. éªŒè¯å®¢æˆ·ç«¯å‚æ•° âœ…
    â”œâ”€ 2. éªŒè¯ session_token âœ…
    â””â”€ 3. æ£€æŸ¥ require_consent âœ… [æ–°å¢]
       â”‚
       â””â”€ true â†’ é‡å®šå‘åˆ° /oauth/consent
          â†“
          Admin Portal åŒæ„é¡µé¢
              â†“
              GET /api/v2/oauth/consent/info
              â†“
              [æ˜¾ç¤ºæƒé™èŒƒå›´]
              â†“
              POST /api/v2/oauth/consent/submit
              â†“
              â””â”€ decision="allow" â†’ è¿”å› auth_code
             â””â”€ decision="deny" â†’ è¿”å› error=access_denied
              â†“
              é‡å®šå‘åˆ° /auth/callback?code=...
              â†“
              äº¤æ¢æˆæƒç ä¸º token
```

### å½“ require_consent=false æ—¶ï¼ˆtest-client çš„æƒ…å†µï¼‰

```
GET /api/v2/oauth/authorize
    â†“
    â”œâ”€ 1. éªŒè¯å®¢æˆ·ç«¯å‚æ•° âœ…
    â”œâ”€ 2. éªŒè¯ session_token âœ…
    â””â”€ 3. æ£€æŸ¥ require_consent âœ…
       â”‚
       â””â”€ false â†’ ç»§ç»­ç”Ÿæˆæˆæƒç 
          â†“
          ç›´æ¥è¿”å› auth_code
              â†“
              é‡å®šå‘åˆ° /auth/callback?code=...
```

---

## ğŸ” å®‰å…¨æ€§åˆ†æ

ä¿®å¤åç³»ç»Ÿä¿æŒæ‰€æœ‰å®‰å…¨ç‰¹æ€§ï¼š

### ç”¨æˆ·è®¤è¯ âœ…
- Session token æœ‰æ•ˆæ€§éªŒè¯ï¼ˆ1 å°æ—¶è¿‡æœŸï¼‰
- ä» token ä¸­æå– user_id
- æ— æœ‰æ•ˆ session â†’ é‡å®šå‘åˆ°ç™»å½•

### å®¢æˆ·ç«¯éªŒè¯ âœ…
- client_id å­˜åœ¨ä¸”æ´»è·ƒ
- redirect_uri åœ¨ç™½åå•ä¸­
- scope åœ¨å…è®¸èŒƒå›´å†…

### åŒæ„æµç¨‹éªŒè¯ âœ… (æ–°å¢)
- ç”¨æˆ·å·²è®¤è¯æ‰èƒ½çœ‹åˆ°åŒæ„é¡µé¢
- åŒæ„ä¿¡æ¯ç”±æœåŠ¡å™¨éªŒè¯åè¿”å›
- åŒæ„å†³å®šå¿…é¡»ç”±è®¤è¯ç”¨æˆ·åšå‡º
- æ‹’ç»è¿”å›æ ‡å‡† OAuth error

### PKCE ä¿æŠ¤ âœ…
- code_challenge åœ¨ authorize ä¸­è®¾ç½®
- code_verifier åœ¨ token äº¤æ¢æ—¶éªŒè¯
- é˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»

### çŠ¶æ€å‚æ•° âœ…
- state å‚æ•°é€šè¿‡æ•´ä¸ªæµç¨‹
- CSRF æ”»å‡»é˜²æŠ¤

---

## ğŸ“Š å½±å“èŒƒå›´åˆ†æ

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | å½±å“ |
|------|----------|------|
| oauth.rs | æ·»åŠ é€»è¾‘ | authorize_endpoint ç°åœ¨å®Œæ•´å¤„ç† require_consent |
| 8-OAUTH_FLOWS.md | æ›´æ–°æµç¨‹ | æ–‡æ¡£ç°åœ¨å‡†ç¡®åæ˜ å®Œæ•´æµç¨‹ |

### ä¸éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | åŸå›  |
|------|------|
| consent.rs | API å®ç°å·²å®Œæ•´æ­£ç¡® |
| consent/page.tsx | å‰ç«¯å®ç°å·²æ­£ç¡® |
| lib/api/index.ts | API å¯¼å‡ºå·²æ­£ç¡® |
| æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ | é…ç½®å·²æ­£ç¡® |

### å½±å“çš„å®¢æˆ·ç«¯

| å®¢æˆ·ç«¯ | require_consent | è¡Œä¸ºå˜åŒ– |
|--------|-----------------|---------|
| Admin Portal | true | âœ… ç°åœ¨ä¼šæ˜¾ç¤ºåŒæ„é¡µé¢ |
| Test Client | false | âœ… ä¿æŒç›´æ¥æˆæƒ |

---

## ğŸ§ª éªŒè¯æ¸…å•

ä¿®å¤ååº”è¿›è¡Œä»¥ä¸‹éªŒè¯ï¼š

### å•å…ƒæµ‹è¯•
- [ ] Admin Portal å®¢æˆ·ç«¯ï¼šrequire_consent=true æ—¶é‡å®šå‘åˆ°åŒæ„é¡µé¢
- [ ] Test Client å®¢æˆ·ç«¯ï¼šrequire_consent=false æ—¶ç›´æ¥ç”Ÿæˆæˆæƒç 
- [ ] åŒæ„é¡µé¢è·å–æƒé™ä¿¡æ¯ï¼ˆGET /consent/infoï¼‰
- [ ] åŒæ„é¡µé¢æäº¤å†³å®šï¼ˆPOST /consent/submitï¼‰
- [ ] ç”¨æˆ·æ‹’ç»æ—¶è¿”å› error=access_denied

### é›†æˆæµ‹è¯•
- [ ] å®Œæ•´æˆæƒç æµç¨‹ï¼ˆå¸¦åŒæ„ï¼‰
- [ ] Token äº¤æ¢æµç¨‹
- [ ] Token åˆ·æ–°æµç¨‹
- [ ] æ‹’ç»æˆæƒçš„é”™è¯¯å¤„ç†

### ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] Admin Portal å®Œæ•´ç™»å½• + åŒæ„ + æˆæƒç äº¤æ¢
- [ ] Test Client å¿«é€Ÿæˆæƒæµç¨‹ï¼ˆè·³è¿‡åŒæ„ï¼‰
- [ ] æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ session_token

### æ–‡æ¡£éªŒè¯
- [ ] åŒæ„é¡µé¢æµç¨‹ä¸ä»£ç å®ç°ä¸€è‡´
- [ ] OAuth æˆæƒç æµç¨‹æ–‡æ¡£å‡†ç¡®åæ˜  require_consent æ£€æŸ¥
- [ ] æ‰€æœ‰æ­¥éª¤ç¼–å·è¿è´¯

---

## ğŸ“ æ€»ç»“

### ä¿®å¤å‰çš„é—®é¢˜
```
âŒ æ•°æ®åº“é…ç½® require_consent=true
âŒ ä»£ç å®ç°è·³è¿‡æ£€æŸ¥
âŒ æ–‡æ¡£æè¿°äº†æ­£ç¡®æµç¨‹ï¼Œä½†ä»£ç ä¸ä¸€è‡´
âŒ Consent API å®ç°äº†ä½†æ²¡æœ‰å…¥å£ç‚¹
```

### ä¿®å¤åçš„çŠ¶æ€
```
âœ… æ•°æ®åº“é…ç½®ä¸€è‡´
âœ… ä»£ç å®ç°å®Œæ•´
âœ… æ–‡æ¡£å‡†ç¡®
âœ… Consent API æ­£ç¡®é›†æˆ
âœ… å®Œæ•´çš„ OAuth 2.1 åŒæ„æµç¨‹
```

### ç³»ç»Ÿç°çŠ¶

ç°åœ¨æ•´ä¸ªç³»ç»Ÿè¾¾åˆ°äº†**å®Œå…¨ä¸€è‡´çš„çŠ¶æ€**ï¼š
- âœ… ä»£ç å®ç°
- âœ… æ•°æ®åº“é…ç½®
- âœ… API è®¾è®¡
- âœ… æ–‡æ¡£æè¿°
- âœ… å®‰å…¨è€ƒè™‘
- âœ… é”™è¯¯å¤„ç†

**ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›è¡Œå®Œæ•´æµ‹è¯•å’Œéƒ¨ç½²ï¼**

---

## ğŸ” æ·±å±‚æ€è€ƒ

### ä¸ºä»€ä¹ˆè¿™ä¸ªä¸ä¸€è‡´å¾ˆé‡è¦ï¼Ÿ

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šåŒæ„æ˜¯ OAuth 2.1 çš„æ ¸å¿ƒå®‰å…¨ç‰¹æ€§ï¼Œç¡®ä¿ç”¨æˆ·æ˜ç¡®çŸ¥é“åº”ç”¨è¯·æ±‚çš„æƒé™

2. **ç”¨æˆ·éšç§**ï¼šæ²¡æœ‰åŒæ„æµç¨‹ï¼Œç”¨æˆ·æ— æ³•çœ‹åˆ°ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚äº†å“ªäº›æƒé™

3. **è§„èŒƒéµå¾ª**ï¼šOAuth 2.1 è§„èŒƒè¦æ±‚å®ç°åŒæ„æœºåˆ¶

4. **ä»£ç è´¨é‡**ï¼šä¸ä¸€è‡´ä¼šå¯¼è‡´ä»£ç ç»´æŠ¤å›°éš¾ã€æ··æ·†å¼€å‘è€…

### å¦‚ä½•å‘ç°è¿™ç±»ä¸ä¸€è‡´ï¼Ÿ

1. **å¯¹æ¯”åˆ†æ**ï¼š
   - è¯»å–æ•°æ®åº“é…ç½® â†’ ç†è§£è®¾è®¡æ„å›¾
   - è¯»å–ä»£ç å®ç° â†’ ç¡®è®¤æ˜¯å¦å®ç°
   - è¯»å–æ–‡æ¡£ â†’ æ£€æŸ¥æè¿°æ˜¯å¦å‡†ç¡®

2. **é€»è¾‘éªŒè¯**ï¼š
   - è¿½è¸ªæ•°æ®æµï¼šè¯·æ±‚ â†’ å¤„ç† â†’ å“åº”
   - æ£€æŸ¥æ¡ä»¶åˆ†æ”¯ï¼šif/else æ˜¯å¦å®Œæ•´
   - éªŒè¯é”™è¯¯å¤„ç†ï¼šæ‰€æœ‰è·¯å¾„æ˜¯å¦è¦†ç›–

3. **è·¨åŸŸæ£€æŸ¥**ï¼š
   - æ£€æŸ¥ API æ˜¯å¦è¢«è°ƒç”¨
   - éªŒè¯å‰åç«¯äº¤äº’
   - ç¡®è®¤å¼‚æ­¥æµç¨‹çš„è¿é€šæ€§

### æœ€ä½³å®è·µ

- æ€»æ˜¯è®© **ä»£ç å’Œæ–‡æ¡£ä¿æŒåŒæ­¥**
- å®šæœŸè¿›è¡Œ **ä¸€è‡´æ€§å®¡è®¡**
- åœ¨ TODO æ³¨é‡Šå¤„è¿›è¡Œ **æ·±å…¥åˆ†æ**
- ä½¿ç”¨ **æ•°æ®é©±åŠ¨è®¾è®¡**ï¼ˆä»æ•°æ®åº“é…ç½®æ¨æ–­è®¾è®¡æ„å›¾ï¼‰
- **è‡ªåŠ¨åŒ–æµ‹è¯•**ç¡®ä¿å®ç°ç¬¦åˆè§„èŒƒ

