# 快速开始指南

> **文档版本**: v1.0.0  
> **最后更新**: 2025-07-22  
> **维护团队**: 开发团队

## 概述

本指南帮助开发者快速搭建和运行 OAuth 2.1 认证中心。通过简单的步骤，您可以在 10 分钟内启动一个完整的认证服务。

## 前置要求

### 系统要求
- **操作系统**: macOS, Linux, Windows (WSL2)
- **Node.js**: 20.x 或更高版本
- **pnpm**: 8.x 或更高版本
- **Git**: 用于代码管理

### 验证环境
```bash
# 检查 Node.js 版本
node --version
# 应该输出 v20.x.x 或更高

# 检查 pnpm 版本
pnpm --version
# 应该输出 8.x.x 或更高
```

## 快速启动

### 1. 获取代码

```bash
# 克隆项目
git clone <repository-url>
cd ts-next-template

# 安装依赖
pnpm install
```

### 2. 环境配置

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量（可选，使用默认值也可以运行）
nano .env
```

必需的环境变量：
```bash
# 数据库配置
DATABASE_URL="file:./dev.db"

# JWT 配置
JWT_PRIVATE_KEY_PATH="./test-private.pem"

# Redis 配置（可选）
REDIS_URL="redis://localhost:6379"
```

### 3. 初始化数据库

```bash
# 生成 Prisma 客户端
pnpm db:generate

# 推送数据库结构
pnpm db:push

# 初始化基础数据
pnpm db:seed
```

### 4. 启动服务

```bash
# 启动所有服务
pnpm dev
```

服务将分别在以下端口启动：
- **oauth-service**: http://localhost:3001
- **admin-portal**: http://localhost:3002
- **kline-service**: http://localhost:3003

### 5. 验证安装

打开浏览器访问：
- 管理后台: http://localhost:3002
- OAuth 服务: http://localhost:3001/api/health

默认管理员账户：
- 用户名: `admin`
- 密码: `admin123`

## 第一个 OAuth 客户端

### 1. 创建客户端

登录管理后台后，创建你的第一个 OAuth 客户端：

1. 访问 http://localhost:3002
2. 使用默认管理员账户登录
3. 进入 "系统管理" > "客户端管理"
4. 点击 "新增客户端"
5. 填写客户端信息：
   - 客户端名称: `测试应用`
   - 重定向 URI: `http://localhost:8080/callback`
   - 允许的权限: `openid profile email`

### 2. 保存客户端信息

创建成功后，记录以下信息：
- **Client ID**: 类似 `client_1234567890`
- **Client Secret**: 保存这个密钥，只在创建时显示一次

### 3. 测试 OAuth 流程

创建一个简单的 HTML 文件测试 OAuth 流程：

```html
<!-- test-oauth.html -->
<!DOCTYPE html>
<html>
<head>
    <title>OAuth 测试</title>
</head>
<body>
    <button onclick="login()">使用 OAuth 登录</button>
    <div id="result"></div>

    <script>
        const config = {
            clientId: 'your_client_id',
            redirectUri: 'http://localhost:8080/callback',
            authority: 'http://localhost:3001',
            scopes: ['openid', 'profile', 'email']
        };

        function login() {
            const state = Math.random().toString(36).substring(7);
            sessionStorage.setItem('oauth_state', state);
            
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: config.clientId,
                redirect_uri: config.redirectUri,
                scope: config.scopes.join(' '),
                state: state,
                code_challenge: 'mock_challenge_for_demo',
                code_challenge_method: 'S256'
            });
            
            window.location.href = `${config.authority}/api/v2/oauth/authorize?${params}`;
        }

        // 处理回调
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');
            
            if (code) {
                document.getElementById('result').innerHTML = '获取到授权码: ' + code;
                // 实际应用中，这里应该用授权码交换访问令牌
            } else if (error) {
                document.getElementById('result').innerHTML = '错误: ' + error;
            }
        };
    </script>
</body>
</html>
```

使用 Python 的简单 HTTP 服务器运行测试：
```bash
# 在另一个终端窗口
python -m http.server 8080
```

访问 http://localhost:8080/test-oauth.html 测试 OAuth 流程。

## 开发指南

### 目录结构

```
ts-next-template/
├── apps/
│   ├── oauth-service/     # OAuth 2.1 服务
│   ├── admin-portal/      # 管理后台
│   └── kline-service/     # 图表服务
├── packages/
│   ├── ui/               # 共享 UI 组件
│   ├── lib/              # 共享工具库
│   ├── database/         # 数据库模型
│   └── cache/            # 缓存层
└── docs/                 # 文档
```

### 开发工作流

1. **修改代码**
   ```bash
   # 编辑 OAuth 服务
   nano apps/oauth-service/app/api/v2/users/route.ts
   ```

2. **运行测试**
   ```bash
   # 运行所有测试
   pnpm test
   
   # 运行特定服务测试
   pnpm --filter=oauth-service test
   ```

3. **代码检查**
   ```bash
   # 格式化代码
   pnpm format
   
   # 检查类型
   pnpm type-check
   
   # 运行 lint
   pnpm lint
   ```

### 常用命令

| 命令 | 描述 |
|------|------|
| `pnpm dev` | 启动所有开发服务 |
| `pnpm build` | 构建所有应用 |
| `pnpm test` | 运行所有测试 |
| `pnpm db:studio` | 打开数据库管理界面 |
| `pnpm db:push` | 同步数据库结构 |
| `pnpm db:seed` | 初始化数据 |

## 部署到生产环境

### Docker 部署

```bash
# 构建镜像
docker build -t oauth-service .

# 运行容器
docker run -d \
  --name oauth-service \
  -p 3001:3001 \
  -e DATABASE_URL="postgresql://user:pass@host:5432/db" \
  -e JWT_SECRET="your-secret-key" \
  oauth-service
```

### Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  oauth-service:
    build: .
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/oauth
      - JWT_SECRET=super-secret-jwt-key
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=oauth
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

启动生产环境：
```bash
docker-compose up -d
```

## 下一步

### 学习资源

1. **阅读完整文档**
   - [系统架构设计](../architecture/系统架构.md)
   - [API 参考文档](../api/API参考文档.md)
   - [RBAC 权限设计](../security/RBAC权限设计.md)

2. **集成示例**
   - [React 应用集成](../guidelines/集成示例指南.md#web-应用集成示例)
   - [后端服务集成](../guidelines/集成示例指南.md#后端服务集成示例)

3. **高级功能**
   - 自定义权限
   - 多租户支持
   - 审计日志
   - 性能优化

### 常见问题

**Q: 如何修改默认管理员密码？**
A: 登录管理后台后，在"个人资料"中修改密码。

**Q: 如何添加新的权限？**
A: 在管理后台的"权限管理"中添加，然后在"角色管理"中分配给相应角色。

**Q: 数据库如何从 SQLite 切换到 PostgreSQL？**
A: 修改 `.env` 文件中的 `DATABASE_URL`，然后运行 `pnpm db:push`。

## 获取帮助

- **文档**: 查看完整的 [文档目录](../README.md)
- **问题反馈**: [GitHub Issues](https://github.com/your-repo/issues)
- **技术支持**: [邮件支持](mailto:support@example.com)

---

恭喜！您已经成功搭建了 OAuth 2.1 认证中心。开始构建您的应用吧！