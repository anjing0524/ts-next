# ç¬¬ä¸‰é˜¶æ®µï¼šæ¨¡å—ç»“æ„ç»Ÿä¸€æ‰§è¡Œæ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-27  
> **æœ€åæ›´æ–°**: 2025-01-27  
> **æ–‡æ¡£çŠ¶æ€**: æ‰§è¡Œä¸­  
> **è´Ÿè´£äºº**: AI Assistant

## æ–‡æ¡£æ‘˜è¦

ç¬¬ä¸‰é˜¶æ®µä¸»è¦è§£å†³æ¨¡å—ç»“æ„ç»Ÿä¸€å’Œå¯¼å…¥è·¯å¾„é—®é¢˜ï¼ŒåŸºäº TypeScript ç¼–è¯‘é”™è¯¯åˆ†æï¼Œç³»ç»Ÿæ€§ä¿®å¤æ‰€æœ‰å¯¼å…¥è·¯å¾„ï¼Œå»ºç«‹ç»Ÿä¸€çš„æ¨¡å—å¯¼å‡ºç»“æ„ã€‚

## ç›®å½•

- [1. é—®é¢˜åˆ†æ](#1-é—®é¢˜åˆ†æ)
- [2. æ¨¡å—ç»“æ„è®¾è®¡](#2-æ¨¡å—ç»“æ„è®¾è®¡)
- [3. æ‰§è¡Œè®¡åˆ’](#3-æ‰§è¡Œè®¡åˆ’)
- [4. å¯¼å…¥è·¯å¾„ä¿®å¤](#4-å¯¼å…¥è·¯å¾„ä¿®å¤)
- [5. éªŒè¯æ–¹æ¡ˆ](#5-éªŒè¯æ–¹æ¡ˆ)

## 1. é—®é¢˜åˆ†æ

### 1.1 å½“å‰ä¸»è¦é—®é¢˜

**TypeScript ç¼–è¯‘é”™è¯¯ç»Ÿè®¡**:
- æ€»é”™è¯¯æ•°: 597 ä¸ª
- æ¶‰åŠæ–‡ä»¶: 78 ä¸ª
- ä¸»è¦é”™è¯¯ç±»å‹: æ¨¡å—å¯¼å…¥è·¯å¾„é”™è¯¯

**é—®é¢˜åˆ†ç±»**:

#### A. è·¯å¾„åˆ«åé—®é¢˜
```typescript
// âŒ é”™è¯¯ç¤ºä¾‹
import { ClientService } from '@/lib/services/client-service';
import { withAuth } from '@/lib/auth/middleware/bearer-auth';
import { prisma } from '@/lib/prisma';

// è¿™äº›è·¯å¾„åœ¨ç›¸åº”çš„åº”ç”¨ä¸­ä¸å­˜åœ¨
```

#### B. æ¨¡å—å¯¼å…¥ä¸ä¸€è‡´
```typescript
// âŒ ä¸ä¸€è‡´çš„å¯¼å…¥é£æ ¼
import { OAuth2ErrorTypes } from 'lib/auth/oauth2';     // ç›¸å¯¹è·¯å¾„
import { prisma } from '@/lib/prisma';                   // åˆ«åè·¯å¾„
import { JWTUtils } from '@repo/lib/auth/jwt-utils';     // åŒ…åˆ«å
```

#### C. ç¼ºå°‘å¿…è¦çš„å¯¼å‡ºæ–‡ä»¶
```typescript
// âŒ ç¼ºå°‘ç»Ÿä¸€å¯¼å‡º
import { withAuth } from '@/lib/auth/middleware/bearer-auth';
import { requirePermission } from '@/lib/auth';
```

### 1.2 å½±å“èŒƒå›´

**OAuth Service (æœ€ä¸¥é‡)**:
- API è·¯ç”±: 50+ ä¸ªé”™è¯¯
- è®¤è¯ä¸­é—´ä»¶å¯¼å…¥é”™è¯¯
- æœåŠ¡ç±»å¯¼å…¥é”™è¯¯
- æ•°æ®åº“å®¢æˆ·ç«¯å¯¼å…¥é”™è¯¯

**å…¶ä»–æœåŠ¡**:
- Admin Portal: ä¾èµ–ç›¸å…³é”™è¯¯
- Flow Service: React ç›¸å…³é”™è¯¯
- Test Service: å·¥å…·ç±»å¯¼å…¥é”™è¯¯

## 2. æ¨¡å—ç»“æ„è®¾è®¡

### 2.1 ç»Ÿä¸€å¯¼å‡ºç»“æ„

**ç›®æ ‡ç»“æ„**:
```
packages/lib/src/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ index.ts                    # è®¤è¯æ¨¡å—ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ jwt-utils.ts
â”‚   â”œâ”€â”€ pkce-utils.ts
â”‚   â”œâ”€â”€ scope-utils.ts
â”‚   â””â”€â”€ oauth2/
â”‚       â”œâ”€â”€ index.ts                # OAuth2 å­æ¨¡å—å¯¼å‡º
â”‚       â”œâ”€â”€ client-auth.ts
â”‚       â”œâ”€â”€ authorization-utils.ts
â”‚       â””â”€â”€ error-types.ts
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ index.ts                    # ä¸­é—´ä»¶ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ bearer-auth.ts
â”‚   â”‚   â””â”€â”€ validation.ts
â”‚   â”œâ”€â”€ cors.ts
â”‚   â””â”€â”€ rate-limit.ts
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ index.ts                    # æœåŠ¡ç±»ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ rbac-service.ts
â”‚   â”œâ”€â”€ client-service.ts
â”‚   â””â”€â”€ permission-service.ts
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ index.ts                    # å·¥å…·ç±»ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ error-handler.ts
â”‚   â”œâ”€â”€ rate-limit-utils.ts
â”‚   â””â”€â”€ logger.ts
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ index.ts                    # æ•°æ®åº“ç»Ÿä¸€å¯¼å‡º
â”‚   â””â”€â”€ client.ts
â””â”€â”€ index.ts                        # æ ¹çº§ç»Ÿä¸€å¯¼å‡º
```

### 2.2 åº”ç”¨çº§åˆ«ç»“æ„

**OAuth Service ç»“æ„**:
```
apps/oauth-service/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ index.ts                    # åº”ç”¨çº§ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ oauth2.ts
â”‚   â”‚   â””â”€â”€ flows/
â”‚   â”‚       â”œâ”€â”€ authorization-code-flow.ts
â”‚   â”‚       â””â”€â”€ client-credentials-flow.ts
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ client-service.ts       # åº”ç”¨ç‰¹å®šæœåŠ¡
â”‚   â””â”€â”€ prisma.ts                   # åº”ç”¨ç‰¹å®šæ•°æ®åº“é…ç½®
```

### 2.3 å¯¼å…¥è·¯å¾„è§„èŒƒ

**è§„èŒƒåŒ–åçš„å¯¼å…¥**:
```typescript
// âœ… åŒ…çº§åˆ«å¯¼å…¥ (ä¼˜å…ˆä½¿ç”¨)
import { JWTUtils, PKCEUtils, ScopeUtils } from '@repo/lib/auth';
import { RBACService } from '@repo/lib/services';
import { withErrorHandling } from '@repo/lib/utils';

// âœ… åº”ç”¨çº§åˆ«å¯¼å…¥
import { ClientService } from '@/lib/services';
import { prisma } from '@/lib/prisma';
import { OAuth2ErrorTypes } from '@/lib/auth';

// âœ… ç‰¹å®šæ¨¡å—å¯¼å…¥ (ä»…åœ¨å¿…è¦æ—¶)
import { AuthorizationCodeFlow } from '@/lib/auth/flows';
```

## 3. æ‰§è¡Œè®¡åˆ’

### 3.1 Phase 1: åˆ›å»ºç»Ÿä¸€å¯¼å‡ºæ–‡ä»¶

#### ä»»åŠ¡ 1.1: åˆ›å»ºåŒ…çº§åˆ«å¯¼å‡ºæ–‡ä»¶

**packages/lib/src/auth/index.ts**:
```typescript
// è®¤è¯ç›¸å…³å·¥å…·ç±»
export { JWTUtils } from './jwt-utils';
export { PKCEUtils } from './pkce-utils';
export { ScopeUtils } from './scope-utils';
export { PasswordUtils } from './password-utils';

// OAuth2 ç›¸å…³
export * from './oauth2-error-types';

// ç±»å‹å®šä¹‰
export type * from './types';
```

**packages/lib/src/services/index.ts**:
```typescript
// æœåŠ¡ç±»
export { RBACService } from './rbac-service';

// ç±»å‹å®šä¹‰
export type * from './types';
```

**packages/lib/src/utils/index.ts**:
```typescript
// å·¥å…·ç±»
export { RateLimitUtils } from './rate-limit-utils';
export { withErrorHandling } from './error-handler';
export { TimeWheel } from './time-wheel';

// ç±»å‹å®šä¹‰
export type * from './types';
```

**packages/lib/src/index.ts**:
```typescript
// æ ¹çº§å¯¼å‡º
export * from './auth';
export * from './services';
export * from './utils';
export * from './middleware';
```

#### ä»»åŠ¡ 1.2: åˆ›å»ºåº”ç”¨çº§åˆ«å¯¼å‡ºæ–‡ä»¶

**apps/oauth-service/lib/index.ts**:
```typescript
// åº”ç”¨ç‰¹å®šæœåŠ¡
export { ClientService } from './services/client-service';

// é‡æ–°å¯¼å‡ºå…±äº«æ¨¡å—
export * from '@repo/lib';

// åº”ç”¨ç‰¹å®šç±»å‹
export type * from './types';
```

**apps/oauth-service/lib/prisma.ts**:
```typescript
// åº”ç”¨ç‰¹å®šæ•°æ®åº“é…ç½®
export { prisma } from '@repo/database';
```

### 3.2 Phase 2: è¿ç§»æœåŠ¡å’Œä¸­é—´ä»¶

#### ä»»åŠ¡ 2.1: è¿ç§»é€šç”¨ä¸­é—´ä»¶åˆ° packages/lib

**ç›®æ ‡æ–‡ä»¶**:
```
packages/lib/src/middleware/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ bearer-auth.ts              # ä» oauth-service è¿ç§»
â”‚   â”œâ”€â”€ validation.ts               # ä» oauth-service è¿ç§»
â”‚   â””â”€â”€ cors.ts                     # ä» oauth-service è¿ç§»
â”œâ”€â”€ rate-limit.ts                   # ä» oauth-service è¿ç§»
â””â”€â”€ index.ts                        # ç»Ÿä¸€å¯¼å‡º
```

#### ä»»åŠ¡ 2.2: è¿ç§»é€šç”¨æœåŠ¡ç±»

**ç›®æ ‡æ–‡ä»¶**:
```
packages/lib/src/services/
â”œâ”€â”€ client-service.ts               # ä» oauth-service è¿ç§»é€šç”¨éƒ¨åˆ†
â”œâ”€â”€ permission-service.ts           # åˆ›å»ºç»Ÿä¸€æƒé™æœåŠ¡
â””â”€â”€ audit-service.ts                # åˆ›å»ºç»Ÿä¸€å®¡è®¡æœåŠ¡
```

### 3.3 Phase 3: æ‰¹é‡æ›´æ–°å¯¼å…¥è·¯å¾„

#### ä»»åŠ¡ 3.1: OAuth Service å¯¼å…¥è·¯å¾„æ›´æ–°

**éœ€è¦æ›´æ–°çš„æ–‡ä»¶æ¨¡å¼**:
```bash
apps/oauth-service/app/api/v2/**/*.ts
apps/oauth-service/lib/**/*.ts
apps/oauth-service/__tests__/**/*.ts
```

**æ›´æ–°è§„åˆ™**:
```typescript
// æ—§å¯¼å…¥ â†’ æ–°å¯¼å…¥
'lib/auth/oauth2'                    â†’ '@/lib/auth'
'lib/prisma'                         â†’ '@/lib/prisma'
'@/lib/services/client-service'      â†’ '@/lib/services'
'@/lib/auth/middleware/bearer-auth'  â†’ '@repo/lib/middleware/auth'
```

#### ä»»åŠ¡ 3.2: å…¶ä»–æœåŠ¡å¯¼å…¥è·¯å¾„æ›´æ–°

**Admin Portal**:
```typescript
// React å’Œ Next.js ç›¸å…³ä¾èµ–éœ€è¦å®‰è£…
npm install @types/react @types/node
```

**Flow Service**:
```typescript
// React æµç¨‹å›¾ç›¸å…³ä¾èµ–
npm install @types/react @types/node
```

## 4. å¯¼å…¥è·¯å¾„ä¿®å¤

### 4.1 è·¯å¾„æ˜ å°„é…ç½®

**tsconfig.json è·¯å¾„åˆ«å**:
```json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./"],
      "@/lib/*": ["./lib/*"],
      "@repo/lib": ["./packages/lib/src"],
      "@repo/lib/*": ["./packages/lib/src/*"],
      "@repo/database": ["./packages/database"],
      "@repo/ui": ["./packages/ui/src"]
    }
  }
}
```

### 4.2 ä¼˜å…ˆçº§è§„åˆ™

1. **@repo/lib**: ç”¨äºå…±äº«å·¥å…·ç±»å’ŒæœåŠ¡
2. **@/lib**: ç”¨äºåº”ç”¨ç‰¹å®šçš„æ¨¡å—
3. **ç›¸å¯¹è·¯å¾„**: ä»…ç”¨äºåŒä¸€ç›®å½•ä¸‹çš„æ–‡ä»¶

### 4.3 ä¾èµ–ç®¡ç†

**éœ€è¦å®‰è£…çš„ä¾èµ–**:
```json
{
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/node": "^20.0.0",
    "@types/jest": "^29.0.0"
  },
  "dependencies": {
    "@tanstack/react-table": "^8.0.0",
    "@tanstack/react-query": "^5.0.0",
    "react-toastify": "^10.0.0"
  }
}
```

## 5. éªŒè¯æ–¹æ¡ˆ

### 5.1 ç¼–è¯‘éªŒè¯

```bash
# 1. TypeScript ç¼–è¯‘æ£€æŸ¥
npx tsc --noEmit

# 2. ESLint æ£€æŸ¥
npx eslint . --ext .ts,.tsx

# 3. æµ‹è¯•è¿è¡Œ
npm run test

# 4. æ„å»ºéªŒè¯
npm run build
```

### 5.2 åŠŸèƒ½éªŒè¯

```bash
# 1. OAuth2 æµç¨‹æµ‹è¯•
npm run test:oauth

# 2. API ç«¯ç‚¹æµ‹è¯•
npm run test:api

# 3. é›†æˆæµ‹è¯•
npm run test:integration
```

### 5.3 æ€§èƒ½éªŒè¯

```bash
# 1. æ‰“åŒ…å¤§å°åˆ†æ
npm run build:analyze

# 2. å¯åŠ¨æ—¶é—´æµ‹è¯•
npm run dev:profile
```

## 6. æ‰§è¡Œæ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|------|----------|------|
| 1 | åˆ›å»ºç»Ÿä¸€å¯¼å‡ºæ–‡ä»¶ | 45åˆ†é’Ÿ | ğŸ“‹ å¾…æ‰§è¡Œ |
| 2 | è¿ç§»æœåŠ¡å’Œä¸­é—´ä»¶ | 60åˆ†é’Ÿ | ğŸ“‹ å¾…æ‰§è¡Œ |
| 3 | æ‰¹é‡æ›´æ–°å¯¼å…¥è·¯å¾„ | 90åˆ†é’Ÿ | ğŸ“‹ å¾…æ‰§è¡Œ |
| 4 | å®‰è£…ç¼ºå¤±ä¾èµ– | 15åˆ†é’Ÿ | ğŸ“‹ å¾…æ‰§è¡Œ |
| 5 | ç¼–è¯‘å’Œæµ‹è¯•éªŒè¯ | 30åˆ†é’Ÿ | ğŸ“‹ å¾…æ‰§è¡Œ |

**æ€»è®¡**: çº¦ 4 å°æ—¶

## 7. éªŒæ”¶æ ‡å‡†

- [ ] TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] å¯¼å…¥è·¯å¾„éµå¾ªç»Ÿä¸€è§„èŒƒ
- [ ] æ¨¡å—å¯¼å‡ºç»“æ„æ¸…æ™°
- [ ] ä¾èµ–å…³ç³»åˆç†
- [ ] æ„å»ºæˆåŠŸ
- [ ] åŠŸèƒ½å®Œæ•´æ€§éªŒè¯é€šè¿‡

## 8. é£é™©è¯„ä¼°

### 8.1 é£é™©åˆ†æ

| é£é™©ç­‰çº§ | é£é™©æè¿° | ç¼“è§£æªæ–½ |
|---------|----------|----------|
| **é«˜** | å¤§é‡å¯¼å…¥è·¯å¾„æ›´æ–°å¯èƒ½é—æ¼ | ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–æ›´æ–° |
| **ä¸­** | æ¨¡å—è¿ç§»ç ´åç°æœ‰åŠŸèƒ½ | ä¿æŒ API å…¼å®¹æ€§ |
| **ä¸­** | ä¾èµ–å®‰è£…å¯èƒ½æœ‰å†²çª | é€æ­¥å®‰è£…å¹¶æµ‹è¯• |
| **ä½** | æµ‹è¯•éœ€è¦åŒæ­¥æ›´æ–° | å¹¶è¡Œæ›´æ–°æµ‹è¯•æ–‡ä»¶ |

### 8.2 å›æ»šè®¡åˆ’

1. **Git åˆ†æ”¯ä¿æŠ¤**: åœ¨ç‹¬ç«‹åˆ†æ”¯æ‰§è¡Œ
2. **å¢é‡æäº¤**: æ¯ä¸ªé˜¶æ®µå•ç‹¬æäº¤
3. **å›æ»šè„šæœ¬**: å‡†å¤‡è‡ªåŠ¨å›æ»šæ–¹æ¡ˆ

## 9. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. ğŸ—ï¸ åˆ›å»ºç»Ÿä¸€å¯¼å‡ºæ–‡ä»¶ç»“æ„
2. ğŸ“¦ å®‰è£…ç¼ºå¤±çš„ä¾èµ–åŒ…
3. ğŸ”§ ä¿®å¤æœ€ä¸¥é‡çš„å¯¼å…¥è·¯å¾„é”™è¯¯
4. âœ… è¿è¡Œç¼–è¯‘éªŒè¯

### åç»­è®¡åˆ’
1. ğŸ“‹ å®Œå–„æµ‹è¯•è¦†ç›–ç‡
2. ğŸ“– æ›´æ–°ç›¸å…³æ–‡æ¡£
3. ğŸš€ å‡†å¤‡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´: 2025-01-27*  
*æ‰§è¡Œè´Ÿè´£äºº: AI Assistant*  
*å½“å‰çŠ¶æ€: å‡†å¤‡æ‰§è¡Œ* 