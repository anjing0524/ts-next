# 系统架构设计

**版本**: 3.0
**状态**: 设计中

## 1. 概述

本系统采用基于 `Turborepo` 的微服务架构（Monorepo），旨在构建一个可扩展、高内聚、低耦合的认证与业务服务平台。该架构整合了 `OAuth2.1` 认证授权服务、`RBAC` 权限管理、以及多个独立的业务微服务。

### 1.1. 技术选型

- **Monorepo**: Turborepo
- **Web框架**: Next.js 15 (App Router)
- **UI**: shadcn/ui + Tailwind CSS
- **语言**: TypeScript

## 2. 宏观架构

系统分为两个核心部分：`Apps`（应用层）和 `Packages`（共享层）。

```mermaid
graph TD
    subgraph Apps (应用层)
        A[oauth-service: 认证授权服务]
        B[admin-portal: 后台管理门户]
        C[kline-service: K线服务]
        D[flow-service: 流程引擎服务]
        E[test-service: 测试与示例服务]
    end

    subgraph Packages (共享层)
        P1[@repo/ui: 共享UI组件库]
        P2[@repo/lib: 共享工具库]
        P3[@repo/database: 数据库ORM与模型]
        P4[eslint-config-custom: ESLint配置]
        P5[tsconfig: TypeScript配置]
    end

    A --> P1 & P2 & P3
    B --> P1 & P2 & P3
    C --> P2 & P3
    D --> P2 & P3
    E --> P1 & P2
```

## 3. 分层详解

### 3.1. Apps（应用层）

`Apps` 目录包含所有独立部署的微服务应用。

- **`oauth-service`**: 
  - **职责**: 核心认证授权服务，实现 `OAuth2.1` 和 `OIDC` 标准。
  - **功能**: 用户注册、登录、令牌发放、令牌验证、PKCE支持、RBAC权限管理。
  - **技术**: Next.js, Prisma, Jose

- **`admin-portal`**: 
  - **职责**: 系统后台管理界面。
  - **功能**: 用户管理、客户端管理、角色权限分配、系统监控。
  - **技术**: Next.js, shadcn/ui, TanStack Query

- **`kline-service`**: 
  - **职责**: 提供金融图表（K线）数据和渲染服务。
  - **功能**: K线数据聚合、WASM高性能计算、实时数据推送。
  - **技术**: Next.js, Rust (WebAssembly), WebSockets

- **`flow-service`**: 
  - **职责**: 可视化流程编排与执行引擎。
  - **功能**: 拖拽式流程设计、节点任务执行、状态持久化。
  - **技术**: Next.js, React Flow

- **`test-service`**: 
  - **职责**: 用于开发、测试和演示的客户端应用。
  - **功能**: 模拟OAuth2.1授权流程、测试API接口、展示UI组件。

### 3.2. Packages（共享层）

`Packages` 目录包含跨应用共享的代码库。

- **`@repo/ui`**: 
  - **职责**: 共享的 `React` 组件库。
  - **内容**: 基于 `shadcn/ui` 封装的通用业务组件，如布局、表单、数据展示等。

- **`@repo/lib`**: 
  - **职责**: 共享的工具函数和类型定义。
  - **内容**: 日期格式化、数据验证(Zod)、常量、TypeScript类型定义等。

- **`@repo/database`**: 
  - **职责**: 数据库访问和模型定义。
  - **内容**: `Prisma` schema、数据库客户端实例、数据迁移脚本。

- **配置包**: 
  - `eslint-config-custom`: 统一的 ESLint 代码风格配置。
  - `tsconfig`: 基础和共享的 TypeScript 配置文件。

## 4. 服务间通信

- **同步通信**: 微服务之间通过 `RESTful API` 或 `gRPC` 进行直接调用，并由 `oauth-service` 签发的 `JWT` 进行认证。
- **异步通信**: 考虑使用消息队列（如 `RabbitMQ` 或 `Kafka`）处理事件驱动的异步任务。

## 5. Turborepo 配置

`turbo.json` 文件定义了任务依赖和缓存策略，以优化构建和开发流程。

```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**"]
    },
    "lint": {
      "dependsOn": ["^lint"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```







## API设计

### OAuth2.1端点

#### 1. 授权端点

```
GET /api/v2/oauth/authorize
```

**参数**:

- `response_type`: 固定为 "code"
- `client_id`: 客户端ID
- `redirect_uri`: 重定向URI
- `scope`: 请求的权限范围
- `state`: 防CSRF状态参数
- `code_challenge`: PKCE挑战码
- `code_challenge_method`: 固定为 "S256"

#### 2. 令牌端点

```
POST /api/v2/oauth/token
```

**授权码模式**:

```json
{
  "grant_type": "authorization_code",
  "code": "授权码",
  "redirect_uri": "重定向URI",
  "client_id": "客户端ID",
  "code_verifier": "PKCE验证码"
}
```

**客户端凭证模式**:

```json
{
  "grant_type": "client_credentials",
  "scope": "请求的权限范围"
}
```

**刷新令牌**:

```json
{
  "grant_type": "refresh_token",
  "refresh_token": "刷新令牌"
}
```

#### 3. 用户信息端点

```
GET /api/v2/oauth/userinfo
Authorization: Bearer {access_token}
```

#### 4. 令牌撤销端点

```
POST /api/v2/oauth/revoke
```

### OIDC发现端点

#### 1. 配置发现

```
GET /.well-known/openid-configuration
```

#### 2. 公钥端点

```
GET /.well-known/jwks.json
```

## 安全机制

### 1. PKCE (强制)

- 所有授权码流程必须使用PKCE
- 使用SHA256哈希算法
- 防止授权码拦截攻击

### 2. JWT安全

- 使用RS256算法签名
- 支持公钥验证
- 包含标准声明 (iss, aud, exp, iat, sub)

### 3. 客户端认证

- 机密客户端使用HTTP Basic认证
- 公开客户端仅验证client_id
- 支持客户端密钥轮换

### 4. 权限控制

- 基于RBAC模型
- 细粒度权限控制
- 支持资源级别权限

## 安全设计

### 密码安全

- BCrypt哈希存储
- 密码强度要求
- 密码历史记录
- 强制密码更新
- 账户锁定机制
- 登录尝试记录

### 令牌安全

- JWT使用RS256签名
- 访问令牌短期有效(15分钟)
- 刷新令牌长期有效(30天)
- 令牌撤销机制
- JTI黑名单管理
- 令牌轮换策略

### 传输安全

- 强制HTTPS
- HSTS头部
- 安全Cookie设置
- CSRF保护
- XSS防护

### 访问控制

- RBAC权限模型
- 最小权限原则
- 权限缓存机制
- IP白名单控制
- 客户端认证

## 缓存策略

### 权限缓存

- **内存缓存**: 用户权限信息缓存15分钟
- **Redis缓存**: 分布式环境下的权限共享
- **缓存失效**: 权限变更时主动清除

### 令牌缓存

- **黑名单缓存**: 撤销令牌的JTI缓存
- **客户端信息缓存**: OAuth客户端配置缓存

### 配置缓存

- **系统配置**: 启动时加载，变更时刷新
- **安全策略**: 内存缓存，定期同步

## 性能优化

### 数据库优化

- **索引策略**: 关键字段建立复合索引
- **查询优化**: 使用Prisma查询优化
- **连接池**: 数据库连接池管理

### API优化

- **响应压缩**: Gzip压缩
- **请求限流**: 基于IP和用户的限流
- **异步处理**: 非关键操作异步执行

### 前端优化

- **代码分割**: 路由级别的代码分割
- **静态资源**: CDN加速
- **缓存策略**: 浏览器缓存优化

## JWT认证授权使用说明

### JWT结构

#### Header

```json
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "key-id"
}
```

#### Payload (Access Token)

```json
{
  "iss": "https://auth.company.com",
  "aud": "api.company.com",
  "sub": "user-id",
  "client_id": "client-id",
  "scope": "openid profile read:users",
  "permissions": ["user:read", "user:write"],
  "iat": 1640995200,
  "exp": 1640998800,
  "jti": "token-id"
}
```

### 令牌验证流程

1. **获取公钥**: 从 `/.well-known/jwks.json` 获取
2. **验证签名**: 使用RS256算法验证
3. **检查声明**: 验证iss, aud, exp等
4. **权限检查**: 验证scope和permissions

### 使用示例

#### 1. 获取访问令牌

```javascript
// 授权码模式
const tokenResponse = await fetch('/api/v2/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    grant_type: 'authorization_code',
    code: authorizationCode,
    redirect_uri: redirectUri,
    client_id: clientId,
    code_verifier: codeVerifier,
  }),
});

const tokens = await tokenResponse.json();
```

#### 2. 使用访问令牌

```javascript
const apiResponse = await fetch('/api/v2/users', {
  headers: {
    Authorization: `Bearer ${tokens.access_token}`,
  },
});
```

#### 3. 刷新令牌

```javascript
const refreshResponse = await fetch('/api/v2/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: tokens.refresh_token,
  }),
});
```

## 管理页面设计

### 页面结构

```
管理控制台
├── 仪表板
│   ├── 系统概览
│   ├── 活跃用户统计
│   └── 令牌使用统计
├── 用户管理
│   ├── 用户列表
│   ├── 创建用户
│   ├── 编辑用户
│   └── 用户权限
├── 客户端管理
│   ├── 客户端列表
│   ├── 注册客户端
│   ├── 编辑客户端
│   └── 客户端密钥
├── 权限管理
│   ├── 角色管理
│   ├── 权限管理
│   └── 权限分配
├── 审计日志
│   ├── 登录日志
│   ├── 操作日志
│   └── 安全事件
└── 系统设置
    ├── 安全策略
    ├── 令牌配置
    └── 系统配置
```

### 页面权限设计

#### 权限矩阵

| 页面/功能  | 超级管理员 | 用户管理员 | 客户端管理员 | 审计员 | 普通用户 |
| ---------- | ---------- | ---------- | ------------ | ------ | -------- |
| 仪表板     | ✓          | ✓          | ✓            | ✓      | ✓        |
| 用户管理   | ✓          | ✓          | ✗            | ✗      | ✗        |
| 客户端管理 | ✓          | ✗          | ✓            | ✗      | ✗        |
| 权限管理   | ✓          | ✓          | ✗            | ✗      | ✗        |
| 审计日志   | ✓          | ✓          | ✓            | ✓      | ✗        |
| 系统设置   | ✓          | ✗          | ✗            | ✗      | ✗        |

#### 菜单权限配置

```typescript
const menuPermissions = {
  dashboard: ['admin:read', 'user:read'],
  userManagement: ['admin:users:read', 'admin:users:write'],
  clientManagement: ['admin:clients:read', 'admin:clients:write'],
  permissionManagement: ['admin:permissions:read', 'admin:permissions:write'],
  auditLogs: ['admin:audit:read'],
  systemSettings: ['admin:system:read', 'admin:system:write'],
};
```

## 权限体系设计

### RBAC模型

```
用户 (User) ←→ 用户角色 (UserRole) ←→ 角色 (Role)
                                        ↓
                                   角色权限 (RolePermission)
                                        ↓
                                   权限 (Permission)
```

### 预定义角色

1. **超级管理员 (super_admin)**

   - 系统最高权限
   - 可管理所有资源

2. **用户管理员 (user_admin)**

   - 用户和角色管理
   - 权限分配

3. **客户端管理员 (client_admin)**

   - OAuth客户端管理
   - 客户端配置

4. **审计员 (auditor)**

   - 查看审计日志
   - 生成合规报告

5. **普通用户 (user)**
   - 基本用户权限
   - 个人信息管理

### 权限命名规范

```
格式: {resource}:{action}

示例:
- user:read          # 读取用户信息
- user:write         # 修改用户信息
- client:read        # 读取客户端信息
- client:write       # 修改客户端信息
- admin:users:read   # 管理员读取用户
- admin:users:write  # 管理员修改用户
```

## 部署指南

### 环境要求

- Node.js 18+
- SQLite
- Redis (可选，用于会话存储)

### 环境变量

```bash
# 数据库
DATABASE_URL="postgresql://user:password@localhost:5432/oauth_db"

# JWT密钥
JWT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"

# 应用配置
NEXTAUTH_URL="https://auth.company.com"
NEXTAUTH_SECRET="your-secret-key"

# 安全配置
BCRYPT_ROUNDS=12
TOKEN_ISSUER="https://auth.company.com"
TOKEN_AUDIENCE="api.company.com"
```

### 部署步骤

1. **安装依赖**

```bash
npm install
```

2. **数据库迁移**

```bash
npx prisma migrate deploy
npx prisma db seed
```

3. **构建应用**

```bash
npm run build
```

4. **启动服务**

```bash
npm start
```

### 健康检查

```bash
# 检查服务状态
curl https://auth.company.com/api/v2/health

# 检查OIDC配置
curl https://auth.company.com/.well-known/openid-configuration

# 检查公钥端点
curl https://auth.company.com/.well-known/jwks.json
```

---

**文档维护**: 本文档应随系统更新而更新，确保与实际实现保持一致。
**联系方式**: 如有问题，请联系认证授权团队。

# 系统架构设计

最新更新日期：2025年01月15日

## 1. Turborepo微服务架构

### 1.1 架构概览

本项目基于Turborepo构建的微服务架构，采用Next.js 15 + shadcn/ui + Tailwind CSS技术栈，实现OAuth2.1认证授权和RBAC权限管理系统。

```mermaid
graph TB
    subgraph "Turborepo Monorepo"
        subgraph "Apps 应用层"
            A[oauth-service:3001<br/>OAuth2认证服务]
            B[admin-portal:3002<br/>管理后台]
            C[kline-service:3003<br/>K线图表服务]
            D[flow-service:3004<br/>流程图服务]
            E[test-service:3005<br/>测试与其他API]
        end
        
        subgraph "Packages 共享层"
            F[@repo/ui<br/>shadcn/ui组件]
            G[@repo/lib<br/>共享工具函数]
            H[@repo/database<br/>Prisma数据库]
            I[@repo/eslint-config<br/>ESLint配置]
            J[@repo/typescript-config<br/>TypeScript配置]
            K[@repo/tailwind-config<br/>Tailwind配置]
        end
    end
    
    B --> A
    C --> A
    D --> A
    E --> A
    
    A --> F
    A --> G
    A --> H
    B --> F
    B --> G
    B --> H
    C --> F
    C --> G
    D --> F
    D --> G
    E --> F
    E --> G
    E --> H
```

### 1.2 服务详细说明

#### 1.2.1 oauth-service (端口3001)
**功能职责：**
- OAuth2.1授权码流程实现
- JWT令牌签发与验证
- PKCE安全增强
- 用户认证与会话管理
- OIDC用户信息端点

**核心端点：**
- `GET /api/v2/oauth/authorize` - 授权端点
- `POST /api/v2/oauth/token` - 令牌端点  
- `GET /api/v2/oauth/userinfo` - 用户信息端点
- `POST /api/v2/oauth/revoke` - 令牌撤销
- `GET /.well-known/jwks.json` - JWT验证公钥

#### 1.2.2 admin-portal (端口3002)  
**功能职责：**
- 管理员登录界面
- 用户权限管理
- 系统配置管理
- 审计日志查看
- RBAC角色管理

**认证方式：**
- 通过oauth-service进行OAuth2认证
- 获取JWT令牌后访问管理功能
- 基于权限的界面控制

#### 1.2.3 kline-service (端口3003)
**功能职责：**
- K线图表数据处理
- WASM计算模块(Rust)
- FlatBuffers数据序列化
- 实时图表渲染
- 技术指标计算

**技术特点：**
- Rust + WASM高性能计算
- OffscreenCanvas多线程渲染
- FlatBuffers零拷贝数据传输

#### 1.2.4 flow-service (端口3004)
**功能职责：**
- 工作流可视化编辑
- 流程图拖拽功能
- 节点关系管理
- 流程执行引擎

**技术栈：**
- @xyflow/react流程图组件
- @dnd-kit拖拽功能
- 状态管理和持久化

#### 1.2.5 test-service (端口3005)
**功能职责：**
- 开发测试API
- 系统健康检查
- 性能监控端点
- 备份恢复管理
- 其他杂项功能

### 1.3 共享包架构

#### 1.3.1 @repo/ui
- shadcn/ui组件库
- 统一UI设计系统
- Tailwind CSS样式
- 响应式组件

#### 1.3.2 @repo/lib  
- OAuth2工具函数
- RBAC权限服务
- API响应格式
- 错误处理机制
- 日志工具

#### 1.3.3 @repo/database
- Prisma ORM配置
- 数据库迁移脚本
- 种子数据
- 数据库连接池

#### 1.3.4 配置包
- `@repo/eslint-config`: 统一代码规范
- `@repo/typescript-config`: TypeScript配置
- `@repo/tailwind-config`: Tailwind样式配置

### 1.4 服务间通信

#### 1.4.1 认证流程
```mermaid
sequenceDiagram
    participant U as 用户
    participant A as admin-portal
    participant O as oauth-service
    participant API as 其他服务
    
    U->>A: 访问管理页面
    A->>O: 重定向到OAuth授权
    U->>O: 用户登录认证
    O->>A: 返回授权码
    A->>O: 交换访问令牌
    O->>A: 返回JWT令牌
    A->>API: 携带JWT访问API
    API->>O: 验证JWT签名
    O->>API: 返回验证结果
    API->>A: 返回API响应
```

#### 1.4.2 API网关模式
- 所有对外服务通过nginx代理
- 基于路径前缀路由到不同服务
- 统一CORS和安全策略
- 负载均衡和故障转移

### 1.5 Turborepo配置

#### 1.5.1 任务编排
```json
{
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "dependsOn": ["^lint"]
    },
    "test": {
      "dependsOn": ["^build"]
    }
  }
}
```

#### 1.5.2 缓存策略
- 构建产物缓存
- 依赖安装缓存  
- 测试结果缓存
- 远程缓存支持
