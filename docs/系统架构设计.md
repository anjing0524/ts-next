# OAuth2.1认证授权中心技术设计文档

**版本**: 2.0  
**创建日期**: 2024-12-19  
**状态**: 生产就绪  
**团队**: 认证授权团队

## 目录

1. [系统概述](#系统概述)
2. [核心功能](#核心功能)
3. [技术架构](#技术架构)
4. [数据库设计](#数据库设计)
5. [API设计](#api设计)
6. [安全机制](#安全机制)
7. [JWT认证授权使用说明](#jwt认证授权使用说明)
8. [管理页面设计](#管理页面设计)
9. [权限体系设计](#权限体系设计)
10. [部署指南](#部署指南)

## 系统概述

本系统是基于OAuth2.1标准的认证授权中心，专为内网环境设计，支持授权码模式和客户端凭证模式，强制使用PKCE，支持OIDC公钥获取，采用RBAC权限模型。

### 设计原则

- **内网专用**: 专为内网环境设计，无需邮箱/手机验证
- **管理员驱动**: 用户和客户端由管理员创建和管理
- **安全优先**: 强制PKCE，支持JWT签名验证
- **标准兼容**: 完全兼容OAuth2.1和OIDC标准
- **简洁高效**: 专注认证授权核心功能

## 核心功能

### 支持的授权模式

1. **授权码模式 (Authorization Code)**

   - 强制PKCE (Proof Key for Code Exchange)
   - 支持刷新令牌
   - 适用于Web应用和移动应用

2. **客户端凭证模式 (Client Credentials)**
   - 用于服务间通信
   - 无需用户交互
   - 基于客户端身份的权限控制

### OIDC支持

- 标准的用户信息端点
- JWT ID Token
- 公钥端点 (/.well-known/jwks.json)
- 发现端点 (/.well-known/openid-configuration)

## 技术架构

### 技术栈

### 前端技术栈

- **框架**: Next.js 15.1.0 (App Router)
- **语言**: TypeScript 5.6.x
- **样式**: Tailwind CSS 3.4.x
- **UI组件**: Shadcn/ui 0.8.x (基于Radix UI)
- **状态管理**: Zustand 4.5.x
- **表单处理**: React Hook Form 7.x + Zod 3.x
- **HTTP客户端**: Fetch API (原生) + TanStack Query 5.x
- **构建工具**: Turbopack (Next.js 15内置)
- **图标**: Lucide React 0.4.x

### 后端技术栈

- **运行时**: Node.js 18.20+ / 20.x LTS
- **框架**: Next.js 15.1.0 API Routes
- **语言**: TypeScript 5.6.x
- **数据库**: SQLite 3.x (开发) / PostgreSQL 15+ (生产)
- **ORM**: Prisma 5.22.x
- **认证**: JWT (jose 5.x) + OAuth 2.1
- **加密**: bcrypt 5.x (密码哈希)
- **验证**: Zod 3.x (数据验证)
- **缓存**: 内存缓存 + Redis 7.x (可选)
- **WebAssembly**: Rust 1.75+ + wasm-pack 0.12.x
- **日期处理**: date-fns 3.x

### WebAssembly架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端 (Next.js)                          │
├─────────────────────────────────────────────────────────────┤
│  TypeScript/JavaScript 业务逻辑                            │
├─────────────────────────────────────────────────────────────┤
│  WASM 绑定层 (wasm-bindgen)                               │
├─────────────────────────────────────────────────────────────┤
│  WebAssembly 模块                                          │
│  ┌─────────────────┐  ┌─────────────────┐                 │
│  │   K线计算模块    │  │   加密算法模块   │                 │
│  │   (Rust)        │  │   (Rust)        │                 │
│  └─────────────────┘  └─────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

**WASM模块功能**:
- **K线数据处理**: 高性能的金融数据计算和渲染
- **加密算法**: 性能关键的加密解密操作
- **数据压缩**: 大数据量的压缩和解压缩
- **图像处理**: Canvas绘制优化

### 数据库与Prisma对应关系

```typescript
// Prisma Schema 与数据库表对应关系
model User {
  // 对应数据库表: users
  id           String    @id @default(cuid())
  username     String    @unique
  passwordHash String    @map("password_hash")
  // ... 其他字段
  
  @@map("users") // 显式指定表名
}

model OAuthClient {
  // 对应数据库表: oauth_clients
  id                String     @id @default(cuid())
  clientId          String     @unique @map("client_id")
  clientSecret      String?    @map("client_secret")
  // ... 其他字段
  
  @@map("oauth_clients")
}

model AccessToken {
  // 对应数据库表: access_tokens
  id        String   @id @default(cuid())
  token     String   @unique
  tokenHash String   @unique @map("token_hash")
  // ... 其他字段
  
  @@map("access_tokens")
}
```

**数据库设计原则**:
- **表名**: 使用snake_case命名(users, oauth_clients)
- **字段名**: 使用snake_case命名(client_id, password_hash)
- **索引**: 关键查询字段添加索引
- **外键**: 使用Prisma关系管理外键约束
- **迁移**: 使用Prisma Migrate管理数据库版本

### 开发工具

- **包管理**: npm (Node.js 内置)
- **代码规范**: ESLint 8.x + Prettier 3.x
- **类型检查**: TypeScript 5.6.x
- **测试框架**: Jest 29.x + @testing-library/jest-dom
- **JWT处理**: jose 6.0.11 (替代jsonwebtoken)
- **Git钩子**: Husky 8.x + lint-staged 15.x
- **容器化**: Docker 24.x + Docker Compose 2.x

### 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端应用     │    │   认证授权中心   │    │   资源服务器     │
│                │    │                │    │                │
│ - Web App      │◄──►│ - OAuth2.1     │◄──►│ - API Services │
│ - Mobile App   │    │ - OIDC         │    │ - Microservices│
│ - Service      │    │ - JWT          │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 安全机制

### OAuth2.1 安全增强

#### PKCE (Proof Key for Code Exchange)
```typescript
// PKCE 流程实现
interface PKCEChallenge {
  codeVerifier: string;    // 43-128字符的随机字符串
  codeChallenge: string;   // SHA256(codeVerifier) 的 base64url 编码
  codeChallengeMethod: 'S256'; // 固定使用 SHA256
}

// 代码挑战生成
function generatePKCEChallenge(): PKCEChallenge {
  const codeVerifier = generateRandomString(128);
  const codeChallenge = base64urlEncode(sha256(codeVerifier));
  return {
    codeVerifier,
    codeChallenge,
    codeChallengeMethod: 'S256'
  };
}
```

#### JWT 安全配置
```typescript
// JWT 配置
interface JWTConfig {
  algorithm: 'RS256';           // 使用 RSA SHA-256
  issuer: string;               // 发行者标识
  audience: string[];           // 受众列表
  accessTokenTtl: number;       // 访问令牌有效期 (秒)
  refreshTokenTtl: number;      // 刷新令牌有效期 (秒)
  keyRotationInterval: number;  // 密钥轮换间隔 (天)
}

// 令牌安全特性
- **短期访问令牌**: 默认1小时过期
- **长期刷新令牌**: 默认30天过期，支持轮换
- **令牌绑定**: 绑定客户端和用户
- **作用域限制**: 细粒度权限控制
- **令牌撤销**: 支持主动撤销
```

#### 密码安全策略
```typescript
// 密码哈希配置
interface PasswordConfig {
  algorithm: 'bcrypt';     // 使用 bcrypt
  saltRounds: 12;          // 盐轮数
  minLength: 8;            // 最小长度
  requireUppercase: true;  // 需要大写字母
  requireLowercase: true;  // 需要小写字母
  requireNumbers: true;    // 需要数字
  requireSymbols: true;    // 需要特殊字符
}

// 账户安全
- **登录失败锁定**: 5次失败后锁定30分钟
- **密码过期**: 90天强制更换
- **密码历史**: 禁止重复使用最近5个密码
- **会话管理**: 30分钟无操作自动登出
```

### API 安全设计

#### 请求验证
```typescript
// API 请求验证中间件
interface APISecurityMiddleware {
  rateLimit: RateLimitConfig;      // 速率限制
  cors: CORSConfig;                // 跨域配置
  csrf: CSRFConfig;                // CSRF 保护
  contentValidation: ValidationConfig; // 内容验证
}

// 速率限制配置
interface RateLimitConfig {
  windowMs: number;        // 时间窗口 (毫秒)
  maxRequests: number;     // 最大请求数
  skipSuccessfulRequests: boolean; // 跳过成功请求
  keyGenerator: (req: Request) => string; // 键生成器
}
```

#### 数据验证
```typescript
// 使用 Zod 进行数据验证
const AuthorizationRequestSchema = z.object({
  response_type: z.literal('code'),
  client_id: z.string().min(1),
  redirect_uri: z.string().url(),
  scope: z.string().optional(),
  state: z.string().min(1),
  code_challenge: z.string().min(43).max(128),
  code_challenge_method: z.literal('S256')
});

// 输入清理和转义
function sanitizeInput(input: string): string {
  return input
    .trim()
    .replace(/[<>"'&]/g, (char) => {
      const entities: Record<string, string> = {
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#x27;',
        '&': '&amp;'
      };
      return entities[char] || char;
    });
}
```

## 数据库设计

### 核心模型

#### User (用户)
```typescript
model User {
  id           String    @id @default(cuid())
  username     String    @unique
  passwordHash String    @map("password_hash")
  isActive     Boolean   @default(true) @map("is_active")
  displayName  String?   @map("display_name")
  lastLoginAt  DateTime? @map("last_login_at")
  passwordChangedAt DateTime @default(now()) @map("password_changed_at")
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lockedUntil  DateTime? @map("locked_until")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  
  // 关联关系
  roles              UserRole[]
  authorizationCodes AuthorizationCode[]
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]
  
  @@map("users")
  @@index([username])
  @@index([isActive])
}
```

#### OAuthClient (OAuth客户端)
```typescript
model OAuthClient {
  id                String     @id @default(cuid())
  clientId          String     @unique @map("client_id")
  clientSecret      String?    @map("client_secret") // 公共客户端可为空
  clientType        ClientType @map("client_type") // PUBLIC | CONFIDENTIAL
  name              String
  redirectUris      String[]   @map("redirect_uris") // JSON数组
  allowedScopes     String[]   @map("allowed_scopes") // JSON数组
  accessTokenTtl    Int        @default(3600) @map("access_token_ttl")    // 秒
  refreshTokenTtl   Int        @default(2592000) @map("refresh_token_ttl") // 30天
  requirePkce       Boolean    @default(true) @map("require_pkce")
  isActive          Boolean    @default(true) @map("is_active")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  
  // 关联关系
  authorizationCodes AuthorizationCode[]
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]
  
  @@map("oauth_clients")
  @@index([clientId])
  @@index([isActive])
}

enum ClientType {
  PUBLIC
  CONFIDENTIAL
  
  @@map("client_type")
}
```

#### Role & Permission (角色和权限)
```typescript
model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  
  users       UserRole[]
  permissions RolePermission[]
  
  @@map("roles")
  @@index([name])
  @@index([isActive])
}

model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  resource    String           // 资源名称
  action      String           // 操作类型
  description String?
  createdAt   DateTime         @default(now()) @map("created_at")
  
  roles       RolePermission[]
  
  @@map("permissions")
  @@index([resource, action])
}

model UserRole {
  id     String @id @default(cuid())
  userId String @map("user_id")
  roleId String @map("role_id")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String @map("role_id")
  permissionId String @map("permission_id")
  
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
}
```

#### Token Models (令牌模型)
```typescript
model AuthorizationCode {
  id              String   @id @default(cuid())
  code            String   @unique
  codeHash        String   @unique @map("code_hash")
  clientId        String   @map("client_id")
  userId          String   @map("user_id")
  redirectUri     String   @map("redirect_uri")
  scope           String?
  codeChallenge   String?  @map("code_challenge")
  codeChallengeMethod String? @map("code_challenge_method")
  expiresAt       DateTime @map("expires_at")
  isUsed          Boolean  @default(false) @map("is_used")
  createdAt       DateTime @default(now()) @map("created_at")
  
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("authorization_codes")
  @@index([code])
  @@index([expiresAt])
  @@index([clientId, userId])
}

model AccessToken {
  id        String   @id @default(cuid())
  token     String   @unique
  tokenHash String   @unique @map("token_hash")
  clientId  String   @map("client_id")
  userId    String?  @map("user_id") // 客户端凭证流可为空
  scope     String?
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")
  
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("access_tokens")
  @@index([token])
  @@index([expiresAt])
  @@index([clientId, userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  tokenHash String   @unique @map("token_hash")
  clientId  String   @map("client_id")
  userId    String   @map("user_id")
  scope     String?
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")
  
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
  @@index([token])
  @@index([expiresAt])
  @@index([clientId, userId])
}
```

## API 设计规范

### RESTful API 设计

#### 端点命名规范
```typescript
// OAuth2.1 标准端点
const OAUTH_ENDPOINTS = {
  // 授权端点
  AUTHORIZATION: '/oauth/authorize',
  // 令牌端点
  TOKEN: '/oauth/token',
  // 令牌撤销端点
  REVOKE: '/oauth/revoke',
  // 令牌内省端点
  INTROSPECT: '/oauth/introspect',
  // OIDC 用户信息端点
  USERINFO: '/oauth/userinfo',
  // OIDC 发现端点
  DISCOVERY: '/.well-known/openid-configuration',
  // JWKS 端点
  JWKS: '/.well-known/jwks.json'
} as const;

// 管理 API 端点
const ADMIN_ENDPOINTS = {
  // 用户管理
  USERS: '/api/admin/users',
  USER_BY_ID: '/api/admin/users/:id',
  // 客户端管理
  CLIENTS: '/api/admin/clients',
  CLIENT_BY_ID: '/api/admin/clients/:id',
  // 角色权限管理
  ROLES: '/api/admin/roles',
  PERMISSIONS: '/api/admin/permissions'
} as const;
```

#### HTTP 状态码规范
```typescript
// 标准 HTTP 状态码使用
const HTTP_STATUS = {
  // 成功响应
  OK: 200,                    // 请求成功
  CREATED: 201,               // 资源创建成功
  NO_CONTENT: 204,            // 请求成功但无内容返回
  
  // 重定向
  FOUND: 302,                 // OAuth 授权重定向
  
  // 客户端错误
  BAD_REQUEST: 400,           // 请求参数错误
  UNAUTHORIZED: 401,          // 未授权
  FORBIDDEN: 403,             // 禁止访问
  NOT_FOUND: 404,             // 资源不存在
  METHOD_NOT_ALLOWED: 405,    // 方法不允许
  CONFLICT: 409,              // 资源冲突
  UNPROCESSABLE_ENTITY: 422,  // 数据验证失败
  TOO_MANY_REQUESTS: 429,     // 请求过于频繁
  
  // 服务器错误
  INTERNAL_SERVER_ERROR: 500, // 内部服务器错误
  SERVICE_UNAVAILABLE: 503    // 服务不可用
} as const;
```

#### 错误响应格式
```typescript
// 标准错误响应格式
interface ErrorResponse {
  error: string;              // 错误代码
  error_description?: string; // 错误描述
  error_uri?: string;         // 错误详情链接
  state?: string;             // OAuth 状态参数
}

// OAuth2.1 标准错误代码
const OAUTH_ERRORS = {
  INVALID_REQUEST: 'invalid_request',
  INVALID_CLIENT: 'invalid_client',
  INVALID_GRANT: 'invalid_grant',
  UNAUTHORIZED_CLIENT: 'unauthorized_client',
  UNSUPPORTED_GRANT_TYPE: 'unsupported_grant_type',
  INVALID_SCOPE: 'invalid_scope',
  ACCESS_DENIED: 'access_denied',
  UNSUPPORTED_RESPONSE_TYPE: 'unsupported_response_type',
  SERVER_ERROR: 'server_error',
  TEMPORARILY_UNAVAILABLE: 'temporarily_unavailable'
} as const;
```

### API 版本控制
```typescript
// API 版本控制策略
interface APIVersioning {
  strategy: 'header' | 'path' | 'query';
  currentVersion: string;
  supportedVersions: string[];
  deprecationPolicy: {
    noticeMonths: number;     // 弃用通知提前月数
    supportMonths: number;    // 弃用版本支持月数
  };
}

// 版本控制实现
const API_VERSIONING: APIVersioning = {
  strategy: 'header',
  currentVersion: 'v1',
  supportedVersions: ['v1'],
  deprecationPolicy: {
    noticeMonths: 6,
    supportMonths: 12
  }
};

// 请求头版本控制
// Accept: application/vnd.oauth-center.v1+json
// API-Version: v1
```

## 部署架构

### 容器化部署

#### Docker 配置
```dockerfile
# Dockerfile
FROM node:20-alpine AS base

# 安装依赖
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN corepack enable pnpm && pnpm install --frozen-lockfile

# 构建应用
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN corepack enable pnpm && pnpm build

# 生产镜像
FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000
ENV PORT=3000
CMD ["node", "server.js"]
```

#### Docker Compose 配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  oauth-center:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://oauth:password@postgres:5432/oauth_center
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=oauth_center
      - POSTGRES_USER=oauth
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U oauth"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  postgres_data:
```

### 生产环境部署

#### 环境配置
```bash
# .env.production
NODE_ENV=production
NEXT_TELEMETRY_DISABLED=1

# 数据库配置
DATABASE_URL="postgresql://oauth:${DB_PASSWORD}@${DB_HOST}:5432/oauth_center?schema=public"

# Redis 配置
REDIS_URL="redis://:${REDIS_PASSWORD}@${REDIS_HOST}:6379"

# JWT 配置
JWT_SECRET_KEY="${JWT_SECRET_KEY}"
JWT_ISSUER="https://oauth.company.com"
JWT_AUDIENCE="https://api.company.com"

# OAuth 配置
OAUTH_BASE_URL="https://oauth.company.com"
OAUTH_COOKIE_SECRET="${OAUTH_COOKIE_SECRET}"

# 安全配置
CSRF_SECRET="${CSRF_SECRET}"
SESSION_SECRET="${SESSION_SECRET}"

# 监控配置
SENTRY_DSN="${SENTRY_DSN}"
SENTRY_ORG="${SENTRY_ORG}"
SENTRY_PROJECT="${SENTRY_PROJECT}"
```

#### Kubernetes 部署
```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oauth-center
  namespace: oauth-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: oauth-center
  template:
    metadata:
      labels:
        app: oauth-center
    spec:
      containers:
      - name: oauth-center
        image: oauth-center:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: oauth-secrets
              key: database-url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
```

## API设计

### OAuth2.1端点

#### 1. 授权端点

```
GET /api/v2/oauth/authorize
```

**参数**:

- `response_type`: 固定为 "code"
- `client_id`: 客户端ID
- `redirect_uri`: 重定向URI
- `scope`: 请求的权限范围
- `state`: 防CSRF状态参数
- `code_challenge`: PKCE挑战码
- `code_challenge_method`: 固定为 "S256"

#### 2. 令牌端点

```
POST /api/v2/oauth/token
```

**授权码模式**:

```json
{
  "grant_type": "authorization_code",
  "code": "授权码",
  "redirect_uri": "重定向URI",
  "client_id": "客户端ID",
  "code_verifier": "PKCE验证码"
}
```

**客户端凭证模式**:

```json
{
  "grant_type": "client_credentials",
  "scope": "请求的权限范围"
}
```

**刷新令牌**:

```json
{
  "grant_type": "refresh_token",
  "refresh_token": "刷新令牌"
}
```

#### 3. 用户信息端点

```
GET /api/v2/oauth/userinfo
Authorization: Bearer {access_token}
```

#### 4. 令牌撤销端点

```
POST /api/v2/oauth/revoke
```

### OIDC发现端点

#### 1. 配置发现

```
GET /.well-known/openid-configuration
```

#### 2. 公钥端点

```
GET /.well-known/jwks.json
```

## 安全机制

### 1. PKCE (强制)

- 所有授权码流程必须使用PKCE
- 使用SHA256哈希算法
- 防止授权码拦截攻击

### 2. JWT安全

- 使用RS256算法签名
- 支持公钥验证
- 包含标准声明 (iss, aud, exp, iat, sub)

### 3. 客户端认证

- 机密客户端使用HTTP Basic认证
- 公开客户端仅验证client_id
- 支持客户端密钥轮换

### 4. 权限控制

- 基于RBAC模型
- 细粒度权限控制
- 支持资源级别权限

## 安全设计

### 密码安全

- BCrypt哈希存储
- 密码强度要求
- 密码历史记录
- 强制密码更新
- 账户锁定机制
- 登录尝试记录

### 令牌安全

- JWT使用RS256签名
- 访问令牌短期有效(15分钟)
- 刷新令牌长期有效(30天)
- 令牌撤销机制
- JTI黑名单管理
- 令牌轮换策略

### 传输安全

- 强制HTTPS
- HSTS头部
- 安全Cookie设置
- CSRF保护
- XSS防护

### 访问控制

- RBAC权限模型
- 最小权限原则
- 权限缓存机制
- IP白名单控制
- 客户端认证

## 缓存策略

### 权限缓存

- **内存缓存**: 用户权限信息缓存15分钟
- **Redis缓存**: 分布式环境下的权限共享
- **缓存失效**: 权限变更时主动清除

### 令牌缓存

- **黑名单缓存**: 撤销令牌的JTI缓存
- **客户端信息缓存**: OAuth客户端配置缓存

### 配置缓存

- **系统配置**: 启动时加载，变更时刷新
- **安全策略**: 内存缓存，定期同步

## 性能优化

### 数据库优化

- **索引策略**: 关键字段建立复合索引
- **查询优化**: 使用Prisma查询优化
- **连接池**: 数据库连接池管理

### API优化

- **响应压缩**: Gzip压缩
- **请求限流**: 基于IP和用户的限流
- **异步处理**: 非关键操作异步执行

### 前端优化

- **代码分割**: 路由级别的代码分割
- **静态资源**: CDN加速
- **缓存策略**: 浏览器缓存优化

## JWT认证授权使用说明

### JWT结构

#### Header

```json
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "key-id"
}
```

#### Payload (Access Token)

```json
{
  "iss": "https://auth.company.com",
  "aud": "api.company.com",
  "sub": "user-id",
  "client_id": "client-id",
  "scope": "openid profile read:users",
  "permissions": ["user:read", "user:write"],
  "iat": 1640995200,
  "exp": 1640998800,
  "jti": "token-id"
}
```

### 令牌验证流程

1. **获取公钥**: 从 `/.well-known/jwks.json` 获取
2. **验证签名**: 使用RS256算法验证
3. **检查声明**: 验证iss, aud, exp等
4. **权限检查**: 验证scope和permissions

### 使用示例

#### 1. 获取访问令牌

```javascript
// 授权码模式
const tokenResponse = await fetch('/api/v2/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    grant_type: 'authorization_code',
    code: authorizationCode,
    redirect_uri: redirectUri,
    client_id: clientId,
    code_verifier: codeVerifier,
  }),
});

const tokens = await tokenResponse.json();
```

#### 2. 使用访问令牌

```javascript
const apiResponse = await fetch('/api/v2/users', {
  headers: {
    Authorization: `Bearer ${tokens.access_token}`,
  },
});
```

#### 3. 刷新令牌

```javascript
const refreshResponse = await fetch('/api/v2/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: tokens.refresh_token,
  }),
});
```

## 管理页面设计

### 页面结构

```
管理控制台
├── 仪表板
│   ├── 系统概览
│   ├── 活跃用户统计
│   └── 令牌使用统计
├── 用户管理
│   ├── 用户列表
│   ├── 创建用户
│   ├── 编辑用户
│   └── 用户权限
├── 客户端管理
│   ├── 客户端列表
│   ├── 注册客户端
│   ├── 编辑客户端
│   └── 客户端密钥
├── 权限管理
│   ├── 角色管理
│   ├── 权限管理
│   └── 权限分配
├── 审计日志
│   ├── 登录日志
│   ├── 操作日志
│   └── 安全事件
└── 系统设置
    ├── 安全策略
    ├── 令牌配置
    └── 系统配置
```

### 页面权限设计

#### 权限矩阵

| 页面/功能  | 超级管理员 | 用户管理员 | 客户端管理员 | 审计员 | 普通用户 |
| ---------- | ---------- | ---------- | ------------ | ------ | -------- |
| 仪表板     | ✓          | ✓          | ✓            | ✓      | ✓        |
| 用户管理   | ✓          | ✓          | ✗            | ✗      | ✗        |
| 客户端管理 | ✓          | ✗          | ✓            | ✗      | ✗        |
| 权限管理   | ✓          | ✓          | ✗            | ✗      | ✗        |
| 审计日志   | ✓          | ✓          | ✓            | ✓      | ✗        |
| 系统设置   | ✓          | ✗          | ✗            | ✗      | ✗        |

#### 菜单权限配置

```typescript
const menuPermissions = {
  dashboard: ['admin:read', 'user:read'],
  userManagement: ['admin:users:read', 'admin:users:write'],
  clientManagement: ['admin:clients:read', 'admin:clients:write'],
  permissionManagement: ['admin:permissions:read', 'admin:permissions:write'],
  auditLogs: ['admin:audit:read'],
  systemSettings: ['admin:system:read', 'admin:system:write'],
};
```

## 权限体系设计

### RBAC模型

```
用户 (User) ←→ 用户角色 (UserRole) ←→ 角色 (Role)
                                        ↓
                                   角色权限 (RolePermission)
                                        ↓
                                   权限 (Permission)
```

### 预定义角色

1. **超级管理员 (super_admin)**

   - 系统最高权限
   - 可管理所有资源

2. **用户管理员 (user_admin)**

   - 用户和角色管理
   - 权限分配

3. **客户端管理员 (client_admin)**

   - OAuth客户端管理
   - 客户端配置

4. **审计员 (auditor)**

   - 查看审计日志
   - 生成合规报告

5. **普通用户 (user)**
   - 基本用户权限
   - 个人信息管理

### 权限命名规范

```
格式: {resource}:{action}

示例:
- user:read          # 读取用户信息
- user:write         # 修改用户信息
- client:read        # 读取客户端信息
- client:write       # 修改客户端信息
- admin:users:read   # 管理员读取用户
- admin:users:write  # 管理员修改用户
```

## 部署指南

### 环境要求

- Node.js 18+
- PostgreSQL 14+
- Redis (可选，用于会话存储)

### 环境变量

```bash
# 数据库
DATABASE_URL="postgresql://user:password@localhost:5432/oauth_db"

# JWT密钥
JWT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"

# 应用配置
NEXTAUTH_URL="https://auth.company.com"
NEXTAUTH_SECRET="your-secret-key"

# 安全配置
BCRYPT_ROUNDS=12
TOKEN_ISSUER="https://auth.company.com"
TOKEN_AUDIENCE="api.company.com"
```

### 部署步骤

1. **安装依赖**

```bash
npm install
```

2. **数据库迁移**

```bash
npx prisma migrate deploy
npx prisma db seed
```

3. **构建应用**

```bash
npm run build
```

4. **启动服务**

```bash
npm start
```

### 健康检查

```bash
# 检查服务状态
curl https://auth.company.com/api/v2/health

# 检查OIDC配置
curl https://auth.company.com/.well-known/openid-configuration

# 检查公钥端点
curl https://auth.company.com/.well-known/jwks.json
```

---

**文档维护**: 本文档应随系统更新而更新，确保与实际实现保持一致。
**联系方式**: 如有问题，请联系认证授权团队。
