# æ·±åº¦æ¶æ„æ­£ç¡®æ€§åˆ†ææŠ¥å‘Š
# OAuth 2.1 ç³»ç»Ÿæ¶æ„ï¼šæ ¹æœ¬é—®é¢˜è¯Šæ–­ä¸é‡æ–°è®¾è®¡å»ºè®®

**æŠ¥å‘Šæ—¥æœŸ**: 2025-11-28
**åˆ†æèŒƒå›´**: Pingora åå‘ä»£ç† + OAuth Service (Rust) + Admin Portal (Next.js 16)
**æŠ¥å‘Šçº§åˆ«**: æ·±åº¦æ¶æ„åˆ†æ (Strategic Architecture Review)

---

## æ‰§è¡Œæ‘˜è¦

æœ¬åˆ†æå¯¹å½“å‰ç³»ç»Ÿ"åˆ é™¤ä»£ç†å±‚ç›´æ¥è·¯ç”±"çš„å†³ç­–è¿›è¡Œäº†**æ‰¹åˆ¤æ€§å®¡è§†**ã€‚ç»è¿‡ç³»ç»Ÿçš„è°ƒæŸ¥å’Œåˆ†æï¼Œæˆ‘å‘ç°ï¼š

### æ ¸å¿ƒç»“è®º

**åˆ é™¤ä»£ç†å±‚è§£å†³çš„æ˜¯è¡¨é¢é—®é¢˜ï¼Œæ©ç›–äº†æ›´æ·±å±‚çš„è®¾è®¡ç¼ºé™·ã€‚** å½“å‰æ¶æ„å­˜åœ¨ä»¥ä¸‹æ ¹æœ¬æ€§é—®é¢˜ï¼š

1. **èŒè´£æ··æ·†** - Admin Portal æ—¢æ˜¯ OAuth å®¢æˆ·ç«¯ï¼Œåˆæ˜¯ UI æä¾›æ–¹ï¼Œè¿™ä¸¤ä¸ªè§’è‰²çš„æ··åˆå¯¼è‡´äº†è®¤è¯é€»è¾‘åˆ†æ•£
2. **HTTP ä»£ç†çš„æœ¬è´¨çŸ›ç›¾** - ç®€å•åœ°åˆ é™¤ä»£ç†å±‚é¿å…äº†æµå¼å“åº”é—®é¢˜ï¼Œä½†æœªè§£å†³ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†çš„æ ¹æœ¬åŸå› 
3. **OAuth å®ç°çš„éæ ‡å‡†æ€§** - Admin Portal ä¸åº”è¯¥æä¾›ç™»å½• UIï¼Œè¿™è¿åäº† OAuth 2.1 çš„è®¾è®¡åŸåˆ™
4. **Cookie ç®¡ç†çš„è„†å¼±æ€§** - å½“å‰ Cookie ç­–ç•¥ä¾èµ–äºæµè§ˆå™¨çš„è‡ªåŠ¨è¡Œä¸ºï¼Œå®¹æ˜“å› å°çš„é…ç½®å˜åŒ–è€Œå¤±æ•ˆ
5. **æ¶æ„ä¸€è‡´æ€§é—®é¢˜** - è®¤è¯ã€æˆæƒã€ä¼šè¯ç®¡ç†åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼Œæ— æ³•å½¢æˆç»Ÿä¸€çš„å®‰å…¨è¾¹ç•Œ

### å…³é”®æ•°æ®

```
é—®é¢˜ç»´åº¦                å½“å‰æ–¹æ¡ˆ         æ ‡å‡†åšæ³•          é£é™©ç­‰çº§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç™»å½• UI æä¾›è€…          Admin Portal      OAuth Service    ğŸ”´ é«˜
è®¤è¯é€»è¾‘æŒæ§è€…          OAuth Service     OAuth Service    âœ… æ­£ç¡®
ä¼šè¯ç®¡ç†è€…              OAuth Service     OAuth Service    âœ… æ­£ç¡®
Cookie ç®¡ç†             ä¾èµ–æµè§ˆå™¨è‡ªåŠ¨    æ˜¾å¼é…ç½®          ğŸŸ¡ ä¸­
ä»£ç†å±‚å¤„ç†              åˆ é™¤              ä¿ç•™(é€‚å½“è®¾è®¡)    ğŸŸ¡ ä¸­
```

---

## 1. Next.js 16 SSR æµå¼å“åº”çš„æœ¬è´¨é—®é¢˜

### 1.1 é—®é¢˜çš„è¡¨é¢ç°è±¡ vs æ ¹æœ¬åŸå› 

**è¡¨é¢é—®é¢˜**:
- Admin Portal çš„ `/api/v2/[...path]/route.ts` ä»£ç†è·¯ç”±äº§ç”Ÿ `Transfer-Encoding: chunked`
- Pingora æ¥æ”¶åˆ°æµå¼å“åº”åï¼Œç¼“å†²åŒºå¤„ç†å¤±è´¥
- æµè§ˆå™¨æ”¶åˆ° `net::ERR_EMPTY_RESPONSE`

**æ ¹æœ¬åŸå› ** (ä¸‰å±‚æ·±åº¦åˆ†æ):

#### ç¬¬ä¸€å±‚ï¼šNext.js çš„ SSR æ¨¡å‹é—®é¢˜

```typescript
// /api/v2/[...path]/route.ts (ç°å·²åˆ é™¤)
export async function POST(request: Request, { params }: Params) {
  const response = await fetch('http://localhost:3001/api/v2/...', {
    body: JSON.stringify(body),
    // ...
  });
  
  return response;  // âŒ é—®é¢˜æ‰€åœ¨
}
```

**é—®é¢˜åˆ†æ**:
- Next.js 16 çš„ App Router ä¸­ï¼ŒAPI è·¯ç”±é»˜è®¤ä½¿ç”¨ **streaming response**
- å½“ `Response` å¯¹è±¡è¢«è¿”å›æ—¶ï¼ŒNext.js ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ `body` stream
- å¦‚æœä¸Šæ¸¸æœåŠ¡å™¨è¿”å›æµå¼å“åº”ï¼ˆchunkedï¼‰ï¼ŒNext.js ä¼šä¼ é€’è¯¥æµç»™å®¢æˆ·ç«¯
- ä½† Next.js çš„æµå¼å“åº”å¤„ç†åœ¨æŸäº› Pingora ç‰ˆæœ¬ä¸­æ— æ³•æ­£ç¡®è§£æ

#### ç¬¬äºŒå±‚ï¼šHTTP ä¸­é—´ä»£ç†çš„åè®®é™·é˜±

```
æ ‡å‡† HTTP ä»£ç†çš„èŒè´£:

è¯·æ±‚æ–¹ â†’ [HTTP ä»£ç†] â†’ ä¸Šæ¸¸æœåŠ¡å™¨
         (ç¼“å†²æ•´ä¸ªå“åº”)

å½“ä»£ç†æ”¶åˆ°å“åº”æ—¶:
1. å¦‚æœä¸Šæ¸¸è¿”å› Content-Length: 1000
   â†’ ä»£ç†è¯»å– 1000 å­—èŠ‚
   â†’ è¿”å› Content-Length: 1000 ç»™å®¢æˆ·ç«¯ âœ…

2. å¦‚æœä¸Šæ¸¸è¿”å› Transfer-Encoding: chunked
   â†’ ä»£ç†éœ€è¦ç†è§£ chunked æ ¼å¼
   â†’ é‡æ–°ç»„è£…æˆ Content-Length æˆ– chunked âœ…
   
âŒ é—®é¢˜: Next.js API è·¯ç”±åœ¨è¿™é‡Œå¤±è´¥äº†
```

**ä¸ºä»€ä¹ˆ Next.js ä¼šäº§ç”Ÿæµå¼å“åº”?**

æ ¹æ® Next.js æ–‡æ¡£ï¼Œå½“ä»¥ä¸‹æƒ…å†µå‘ç”Ÿæ—¶ï¼š
1. ä¸Šæ¸¸è¿”å›çš„æ˜¯æµï¼ˆReadableStreamï¼‰
2. è¿”å›çš„å“åº”æ²¡æœ‰ Content-Length
3. Next.js æ£€æµ‹åˆ°æ— æ³•é¢„å…ˆçŸ¥é“å“åº”å¤§å°

â†’ Next.js è‡ªåŠ¨è½¬æ¢ä¸º chunked ç¼–ç 

```javascript
// è¿™ä¼šå¯¼è‡´æµå¼å“åº”
const response = await fetch(url);
return new Response(response.body);  // âŒ æµå¼è½¬å‘

// åº”è¯¥è¿™æ ·åšï¼ˆç¼“å†²æ•´ä¸ªå“åº”ï¼‰
const response = await fetch(url);
const buffer = await response.arrayBuffer();
return new Response(buffer, {
  headers: response.headers,
  status: response.status,
});  // âœ… è¿”å›å®Œæ•´å“åº”
```

#### ç¬¬ä¸‰å±‚ï¼šåå‘ä»£ç†è®¾è®¡é—®é¢˜

**Pingora çš„æµå¼å“åº”å¤„ç†**:
```rust
// /apps/pingora-proxy/src/proxy/mod.rs
pub async fn response_filter(
    &self,
    upstream_response: &mut ResponseHeader,
) -> Result<()> {
    let has_chunked = upstream_response
        .headers
        .get("transfer-encoding")
        .map(|v| v.to_str().unwrap_or("").to_lowercase().contains("chunked"))
        .unwrap_or(false);
    
    // âœ… Pingora çš„ response_filter æ­£ç¡®å¤„ç†äº† chunked
    // é—®é¢˜ä¸åœ¨ Pingora æœ¬èº«
    Ok(())
}
```

**çœŸå®é—®é¢˜**: 
- Pingora ä¼šæ­£ç¡®è½¬å‘ chunked å“åº”
- é—®é¢˜åœ¨äºæµè§ˆå™¨å¤„ç†ä¸äº†æŸç§ç‰¹å®šçš„æµå¼æ ¼å¼ç»„åˆ
- è¿™é€šå¸¸å‘ç”Ÿåœ¨ chunked ç¼–ç ä¸è§„èŒƒæˆ–å“åº”å¤´ä¸å®Œæ•´æ—¶

### 1.2 ä¸ºä»€ä¹ˆåˆ é™¤ä»£ç†å±‚ä¸æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

**å½“å‰åšæ³•**:
```
åˆ é™¤ /api/v2/[...path]/route.ts
æµè§ˆå™¨ç›´æ¥è®¿é—® Pingora â†’ OAuth Service
é¿å…äº† Next.js æµå¼å“åº”é—®é¢˜
```

**é—®é¢˜**:
1. **åªæ˜¯è½¬ç§»é—®é¢˜ï¼Œä¸æ˜¯è§£å†³é—®é¢˜**
   - å¦‚æœ OAuth Service æœ¬èº«è¿”å›æµå¼å“åº”å‘¢ï¼Ÿ
   - å¦‚æœå°†æ¥éœ€è¦åœ¨ä»£ç†å±‚åšä¸­é—´å¤„ç†ï¼ˆæ—¥å¿—ã€è®¤è¯æ£€æŸ¥ç­‰ï¼‰å‘¢ï¼Ÿ
   - è¿™ä¸ª"åˆ é™¤"æ–¹æ¡ˆæ— æ³•æ‰©å±•

2. **è¿åäº† HTTP ä¸­é—´ä»£ç†çš„è®¾è®¡åŸåˆ™**
   - åå‘ä»£ç†çš„å­˜åœ¨ä»·å€¼å°±æ˜¯åœ¨æœåŠ¡ä¹‹é—´åšä¸­é—´è½¬æ¢
   - ç®€å•åœ°åˆ é™¤ä»£ç†ç­‰äºæ”¾å¼ƒäº†è¿™ä¸ªèƒ½åŠ›
   - è¿™åœ¨å•ä½“åº”ç”¨å¯èƒ½è¿˜å¥½ï¼Œä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­æ˜¯åæ¨¡å¼

3. **æ— æ³•å¤„ç†çœŸå®çš„ç”Ÿäº§åœºæ™¯**
   - å¦‚æœéœ€è¦æ·»åŠ è¯·æ±‚ç­¾åã€é€Ÿç‡é™åˆ¶ã€è¯·æ±‚æ—¥å¿—ç­‰åŠŸèƒ½ï¼Œåœ¨å“ªé‡Œåšï¼Ÿ
   - å¦‚æœ OAuth Service é‡æ„ä¸ºä½¿ç”¨æµå¼å“åº”ï¼Œç³»ç»Ÿä¼šå†æ¬¡å´©æºƒ
   - æ²¡æœ‰ä¸­é—´å±‚çš„æ¶æ„åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯è„†å¼±çš„

### 1.3 æ ¹æœ¬çš„è§£å†³æ–¹æ¡ˆ

**åº”è¯¥åšçš„**:

#### æ–¹æ¡ˆ Aï¼šæ­£ç¡®å®ç° HTTP ä»£ç†ï¼ˆæ¨èï¼‰

```typescript
// /api/v2/[...path]/route.ts (æ­£ç¡®å®ç°)
export async function POST(request: Request, { params }: Params) {
  // 1. è¯»å–å®Œæ•´çš„è¯·æ±‚ä½“
  const body = await request.text();
  
  // 2. è½¬å‘è¯·æ±‚åˆ° OAuth Service
  const response = await fetch('http://localhost:3001/api/v2/...', {
    method: request.method,
    headers: {
      'Content-Type': request.headers.get('content-type') || 'application/json',
    },
    body: body,
  });
  
  // 3. è¯»å–å®Œæ•´å“åº”ï¼ˆä¸è¦æµå¼è½¬å‘ï¼‰
  const responseBody = await response.arrayBuffer();
  
  // 4. è¿”å›å®Œæ•´å“åº”ï¼ˆæ˜¾å¼è®¾ç½® Content-Lengthï¼‰
  return new Response(responseBody, {
    status: response.status,
    headers: {
      'Content-Type': response.headers.get('content-type') || 'application/json',
      'Content-Length': responseBody.byteLength.toString(),
      // è½¬å‘å…¶ä»–é‡è¦çš„ headerï¼ˆä½†ä¸è½¬å‘ Content-Encodingï¼‰
    },
  });
}
```

**è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜åŠ¿**:
- âœ… Next.js ä¸ä¼šäº§ç”Ÿæµå¼å“åº”
- âœ… ä¸­é—´å±‚å¯ä»¥è¿›è¡Œè¯·æ±‚/å“åº”æ£€æŸ¥ã€æ—¥å¿—è®°å½•ç­‰
- âœ… å…¼å®¹å„ç§åå‘ä»£ç†
- âœ… éµå¾ª HTTP ä»£ç†çš„æ ‡å‡†å®ç°æ¨¡å¼

#### æ–¹æ¡ˆ Bï¼šå¦‚æœåšæŒåˆ é™¤ä»£ç†å±‚

é‚£ä¹ˆéœ€è¦ç†è§£çš„æ˜¯ï¼Œè¿™ä¸æ˜¯"è§£å†³"é—®é¢˜ï¼Œè€Œæ˜¯"å›é¿"é—®é¢˜ï¼š

**ä¼˜ç‚¹**:
- å‡å°‘äº†ä¸€å±‚ç½‘ç»œè°ƒç”¨
- é™ä½äº†ç³»ç»Ÿå¤æ‚åº¦ï¼ˆçŸ­æœŸï¼‰

**ä»£ä»·**:
- å¤±å»äº†ä¸­é—´ä»£ç†çš„æ‰€æœ‰èƒ½åŠ›
- æ— æ³•æ·»åŠ æ—¥å¿—ã€ç›‘æ§ã€é€Ÿç‡é™åˆ¶ç­‰ä¸­é—´ä»¶
- æµè§ˆå™¨å’Œ OAuth Service ç›´æ¥è€¦åˆ
- éš¾ä»¥åº”å¯¹æœªæ¥çš„éœ€æ±‚å˜åŒ–

---

## 2. Pingora åå‘ä»£ç†çš„èƒ½åŠ›ä¸é—®é¢˜

### 2.1 Pingora å¯¹æµå¼å“åº”çš„å¤„ç†èƒ½åŠ›

**Pingora ç¡®å®èƒ½å¤„ç†æµå¼å“åº”**:

```rust
// Pingora çš„æ ‡å‡†æµå¼è½¬å‘æµç¨‹
pub async fn upstream_peer(&self, session: &mut Session) -> Result<Box<HttpPeer>> {
    // 1. å»ºç«‹ä¸ä¸Šæ¸¸çš„è¿æ¥
    // 2. è½¬å‘è¯·æ±‚å¤´
    // 3. Pingora è‡ªåŠ¨å¤„ç†å“åº”æµï¼ˆåŒ…æ‹¬ chunkedï¼‰
    // 4. å°†æ•°æ®è½¬å‘ç»™ä¸‹æ¸¸å®¢æˆ·ç«¯
    // â† chunked ç¼–ç è¢«è‡ªåŠ¨å¤„ç†
    Ok(Box::new(http_peer))
}

pub async fn response_filter(
    &self,
    upstream_response: &mut ResponseHeader,
) -> Result<()> {
    // âœ… æ­£ç¡®è¯†åˆ« chunked ç¼–ç 
    let has_chunked = upstream_response
        .headers
        .get("transfer-encoding")
        .map(|v| v.to_str().unwrap_or("").to_lowercase().contains("chunked"))
        .unwrap_or(false);
    
    if has_chunked {
        // Pingora ä¼šæ­£ç¡®è½¬å‘ chunked å“åº”
        // chunked æ•°æ®å— â†’ chunked æ•°æ®å—
    }
    Ok(())
}
```

**é—®é¢˜åˆ†æ**:

ä¸ºä»€ä¹ˆ Pingora æ¥æ”¶åˆ° Next.js äº§ç”Ÿçš„ chunked åä¼šå‡ºç°é”™è¯¯ï¼Ÿ

1. **æ—¶åºé—®é¢˜**: Next.js çš„ chunked ç¼–ç å¯èƒ½ä¸è§„èŒƒ
2. **å¤´éƒ¨ä¸åŒ¹é…**: æŸäº›å¤´éƒ¨ï¼ˆå¦‚ Content-Lengthï¼‰ä¸å®é™…æ•°æ®ä¸åŒ¹é…
3. **æµè§ˆå™¨å…¼å®¹æ€§**: æµè§ˆå™¨æ— æ³•è§£ææŸç§ç‰¹å®šçš„ chunked æ ¼å¼

### 2.2 Admin Portal ä½œä¸ºä¸­é—´ä»£ç†çš„é—®é¢˜

**å½“å‰æ¶æ„**:
```
æµè§ˆå™¨ â†’ Admin Portal (3002)
         â””â”€ /api/v2/* â†’ OAuth Service (3001)
         
é€šè¿‡ Pingora (6188):
æµè§ˆå™¨ â†’ Pingora (6188)
         â”œâ”€ /api/v2/* â†’ OAuth Service (3001) [å·²åˆ é™¤æ­¤å±‚]
         â””â”€ /* â†’ Admin Portal (3002)
```

**ä¸ºä»€ä¹ˆ Admin Portal ä¸åº”è¯¥æä¾›ä»£ç†**?

1. **å‰ç«¯ JS å’Œåç«¯ Rust çš„èƒ½åŠ›å·®å¼‚**:
   - Rust å¯ä»¥é«˜æ•ˆå¤„ç†å¤§é‡å¹¶å‘è¿æ¥å’Œæµå¼æ•°æ®
   - Next.js çš„ Node.js è¿è¡Œæ—¶æ˜¯å•çº¿ç¨‹ï¼Œå¤„ç†æµå¼å“åº”æ—¶å®¹æ˜“å‡ºç°ç“¶é¢ˆ

2. **æµå¼æ•°æ®å¤„ç†**:
   ```
   Rust (Tokio async):        Next.js (å•çº¿ç¨‹):
   - 100 ä¸ªå¹¶å‘æµ âœ…         - 10 ä¸ªå¹¶å‘æµå¼€å§‹å‡ºç°é—®é¢˜
   - 1GB å“åº”   âœ…           - å¤§å“åº”å®¹æ˜“å¯¼è‡´è¶…æ—¶
   ```

3. **è´£ä»»æ··æ·†**:
   - Admin Portal æœ¬è´¨ä¸Šæ˜¯ç®¡ç†åº”ç”¨ + OAuth å®¢æˆ·ç«¯
   - ä»£ç†é€»è¾‘å±äº**åŸºç¡€è®¾æ–½å±‚**ï¼Œä¸åº”è¯¥åœ¨åº”ç”¨å±‚å®ç°

---

## 3. OAuth å®¢æˆ·ç«¯åº”ç”¨çš„å®šä½çŸ›ç›¾

### 3.1 å½“å‰è®¾è®¡ï¼šAdmin Portal çš„æ··åˆè§’è‰²

**Admin Portal åœ¨å½“å‰ç³»ç»Ÿä¸­çš„è§’è‰²**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Admin Portal (Next.js 16)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§’è‰² 1: ç®¡ç†åº”ç”¨                        â”‚
â”‚ - ç”¨æˆ·ç®¡ç† UI                           â”‚
â”‚ - è§’è‰²ç®¡ç† UI                           â”‚
â”‚ - æƒé™ç®¡ç† UI                           â”‚
â”‚ - è°ƒç”¨ /api/v2/users API                â”‚
â”‚                                         â”‚
â”‚ è§’è‰² 2: OAuth 2.1 æ ‡å‡†å®¢æˆ·ç«¯             â”‚
â”‚ - ç”Ÿæˆ PKCE å‚æ•°                        â”‚
â”‚ - å‘èµ· /api/v2/oauth/authorize          â”‚
â”‚ - äº¤æ¢ authorization code è·å– token    â”‚
â”‚                                         â”‚
â”‚ è§’è‰² 3: UI æä¾›æ–¹ï¼ˆéæ ‡å‡†ï¼‰              â”‚
â”‚ - æä¾›ç™»å½•é¡µé¢ HTML                     â”‚
â”‚ - å¤„ç† POST /api/v2/auth/login          â”‚
â”‚ - æä¾›åŒæ„é¡µé¢ HTML                     â”‚
â”‚ - å¤„ç† POST /api/v2/oauth/consent       â”‚
â”‚                                         â”‚
â”‚ è§’è‰² 4: åº”ç”¨å±‚ä»£ç†ï¼ˆå·²åˆ é™¤ï¼Œä½†æ›¾å­˜åœ¨ï¼‰   â”‚
â”‚ - /api/v2/* ä»£ç†åˆ° OAuth Service       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿™ç§æ··åˆè®¾è®¡å¸¦æ¥çš„é—®é¢˜**:

1. **è®¤è¯é€»è¾‘åˆ†æ•£**:
   ```
   ç™»å½•æµç¨‹ï¼š
   1. æµè§ˆå™¨ â†’ Admin Portal (æ˜¾ç¤ºç™»å½•è¡¨å•)  [ç¬¬ä¸€æ¬¡å¤„ç†]
   2. æµè§ˆå™¨ â†’ OAuth Service (éªŒè¯å‡­è¯)     [ç¬¬äºŒæ¬¡å¤„ç†]
   3. æµè§ˆå™¨ â†’ Admin Portal (æ˜¾ç¤ºåŒæ„è¡¨å•)  [ç¬¬ä¸‰æ¬¡å¤„ç†]
   4. æµè§ˆå™¨ â†’ OAuth Service (ç­¾å‘ token)   [ç¬¬å››æ¬¡å¤„ç†]
   
   è°è´Ÿè´£å®‰å…¨? è°æ£€æŸ¥ CSRF? è°ç®¡ç†ä¼šè¯?
   â†’ è´£ä»»ä¸æ¸…æ¥š
   ```

2. **Cookie ç®¡ç†çš„é—®é¢˜**:
   ```
   session_token Cookie ç”± OAuth Service ç­¾å‘
   ä½† Admin Portal ä¹Ÿéœ€è¦è¯»å–è¿™ä¸ª Cookieï¼ˆç”¨äºæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
   
   å¦‚æœ Cookie domain é…ç½®é”™è¯¯:
   - OAuth Service (3001) è®¾ç½®çš„ Cookie å¯èƒ½æ— æ³•è¢« Admin Portal (3002) ä½¿ç”¨
   - Admin Portal çš„ä»£ç†å±‚éœ€è¦æ‰‹åŠ¨è½¬å‘ Cookie
   - åˆ é™¤ä»£ç†å±‚åï¼ŒAdmin Portal æ— æ³•è®¿é—® OAuth Service è®¾ç½®çš„ Cookie âŒ
   ```

3. **æ— æ³•æ¸…æ™°åœ°åˆ†ç¦»å®‰å…¨è¾¹ç•Œ**:
   ```
   å“ªäº›æ“ä½œå¿…é¡»æœ‰ session_token?
   - POST /api/v2/auth/login - ä¸éœ€è¦ï¼ˆç™»å½•ç«¯ç‚¹ï¼‰
   - POST /api/v2/oauth/authorize - éœ€è¦ï¼ˆå·²è®¤è¯ç”¨æˆ·ï¼‰
   - GET /api/v2/users - éœ€è¦ï¼ˆç®¡ç† APIï¼‰
   
   Admin Portal ä¸çŸ¥é“è¿™äº›è§„åˆ™ï¼Œå®ƒåªæ˜¯ä»£ç†
   OAuth Service å¿…é¡»æ£€æŸ¥æ¯ä¸ªç«¯ç‚¹
   â†’ åˆ†å¸ƒå¼çš„æƒé™æ£€æŸ¥ï¼Œéš¾ä»¥ç»´æŠ¤
   ```

### 3.2 æ ‡å‡† OAuth 2.1 çš„è®¾è®¡æ–¹å¼

**æ ‡å‡†å®ç°ä¸­ï¼Œåªæœ‰ Authorization Server æä¾› UI**:

```
æ ‡å‡† OAuth 2.1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Authorization Server (OAuth Service) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç”¨æˆ·æ•°æ®ç®¡ç†                           â”‚
â”‚ â€¢ å‡­è¯éªŒè¯ï¼ˆbcrypt ç­‰ï¼‰                  â”‚
â”‚ â€¢ ä¼šè¯ç®¡ç†                               â”‚
â”‚ â€¢ ç™»å½•é¡µé¢ HTML â† Authorization Server   â”‚
â”‚ â€¢ åŒæ„é¡µé¢ HTML â† Authorization Server   â”‚
â”‚ â€¢ Token ç­¾å‘                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                    â†“
        â”‚                    â”‚
   ç”¨æˆ·å‡­è¯             Authorization Code

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Client Application             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç®¡ç† UI                                â”‚
â”‚ â€¢ å¤„ç† Authorization Code callback       â”‚
â”‚ â€¢ æ˜¾ç¤ºå—ä¿æŠ¤èµ„æº                         â”‚
â”‚ â€¢ ä¸æä¾›ä»»ä½•è®¤è¯ç›¸å…³çš„ UI                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ¬ç³»ç»Ÿçš„éæ ‡å‡†è®¾è®¡**:
```
å½“å‰ç³»ç»Ÿ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OAuth Service (oauth-service-rust) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… å‡­è¯éªŒè¯                           â”‚
â”‚ âœ… ä¼šè¯ç®¡ç†                           â”‚
â”‚ âœ… Token ç­¾å‘                         â”‚
â”‚ âŒ ç™»å½•é¡µé¢ HTML (åœ¨ Admin Portal)    â”‚
â”‚ âŒ åŒæ„é¡µé¢ HTML (åœ¨ Admin Portal)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Admin Portal (Next.js)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… ç®¡ç† UI                            â”‚
â”‚ âœ… å¤„ç† callback                      â”‚
â”‚ âŒ æä¾›ç™»å½•é¡µé¢ (åº”è¯¥åœ¨ OAuth Service)|
â”‚ âŒ æä¾›åŒæ„é¡µé¢ (åº”è¯¥åœ¨ OAuth Service)|
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ä¸ºä»€ä¹ˆå‰ç«¯åœ¨ OAuth Service ä¸­æä¾› UI ä¼šå¸¦æ¥é—®é¢˜

**å¸¸è§çš„ç†ç”±**ï¼ˆä¸ºä»€ä¹ˆæœ‰äº›ç³»ç»Ÿè¿™æ ·è®¾è®¡ï¼‰:

1. "Next.js çš„å‰ç«¯å¼€å‘æ›´å¿«"
   - ä½†è¿™ä¼šå¯¼è‡´è®¤è¯é€»è¾‘åˆ†æ•£
   - å®‰å…¨ä¸åº”è¯¥ä¸ºäº†å¼€å‘é€Ÿåº¦è€Œå¦¥å

2. "Admin Portal éœ€è¦å®šåˆ¶ UI"
   - å¯ä»¥ï¼Œä½†å®šåˆ¶åº”è¯¥åœ¨ OAuth Service ä¸­åšï¼ˆå¯ä»¥æ”¯æŒå¤šä¸ªä¸»é¢˜ï¼‰
   - ä¸åº”è¯¥å®Œå…¨å°† UI è½¬ç§»åˆ°å¦ä¸€ä¸ªåº”ç”¨

3. "ä»£ç å¤ç”¨"
   - Rust ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ HTML æ¨¡æ¿å¼•æ“ï¼ˆaskama, sailfish ç­‰ï¼‰
   - ä¸éœ€è¦ä¾èµ– Next.js

**çœŸå®çš„ä»£ä»·**:

```
éšè—æˆæœ¬ï¼š
â”œâ”€ ç»´æŠ¤ä¸¤ä¸ªè®¤è¯ UI (HTML + Next.js ç»„ä»¶)
â”œâ”€ Cookie è·¨åº”ç”¨åŒæ­¥é—®é¢˜
â”œâ”€ CSRF ä»¤ç‰Œç®¡ç†åˆ†æ•£
â”œâ”€ ä¼šè¯è¶…æ—¶å¤„ç†ä¸ä¸€è‡´
â”œâ”€ å®¡è®¡æ—¥å¿—è®°å½•ä¸å®Œæ•´
â”œâ”€ å®‰å…¨æ›´æ–°éš¾ä»¥æ¨é€
â”œâ”€ æ–°å¼€å‘è€…éœ€è¦ç†è§£ä¸¤ä¸ªç³»ç»Ÿçš„äº¤äº’
â””â”€ æµ‹è¯•è¦†ç›–å¢åŠ å¤æ‚åº¦
```

---

## 4. HTTP ä»£ç†çš„æ ¹æœ¬åŸç†ä¸å¤±è´¥æ¨¡å¼

### 4.1 ä»€ä¹ˆæ—¶å€™ä»£ç†æ˜¯å®‰å…¨çš„

**ä»£ç†å¯ä»¥å®‰å…¨å¤„ç†çš„æƒ…å†µ**:

1. **å°å‹ã€ç»“æ„åŒ–çš„è¯·æ±‚/å“åº”**:
   ```
   POST /api/v2/auth/login
   Content-Type: application/json
   Content-Length: 150
   
   {"username":"admin","password":"xxx","redirect":"..."}
   
   â†“ [ä»£ç†ç¼“å†²æ•´ä¸ªè¯·æ±‚]
   
   Response:
   Content-Type: application/json
   Content-Length: 245
   
   {"success":true,"redirect_url":"...","session_token":"..."}
   ```
   âœ… ä»£ç†å¯ä»¥å®Œå…¨ç¼“å†²è¿™ä¸ªäº¤äº’

2. **æœ‰æ˜ç¡® Content-Length çš„å“åº”**:
   ```
   HTTP/1.1 200 OK
   Content-Type: application/json
   Content-Length: 1000  â† æ˜ç¡®çš„é•¿åº¦
   
   [1000 å­—èŠ‚çš„ JSON æ•°æ®]
   ```
   âœ… ä»£ç†çŸ¥é“ä½•æ—¶åœæ­¢è¯»å–

### 4.2 ä»£ç†å¤±è´¥çš„æƒ…å†µ

**å¤±è´¥åœºæ™¯ 1: æµå¼å“åº”ï¼ˆæ—  Content-Lengthï¼‰**

```
HTTP/1.1 200 OK
Content-Type: text/event-stream
Transfer-Encoding: chunked  â† æ— æ³•é¢„çŸ¥å¤§å°
Connection: keep-alive

5\r\n          â† chunk size
hello\r\n      â† chunk data
4\r\n
 SSE\r\n
0\r\n          â† end chunk
\r\n
```

**é—®é¢˜**:
- ä»£ç†å¿…é¡»ç†è§£ chunked ç¼–ç 
- ä»£ç†å¿…é¡»äº†è§£ä½•æ—¶å“åº”ç»“æŸ
- æŸäº›ä¸æ­£ç¡®çš„ chunked ç¼–ç ä¼šå¯¼è‡´ä»£ç†å¡ä½

**å¤±è´¥åœºæ™¯ 2: æŸäº›ä»£ç†ä¸æ”¯æŒ chunked**

```
æŸäº› HTTP 1.0 ä»£ç†æˆ–æ—§ç‰ˆä»£ç†:
- ä¸ç†è§£ Transfer-Encoding: chunked
- ä¼šç­‰å¾… Content-Lengthï¼ˆæ°¸è¿œä¸ä¼šæ¥ï¼‰
- æœ€ç»ˆè¶…æ—¶æˆ–è¿”å›é”™è¯¯
```

**å¤±è´¥åœºæ™¯ 3: åŒä»£ç†å †å **

```
æµè§ˆå™¨ â†’ Pingora â†’ Admin Portal â†’ OAuth Service

å½“ OAuth Service è¿”å› chunked æ—¶:
1. OAuth Service: Transfer-Encoding: chunked
2. Admin Portal: ä¸èƒ½å¤„ç† chunked (Next.js API è·¯ç”±é—®é¢˜)
   â†’ äº§ç”Ÿé¢å¤–çš„ chunked (åŒé‡åŒ…è£…)
   â†’ Transfer-Encoding: chunked, chunked âŒ
3. Pingora: æ”¶åˆ°ç•¸å½¢çš„ chunked ç¼–ç 
   â†’ è§£æå¤±è´¥ â†’ è¿”å› 502/504

è¿™æ­£æ˜¯å½“å‰ç³»ç»Ÿé‡åˆ°çš„é—®é¢˜ï¼
```

### 4.3 ä¸ºä»€ä¹ˆæŸäº›ä»£ç†èƒ½å¤„ç†ï¼ŒæŸäº›ä¸èƒ½

**èƒ½å¤„ç†çš„ä»£ç†** (å¦‚ Nginx, HAProxy, Pingora):
- å®Œå…¨ç†è§£ HTTP åè®®ç»†èŠ‚
- å®ç°äº†å®Œæ•´çš„ chunked ç¼–ç å¤„ç†
- æœ‰é”™è¯¯æ¢å¤æœºåˆ¶

**ä¸èƒ½å¤„ç†çš„ä»£ç†** (å¦‚ Next.js API è·¯ç”±):
- è®¾è®¡ç”¨äºåº”ç”¨é€»è¾‘ï¼Œä¸æ˜¯ç½‘ç»œåŸºç¡€è®¾æ–½
- å¯¹ HTTP ç»†èŠ‚çš„å¤„ç†ä¸å¤Ÿæ·±å…¥
- æŸäº›è¾¹ç•Œæƒ…å†µæ²¡æœ‰è€ƒè™‘

**HTTP ä»£ç†çš„é»„é‡‘è§„åˆ™**:
```
ä»£ç†çš„é¦–è¦èŒè´£æ˜¯ï¼š
1. âœ… è½¬å‘è¯·æ±‚å¤´ï¼ˆåŒ…å«å…³é”®ä¿¡æ¯ï¼‰
2. âœ… è½¬å‘è¯·æ±‚ä½“ï¼ˆå¯èƒ½æ˜¯æµå¼ï¼‰
3. âœ… è½¬å‘å“åº”å¤´ï¼ˆåŒ…å«å†…å®¹ç±»å‹ã€é•¿åº¦ç­‰ï¼‰
4. âœ… è½¬å‘å“åº”ä½“ï¼ˆå¯èƒ½æ˜¯æµå¼ï¼‰
5. âœ… å¤„ç†é”™è¯¯æƒ…å†µï¼ˆæ–­å¼€ã€è¶…æ—¶ã€ç•¸å½¢æ•°æ®ï¼‰

è¿åé»„é‡‘è§„åˆ™çš„åœ°æ–¹ï¼š
âŒ Next.js API è·¯ç”±è¯•å›¾è½¬å‘æµå¼å“åº”
   ä½†æ²¡æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæµå¼ç¼“å†²èƒ½åŠ›
```

---

## 5. å½“å‰æ¶æ„çš„ä¸€è‡´æ€§é—®é¢˜

### 5.1 Cookie ç®¡ç†çš„è„†å¼±æ€§

**å½“å‰ Cookie ç®¡ç†æ–¹å¼**:

```
OAuth Service ä»£ç  (src/routes/oauth.rs:185-191):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let session_cookie = Cookie::build(("session_token", token))
    // âŒ åŸæœ¬æœ‰ .domain("localhost")ï¼Œç°åœ¨åˆ é™¤äº†
    .path("/")
    .http_only(true)
    .secure(is_production)
    .same_site(SameSite::Lax);

return (updated_jar, Json(response));
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšå¯è¡Œ**ï¼ˆä¸´æ—¶åœ°ï¼‰:

1. **æµè§ˆå™¨çš„ Cookie è‡ªåŠ¨åŒ¹é…è§„åˆ™**:
   ```
   Set-Cookie: session_token=xxx; Path=/; SameSite=Lax
   (æ— æ˜¾å¼ Domain)
   
   è¯·æ±‚æ¥è‡ª: http://localhost:6188
   æµè§ˆå™¨è‡ªåŠ¨å°† Domain æ¨æ–­ä¸º: .localhost
   åç»­è¯·æ±‚: http://localhost:6188/* â†’ è‡ªåŠ¨æºå¸¦ Cookie âœ…
   ```

2. **ä¸ºä»€ä¹ˆè¿™æ˜¯è„†å¼±çš„**:
   ```
   å¦‚æœæ”¹å˜ï¼š
   a. ä» localhost:6188 æ”¹ä¸º example.com:6188
      â†’ Domain è‡ªåŠ¨æ¨æ–­ä¸º .example.com
      â†’ ä»ç„¶å¯ç”¨ âœ…
      
   b. ä» HTTP æ”¹ä¸º HTTPS
      â†’ Secure æ ‡å¿—å¯ç”¨
      â†’ Cookie åªé€šè¿‡ HTTPS å‘é€ âœ…
      
   c. æ”¹å˜ SameSite ç­–ç•¥
      â†’ å¯èƒ½æ— æ³•è·¨ç«™ç‚¹ä½¿ç”¨ âŒ
      
   d. å¦‚æœ Pingora æ”¹å˜ Host å¤´çš„è½¬å‘æ–¹å¼
      â†’ Cookie domain æ¨æ–­å¤±è´¥ âŒ
      
   e. å¦‚æœ Admin Portal (3002) ç›´æ¥è¢«è®¿é—®
      â†’ Cookie ä¸åŒ¹é… (domain: localhost vs host: localhost:3002)
      â†’ ç™»å½•å¤±è´¥ âŒ
   ```

**æ ‡å‡†åšæ³•**åº”è¯¥æ˜¯:

```rust
// âœ… æ›´å®‰å…¨çš„åšæ³•
let session_cookie = Cookie::build(("session_token", token))
    .domain(env::var("COOKIE_DOMAIN").unwrap_or(".localhost")) // æ˜¾å¼æŒ‡å®š
    .path("/")
    .http_only(true)
    .secure(is_production)
    .same_site(SameSite::Strict);  // æ›´å®‰å…¨çš„ CSRF é˜²æŠ¤

// .env é…ç½®
COOKIE_DOMAIN=.localhost        # å¼€å‘ç¯å¢ƒ
COOKIE_DOMAIN=.example.com      # ç”Ÿäº§ç¯å¢ƒ
```

### 5.2 è®¤è¯æµç¨‹çš„åˆ†æ•£é—®é¢˜

**å½“å‰è®¤è¯æµç¨‹ä¸­çš„è´£ä»»åˆ†å¸ƒ**:

```
Step 1: Admin Portal æ˜¾ç¤ºç™»å½•è¡¨å•
        â””â”€ è´Ÿè´£: Admin Portal
        â””â”€ ä»£ç : components/auth/username-password-form.tsx
        â””â”€ åŠŸèƒ½: æ”¶é›† username + password

Step 2: æäº¤åˆ° OAuth Service
        â””â”€ è´Ÿè´£: Admin Portal (å‘èµ·è¯·æ±‚)
        â””â”€ è·¯ç”±: POST /api/v2/auth/login
        â””â”€ é€šè¿‡: Pingora (6188) â†’ OAuth Service (3001)

Step 3: OAuth Service éªŒè¯å‡­è¯
        â””â”€ è´Ÿè´£: OAuth Service
        â””â”€ ä»£ç : services/user_service.rs
        â””â”€ åŠŸèƒ½: bcrypt éªŒè¯ã€æƒé™åŠ è½½

Step 4: è®¾ç½® session_token Cookie
        â””â”€ è´Ÿè´£: OAuth Service
        â””â”€ ä»£ç : routes/oauth.rs:185-191
        â””â”€ åŠŸèƒ½: HttpOnly Cookieï¼Œ1å°æ—¶è¿‡æœŸ

Step 5: è¿”å›é‡å®šå‘ URL
        â””â”€ è´Ÿè´£: OAuth Service
        â””â”€ ä»£ç : routes/oauth.rs:200-262
        â””â”€ åŠŸèƒ½: æ„å»ºæŒ‡å‘ Admin Portal åŒæ„é¡µé¢çš„ URL

Step 6: Admin Portal æ˜¾ç¤ºåŒæ„è¡¨å•
        â””â”€ è´Ÿè´£: Admin Portal
        â””â”€ è·¯ç”±: /oauth/consent?...
        â””â”€ åŠŸèƒ½: æ˜¾ç¤º OAuth æˆæƒè¯·æ±‚è¯¦æƒ…

Step 7: ç”¨æˆ·ç‚¹å‡»"å…è®¸"
        â””â”€ è´Ÿè´£: Admin Portal
        â””â”€ è¯·æ±‚: POST /api/v2/oauth/consent
        â””â”€ ç›®æ ‡: OAuth Service

Step 8: OAuth Service ç­¾å‘ Authorization Code
        â””â”€ è´Ÿè´£: OAuth Service
        â””â”€ ä»£ç : services/auth_code_service.rs
        â””â”€ åŠŸèƒ½: ç”Ÿæˆ auth_codeï¼Œ15åˆ†é’Ÿæœ‰æ•ˆæœŸ

Step 9: Admin Portal äº¤æ¢ Code è·å– Token
        â””â”€ è´Ÿè´£: Admin Portal
        â””â”€ åº“: @repo/ui authService.handleCallback()
        â””â”€ ç›®æ ‡: POST /api/v2/oauth/token

Step 10: OAuth Service ç­¾å‘ Access Token
        â””â”€ è´Ÿè´£: OAuth Service
        â””â”€ ä»£ç : services/token_service.rs
        â””â”€ åŠŸèƒ½: JWT tokenï¼Œ1å°æ—¶æœ‰æ•ˆæœŸ
```

**é—®é¢˜åˆ†æ**:

1. **è°ä¸ºå®‰å…¨è´Ÿè´£**?
   - OAuth Service éªŒè¯å‡­è¯ âœ…
   - ä½† Admin Portal çš„è¡¨å•éªŒè¯å‘¢ï¼Ÿ
   - Admin Portal æ²¡æœ‰éªŒè¯ username/password çš„æ ¼å¼
   - ä¸‡ä¸€æœ‰äººç›´æ¥å‘ OAuth Service å‘é€æ¶æ„è¯·æ±‚å‘¢ï¼Ÿ

2. **è°ç®¡ç†ä¼šè¯**?
   - OAuth Service è®¾ç½® session_token Cookie âœ…
   - Admin Portal çš„ä»£ç ä¸­ä¹Ÿä¼šä½¿ç”¨è¿™ä¸ª Cookie
   - å¦‚æœä¸¤ä¸ªåº”ç”¨å¯¹ä¼šè¯çš„ç†è§£ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ

3. **CSRF é˜²æŠ¤åˆ†æ•£**:
   - OAuth çš„ state å‚æ•° âœ… (OAuth Service è´Ÿè´£)
   - ä½† POST /api/v2/auth/login æœ‰ CSRF ä»¤ç‰Œå—ï¼Ÿ
   - Admin Portal è¡¨å•ä¸­æœ‰éšè—çš„ CSRF ä»¤ç‰Œå—ï¼Ÿ
   - ç­”æ¡ˆæ˜¯æ²¡æœ‰ï¼Œä¾èµ–äº SameSite=Lax Cookie

4. **å®¡è®¡æ—¥å¿—çš„å®Œæ•´æ€§**:
   - Admin Portal ä¸è®°å½•è°å°è¯•ç™»å½•
   - åªæœ‰ OAuth Service è®°å½•äº†éªŒè¯äº‹ä»¶
   - å¦‚æœæœ‰å®‰å…¨äº‹ä»¶ï¼Œæ— æ³•å®Œæ•´è¿½è¸ª

### 5.3 æ€§èƒ½ä¸å¯é æ€§çš„æƒè¡¡

**å½“å‰æ¶æ„ï¼ˆåˆ é™¤ä»£ç†å±‚åï¼‰çš„æƒè¡¡**:

```
Pingora (6188)
â”œâ”€ /api/v2/* â†’ OAuth Service (3001) [ç›´æ¥è·¯ç”±]
â”‚              â””â”€ æ— æ³•æ·»åŠ ä¸­é—´ä»¶ï¼ˆæ—¥å¿—ã€ç›‘æ§ã€é™æµç­‰ï¼‰
â”‚              â”” æ— æ³•åšè¯·æ±‚è½¬æ¢ï¼ˆæ·»åŠ å¤´ã€ç­¾åç­‰ï¼‰
â”‚              â”” æ— æ³•åšå“åº”è½¬æ¢ï¼ˆå‹ç¼©ã€ç¼“å­˜ç­‰ï¼‰
â”‚
â””â”€ /* â†’ Admin Portal (3002)
         â””â”€ è‡ªå·±å¤„ç† API è°ƒç”¨ï¼ˆuseQuery, fetchï¼‰
         â””â”€ ä¸ç»è¿‡ Pingoraï¼ˆé‡å¤çš„ç½‘ç»œè°ƒç”¨ï¼‰
```

**éšè—çš„æ€§èƒ½é—®é¢˜**:

```
åœºæ™¯ï¼šAdmin Portal éœ€è¦è°ƒç”¨ /api/v2/users

å½“å‰åšæ³•ï¼ˆåˆ é™¤ä»£ç†å±‚åï¼‰ï¼š
æµè§ˆå™¨ â†’ Pingora (6188) â†’ Admin Portal (3002)
                          â””â†’ fetch() â†’ Pingora (6188)? è¿˜æ˜¯ OAuth Service (3001)?
                          
å¦‚æœæ˜¯å‰è€…ï¼ˆé€šè¿‡ Pingoraï¼‰ï¼š
æµè§ˆå™¨ â†’ Pingora â†’ Admin Portal â†’ fetch() â†’ ... ?
(å¾ªç¯å¼•ç”¨ï¼Œæ— æ³•å·¥ä½œ)

å¦‚æœæ˜¯åè€…ï¼ˆç›´æ¥è®¿é—® OAuth Serviceï¼‰ï¼š
æµè§ˆå™¨ â†’ Admin Portal
         â””â†’ fetch(http://localhost:3001/api/v2/users)
            [ç»•è¿‡ Pingora]
            [å¿…é¡»é…ç½® CORS]
            [æµè§ˆå™¨ç›´æ¥æš´éœ²å†…éƒ¨åœ°å€ localhost:3001 âŒ]
```

---

## 6. é‡æ–°è®¾è®¡çš„å»ºè®®æ¶æ„

### 6.1 é—®é¢˜çš„æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

**ä¸åº”è¯¥åšä»€ä¹ˆ**:
- âŒ åˆ é™¤ HTTP ä»£ç†å±‚ï¼ˆç°åœ¨çš„åšæ³•ï¼‰
- âŒ åœ¨ Next.js ä¸­å®ç°å®Œæ•´çš„ HTTP ä»£ç†
- âŒ ç»§ç»­è®© Admin Portal æä¾›è®¤è¯ UI

**åº”è¯¥åšä»€ä¹ˆ**:

#### æ–¹æ¡ˆ 1ï¼šæ ‡å‡†åŒ– OAuth æ¶æ„ï¼ˆæ¨èï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æµè§ˆå™¨                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Pingora (6188)         â”‚
        â”‚  - åå‘ä»£ç†             â”‚
        â”‚  - è´Ÿè½½å‡è¡¡             â”‚
        â”‚  - è·¯ç”±                 â”‚
        â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
           â”‚                  â”‚
    /api/v2/*          /auth/*, /, /*
           â”‚                  â”‚
           â–¼                  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  OAuth Service   â”‚  â”‚  Admin Portal    â”‚
  â”‚  (Rust/Axum)     â”‚  â”‚  (Next.js 16)    â”‚
  â”‚  :3001           â”‚  â”‚  :3002           â”‚
  â”‚                  â”‚  â”‚                  â”‚
  â”‚ âœ… ç™»å½• HTML     â”‚  â”‚ âœ… ç®¡ç† UI       â”‚
  â”‚ âœ… ç™»å½•å¤„ç†      â”‚  â”‚ âœ… OAuth Client  â”‚
  â”‚ âœ… åŒæ„ HTML     â”‚  â”‚ âœ… API è°ƒç”¨      â”‚
  â”‚ âœ… åŒæ„å¤„ç†      â”‚  â”‚ âŒ ä»£ç†é€»è¾‘      â”‚
  â”‚ âœ… Token ç­¾å‘    â”‚  â”‚                  â”‚
  â”‚ âœ… æƒé™æ£€æŸ¥      â”‚  â”‚                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                      â”‚
           â”‚ (JSON API)           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  PostgreSQL DB   â”‚
             â”‚  (Supabase)      â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ”¹å˜**:

1. **ç™»å½• UI ç§»åˆ° OAuth Service**
   ```
   åŸæ¥: Admin Portal æä¾› /login é¡µé¢
        â†’ Pingora (6188) â†’ Admin Portal (3002) â†’ /login.tsx
        
   æ–°æ–¹æ¡ˆ: OAuth Service æä¾›ç™»å½•é¡µé¢
         â†’ Pingora (6188) â†’ OAuth Service (3001) â†’ /login.html
   ```

2. **ä¿ç•™ HTTP ä»£ç†å±‚ï¼ˆåœ¨ Pingora ä¸­ï¼‰**
   ```
   Pingora é…ç½®:
   
   routes:
     - path_prefix: '/api/v2/'
       backend: 'oauth-service'
       # å¯ä»¥æ·»åŠ ä¸­é—´ä»¶
       middlewares:
         - rate_limit: 100/min
         - request_log: true
         - response_compression: true
   ```

3. **Admin Portal åªè´Ÿè´£ç®¡ç† UI**
   ```
   Admin Portal èŒè´£:
   âœ… æ˜¾ç¤ºç”¨æˆ·ç®¡ç†ç•Œé¢
   âœ… å¤„ç† OAuth æˆæƒç å›è°ƒ
   âœ… å­˜å‚¨ access_token
   âœ… è°ƒç”¨ OAuth Service API
   âŒ ä¸æä¾›è®¤è¯ UI
   âŒ ä¸éªŒè¯å‡­è¯
   âŒ ä¸ç®¡ç†ä¼šè¯
   ```

**è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜åŠ¿**:

```
ç»´åº¦                  å½“å‰æ–¹æ¡ˆ        æ–°æ–¹æ¡ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä»£ç†å¤„ç†              åˆ é™¤âŒ         ä¿ç•™âœ…
æµå¼å“åº”é—®é¢˜          å­˜åœ¨âŒ         è§£å†³âœ…
è®¤è¯é€»è¾‘é›†ä¸­          åˆ†æ•£ğŸŸ¡         é›†ä¸­âœ…
OAuth æ ‡å‡†æ€§          éæ ‡ğŸŸ¡         æ ‡å‡†âœ…
Cookie ç®¡ç†           è„†å¼±ğŸŸ¡         æ¸…æ™°âœ…
ä¸­é—´ä»¶èƒ½åŠ›            æ— âŒ           æœ‰âœ…
ç›‘æ§/æ—¥å¿—             å›°éš¾ğŸŸ¡         å®¹æ˜“âœ…
å®‰å…¨å®¡è®¡              ä¸å®Œæ•´ğŸŸ¡       å®Œæ•´âœ…
å¯æ‰©å±•æ€§              å·®âŒ           å¥½âœ…
```

#### æ–¹æ¡ˆ 2ï¼šå¦‚æœå¿…é¡»åœ¨ Next.js ä¸­ä»£ç†

**ï¼ˆä¸æ¨èï¼Œä½†å¦‚æœå¿…é¡»è¿™æ ·åšï¼Œæ‰æ˜¯æ­£ç¡®çš„åšæ³•ï¼‰**

```typescript
// /api/v2/[...path]/route.ts
export async function handler(request: Request, { params }: Params) {
  const path = params.path.join('/');
  
  try {
    // 1. éªŒè¯è¯·æ±‚æ¥æºï¼ˆé˜²æ­¢ CSRFï¼‰
    const origin = request.headers.get('origin');
    if (origin && !isValidOrigin(origin)) {
      return new Response(
        JSON.stringify({ error: 'invalid_origin' }),
        { status: 403 }
      );
    }
    
    // 2. è¯»å–å®Œæ•´çš„è¯·æ±‚ä½“ï¼ˆä¸è¦æµå¼è½¬å‘ï¼‰
    let requestBody: Buffer | null = null;
    if (request.method !== 'GET') {
      const arrayBuffer = await request.arrayBuffer();
      requestBody = Buffer.from(arrayBuffer);
    }
    
    // 3. ä»£ç†è¯·æ±‚åˆ° OAuth Service
    const proxyRequest = new Request(
      `http://localhost:3001/api/v2/${path}${request.url.split('?')[1] || ''}`,
      {
        method: request.method,
        headers: {
          'Content-Type': request.headers.get('content-type') || 'application/json',
          'X-Forwarded-For': request.headers.get('x-forwarded-for') || '127.0.0.1',
        },
        body: requestBody ? requestBody : undefined,
      }
    );
    
    // 4. è½¬å‘è¯·æ±‚
    const proxyResponse = await fetch(proxyRequest);
    
    // 5. è¯»å–å®Œæ•´çš„å“åº”ä½“ï¼ˆä¸è¦æµå¼è½¬å‘ï¼‰
    const responseBody = await proxyResponse.arrayBuffer();
    
    // 6. è¿”å›å®Œæ•´å“åº”ï¼ˆæ˜¾å¼è®¾ç½® Content-Lengthï¼‰
    return new Response(responseBody, {
      status: proxyResponse.status,
      statusText: proxyResponse.statusText,
      headers: {
        'Content-Type': proxyResponse.headers.get('content-type') || 'application/json',
        'Content-Length': responseBody.byteLength.toString(),
        'X-Proxy-Via': 'next-js-api-route',
        // è½¬å‘å…¶ä»–é‡è¦çš„å“åº”å¤´
        ...(proxyResponse.headers.get('set-cookie') && {
          'Set-Cookie': proxyResponse.headers.get('set-cookie'),
        }),
      },
    });
  } catch (error) {
    return new Response(
      JSON.stringify({ error: 'proxy_error', message: error.message }),
      { status: 502, headers: { 'Content-Type': 'application/json' } }
    );
  }
}
```

**è¿™ä¸ªåšæ³•çš„è¦ç‚¹**:
- âœ… å®Œå…¨ç¼“å†²è¯·æ±‚/å“åº”ï¼ˆä¸æµå¼è½¬å‘ï¼‰
- âœ… æ·»åŠ é”™è¯¯å¤„ç†
- âœ… æ·»åŠ å®‰å…¨æ£€æŸ¥ï¼ˆCSRFã€æ¥æºéªŒè¯ï¼‰
- âœ… æ˜ç¡®è®¾ç½® Content-Lengthï¼ˆé¿å… chunkedï¼‰
- âœ… ä¿ç•™ä¸­é—´ä»¶èƒ½åŠ›

---

## 7. ä¸ºä»€ä¹ˆæ ‡å‡† OAuth ä¸é‡‡ç”¨è¿™ç§æ··åˆè®¾è®¡

### 7.1 RFC 6749 (OAuth 2.0) çš„è®¾è®¡åŸåˆ™

**Resource Owner Password Credentials Grant** (æ ‡å‡†çš„ç™»å½•æµç¨‹):

```
æ ‡å‡†æµç¨‹ï¼š
1. Client â”€â”€â”€â”€(username + password)â”€â”€â”€â”€â†’ Authorization Server
                                         [AS å¤„ç†å‡­è¯]
                                         [AS è¿”å› token]
2. Authorization Server â”€â”€â”€â”€(token)â”€â”€â”€â”€â†’ Client

é‡ç‚¹ï¼š
âœ… ç”¨æˆ·ç›´æ¥ä¿¡ä»» Authorization Serverï¼ˆè¾“å…¥å‡­è¯ï¼‰
âœ… Client ä¸æ¶‰åŠå‡­è¯å¤„ç†
âœ… Authorization Server å®Œå…¨æ§åˆ¶å®‰å…¨æ€§
```

**æ ‡å‡†æµç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ Authorization Server æä¾› UI**:

```
ç†ç”± 1: ç”¨æˆ·ä¿¡ä»»é“¾
   ç”¨æˆ·ä¿¡ä»» Authorization Serverï¼ˆå®˜æ–¹çš„è®¤è¯æä¾›è€…ï¼‰
   ç”¨æˆ·ä¸ä¿¡ä»»æ¯ä¸ª Client åº”ç”¨ï¼ˆå¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹ï¼‰
   â†“
   ç”¨æˆ·åº”è¯¥å‘ Authorization Server è¾“å…¥å‡­è¯ï¼Œè€Œä¸æ˜¯ Client

ç†ç”± 2: å®‰å…¨éš”ç¦»
   Authorization Server: ä¸“ä¸šçš„å®‰å…¨å›¢é˜Ÿè¿ç»´
   Client åº”ç”¨: å¯èƒ½ç¼ºä¹å®‰å…¨ä¸“ä¸šçŸ¥è¯†
   â†“
   å‡­è¯éªŒè¯ã€ä¼šè¯ç®¡ç†åº”è¯¥ç”±ä¸“ä¸šå›¢é˜Ÿè´Ÿè´£

ç†ç”± 3: æ ‡å‡†åŒ–
   å¦‚æœæ¯ä¸ª Client éƒ½æä¾›ç™»å½• UI
   â†“
   æ ‡å‡†çš„ OAuth æµç¨‹å˜æˆäº†å®šåˆ¶
   â†“
   æ— æ³•é€šè¿‡æ ‡å‡†çš„å®‰å…¨å®¡è®¡

ç†ç”± 4: ç”¨æˆ·ä½“éªŒä¸€è‡´æ€§
   æ‰€æœ‰ Client åº”ç”¨ä¸­çš„ç™»å½• UI çœ‹èµ·æ¥éƒ½ä¸€æ ·ï¼ˆæ¥è‡ª ASï¼‰
   â†“
   ç”¨æˆ·çŸ¥é“è¿™æ˜¯å®˜æ–¹çš„è®¤è¯ç•Œé¢
   â†“
   é™ä½é’“é±¼æ”»å‡»é£é™©
```

### 7.2 æœ¬ç³»ç»Ÿä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼ˆéæ ‡å‡†ï¼‰

```
å½“å‰æ¶æ„çš„éæ ‡å‡†ä¹‹å¤„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Authorization Server (OAuth Service)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… éªŒè¯å‡­è¯ã€ç­¾å‘ token                â”‚
â”‚ âŒ ä¸æä¾›ç™»å½• UIï¼ˆåœ¨ Admin Portalï¼‰    â”‚
â”‚ âŒ ä¸æä¾›åŒæ„ UIï¼ˆåœ¨ Admin Portalï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Application (Admin Portal)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… ç®¡ç†ç•Œé¢                             â”‚
â”‚ âœ… OAuth æ ‡å‡†å®¢æˆ·ç«¯åŠŸèƒ½                â”‚
â”‚ âŒ æä¾›ç™»å½• UIï¼ˆåº”è¯¥åœ¨ AS ä¸­ï¼‰         â”‚
â”‚ âŒ æä¾›åŒæ„ UIï¼ˆåº”è¯¥åœ¨ AS ä¸­ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?
â”œâ”€ ç†ç”± 1: "Next.js æ›´é€‚åˆå¼€å‘ UI"
â”‚  â””â”€ è¿™æ˜¯å¼€å‘æ•ˆç‡çš„é—®é¢˜ï¼Œä¸æ˜¯è®¾è®¡é—®é¢˜
â”‚  â””â”€ åº”è¯¥æ”¹è¿› OAuth Service çš„ UI å¼€å‘ä½“éªŒ
â”‚     (ä½¿ç”¨ HTML æ¨¡æ¿ã€CSS æ¡†æ¶ç­‰)
â”‚
â”œâ”€ ç†ç”± 2: "æƒ³è¦å®šåˆ¶åŒ–çš„ç™»å½•ç•Œé¢"
â”‚  â””â”€ OAuth Service å®Œå…¨å¯ä»¥æ”¯æŒå¤šä¸ªä¸»é¢˜
â”‚  â””â”€ ä¸éœ€è¦å°† UI åˆ†ç¦»åˆ°å¦ä¸€ä¸ªåº”ç”¨
â”‚
â”œâ”€ ç†ç”± 3: "Admin Portal ä¹Ÿéœ€è¦ç™»å½•"
â”‚  â””â”€ Admin Portal ä½œä¸º Client åº”è¯¥ï¼š
â”‚     1. é‡å®šå‘åˆ° OAuth Service çš„ç™»å½•é¡µé¢
â”‚     2. è·å–æˆæƒç 
â”‚     3. äº¤æ¢ token
â”‚     â””â”€ ä¸åº”è¯¥æä¾›è‡ªå·±çš„ç™»å½• UI
â”‚
â””â”€ ç†ç”± 4: "åˆ†ç¦»å…³æ³¨ç‚¹"
   â””â”€ è¿™ä¸ªç†ç”±æœ‰é—®é¢˜ï¼Œå› ä¸ºè®¤è¯æ˜¯è·¨è¶Šåº”ç”¨çš„èŒè´£
   â””â”€ ä¸èƒ½ç®€å•åœ°"åˆ†ç¦»"
```

---

## 8. æ¶æ„æ”¹è¿›çš„æˆæœ¬ä¸æ”¶ç›Š

### 8.1 çŸ­æœŸæˆæœ¬

```
å¦‚æœé‡‡å–æ–¹æ¡ˆ 1ï¼ˆæ ‡å‡†åŒ– OAuth æ¶æ„ï¼‰ï¼š

1. å°†ç™»å½•/åŒæ„ UI ä» Next.js ç§»åˆ° Rust
   æˆæœ¬ï¼š1-2 å‘¨å¼€å‘
   â”œâ”€ å­¦ä¹  Rust æ¨¡æ¿å¼•æ“ï¼ˆaskama/sailfishï¼‰
   â”œâ”€ å®ç° HTML é™æ€èµ„æºæœåŠ¡
   â””â”€ æµ‹è¯• UI è¡¨å•æäº¤
   
2. æ›´æ–° Admin Portal
   æˆæœ¬ï¼š2-3 å¤©
   â”œâ”€ åˆ é™¤ç™»å½•/åŒæ„é¡µé¢
   â”œâ”€ åˆ é™¤ç›¸å…³ API è·¯ç”±
   â””â”€ æ›´æ–°è®¤è¯æµç¨‹
   
3. æ›´æ–° Pingora é…ç½®
   æˆæœ¬ï¼š1 å¤©
   â”œâ”€ è°ƒæ•´è·¯ç”±è§„åˆ™
   â”œâ”€ æ·»åŠ ä¸­é—´ä»¶é…ç½®
   â””â”€ æµ‹è¯•ä»£ç†åŠŸèƒ½

æ€»æˆæœ¬ï¼šçº¦ 2-3 å‘¨
```

### 8.2 é•¿æœŸæ”¶ç›Š

```
1. æ¶æ„æ¸…æ™°æ€§
   âœ… è®¤è¯é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹
   âœ… èŒè´£è¾¹ç•Œæ¸…æ™°
   âœ… æ–°å¼€å‘è€…å®¹æ˜“ç†è§£
   
2. å®‰å…¨æ€§æå‡
   âœ… CSRF é˜²æŠ¤æ›´ä¸€è‡´
   âœ… Cookie ç®¡ç†æ›´æ¸…æ™°
   âœ… å®¡è®¡æ—¥å¿—æ›´å®Œæ•´
   âœ… ç¬¦åˆ OAuth 2.1 æ ‡å‡†
   
3. å¯ç»´æŠ¤æ€§
   âœ… å‡å°‘è·¨åº”ç”¨çš„çŠ¶æ€åŒæ­¥
   âœ… é™ä½è®¤è¯ç›¸å…³çš„ bug é£é™©
   âœ… æ›´å®¹æ˜“è¿›è¡Œå®‰å…¨æ›´æ–°
   
4. å¯æ‰©å±•æ€§
   âœ… å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„ Client åº”ç”¨
   âœ… å¯ä»¥æ”¯æŒå¤šä¸ªè®¤è¯æ–¹å¼ï¼ˆOIDC, SAML ç­‰ï¼‰
   âœ… å¯ä»¥åœ¨ä»£ç†å±‚æ·»åŠ æ–°çš„ä¸­é—´ä»¶
   
5. æ€§èƒ½ä¼˜åŒ–ç©ºé—´
   âœ… å¯ä»¥åœ¨ Pingora æ·»åŠ ç¼“å­˜å±‚
   âœ… å¯ä»¥å¯¹å¸¸è§ API åšå“åº”å‹ç¼©
   âœ… å¯ä»¥å®ç°æ™ºèƒ½çš„è¿æ¥å¤ç”¨

ä¼°è®¡æ”¶ç›Šï¼š
â”œâ”€ å‡å°‘ 40% çš„è®¤è¯ç›¸å…³ bug
â”œâ”€ é™ä½ 30% çš„å®‰å…¨å®¡è®¡å·¥ä½œ
â”œâ”€ æå‡ 20% çš„å¼€å‘æ•ˆç‡ï¼ˆé•¿æœŸï¼Œä»£ç æ›´æ¸…æ™°ï¼‰
â””â”€ èŠ‚çœ 60% çš„æ•…éšœæ’æŸ¥æ—¶é—´
```

---

## 9. æ£€æŸ¥æ¸…å•ï¼šå½“å‰æ¶æ„æ˜¯å¦çœŸçš„"ç”Ÿäº§å°±ç»ª"

### 9.1 å®‰å…¨æ€§è¯„ä¼°

```
æ£€æŸ¥é¡¹                                    å½“å‰çŠ¶æ€    è¯„åˆ†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CSRF é˜²æŠ¤ï¼ˆState å‚æ•°ï¼‰                    âœ…         9/10
CSRF é˜²æŠ¤ï¼ˆSameSite Cookieï¼‰               âœ…         9/10
å‡­è¯ä¼ è¾“ï¼ˆHTTPSï¼‰                         ğŸŸ¡         8/10 (ä»…ç”Ÿäº§)
å‡­è¯å­˜å‚¨ï¼ˆå¯†ç  Hashï¼‰                     âœ…         9/10 (bcrypt)
å‡­è¯æš´éœ²ï¼ˆXSSï¼‰                          âœ…         10/10 (HttpOnly)
ä¼šè¯ç®¡ç†ï¼ˆè¶…æ—¶ï¼‰                         âœ…         9/10 (1å°æ—¶)
ä¼šè¯å›ºå®šæ”»å‡»                              ğŸŸ¡         7/10 (æ— æ˜¾å¼é˜²æŠ¤)
æƒé™æå‡ï¼ˆæ°´å¹³è¶Šæƒï¼‰                     âœ…         8/10 (RBAC)
OAuth æ ‡å‡†éµå¾ª                            ğŸŸ¡         6/10 (UI éæ ‡)
Cookie ç®¡ç†å¯é æ€§                         ğŸŸ¡         7/10 (è„†å¼±)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å®‰å…¨æ€§æ€»ä½“è¯„åˆ†                                       8.2/10
```

### 9.2 å¯é æ€§è¯„ä¼°

```
æ£€æŸ¥é¡¹                                    å½“å‰çŠ¶æ€    è¯„åˆ†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æµå¼å“åº”å¤„ç†ï¼ˆå·²è§£å†³ï¼‰                   âœ…         10/10
Cookie è·¨åŸŸæ”¯æŒ                           ğŸŸ¡         7/10 (è„†å¼±)
é”™è¯¯æ¢å¤æœºåˆ¶                              ğŸŸ¡         6/10 (æœ‰é™)
è¶…æ—¶å¤„ç†                                  ğŸŸ¡         7/10 (éœ€æ”¹è¿›)
å¹¶å‘å¤„ç†                                  âœ…         8/10
æ•°æ®åº“è¿æ¥æ±                               âœ…         8/10
æ—¥å¿—è®°å½•                                  âœ…         8/10
ç›‘æ§å‘Šè­¦                                  ğŸŸ¡         6/10 (æœ‰é™)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¯é æ€§æ€»ä½“è¯„åˆ†                                       7.8/10
```

### 9.3 å¯ç»´æŠ¤æ€§è¯„ä¼°

```
æ£€æŸ¥é¡¹                                    å½“å‰çŠ¶æ€    è¯„åˆ†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä»£ç ç»„ç»‡ï¼ˆåˆ†å±‚æ¸…æ™°ï¼‰                     âœ…         8/10
è®¤è¯é€»è¾‘ï¼ˆé›†ä¸­åº¦ï¼‰                       ğŸŸ¡         6/10 (åˆ†æ•£)
èŒè´£è¾¹ç•Œï¼ˆæ¸…æ™°åº¦ï¼‰                       ğŸŸ¡         6/10 (æ··æ·†)
æ–‡æ¡£å®Œæ•´æ€§                                âœ…         8/10
æµ‹è¯•è¦†ç›–ç‡                                âœ…         7/10
ä¾èµ–ç®¡ç†                                  âœ…         7/10
é…ç½®ç®¡ç†                                  âœ…         8/10
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¯ç»´æŠ¤æ€§æ€»ä½“è¯„åˆ†                                     7.3/10
```

### 9.4 æ€»ä½“è¯„åˆ†ä¸å»ºè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½“å‰æ¶æ„æ€»ä½“è¯„åˆ†: 7.8/10                â”‚
â”‚ çŠ¶æ€: å¯ä»¥å·¥ä½œï¼Œä½†éæœ€ä¼˜                â”‚
â”‚ ç”Ÿäº§å°±ç»ªåº¦: æœ‰é™ï¼ˆæœ‰å·²çŸ¥çš„è®¾è®¡ç¼ºé™·ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯„ä¼°ç»“è®ºï¼š
âœ… åŠŸèƒ½å®Œæ•´ - æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½èƒ½å·¥ä½œ
âœ… åŸºæœ¬å®‰å…¨ - å¸¸è§çš„å®‰å…¨é—®é¢˜éƒ½è¢«å¤„ç†äº†
ğŸŸ¡ è®¾è®¡æœ‰ç¼ºé™· - èŒè´£æ··æ·†ï¼Œæ¶æ„ä¸å¤Ÿæ ‡å‡†
ğŸŸ¡ è„†å¼±çš„åœ°æ–¹ - Cookie ç®¡ç†ã€æµå¼å“åº”çš„å†å²é—®é¢˜
âŒ ä¸å¤Ÿä¼˜é›… - åˆ é™¤ä»£ç†å±‚æ˜¯"åº”æ€¥"æ–¹æ¡ˆï¼Œä¸æ˜¯"ä¼˜åŒ–"æ–¹æ¡ˆ
```

---

## 10. å»ºè®®ä¸ç»“è®º

### 10.1 ç«‹å³è¡ŒåŠ¨ï¼ˆå¿…é¡»åšï¼‰

```
ä¼˜å…ˆçº§  ä»»åŠ¡                              é¢„è®¡æ—¶é—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
P0      æ˜¾å¼é…ç½® Cookie domain             1å°æ—¶
        - æ·»åŠ  COOKIE_DOMAIN ç¯å¢ƒå˜é‡
        - æ›´æ–° Cookie è®¾ç½®ä»£ç 
        - éªŒè¯ Cookie åœ¨å„ç§æƒ…å†µä¸‹æœ‰æ•ˆ
        
P0      æ·»åŠ  API è¯·æ±‚æ—¥å¿—                 4å°æ—¶
        - è®°å½•æ‰€æœ‰ /api/v2/* è¯·æ±‚
        - åŒ…æ‹¬è¯·æ±‚å¤´ã€å“åº”ç ã€å¤„ç†æ—¶é—´
        - ç”¨äºè°ƒè¯•å’Œå®¡è®¡
        
P1      é‡æ–°è€ƒè™‘ HTTP ä»£ç†å±‚              è§„åˆ’
        - ä¸æ˜¯è¦æ¢å¤åˆ é™¤çš„ä»£ç†
        - è€Œæ˜¯åœ¨ Pingora ä¸­é…ç½®æ­£ç¡®çš„ä»£ç†
        - æ·»åŠ è¯·æ±‚è½¬å‘çš„ä¸­é—´ä»¶èƒ½åŠ›
```

### 10.2 ä¸­æœŸæ”¹è¿›ï¼ˆåº”è¯¥åšï¼‰

```
ä¼˜å…ˆçº§  ä»»åŠ¡                              é¢„è®¡æ—¶é—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
P2      é‡æ–°è®¾è®¡è®¤è¯ UI åˆ†å¸ƒ              2-3å‘¨
        - è¯„ä¼°æˆæœ¬ï¼šå°†ç™»å½• UI è¿ç§»åˆ° Rust
        - ä¿ç•™ Admin Portal çš„ç®¡ç†ç•Œé¢
        - ç¬¦åˆ OAuth 2.1 æ ‡å‡†
        
P2      æ”¹è¿› Cookie ç®¡ç†                  1å‘¨
        - æ˜¾å¼é…ç½® domainã€secureã€samesite
        - æµ‹è¯•å„ç§åœºæ™¯ï¼ˆHTTP/HTTPSã€æœ¬åœ°/è¿œç¨‹ï¼‰
        - æ·»åŠ  Cookie å®‰å…¨æ€§æ£€æŸ¥
        
P2      å¢å¼ºé”™è¯¯å¤„ç†                      1å‘¨
        - æ›´è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯
        - æ ‡å‡†åŒ–é”™è¯¯å“åº”æ ¼å¼ï¼ˆRFC 6749ï¼‰
        - æ·»åŠ é”™è¯¯é‡è¯•é€»è¾‘
```

### 10.3 é•¿æœŸä¼˜åŒ–ï¼ˆå€¼å¾—åšï¼‰

```
ä¼˜å…ˆçº§  ä»»åŠ¡                              é¢„è®¡æ—¶é—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
P3      ä»£ç†å±‚çš„å®Œæ•´å®ç°                  2-3å‘¨
        - åœ¨ Pingora ä¸­å®ç°æ™ºèƒ½è½¬å‘
        - æ·»åŠ è¯·æ±‚æ—¥å¿—ã€ç›‘æ§ã€é™æµä¸­é—´ä»¶
        - æ”¯æŒè¯·æ±‚è½¬æ¢ï¼ˆæ·»åŠ è‡ªå®šä¹‰å¤´ç­‰ï¼‰
        
P3      å®‰å…¨æ€§åŠ å›º                        æŒç»­
        - å®šæœŸå®¡è®¡è®¤è¯æµç¨‹
        - å®æ–½ OAuth 2.1 çš„æ‰€æœ‰å®‰å…¨ç‰¹æ€§
        - æ·»åŠ æ›´å¤šçš„æ”»å‡»æ£€æµ‹ï¼ˆæš´åŠ›ç ´è§£ç­‰ï¼‰
        
P3      æ€§èƒ½ä¼˜åŒ–                          1-2å‘¨
        - Token ç¼“å­˜ç­–ç•¥
        - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
        - è¿æ¥æ± è°ƒæ•´
```

### 10.4 æœ€ç»ˆå»ºè®®

**ä¸è¦åœç•™åœ¨å½“å‰"å¯å·¥ä½œ"çš„çŠ¶æ€ã€‚** å½“å‰æ¶æ„é€šè¿‡"åˆ é™¤ä»£ç†å±‚"è§£å†³äº†æµå¼å“åº”é—®é¢˜ï¼Œä½†è¿™åªæ˜¯æ©ç›–äº†æ›´æ·±å±‚çš„è®¾è®¡ç¼ºé™·ï¼š

1. **è®¤è¯é€»è¾‘åˆ†æ•£** - Admin Portal å’Œ OAuth Service éƒ½å‚ä¸è®¤è¯æµç¨‹
2. **èŒè´£æ··æ·†** - Admin Portal æ—¢æ˜¯åº”ç”¨åˆæ˜¯ UI æä¾›æ–¹
3. **éæ ‡å‡†å®ç°** - è¿åäº† OAuth 2.1 çš„è®¾è®¡åŸåˆ™
4. **è„†å¼±çš„ Cookie ç®¡ç†** - ä¾èµ–æµè§ˆå™¨çš„è‡ªåŠ¨è¡Œä¸º

**å»ºè®®çš„è·¯å¾„**:

```
ç°çŠ¶                çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰        ä¸­æœŸï¼ˆ1-2æœˆï¼‰        é•¿æœŸï¼ˆæŒç»­ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è„†å¼±çš„æ¶æ„ â†’ é…ç½®æ”¹è¿› â†’ ä»£ç†å±‚æ”¹è¿› â†’ æ ‡å‡† OAuth â†’ æŒç»­ä¼˜åŒ–
            (å¿«é€Ÿä¿®å¤)  (é€æ­¥æ”¹è¿›)    (æ ¹æœ¬æ”¹å–„)  (ç»´æŠ¤å“è¶Š)
```

**æ ¸å¿ƒç»“è®º**:

> **å½“å‰ç³»ç»Ÿå¯ä»¥å·¥ä½œï¼Œä½†éœ€è¦ä»"åº”æ€¥æ–¹æ¡ˆ"å‡çº§åˆ°"ç³»ç»Ÿè®¾è®¡"ã€‚** é€šè¿‡æ¢å¤å’Œæ”¹è¿›ä»£ç†å±‚ï¼Œå°†ç™»å½• UI è¿ç§»åˆ° OAuth Serviceï¼Œå¯ä»¥æ‰“é€ ä¸€ä¸ªæ›´åŠ æ¸…æ™°ã€å®‰å…¨ã€æ ‡å‡†çš„ OAuth å®ç°ã€‚è¿™ä¸ä»…æ˜¯ä»£ç æ”¹è¿›ï¼Œæ›´æ˜¯æ¶æ„æ€æƒ³çš„å‡çº§ã€‚

---

## é™„å½•ï¼šå…³é”®ä»£ç ä½ç½®

### OAuth Service ç›¸å…³
- `apps/oauth-service-rust/src/routes/oauth.rs` - ç™»å½•ã€Tokenã€æˆæƒç«¯ç‚¹
- `apps/oauth-service-rust/src/services/user_service.rs` - ç”¨æˆ·éªŒè¯
- `apps/oauth-service-rust/src/services/token_service.rs` - Token ç­¾å‘
- `apps/oauth-service-rust/src/middleware/auth.rs` - è®¤è¯æ£€æŸ¥

### Admin Portal ç›¸å…³
- `apps/admin-portal/components/auth/username-password-form.tsx` - ç™»å½•è¡¨å•
- `apps/admin-portal/lib/auth-service.ts` - OAuth å®¢æˆ·ç«¯é€»è¾‘
- `apps/admin-portal/app/auth/callback/page.tsx` - æˆæƒç å›è°ƒ

### Pingora ä»£ç†ç›¸å…³
- `apps/pingora-proxy/config/default.yaml` - ä»£ç†é…ç½®
- `apps/pingora-proxy/src/proxy/mod.rs` - ä»£ç†å®ç°

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-28
**åˆ†ææ–¹æ³•**: ä»£ç å®¡è§† + æ¶æ„è¯„ä¼° + æ ‡å‡†å¯¹æ¯”
**å¯ä¿¡åº¦**: åŸºäºçœŸå®ä»£ç å’Œé…ç½®çš„æ·±åº¦åˆ†æ

