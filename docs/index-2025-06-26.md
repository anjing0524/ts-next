# Monorepo 项目索引 & 依赖关系图

> **文档版本**: v1.1.0  
> **最后更新**: 2025-01-26  
> **维护团队**: 架构组  
> **项目状态**: ⚠️ 核心功能完成，存在集成问题

本文档提供了 monorepo 中各应用和子包的索引、依赖关系图和按需引用指南，帮助开发者快速了解项目结构。

**⚠️ 当前状态**: 项目结构完整，但 admin-portal 与 oauth-service 之间存在API集成问题需要解决。

## 目录

1. 总览
2. Apps 索引
3. Packages 索引
4. 依赖关系图
5. 按需引用指南
6. TypeScript 别名共享方案（2025-06-26 更新）

---

## 1. 总览

- **包管理器**：pnpm + Turborepo
- **前端框架**：Next.js 15 + TailwindCSS 4 + shadcn/ui
- **数据库**：Prisma + SQLite
- **测试框架**：Jest 30

项目根目录简化结构：

```bash
.
├── apps/            # 微服务应用
├── packages/        # 共享包（UI、Lib、Database…）
├── docs/            # 文档
└── turbo.json       # Turborepo 配置
```

## 应用 (Apps)

### 🔐 oauth-service

- **路径**: `apps/oauth-service`
- **端口**: 3001
- **职责**: OAuth2.1 认证授权服务
- **状态**: ✅ 核心功能完成
- **问题**: ⚠️ 部分API端点缺失（审计日志、用户资料更新）

### 🎛️ admin-portal

- **路径**: `apps/admin-portal`
- **端口**: 3002
- **职责**: 系统管理后台
- **状态**: ⚠️ 基础功能完成
- **问题**: ⚠️ API集成问题（路径不匹配、后端缺失）

### 📈 kline-service

- **路径**: `apps/kline-service`
- **端口**: 3003
- **职责**: K线图表服务
- **状态**: 🚧 开发中

### 🧪 test-service

- **路径**: `apps/test-service`
- **端口**: 3004
- **职责**: 测试服务示例
- **状态**: 📝 示例代码

> 约定：所有 Next.js 应用的端口可在各自 `package.json` 的 `dev` / `start` 脚本中通过 `-p` 参数调整。

## 3. Packages 索引

| 包                          | 说明                                                       | 入口文件 / 导出概览                                                                                            |
| --------------------------- | ---------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| **@repo/ui**                | 共享 UI 组件库，基于 shadcn/ui 与 TailwindCSS。            | `src/index.ts` → `components.ts`：Alert／Button／Table／Dashboard blocks 等 30+ 组件；`hooks/`；`lib/utils.ts` |
| **@repo/lib**               | 业务逻辑 & 工具库。提供 OAuth2 / JWT / RBAC 等工具与服务。 | `src/index.ts`：`auth/*`、`services/*`、`utils/*`、`middleware/*`，以及 `LIB_VERSION` 常量                     |
| **@repo/database**          | Prisma 客户端封装，提供数据库访问与数据类型。              | `client.ts`、`mysql-client.ts`、`prisma/schema.prisma`                                                         |
| **@repo/cache**             | 简易缓存工具与日志封装。                                   | `src/cache-manager.ts`、`src/logger.ts`                                                                        |
| **@repo/eslint-config**     | 共享 ESLint Flat 配置。                                    | `flat.js`                                                                                                      |
| **@repo/jest-config**       | 共享 Jest 30 配置。                                        | `index.js`、`next.js`                                                                                          |
| **@repo/prettier-config**   | 共享 Prettier 配置。                                       | `index.js`                                                                                                     |
| **@repo/tailwind-config**   | 共享 Tailwind v4 + shadcn preset。                         | `postcss.config.mjs`、`shared-styles.css`                                                                      |
| **@repo/next-config**       | 统一 Next.js (15) 配置扩展。                               | `index.js`                                                                                                     |
| **@repo/typescript-config** | TypeScript base / Next.js tsconfig 片段。                  | `base.json`、`nextjs.json`                                                                                     |

> 如需详细导出，请查看对应包下的 README（将在后续 PR 中补充）。

## 依赖关系图

```mermaid
graph TD
    %% 应用层
    A[admin-portal:3002] -.->|⚠️ API集成问题| B[oauth-service:3001]
    C[kline-service:3003] --> B
    D[test-service:3004] --> B

    %% 共享包依赖
    A --> E[@repo/ui]
    A --> F[@repo/lib]
    A --> G[@repo/database]

    B --> F
    B --> G

    C --> E
    C --> F

    D --> E
    D --> F
    D --> G

    %% 基础包
    E --> H[@repo/eslint-config]
    E --> I[@repo/typescript-config]

    F --> H
    F --> I

    G --> H
    G --> I

    %% 样式
    classDef app fill:#e1f5fe
    classDef package fill:#f3e5f5
    classDef config fill:#fff3e0
    classDef warning fill:#ffebee

    class A,B,C,D app
    class E,F,G package
    class H,I config
```

### ⚠️ 集成问题说明

**admin-portal → oauth-service 集成问题**:

- 🔴 审计日志API完全缺失
- 🔴 用户资料更新端点缺失
- 🔴 客户端密钥轮换路径不匹配
- 🔴 会话注销未集成令牌撤销
- 🟡 功能重复端点需要统一

Mermaid 渲染示例：

![dependency-graph](./images/dependency-graph-20250626.png)

> 若在 GitHub 上无法直接渲染，请安装支持 Mermaid 的浏览器插件或在本地 VSCode 预览。

## 按需引用指南

### 开发新应用时

1. **基础配置**: 必须依赖 `@repo/eslint-config` 和 `@repo/typescript-config`
2. **UI组件**: 如需UI组件，依赖 `@repo/ui`
3. **工具函数**: 如需共享工具，依赖 `@repo/lib`
4. **数据库**: 如需数据库访问，依赖 `@repo/database`
5. **认证**: 如需认证功能，集成 `oauth-service`

### ⚠️ 集成注意事项

- **API路径**: 确保前后端API路径完全匹配
- **错误处理**: 使用统一的错误响应格式
- **认证流程**: 优先使用OAuth2.1标准端点
- **测试覆盖**: 编写集成测试验证API连通性

1. **在 App 中引用 UI 组件**
   ```tsx
   import { Button, Alert } from '@repo/ui';
   ```
2. **使用业务库工具**
   ```ts
   import { generateAccessToken } from '@repo/lib/auth';
   import { RBACService } from '@repo/lib/services';
   ```
3. **数据库访问（Server 侧）**
   ```ts
   import { prisma } from '@repo/database';
   const users = await prisma.user.findMany();
   ```
4. **共享配置包** 在各包 `package.json` 中以 `workspace:*` 方式依赖；在根或子项目中：
   ```jsonc
   "eslintConfig": {
     "extends": ["@repo/eslint-config"]
   }
   ```
5. **Turborepo 任务** 示例（根目录 `package.json`）：
   ```jsonc
   {
     "scripts": {
       "dev": "turbo run dev --parallel",
       "build": "turbo run build",
       "test": "turbo run test",
     },
   }
   ```

> 以上示例仅供参考，更多细节请查阅各包 README 与具体源码。

### TypeScript 别名共享方案

所有应用和包都可以使用以下别名：

```typescript
// 导入共享UI组件
import { Button } from '@repo/ui';

// 导入共享工具函数
import { formatDate } from '@repo/lib';

// 导入数据库模型
import { prisma } from '@repo/database';
```

### API集成最佳实践

```typescript
// ✅ 推荐：使用统一的API客户端
import { apiClient } from '@repo/lib/api';

// ✅ 推荐：使用OAuth2.1标准端点
const revokeToken = () => apiClient.post('/api/v2/oauth/revoke');

// ❌ 避免：直接调用非标准端点
// const logout = () => apiClient.post('/api/v2/auth/logout')
```

自本次更新起，所有 Next.js 应用的 `tsconfig.json` 不再单独维护 `paths`，统一继承 `@repo/typescript-config/nextjs.json`。该共享配置内预设常用别名，支持根目录及 `src/` 两种组织形式，示例：

```jsonc
{
  "extends": "@repo/typescript-config/nextjs.json",
  "compilerOptions": {
    "baseUrl": ".",
  },
}
```

共享配置关键片段：

```jsonc
"paths": {
  "@/*": ["./*"],
  "@/app/*": ["./app/*"],
  "@/components/*": ["./components/*"],
  "@/lib/*": ["./lib/*"]
}
```

> 如果应用需要额外别名，可在自身 `compilerOptions.paths` 中追加（优先级高于共享配置）。
