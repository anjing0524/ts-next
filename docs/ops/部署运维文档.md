# 部署运维文档

**文档版本**: v1.1.0  
**创建日期**: 2025-01-28  
**最后更新**: 2025-07-08  
**作者**: 运维团队  
**状态**: 正式版 - 基础部署方案

## 概述

本文档描述了基于 Turborepo 的 OAuth2.1 认证授权中心和微服务平台的部署和运维方案。系统采用容器化部署，支持开发、测试和生产环境。

## 系统架构

### 服务端口分配

| 服务名称      | 端口   | 协议       | 描述              |
| ------------- | ------ | ---------- | ----------------- |
| pingora-proxy | `8080` | HTTP/HTTPS | 反向代理网关      |
| oauth-service | `3001` | HTTP       | OAuth2.1 认证服务 |
| admin-portal  | `3002` | HTTP       | 管理后台          |
| kline-service | `3003` | HTTP       | K线图服务         |
| flow-service  | `3004` | HTTP       | 工作流服务        |
| test-service  | `3005` | HTTP       | 测试服务          |
| sqlite        | file   | file       | 数据库            |
| Prometheus    | `9090` | HTTP       | 监控系统          |
| Grafana       | `3000` | HTTP       | 监控面板          |

## 环境配置

### 开发环境

**系统要求**:

- Node.js 20+
- Rust 1.70+
- pnpm 8+
- Docker 24+
- PostgreSQL 15+

**启动步骤**:

```bash
# 1. 安装依赖
pnpm install

# 2. 数据库初始化
pnpm db:push
pnpm db:seed

# 3. 构建 Pingora Proxy
cd apps/pingora-proxy
cargo build

# 4. 启动所有服务
pnpm dev

# 5. 启动 Pingora Proxy
cd apps/pingora-proxy
cargo run -- --config config/default.yaml
```

### 生产环境

**Docker Compose 部署**:

```yaml
# docker-compose.yml
version: '3.8'

services:
  # 反向代理网关
  pingora-proxy:
    build:
      context: ./apps/pingora-proxy
      dockerfile: Dockerfile
    ports:
      - '8080:8080'
    volumes:
      - ./apps/pingora-proxy/config:/app/config
    depends_on:
      - oauth-service
      - admin-portal
    restart: unless-stopped

  # OAuth2.1 认证服务
  oauth-service:
    build:
      context: .
      dockerfile: apps/oauth-service/Dockerfile
    ports:
      - '3001:3001'
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/oauth_db
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
    restart: unless-stopped

  # 管理后台
  admin-portal:
    build:
      context: .
      dockerfile: apps/admin-portal/Dockerfile
    ports:
      - '3002:3002'
    environment:
      - NEXT_PUBLIC_API_URL=http://oauth-service:3001
    depends_on:
      - oauth-service
    restart: unless-stopped

  # 数据库
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=oauth_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    restart: unless-stopped

  # 监控系统
  prometheus:
    image: prom/prometheus:latest
    ports:
      - '9090:9090'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - '3000:3000'
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped

volumes:
  postgres_data:
  grafana_data:
```

## 监控配置

### Prometheus 配置

```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'pingora-proxy'
    static_configs:
      - targets: ['pingora-proxy:8080']
    metrics_path: '/metrics'

  - job_name: 'oauth-service'
    static_configs:
      - targets: ['oauth-service:3001']
    metrics_path: '/api/metrics'

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
```

### 关键监控指标

**Pingora Proxy 指标**:

- `pingora_requests_total` - 请求总数
- `pingora_request_duration_seconds` - 请求响应时间
- `pingora_upstream_health` - 上游服务健康状态
- `pingora_connections_active` - 活跃连接数

**应用指标**:

- `http_requests_total` - HTTP 请求总数
- `http_request_duration_seconds` - 请求响应时间
- `oauth_tokens_issued_total` - 令牌签发数量
- `oauth_login_attempts_total` - 登录尝试次数

## 安全配置

### TLS/SSL 配置

**Pingora Proxy TLS 配置**:

```yaml
# config/production.yaml
server:
  bind_address: '0.0.0.0:8080'
  tls:
    enabled: true
    cert_file: '/etc/ssl/certs/server.crt'
    key_file: '/etc/ssl/private/server.key'
    protocols: ['TLSv1.2', 'TLSv1.3']
```

### 环境变量安全

**必需的环境变量**:

```bash
# OAuth2.1 配置
JWT_SECRET=your-super-secret-jwt-key
OAUTH_CLIENT_SECRET=your-oauth-client-secret

# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/oauth_db

# 加密配置
ENCRYPTION_KEY=your-32-character-encryption-key

# 监控配置
PROMETHEUS_ENABLED=true
METRICS_PORT=9090
```

## 备份策略

### 数据库备份

**自动备份脚本**:

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"
DB_NAME="oauth_db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 数据库备份
pg_dump -h localhost -U user $DB_NAME > $BACKUP_DIR/oauth_db_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/oauth_db_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "oauth_db_*.sql.gz" -mtime +7 -delete

echo "Backup completed: oauth_db_$DATE.sql.gz"
```

**定时任务配置**:

```bash
# 每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh
```

## 故障排查

### 常见问题

**1. Pingora Proxy 启动失败**

```bash
# 检查配置文件
cargo run -- --config config/default.yaml --validate

# 检查端口占用
lsof -i :8080

# 查看日志
tail -f /var/log/pingora-proxy.log
```

**2. OAuth 服务连接失败**

```bash
# 检查服务状态
curl http://localhost:3000/health

# 检查数据库连接
pnpm db:studio

# 查看应用日志
docker logs oauth-service
```

**3. 数据库连接问题**

```bash
# 测试数据库连接
psql -h localhost -U user -d oauth_db

# 检查连接池状态
SELECT * FROM pg_stat_activity;
```

### 日志管理

**日志轮转配置**:

```bash
# /etc/logrotate.d/oauth-platform
/var/log/oauth-platform/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        systemctl reload oauth-platform
    endscript
}
```

## 性能优化

### Pingora Proxy 优化

```yaml
# config/production.yaml
server:
  worker_threads: 8 # 根据CPU核心数调整
  max_connections: 10000
  keepalive_timeout: 60

upstreams:
  - name: 'oauth-service'
    servers:
      - '127.0.0.1:3000'
      - '127.0.0.1:3001'
    health_check:
      interval: 10
      timeout: 5
      retries: 3
    load_balancing:
      algorithm: 'round_robin'
      max_fails: 3
      fail_timeout: 30
```

### 数据库优化

```sql
-- PostgreSQL 性能优化
-- 连接池配置
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';

-- 索引优化
CREATE INDEX CONCURRENTLY idx_users_email ON users(email);
CREATE INDEX CONCURRENTLY idx_tokens_client_id ON oauth_tokens(client_id);
CREATE INDEX CONCURRENTLY idx_audit_logs_timestamp ON audit_logs(created_at);
```

## 扩展部署

### 水平扩展

**负载均衡配置**:

```yaml
# 多实例部署
services:
  oauth-service-1:
    # ... oauth-service 配置

  oauth-service-2:
    # ... oauth-service 配置

  pingora-proxy:
    # 更新上游配置
    environment:
      - UPSTREAM_OAUTH_1=oauth-service-1:3000
      - UPSTREAM_OAUTH_2=oauth-service-2:3000
```

### 高可用部署

**主从数据库配置**:

```yaml
services:
  postgres-master:
    image: postgres:15
    environment:
      - POSTGRES_REPLICATION_MODE=master
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password

  postgres-slave:
    image: postgres:15
    environment:
      - POSTGRES_REPLICATION_MODE=slave
      - POSTGRES_MASTER_HOST=postgres-master
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=replicator_password
```

## 维护计划

### 定期维护任务

**每日任务**:

- 检查系统日志
- 监控服务状态
- 数据库备份验证

**每周任务**:

- 性能指标分析
- 安全日志审查
- 备份恢复测试

**每月任务**:

- 系统更新和补丁
- 容量规划评估
- 灾难恢复演练

### 更新流程

**滚动更新步骤**:

1. 更新测试环境
2. 执行自动化测试
3. 创建生产环境备份
4. 逐个更新服务实例
5. 验证服务功能
6. 监控系统稳定性

## 联系信息

**运维团队**:

- 邮箱: ops@company.com
- 值班电话: +86-xxx-xxxx-xxxx
- 钉钉群: OAuth平台运维群

**紧急联系**:

- 系统架构师: architect@company.com
- 开发负责人: dev-lead@company.com
