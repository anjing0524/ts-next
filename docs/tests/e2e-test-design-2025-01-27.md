# E2E测试设计方案

**文档日期**: 2025-07-18  
**版本**: v1.0  
**作者**: AI Assistant  

## 1. 当前问题分析

### 1.1 现状
- ✅ 已有E2E测试文件（oauth2.1-flow.spec.ts等）
- ✅ 已有Playwright配置和测试辅助文件
- ❌ webServer配置被注释，无法自动启动服务
- ❌ globalSetup/globalTeardown被注释，缺少环境初始化
- ❌ 测试依赖手动启动服务，不够自动化

### 1.2 核心问题
1. **服务依赖**: 测试需要admin-portal(3002)和oauth-service(3001)两个服务
2. **数据库状态**: 需要测试数据库的初始化和清理
3. **认证状态**: OAuth流程测试需要正确的认证设置
4. **测试隔离**: 并发测试可能产生数据冲突

## 2. 测试设计方案

### 2.1 测试架构

```
┌─────────────────────────────────────────────────────────────┐
│                    E2E测试架构                              │
├─────────────────────────────────────────────────────────────┤
│ 1. 全局设置 (Global Setup)                                  │
│    ├── 启动服务 (webServer)                                │
│    ├── 数据库初始化                                        │
│    ├── 测试数据准备                                        │
│    └── 认证设置                                            │
├─────────────────────────────────────────────────────────────┤
│ 2. 测试执行                                                │
│    ├── OAuth 2.1 流程测试                                  │
│    ├── 管理后台功能测试                                    │
│    ├── 权限控制测试                                        │
│    └── 错误处理测试                                        │
├─────────────────────────────────────────────────────────────┤
│ 3. 全局清理 (Global Teardown)                              │
│    ├── 测试数据清理                                        │
│    ├── 服务停止                                            │
│    └── 资源释放                                            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 服务启动策略

#### 2.2.1 自动服务启动
- 启用Playwright的webServer配置
- 自动启动admin-portal和oauth-service
- 健康检查确保服务就绪

#### 2.2.2 环境变量配置
```bash
# 测试环境变量
NODE_ENV=test
DATABASE_URL=file:./test.db
NEXT_PUBLIC_OAUTH_SERVICE_URL=http://localhost:3001
NEXT_PUBLIC_APP_URL=http://localhost:3002
```

### 2.3 数据库管理策略

#### 2.3.1 测试数据库隔离
- 使用独立的测试数据库
- 每次测试前重置数据库状态
- 使用事务回滚保证测试隔离

#### 2.3.2 测试数据管理
- 预定义测试用户和客户端
- 动态生成测试数据
- 测试后自动清理

### 2.4 测试分类设计

#### 2.4.1 核心流程测试
1. **OAuth 2.1 授权码+PKCE流程**
   - 用户登录
   - 授权同意
   - 令牌交换
   - 令牌刷新

2. **管理后台功能**
   - 用户管理
   - 角色权限
   - 客户端管理
   - 审计日志

#### 2.4.2 边界条件测试
1. **错误处理**
   - 无效授权码
   - 过期令牌
   - 权限不足

2. **安全测试**
   - CSRF防护
   - PKCE验证
   - 状态参数验证

### 2.5 并发和性能策略

#### 2.5.1 测试隔离
- 使用不同的测试用户
- 独立的测试数据空间
- 避免共享状态

#### 2.5.2 执行策略
- CI环境串行执行（workers: 1）
- 本地环境并行执行
- 失败重试机制

## 3. 实施计划

### 3.1 第一阶段：基础设施完善
1. ✅ 启用webServer配置
2. ✅ 启用globalSetup/globalTeardown
3. ✅ 完善测试数据管理
4. ✅ 配置测试环境变量

### 3.2 第二阶段：测试用例优化
1. ✅ 重构现有测试用例
2. ✅ 增加错误处理测试
3. ✅ 完善断言和验证
4. ✅ 添加性能监控

### 3.3 第三阶段：CI/CD集成
1. ✅ GitHub Actions集成
2. ✅ 测试报告生成
3. ✅ 失败通知机制
4. ✅ 测试覆盖率统计

## 4. 配置文件修改

### 4.1 playwright.config.ts
- 启用webServer配置
- 启用globalSetup/globalTeardown
- 配置测试环境变量

### 4.2 package.json
- 添加测试脚本
- 配置测试依赖

### 4.3 环境配置
- 测试环境变量
- 数据库配置

## 5. 测试执行流程

### 5.1 本地开发
```bash
# 1. 安装依赖
pnpm install

# 2. 构建项目
pnpm build

# 3. 运行E2E测试
pnpm test:e2e
```

### 5.2 CI环境
```bash
# 1. 环境准备
export NODE_ENV=test
export CI=true

# 2. 依赖安装和构建
pnpm install --frozen-lockfile
pnpm build

# 3. 数据库准备
pnpm db:migrate
pnpm db:seed

# 4. 运行测试
pnpm test:e2e --reporter=json
```

## 6. 监控和维护

### 6.1 测试监控
- 测试执行时间监控
- 失败率统计
- 性能指标收集

### 6.2 维护策略
- 定期更新测试数据
- 测试用例重构
- 依赖版本更新

### 2.4.3 用户管理测试
1. **用户列表加载和显示**
   - 验证用户表格数据
   - 检查分页和排序
2. **用户操作**
   - 添加新用户
   - 编辑用户
   - 删除用户
   - 批量删除
3. **状态和角色管理**
   - 验证用户状态
   - 分配和验证角色
4. **导入导出**
   - 导出用户数据
   - 导入用户数据

## 7. 风险和缓解

### 7.1 潜在风险
1. **服务启动失败**: 端口冲突、依赖缺失
2. **数据库状态**: 数据残留、并发冲突
3. **网络问题**: 超时、连接失败
4. **环境差异**: 本地vs CI环境

### 7.2 缓解措施
1. **健康检查**: 服务就绪验证
2. **重试机制**: 自动重试失败的测试
3. **错误日志**: 详细的错误信息收集
4. **环境标准化**: Docker容器化

## 8. 总结

这个E2E测试设计方案解决了当前测试架构中的关键问题：

1. **自动化**: 自动启动服务，无需手动干预
2. **隔离性**: 独立的测试环境和数据
3. **可靠性**: 完善的错误处理和重试机制
4. **可维护性**: 清晰的测试结构和文档

通过实施这个方案，可以确保E2E测试的稳定性和可靠性，为OAuth 2.1和管理后台功能提供全面的测试覆盖。