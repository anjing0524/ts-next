# 统一 E2E 测试策略与计划

> **文档版本**: v7.0.0  
> **创建日期**: 2025-07-15  
> **最后更新**: 2025-07-15  
> **文档状态**: 正式版  
> **维护团队**: 质量保障团队

## 1. 概述与目标

### 1.1. 策略目标

本文档定义了基于 **Turborepo** 的 **OAuth2.1 认证授权中心和微服务平台** 的统一端到端（E2E）测试策略。旨在确保 `admin-portal` 与 `oauth-service` 的高质量集成，验证核心业务流程的正确性、安全性和稳定性。

### 1.2. 核心测试原则

- **TDD 优先**: 遵循测试驱动开发，为新功能和修复先编写测试。
- **标准验证**: 严格测试 OAuth2.1 + OIDC 规范和 PKCE 安全机制。
- **真实环境模拟**: 使用 Playwright 在真实浏览器环境中模拟用户操作，并连接到真实的测试数据库。
- **安全驱动**: 重点验证 JWT、RBAC、权限边界等安全相关的功能。
- **自动化与CI/CD**: 所有 E2E 测试必须自动化，并集成到 CI/CD 流程中，作为代码合并的质量门禁。

## 2. 测试架构与技术栈

| 分类         | 工具/框架                         | 描述                                           |
| :----------- | :-------------------------------- | :--------------------------------------------- |
| **测试框架** | Playwright                        | 用于模拟真实用户交互，进行跨浏览器测试。       |
| **测试管理** | Jest (可选)                       | 可与 Playwright 结合，用于运行和管理测试套件。 |
| **辅助工具** | `auth-helpers.ts`, `test-data.ts` | 封装通用操作（如登录）和管理测试数据。         |
| **CI/CD**    | GitHub Actions                    | 自动化执行测试并生成报告。                     |

## 3. 测试环境与数据

### 3.1. 环境配置

- **admin-portal**: `http://localhost:3002`
- **oauth-service**: `http://localhost:3001`
- **数据库**: 使用独立的测试数据库（SQLite 或 MySQL），通过 `pnpm db:seed` 预置测试数据。

### 3.2. 测试数据

- **用户角色**:
  - **系统管理员**: `admin@example.com` / `password123`
  - **用户管理员**: `useradmin@example.com` / `password123`
  - **安全管理员**: `security@example.com` / `password123`
  - **普通用户**: `user@example.com` / `password123`
- **OAuth 客户端**:
  - **Admin Portal Client**: `auth-center-admin-client`
  - **公共测试客户端**: `public-test-client`

## 4. 核心测试场景与用例

### 4.1. 认证授权流程 (Auth Flow)

| 用例ID          | 场景描述                   | 关键步骤                                                                                             | 预期结果                                                                                          | 优先级 |
| :-------------- | :------------------------- | :--------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------ | :----- |
| **TC-AUTH-001** | **匿名用户访问受保护页面** | 1. 清理Cookie<br>2. 访问 `/admin/users`                                                              | 1. 自动重定向到 `/login` 页面。<br>2. 登录页面显示正常。                                          | **P0** |
| **TC-AUTH-002** | **管理员完整登录流程**     | 1. 访问 `/login`<br>2. 点击登录按钮<br>3. 在 `oauth-service` 页面输入管理员凭据<br>4. 提交并同意授权 | 1. 成功重定向到 `/admin` 仪表盘。<br>2. 页面显示管理员信息。                                      | **P0** |
| **TC-AUTH-003** | **Token 过期与刷新**       | 1. 管理员登录<br>2. 手动删除或等待 `access_token` 过期<br>3. 刷新页面或发起API请求                   | 1. 系统应能静默刷新token（如果 `refresh_token` 有效）。<br>2. 如果刷新失败，则重定向到 `/login`。 | **P1** |
| **TC-AUTH-004** | **用户拒绝授权**           | 1. 发起授权请求<br>2. 在同意页面点击“拒绝”                                                           | 1. 重定向回客户端的 `redirect_uri`。<br>2. URL中包含 `error=access_denied` 查询参数。             | **P1** |

### 4.2. 权限控制 (RBAC)

| 用例ID          | 场景描述              | 关键步骤                                                         | 预期结果                                                                 | 优先级 |
| :-------------- | :-------------------- | :--------------------------------------------------------------- | :----------------------------------------------------------------------- | :----- |
| **TC-RBAC-001** | **角色权限-页面访问** | 1. 使用“普通用户”登录<br>2. 尝试直接访问 `/admin/users`          | 1. 页面重定向到 `/unauthorized` 或显示无权限提示。                       | **P0** |
| **TC-RBAC-002** | **角色权限-菜单渲染** | 1. 分别使用不同角色登录（管理员、普通用户）<br>2. 检查侧边栏菜单 | 1. 管理员能看到所有管理菜单。<br>2. 普通用户只看到“仪表盘”和“个人资料”。 | **P0** |
| **TC-RBAC-003** | **角色权限-API访问**  | 1. 使用“普通用户”的token<br>2. 尝试调用 `POST /api/v2/users`     | 1. API返回 `403 Forbidden` 错误。                                        | **P1** |

### 4.3. 管理功能

| 用例ID          | 场景描述           | 关键步骤                                                                                     | 预期结果                                                     | 优先级 |
| :-------------- | :----------------- | :------------------------------------------------------------------------------------------- | :----------------------------------------------------------- | :----- |
| **TC-FUNC-001** | **用户管理 CRUD**  | 1. 管理员登录<br>2. 访问用户管理页面<br>3. 创建、编辑、删除一个测试用户                      | 1. 所有操作成功，列表实时更新。                              | **P1** |
| **TC-FUNC-002** | **角色权限分配**   | 1. 管理员登录<br>2. 访问角色管理页面<br>3. 为“普通用户”角色添加 `menu:system:user:view` 权限 | 1. 分配成功。<br>2. “普通用户”重新登录后能看到用户管理菜单。 | **P1** |
| **TC-FUNC-003** | **客户端密钥轮换** | 1. 管理员登录<br>2. 访问客户端管理<br>3. 为一个机密客户端轮换密钥                            | 1. 成功生成新密钥并仅显示一次。                              | **P2** |

## 5. 测试执行与报告

### 5.1. 执行命令

```bash
# 运行所有 E2E 测试
pnpm --filter admin-portal test:e2e

# 打开 Playwright UI 进行调试
pnpm --filter admin-portal test:e2e:ui

# 查看测试报告
pnpm --filter admin-portal test:e2e:report
```

### 5.2. CI/CD 集成

- **触发时机**: 在每次向 `main` 或 `develop` 分支提交 Pull Request 时自动触发。
- **流程**:
  1. `actions/checkout`
  2. `pnpm install`
  3. `pnpm db:push` (使用测试数据库)
  4. `pnpm build`
  5. `pnpm start:e2e` (后台启动服务)
  6. `pnpm test:e2e`
- **结果**: 测试失败将阻塞代码合并。测试报告作为产物上传，供审查。

## 6. 专项测试策略

针对在分析阶段发现的问题，制定以下专项测试用例，并纳入回归测试套件。

- **TC-FIX-001**: **验证重复布局已删除** - 检查 `/admin` 路由下的页面布局是否唯一且正确。
- **TC-FIX-002**: **验证 `email` 字段** - 根据最终实现，验证 `email` 字段在用户管理和个人资料页面是否按预期工作或被移除。
- **TC-FIX-003**: **验证 `consent` 页面 API 调用** - 拦截网络请求，确认同意页面的 API 调用路径与 `lib/api.ts` 中定义的一致。
