# E2E功能测试设计文档

> **文档版本**: v1.0.0  
> **创建日期**: 2025-01-27  
> **最后更新**: 2025-01-27  
> **文档状态**: 设计版  
> **维护团队**: 测试团队

## 1. 概述

本文档详细描述了基于功能点的E2E测试设计方案。测试覆盖OAuth2.1认证服务、RBAC权限管理、用户管理等核心功能模块，确保系统的完整性和可靠性。

### 1.1 测试目标

- **功能完整性**: 验证所有核心功能按预期工作
- **用户体验**: 确保关键用户场景流畅运行
- **安全性**: 验证认证授权机制正确实施
- **集成性**: 确保各模块间正确协作

### 1.2 测试环境

- **前端**: admin-portal (http://localhost:3002)
- **后端**: oauth-service (http://localhost:3001)
- **浏览器**: Chromium, Firefox, Safari
- **数据**: 使用测试数据库，每次测试前重置

## 2. 功能点拆解与测试用例

### 2.1 OAuth2.1认证流程

#### 功能描述
OAuth2.1授权码流程，包含PKCE、令牌管理、自动刷新等核心认证功能。

#### 测试用例

##### TC-AUTH-001: 首次访问认证流程
**测试目标**: 验证未认证用户的完整认证流程

**前置条件**:
- 用户未登录
- 清空浏览器存储

**测试步骤**:
1. 访问 `/dashboard`
2. 验证自动重定向到 `/auth/login`
3. 输入有效用户名密码
4. 验证重定向到授权页面 `/oauth/consent`
5. 点击"同意授权"
6. 验证重定向回 `/dashboard`
7. 验证localStorage中存储了access_token和refresh_token
8. 验证JWT包含正确的用户信息和权限

**预期结果**:
- 成功完成OAuth2.1授权码流程
- 用户能正常访问dashboard
- 令牌正确存储

##### TC-AUTH-002: 登录失败处理
**测试目标**: 验证错误凭据的处理

**测试步骤**:
1. 访问 `/auth/login`
2. 输入无效用户名密码
3. 点击登录
4. 验证显示错误提示
5. 验证不会重定向
6. 验证localStorage为空

**预期结果**:
- 显示明确的错误信息
- 用户停留在登录页面
- 不会产生令牌

##### TC-AUTH-003: 令牌自动刷新
**测试目标**: 验证access_token过期时的自动刷新机制

**前置条件**:
- 用户已登录
- 存在有效的refresh_token
- access_token即将过期

**测试步骤**:
1. 模拟access_token过期
2. 发起需要认证的API请求
3. 验证自动使用refresh_token获取新令牌
4. 验证API请求成功完成
5. 验证localStorage中更新了新的令牌

**预期结果**:
- 令牌自动刷新成功
- 用户无感知继续操作
- 新令牌正确存储

##### TC-AUTH-004: 退出登录
**测试目标**: 验证用户主动退出流程

**测试步骤**:
1. 用户已登录状态
2. 点击退出按钮
3. 验证localStorage被清空
4. 验证重定向到登录页面
5. 尝试访问受保护页面
6. 验证被重定向到登录页面

**预期结果**:
- 成功清除认证状态
- 无法访问受保护资源

### 2.2 用户管理功能

#### 功能描述
管理员对系统用户进行CRUD操作，包括用户创建、编辑、删除、角色分配等。

#### 测试用例

##### TC-USER-001: 用户列表查看
**测试目标**: 验证用户列表的正确显示

**前置条件**:
- 管理员已登录
- 具有 `menu:system:user:view` 和 `user:list` 权限

**测试步骤**:
1. 访问 `/admin/users`
2. 验证页面正常加载
3. 验证用户列表正确显示
4. 验证表格包含必要字段: username, displayName, organization, isActive, createdAt
5. 验证分页功能正常
6. 验证搜索功能正常

**预期结果**:
- 用户列表正确显示
- 所有功能正常工作

##### TC-USER-002: 创建新用户
**测试目标**: 验证用户创建功能

**前置条件**:
- 管理员已登录
- 具有 `user:create` 权限

**测试步骤**:
1. 在用户管理页面点击"创建用户"
2. 填写用户表单:
   - username: "testuser001"
   - password: "Test@123456"
   - displayName: "测试用户001"
   - organization: "测试部门"
3. 点击保存
4. 验证成功提示
5. 验证用户列表中出现新用户
6. 验证新用户可以正常登录

**预期结果**:
- 用户创建成功
- 新用户信息正确
- 新用户可正常使用

##### TC-USER-003: 编辑用户信息
**测试目标**: 验证用户信息编辑功能

**测试步骤**:
1. 在用户列表中选择一个用户
2. 点击"编辑"按钮
3. 修改用户信息:
   - displayName: "更新后的显示名"
   - organization: "新部门"
4. 点击保存
5. 验证成功提示
6. 验证用户列表中信息已更新

**预期结果**:
- 用户信息更新成功
- 更改立即生效

##### TC-USER-004: 删除用户
**测试目标**: 验证用户删除功能

**测试步骤**:
1. 在用户列表中选择一个测试用户
2. 点击"删除"按钮
3. 在确认对话框中点击"确认删除"
4. 验证成功提示
5. 验证用户从列表中消失
6. 验证被删除用户无法登录

**预期结果**:
- 用户删除成功
- 被删除用户无法访问系统

##### TC-USER-005: 用户角色分配
**测试目标**: 验证为用户分配角色的功能

**测试步骤**:
1. 编辑一个用户
2. 在角色分配区域选择角色
3. 保存更改
4. 验证用户权限已更新
5. 使用该用户登录
6. 验证可以访问对应权限的功能

**预期结果**:
- 角色分配成功
- 用户权限正确更新

### 2.3 角色管理功能

#### 功能描述
管理系统角色，包括角色的CRUD操作和权限分配。

#### 测试用例

##### TC-ROLE-001: 角色列表查看
**测试目标**: 验证角色列表的正确显示

**前置条件**:
- 管理员已登录
- 具有 `menu:system:role:view` 和 `role:list` 权限

**测试步骤**:
1. 访问 `/admin/roles`
2. 验证页面正常加载
3. 验证角色列表正确显示
4. 验证表格包含必要字段: name, description, permissions count, createdAt
5. 验证搜索功能正常

**预期结果**:
- 角色列表正确显示
- 所有功能正常工作

##### TC-ROLE-002: 创建新角色
**测试目标**: 验证角色创建功能

**测试步骤**:
1. 点击"创建角色"
2. 填写角色信息:
   - name: "测试角色"
   - description: "用于测试的角色"
3. 选择权限
4. 保存角色
5. 验证角色创建成功
6. 验证角色出现在列表中

**预期结果**:
- 角色创建成功
- 权限正确分配

##### TC-ROLE-003: 角色权限管理
**测试目标**: 验证角色权限的分配和移除

**测试步骤**:
1. 编辑一个角色
2. 添加新权限
3. 移除现有权限
4. 保存更改
5. 验证权限更改生效
6. 验证拥有该角色的用户权限相应更新

**预期结果**:
- 权限分配正确
- 用户权限实时更新

### 2.4 客户端管理功能

#### 功能描述
管理OAuth客户端配置，包括客户端的注册、配置更新等。

#### 测试用例

##### TC-CLIENT-001: 客户端列表查看
**测试目标**: 验证OAuth客户端列表显示

**测试步骤**:
1. 访问 `/admin/clients`
2. 验证显示所有已注册的OAuth客户端
3. 验证admin-portal客户端存在
4. 验证客户端信息完整

**预期结果**:
- 客户端列表正确显示
- admin-portal客户端配置正确

##### TC-CLIENT-002: 客户端配置管理
**测试目标**: 验证客户端配置的更新功能

**测试步骤**:
1. 编辑admin-portal客户端
2. 更新重定向URI
3. 更新权限范围
4. 保存配置
5. 验证配置更新成功
6. 验证OAuth流程仍然正常工作

**预期结果**:
- 配置更新成功
- OAuth流程不受影响

### 2.5 权限验证功能

#### 功能描述
验证基于RBAC的权限控制是否正确实施。

#### 测试用例

##### TC-PERM-001: 菜单权限控制
**测试目标**: 验证菜单级别的权限控制

**测试步骤**:
1. 使用不同权限的用户登录
2. 验证只显示有权限的菜单项
3. 验证无权限菜单项不显示
4. 尝试直接访问无权限页面URL
5. 验证被拒绝访问

**预期结果**:
- 菜单权限控制正确
- 无权限页面无法访问

##### TC-PERM-002: API权限控制
**测试目标**: 验证API级别的权限控制

**测试步骤**:
1. 使用有限权限的用户登录
2. 尝试调用无权限的API
3. 验证返回403错误
4. 调用有权限的API
5. 验证正常返回

**预期结果**:
- API权限控制正确
- 无权限操作被阻止

### 2.6 个人资料管理

#### 功能描述
用户管理自己的个人信息和密码。

#### 测试用例

##### TC-PROFILE-001: 查看个人资料
**测试目标**: 验证个人资料页面显示

**测试步骤**:
1. 访问 `/profile`
2. 验证显示当前用户信息
3. 验证信息准确性

**预期结果**:
- 个人信息正确显示

##### TC-PROFILE-002: 更新个人信息
**测试目标**: 验证个人信息更新功能

**测试步骤**:
1. 修改显示名称
2. 保存更改
3. 验证更新成功
4. 验证界面显示更新后的信息

**预期结果**:
- 个人信息更新成功

##### TC-PROFILE-003: 修改密码
**测试目标**: 验证密码修改功能

**测试步骤**:
1. 在个人资料页面点击"修改密码"
2. 输入当前密码和新密码
3. 保存更改
4. 退出登录
5. 使用新密码登录
6. 验证登录成功

**预期结果**:
- 密码修改成功
- 新密码可正常使用

### 2.7 仪表盘功能

#### 功能描述
显示系统概览信息和用户可访问的功能入口。

#### 测试用例

##### TC-DASHBOARD-001: 仪表盘显示
**测试目标**: 验证仪表盘正确显示

**测试步骤**:
1. 登录后访问 `/dashboard`
2. 验证页面正常加载
3. 验证显示用户权限范围内的信息
4. 验证快捷操作链接正常

**预期结果**:
- 仪表盘正确显示
- 权限控制正确

## 3. 测试数据准备

### 3.1 测试用户

| 用户名 | 密码 | 角色 | 权限范围 |
|--------|------|------|----------|
| admin | Admin@123 | 超级管理员 | 所有权限 |
| manager | Manager@123 | 管理员 | 用户管理、角色管理 |
| user | User@123 | 普通用户 | 仅个人资料 |
| readonly | Readonly@123 | 只读用户 | 查看权限 |

### 3.2 测试角色

| 角色名 | 描述 | 权限 |
|--------|------|------|
| super_admin | 超级管理员 | 所有权限 |
| admin | 管理员 | 用户管理、角色管理、客户端管理 |
| user | 普通用户 | dashboard:view, profile:view, profile:update |
| readonly | 只读用户 | 查看类权限 |

## 4. 测试执行策略

### 4.1 测试顺序

1. **认证流程测试** - 确保基础认证功能正常
2. **权限验证测试** - 验证权限控制机制
3. **用户管理测试** - 测试用户CRUD操作
4. **角色管理测试** - 测试角色和权限管理
5. **客户端管理测试** - 测试OAuth客户端管理
6. **个人资料测试** - 测试用户自服务功能
7. **集成测试** - 验证各模块协作

### 4.2 测试环境准备

每次测试执行前:
1. 重置测试数据库
2. 启动所有服务
3. 验证服务健康状态
4. 清理浏览器缓存

### 4.3 失败处理

- 截图保存失败场景
- 记录详细错误日志
- 保存网络请求信息
- 生成测试报告

## 5. 自动化实现

### 5.1 测试框架

- **工具**: Playwright
- **语言**: TypeScript
- **报告**: HTML报告 + JSON结果
- **CI/CD**: GitHub Actions集成

### 5.2 页面对象模式

每个页面创建对应的Page Object类:
- `LoginPage`
- `DashboardPage`
- `UserManagementPage`
- `RoleManagementPage`
- `ClientManagementPage`
- `ProfilePage`

### 5.3 测试工具类

- `AuthHelper` - 认证相关操作
- `DataHelper` - 测试数据管理
- `ApiHelper` - API调用封装
- `PermissionHelper` - 权限验证工具

## 6. 验收标准

### 6.1 功能验收

- [ ] 所有核心功能测试通过
- [ ] 权限控制正确实施
- [ ] 用户体验流畅
- [ ] 错误处理恰当

### 6.2 性能验收

- [ ] 页面加载时间 < 2秒
- [ ] API响应时间 < 500ms
- [ ] 认证流程 < 3秒

### 6.3 安全验收

- [ ] 无权限访问被阻止
- [ ] 敏感信息不泄露
- [ ] CSRF攻击防护有效
- [ ] JWT令牌安全处理

## 7. 维护计划

### 7.1 定期更新

- 每月回顾测试用例覆盖度
- 根据新功能更新测试用例
- 优化测试执行效率
- 更新测试数据

### 7.2 监控指标

- 测试通过率
- 测试执行时间
- 缺陷发现率
- 回归测试覆盖度

---

**文档结束**

> 本文档将随着项目发展持续更新，确保测试用例与实际功能保持同步。