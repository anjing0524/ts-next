# Admin-Portal 与 OAuth-Service 集成 E2E 测试策略

> **文档版本**: v1.0.0  
> **创建日期**: 2025-01-28  
> **最后更新**: 2025-01-28  
> **文档状态**: 正式版 - 用于指导集成测试  
> **维护团队**: 测试团队

## 1. 概述

本文档定义了 admin-portal 与 oauth-service 集成的端到端测试策略。测试将验证两个服务之间的完整OAuth2.1认证流程、权限管理和功能集成。

## 2. 测试目标

### 2.1 主要目标
- 验证 admin-portal 与 oauth-service 的完整集成
- 确保 OAuth2.1 认证流程正常工作
- 验证 RBAC 权限系统在集成环境中的正确性
- 确保所有管理页面在集成环境中可正常访问
- 验证生产模式下的服务稳定性

### 2.2 测试范围
- **认证流程测试**: OAuth2.1 授权码流程
- **权限管理测试**: RBAC 角色和权限验证
- **页面功能测试**: 所有管理页面的可访问性和功能
- **API集成测试**: admin-portal 与 oauth-service API 的交互
- **生产模式测试**: 构建后的服务在生产环境中的表现

## 3. 测试环境配置

### 3.1 服务配置
```bash
# admin-portal 配置
NEXT_PUBLIC_OAUTH_SERVICE_URL=http://localhost:3001
NEXT_PUBLIC_ADMIN_PORTAL_URL=http://localhost:3002

# oauth-service 配置
AUTH_CENTER_LOGIN_PAGE_URL=http://localhost:3002/auth/login
AUTH_CENTER_REDIRECT_URI=http://localhost:3002/auth/callback
```

### 3.2 数据库配置
- SQLite 数据库文件: `packages/database/prisma/dev.db`
- 已初始化基础数据: 用户、角色、权限

## 4. 测试用例设计

### 4.1 服务健康检查测试
**测试用例**: TC-001-服务健康检查
- **目标**: 验证两个服务都能正常响应
- **步骤**:
  1. 访问 oauth-service 健康检查端点
  2. 访问 admin-portal 健康检查端点
- **预期结果**: 两个服务都返回 200 状态码和正常响应

### 4.2 OAuth认证流程测试
**测试用例**: TC-002-OAuth认证流程
- **目标**: 验证完整的OAuth2.1授权码流程
- **步骤**:
  1. 访问 admin-portal 登录页面
  2. 重定向到 oauth-service 授权页面
  3. 完成用户认证
  4. 重定向回 admin-portal 回调页面
  5. 验证访问令牌获取
- **预期结果**: 成功完成认证流程，获取有效访问令牌

### 4.3 页面访问权限测试
**测试用例**: TC-003-页面访问权限
- **目标**: 验证不同角色用户对页面的访问权限
- **步骤**:
  1. 使用管理员角色登录
  2. 访问用户管理页面
  3. 访问角色管理页面
  4. 访问权限管理页面
  5. 使用普通用户角色登录
  6. 验证权限限制
- **预期结果**: 管理员可以访问所有页面，普通用户只能访问授权页面

### 4.4 API集成测试
**测试用例**: TC-004-API集成
- **目标**: 验证 admin-portal 与 oauth-service API 的交互
- **步骤**:
  1. 获取有效访问令牌
  2. 调用 oauth-service 用户信息API
  3. 调用 oauth-service 权限验证API
  4. 验证API响应正确性
- **预期结果**: API调用成功，返回正确的用户和权限信息

### 4.5 错误处理测试
**测试用例**: TC-005-错误处理
- **目标**: 验证系统对异常情况的处理
- **步骤**:
  1. 使用无效令牌访问受保护页面
  2. 访问不存在的页面
  3. 使用过期令牌
- **预期结果**: 系统正确处理错误，显示适当的错误页面

## 5. 测试执行计划

### 5.1 测试环境准备
1. 启动 oauth-service (端口 3001)
2. 启动 admin-portal (端口 3002)
3. 验证数据库连接
4. 确认基础数据已加载

### 5.2 测试执行顺序
1. 服务健康检查测试
2. OAuth认证流程测试
3. 页面访问权限测试
4. API集成测试
5. 错误处理测试

### 5.3 测试数据准备
- 管理员用户: admin@example.com / password123
- 普通用户: user@example.com / password123
- 测试角色: admin, user, guest

## 6. 测试报告

### 6.1 测试指标
- **测试覆盖率**: 目标 90% 以上
- **通过率**: 目标 100%
- **响应时间**: 页面加载 < 3秒，API响应 < 1秒

### 6.2 测试报告模板
```markdown
# 集成测试报告

## 测试概览
- 测试日期: [日期]
- 测试环境: [环境信息]
- 测试版本: [版本号]

## 测试结果
- 总测试用例: [数量]
- 通过: [数量]
- 失败: [数量]
- 跳过: [数量]

## 详细结果
[详细测试结果]

## 问题汇总
[发现的问题和解决方案]
```

## 7. 持续集成

### 7.1 自动化测试
- 每次代码提交触发E2E测试
- 测试失败阻止部署
- 生成测试报告和覆盖率报告

### 7.2 监控和告警
- 服务健康状态监控
- API响应时间监控
- 错误率监控 