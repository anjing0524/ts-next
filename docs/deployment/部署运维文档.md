# 部署与运维指南

> **文档版本**: v1.0.0
> **最后更新**: 2025-11-11

## 概述

本文档为`ts-next-template`项目提供了全面的部署和运维指南，涵盖了从环境准备到生产部署、监控和故障排查的各个方面。

## 1. 环境准备

### 必需软件
- **Docker**: v24.0+
- **Docker Compose**: v2.0+
- **Node.js**: 20.x+ (用于本地开发)
- **Rust**: 1.70+ (用于本地开发)
- **pnpm**: 8.x+ (用于本地开发)

## 2. 生产部署 (Docker Compose)

这是推荐的生产环境部署方式，使用Docker Compose来编排所有服务。

### 2.1. `docker-compose.yml` 文件

在项目根目录下创建一个 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  pingora-proxy:
    build:
      context: ./apps/pingora-proxy
      dockerfile: Dockerfile
    ports:
      - "6188:6188"
    depends_on:
      - oauth-service-rust
      - admin-portal
    networks:
      - app-network
    restart: unless-stopped

  oauth-service-rust:
    build:
      context: .
      dockerfile: apps/oauth-service-rust/Dockerfile
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/oauth_db
      - JWT_PRIVATE_KEY_PATH=/app/keys/private.pem
      - JWT_PUBLIC_KEY_PATH=/app/keys/public.pem
    volumes:
      - ./keys:/app/keys:ro
    depends_on:
      - postgres
    networks:
      - app-network
    restart: unless-stopped

  admin-portal:
    build:
      context: .
      dockerfile: apps/admin-portal/Dockerfile
    ports:
      - "3002:3002"
    environment:
      - NEXT_PUBLIC_OAUTH_SERVICE_URL=http://oauth-service-rust:3001
    depends_on:
      - oauth-service-rust
    networks:
      - app-network
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=oauth_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - app-network
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  app-network:
    driver: bridge
```

### 2.2. 环境变量

在项目根目录创建一个 `.env` 文件来管理敏感信息：

```env
# JWT 密钥等敏感信息
JWT_SECRET=your-super-secret-jwt-key
```

### 2.3. 启动服务

```bash
# 构建并以后台模式启动所有服务
docker-compose up --build -d

# 查看服务状态
docker-compose ps

# 查看特定服务的日志
docker-compose logs -f oauth-service-rust
```

### 2.4. 停止服务

```bash
# 停止并移除容器
docker-compose down

# 停止并移除容器和数据卷
docker-compose down -v
```

## 3. 监控

### 3.1. 健康检查

每个服务都提供一个健康检查端点：

- **pingora-proxy**: `http://localhost:6188/health`
- **oauth-service-rust**: `http://localhost:3001/health`
- **admin-portal**: `http://localhost:3002/api/health`

### 3.2. Prometheus 指标

如果集成了Prometheus，可以从以下端点获取指标：

- **pingora-proxy**: `/metrics`
- **oauth-service-rust**: `/metrics`

## 4. 故障排查

### 4.1. 服务无法访问

1.  **检查容器状态**: `docker-compose ps`，确保所有服务的状态都是 `Up`。
2.  **检查代理日志**: `docker-compose logs -f pingora-proxy`，查看是否有路由错误或上游服务连接失败的日志。
3.  **检查上游服务日志**: `docker-compose logs -f oauth-service-rust` 或 `docker-compose logs -f admin-portal`，查找启动错误或运行时异常。
4.  **网络检查**: 确保Docker容器网络 `app-network` 工作正常，并且服务之间可以相互通信。

### 4.2. 认证失败 (401/403错误)

1.  **检查`oauth-service-rust`日志**: `docker-compose logs -f oauth-service-rust`，查找JWT验证失败、权限不足等相关错误。
2.  **验证JWT密钥**: 确保传递给`oauth-service-rust`容器的JWT密钥是正确的，并且与`admin-portal`或其他客户端使用的公钥匹配。
3.  **检查数据库**: 确认用户、角色、权限数据是否正确。

### 4.3. 数据库问题

1.  **检查`postgres`容器日志**: `docker-compose logs -f postgres`，查看是否有数据库错误。
2.  **连接数据库**: 使用任何PostgreSQL客户端连接到 `localhost:5432`，用户 `user`，密码 `password`，数据库 `oauth_db`，检查数据是否完整。
3.  **检查数据卷**: `docker volume inspect ts-next-template_postgres_data`，确保数据卷存在且正常。

## 5. 维护

### 5.1. 数据库备份

```bash
# 执行数据库备份
docker-compose exec -T postgres pg_dump -U user -d oauth_db > backup.sql

# 恢复数据库
cat backup.sql | docker-compose exec -T postgres psql -U user -d oauth_db
```

### 5.2. 更新服务

1.  **拉取最新代码**: `git pull origin main`
2.  **重新构建镜像**: `docker-compose build <service_name>` (例如 `oauth-service-rust`)
3.  **重启服务**: `docker-compose up -d --no-deps <service_name>`

或者，直接运行 `docker-compose up --build -d` 来重新构建并重启所有有变动的服务。
