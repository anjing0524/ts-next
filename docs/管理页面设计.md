# ç®¡ç†é¡µé¢è®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v4.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-06-27  
> **æœ€åæ›´æ–°**: 2025-06-27  
> **æ–‡æ¡£çŠ¶æ€**: æ­£å¼ç‰ˆ  
> **ç»´æŠ¤å›¢é˜Ÿ**: å‰ç«¯å›¢é˜Ÿ

## æŠ€æœ¯æ¶æ„ä¸å®šä½

**æ ¸å¿ƒå®šä½**:

- âœ… **å¾®æœåŠ¡ç®¡ç†ä¸­å¿ƒ**: ä½œä¸º Turborepo Monorepo å¾®æœåŠ¡æ¶æ„çš„ç»Ÿä¸€ç®¡ç†å…¥å£
- âœ… **OAuth2.1 å®¢æˆ·ç«¯**: ä½œä¸º `oauth-service` çš„æ ‡å‡† OAuth2.1 å®¢æˆ·ç«¯ï¼Œå®Œå…¨éµå¾ªæˆæƒæµç¨‹
- âœ… **ç°ä»£åŒ–æŠ€æœ¯æ ˆ**: åŸºäº Next.js 15.3.2 + React 19 + shadcn/ui + Tailwind CSS 4.1.5
- âœ… **ä¼ä¸šçº§ RBAC**: æ”¯æŒå››çº§æƒé™æ§åˆ¶ï¼ˆèœå•ã€APIã€æ•°æ®ã€æ“ä½œï¼‰
- âœ… **å“åº”å¼è®¾è®¡**: æ”¯æŒæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯è®¿é—®

**æŠ€æœ¯ç‰¹è‰²**:

- ğŸ¨ **shadcn/ui ç»„ä»¶åº“**: åŸºäº Radix UI çš„ç°ä»£åŒ–ç»„ä»¶ç³»ç»Ÿ
- ğŸ” **å¼ºåˆ¶ PKCE**: æ‰€æœ‰ OAuth2.1 æµç¨‹å¼ºåˆ¶ä½¿ç”¨ PKCE (S256)
- ğŸ“Š **æ•°æ®è¡¨æ ¼**: @tanstack/react-table é«˜æ€§èƒ½æ•°æ®å±•ç¤º
- ğŸ¯ **ç±»å‹å®‰å…¨**: 100% TypeScript 5 ä¸¥æ ¼æ¨¡å¼
- ğŸš€ **æ€§èƒ½ä¼˜åŒ–**: Next.js 15 App Router + React 19 å¹¶å‘ç‰¹æ€§

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† `admin-portal` åº”ç”¨ï¼ˆç«¯å£: 3002ï¼‰çš„é¡µé¢åŠŸèƒ½å’Œå®ç°å®Œæ•´æ€§ã€‚`admin-portal` æ˜¯æ•´ä¸ª OAuth2.1 è®¤è¯æˆæƒä¸­å¿ƒå’Œå¾®æœåŠ¡å¹³å°çš„æ ¸å¿ƒç®¡ç†ç•Œé¢ï¼Œè´Ÿè´£ç”¨æˆ·ç®¡ç†ã€è§’è‰²æƒé™åˆ†é…ã€OAuthå®¢æˆ·ç«¯ç®¡ç†ã€ç³»ç»Ÿç›‘æ§ç­‰åŠŸèƒ½ã€‚å®ƒä¸¥æ ¼éµå¾ª OAuth2.1 + å¼ºåˆ¶ PKCE æ ‡å‡†ä¸ `oauth-service` è¿›è¡Œå®‰å…¨é€šä¿¡ï¼Œä¸ºç®¡ç†å‘˜æä¾›å¼ºå¤§è€Œå®‰å…¨çš„æ“ä½œä½“éªŒã€‚

## å½“å‰å®ç°çŠ¶æ€

### å·²å®ç°çš„é¡µé¢

#### 1. è®¤è¯ç›¸å…³é¡µé¢

##### ç™»å½•é¡µé¢ (`/login`)

- **æ–‡ä»¶**: `apps/admin-portal/app/login/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ç”¨æˆ·å/å¯†ç ç™»å½•è¡¨å•
  - Zod è¡¨å•éªŒè¯
  - PKCE æ”¯æŒï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰
  - OAuth æµç¨‹é›†æˆ
  - é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - æ”¯æŒå†…éƒ¨ç®¡ç†å‘˜è®¿é—®å’Œå¤–éƒ¨ OAuth å®¢æˆ·ç«¯
  - å®Œæ•´çš„ PKCE å®ç°ï¼ˆcode_verifier å’Œ code_challengeï¼‰
  - å“åº”å¼ UI è®¾è®¡

##### OAuth æˆæƒåŒæ„é¡µé¢ (`/oauth/consent`)

- **æ–‡ä»¶**: `apps/admin-portal/app/oauth/consent/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - æ˜¾ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„æƒé™èŒƒå›´
  - ç”¨æˆ·æˆæƒç¡®è®¤ç•Œé¢
  - æ”¯æŒæˆæƒ/æ‹’ç»æ“ä½œ
  - å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - ç°ä»£åŒ– UI è®¾è®¡
  - æƒé™èŒƒå›´æ ¼å¼åŒ–æ˜¾ç¤º
  - è¡¨å•æäº¤åˆ° `/api/oauth/consent`

##### è®¤è¯å›è°ƒé¡µé¢ (`/auth/callback`)

- **æ–‡ä»¶**: `apps/admin-portal/app/auth/callback/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - å¤„ç† OAuth æˆæƒç äº¤æ¢
  - PKCE éªŒè¯
  - Token å­˜å‚¨å’Œç®¡ç†
  - é”™è¯¯å¤„ç†å’Œé‡å®šå‘
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - å®Œæ•´çš„æˆæƒç æµç¨‹å¤„ç†
  - å®‰å…¨çš„ token å­˜å‚¨ï¼ˆcookie + sessionStorageï¼‰
  - åŠ è½½çŠ¶æ€å’Œé”™è¯¯çŠ¶æ€å¤„ç†

##### æœªæˆæƒè®¿é—®é¡µé¢ (`/unauthorized`)

- **æ–‡ä»¶**: `apps/admin-portal/app/unauthorized/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - æ˜¾ç¤ºæƒé™ä¸è¶³ä¿¡æ¯
  - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å±•ç¤º
  - è¿”å›é¦–é¡µé“¾æ¥
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - æ”¯æŒå¤šç§é”™è¯¯ç±»å‹æ˜¾ç¤º
  - åŠ¨æ€é”™è¯¯æ¶ˆæ¯ç”Ÿæˆ
  - ç”¨æˆ·å‹å¥½çš„ç•Œé¢è®¾è®¡

#### 2. ç®¡ç†é¡µé¢

##### ç®¡ç†å‘˜æ§åˆ¶å° (`/admin`)

- **æ–‡ä»¶**: `apps/admin-portal/app/admin/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæ•´
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ç”¨æˆ·ç®¡ç†ï¼ˆCRUD æ“ä½œï¼‰
  - è§’è‰²ç®¡ç†ï¼ˆCRUD æ“ä½œï¼‰
  - æƒé™ç®¡ç†ï¼ˆCRUD æ“ä½œï¼‰
  - OAuth å®¢æˆ·ç«¯ç®¡ç†ï¼ˆCRUD æ“ä½œï¼‰
  - OAuth ä½œç”¨åŸŸç®¡ç†ï¼ˆCRUD æ“ä½œï¼‰
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - å®Œæ•´çš„çŠ¶æ€ç®¡ç†
  - æ¨¡æ€æ¡†æ“ä½œç•Œé¢
  - æ•°æ®è¡¨æ ¼å±•ç¤º
  - è¡¨å•éªŒè¯

##### ç”¨æˆ·ç®¡ç†é¡µé¢ (`/admin/users`)

- **æ–‡ä»¶**: `apps/admin-portal/app/(dashboard)/admin/users/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ä» `/api/v2/users` è·å–å¹¶å±•ç¤ºç”¨æˆ·åˆ—è¡¨
  - ä½¿ç”¨ TanStack Table å®ç°åˆ†é¡µã€æ’åºå’Œè¿‡æ»¤
  - æä¾›ç”¨æˆ·æ“ä½œï¼ˆæŸ¥çœ‹è¯¦æƒ…ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰çš„å…¥å£
  - å®Œæ•´çš„åŠ è½½å’Œé”™è¯¯çŠ¶æ€å¤„ç†
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - ä¸ `useAuth` é’©å­é›†æˆï¼Œç¡®ä¿è®¤è¯å’Œæƒé™
  - æ¨¡å—åŒ–çš„åˆ—å®šä¹‰ (`columns.tsx`)
  - å“åº”å¼æ•°æ®è¡¨æ ¼

##### å®¡è®¡æ—¥å¿—é¡µé¢ (`/admin/audit`)

- **æ–‡ä»¶**: `apps/admin-portal/app/(dashboard)/admin/audit/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ä» `/api/v2/audit-logs` è·å–å¹¶å±•ç¤ºå®¡è®¡æ—¥å¿—
  - æ ¹æ®æ“ä½œç±»å‹ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰æ˜¾ç¤ºä¸åŒé¢œè‰²çš„å¾½ç« 
  - æä¾›æ—¥å¿—è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - å®æ—¶æ•°æ®è·å–å’Œå±•ç¤º
  - è‡ªå®šä¹‰è¡¨æ ¼åˆ—æ¸²æŸ“
  - é«˜æ•ˆçš„æ•°æ®åˆ†é¡µå’Œè¿‡æ»¤

##### ç®¡ç†å‘˜å¸ƒå±€ (`/admin/layout`)

- **æ–‡ä»¶**: `apps/admin-portal/app/admin/layout.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ä¾§è¾¹æ å¯¼èˆª
  - å¤´éƒ¨ç»„ä»¶
  - å“åº”å¼å¸ƒå±€
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - Suspense åŠ è½½å¤„ç†
  - æ¨¡å—åŒ–ç»„ä»¶è®¾è®¡

##### å®¢æˆ·ç«¯æ³¨å†Œé¡µé¢ (`/clients/register`)

- **æ–‡ä»¶**: `apps/admin-portal/app/clients/register/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - OAuth å®¢æˆ·ç«¯æ³¨å†Œè¡¨å•
  - Zod è¡¨å•éªŒè¯
  - é‡å®šå‘ URI éªŒè¯
  - JWKS URI é…ç½®
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - å®Œæ•´çš„è¡¨å•éªŒè¯é€»è¾‘
  - ç°ä»£åŒ– UI è®¾è®¡
  - é”™è¯¯å¤„ç†å’ŒæˆåŠŸåé¦ˆ

##### ä»ªè¡¨æ¿é¡µé¢ (`/dashboard`)

- **æ–‡ä»¶**: `apps/admin-portal/app/dashboard/page.tsx`
- **åŠŸèƒ½çŠ¶æ€**: âŒ å·²å¼ƒç”¨
- **è¯´æ˜**: æ­¤é¡µé¢å·²è¢«ç§»é™¤ã€‚å…¶æ ¸å¿ƒåŠŸèƒ½ï¼ˆç”¨æˆ·åˆ—è¡¨å±•ç¤ºï¼‰å·²è¿ç§»å¹¶æ•´åˆåˆ° `/admin/users` é¡µé¢ä¸­ï¼Œä»¥å®ç°æ›´ç»Ÿä¸€çš„ç®¡ç†ä½“éªŒã€‚

#### 3. æ”¯æŒç»„ä»¶

##### ç®¡ç†å‘˜ä¾§è¾¹æ  (`components/admin/sidebar.tsx`)

- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - åŸºäºæƒé™çš„èœå•è¿‡æ»¤
  - åŠ¨æ€å¯¼èˆªèœå•
  - ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
- **èœå•é¡¹**:
  - ç³»ç»Ÿç®¡ç†ï¼ˆç”¨æˆ·ã€è§’è‰²ã€æƒé™ã€å®¢æˆ·ç«¯ã€ä½œç”¨åŸŸã€å®¡è®¡æ—¥å¿—ï¼‰
  - æƒé™æ§åˆ¶é›†æˆ

##### ç®¡ç†å‘˜å¤´éƒ¨ (`components/admin/header.tsx`)

- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
  - ç™»å‡ºåŠŸèƒ½
  - åŠ è½½çŠ¶æ€å¤„ç†

#### 4. è®¤è¯ Hook

##### useAuth Hook (`hooks/useAuth.ts`)

- **åŠŸèƒ½çŠ¶æ€**: âœ… å®Œæ•´å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**:
  - ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†
  - Token å­˜å‚¨å’Œæ£€ç´¢ (Cookie + LocalStorage)
  - æƒé™æ£€æŸ¥åŠŸèƒ½
  - ç™»å½•/ç™»å‡ºæ“ä½œ
  - Token åˆ·æ–°æœºåˆ¶
- **æŠ€æœ¯ç‰¹ç‚¹**:
  - è¿æ¥çœŸå® API (`/api/v2/users/me`, `/api/v2/oauth/token`)
  - å®‰å…¨çš„ Token å­˜å‚¨ç­–ç•¥
  - è‡ªåŠ¨åŒ–çš„ Token åˆ·æ–°
  - React hooks æ¨¡å¼

## å®Œæ•´æ€§è¯„ä¼°

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

1. **è®¤è¯æµç¨‹**

   - å®Œæ•´çš„ OAuth 2.0 + PKCE æµç¨‹
   - ç”¨æˆ·ç™»å½•/ç™»å‡º
   - æˆæƒåŒæ„é¡µé¢
   - è®¤è¯å›è°ƒå¤„ç†
   - æœªæˆæƒè®¿é—®å¤„ç†

2. **ç®¡ç†åŠŸèƒ½**

   - ç”¨æˆ·ç®¡ç†ç•Œé¢
   - è§’è‰²å’Œæƒé™ç®¡ç†
   - OAuth å®¢æˆ·ç«¯ç®¡ç†
   - OAuth ä½œç”¨åŸŸç®¡ç†
   - å®¢æˆ·ç«¯æ³¨å†ŒåŠŸèƒ½

3. **UI/UX è®¾è®¡**
   - ç°ä»£åŒ–çš„ç•Œé¢è®¾è®¡
   - å“åº”å¼å¸ƒå±€
   - ä¸€è‡´çš„ç»„ä»¶é£æ ¼
   - é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€

### âš ï¸ éœ€è¦æ”¹è¿›çš„åŠŸèƒ½

1. **æ•°æ®è·å–**

   - ç®¡ç†é¡µé¢å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œéœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„APIè°ƒç”¨ã€‚
   - éœ€è¦åœ¨æ‰€æœ‰æ•°æ®è·å–ç‚¹å®ç°åŠ è½½ï¼ˆloadingï¼‰å’Œé”™è¯¯ï¼ˆerrorï¼‰çŠ¶æ€çš„å®Œæ•´å¤„ç†ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
   - å®¡è®¡æ—¥å¿—åŠŸèƒ½å°šæœªå®Œå…¨å®ç°ï¼Œéœ€è¦æ·»åŠ ç›¸åº”çš„é¡µé¢å’ŒAPIè°ƒç”¨ã€‚

2. **æƒé™ç³»ç»Ÿé›†æˆ**
   - æƒé™æ£€æŸ¥é€»è¾‘éœ€è¦å®Œå–„
   - èœå•æƒé™è¿‡æ»¤éœ€è¦å®é™…å®ç°
   - é¡µé¢çº§æƒé™æ§åˆ¶

### âŒ ç¼ºå¤±çš„åŠŸèƒ½

1. **é«˜çº§ç®¡ç†åŠŸèƒ½**

   - å®¡è®¡æ—¥å¿—æŸ¥çœ‹é¡µé¢
   - ç³»ç»Ÿé…ç½®ç®¡ç†
   - æ‰¹é‡æ“ä½œåŠŸèƒ½

2. **ç›‘æ§å’Œç»Ÿè®¡**

   - ç³»ç»Ÿä½¿ç”¨ç»Ÿè®¡
   - æ€§èƒ½ç›‘æ§é¢æ¿
   - é”™è¯¯æ—¥å¿—æŸ¥çœ‹

3. **ä¸ªäººèµ„æ–™ç®¡ç†**
   - ç”¨æˆ·ä¸ªäººèµ„æ–™ç¼–è¾‘
   - å¯†ç ä¿®æ”¹é¡µé¢
   - å¤´åƒä¸Šä¼ åŠŸèƒ½

## ä¼˜åŒ–å»ºè®®

### 1. è®¤è¯ç³»ç»Ÿä¼˜åŒ–

#### å®ç°çœŸå®çš„ useAuth Hook

```typescript
// hooks/useAuth.ts - ç”Ÿäº§ç‰ˆæœ¬ç¤ºä¾‹
export function useAuth() {
  const [authState, setAuthState] = useState<AuthState>({
    user: null,
    token: null,
    isLoading: true,
    error: null,
  });

  const fetchUserProfile = useCallback(async (token: string) => {
    try {
      const response = await fetch('/api/v2/auth/me', {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch user profile');
      }

      const userData = await response.json();
      setAuthState({
        user: userData.data,
        token,
        isLoading: false,
        error: null,
      });
    } catch (error) {
      console.error('Failed to fetch user profile:', error);
      setAuthState({
        user: null,
        token: null,
        isLoading: false,
        error: 'Failed to load user data',
      });
    }
  }, []);

  // Token åˆ·æ–°é€»è¾‘
  const refreshToken = useCallback(async () => {
    const refreshToken = sessionStorage.getItem('refresh_token');
    if (!refreshToken) return false;

    try {
      const response = await fetch('/api/v2/oauth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          grant_type: 'refresh_token',
          refresh_token: refreshToken,
          client_id: 'auth-center-self',
        }),
      });

      if (response.ok) {
        const data = await response.json();
        document.cookie = `auth_token=${data.access_token}; path=/; SameSite=Lax`;
        if (data.refresh_token) {
          sessionStorage.setItem('refresh_token', data.refresh_token);
        }
        return true;
      }
    } catch (error) {
      console.error('Token refresh failed:', error);
    }
    return false;
  }, []);

  // æƒé™æ£€æŸ¥å‡½æ•°
  const hasPermission = useCallback(
    (permission: string): boolean => {
      return authState.user?.permissions.includes(permission) ?? false;
    },
    [authState.user?.permissions]
  );

  return {
    ...authState,
    hasPermission,
    refreshToken,
    login,
    logout,
  };
}
```

#### å®‰å…¨çš„ Token å­˜å‚¨

```typescript
// lib/auth/tokenStorage.ts
export class TokenStorage {
  private static readonly TOKEN_KEY = 'auth_token';
  private static readonly REFRESH_TOKEN_KEY = 'refresh_token';

  static setTokens(accessToken: string, refreshToken?: string) {
    // ä½¿ç”¨ HttpOnly cookie å­˜å‚¨è®¿é—®ä»¤ç‰Œï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
    document.cookie = `${this.TOKEN_KEY}=${accessToken}; path=/; SameSite=Lax; Secure`;

    // åˆ·æ–°ä»¤ç‰Œå­˜å‚¨åœ¨ sessionStorage
    if (refreshToken) {
      sessionStorage.setItem(this.REFRESH_TOKEN_KEY, refreshToken);
    }
  }

  static getAccessToken(): string | null {
    const cookies = document.cookie.split(';');
    const tokenCookie = cookies.find((cookie) => cookie.trim().startsWith(`${this.TOKEN_KEY}=`));
    return tokenCookie ? tokenCookie.split('=')[1] : null;
  }

  static getRefreshToken(): string | null {
    return sessionStorage.getItem(this.REFRESH_TOKEN_KEY);
  }

  static clearTokens() {
    document.cookie = `${this.TOKEN_KEY}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
    sessionStorage.removeItem(this.REFRESH_TOKEN_KEY);
  }
}
```

### 2. æ•°æ®ç®¡ç†ä¼˜åŒ–

#### API å®¢æˆ·ç«¯é›†æˆ

```typescript
// lib/api/adminApi.ts - çœŸå® API é›†æˆç¤ºä¾‹
export const adminApi = {
  // ç”¨æˆ·ç®¡ç†
  async getUsers(params?: { page?: number; limit?: number; search?: string }) {
    const searchParams = new URLSearchParams();
    if (params?.page) searchParams.set('page', params.page.toString());
    if (params?.limit) searchParams.set('limit', params.limit.toString());
    if (params?.search) searchParams.set('search', params.search);

    const response = await fetch(`/api/v2/users?${searchParams}`, {
      headers: {
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch users');
    }

    return response.json();
  },

  async createUser(userData: CreateUserRequest) {
    const response = await fetch('/api/v2/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
      body: JSON.stringify(userData),
    });

    if (!response.ok) {
      throw new Error('Failed to create user');
    }

    return response.json();
  },

  // è§’è‰²ç®¡ç†
  async getRoles() {
    const response = await fetch('/api/v2/roles', {
      headers: {
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch roles');
    }

    return response.json();
  },

  // OAuth å®¢æˆ·ç«¯ç®¡ç†
  async getClients() {
    const response = await fetch('/api/v2/clients', {
      headers: {
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch clients');
    }

    return response.json();
  },
};
```

### 3. ç¼ºå¤±é¡µé¢å®ç°

######### å®¡è®¡æ—¥å¿—é¡µé¢

```typescript
// apps/admin-portal/app/admin/audit/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { DataTable } from '@/components/data-table/data-table';
import { Badge } from '@/components/ui/badge';
import { adminApi } from '@/lib/api';

interface AuditLog {
  id: string;
  userId: string;
  action: string;
  resource: string;
  timestamp: string;
  ipAddress: string;
  userAgent: string;
  details?: Record<string, any>;
}

export default function AuditLogPage() {
  const [logs, setLogs] = useState<AuditLog[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchAuditLogs = async () => {
      try {
        const response = await adminApi.getAuditLogs();
        setLogs(response.data);
      } catch (err) {
        setError('Failed to load audit logs');
      } finally {
        setIsLoading(false);
      }
    };

    fetchAuditLogs();
  }, []);

  const columns = [
    {
      accessorKey: 'timestamp',
      header: 'æ—¶é—´',
      cell: ({ row }) => new Date(row.getValue('timestamp')).toLocaleString(),
    },
    {
      accessorKey: 'userId',
      header: 'ç”¨æˆ·',
    },
    {
      accessorKey: 'action',
      header: 'æ“ä½œ',
      cell: ({ row }) => {
        const action = row.getValue('action') as string;
        return (
          <Badge variant={action.includes('DELETE') ? 'destructive' : 'default'}>
            {action}
          </Badge>
        );
      },
    },
    {
      accessorKey: 'resource',
      header: 'èµ„æº',
    },
    {
      accessorKey: 'ipAddress',
      header: 'IP åœ°å€',
    },
  ];

  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (error) {
    return <div>é”™è¯¯: {error}</div>;
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">å®¡è®¡æ—¥å¿—</h1>
        <p className="text-gray-600">æŸ¥çœ‹ç³»ç»Ÿæ“ä½œè®°å½•</p>
      </div>

      <DataTable
        columns={columns}
        data={logs}
        searchKey="action"
        searchPlaceholder="æœç´¢æ“ä½œ..."
      />
    </div>
  );
}
```

#### ç”¨æˆ·ä¸ªäººèµ„æ–™é¡µé¢

```typescript
// app/(dashboard)/profile/page.tsx
'use client';

import { useState } from 'react';
import { useAuth } from '@/hooks/useAuth';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';

export default function ProfilePage() {
  const { user } = useAuth();
  const [isEditing, setIsEditing] = useState(false);
  const [formData, setFormData] = useState({
    displayName: user?.displayName || '',
    email: user?.email || '',
  });

  const handleSave = async () => {
    try {
      // è°ƒç”¨ API æ›´æ–°ç”¨æˆ·èµ„æ–™
      await adminApi.updateProfile(formData);
      setIsEditing(false);
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    } catch (error) {
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    }
  };

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <div>
        <h1 className="text-3xl font-bold">ä¸ªäººèµ„æ–™</h1>
        <p className="text-gray-600">ç®¡ç†æ‚¨çš„è´¦æˆ·ä¿¡æ¯</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>åŸºæœ¬ä¿¡æ¯</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="username">ç”¨æˆ·å</Label>
            <Input
              id="username"
              value={user?.username || ''}
              disabled
              className="bg-gray-50"
            />
          </div>

          <div>
            <Label htmlFor="displayName">æ˜¾ç¤ºåç§°</Label>
            <Input
              id="displayName"
              value={formData.displayName}
              onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}
              disabled={!isEditing}
            />
          </div>

          <div>
            <Label htmlFor="email">é‚®ç®±</Label>
            <Input
              id="email"
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              disabled={!isEditing}
            />
          </div>

          <div className="flex gap-2">
            {isEditing ? (
              <>
                <Button onClick={handleSave}>ä¿å­˜</Button>
                <Button variant="outline" onClick={() => setIsEditing(false)}>
                  å–æ¶ˆ
                </Button>
              </>
            ) : (
              <Button onClick={() => setIsEditing(true)}>ç¼–è¾‘</Button>
            )}
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>æƒé™ä¿¡æ¯</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            {user?.permissions.map((permission) => (
              <Badge key={permission} variant="outline">
                {permission}
              </Badge>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### 4. æƒé™ç³»ç»Ÿé›†æˆ

#### é¡µé¢çº§æƒé™ä¿æŠ¤

```typescript
// components/auth/PermissionGuard.tsx
import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

interface PermissionGuardProps {
  permission: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
}

export function PermissionGuard({
  permission,
  children,
  fallback
}: PermissionGuardProps) {
  const { hasPermission, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !hasPermission(permission)) {
      router.push(`/unauthorized?required_permission=${permission}`);
    }
  }, [hasPermission, permission, isLoading, router]);

  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!hasPermission(permission)) {
    return fallback || null;
  }

  return <>{children}</>;
}
```

#### èœå•æƒé™è¿‡æ»¤å®ç°

```typescript
// components/admin/sidebar.tsx - ä¼˜åŒ–ç‰ˆæœ¬
const menuItems = [
  {
    title: 'ç³»ç»Ÿç®¡ç†',
    permission: 'menu:system:view',
    children: [
      {
        title: 'ç”¨æˆ·ç®¡ç†',
        href: '/admin/users',
        permission: 'menu:system:user:view',
      },
      {
        title: 'è§’è‰²ç®¡ç†',
        href: '/admin/roles',
        permission: 'menu:system:role:view',
      },
      // ... å…¶ä»–èœå•é¡¹
    ],
  },
];

function filterMenuItems(items: MenuItem[], hasPermission: (permission: string) => boolean) {
  return items
    .filter(item => !item.permission || hasPermission(item.permission))
    .map(item => ({
      ...item,
      children: item.children
        ? filterMenuItems(item.children, hasPermission)
        : undefined,
    }))
    .filter(item => !item.children || item.children.length > 0);
}

export function Sidebar() {
  const { hasPermission, isLoading } = useAuth();

  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  const filteredMenuItems = filterMenuItems(menuItems, hasPermission);

  return (
    <nav className="space-y-2">
      {filteredMenuItems.map((item) => (
        <MenuItemComponent key={item.title} item={item} />
      ))}
    </nav>
  );
}
```

## æµ‹è¯•ç­–ç•¥

### Jest æµ‹è¯•èŒƒå›´

æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼ŒJest åªæµ‹è¯• `app/api` ç›¸å…³çš„ Node.js æœåŠ¡ï¼Œä¸æµ‹è¯•é¡µé¢ç»„ä»¶ã€‚ä»¥ä¸‹æ˜¯æµ‹è¯•é‡ç‚¹ï¼š

1. **API è·¯ç”±æµ‹è¯•**

   - è®¤è¯ç›¸å…³ API (`/api/v2/auth/*`)
   - OAuth ç›¸å…³ API (`/api/v2/oauth/*`)
   - ç®¡ç†ç›¸å…³ API (`/api/v2/users/*`, `/api/v2/roles/*`, etc.)

2. **ä¸­é—´ä»¶æµ‹è¯•**

   - è®¤è¯ä¸­é—´ä»¶
   - æƒé™æ£€æŸ¥ä¸­é—´ä»¶
   - é”™è¯¯å¤„ç†ä¸­é—´ä»¶

3. **å·¥å…·å‡½æ•°æµ‹è¯•**
   - è®¤è¯å·¥å…·å‡½æ•°
   - OAuth æµç¨‹å‡½æ•°
   - æ•°æ®éªŒè¯å‡½æ•°

### E2E æµ‹è¯•ï¼ˆPlaywrightï¼‰

é¡µé¢ç›¸å…³çš„æµ‹è¯•å°†ç”± Playwright E2E æµ‹è¯•è¦†ç›–ï¼š

1. **è®¤è¯æµç¨‹æµ‹è¯•**

   - ç™»å½•/ç™»å‡ºæµç¨‹
   - OAuth æˆæƒæµç¨‹
   - æƒé™éªŒè¯

2. **ç®¡ç†é¡µé¢æµ‹è¯•**

   - ç”¨æˆ·ç®¡ç†æ“ä½œ
   - è§’è‰²æƒé™ç®¡ç†
   - å®¢æˆ·ç«¯ç®¡ç†

3. **UI äº¤äº’æµ‹è¯•**
   - è¡¨å•æäº¤
   - æ•°æ®è¡¨æ ¼æ“ä½œ
   - æ¨¡æ€æ¡†äº¤äº’

## æ€»ç»“

### å½“å‰çŠ¶æ€

é¡¹ç›®çš„è®¤è¯æˆæƒå’Œç®¡ç†é¡µé¢å®ç°å·²ç»ç›¸å½“å®Œæ•´ï¼Œå…·å¤‡äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **å®Œæ•´çš„è®¤è¯æµç¨‹**: OAuth 2.0 + PKCE å®ç°å®Œæ•´
2. **å…¨é¢çš„ç®¡ç†åŠŸèƒ½**: ç”¨æˆ·ã€è§’è‰²ã€æƒé™ã€å®¢æˆ·ç«¯ç®¡ç†é½å…¨
3. **ç°ä»£åŒ–çš„ UI**: ä½¿ç”¨äº†ç°ä»£åŒ–çš„ç»„ä»¶åº“å’Œè®¾è®¡
4. **è‰¯å¥½çš„ä»£ç ç»“æ„**: ç»„ä»¶åŒ–å’Œæ¨¡å—åŒ–è®¾è®¡

### ä¸»è¦æ”¹è¿›ç‚¹

1. **è®¤è¯ç³»ç»Ÿ**: éœ€è¦ä»æ¨¡æ‹Ÿå®ç°è½¬å‘çœŸå® API é›†æˆ
2. **æ•°æ®ç®¡ç†**: éœ€è¦é›†æˆçœŸå®çš„æ•°æ®è·å–å’ŒçŠ¶æ€ç®¡ç†
3. **æƒé™ç³»ç»Ÿ**: éœ€è¦å®Œå–„æƒé™æ£€æŸ¥å’Œé¡µé¢ä¿æŠ¤
4. **åŠŸèƒ½è¡¥å……**: éœ€è¦æ·»åŠ å®¡è®¡æ—¥å¿—ã€ä¸ªäººèµ„æ–™ç­‰é¡µé¢

### ä¼˜å…ˆçº§å»ºè®®

**é«˜ä¼˜å…ˆçº§**:

1. å®ç°çœŸå®çš„ useAuth Hook
2. é›†æˆ API å®¢æˆ·ç«¯
3. å®Œå–„æƒé™ç³»ç»Ÿ

**ä¸­ä¼˜å…ˆçº§**:

1. æ·»åŠ å®¡è®¡æ—¥å¿—é¡µé¢
2. å®ç°ä¸ªäººèµ„æ–™ç®¡ç†
3. ä¼˜åŒ–é”™è¯¯å¤„ç†

**ä½ä¼˜å…ˆçº§**:

1. æ·»åŠ ç›‘æ§ç»Ÿè®¡
2. å®ç°æ‰¹é‡æ“ä½œ
3. ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

é€šè¿‡ä»¥ä¸Šæ”¹è¿›ï¼Œé¡¹ç›®çš„ç®¡ç†é¡µé¢å°†è¾¾åˆ°ç”Ÿäº§ç¯å¢ƒçš„è¦æ±‚ï¼Œä¸ºç”¨æˆ·æä¾›å®Œæ•´ã€å®‰å…¨ã€æ˜“ç”¨çš„ç®¡ç†ä½“éªŒã€‚
