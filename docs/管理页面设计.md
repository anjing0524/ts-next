# 管理门户 (admin-portal) 页面设计文档

> **文档版本**: v3.1.0  
> **创建日期**: 2024-12-19  
> **最后更新**: 2024-12-22  
> **文档状态**: 正式版  
> **维护团队**: 前端团队

## 技术架构与定位

**核心定位**:

- ✅ **微服务UI**: 作为Monorepo微服务架构的统一管理入口。
- ✅ **前后端分离**: 纯前端应用，通过API与后端服务（主要是 `oauth-service`）通信。
- ✅ **技术栈**: 基于 Next.js 15, shadcn/ui, 和 Tailwind CSS ^4.0.0 构建。
- ✅ **OAuth2.1客户端**: 作为 `oauth-service` 的一个OAuth客户端，完全遵循标准授权流程。

## 概述

本文档详细描述了 `admin-portal` 应用的页面功能和实现完整性。`admin-portal` 是整个微服务生态系统的核心管理界面，负责用户管理、角色权限分配、OAuth客户端管理等功能。它严格遵循OAuth2.1+强制PKCE标准与 `oauth-service` 进行安全通信，为管理员提供强大而安全的操作体验。

## 当前实现状态

### 已实现的页面

#### 1. 认证相关页面

##### 登录页面 (`/login`)

- **文件**: `apps/admin-portal/app/login/page.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 用户名/密码登录表单
  - Zod 表单验证
  - PKCE 支持（浏览器兼容）
  - OAuth 流程集成
  - 错误处理和状态管理
- **技术特点**:
  - 支持内部管理员访问和外部 OAuth 客户端
  - 完整的 PKCE 实现（code_verifier 和 code_challenge）
  - 响应式 UI 设计

##### OAuth 授权同意页面 (`/oauth/consent`)

- **文件**: `apps/admin-portal/app/oauth/consent/page.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 显示客户端请求的权限范围
  - 用户授权确认界面
  - 支持授权/拒绝操作
  - 参数验证和错误处理
- **技术特点**:
  - 现代化 UI 设计
  - 权限范围格式化显示
  - 表单提交到 `/api/oauth/consent`

##### 认证回调页面 (`/auth/callback`)

- **文件**: `apps/admin-portal/app/auth/callback/page.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 处理 OAuth 授权码交换
  - PKCE 验证
  - Token 存储和管理
  - 错误处理和重定向
- **技术特点**:
  - 完整的授权码流程处理
  - 安全的 token 存储（cookie + sessionStorage）
  - 加载状态和错误状态处理

##### 未授权访问页面 (`/unauthorized`)

- **文件**: `apps/admin-portal/app/unauthorized/page.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 显示权限不足信息
  - 详细的错误信息展示
  - 返回首页链接
- **技术特点**:
  - 支持多种错误类型显示
  - 动态错误消息生成
  - 用户友好的界面设计

#### 2. 管理页面

##### 管理员控制台 (`/admin`)

- **文件**: `apps/admin-portal/app/admin/page.tsx`
- **功能状态**: ✅ 核心功能完整
- **核心功能**:
  - 用户管理（CRUD 操作）
  - 角色管理（CRUD 操作）
  - 权限管理（CRUD 操作）
  - OAuth 客户端管理（CRUD 操作）
  - OAuth 作用域管理（CRUD 操作）
- **技术特点**:
  - 完整的状态管理
  - 模态框操作界面
  - 数据表格展示
  - 表单验证

##### 用户管理页面 (`/admin/users`)

- **文件**: `apps/admin-portal/app/(dashboard)/admin/users/page.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 从 `/api/v2/users` 获取并展示用户列表
  - 使用 TanStack Table 实现分页、排序和过滤
  - 提供用户操作（查看详情、编辑、删除）的入口
  - 完整的加载和错误状态处理
- **技术特点**:
  - 与 `useAuth` 钩子集成，确保认证和权限
  - 模块化的列定义 (`columns.tsx`)
  - 响应式数据表格

##### 审计日志页面 (`/admin/audit`)

- **文件**: `apps/admin-portal/app/(dashboard)/admin/audit/page.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 从 `/api/v2/audit-logs` 获取并展示审计日志
  - 根据操作类型（创建、更新、删除）显示不同颜色的徽章
  - 提供日志详情查看功能
- **技术特点**:
  - 实时数据获取和展示
  - 自定义表格列渲染
  - 高效的数据分页和过滤

##### 管理员布局 (`/admin/layout`)

- **文件**: `apps/admin-portal/app/admin/layout.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 侧边栏导航
  - 头部组件
  - 响应式布局
- **技术特点**:
  - Suspense 加载处理
  - 模块化组件设计

##### 客户端注册页面 (`/clients/register`)

- **文件**: `apps/admin-portal/app/clients/register/page.tsx`
- **功能状态**: ✅ 完整实现
- **核心功能**:
  - OAuth 客户端注册表单
  - Zod 表单验证
  - 重定向 URI 验证
  - JWKS URI 配置
- **技术特点**:
  - 完整的表单验证逻辑
  - 现代化 UI 设计
  - 错误处理和成功反馈

##### 仪表板页面 (`/dashboard`)

- **文件**: `apps/admin-portal/app/dashboard/page.tsx`
- **功能状态**: ❌ 已弃用
- **说明**: 此页面已被移除。其核心功能（用户列表展示）已迁移并整合到 `/admin/users` 页面中，以实现更统一的管理体验。

#### 3. 支持组件

##### 管理员侧边栏 (`components/admin/sidebar.tsx`)

- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 基于权限的菜单过滤
  - 动态导航菜单
  - 用户状态检查
- **菜单项**:
  - 系统管理（用户、角色、权限、客户端、作用域、审计日志）
  - 权限控制集成

##### 管理员头部 (`components/admin/header.tsx`)

- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 用户信息显示
  - 登出功能
  - 加载状态处理

#### 4. 认证 Hook

##### useAuth Hook (`hooks/useAuth.ts`)

- **功能状态**: ✅ 完整实现
- **核心功能**:
  - 用户认证状态管理
  - Token 存储和检索 (Cookie + LocalStorage)
  - 权限检查功能
  - 登录/登出操作
  - Token 刷新机制
- **技术特点**:
  - 连接真实 API (`/api/v2/users/me`, `/api/v2/oauth/token`)
  - 安全的 Token 存储策略
  - 自动化的 Token 刷新
  - React hooks 模式

## 完整性评估

### ✅ 已完成的功能

1. **认证流程**

   - 完整的 OAuth 2.0 + PKCE 流程
   - 用户登录/登出
   - 授权同意页面
   - 认证回调处理
   - 未授权访问处理

2. **管理功能**

   - 用户管理界面
   - 角色和权限管理
   - OAuth 客户端管理
   - OAuth 作用域管理
   - 客户端注册功能

3. **UI/UX 设计**
   - 现代化的界面设计
   - 响应式布局
   - 一致的组件风格
   - 错误处理和加载状态

### ⚠️ 需要改进的功能

1. **数据获取**

   - 管理页面当前使用模拟数据，需要替换为真实的API调用。
   - 需要在所有数据获取点实现加载（loading）和错误（error）状态的完整处理，提升用户体验。
   - 审计日志功能尚未完全实现，需要添加相应的页面和API调用。

2. **权限系统集成**
   - 权限检查逻辑需要完善
   - 菜单权限过滤需要实际实现
   - 页面级权限控制

### ❌ 缺失的功能

1. **高级管理功能**

   - 审计日志查看页面
   - 系统配置管理
   - 批量操作功能

2. **监控和统计**

   - 系统使用统计
   - 性能监控面板
   - 错误日志查看

3. **个人资料管理**
   - 用户个人资料编辑
   - 密码修改页面
   - 头像上传功能

## 优化建议

### 1. 认证系统优化

#### 实现真实的 useAuth Hook

```typescript
// hooks/useAuth.ts - 生产版本示例
export function useAuth() {
  const [authState, setAuthState] = useState<AuthState>({
    user: null,
    token: null,
    isLoading: true,
    error: null,
  });

  const fetchUserProfile = useCallback(async (token: string) => {
    try {
      const response = await fetch('/api/v2/auth/me', {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch user profile');
      }

      const userData = await response.json();
      setAuthState({
        user: userData.data,
        token,
        isLoading: false,
        error: null,
      });
    } catch (error) {
      console.error('Failed to fetch user profile:', error);
      setAuthState({
        user: null,
        token: null,
        isLoading: false,
        error: 'Failed to load user data',
      });
    }
  }, []);

  // Token 刷新逻辑
  const refreshToken = useCallback(async () => {
    const refreshToken = sessionStorage.getItem('refresh_token');
    if (!refreshToken) return false;

    try {
      const response = await fetch('/api/v2/oauth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          grant_type: 'refresh_token',
          refresh_token: refreshToken,
          client_id: 'auth-center-self',
        }),
      });

      if (response.ok) {
        const data = await response.json();
        document.cookie = `auth_token=${data.access_token}; path=/; SameSite=Lax`;
        if (data.refresh_token) {
          sessionStorage.setItem('refresh_token', data.refresh_token);
        }
        return true;
      }
    } catch (error) {
      console.error('Token refresh failed:', error);
    }
    return false;
  }, []);

  // 权限检查函数
  const hasPermission = useCallback(
    (permission: string): boolean => {
      return authState.user?.permissions.includes(permission) ?? false;
    },
    [authState.user?.permissions]
  );

  return {
    ...authState,
    hasPermission,
    refreshToken,
    login,
    logout,
  };
}
```

#### 安全的 Token 存储

```typescript
// lib/auth/tokenStorage.ts
export class TokenStorage {
  private static readonly TOKEN_KEY = 'auth_token';
  private static readonly REFRESH_TOKEN_KEY = 'refresh_token';

  static setTokens(accessToken: string, refreshToken?: string) {
    // 使用 HttpOnly cookie 存储访问令牌（生产环境推荐）
    document.cookie = `${this.TOKEN_KEY}=${accessToken}; path=/; SameSite=Lax; Secure`;

    // 刷新令牌存储在 sessionStorage
    if (refreshToken) {
      sessionStorage.setItem(this.REFRESH_TOKEN_KEY, refreshToken);
    }
  }

  static getAccessToken(): string | null {
    const cookies = document.cookie.split(';');
    const tokenCookie = cookies.find((cookie) => cookie.trim().startsWith(`${this.TOKEN_KEY}=`));
    return tokenCookie ? tokenCookie.split('=')[1] : null;
  }

  static getRefreshToken(): string | null {
    return sessionStorage.getItem(this.REFRESH_TOKEN_KEY);
  }

  static clearTokens() {
    document.cookie = `${this.TOKEN_KEY}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
    sessionStorage.removeItem(this.REFRESH_TOKEN_KEY);
  }
}
```

### 2. 数据管理优化

#### API 客户端集成

```typescript
// lib/api/adminApi.ts - 真实 API 集成示例
export const adminApi = {
  // 用户管理
  async getUsers(params?: { page?: number; limit?: number; search?: string }) {
    const searchParams = new URLSearchParams();
    if (params?.page) searchParams.set('page', params.page.toString());
    if (params?.limit) searchParams.set('limit', params.limit.toString());
    if (params?.search) searchParams.set('search', params.search);

    const response = await fetch(`/api/v2/users?${searchParams}`, {
      headers: {
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch users');
    }

    return response.json();
  },

  async createUser(userData: CreateUserRequest) {
    const response = await fetch('/api/v2/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
      body: JSON.stringify(userData),
    });

    if (!response.ok) {
      throw new Error('Failed to create user');
    }

    return response.json();
  },

  // 角色管理
  async getRoles() {
    const response = await fetch('/api/v2/roles', {
      headers: {
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch roles');
    }

    return response.json();
  },

  // OAuth 客户端管理
  async getClients() {
    const response = await fetch('/api/v2/clients', {
      headers: {
        Authorization: `Bearer ${TokenStorage.getAccessToken()}`,
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch clients');
    }

    return response.json();
  },
};
```

### 3. 缺失页面实现

######### 审计日志页面

```typescript
// apps/admin-portal/app/admin/audit/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { DataTable } from '@/components/data-table/data-table';
import { Badge } from '@/components/ui/badge';
import { adminApi } from '@/lib/api';

interface AuditLog {
  id: string;
  userId: string;
  action: string;
  resource: string;
  timestamp: string;
  ipAddress: string;
  userAgent: string;
  details?: Record<string, any>;
}

export default function AuditLogPage() {
  const [logs, setLogs] = useState<AuditLog[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchAuditLogs = async () => {
      try {
        const response = await adminApi.getAuditLogs();
        setLogs(response.data);
      } catch (err) {
        setError('Failed to load audit logs');
      } finally {
        setIsLoading(false);
      }
    };

    fetchAuditLogs();
  }, []);

  const columns = [
    {
      accessorKey: 'timestamp',
      header: '时间',
      cell: ({ row }) => new Date(row.getValue('timestamp')).toLocaleString(),
    },
    {
      accessorKey: 'userId',
      header: '用户',
    },
    {
      accessorKey: 'action',
      header: '操作',
      cell: ({ row }) => {
        const action = row.getValue('action') as string;
        return (
          <Badge variant={action.includes('DELETE') ? 'destructive' : 'default'}>
            {action}
          </Badge>
        );
      },
    },
    {
      accessorKey: 'resource',
      header: '资源',
    },
    {
      accessorKey: 'ipAddress',
      header: 'IP 地址',
    },
  ];

  if (isLoading) {
    return <div>加载中...</div>;
  }

  if (error) {
    return <div>错误: {error}</div>;
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">审计日志</h1>
        <p className="text-gray-600">查看系统操作记录</p>
      </div>

      <DataTable
        columns={columns}
        data={logs}
        searchKey="action"
        searchPlaceholder="搜索操作..."
      />
    </div>
  );
}
```

#### 用户个人资料页面

```typescript
// app/(dashboard)/profile/page.tsx
'use client';

import { useState } from 'react';
import { useAuth } from '@/hooks/useAuth';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';

export default function ProfilePage() {
  const { user } = useAuth();
  const [isEditing, setIsEditing] = useState(false);
  const [formData, setFormData] = useState({
    displayName: user?.displayName || '',
    email: user?.email || '',
  });

  const handleSave = async () => {
    try {
      // 调用 API 更新用户资料
      await adminApi.updateProfile(formData);
      setIsEditing(false);
      // 显示成功消息
    } catch (error) {
      // 显示错误消息
    }
  };

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <div>
        <h1 className="text-3xl font-bold">个人资料</h1>
        <p className="text-gray-600">管理您的账户信息</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>基本信息</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="username">用户名</Label>
            <Input
              id="username"
              value={user?.username || ''}
              disabled
              className="bg-gray-50"
            />
          </div>

          <div>
            <Label htmlFor="displayName">显示名称</Label>
            <Input
              id="displayName"
              value={formData.displayName}
              onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}
              disabled={!isEditing}
            />
          </div>

          <div>
            <Label htmlFor="email">邮箱</Label>
            <Input
              id="email"
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              disabled={!isEditing}
            />
          </div>

          <div className="flex gap-2">
            {isEditing ? (
              <>
                <Button onClick={handleSave}>保存</Button>
                <Button variant="outline" onClick={() => setIsEditing(false)}>
                  取消
                </Button>
              </>
            ) : (
              <Button onClick={() => setIsEditing(true)}>编辑</Button>
            )}
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>权限信息</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            {user?.permissions.map((permission) => (
              <Badge key={permission} variant="outline">
                {permission}
              </Badge>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### 4. 权限系统集成

#### 页面级权限保护

```typescript
// components/auth/PermissionGuard.tsx
import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

interface PermissionGuardProps {
  permission: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
}

export function PermissionGuard({
  permission,
  children,
  fallback
}: PermissionGuardProps) {
  const { hasPermission, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !hasPermission(permission)) {
      router.push(`/unauthorized?required_permission=${permission}`);
    }
  }, [hasPermission, permission, isLoading, router]);

  if (isLoading) {
    return <div>加载中...</div>;
  }

  if (!hasPermission(permission)) {
    return fallback || null;
  }

  return <>{children}</>;
}
```

#### 菜单权限过滤实现

```typescript
// components/admin/sidebar.tsx - 优化版本
const menuItems = [
  {
    title: '系统管理',
    permission: 'menu:system:view',
    children: [
      {
        title: '用户管理',
        href: '/admin/users',
        permission: 'menu:system:user:view',
      },
      {
        title: '角色管理',
        href: '/admin/roles',
        permission: 'menu:system:role:view',
      },
      // ... 其他菜单项
    ],
  },
];

function filterMenuItems(items: MenuItem[], hasPermission: (permission: string) => boolean) {
  return items
    .filter(item => !item.permission || hasPermission(item.permission))
    .map(item => ({
      ...item,
      children: item.children
        ? filterMenuItems(item.children, hasPermission)
        : undefined,
    }))
    .filter(item => !item.children || item.children.length > 0);
}

export function Sidebar() {
  const { hasPermission, isLoading } = useAuth();

  if (isLoading) {
    return <div>加载中...</div>;
  }

  const filteredMenuItems = filterMenuItems(menuItems, hasPermission);

  return (
    <nav className="space-y-2">
      {filteredMenuItems.map((item) => (
        <MenuItemComponent key={item.title} item={item} />
      ))}
    </nav>
  );
}
```

## 测试策略

### Jest 测试范围

根据用户要求，Jest 只测试 `app/api` 相关的 Node.js 服务，不测试页面组件。以下是测试重点：

1. **API 路由测试**

   - 认证相关 API (`/api/v2/auth/*`)
   - OAuth 相关 API (`/api/v2/oauth/*`)
   - 管理相关 API (`/api/v2/users/*`, `/api/v2/roles/*`, etc.)

2. **中间件测试**

   - 认证中间件
   - 权限检查中间件
   - 错误处理中间件

3. **工具函数测试**
   - 认证工具函数
   - OAuth 流程函数
   - 数据验证函数

### E2E 测试（Playwright）

页面相关的测试将由 Playwright E2E 测试覆盖：

1. **认证流程测试**

   - 登录/登出流程
   - OAuth 授权流程
   - 权限验证

2. **管理页面测试**

   - 用户管理操作
   - 角色权限管理
   - 客户端管理

3. **UI 交互测试**
   - 表单提交
   - 数据表格操作
   - 模态框交互

## 总结

### 当前状态

项目的认证授权和管理页面实现已经相当完整，具备了以下优势：

1. **完整的认证流程**: OAuth 2.0 + PKCE 实现完整
2. **全面的管理功能**: 用户、角色、权限、客户端管理齐全
3. **现代化的 UI**: 使用了现代化的组件库和设计
4. **良好的代码结构**: 组件化和模块化设计

### 主要改进点

1. **认证系统**: 需要从模拟实现转向真实 API 集成
2. **数据管理**: 需要集成真实的数据获取和状态管理
3. **权限系统**: 需要完善权限检查和页面保护
4. **功能补充**: 需要添加审计日志、个人资料等页面

### 优先级建议

**高优先级**:

1. 实现真实的 useAuth Hook
2. 集成 API 客户端
3. 完善权限系统

**中优先级**:

1. 添加审计日志页面
2. 实现个人资料管理
3. 优化错误处理

**低优先级**:

1. 添加监控统计
2. 实现批量操作
3. 优化性能和用户体验

通过以上改进，项目的管理页面将达到生产环境的要求，为用户提供完整、安全、易用的管理体验。
