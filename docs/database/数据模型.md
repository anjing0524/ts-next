# 数据库设计

## 核心实体关系

```
User ──┬─ UserRole ── Role
       │              │
       │              └─ RolePermission ── Permission
       │
       └─ OAuthClient ── AuthorizationCode
                     │
                     ├─ AccessToken
                     │
                     └─ RefreshToken
```

## 用户相关表

### users
用户账户信息

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | String | PK, CUID | 主键 |
| username | String | Unique | 用户名 |
| passwordHash | String | | bcrypt哈希密码 |
| displayName | String? | | 显示名称 |
| isActive | Boolean | Default true | 是否激活 |
| mustChangePassword | Boolean | Default true | 是否需要修改密码 |
| failedLoginAttempts | Int | Default 0 | 登录失败次数 |
| lockedUntil | DateTime? | | 锁定到期时间 |

### roles
角色定义

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | String | PK, CUID | 主键 |
| name | String | Unique | 角色名 |
| displayName | String | | 显示名称 |
| isSystemRole | Boolean | Default false | 是否系统角色 |
| isActive | Boolean | Default true | 是否激活 |

### permissions
权限定义

| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|
| id | String | PK, CUID | 主键 |
| name | String | Unique | 权限名 |
| resource | String | | 资源 |
| action | String | | 操作 |
| type | PermissionType | | 权限类型 |

## 关联表

### user_roles
用户角色关联

| 字段 | 类型 | 约束 |
|------|------|------|
| userId | String | FK |
| roleId | String | FK |
| assignedAt | DateTime | Default now |
| assignedBy | String? | FK |

### role_permissions
角色权限关联

| 字段 | 类型 | 约束 |
|------|------|------|
| roleId | String | FK |
| permissionId | String | FK |

## OAuth相关表

### oauth_clients
OAuth客户端

| 字段 | 类型 | 约束 |
|------|------|------|
| id | String | PK, CUID |
| clientId | String | Unique |
| clientSecret | String? | |
| clientType | ClientType | |
| redirectUris | String | JSON数组 |
| allowedScopes | String | JSON数组 |
| grantTypes | String | JSON数组 |
| requirePkce | Boolean | Default true |

### authorization_codes
授权码

| 字段 | 类型 | 约束 |
|------|------|------|
| code | String | PK |
| userId | String | FK |
| clientId | String | FK |
| redirectUri | String | |
| scope | String | |
| codeChallenge | String | |
| expiresAt | DateTime | |
| isUsed | Boolean | Default false |

### access_tokens
访问令牌

| 字段 | 类型 | 约束 |
|------|------|------|
| tokenHash | String | PK |
| userId | String | FK |
| clientId | String | FK |
| scope | String | |
| expiresAt | DateTime | |
| jti | String | Unique |

### refresh_tokens
刷新令牌

| 字段 | 类型 | 约束 |
|------|------|------|
| tokenHash | String | PK |
| userId | String | FK |
| clientId | String | FK |
| expiresAt | DateTime | |
| isRevoked | Boolean | Default false |

## 审计相关

### audit_logs
审计日志

| 字段 | 类型 | 约束 |
|------|------|------|
| id | String | PK, CUID |
| userId | String? | FK |
| action | String | |
| resourceType | String | |
| resourceId | String? | |
| status | String | |
| ipAddress | String? | |
| userAgent | String? | |
| details | Json? | |
| timestamp | DateTime | Default now |

### consent_grants
用户授权记录

| 字段 | 类型 | 约束 |
|------|------|------|
| id | String | PK, CUID |
| userId | String | FK |
| clientId | String | FK |
| scope | String | |
| grantedAt | DateTime | Default now |

## 枚举定义

### PermissionType
- API
- MENU
- OPERATION
- DATA

### ClientType
- PUBLIC
- CONFIDENTIAL