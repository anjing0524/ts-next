# æµ‹è¯•æ¶æ„è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v1.1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-27  
**æœ€åæ›´æ–°**: 2025-01-27  
**çŠ¶æ€**: é›†æˆé—®é¢˜æµ‹è¯•ç‰ˆ  
**ç»´æŠ¤å›¢é˜Ÿ**: è´¨é‡ä¿éšœå›¢é˜Ÿ

> âš ï¸ **é›†æˆçŠ¶æ€è­¦å‘Š**: å½“å‰é¡¹ç›®å­˜åœ¨å…³é”®é›†æˆé—®é¢˜ï¼Œæµ‹è¯•æ¶æ„å·²è°ƒæ•´ä»¥æ”¯æŒé›†æˆé—®é¢˜çš„éªŒè¯å’Œä¿®å¤æµ‹è¯•ã€‚

## æ–‡æ¡£æ‘˜è¦

æœ¬æ–‡æ¡£æè¿°äº†OAuth2.1è®¤è¯æˆæƒä¸­å¿ƒçš„æµ‹è¯•æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯(E2E)æµ‹è¯•çš„ç»„ç»‡ç»“æ„ã€‚é€šè¿‡å°†E2Eæµ‹è¯•è¿ç§»åˆ°å„ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œå®ç°äº†æµ‹è¯•çš„ç‹¬ç«‹æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

**å½“å‰é›†æˆçŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œä½†å­˜åœ¨å…³é”®é›†æˆé—®é¢˜éœ€è¦é€šè¿‡ä¸“é—¨çš„æµ‹è¯•æ¶æ„æ¥éªŒè¯å’Œä¿®å¤ã€‚

### é›†æˆé—®é¢˜æµ‹è¯•æ¶æ„æ¦‚è§ˆ

é’ˆå¯¹å½“å‰é¡¹ç›®å­˜åœ¨çš„é›†æˆé—®é¢˜ï¼Œæœ¬æ–‡æ¡£æ–°å¢äº†ä¸“é—¨çš„æµ‹è¯•æ¶æ„è®¾è®¡ï¼š

1. **é—®é¢˜éªŒè¯å±‚**: éªŒè¯é›†æˆé—®é¢˜çš„å­˜åœ¨å’Œå½±å“èŒƒå›´
2. **ä¿®å¤éªŒè¯å±‚**: ç¡®ä¿ä¿®å¤æ–¹æ¡ˆçš„æœ‰æ•ˆæ€§
3. **å›å½’æµ‹è¯•å±‚**: é˜²æ­¢å·²ä¿®å¤é—®é¢˜çš„é‡æ–°å‡ºç°
4. **æŒç»­é›†æˆå±‚**: åœ¨CI/CDæµç¨‹ä¸­é›†æˆé—®é¢˜æ£€æµ‹

## æµ‹è¯•æ¶æ„åŸåˆ™

- âœ… **æµ‹è¯•ç‹¬ç«‹æ€§**: æ¯ä¸ªåº”ç”¨æœ‰ç‹¬ç«‹çš„æµ‹è¯•ç¯å¢ƒå’Œé…ç½®
- âœ… **å°±è¿‘åŸåˆ™**: æµ‹è¯•é è¿‘è¢«æµ‹è¯•çš„ä»£ç ï¼Œä¾¿äºç»´æŠ¤
- âœ… **çœŸå®ç¯å¢ƒ**: ä½¿ç”¨çœŸå®æ•°æ®åº“è¿æ¥ï¼Œé¿å…è¿‡åº¦Mock
- âœ… **å¤šæµè§ˆå™¨æ”¯æŒ**: E2Eæµ‹è¯•è¦†ç›–ä¸»æµæµè§ˆå™¨ç¯å¢ƒ
- âœ… **CI/CDé›†æˆ**: æ‰€æœ‰æµ‹è¯•è‡ªåŠ¨åŒ–å¹¶é›†æˆåˆ°æ„å»ºæµç¨‹
- âš ï¸ **é›†æˆé—®é¢˜ä¼˜å…ˆ**: é’ˆå¯¹å‘ç°çš„é›†æˆé—®é¢˜å»ºç«‹ä¸“é—¨çš„æµ‹è¯•æ¶æ„å’ŒéªŒè¯æµç¨‹

## æµ‹è¯•å±‚çº§æ¶æ„

```
OAuth2.1è®¤è¯æˆæƒä¸­å¿ƒæµ‹è¯•æ¶æ„
â”œâ”€â”€ æ ¹ç›®å½•æµ‹è¯• (/\__tests__)
â”‚   â”œâ”€â”€ APIæµ‹è¯• (api/)
â”‚   â”‚   â”œâ”€â”€ audit-logs.test.ts
â”‚   â”‚   â””â”€â”€ user-service.test.ts
â”‚   â”œâ”€â”€ é›†æˆæµ‹è¯• (integration/)
â”‚   â”‚   â””â”€â”€ admin-portal-oauth-service.test.ts
â”‚   â””â”€â”€ é›†æˆé—®é¢˜æµ‹è¯• (integration-issues/) âš ï¸ **æ–°å¢**
â”‚       â”œâ”€â”€ api/
â”‚       â”‚   â”œâ”€â”€ audit-logs-missing.test.ts
â”‚       â”‚   â”œâ”€â”€ user-profile-update.test.ts
â”‚       â”‚   â”œâ”€â”€ client-secret-rotation.test.ts
â”‚       â”‚   â”œâ”€â”€ endpoint-unification.test.ts
â”‚       â”‚   â””â”€â”€ path-consistency.test.ts
â”‚       â”œâ”€â”€ integration/
â”‚       â”‚   â”œâ”€â”€ logout-token-revocation.test.ts
â”‚       â”‚   â”œâ”€â”€ frontend-backend-sync.test.ts
â”‚       â”‚   â””â”€â”€ oauth-compliance.test.ts
â”‚       â”œâ”€â”€ regression/
â”‚       â”‚   â”œâ”€â”€ integration-issues.test.ts
â”‚       â”‚   â”œâ”€â”€ api-compatibility.test.ts
â”‚       â”‚   â””â”€â”€ security-compliance.test.ts
â”‚       â””â”€â”€ monitoring/
â”‚           â”œâ”€â”€ integration-health.test.ts
â”‚           â”œâ”€â”€ performance-regression.test.ts
â”‚           â””â”€â”€ error-tracking.test.ts
â”‚
â”œâ”€â”€ Admin Portalæµ‹è¯• (apps/admin-portal/tests/)
â”‚   â”œâ”€â”€ E2Eæµ‹è¯• (e2e/)
â”‚   â”‚   â”œâ”€â”€ admin-management.spec.ts
â”‚   â”‚   â”œâ”€â”€ oauth-flow.spec.ts
â”‚   â”‚   â””â”€â”€ basic.spec.ts
â”‚   â””â”€â”€ æµ‹è¯•è¾…åŠ© (helpers/)
â”‚       â”œâ”€â”€ auth-helpers.ts
â”‚       â”œâ”€â”€ test-data.ts
â”‚       â”œâ”€â”€ global-setup.ts
â”‚       â””â”€â”€ global-teardown.ts
â”‚
â””â”€â”€ OAuth Serviceæµ‹è¯• (apps/oauth-service/)
    â””â”€â”€ å•å…ƒæµ‹è¯•å’ŒAPIæµ‹è¯•
```

### é›†æˆé—®é¢˜æµ‹è¯•æ¶æ„å±‚çº§

#### 1. é—®é¢˜éªŒè¯å±‚ (Problem Verification Layer)

**ç›®æ ‡**: éªŒè¯é›†æˆé—®é¢˜çš„å­˜åœ¨å’Œå½±å“èŒƒå›´

```typescript
// __tests__/integration-issues/api/audit-logs-missing.test.ts
describe('é—®é¢˜éªŒè¯: å®¡è®¡æ—¥å¿—APIç¼ºå¤±', () => {
  beforeAll(async () => {
    // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    await setupTestEnvironment();
  });

  it('åº”è¯¥éªŒè¯å®¡è®¡æ—¥å¿—APIç¡®å®ç¼ºå¤±', async () => {
    const response = await fetch('/api/v2/audit-logs');
    expect(response.status).toBe(404);

    // è®°å½•é—®é¢˜è¯¦æƒ…
    await logIntegrationIssue({
      type: 'API_MISSING',
      endpoint: '/api/v2/audit-logs',
      severity: 'HIGH',
      impact: 'Frontend calls fail',
    });
  });

  it('åº”è¯¥éªŒè¯å‰ç«¯è°ƒç”¨å¤±è´¥çš„å…·ä½“è¡¨ç°', async () => {
    // æ¨¡æ‹Ÿå‰ç«¯è°ƒç”¨
    const frontendCall = async () => {
      return await fetch('/api/v2/audit-logs?page=1&pageSize=10');
    };

    await expect(frontendCall()).rejects.toThrow();
  });
});
```

#### 2. ä¿®å¤éªŒè¯å±‚ (Fix Verification Layer)

**ç›®æ ‡**: ç¡®ä¿ä¿®å¤æ–¹æ¡ˆçš„æœ‰æ•ˆæ€§

```typescript
// __tests__/integration-issues/api/user-profile-update.test.ts
describe('ä¿®å¤éªŒè¯: ç”¨æˆ·èµ„æ–™æ›´æ–°ç«¯ç‚¹', () => {
  describe('ä¿®å¤å‰çŠ¶æ€éªŒè¯', () => {
    it('åº”è¯¥ç¡®è®¤ç«¯ç‚¹ä¸å­˜åœ¨', async () => {
      const response = await fetch('/api/v2/users/me', {
        method: 'PUT',
        headers: { Authorization: `Bearer ${validToken}` },
      });
      expect(response.status).toBe(404);
    });
  });

  describe('ä¿®å¤ååŠŸèƒ½éªŒè¯', () => {
    beforeAll(async () => {
      // è¿™é‡Œå‡è®¾ä¿®å¤å·²ç»å®æ–½
      await waitForFixImplementation();
    });

    it('åº”è¯¥æ”¯æŒç”¨æˆ·èµ„æ–™æ›´æ–°', async () => {
      const updateData = {
        email: 'updated@test.com',
        displayName: 'æ›´æ–°çš„ç”¨æˆ·å',
      };

      const response = await fetch('/api/v2/users/me', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${validToken}`,
        },
        body: JSON.stringify(updateData),
      });

      expect(response.status).toBe(200);
      const result = await response.json();
      expect(result.data.email).toBe(updateData.email);
    });

    it('åº”è¯¥éªŒè¯æ•°æ®å®Œæ•´æ€§', async () => {
      // éªŒè¯æ›´æ–°åçš„æ•°æ®åœ¨æ•°æ®åº“ä¸­æ­£ç¡®ä¿å­˜
      const user = await getUserFromDatabase(testUserId);
      expect(user.email).toBe('updated@test.com');
    });
  });
});
```

#### 3. å›å½’æµ‹è¯•å±‚ (Regression Test Layer)

**ç›®æ ‡**: é˜²æ­¢å·²ä¿®å¤é—®é¢˜çš„é‡æ–°å‡ºç°

```typescript
// __tests__/integration-issues/regression/integration-issues.test.ts
describe('é›†æˆé—®é¢˜å›å½’æµ‹è¯•å¥—ä»¶', () => {
  const criticalEndpoints = [
    '/api/v2/audit-logs',
    '/api/v2/users/me',
    '/api/v2/clients/{id}/secret',
    '/api/v2/oauth/revoke',
  ];

  describe('å…³é”®ç«¯ç‚¹å¯ç”¨æ€§å›å½’æµ‹è¯•', () => {
    criticalEndpoints.forEach((endpoint) => {
      it(`${endpoint} åº”è¯¥ä¿æŒå¯ç”¨`, async () => {
        const testEndpoint = endpoint.replace('{id}', 'test-client-001');
        const response = await fetch(testEndpoint, {
          method: getMethodForEndpoint(endpoint),
          headers: getHeadersForEndpoint(endpoint),
        });

        expect(response.status).not.toBe(404);
        expect(response.status).not.toBe(500);
      });
    });
  });

  describe('æ•°æ®ä¸€è‡´æ€§å›å½’æµ‹è¯•', () => {
    it('åº”è¯¥ä¿æŒå‰åç«¯æ•°æ®æ ¼å¼ä¸€è‡´', async () => {
      const endpoints = ['/api/v2/users/me', '/api/v2/oauth/userinfo'];

      for (const endpoint of endpoints) {
        const response = await fetch(endpoint, {
          headers: { Authorization: `Bearer ${validToken}` },
        });

        const data = await response.json();
        await validateDataSchema(endpoint, data);
      }
    });
  });

  describe('å®‰å…¨æ€§å›å½’æµ‹è¯•', () => {
    it('åº”è¯¥ä¿æŒä»¤ç‰Œæ’¤é”€åŠŸèƒ½æ­£å¸¸', async () => {
      const token = await generateTestToken();

      // æ’¤é”€ä»¤ç‰Œ
      await fetch('/api/v2/oauth/revoke', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          token: token,
          token_type_hint: 'access_token',
        }),
      });

      // éªŒè¯ä»¤ç‰Œå·²å¤±æ•ˆ
      const response = await fetch('/api/v2/oauth/userinfo', {
        headers: { Authorization: `Bearer ${token}` },
      });

      expect(response.status).toBe(401);
    });
  });
});
```

#### 4. æŒç»­é›†æˆå±‚ (Continuous Integration Layer)

**ç›®æ ‡**: åœ¨CI/CDæµç¨‹ä¸­é›†æˆé—®é¢˜æ£€æµ‹

```typescript
// __tests__/integration-issues/monitoring/integration-health.test.ts
describe('é›†æˆå¥åº·ç›‘æ§', () => {
  describe('APIç«¯ç‚¹å¥åº·æ£€æŸ¥', () => {
    it('åº”è¯¥ç›‘æ§æ‰€æœ‰å…³é”®ç«¯ç‚¹çš„å¥åº·çŠ¶æ€', async () => {
      const healthCheck = new IntegrationHealthChecker();
      const results = await healthCheck.checkAllEndpoints();

      const failedEndpoints = results.filter((r) => !r.healthy);

      if (failedEndpoints.length > 0) {
        await notifyIntegrationIssues(failedEndpoints);

        // åœ¨CIç¯å¢ƒä¸­ï¼Œå¦‚æœæœ‰å…³é”®ç«¯ç‚¹å¤±è´¥ï¼Œåº”è¯¥å¤±è´¥æ„å»º
        if (process.env.CI && hasHighSeverityIssues(failedEndpoints)) {
          throw new Error(
            `å…³é”®é›†æˆé—®é¢˜æ£€æµ‹åˆ°: ${failedEndpoints.map((f) => f.endpoint).join(', ')}`
          );
        }
      }

      expect(failedEndpoints.length).toBe(0);
    });
  });

  describe('æ€§èƒ½å›å½’ç›‘æ§', () => {
    it('åº”è¯¥ç›‘æ§APIå“åº”æ—¶é—´', async () => {
      const performanceMonitor = new PerformanceMonitor();
      const metrics = await performanceMonitor.measureEndpoints([
        '/api/v2/audit-logs',
        '/api/v2/users/me',
        '/api/v2/clients',
      ]);

      metrics.forEach((metric) => {
        expect(metric.responseTime).toBeLessThan(1000); // 1ç§’é˜ˆå€¼
        expect(metric.errorRate).toBeLessThan(0.01); // 1%é”™è¯¯ç‡é˜ˆå€¼
      });
    });
  });

  describe('æ•°æ®å®Œæ•´æ€§ç›‘æ§', () => {
    it('åº”è¯¥éªŒè¯å…³é”®æ•°æ®çš„å®Œæ•´æ€§', async () => {
      const integrityChecker = new DataIntegrityChecker();
      const issues = await integrityChecker.checkCriticalData();

      if (issues.length > 0) {
        await logDataIntegrityIssues(issues);
      }

      expect(issues).toHaveLength(0);
    });
  });
});
```

## E2Eæµ‹è¯•æ¶æ„è®¾è®¡

### 1. ç‹¬ç«‹æµ‹è¯•ç¯å¢ƒ

#### Admin Portalæµ‹è¯•é…ç½®

```typescript
// apps/admin-portal/playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  outputDir: './test-results',
  reporter: [
    ['html', { outputFolder: './playwright-report' }],
    ['json', { outputFile: './test-results/results.json' }],
    ['junit', { outputFile: './test-results/junit.xml' }],
  ],

  // å¤šæµè§ˆå™¨æ”¯æŒ
  projects: [
    { name: 'Desktop Chrome', use: { ...devices['Desktop Chrome'] } },
    { name: 'Desktop Firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'Desktop Safari', use: { ...devices['Desktop Safari'] } },
    { name: 'Mobile Chrome', use: { ...devices['Pixel 5'] } },
  ],

  // å…¨å±€è®¾ç½®
  globalSetup: require.resolve('./tests/helpers/global-setup'),
  globalTeardown: require.resolve('./tests/helpers/global-teardown'),

  use: {
    baseURL: process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3002',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
});
```

### 2. æµ‹è¯•ç”¨ä¾‹ç»„ç»‡

#### ç®¡ç†åŠŸèƒ½æµ‹è¯•

```typescript
// apps/admin-portal/tests/e2e/admin-management.spec.ts
test.describe('Admin Portal ç®¡ç†åŠŸèƒ½æµ‹è¯•', () => {
  test.beforeEach(async ({ page }) => {
    await page.context().clearCookies();
    await loginAsAdmin(page);
  });

  test('åº”è¯¥èƒ½å¤Ÿè®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢', async ({ page }) => {
    await page.goto('/admin/users');
    await expect(page.locator('h1, h2')).toContainText(/ç”¨æˆ·ç®¡ç†|Users/);
  });

  test('åº”è¯¥èƒ½å¤ŸæŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨å’Œåˆ†é¡µ', async ({ page }) => {
    // æµ‹è¯•ç”¨æˆ·åˆ—è¡¨åŠŸèƒ½
  });

  test('æƒé™æ£€æŸ¥åº”è¯¥æ­£å¸¸å·¥ä½œ', async ({ page }) => {
    // æµ‹è¯•RBACæƒé™æ§åˆ¶
  });
});
```

#### OAuthè®¤è¯æµç¨‹æµ‹è¯•

```typescript
// apps/admin-portal/tests/e2e/oauth-flow.spec.ts
test.describe('Admin Portal OAuthè®¤è¯æµç¨‹', () => {
  test('OAuthå›è°ƒåº”è¯¥æ­£å¸¸å¤„ç†', async ({ page }) => {
    // æ¨¡æ‹ŸOAuthæˆæƒç æµç¨‹
    await page.route('**/api/v2/oauth/token', async (route) => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          access_token: 'mock_access_token',
          refresh_token: 'mock_refresh_token',
        }),
      });
    });

    // æµ‹è¯•å›è°ƒå¤„ç†é€»è¾‘
  });

  test('Tokenå­˜å‚¨åº”è¯¥å®‰å…¨å¤„ç†', async ({ page }) => {
    // éªŒè¯Cookie + sessionStorageå®‰å…¨å­˜å‚¨
    const cookies = await page.context().cookies();
    const authCookie = cookies.find((cookie) => cookie.name === 'auth_token');
    expect(authCookie).toBeDefined();
  });
});
```

### 3. æµ‹è¯•è¾…åŠ©å·¥å…·

#### è®¤è¯è¾…åŠ©å‡½æ•°

```typescript
// apps/admin-portal/tests/helpers/auth-helpers.ts
export class AuthHelpers {
  /**
   * ç®¡ç†å‘˜ç™»å½•è¾…åŠ©å‡½æ•°
   */
  static async loginAsAdmin(page: Page): Promise<void> {
    await page.goto('/login');
    await page.fill('input[name="username"]', 'admin');
    await page.fill('input[name="password"]', 'admin123');
    await page.click('button[type="submit"]');
    await page.waitForLoadState('networkidle');
  }

  /**
   * æ¨¡æ‹ŸOAuth Tokenå“åº”
   */
  static async mockOAuthToken(page: Page): Promise<void> {
    await page.route('**/api/v2/oauth/token', async (route) => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          access_token: 'test_access_token',
          refresh_token: 'test_refresh_token',
          token_type: 'Bearer',
          expires_in: 3600,
        }),
      });
    });
  }
}
```

#### æµ‹è¯•æ•°æ®ç®¡ç†

```typescript
// apps/admin-portal/tests/helpers/test-data.ts
export class TestDataManager {
  /**
   * åˆ›å»ºæµ‹è¯•ç”¨æˆ·
   */
  static async createTestUser(userData: Partial<User>): Promise<User> {
    // åˆ›å»ºæµ‹è¯•ç”¨æˆ·é€»è¾‘
  }

  /**
   * æ¸…ç†æµ‹è¯•æ•°æ®
   */
  static async cleanupTestData(): Promise<void> {
    // æ¸…ç†æµ‹è¯•æ•°æ®é€»è¾‘
  }

  /**
   * è·å–æµ‹è¯•OAuthå®¢æˆ·ç«¯é…ç½®
   */
  static getTestClientConfig(): ClientConfig {
    return {
      clientId: 'test-client-id',
      clientSecret: 'test-client-secret',
      redirectUri: 'http://localhost:3002/auth/callback',
    };
  }
}
```

## æµ‹è¯•ç¯å¢ƒé…ç½®

### 1. å…¨å±€è®¾ç½®

```typescript
// apps/admin-portal/tests/helpers/global-setup.ts
async function globalSetup(config: FullConfig) {
  console.log('ğŸš€ å¼€å§‹Admin Portalæµ‹è¯•è®¾ç½®...');

  try {
    // æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    await checkServices();

    // åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
    await initializeTestDatabase();

    // é¢„çƒ­åº”ç”¨
    await warmupApplication();

    console.log('âœ… Admin Portalæµ‹è¯•ç¯å¢ƒå‡†å¤‡å°±ç»ª');
  } catch (error) {
    console.error('âŒ æµ‹è¯•ç¯å¢ƒè®¾ç½®å¤±è´¥:', error);
    throw error;
  }
}

async function checkServices() {
  const adminPortalUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3002';
  const oauthServiceUrl =
    process.env.NEXT_PUBLIC_OAUTH_SERVICE_URL || 'http://localhost:3001/datamgr_flow';

  const services = [
    { name: 'admin-portal', url: `${adminPortalUrl}/api/menu` },
    { name: 'oauth-service', url: `${oauthServiceUrl}/api/v2/.well-known/openid-configuration` },
  ];

  for (const service of services) {
    const response = await fetch(service.url);
    if (!response.ok) {
      throw new Error(`${service.name} æœåŠ¡ä¸å¯ç”¨: ${response.status}`);
    }
    console.log(`âœ… ${service.name} æœåŠ¡è¿è¡Œæ­£å¸¸`);
  }
}
```

### 2. æµ‹è¯•æ‰§è¡Œè„šæœ¬

#### æ ¹ç›®å½•æµ‹è¯•è„šæœ¬é…ç½®

```json
// package.json
{
  "scripts": {
    "test": "jest",
    "test:unit": "jest __tests__/unit",
    "test:integration": "jest __tests__/integration",
    "test:e2e": "jest __tests__/e2e",
    "test:integration-issues": "jest __tests__/integration-issues",
    "test:integration-issues:api": "jest __tests__/integration-issues/api",
    "test:integration-issues:regression": "jest __tests__/integration-issues/regression",
    "test:integration-issues:monitoring": "jest __tests__/integration-issues/monitoring",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --watchAll=false",
    "test:ci:integration-issues": "jest --ci --coverage --watchAll=false __tests__/integration-issues",
    "test:health-check": "jest __tests__/integration-issues/monitoring/integration-health.test.ts",
    "test:fix-verification": "jest __tests__/integration-issues/api --testNamePattern='ä¿®å¤å'"
  }
}
```

#### Admin Portal E2Eæµ‹è¯•è„šæœ¬

```json
// apps/admin-portal/package.json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:report": "playwright show-report"
  }
}
```

#### é›†æˆé—®é¢˜æµ‹è¯•ä¸“ç”¨é…ç½®

```javascript
// jest.integration-issues.config.js
module.exports = {
  ...require('./jest.config.js'),
  testMatch: ['<rootDir>/__tests__/integration-issues/**/*.test.ts'],
  setupFilesAfterEnv: ['<rootDir>/__tests__/setup/integration-issues-setup.ts'],
  testTimeout: 30000, // é›†æˆé—®é¢˜æµ‹è¯•å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
  reporters: [
    'default',
    [
      'jest-html-reporters',
      {
        publicPath: './test-reports/integration-issues',
        filename: 'integration-issues-report.html',
        expand: true,
      },
    ],
    [
      'jest-junit',
      {
        outputDirectory: './test-reports/integration-issues',
        outputName: 'integration-issues-results.xml',
      },
    ],
  ],
  collectCoverageFrom: [
    'apps/*/src/**/*.{ts,tsx}',
    'packages/*/src/**/*.{ts,tsx}',
    '!**/*.d.ts',
    '!**/*.test.{ts,tsx}',
    '!**/node_modules/**',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
    // é›†æˆé—®é¢˜ç›¸å…³ä»£ç éœ€è¦æ›´é«˜è¦†ç›–ç‡
    './apps/oauth-service/src/api/v2/': {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90,
    },
  },
};
```

## æµ‹è¯•è¦†ç›–ç­–ç•¥

### 1. E2Eæµ‹è¯•è¦†ç›–èŒƒå›´

| åŠŸèƒ½æ¨¡å—   | æµ‹è¯•åœºæ™¯              | è¦†ç›–ç‡ç›®æ ‡ |
| ---------- | --------------------- | ---------- |
| ç”¨æˆ·è®¤è¯   | ç™»å½•ã€ç™»å‡ºã€OAuthæµç¨‹ | 100%       |
| ç”¨æˆ·ç®¡ç†   | CRUDæ“ä½œã€æƒé™éªŒè¯    | 90%        |
| è§’è‰²ç®¡ç†   | è§’è‰²åˆ†é…ã€æƒé™é…ç½®    | 85%        |
| å®¢æˆ·ç«¯ç®¡ç† | OAuthå®¢æˆ·ç«¯é…ç½®       | 80%        |
| ç³»ç»Ÿè®¾ç½®   | é…ç½®ç®¡ç†ã€å®¡è®¡æ—¥å¿—    | 75%        |

### 2. æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•

| æµè§ˆå™¨        | ç‰ˆæœ¬   | æµ‹è¯•åœºæ™¯     |
| ------------- | ------ | ------------ |
| Chrome        | Latest | å®Œæ•´åŠŸèƒ½æµ‹è¯• |
| Firefox       | Latest | æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• |
| Safari        | Latest | åŸºç¡€åŠŸèƒ½æµ‹è¯• |
| Mobile Chrome | Latest | å“åº”å¼æµ‹è¯•   |

### 3. æµ‹è¯•æ•°æ®è¦†ç›–

- âœ… ç®¡ç†å‘˜è§’è‰²æµ‹è¯•
- âœ… æ™®é€šç”¨æˆ·è§’è‰²æµ‹è¯•
- âœ… æƒé™è¾¹ç•Œæµ‹è¯•
- âœ… å¼‚å¸¸æƒ…å†µæµ‹è¯•
- âœ… ç½‘ç»œé”™è¯¯æµ‹è¯•

## æµ‹è¯•æŠ¥å‘Šä¸ç›‘æ§

### 1. æµ‹è¯•æŠ¥å‘Šæ ¼å¼

```typescript
// æµ‹è¯•ç»“æœæ ¼å¼
interface TestResult {
  passed: number;
  failed: number;
  skipped: number;
  total: number;
  duration: number;
  coverage: {
    statements: number;
    branches: number;
    functions: number;
    lines: number;
  };
  browsers: BrowserResult[];
}
```

### 2. CI/CDé›†æˆ

```yaml
# .github/workflows/test.yml
name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Run integration issues tests âš ï¸ **æ–°å¢**
        run: npm run test:ci:integration-issues
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          CI: true
        continue-on-error: false # é›†æˆé—®é¢˜æµ‹è¯•å¤±è´¥åº”è¯¥é˜»æ­¢éƒ¨ç½²

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Generate integration issues report
        if: always()
        run: |
          mkdir -p ./reports/integration-issues
          npm run test:integration-issues -- --reporters=jest-html-reporters

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: |
            ./test-reports/
            ./reports/

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3

  test-admin-portal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Start services
        run: |
          pnpm dev:oauth-service &
          pnpm dev:admin-portal &
          sleep 30

      - name: Run E2E tests
        run: cd apps/admin-portal && pnpm test:e2e

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: apps/admin-portal/playwright-report/

  # ä¸“é—¨çš„é›†æˆé—®é¢˜ç›‘æ§ä»»åŠ¡
  integration-health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration health check
        run: npm run test:health-check
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          HEALTH_CHECK_MODE: true

      - name: Notify on integration issues
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'ğŸš¨ é›†æˆé—®é¢˜æ£€æµ‹åˆ°ï¼è¯·æ£€æŸ¥é›†æˆå¥åº·çŠ¶æ€ã€‚'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### é›†æˆé—®é¢˜æµ‹è¯•çš„CI/CDæœ€ä½³å®è·µ

#### 1. åˆ†å±‚æµ‹è¯•ç­–ç•¥

```yaml
# .github/workflows/integration-issues.yml
name: Integration Issues Testing

on:
  push:
    paths:
      - 'apps/oauth-service/src/api/v2/**'
      - 'apps/admin-portal/src/**'
      - '__tests__/integration-issues/**'
  pull_request:
    paths:
      - 'apps/oauth-service/src/api/v2/**'
      - 'apps/admin-portal/src/**'

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šé—®é¢˜éªŒè¯
  verify-issues:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup environment
        run: # ç¯å¢ƒè®¾ç½®æ­¥éª¤
      - name: Verify known issues exist
        run: npm run test:integration-issues:api -- --testNamePattern='é—®é¢˜éªŒè¯'
        continue-on-error: true # é¢„æœŸè¿™äº›æµ‹è¯•ä¼šå¤±è´¥

  # ç¬¬äºŒé˜¶æ®µï¼šä¿®å¤éªŒè¯ï¼ˆä»…åœ¨æœ‰ä¿®å¤æ—¶è¿è¡Œï¼‰
  verify-fixes:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[fix]')
    steps:
      - uses: actions/checkout@v3
      - name: Setup environment
        run: # ç¯å¢ƒè®¾ç½®æ­¥éª¤
      - name: Verify fixes work
        run: npm run test:fix-verification

  # ç¬¬ä¸‰é˜¶æ®µï¼šå›å½’æµ‹è¯•
  regression-tests:
    runs-on: ubuntu-latest
    needs: [verify-fixes]
    if: success()
    steps:
      - uses: actions/checkout@v3
      - name: Setup environment
        run: # ç¯å¢ƒè®¾ç½®æ­¥éª¤
      - name: Run regression tests
        run: npm run test:integration-issues:regression
```

#### 2. æµ‹è¯•æŠ¥å‘Šå’Œé€šçŸ¥

```yaml
- name: Generate detailed integration report
  if: always()
  run: |
    node scripts/generate-integration-report.js

- name: Comment PR with integration status
  if: github.event_name == 'pull_request'
  uses: actions/github-script@v6
  with:
    script: |
      const fs = require('fs');
      const report = fs.readFileSync('./reports/integration-summary.md', 'utf8');

      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: `## ğŸ” é›†æˆçŠ¶æ€æŠ¥å‘Š\n\n${report}`
      });
```

#### 3. ç¯å¢ƒç‰¹å®šé…ç½®

```javascript
// __tests__/setup/integration-issues-setup.ts
import { setupTestEnvironment } from '../setup/test-environment';

beforeAll(async () => {
  // è®¾ç½®é›†æˆé—®é¢˜æµ‹è¯•ä¸“ç”¨ç¯å¢ƒ
  await setupTestEnvironment({
    mode: 'integration-issues',
    database: {
      // ä½¿ç”¨ä¸“é—¨çš„æµ‹è¯•æ•°æ®
      seedData: 'integration-issues-seed.sql',
    },
    services: {
      // å¯ç”¨æ‰€æœ‰ç›¸å…³æœåŠ¡
      oauthService: true,
      adminPortal: true,
      auditService: false, // æ•…æ„ç¦ç”¨ä»¥æµ‹è¯•ç¼ºå¤±API
    },
  });
});

// å…¨å±€æµ‹è¯•å·¥å…·
global.logIntegrationIssue = async (issue) => {
  if (process.env.CI) {
    // åœ¨CIç¯å¢ƒä¸­è®°å½•åˆ°æ–‡ä»¶
    const fs = require('fs');
    const logFile = './reports/integration-issues.log';
    fs.appendFileSync(logFile, JSON.stringify(issue) + '\n');
  }
};

global.notifyIntegrationIssues = async (issues) => {
  if (process.env.CI && issues.length > 0) {
    // å‘é€é€šçŸ¥åˆ°ç›‘æ§ç³»ç»Ÿ
    console.log('ğŸš¨ é›†æˆé—®é¢˜æ£€æµ‹åˆ°:', issues);
  }
};
```

## è¿ç§»æŒ‡å—

### 1. è¿ç§»å‰çŠ¶æ€

- âŒ E2Eæµ‹è¯•é›†ä¸­åœ¨æ ¹ç›®å½•
- âŒ æµ‹è¯•é…ç½®åˆ†æ•£ä¸”é‡å¤
- âŒ ç¼ºå°‘ç‹¬ç«‹çš„æµ‹è¯•ç¯å¢ƒ
- âŒ æµ‹è¯•è¾…åŠ©å‡½æ•°é‡å¤å®šä¹‰

### 2. è¿ç§»åçŠ¶æ€

- âœ… E2Eæµ‹è¯•æŒ‰åº”ç”¨ç»„ç»‡
- âœ… ç‹¬ç«‹çš„æµ‹è¯•é…ç½®å’Œç¯å¢ƒ
- âœ… å®Œæ•´çš„æµ‹è¯•è¾…åŠ©å·¥å…·é“¾
- âœ… å¤šæµè§ˆå™¨æ”¯æŒ
- âœ… å®Œå–„çš„æµ‹è¯•æŠ¥å‘Š

### 3. è¿ç§»æ­¥éª¤

1. **åˆ›å»ºç‹¬ç«‹æµ‹è¯•ç¯å¢ƒ**: åœ¨admin-portalä¸­å»ºç«‹å®Œæ•´çš„Playwrighté…ç½®
2. **è¿ç§»æµ‹è¯•ç”¨ä¾‹**: å°†æ ¹ç›®å½•çš„E2Eæµ‹è¯•è¿ç§»åˆ°å¯¹åº”åº”ç”¨
3. **å»ºç«‹æµ‹è¯•è¾…åŠ©**: åˆ›å»ºè®¤è¯ã€æ•°æ®ç®¡ç†ç­‰è¾…åŠ©å·¥å…·
4. **é…ç½®CI/CD**: æ›´æ–°æ„å»ºæµç¨‹æ”¯æŒæ–°çš„æµ‹è¯•æ¶æ„
5. **æ¸…ç†æ—§æµ‹è¯•**: åˆ é™¤æ ¹ç›®å½•ä¸­å·²è¿ç§»çš„æµ‹è¯•æ–‡ä»¶

## æœ€ä½³å®è·µ

### 1. æµ‹è¯•ç»„ç»‡

- âœ… æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡æµ‹è¯•ç”¨ä¾‹
- âœ… ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
- âœ… ä¿æŒæµ‹è¯•ç”¨ä¾‹çš„ç‹¬ç«‹æ€§
- âœ… åˆç†ä½¿ç”¨æµ‹è¯•è¾…åŠ©å‡½æ•°

### 2. æµ‹è¯•æ‰§è¡Œ

- âœ… å¹¶è¡Œæ‰§è¡Œæé«˜æ•ˆç‡
- âœ… å¤±è´¥æ—¶ä¿ç•™æˆªå›¾å’Œè§†é¢‘
- âœ… åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- âœ… ä½¿ç”¨ç¨³å®šçš„é€‰æ‹©å™¨

### 3. æµ‹è¯•ç»´æŠ¤

- âœ… å®šæœŸæ›´æ–°æµ‹è¯•ç”¨ä¾‹
- âœ… ç›‘æ§æµ‹è¯•æ‰§è¡Œæ—¶é—´
- âœ… åŠæ—¶ä¿®å¤ä¸ç¨³å®šçš„æµ‹è¯•
- âœ… ä¿æŒæµ‹è¯•ä»£ç çš„å¯è¯»æ€§

## æ€»ç»“

é€šè¿‡å®æ–½æ–°çš„æµ‹è¯•æ¶æ„è®¾è®¡ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **æµ‹è¯•ç‹¬ç«‹æ€§**: æ¯ä¸ªåº”ç”¨æœ‰ç‹¬ç«‹çš„æµ‹è¯•ç¯å¢ƒï¼Œäº’ä¸å¹²æ‰°
2. **ç»´æŠ¤ä¾¿åˆ©æ€§**: æµ‹è¯•ä»£ç å°±è¿‘ç»„ç»‡ï¼Œä¾¿äºç»´æŠ¤å’Œæ›´æ–°
3. **æ‰§è¡Œæ•ˆç‡**: å¹¶è¡Œæ‰§è¡Œå’Œå¤šæµè§ˆå™¨æ”¯æŒæé«˜æµ‹è¯•æ•ˆç‡
4. **è´¨é‡ä¿è¯**: å®Œå–„çš„æµ‹è¯•è¦†ç›–å’ŒæŠ¥å‘Šæœºåˆ¶

è¿™ä¸ªæµ‹è¯•æ¶æ„ä¸ºOAuth2.1è®¤è¯æˆæƒä¸­å¿ƒæä¾›äº†å¯é çš„è´¨é‡ä¿è¯åŸºç¡€ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚
