# 产品需求文档 (PRD)

> **文档版本**: v6.0.0  
> **创建日期**: 2025-01-28
> **最后更新**: 2025-07-17  
> **文档状态**: 正式版  
> **维护团队**: 产品团队

## 1. 产品概述

### 1.1 产品愿景与目标

**愿景**: 打造一个专为企业内网环境设计，安全、标准、易于集成的认证授权基础设施，采用完整的OAuth 2.1 + OpenID Connect无状态架构。

**核心目标**:

- **标准化**: 提供完全遵循 OAuth 2.1 和 OpenID Connect (OIDC) 规范的认证服务，强制PKCE增强安全。
- **无状态**: 采用无状态JWT令牌机制，不依赖服务器端session，支持水平扩展。
- **双角色架构**: admin-portal同时作为OAuth客户端和认证中心UI，实现自包含的认证生态。
- **企业级RBAC**: 通过JWT内嵌权限信息，实现细粒度的基于角色访问控制。
- **生产可用**: 支持refresh token、JWKS动态密钥轮换、完整的审计日志。

### 1.2 目标用户

| 用户角色           | 核心诉求                                                              |
| :----------------- | :-------------------------------------------------------------------- |
| **企业IT管理员**   | 统一管理内部应用和用户权限；确保系统安全合规；支持admin-portal作为OAuth客户端的自认证流程。 |
| **内网应用开发者** | 通过标准OAuth 2.1流程集成认证功能；admin-portal本身即为第一个接入的OAuth客户端示例。 |
| **安全审计员**     | 监控和审计所有关键操作和访问行为；确保系统符合企业安全策略。          |
| **企业员工**       | 通过admin-portal作为OAuth客户端，实现单点登录(SSO)访问所有内部应用。 |

### 1.3 核心价值主张

- **自包含生态**: admin-portal作为OAuth客户端，同时提供认证中心UI，形成完整的认证闭环。
- **无状态架构**: 不依赖服务器端session，支持云原生部署和水平扩展。
- **生产级安全**: 强制PKCE、JWT签名验证、refresh token支持、JWKS动态密钥管理。
- **开发者友好**: admin-portal作为最佳实践示例，展示如何作为OAuth客户端接入系统。

---

## 2. 用户故事与核心场景

### 2.1 系统初始化场景

- **As an** IT管理员, **I want to** 初始化系统时由oauth-service为admin-portal自动颁发client_id和client_secret, **so that** admin-portal可以作为一个标准的OAuth客户端接入认证系统。

### 2.2 认证流程场景

- **As an** 企业员工, **I want to** 访问dashboard页面时，如果未认证则自动跳转到登录页面, **so that** 我可以完成身份认证。
- **As an** 企业员工, **I want to** 在admin-portal登录页面输入用户名密码后，自动完成OAuth 2.1授权码流程, **so that** 我可以获得访问令牌的权限。
- **As an** 企业员工, **I want to** 在授权页面清楚看到admin-portal作为客户端请求的权限范围, **so that** 我可以做出明智的授权决定。
- **As an** 企业员工, **I want to** 使用refresh token在令牌过期时自动获取新的访问令牌, **so that** 我可以保持持续的登录状态。

### 2.3 管理员场景

- **As an** IT管理员, **I want to** 通过admin-portal管理后台配置admin-portal自身的OAuth客户端设置, **so that** 我可以控制其权限范围和重定向URI。
- **As an** IT管理员, **I want to** 查看JWKS端点提供的公钥信息, **so that** 我可以验证JWT令牌的签名有效性。

---

## 3. 功能需求详述

### 3.1 `oauth-service`: 认证授权核心服务

#### 核心功能模块

| 功能模块               | 需求描述                                                                                            | 优先级 |
| :--------------------- | :-------------------------------------------------------------------------------------------------- | :----- |
| **OAuth 2.1 完整实现** | 提供完整的授权码流程，**强制PKCE (S256)**，支持refresh token，符合OAuth 2.1规范。                    | **P0** |
| **OIDC 1.0 支持**      | 完整实现OpenID Connect协议，包括UserInfo端点、ID Token、标准claims。                               | **P0** |
| **JWKS 动态管理**      | 支持RSA密钥对的动态轮换，通过`/.well-known/jwks.json`提供公钥，支持密钥版本控制。                   | **P0** |
| **admin-portal客户端** | 系统初始化时自动为admin-portal创建OAuth客户端，配置标准权限scope和重定向URI。                       | **P0** |
| **令牌生命周期管理**   | Access Token: 15分钟，Refresh Token: 30天，支持令牌撤销和黑名单机制。                               | **P0** |
| **客户端管理API**      | 提供完整的OAuth客户端CRUD API，支持客户端密钥轮换、权限范围配置、重定向URI验证。                    | **P0** |
| **用户管理API**        | 提供用户账户管理API，支持用户状态管理、密码策略、角色分配。                                         | **P0** |
| **无状态架构**         | 完全无状态设计，不依赖服务器端session，支持水平扩展和云原生部署。                                   | **P0** |

### 3.2 `admin-portal`: 系统管理后台 + OAuth客户端

#### 3.2.1 作为OAuth客户端的功能

| 功能模块               | 需求描述                                                                                  | 优先级 |
| :--------------------- | :---------------------------------------------------------------------------------------- | :----- |
| **客户端注册**         | 系统初始化时自动向oauth-service注册为OAuth客户端，获取client_id和client_secret。          | **P0** |
| **PKCE实现**           | 完整实现PKCE流程，包括code_verifier和code_challenge的生成与验证。                         | **P0** |
| **令牌存储**           | 安全存储access token和refresh token（浏览器localStorage），支持自动刷新。                 | **P0** |
| **权限范围申请**       | 申请标准scope: `openid profile admin:read admin:write`，根据用户权限动态调整。             | **P0** |
| **重定向URI配置**      | 配置标准重定向URI: `https://admin-portal.example.com/auth/callback`。                    | **P0** |

#### 3.2.2 作为认证中心UI的功能

| 功能模块               | 需求描述                                                                                  | 优先级 |
| :--------------------- | :---------------------------------------------------------------------------------------- | :----- |
| **统一登录页**         | 提供标准登录界面，支持用户名密码登录，作为OAuth授权流程的起点。                           | **P0** |
| **授权同意页面**       | 显示admin-portal作为客户端请求的权限详情，提供同意/拒绝选项。                             | **P0** |
| **错误处理页面**       | 处理各种OAuth错误情况（无效客户端、scope冲突、用户拒绝等）。                              | **P0** |
| **令牌刷新机制**       | 在access token过期前自动使用refresh token获取新令牌，保持用户登录状态。                   | **P0** |

#### 3.2.3 管理后台功能

| 功能模块           | 需求描述                                                                                  | 优先级 |
| :----------------- | :---------------------------------------------------------------------------------------- | :----- |
| **仪表盘**         | 基于JWT中的权限信息显示用户可访问的仪表盘数据。                                           | **P1** |
| **用户管理**       | 管理用户账户，支持批量操作，集成RBAC权限控制。                                            | **P0** |
| **角色管理**       | 可视化角色管理，支持权限分配和角色继承。                                                  | **P0** |
| **客户端管理**     | 管理所有OAuth客户端，包括admin-portal自身的客户端配置。                                   | **P0** |
| **个人资料**       | 允许用户查看和修改自己的基本信息和密码。                                                  | **P2** |

### 3.3 完整的OAuth 2.1认证流程

#### 3.3.1 首次访问场景

1. **用户访问dashboard**: `https://admin-portal.example.com/admin`
2. **检查认证状态**: admin-portal检查localStorage中的access token
3. **重定向到授权**: 无有效token，重定向到 `https://oauth-service.example.com/api/v2/oauth/authorize?client_id=admin-portal&response_type=code&scope=openid profile admin:read&redirect_uri=https://admin-portal.example.com/auth/callback&state=xyz&code_challenge=abc&code_challenge_method=S256`
4. **登录页面**: oauth-service检测未认证，重定向到 `https://admin-portal.example.com/auth/login`
5. **用户登录**: 用户输入用户名密码
6. **授权同意**: 登录成功后跳转到授权同意页面 `https://admin-portal.example.com/oauth/consent`
7. **用户授权**: 用户确认授权范围
8. **令牌交换**: admin-portal收到授权码，调用 `POST /oauth/token` 交换access token和refresh token
9. **重定向到目标**: 携带token重定向回原始dashboard页面

#### 3.3.2 令牌刷新场景

1. **检测过期**: admin-portal检测到access token即将过期
2. **自动刷新**: 使用refresh token调用 `POST /oauth/token` (grant_type=refresh_token)
3. **更新存储**: 将新的access token和refresh token存储到localStorage
4. **继续访问**: 用户无感知地继续访问应用

#### 3.3.3 权限验证场景

1. **JWT解析**: admin-portal解析JWT中的权限信息
2. **权限检查**: 根据权限控制界面元素显示
3. **API调用**: 所有API调用都携带JWT进行权限验证
4. **权限更新**: 用户权限变更后通过新的JWT即时生效

---

## 4. 技术规范

### 4.1 令牌规范

#### JWT结构
```json
{
  "iss": "oauth-service",
  "sub": "user-id",
  "aud": "admin-portal",
  "exp": 1234567890,
  "iat": 1234567890,
  "scope": "openid profile admin:read admin:write",
  "permissions": ["user:list", "client:read", "role:update"],
  "user": {
    "id": "user-123",
    "username": "admin",
    "displayName": "系统管理员"
  }
}
```

#### 支持的Claims
- **标准Claims**: `iss`, `sub`, `aud`, `exp`, `iat`, `jti`
- **OIDC Claims**: `name`, `email`, `preferred_username`
- **自定义Claims**: `permissions`, `scope`, `user`

### 4.2 客户端配置规范

#### admin-portal客户端配置
```json
{
  "client_id": "admin-portal",
  "client_secret": "generated-secret",
  "redirect_uris": [
    "https://admin-portal.example.com/auth/callback",
    "http://localhost:3000/auth/callback"
  ],
  "grant_types": [
    "authorization_code",
    "refresh_token"
  ],
  "response_types": [
    "code"
  ],
  "scope": "openid profile admin:read admin:write user:read user:write",
  "token_endpoint_auth_method": "client_secret_post"
}
```

### 4.3 安全要求

#### PKCE强制要求
- **code_challenge_method**: 必须为 `S256`
- **code_challenge**: 最小长度为43字符，最大128字符
- **code_verifier**: 最小长度为43字符，最大128字符

#### 令牌安全
- **签名算法**: RS256 (RSA + SHA256)
- **密钥长度**: 2048位RSA密钥对
- **密钥轮换**: 支持每日、每周或每月自动轮换
- **令牌存储**: 使用浏览器localStorage，支持加密存储

---

## 5. 非功能性需求

### 5.1 性能要求

| 场景                 | 性能指标                 |
| :------------------- | :----------------------- |
| **授权码流程**       | P99响应时间 < 500ms      |
| **令牌刷新**         | P99响应时间 < 200ms      |
| **JWT验证**          | P99响应时间 < 50ms       |
| **页面加载**         | 首次加载 < 2秒           |
| **权限检查**         | 客户端验证 < 10ms        |

### 5.2 安全要求

- **强制PKCE**: 所有授权码流程必须使用PKCE
- **令牌加密**: JWT必须使用RS256非对称签名
- **密钥管理**: 支持JWKS动态密钥轮换
- **权限最小化**: admin-portal客户端仅申请必要权限
- **审计日志**: 记录所有认证和授权操作
- **CSRF防护**: 使用state参数防止CSRF攻击

### 5.3 可用性要求

- **服务可用性**: 99.9%服务可用性
- **故障恢复**: 服务器重启不影响已颁发的令牌
- **水平扩展**: 支持无状态水平扩展
- **负载均衡**: 无需粘性会话的负载均衡支持

### 5.4 兼容性要求

- **浏览器支持**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **协议支持**: OAuth 2.1 (RFC 6749), OIDC 1.0 (RFC 7519)
- **PKCE支持**: RFC 7636标准实现
- **JWKS支持**: RFC 7517标准实现

---

## 6. 部署与运维

### 6.1 初始化流程

1. **系统启动**: oauth-service启动并初始化密钥对
2. **客户端注册**: 自动为admin-portal创建OAuth客户端
3. **权限配置**: 设置admin-portal的标准权限范围
4. **JWKS发布**: 发布初始公钥到JWKS端点
5. **健康检查**: 验证admin-portal客户端配置正确性

### 6.2 监控指标

- **认证成功率**: 登录成功率、授权同意率
- **令牌使用率**: access token使用频率、refresh token使用频率
- **错误率**: 认证失败率、授权拒绝率、令牌过期率
- **性能指标**: 授权流程耗时、令牌验证耗时、页面加载时间

### 6.3 运维工具

- **密钥轮换**: 自动化JWKS密钥轮换工具
- **令牌审计**: JWT令牌使用审计工具
- **客户端管理**: admin-portal客户端配置管理界面
- **健康监控**: 认证服务健康状态监控

---

## 7. 未来展望

- **MFA支持**: 集成TOTP多因素认证
- **SSO扩展**: 支持更多OAuth客户端接入
- **权限细化**: 支持更细粒度的权限控制
- **移动端支持**: 适配移动端认证流程
- **API网关集成**: 与pingora-proxy深度集成