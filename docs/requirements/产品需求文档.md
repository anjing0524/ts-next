# 产品需求文档 (PRD)

> **文档版本**: v6.1.0  
> **最后更新**: 2025-07-22  
> **维护团队**: 产品团队

## 1. 产品概述

### 1.1 产品目标

- **标准化**: OAuth 2.1 + OIDC认证服务，强制PKCE
- **无状态**: JWT令牌机制，支持水平扩展
- **双角色架构**: admin-portal同时作为OAuth客户端和认证服务UI
- **企业级RBAC**: JWT内嵌细粒度权限控制
- **生产可用**: refresh token/JWKS轮换/审计日志

### 1.2 目标用户

| 用户角色           | 核心诉求                                      |
| :----------------- | :-------------------------------------------- |
| **IT管理员**       | 统一管理应用权限，确保安全合规                |
| **应用开发者**     | 标准OAuth集成，管理后台客户端作为示例         |
| **安全审计员**     | 监控关键操作，确保符合安全策略                |
| **企业员工**       | 通过管理后台客户端实现SSO访问                 |

### 1.3 核心价值主张

- **自包含生态**: admin-portal作为OAuth客户端，同时提供认证中心UI，形成完整的认证闭环。
- **无状态架构**: 不依赖服务器端session，支持云原生部署和水平扩展。
- **生产级安全**: 强制PKCE、JWT签名验证、refresh token支持、JWKS动态密钥管理。
- **开发者友好**: admin-portal作为最佳实践示例，展示如何作为OAuth客户端接入系统。

---

## 2. 用户故事与核心场景

### 2.1 系统初始化场景

- **As an** IT管理员, **I want to** 初始化系统时由oauth-service为admin-portal自动颁发client_id和client_secret, **so that** admin-portal可以作为一个标准的OAuth客户端接入认证系统。

### 2.2 认证流程场景

- **As an** 企业员工, **I want to** 访问dashboard页面时，如果未认证则自动跳转到登录页面, **so that** 我可以完成身份认证。
- **As an** 企业员工, **I want to** 在admin-portal登录页面输入用户名密码后，自动完成OAuth 2.1授权码流程, **so that** 我可以获得访问令牌的权限。
- **As an** 企业员工, **I want to** 在授权页面清楚看到admin-portal作为客户端请求的权限范围, **so that** 我可以做出明智的授权决定。
- **As an** 企业员工, **I want to** 使用refresh token在令牌过期时自动获取新的访问令牌, **so that** 我可以保持持续的登录状态。

### 2.3 管理员场景

- **As an** IT管理员, **I want to** 通过admin-portal管理后台配置admin-portal自身的OAuth客户端设置, **so that** 我可以控制其权限范围和重定向URI。
- **As an** IT管理员, **I want to** 查看JWKS端点提供的公钥信息, **so that** 我可以验证JWT令牌的签名有效性。

---

## 3. 功能需求详述

### 3.1 认证服务 (oauth-service)

#### 核心功能

| 功能模块          | 需求描述                                      | 优先级 |
| :---------------- | :-------------------------------------------- | :----- |
| **OAuth 2.1**     | 授权码流程，支持refresh token                 | **P0** |
| **OIDC 1.0**      | UserInfo端点/ID Token/标准claims             | **P0** |
| **JWKS 管理**     | RSA密钥动态轮换，`/.well-known/jwks.json`     | **P0** |
| **管理后台客户端**| 初始化时自动创建客户端配置                    | **P0** |
| **令牌管理**      | Access Token(15分)/Refresh Token(30天)        | **P0** |
| **客户端API**     | OAuth客户端CRUD管理                           | **P0** |
| **用户API**       | 用户账户管理/密码策略/角色分配                | **P0** |

### 3.2 管理后台 (admin-portal)

#### 3.2.1 OAuth客户端功能

| 功能模块          | 需求描述                                      | 优先级 |
| :---------------- | :-------------------------------------------- | :----- |
| **客户端注册**    | 自动获取client_id/client_secret               | **P0** |
| **令牌存储**      | localStorage存储token，支持自动刷新           | **P0** |
| **权限范围**      | `openid profile admin:read admin:write`       | **P0** |
| **重定向URI**     | `https://admin-portal.example.com/auth/callback` | **P0** |

#### 3.2.2 认证服务UI功能

| 功能模块          | 需求描述                                      | 优先级 |
| :---------------- | :-------------------------------------------- | :----- |
| **登录页**        | 标准登录界面                                  | **P0** |
| **授权页面**      | 显示权限详情，提供同意/拒绝选项               | **P0** |
| **错误处理**      | 处理OAuth错误情况                             | **P0** |

#### 3.2.3 管理后台功能

| 功能模块           | 需求描述                                                                                  | 优先级 |
| :----------------- | :---------------------------------------------------------------------------------------- | :----- |
| **仪表盘**         | 基于JWT中的权限信息显示用户可访问的仪表盘数据。                                           | **P1** |
| **用户管理**       | 管理用户账户，支持批量操作，集成RBAC权限控制。                                            | **P0** |
| **角色管理**       | 可视化角色管理，支持权限分配和角色继承。                                                  | **P0** |
| **客户端管理**     | 管理所有OAuth客户端，包括admin-portal自身的客户端配置。                                   | **P0** |
| **个人资料**       | 允许用户查看和修改自己的基本信息和密码。                                                  | **P2** |

### 3.3 完整的OAuth 2.1认证流程

#### 3.3.1 首次访问流程

1. 访问dashboard → 检查token
2. 无token → 重定向到oauth-service/authorize
3. 未认证 → 重定向到auth/login
4. 用户登录
5. 需要授权 → 跳转oauth/consent
6. 用户授权 → 调用/oauth/token交换令牌
7. 重定向回dashboard

#### 3.3.2 令牌刷新场景

1. **检测过期**: admin-portal检测到access token即将过期
2. **自动刷新**: 使用refresh token调用 `POST /oauth/token` (grant_type=refresh_token)
3. **更新存储**: 将新的access token和refresh token存储到localStorage
4. **继续访问**: 用户无感知地继续访问应用

#### 3.3.3 权限验证场景

1. **JWT解析**: admin-portal解析JWT中的权限信息
2. **权限检查**: 根据权限控制界面元素显示
3. **API调用**: 所有API调用都携带JWT进行权限验证
4. **权限更新**: 用户权限变更后通过新的JWT即时生效

---

## 4. 技术规范

### 4.1 令牌规范

#### JWT结构
```json
{
  "iss": "oauth-service",
  "sub": "user-id",
  "aud": "admin-portal",
  "exp": 1234567890,
  "iat": 1234567890,
  "scope": "openid profile admin:read admin:write",
  "permissions": ["user:list", "client:read", "role:update"],
  "user": {
    "id": "user-123",
    "username": "admin",
    "displayName": "系统管理员"
  }
}
```

#### 支持的Claims
- **标准Claims**: `iss`, `sub`, `aud`, `exp`, `iat`, `jti`
- **OIDC Claims**: `name`, `email`, `preferred_username`
- **自定义Claims**: `permissions`, `scope`, `user`

### 4.2 客户端配置规范

#### admin-portal客户端配置
```json
{
  "client_id": "admin-portal",
  "client_secret": "generated-secret",
  "redirect_uris": [
    "https://admin-portal.example.com/auth/callback",
    "http://localhost:3000/auth/callback"
  ],
  "grant_types": [
    "authorization_code",
    "refresh_token"
  ],
  "response_types": [
    "code"
  ],
  "scope": "openid profile admin:read admin:write user:read user:write",
  "token_endpoint_auth_method": "client_secret_post"
}
```

### 4.3 安全要求

#### PKCE强制要求
- **code_challenge_method**: 必须为 `S256`
- **code_challenge**: 最小长度为43字符，最大128字符
- **code_verifier**: 最小长度为43字符，最大128字符

#### 令牌安全
- **签名算法**: RS256 (RSA + SHA256)
- **密钥长度**: 2048位RSA密钥对
- **密钥轮换**: 支持每日、每周或每月自动轮换
- **令牌存储**: 使用浏览器localStorage，支持加密存储

---

## 5. 非功能性需求

### 5.1 性能与安全

| 指标类型       | 要求                                  |
| :------------- | :------------------------------------ |
| **响应时间**   | 授权流程<500ms, 令牌刷新<200ms        |
| **页面加载**   | 首次加载<2秒                          |
| **安全机制**   | 强制PKCE/RS256签名/JWKS轮换/CSRF防护  |
| **权限控制**   | 最小权限原则+完整审计日志             |

### 5.3 可用性要求

- **服务可用性**: 99.9%服务可用性
- **故障恢复**: 服务器重启不影响已颁发的令牌
- **水平扩展**: 支持无状态水平扩展
- **负载均衡**: 无需粘性会话的负载均衡支持

### 5.4 兼容性要求

- **浏览器支持**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **协议支持**: OAuth 2.1 (RFC 6749), OIDC 1.0 (RFC 7519)
- **PKCE支持**: RFC 7636标准实现
- **JWKS支持**: RFC 7517标准实现

---

## 6. 部署与运维

### 6.1 初始化流程

1. **系统启动**: oauth-service启动并初始化密钥对
2. **客户端注册**: 自动为admin-portal创建OAuth客户端
3. **权限配置**: 设置admin-portal的标准权限范围
4. **JWKS发布**: 发布初始公钥到JWKS端点
5. **健康检查**: 验证admin-portal客户端配置正确性

### 6.2 监控指标

- **认证成功率**: 登录成功率、授权同意率
- **令牌使用率**: access token使用频率、refresh token使用频率
- **错误率**: 认证失败率、授权拒绝率、令牌过期率
- **性能指标**: 授权流程耗时、令牌验证耗时、页面加载时间

### 6.3 运维工具

- **密钥轮换**: 自动化JWKS密钥轮换工具
- **令牌审计**: JWT令牌使用审计工具
- **客户端管理**: admin-portal客户端配置管理界面
- **健康监控**: 认证服务健康状态监控

---

## 7. 未来展望

- **MFA支持**: 集成TOTP多因素认证
- **SSO扩展**: 支持更多OAuth客户端接入
- **权限细化**: 支持更细粒度的权限控制
- **移动端支持**: 适配移动端认证流程
- **API网关集成**: 与pingora-proxy深度集成
