# OAuth2.1è®¤è¯æˆæƒä¸­å¿ƒæµ‹è¯•ç­–ç•¥æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2024-01-20  
> **æœ€åæ›´æ–°**: 2024-12-19  
> **æ–‡æ¡£çŠ¶æ€**: æ­£å¼ç‰ˆ  
> **ç»´æŠ¤å›¢é˜Ÿ**: æµ‹è¯•å›¢é˜Ÿ

## æ–‡æ¡£æ‘˜è¦

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†OAuth2.1è®¤è¯æˆæƒä¸­å¿ƒçš„å®Œæ•´æµ‹è¯•ç­–ç•¥ï¼ŒåŒ…æ‹¬æµ‹è¯•ç›®æ ‡ã€æµ‹è¯•èŒƒå›´ã€æµ‹è¯•ç¯å¢ƒè®¾è®¡ã€æµ‹è¯•ç”¨ä¾‹è®¾è®¡ã€è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆç­‰ã€‚ç¡®ä¿ç³»ç»Ÿåœ¨åŠŸèƒ½æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½å’Œå¯é æ€§æ–¹é¢è¾¾åˆ°ä¼ä¸šçº§æ ‡å‡†ã€‚

## ç›®å½•

- [1. æµ‹è¯•æ¦‚è¿°](#1-æµ‹è¯•æ¦‚è¿°)
  - [1.1 æµ‹è¯•ç›®æ ‡](#11-æµ‹è¯•ç›®æ ‡)
  - [1.2 æµ‹è¯•èŒƒå›´](#12-æµ‹è¯•èŒƒå›´)
  - [1.3 æµ‹è¯•ç­–ç•¥](#13-æµ‹è¯•ç­–ç•¥)
- [2. æµ‹è¯•é‡‘å­—å¡”æ¨¡å‹](#2-æµ‹è¯•é‡‘å­—å¡”æ¨¡å‹)
- [3. å•å…ƒæµ‹è¯•](#3-å•å…ƒæµ‹è¯•)
- [4. é›†æˆæµ‹è¯•](#4-é›†æˆæµ‹è¯•)
- [5. å®‰å…¨æµ‹è¯•](#5-å®‰å…¨æµ‹è¯•)
- [6. æ€§èƒ½æµ‹è¯•](#6-æ€§èƒ½æµ‹è¯•)
- [7. ç«¯åˆ°ç«¯æµ‹è¯•](#7-ç«¯åˆ°ç«¯æµ‹è¯•)
- [8. æµ‹è¯•ç¯å¢ƒé…ç½®](#8-æµ‹è¯•ç¯å¢ƒé…ç½®)
- [9. æµ‹è¯•æ•°æ®ç®¡ç†](#9-æµ‹è¯•æ•°æ®ç®¡ç†)
- [10. æµ‹è¯•è‡ªåŠ¨åŒ–æµæ°´çº¿](#10-æµ‹è¯•è‡ªåŠ¨åŒ–æµæ°´çº¿)
- [11. è´¨é‡ä¿è¯](#11-è´¨é‡ä¿è¯)

## 1. æµ‹è¯•æ¦‚è¿°

### 1.1 æµ‹è¯•ç›®æ ‡

æœ¬æµ‹è¯•ç­–ç•¥åŸºäº**æµ‹è¯•é©±åŠ¨å¼€å‘(TDD)**ç†å¿µï¼Œæ—¨åœ¨ç¡®ä¿OAuth2.1è®¤è¯æˆæƒä¸­å¿ƒçš„åŠŸèƒ½å®Œæ•´æ€§ã€å®‰å…¨æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚é€šè¿‡å…¨é¢çš„æµ‹è¯•è¦†ç›–ï¼ŒéªŒè¯ç³»ç»Ÿåœ¨å„ç§åœºæ™¯ä¸‹çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼Œç‰¹åˆ«å…³æ³¨å†…ç½‘ç¯å¢ƒä¸‹çš„è®¤è¯æˆæƒæ ¸å¿ƒåŠŸèƒ½ã€‚

**æ ¸å¿ƒæµ‹è¯•ç›®æ ‡**ï¼š
- **OAuth2.1åè®®åˆè§„æ€§**: ä¸¥æ ¼éµå¾ªRFC 6749ã€RFC 7636ç­‰æ ‡å‡†
- **PKCEå®‰å…¨å¢å¼º**: éªŒè¯PKCEæµç¨‹çš„å®‰å…¨æ€§å’Œæ­£ç¡®æ€§
- **OIDCèº«ä»½è®¤è¯**: ç¡®ä¿OpenID ConnectåŠŸèƒ½çš„å®Œæ•´æ€§
- **RBACæƒé™æ§åˆ¶**: éªŒè¯åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æœºåˆ¶
- **APIå®‰å…¨æ€§**: ç¡®ä¿æ‰€æœ‰APIç«¯ç‚¹çš„å®‰å…¨æ€§
- **æ€§èƒ½å’Œå¯é æ€§**: éªŒè¯ç³»ç»Ÿåœ¨å„ç§è´Ÿè½½ä¸‹çš„è¡¨ç°

### 1.2 æµ‹è¯•èŒƒå›´

#### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
- **OAuth2.1æˆæƒç æ¨¡å¼**: å®Œæ•´çš„æˆæƒç æµç¨‹æµ‹è¯•
- **å®¢æˆ·ç«¯è®¤è¯æ¨¡å¼**: Service-to-Serviceè®¤è¯æµ‹è¯•
- **å¼ºåˆ¶PKCE**: PKCEå‚æ•°ç”Ÿæˆå’ŒéªŒè¯æµ‹è¯•
- **OIDCå…¬é’¥è·å–**: OpenID Connectå…¬é’¥ç«¯ç‚¹æµ‹è¯•
- **RBACæƒé™æ¨¡å‹**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æµ‹è¯•
- **JWTä»¤ç‰Œç®¡ç†**: ä»¤ç‰Œç”Ÿæˆã€éªŒè¯ã€åˆ·æ–°æµ‹è¯•

#### æŠ€æœ¯æ ˆæµ‹è¯•
- **Next.js 15**: å‰ç«¯æ¡†æ¶åŠŸèƒ½æµ‹è¯•
- **Prisma + SQLite**: æ•°æ®åº“æ“ä½œæµ‹è¯•
- **Vitest**: å•å…ƒæµ‹è¯•æ¡†æ¶
- **WebAssembly**: Rustç¼–è¯‘çš„WASMæ¨¡å—æµ‹è¯•

### 1.3 æµ‹è¯•ç­–ç•¥

é‡‡ç”¨åˆ†å±‚æµ‹è¯•ç­–ç•¥ï¼Œç¡®ä¿å„ä¸ªå±‚çº§çš„è´¨é‡ï¼š

1. **å•å…ƒæµ‹è¯•**: å‡½æ•°çº§åˆ«çš„ç»†ç²’åº¦æµ‹è¯•
2. **é›†æˆæµ‹è¯•**: æ¨¡å—é—´äº¤äº’æµ‹è¯•
3. **å®‰å…¨æµ‹è¯•**: å®‰å…¨æ¼æ´å’Œå¨èƒæµ‹è¯•
4. **æ€§èƒ½æµ‹è¯•**: è´Ÿè½½å’Œå‹åŠ›æµ‹è¯•
5. **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´ç”¨æˆ·åœºæ™¯æµ‹è¯•

## 2. æµ‹è¯•é‡‘å­—å¡”æ¨¡å‹

```
æµ‹è¯•åˆ†å±‚ç­–ç•¥:

           /\     E2E Tests (10%)
          /  \    - ç”¨æˆ·åœºæ™¯æµ‹è¯•
         /    \   - æµè§ˆå™¨è‡ªåŠ¨åŒ–
        /______\  - å…³é”®ä¸šåŠ¡æµç¨‹
       /        \
      /          \  Integration Tests (20%)
     /            \ - APIæ¥å£æµ‹è¯•
    /              \- æ•°æ®åº“é›†æˆæµ‹è¯•
   /________________\- ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
  /                  \
 /                    \ Unit Tests (70%)
/______________________\- å‡½æ•°çº§åˆ«æµ‹è¯•
                        - ç»„ä»¶æµ‹è¯•
                        - å·¥å…·å‡½æ•°æµ‹è¯•
```

### 2.1 æµ‹è¯•è¦†ç›–ç›®æ ‡

| æµ‹è¯•ç±»å‹ | è¦†ç›–ç‡ç›®æ ‡ | æ‰§è¡Œé¢‘ç‡ | æ‰§è¡Œæ—¶é—´ |
|----------|------------|----------|----------|
| å•å…ƒæµ‹è¯• | â‰¥ 85% | æ¯æ¬¡æäº¤ | < 5åˆ†é’Ÿ |
| é›†æˆæµ‹è¯• | â‰¥ 75% | æ¯æ¬¡åˆå¹¶ | < 15åˆ†é’Ÿ |
| å®‰å…¨æµ‹è¯• | â‰¥ 90% | æ¯æ—¥æ„å»º | < 30åˆ†é’Ÿ |
| æ€§èƒ½æµ‹è¯• | å…³é”®è·¯å¾„ | æ¯å‘¨æ‰§è¡Œ | < 60åˆ†é’Ÿ |
| E2Eæµ‹è¯• | æ ¸å¿ƒåœºæ™¯ | å‘å¸ƒå‰ | < 45åˆ†é’Ÿ |

## 3. å•å…ƒæµ‹è¯•

### 3.1 æµ‹è¯•æ¡†æ¶

ä½¿ç”¨**Vitest**ä½œä¸ºä¸»è¦æµ‹è¯•æ¡†æ¶ï¼Œé…åˆä»¥ä¸‹å·¥å…·ï¼š

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import path from 'path'

export default defineConfig({
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./vitest.setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      threshold: {
        global: {
          branches: 85,
          functions: 85,
          lines: 85,
          statements: 85
        }
      }
    }
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './')
    }
  }
})
```

### 3.2 æµ‹è¯•åˆ†ç±»

#### 3.2.1 è®¤è¯æˆæƒæ¨¡å—æµ‹è¯•

```typescript
// __tests__/lib/auth/oauth2.test.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { OAuth2Service } from '@/lib/auth/oauth2'

describe('OAuth2Service', () => {
  let oauth2Service: OAuth2Service

  beforeEach(() => {
    oauth2Service = new OAuth2Service()
  })

  describe('æˆæƒç æ¨¡å¼', () => {
    it('åº”è¯¥ç”Ÿæˆæœ‰æ•ˆçš„æˆæƒURL', () => {
      const params = {
        clientId: 'test-client',
        redirectUri: 'http://localhost:3000/callback',
        scope: 'openid profile',
        state: 'random-state'
      }
      
      const authUrl = oauth2Service.generateAuthUrl(params)
      expect(authUrl).toContain('response_type=code')
      expect(authUrl).toContain('client_id=test-client')
    })

    it('åº”è¯¥éªŒè¯PKCEå‚æ•°', () => {
      const codeVerifier = oauth2Service.generateCodeVerifier()
      const codeChallenge = oauth2Service.generateCodeChallenge(codeVerifier)
      
      expect(codeVerifier).toHaveLength(128)
      expect(codeChallenge).toBeTruthy()
      expect(oauth2Service.verifyCodeChallenge(codeVerifier, codeChallenge)).toBe(true)
    })
  })
})
```

#### 3.2.2 JWTå·¥å…·å‡½æ•°æµ‹è¯•

```typescript
// __tests__/lib/auth/jwtUtils.test.ts
import { describe, it, expect } from 'vitest'
import { JWTUtils } from '@/lib/auth/jwtUtils'

describe('JWTUtils', () => {
  const jwtUtils = new JWTUtils()

  describe('ä»¤ç‰Œç”Ÿæˆ', () => {
    it('åº”è¯¥ç”Ÿæˆæœ‰æ•ˆçš„è®¿é—®ä»¤ç‰Œ', async () => {
      const payload = {
        sub: 'user123',
        scope: 'read write',
        iat: Math.floor(Date.now() / 1000)
      }
      
      const token = await jwtUtils.generateAccessToken(payload)
      expect(token).toBeTruthy()
      expect(token.split('.')).toHaveLength(3)
    })

    it('åº”è¯¥éªŒè¯ä»¤ç‰Œç­¾å', async () => {
      const payload = { sub: 'user123' }
      const token = await jwtUtils.generateAccessToken(payload)
      
      const isValid = await jwtUtils.verifyToken(token)
      expect(isValid).toBe(true)
    })
  })
})
```

### 3.3 APIè·¯ç”±æµ‹è¯•

```typescript
// __tests__/api/v2/oauth/token.test.ts
import { describe, it, expect } from 'vitest'
import { POST } from '@/app/api/v2/oauth/token/route'
import { NextRequest } from 'next/server'

describe('/api/v2/oauth/token', () => {
  it('åº”è¯¥å¤„ç†å®¢æˆ·ç«¯è®¤è¯æ¨¡å¼', async () => {
    const request = new NextRequest('http://localhost:3000/api/v2/oauth/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa('client_id:client_secret')
      },
      body: 'grant_type=client_credentials&scope=api:read'
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(200)
    expect(data.access_token).toBeTruthy()
    expect(data.token_type).toBe('Bearer')
  })
})
```

## 4. é›†æˆæµ‹è¯•

### 4.1 æ•°æ®åº“é›†æˆæµ‹è¯•

```typescript
// __tests__/integration/database.test.ts
import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import { PrismaClient } from '@prisma/client'
import { execSync } from 'child_process'

describe('æ•°æ®åº“é›†æˆæµ‹è¯•', () => {
  let prisma: PrismaClient

  beforeEach(async () => {
    // é‡ç½®æµ‹è¯•æ•°æ®åº“
    execSync('npx prisma db push --force-reset', { stdio: 'inherit' })
    prisma = new PrismaClient()
  })

  afterEach(async () => {
    await prisma.$disconnect()
  })

  it('åº”è¯¥åˆ›å»ºå’ŒæŸ¥è¯¢ç”¨æˆ·', async () => {
    const user = await prisma.user.create({
      data: {
        email: 'test@example.com',
        name: 'Test User',
        hashedPassword: 'hashed_password'
      }
    })

    expect(user.id).toBeTruthy()
    expect(user.email).toBe('test@example.com')

    const foundUser = await prisma.user.findUnique({
      where: { email: 'test@example.com' }
    })

    expect(foundUser).toBeTruthy()
    expect(foundUser?.name).toBe('Test User')
  })
})
```

### 4.2 APIé›†æˆæµ‹è¯•

```typescript
// __tests__/integration/oauth-flow.test.ts
import { describe, it, expect } from 'vitest'
import { testClient } from '../utils/test-helpers'

describe('OAuth2.1å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•', () => {
  it('åº”è¯¥å®Œæˆæˆæƒç æ¨¡å¼æµç¨‹', async () => {
    // 1. è·å–æˆæƒç 
    const authResponse = await testClient.get('/api/oauth/authorize', {
      params: {
        response_type: 'code',
        client_id: 'test-client',
        redirect_uri: 'http://localhost:3000/callback',
        scope: 'openid profile',
        code_challenge: 'test-challenge',
        code_challenge_method: 'S256'
      }
    })

    expect(authResponse.status).toBe(302)
    
    // 2. äº¤æ¢è®¿é—®ä»¤ç‰Œ
    const tokenResponse = await testClient.post('/api/v2/oauth/token', {
      grant_type: 'authorization_code',
      code: 'auth_code',
      redirect_uri: 'http://localhost:3000/callback',
      code_verifier: 'test-verifier'
    })

    expect(tokenResponse.status).toBe(200)
    expect(tokenResponse.data.access_token).toBeTruthy()
  })
})
```

## 5. å®‰å…¨æµ‹è¯•

### 5.1 å®‰å…¨æµ‹è¯•ç”¨ä¾‹

#### 5.1.1 PKCEå®‰å…¨æµ‹è¯•

```typescript
// __tests__/security/pkce.test.ts
import { describe, it, expect } from 'vitest'
import { PKCEValidator } from '@/lib/auth/pkce'

describe('PKCEå®‰å…¨æµ‹è¯•', () => {
  it('åº”è¯¥æ‹’ç»æ— æ•ˆçš„code_verifier', () => {
    const validator = new PKCEValidator()
    
    // æµ‹è¯•è¿‡çŸ­çš„verifier
    expect(() => {
      validator.validateCodeVerifier('short')
    }).toThrow('Code verifier too short')
    
    // æµ‹è¯•åŒ…å«éæ³•å­—ç¬¦çš„verifier
    expect(() => {
      validator.validateCodeVerifier('invalid@characters!')
    }).toThrow('Invalid characters in code verifier')
  })

  it('åº”è¯¥éªŒè¯code_challengeåŒ¹é…', () => {
    const validator = new PKCEValidator()
    const verifier = validator.generateCodeVerifier()
    const challenge = validator.generateCodeChallenge(verifier)
    
    expect(validator.verifyChallenge(verifier, challenge)).toBe(true)
    expect(validator.verifyChallenge('wrong-verifier', challenge)).toBe(false)
  })
})
```

#### 5.1.2 JWTå®‰å…¨æµ‹è¯•

```typescript
// __tests__/security/jwt.test.ts
import { describe, it, expect } from 'vitest'
import { JWTSecurity } from '@/lib/auth/jwt-security'

describe('JWTå®‰å…¨æµ‹è¯•', () => {
  it('åº”è¯¥æ‹’ç»è¿‡æœŸçš„ä»¤ç‰Œ', async () => {
    const jwtSecurity = new JWTSecurity()
    
    // åˆ›å»ºå·²è¿‡æœŸçš„ä»¤ç‰Œ
    const expiredToken = await jwtSecurity.createToken({
      sub: 'user123',
      exp: Math.floor(Date.now() / 1000) - 3600 // 1å°æ—¶å‰è¿‡æœŸ
    })
    
    const result = await jwtSecurity.verifyToken(expiredToken)
    expect(result.valid).toBe(false)
    expect(result.error).toBe('Token expired')
  })

  it('åº”è¯¥æ‹’ç»è¢«ç¯¡æ”¹çš„ä»¤ç‰Œ', async () => {
    const jwtSecurity = new JWTSecurity()
    
    const validToken = await jwtSecurity.createToken({ sub: 'user123' })
    const tamperedToken = validToken.slice(0, -10) + 'tampered123'
    
    const result = await jwtSecurity.verifyToken(tamperedToken)
    expect(result.valid).toBe(false)
    expect(result.error).toBe('Invalid signature')
  })
})
```

### 5.2 æ¸—é€æµ‹è¯•

#### 5.2.1 SQLæ³¨å…¥æµ‹è¯•

```typescript
// __tests__/security/sql-injection.test.ts
import { describe, it, expect } from 'vitest'
import { UserService } from '@/lib/services/user-service'

describe('SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯•', () => {
  it('åº”è¯¥é˜²æ­¢SQLæ³¨å…¥æ”»å‡»', async () => {
    const userService = new UserService()
    
    // å°è¯•SQLæ³¨å…¥
    const maliciousEmail = "'; DROP TABLE users; --"
    
    await expect(async () => {
      await userService.findByEmail(maliciousEmail)
    }).not.toThrow()
    
    // éªŒè¯æ•°æ®åº“è¡¨ä»ç„¶å­˜åœ¨
    const users = await userService.getAllUsers()
    expect(Array.isArray(users)).toBe(true)
  })
})
```

## 6. æ€§èƒ½æµ‹è¯•

### 6.1 è´Ÿè½½æµ‹è¯•

```typescript
// __tests__/performance/load.test.ts
import { describe, it, expect } from 'vitest'
import { performance } from 'perf_hooks'

describe('æ€§èƒ½è´Ÿè½½æµ‹è¯•', () => {
  it('ä»¤ç‰Œç”Ÿæˆæ€§èƒ½æµ‹è¯•', async () => {
    const jwtUtils = new JWTUtils()
    const iterations = 1000
    
    const start = performance.now()
    
    for (let i = 0; i < iterations; i++) {
      await jwtUtils.generateAccessToken({ sub: `user${i}` })
    }
    
    const end = performance.now()
    const avgTime = (end - start) / iterations
    
    // å¹³å‡æ¯ä¸ªä»¤ç‰Œç”Ÿæˆæ—¶é—´åº”å°äº10ms
    expect(avgTime).toBeLessThan(10)
  })

  it('å¹¶å‘è¯·æ±‚å¤„ç†æµ‹è¯•', async () => {
    const concurrentRequests = 100
    const promises = []
    
    for (let i = 0; i < concurrentRequests; i++) {
      promises.push(
        fetch('/api/v2/oauth/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ grant_type: 'client_credentials' })
        })
      )
    }
    
    const start = performance.now()
    const responses = await Promise.all(promises)
    const end = performance.now()
    
    // æ‰€æœ‰è¯·æ±‚åº”è¯¥æˆåŠŸ
    responses.forEach(response => {
      expect(response.status).toBe(200)
    })
    
    // æ€»æ—¶é—´åº”å°äº5ç§’
    expect(end - start).toBeLessThan(5000)
  })
})
```

## 7. ç«¯åˆ°ç«¯æµ‹è¯•

### 7.1 Playwrighté…ç½®

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### 7.2 ç”¨æˆ·åœºæ™¯æµ‹è¯•

```typescript
// e2e/oauth-flow.spec.ts
import { test, expect } from '@playwright/test'

test.describe('OAuth2.1ç”¨æˆ·æˆæƒæµç¨‹', () => {
  test('ç”¨æˆ·ç™»å½•å¹¶æˆæƒåº”ç”¨', async ({ page }) => {
    // 1. è®¿é—®åº”ç”¨
    await page.goto('/login')
    
    // 2. ç‚¹å‡»OAuthç™»å½•
    await page.click('[data-testid="oauth-login"]')
    
    // 3. åœ¨æˆæƒé¡µé¢è¾“å…¥å‡­æ®
    await page.fill('[data-testid="username"]', 'testuser@example.com')
    await page.fill('[data-testid="password"]', 'password123')
    await page.click('[data-testid="login-submit"]')
    
    // 4. æˆæƒåº”ç”¨
    await page.click('[data-testid="authorize-button"]')
    
    // 5. éªŒè¯é‡å®šå‘åˆ°åº”ç”¨
    await expect(page).toHaveURL(/\/dashboard/)
    await expect(page.locator('[data-testid="user-info"]')).toBeVisible()
  })

  test('æ‹’ç»æˆæƒåº”è¯¥è¿”å›é”™è¯¯', async ({ page }) => {
    await page.goto('/login')
    await page.click('[data-testid="oauth-login"]')
    
    // ç™»å½•åæ‹’ç»æˆæƒ
    await page.fill('[data-testid="username"]', 'testuser@example.com')
    await page.fill('[data-testid="password"]', 'password123')
    await page.click('[data-testid="login-submit"]')
    await page.click('[data-testid="deny-button"]')
    
    // éªŒè¯é”™è¯¯é¡µé¢
    await expect(page).toHaveURL(/error=access_denied/)
  })
})
```

## 8. æµ‹è¯•ç¯å¢ƒé…ç½®

### 8.1 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.test
DATABASE_URL="file:./test.db"
JWT_SECRET="test-jwt-secret-key"
OAUTH_CLIENT_ID="test-client-id"
OAUTH_CLIENT_SECRET="test-client-secret"
NEXT_PUBLIC_API_URL="http://localhost:3000"
NODE_ENV="test"
```

### 8.2 æµ‹è¯•æ•°æ®åº“è®¾ç½®

```typescript
// vitest.setup.ts
import { beforeAll, afterAll, beforeEach } from 'vitest'
import { execSync } from 'child_process'
import { PrismaClient } from '@prisma/client'

let prisma: PrismaClient

beforeAll(async () => {
  // è®¾ç½®æµ‹è¯•æ•°æ®åº“
  process.env.DATABASE_URL = 'file:./test.db'
  
  // è¿è¡Œæ•°æ®åº“è¿ç§»
  execSync('npx prisma db push --force-reset', { stdio: 'inherit' })
  
  prisma = new PrismaClient()
})

beforeEach(async () => {
  // æ¸…ç†æµ‹è¯•æ•°æ®
  await prisma.user.deleteMany()
  await prisma.client.deleteMany()
  await prisma.authorizationCode.deleteMany()
})

afterAll(async () => {
  await prisma.$disconnect()
})
```

## 9. æµ‹è¯•æ•°æ®ç®¡ç†

### 9.1 æµ‹è¯•æ•°æ®å·¥å‚

```typescript
// __tests__/utils/test-factories.ts
import { faker } from '@faker-js/faker'
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

export class TestDataFactory {
  /**
   * åˆ›å»ºæµ‹è¯•ç”¨æˆ·
   */
  static async createUser(overrides: Partial<User> = {}) {
    return await prisma.user.create({
      data: {
        email: faker.internet.email(),
        name: faker.person.fullName(),
        hashedPassword: await hashPassword('password123'),
        ...overrides
      }
    })
  }

  /**
   * åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯
   */
  static async createClient(overrides: Partial<Client> = {}) {
    return await prisma.client.create({
      data: {
        clientId: faker.string.uuid(),
        clientSecret: faker.string.alphanumeric(32),
        name: faker.company.name(),
        redirectUris: ['http://localhost:3000/callback'],
        ...overrides
      }
    })
  }

  /**
   * åˆ›å»ºæµ‹è¯•æˆæƒç 
   */
  static async createAuthorizationCode(userId: string, clientId: string) {
    return await prisma.authorizationCode.create({
      data: {
        code: faker.string.alphanumeric(32),
        userId,
        clientId,
        redirectUri: 'http://localhost:3000/callback',
        scope: 'openid profile',
        codeChallenge: faker.string.alphanumeric(43),
        codeChallengeMethod: 'S256',
        expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10åˆ†é’Ÿåè¿‡æœŸ
      }
    })
  }
}
```

### 9.2 æµ‹è¯•åŠ©æ‰‹å‡½æ•°

```typescript
// __tests__/utils/test-helpers.ts
import { NextRequest, NextResponse } from 'next/server'
import { JWTUtils } from '@/lib/auth/jwtUtils'

/**
 * åˆ›å»ºæ¨¡æ‹Ÿçš„NextRequestå¯¹è±¡
 */
export function createMockRequest(url: string, options: RequestInit = {}) {
  return new NextRequest(url, options)
}

/**
 * åˆ›å»ºæµ‹è¯•ç”¨çš„JWTä»¤ç‰Œ
 */
export async function createTestToken(payload: any) {
  const jwtUtils = new JWTUtils()
  return await jwtUtils.generateAccessToken(payload)
}

/**
 * æ¨¡æ‹Ÿè®¤è¯ä¸­é—´ä»¶
 */
export function mockAuthMiddleware(user: any) {
  return (req: NextRequest) => {
    // åœ¨è¯·æ±‚ä¸­æ·»åŠ ç”¨æˆ·ä¿¡æ¯
    (req as any).user = user
    return req
  }
}

/**
 * ç­‰å¾…æŒ‡å®šæ—¶é—´
 */
export function sleep(ms: number) {
  return new Promise(resolve => setTimeout(resolve, ms))
}
```

## 10. æµ‹è¯•è‡ªåŠ¨åŒ–æµæ°´çº¿

### 10.1 GitHub Actionsé…ç½®

```yaml
# .github/workflows/test.yml
name: æµ‹è¯•æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: è¿è¡Œä»£ç æ£€æŸ¥
      run: npm run lint
    
    - name: è¿è¡Œç±»å‹æ£€æŸ¥
      run: npm run type-check
    
    - name: è®¾ç½®æµ‹è¯•æ•°æ®åº“
      run: |
        npx prisma generate
        npx prisma db push --force-reset
    
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: npm run test:unit
    
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: npm run test:integration
    
    - name: è¿è¡ŒE2Eæµ‹è¯•
      run: |
        npm run build
        npm run test:e2e
    
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
```

### 10.2 npm scriptsé…ç½®

```json
{
  "scripts": {
    "test": "vitest",
    "test:unit": "vitest run --coverage",
    "test:integration": "vitest run --config vitest.integration.config.ts",
    "test:e2e": "playwright test",
    "test:security": "vitest run --config vitest.security.config.ts",
    "test:performance": "vitest run --config vitest.performance.config.ts",
    "test:watch": "vitest --watch",
    "test:ui": "vitest --ui",
    "coverage": "vitest run --coverage",
    "coverage:open": "open coverage/index.html"
  }
}
```

## 11. è´¨é‡ä¿è¯

### 11.1 è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ |
|----------|--------|----------|
| ä»£ç è¦†ç›–ç‡ | â‰¥ 85% | è‡ªåŠ¨åŒ–æŠ¥å‘Š |
| æµ‹è¯•é€šè¿‡ç‡ | 100% | CI/CDæµæ°´çº¿ |
| æ€§èƒ½åŸºå‡† | < 100ms | æ€§èƒ½æµ‹è¯• |
| å®‰å…¨æ‰«æ | 0ä¸ªé«˜å±æ¼æ´ | å®‰å…¨æµ‹è¯• |
| ä»£ç è´¨é‡ | Açº§ | SonarQube |

### 11.2 è´¨é‡é—¨ç¦

```typescript
// scripts/quality-gate.ts
import { execSync } from 'child_process'

/**
 * è´¨é‡é—¨ç¦æ£€æŸ¥
 */
function runQualityGate() {
  console.log('ğŸš€ å¼€å§‹è´¨é‡é—¨ç¦æ£€æŸ¥...')
  
  try {
    // 1. ä»£ç æ ¼å¼æ£€æŸ¥
    console.log('ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼...')
    execSync('npm run lint', { stdio: 'inherit' })
    
    // 2. ç±»å‹æ£€æŸ¥
    console.log('ğŸ” æ£€æŸ¥TypeScriptç±»å‹...')
    execSync('npm run type-check', { stdio: 'inherit' })
    
    // 3. å•å…ƒæµ‹è¯•
    console.log('ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...')
    execSync('npm run test:unit', { stdio: 'inherit' })
    
    // 4. å®‰å…¨æ‰«æ
    console.log('ğŸ”’ è¿è¡Œå®‰å…¨æ‰«æ...')
    execSync('npm audit --audit-level=high', { stdio: 'inherit' })
    
    console.log('âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡ï¼')
  } catch (error) {
    console.error('âŒ è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥ï¼')
    process.exit(1)
  }
}

runQualityGate()
```

### 11.3 æŒç»­ç›‘æ§

```typescript
// lib/monitoring/test-metrics.ts
/**
 * æµ‹è¯•æŒ‡æ ‡æ”¶é›†
 */
export class TestMetrics {
  /**
   * æ”¶é›†æµ‹è¯•æ‰§è¡ŒæŒ‡æ ‡
   */
  static collectTestMetrics(results: TestResults) {
    const metrics = {
      totalTests: results.numTotalTests,
      passedTests: results.numPassedTests,
      failedTests: results.numFailedTests,
      coverage: results.coverageMap?.getCoverageSummary(),
      duration: results.testResults.reduce((acc, test) => acc + test.perfStats.runtime, 0),
      timestamp: new Date().toISOString()
    }
    
    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    this.sendToMonitoring(metrics)
  }
  
  private static sendToMonitoring(metrics: any) {
    // å®ç°ç›‘æ§æ•°æ®å‘é€é€»è¾‘
    console.log('ğŸ“Š æµ‹è¯•æŒ‡æ ‡:', metrics)
  }
}
```

## æ€»ç»“

æœ¬æµ‹è¯•ç­–ç•¥æ–‡æ¡£æä¾›äº†OAuth2.1è®¤è¯æˆæƒä¸­å¿ƒçš„å…¨é¢æµ‹è¯•æ¡†æ¶ï¼ŒåŒ…æ‹¬ï¼š

1. **åˆ†å±‚æµ‹è¯•ç­–ç•¥**: ä»å•å…ƒæµ‹è¯•åˆ°ç«¯åˆ°ç«¯æµ‹è¯•çš„å®Œæ•´è¦†ç›–
2. **è‡ªåŠ¨åŒ–æµ‹è¯•**: åŸºäºVitestå’ŒPlaywrightçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆ
3. **å®‰å…¨æµ‹è¯•**: é’ˆå¯¹OAuth2.1å’ŒJWTçš„ä¸“é¡¹å®‰å…¨æµ‹è¯•
4. **æ€§èƒ½æµ‹è¯•**: è´Ÿè½½å’Œå‹åŠ›æµ‹è¯•ç¡®ä¿ç³»ç»Ÿæ€§èƒ½
5. **è´¨é‡ä¿è¯**: å®Œæ•´çš„è´¨é‡é—¨ç¦å’ŒæŒç»­ç›‘æ§æœºåˆ¶

é€šè¿‡éµå¾ªæœ¬æµ‹è¯•ç­–ç•¥ï¼Œå¯ä»¥ç¡®ä¿ç³»ç»Ÿçš„é«˜è´¨é‡äº¤ä»˜å’ŒæŒç»­ç¨³å®šè¿è¡Œã€‚

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£ç”±æµ‹è¯•å›¢é˜Ÿç»´æŠ¤ï¼Œå¦‚æœ‰é—®é¢˜è¯·æäº¤Issueã€‚  
**æœ€åæ›´æ–°**: 2024-12-19  
**ä¸‹æ¬¡å®¡æ ¸**: 2025-01-19