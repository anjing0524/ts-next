# 系统架构设计

## 双服务架构

### oauth-service (端口 3001)
**职责**: OAuth 2.1 授权服务器，仅提供API

- OAuth 2.1 标准端点实现
- JWT 令牌生成和验证
- RBAC 权限校验
- 客户端管理
- 无任何UI渲染

### admin-portal (端口 3002)
**职责**: 认证中心UI + 管理后台

- 认证页面（登录、授权、错误）
- 管理界面（用户、角色、客户端）
- 同时作为OAuth客户端
- 负责所有用户交互

## 核心流程

### 认证流程
1. 访问受保护资源 → oauth-service/authorize
2. 未认证 → 重定向到 admin-portal/auth/login
3. 登录成功 → 回调 oauth-service 继续流程
4. 需要授权 → 重定向到 admin-portal/oauth/consent
5. 用户决策 → oauth-service 颁发令牌

### 授权流程
1. API请求携带JWT → oauth-service中间件
2. 验证JWT有效性 → 提取用户角色权限
3. 检查端点所需权限 → RBAC校验
4. 允许/拒绝访问 → 记录审计日志

## 技术栈

### 后端技术
- Next.js 15 (API Routes)
- Prisma ORM
- SQLite/PostgreSQL
- Redis (缓存)
- OAuth 2.1 + PKCE
- JWT (RS256)

### 前端技术
- Next.js 15 (App Router)
- React 19
- TypeScript
- TailwindCSS
- shadcn/ui

### 共享包
- @repo/database: 数据库模型
- @repo/lib: 工具函数
- @repo/cache: 缓存层
- @repo/ui: UI组件

## 数据流

### 认证数据流
```
客户端 → oauth-service/authorize
     ↓ (未认证)
admin-portal/login → 用户登录
     ↓
oauth-service/auth/login → 验证
     ↓
oauth-service/authorize → 继续
     ↓ (需授权)
admin-portal/consent → 用户确认
     ↓
oauth-service → 颁发授权码
     ↓
客户端 → oauth-service/token → 获取访问令牌
```

### 授权数据流
```
API请求 → 中间件 → JWT验证
     ↓
提取权限 → RBAC校验
     ↓
允许/拒绝 → 审计记录
```