# OAuth2.1 完整集成计划

> **文档版本**: v1.0.0  
> **创建日期**: 2025-07-10  
> **最后更新**: 2025-07-10  
> **文档状态**: 进行中  
> **维护团队**: AI Assistant  

## 1. 项目概述

### 1.1 目标
实现完整的OAuth2.1第三方客户端集成、权限校验、登录跳转、token获取、权限菜单动态渲染、dashboard及子页面的受保护访问。

### 1.2 核心架构
- **admin-portal**: 提供登录页面和授权页面，作为OAuth客户端
- **oauth-service**: 仅提供OAuth2.1相关API和管理API
- **认证流程**: 必须通过OAuth2.1授权码+PKCE流程，无直接登录API
- **权限模型**: 基于RBAC，包含菜单权限、API权限、操作权限、数据权限四个层级

### 1.3 核心角色定义
- **SYSTEM_ADMIN**: 拥有所有权限，可访问所有功能
- **USER_ADMIN**: 只能管理用户，不能管理角色权限
- **SECURITY_ADMIN**: 可管理角色、权限、客户端、审计
- **USER**: 只能查看仪表盘和个人资料

## 2. 详细集成计划

### 阶段一：OAuth2.1授权码+PKCE登录流程集成

#### 1.1 完善admin-portal登录页面
- **目标**: 实现OAuth2.1授权码+PKCE登录流程
- **实现内容**:
  - 登录页面跳转到oauth-service授权端点
  - 生成PKCE参数(code_verifier, code_challenge)
  - 处理授权回调，获取授权码
  - 使用授权码+PKCE获取access_token
  - 保存token到cookie/localStorage
- **状态**: 🔄 进行中
- **预计时间**: 2小时
- **开始时间**: 2025-07-10

#### 1.2 未登录访问保护
- **目标**: 访问受保护页面时自动跳转登录
- **实现内容**:
  - 所有dashboard页面添加token校验
  - 无token或token无效时自动跳转/login
  - 实现middleware进行全局token校验
- **状态**: ⏳ 待开始
- **预计时间**: 1小时

### 阶段二：权限校验与菜单动态渲染

#### 2.1 菜单API权限过滤
- **目标**: 根据用户权限动态返回菜单
- **实现内容**:
  - 菜单API解析JWT中的permissions claims
  - 根据权限过滤菜单项
  - 支持菜单层级权限控制(menu:system:user:view等)
- **状态**: ⏳ 待开始
- **预计时间**: 1.5小时

#### 2.2 页面级权限保护
- **目标**: dashboard及所有子页面受保护访问
- **实现内容**:
  - 用户管理页面(/admin/users)需要user:list权限
  - 角色管理页面(/admin/system/roles)需要role:list权限
  - 权限管理页面(/admin/system/permissions)需要permission:list权限
  - 客户端管理页面(/admin/system/clients)需要client:list权限
  - 审计日志页面(/admin/system/audits)需要audit:list权限
- **状态**: ⏳ 待开始
- **预计时间**: 2小时

### 阶段三：API权限保护

#### 3.1 API端点权限校验
- **目标**: 所有管理API需要相应权限
- **实现内容**:
  - 用户管理API: user:list, user:create, user:update, user:delete
  - 角色管理API: role:list, role:create, role:update, role:delete
  - 权限管理API: permission:list, permission:create等
  - 客户端管理API: client:list, client:create等
- **状态**: ⏳ 待开始
- **预计时间**: 2小时

#### 3.2 操作级权限控制
- **目标**: 页面内操作按钮根据权限显示/隐藏
- **实现内容**:
  - 创建按钮需要create权限
  - 编辑按钮需要update权限
  - 删除按钮需要delete权限
  - 使用PermissionGuard组件包裹操作元素
- **状态**: ⏳ 待开始
- **预计时间**: 1.5小时

### 阶段四：角色与权限管理功能

#### 4.1 用户管理功能
- **目标**: 完整的用户CRUD操作
- **实现内容**:
  - 用户列表展示(需要user:list权限)
  - 创建用户(需要user:create权限)
  - 编辑用户(需要user:update权限)
  - 删除用户(需要user:delete权限)
  - 用户角色分配(需要user:manage_roles权限)
- **状态**: ⏳ 待开始
- **预计时间**: 2小时

#### 4.2 角色管理功能
- **目标**: 角色及其权限的完整管理
- **实现内容**:
  - 角色列表(需要role:list权限)
  - 创建角色(需要role:create权限)
  - 编辑角色(需要role:update权限)
  - 删除角色(需要role:delete权限)
  - 角色权限分配(需要roles:permissions:assign权限)
- **状态**: ⏳ 待开始
- **预计时间**: 2小时

#### 4.3 权限管理功能
- **目标**: 权限点的管理
- **实现内容**:
  - 权限列表(需要permission:list权限)
  - 创建权限(需要permission:create权限)
  - 编辑权限(需要permission:update权限)
  - 删除权限(需要permission:delete权限)
- **状态**: ⏳ 待开始
- **预计时间**: 1.5小时

#### 4.4 客户端管理功能
- **目标**: OAuth客户端的管理
- **实现内容**:
  - 客户端列表(需要client:list权限)
  - 创建客户端(需要client:create权限)
  - 编辑客户端(需要client:update权限)
  - 删除客户端(需要client:delete权限)
  - 重置客户端密钥(需要oauth:clients:manage权限)
- **状态**: ⏳ 待开始
- **预计时间**: 1.5小时

### 阶段五：完整流程测试

#### 5.1 自动化测试用例
- **未登录访问**: 访问dashboard自动跳转登录页
- **登录流程**: 完成OAuth2.1授权码+PKCE登录
- **权限验证**: 不同角色用户登录后菜单不同
- **API保护**: 无权限访问API返回403
- **页面保护**: 无权限访问页面跳转unauthorized
- **token失效**: token过期后自动跳转登录
- **状态**: ⏳ 待开始
- **预计时间**: 2小时

#### 5.2 角色测试场景
- **SYSTEM_ADMIN**: 拥有所有权限，可访问所有功能
- **USER_ADMIN**: 只能管理用户，不能管理角色权限
- **SECURITY_ADMIN**: 可管理角色、权限、客户端、审计
- **USER**: 只能查看仪表盘和个人资料
- **状态**: ⏳ 待开始
- **预计时间**: 1小时

## 3. 执行进度跟踪

### 3.1 总体进度
- **总任务数**: 12个主要任务
- **已完成**: 0个
- **进行中**: 0个
- **待开始**: 12个
- **预计总时间**: 18.5小时

### 3.2 当前状态
- **当前阶段**: 阶段一
- **当前任务**: 1.1 完善admin-portal登录页面
- **下一步**: 开始实现OAuth2.1授权码+PKCE登录流程

## 4. 技术实现要点

### 4.1 OAuth2.1流程
1. 客户端生成PKCE参数
2. 重定向到授权端点
3. 用户授权后获取授权码
4. 使用授权码+PKCE获取token
5. 保存token并跳转到dashboard

### 4.2 权限校验机制
1. JWT解析获取permissions claims
2. 页面级权限校验
3. API级权限校验
4. 操作级权限控制

### 4.3 菜单动态渲染
1. 根据用户权限过滤菜单项
2. 支持多级菜单权限控制
3. 实时更新菜单显示

## 5. 风险评估与应对

### 5.1 技术风险
- **JWT密钥管理**: 确保密钥正确配置和轮换
- **PKCE实现**: 确保PKCE参数生成和验证正确
- **权限模型**: 确保RBAC模型正确实现

### 5.2 应对措施
- 分阶段实施，每阶段完成后进行测试
- 保持文档与代码同步更新
- 建立自动化测试覆盖关键流程

## 6. 验收标准

### 6.1 功能验收
- [ ] OAuth2.1授权码+PKCE登录流程完整可用
- [ ] 未登录访问受保护页面自动跳转登录
- [ ] 菜单根据用户权限动态显示
- [ ] 所有API端点正确进行权限校验
- [ ] 所有页面正确进行权限保护
- [ ] 不同角色用户登录后功能权限正确

### 6.2 性能验收
- [ ] 登录流程响应时间 < 3秒
- [ ] 菜单加载时间 < 1秒
- [ ] API响应时间 < 2秒

### 6.3 安全验收
- [ ] PKCE流程正确实现
- [ ] JWT签名验证正确
- [ ] 权限校验无绕过漏洞
- [ ] Token安全存储和传输

---

**下一步行动**: 开始阶段一任务1.1，完善admin-portal登录页面的OAuth2.1授权码+PKCE登录流程。 