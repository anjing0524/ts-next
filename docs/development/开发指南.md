# 开发指南

> **文档版本**: v1.0.0
> **最后更新**: 2025-11-11

## 1. 快速入门

### 1.1. 环境要求
- **Node.js**: 20.x+
- **pnpm**: 8.x+
- **Rust**: 1.70+
- **Docker**: 24.0+ (用于数据库)

### 1.2. 环境搭建

1.  **克隆项目**
    ```bash
    git clone <repository-url>
    cd ts-next-template
    ```

2.  **安装依赖**
    ```bash
    pnpm install
    ```

3.  **启动数据库**
    为了方便开发，我们使用Docker来运行PostgreSQL数据库。
    ```bash
    docker-compose up -d postgres
    ```
    *注意: `docker-compose.yml` 文件请参考[部署与运维指南](./../deployment/部署运维文档.md)。*

4.  **初始化数据库**
    ```bash
    # 确保.env文件中的DATABASE_URL指向Docker中的数据库
    # DATABASE_URL="postgresql://user:password@localhost:5432/oauth_db"

    pnpm db:generate  # 生成Prisma客户端
    pnpm db:push      # 推送数据库 schema
    pnpm db:seed      # 填充初始数据
    ```

5.  **启动开发服务器**
    ```bash
    pnpm dev
    ```
    这将同时启动 `oauth-service-rust`, `admin-portal`, 和 `pingora-proxy`。

### 1.3. 访问服务
- **管理后台**: `http://localhost:3002`
- **Pingora代理入口**: `http://localhost:6188`
- **默认管理员**: `admin` / `admin123`

## 2. 项目结构

```
├── apps/
│   ├── oauth-service-rust/ # OAuth 2.1 认证服务 (Rust)
│   ├── admin-portal/       # 管理后台 (Next.js)
│   └── pingora-proxy/      # 反向代理 (Rust)
├── packages/
│   ├── database/           # Prisma schema 和数据库客户端
│   ├── eslint-config/      #共享Eslint配置
│   ├── jest-config/        # 共享Jest配置
│   ├── next-config/        # 共享Next.js配置
│   ├── prettier-config/    # 共享Prettier配置
│   ├── tailwind-config/    # 共享Tailwind配置
│   ├── typescript-config/  # 共享Typescript配置
│   └── ui/                 # 共享React UI组件
└── docs/                   # 项目文档
```

## 3. 开发工作流

### 3.1. 常用命令

- `pnpm dev`: 启动所有服务的开发模式。
- `pnpm build`: 构建所有应用。
- `pnpm test`: 运行所有单元测试和集成测试。
- `pnpm lint`: 检查代码风格。
- `pnpm format`: 格式化所有代码。

### 3.2. 数据库迁移

当你修改了 `packages/database/prisma/schema.prisma` 文件后，你需要创建一个新的迁移并应用它。

```bash
# 1. 创建一个新的迁移文件
pnpm db:migrate:dev --name <your-migration-name>

# 2. 应用迁移 (pnpm dev 会自动做)
pnpm db:push
```

### 3.3. 添加新API端点 (oauth-service-rust)

1.  在 `apps/oauth-service-rust/src/routes/` 目录下创建一个新的模块。
2.  在模块中定义你的Actix-web处理器函数。
3.  在 `apps/oauth-service-rust/src/main.rs` 中注册你的新路由。
4.  添加相应的业务逻辑和数据库查询。
5.  编写集成测试来验证你的新端点。

### 3.4. 添加新页面 (admin-portal)

1.  在 `apps/admin-portal/app/` 目录下创建新的页面或路由组。
2.  使用 `@repo/ui` 中的共享组件或创建新组件。
3.  如果需要，使用 `PermissionGuard` 组件来保护页面。
4.  通过 `fetch` 或 `axios` 调用 `oauth-service-rust` 的API。

## 4. 测试

### 4.1. 单元测试
使用 `jest` 进行单元测试。

```bash
# 运行所有测试
pnpm test

# 运行特定服务的测试
pnpm test --filter=admin-portal
```

### 4.2. 端到端 (E2E) 测试
使用 `playwright` 进行E2E测试。

```bash
# 第一次使用需要安装浏览器
pnpm playwright install

# 运行E2E测试
pnpm test:e2e
```

## 5. 代码质量

项目使用 `eslint` 和 `prettier` 来保证代码质量。在提交代码前，请确保运行了 `lint` 和 `format` 命令。

```bash
pnpm lint
pnpm format
```

项目还配置了 `lint-staged` 和 `husky`，会在 `git commit` 时自动检查和格式化暂存区的文件。
