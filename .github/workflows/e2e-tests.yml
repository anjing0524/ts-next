name: E2E Tests

# E2Eæµ‹è¯•å·¥ä½œæµ
# åœ¨PRå’Œä¸»åˆ†æ”¯æ¨é€æ—¶è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/admin-portal/**'
      - 'apps/oauth-service-rust/**'
      - 'packages/**'
      - '.github/workflows/e2e-tests.yml'

env:
  NODE_ENV: test
  CI: true
  DATABASE_URL: file:./test.db
  NEXT_PUBLIC_OAUTH_SERVICE_URL: http://localhost:3001
  NEXT_PUBLIC_APP_URL: http://localhost:3002
  JWT_SECRET: test-jwt-secret-key-for-e2e-testing-ci
  ENCRYPTION_KEY: test-encryption-key-32-chars-long

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        node-version: [20]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build projects
        run: pnpm build

      - name: ğŸ—„ï¸ Setup test database
        run: |
          cd apps/oauth-service-rust
          mkdir -p data
          DATABASE_URL="sqlite://test.db" sqlx database create
          sqlx migrate run

      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸŒ Install Playwright browsers
        run: |
          cd apps/admin-portal
          pnpm exec playwright install chromium

      - name: ğŸš€ Start OAuth Service (Rust)
        run: |
          cd apps/oauth-service-rust
          DATABASE_URL="sqlite://test.db" cargo build --release
          DATABASE_URL="sqlite://test.db" cargo run --release &
          echo $! > /tmp/oauth-service.pid
          sleep 5

      - name: ğŸš€ Start Admin Portal
        run: |
          cd apps/admin-portal
          pnpm dev &
          echo $! > /tmp/admin-portal.pid
          sleep 5

      - name: ğŸš€ Start Pingora Proxy
        run: |
          cd apps/pingora-proxy
          cargo build --release
          cargo run --release &
          echo $! > /tmp/pingora.pid
          sleep 3

      - name: âœ… Health check services
        run: |
          echo "Checking OAuth Service..."
          curl -f http://localhost:3001/api/v2/health || exit 1

          echo "Checking Admin Portal..."
          curl -f http://localhost:3002 || exit 1

          echo "Checking Pingora Proxy..."
          curl -f http://localhost:6188 || exit 1

          echo "All services are healthy!"

      - name: ğŸ§ª Run E2E tests
        run: |
          cd apps/admin-portal
          pnpm test:e2e:ci
        env:
          PLAYWRIGHT_WORKERS: 1
          PLAYWRIGHT_TEST_BASE_URL: http://localhost:6188

      - name: ğŸ›‘ Stop services
        if: always()
        run: |
          if [ -f /tmp/pingora.pid ]; then kill $(cat /tmp/pingora.pid) || true; fi
          if [ -f /tmp/admin-portal.pid ]; then kill $(cat /tmp/admin-portal.pid) || true; fi
          if [ -f /tmp/oauth-service.pid ]; then kill $(cat /tmp/oauth-service.pid) || true; fi

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            apps/admin-portal/test-results/
            apps/admin-portal/test-results.json
          retention-days: 7

      - name: ğŸ“¸ Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots
          path: apps/admin-portal/test-results/
          retention-days: 7

      - name: ğŸ“ Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'apps/admin-portal/test-results.json';

            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              const { stats } = results;

              const passed = stats.expected || 0;
              const failed = stats.unexpected || 0;
              const skipped = stats.skipped || 0;
              const total = passed + failed + skipped;

              const status = failed > 0 ? 'âŒ Failed' : 'âœ… Passed';

              const comment = `## E2E Test Results ${status}

              ğŸ“Š **Test Summary:**
              - Total: ${total}
              - Passed: ${passed}
              - Failed: ${failed}
              - Skipped: ${skipped}

              ${failed > 0 ? 'âš ï¸ Some tests failed. Please check the test results for details.' : 'ğŸ‰ All tests passed!'}

              ğŸ“ **Artifacts:**
              - Test results and screenshots are available in the workflow artifacts
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: ğŸ“§ Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ E2E Tests Failed - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "GitHub Actions <noreply@github.com>"
          body: |
            E2E tests failed in ${{ github.repository }}

            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

            Workflow: ${{ github.workflow }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please check the workflow logs and test results for details.
          priority: high
        continue-on-error: true

      - name: ğŸ’¬ Send Slack notification
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âŒ E2E Tests Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ E2E Tests Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  # å¯é€‰ï¼šæ€§èƒ½æµ‹è¯•ä½œä¸š
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build projects
        run: pnpm build

      - name: âš¡ Run Lighthouse CI
        run: |
          cd apps/admin-portal
          # è¿™é‡Œå¯ä»¥æ·»åŠ Lighthouse CIæˆ–å…¶ä»–æ€§èƒ½æµ‹è¯•
          echo "Performance tests placeholder"