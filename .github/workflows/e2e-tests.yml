name: E2E Tests

# E2Eæµ‹è¯•å·¥ä½œæµ
# åœ¨PRå’Œä¸»åˆ†æ”¯æ¨é€æ—¶è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/admin-portal/**'
      - 'apps/oauth-service-rust/**'
      - 'packages/**'
      - '.github/workflows/e2e-tests.yml'

env:
  NODE_ENV: test
  CI: true
  DATABASE_URL: file:./test.db
  NEXT_PUBLIC_OAUTH_SERVICE_URL: http://localhost:3001
  NEXT_PUBLIC_APP_URL: http://localhost:3002
  JWT_SECRET: test-jwt-secret-key-for-e2e-testing-ci
  ENCRYPTION_KEY: test-encryption-key-32-chars-long

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        node-version: [20]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build projects
        run: pnpm build

      - name: ğŸ—„ï¸ Setup test database
        run: |
          cd apps/oauth-service-rust
          mkdir -p data
          DATABASE_URL="sqlite://test.db" sqlx database create
          sqlx migrate run

      - name: ğŸŒ Install Playwright browsers
        run: |
          cd apps/admin-portal
          pnpm exec playwright install chromium

      - name: ğŸ§ª Run E2E tests
        run: |
          cd apps/admin-portal
          pnpm test:e2e:ci
        env:
          PLAYWRIGHT_WORKERS: 1

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            apps/admin-portal/test-results/
            apps/admin-portal/test-results.json
          retention-days: 7

      - name: ğŸ“¸ Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots
          path: apps/admin-portal/test-results/
          retention-days: 7

      - name: ğŸ“ Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'apps/admin-portal/test-results.json';
            
            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              const { stats } = results;
              
              const passed = stats.expected || 0;
              const failed = stats.unexpected || 0;
              const skipped = stats.skipped || 0;
              const total = passed + failed + skipped;
              
              const status = failed > 0 ? 'âŒ Failed' : 'âœ… Passed';
              
              const comment = `## E2E Test Results ${status}
              
              ğŸ“Š **Test Summary:**
              - Total: ${total}
              - Passed: ${passed}
              - Failed: ${failed}
              - Skipped: ${skipped}
              
              ${failed > 0 ? 'âš ï¸ Some tests failed. Please check the test results for details.' : 'ğŸ‰ All tests passed!'}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # å¯é€‰ï¼šæ€§èƒ½æµ‹è¯•ä½œä¸š
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build projects
        run: pnpm build

      - name: âš¡ Run Lighthouse CI
        run: |
          cd apps/admin-portal
          # è¿™é‡Œå¯ä»¥æ·»åŠ Lighthouse CIæˆ–å…¶ä»–æ€§èƒ½æµ‹è¯•
          echo "Performance tests placeholder"