// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ================================
// 认证核心模型 (Authentication Core)
// ================================

// 用户表 - 认证系统的核心
model User {
  id           String    @id @default(cuid())
  username     String    @unique
  passwordHash String // BCrypt哈希存储
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  // 用户基本信息
  displayName  String? // 显示名称
  avatar       String? // 头像URL
  phone        String? // 手机号
  organization String? // 用户所属组织
  department   String? // 用户所属部门
  workLocation String? // 用户工作地点

  // 关联关系
  userRoles          UserRole[]
  authorizationCodes AuthorizationCode[]
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]
  auditLogs          AuditLog[]

  @@index([username])
  @@index([isActive])
  @@index([organization])
  @@index([department])
  @@map("users")
}

// OAuth客户端表
model OAuthClient {
  id                String     @id @default(cuid())
  clientId          String     @unique
  clientSecret      String? // 机密客户端的密钥 (BCrypt哈希存储)
  redirectUris      String     @db.Text // JSON字符串存储重定向URI列表
  grantTypes        String     @db.Text // JSON字符串存储授权类型
  responseTypes     String     @db.Text // JSON字符串存储响应类型
  allowedScopes     String     @db.Text // JSON字符串存储权限范围
  clientName        String? // 客户端名称
  clientDescription String? // 客户端描述
  clientType        ClientType @default(PUBLIC) // 客户端类型
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // 关联关系
  authorizationCodes AuthorizationCode[]
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]

  @@index([clientId])
  @@index([isActive])
  @@index([clientType])
  @@map("oauth_clients")
}

enum ClientType {
  PUBLIC // 公开客户端
  CONFIDENTIAL // 机密客户端
}

// 授权码表 (OAuth 2.1 Authorization Code)
model AuthorizationCode {
  id                  String   @id @default(cuid())
  code                String   @unique
  userId              String
  clientId            String
  redirectUri         String
  scope               String   @db.Text // JSON字符串存储权限范围
  expiresAt           DateTime
  codeChallenge       String? // PKCE code challenge
  codeChallengeMethod String? // PKCE code challenge method
  isUsed              Boolean  @default(false)
  createdAt           DateTime @default(now())

  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@index([isUsed])
  @@map("authorization_codes")
}

// 访问令牌表
model AccessToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  clientId  String
  scope     String   @db.Text // JSON字符串存储权限范围
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("access_tokens")
}

// 刷新令牌表
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  clientId  String
  scope     String   @db.Text // JSON字符串存储权限范围
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("refresh_tokens")
}

// ================================
// 权限管理核心 (Permission Management Core)
// ================================

// 角色表
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String // 显示名称
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联关系
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@index([name])
  @@index([isActive])
  @@map("roles")
}

// 权限表 - 统一的权限资源表
model Permission {
  id          String         @id @default(cuid())
  name        String         @unique // 权限唯一标识
  displayName String // 显示名称
  description String? // 权限描述
  resource    String // 资源标识
  action      String // 操作类型 (read, write, delete, execute等)
  type        PermissionType @default(API) // 权限类型
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // 关联关系
  rolePermissions RolePermission[]

  // 类型化资源关联
  apiPermission  ApiPermission?
  menuPermission MenuPermission?
  dataPermission DataPermission?

  @@index([name])
  @@index([resource])
  @@index([action])
  @@index([type])
  @@index([isActive])
  @@map("permissions")
}

enum PermissionType {
  API // API权限
  MENU // 菜单权限
  DATA // 数据权限
}

// API权限详细信息表
model ApiPermission {
  id           String @id @default(cuid())
  permissionId String @unique
  httpMethod   String // HTTP方法 (GET, POST, PUT, DELETE等)
  endpoint     String // API端点路径
  rateLimit    Int? // 速率限制 (每分钟请求数)

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@index([httpMethod])
  @@index([endpoint])
  @@map("api_permissions")
}

// 菜单权限详细信息表
model MenuPermission {
  id           String @id @default(cuid())
  permissionId String @unique
  menuId       String

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  menu       Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId])
  @@map("menu_permissions")
}

// 数据权限详细信息表
model DataPermission {
  id           String  @id @default(cuid())
  permissionId String  @unique
  tableName    String // 数据表名
  columnName   String? // 列名 (可选，用于列级权限)
  conditions   String? @db.Text // 数据过滤条件 (JSON格式)

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@index([tableName])
  @@index([columnName])
  @@map("data_permissions")
}

// 菜单表 - 独立的菜单资源表
model Menu {
  id        String  @id @default(cuid())
  name      String // 菜单名称
  key       String  @unique // 菜单唯一标识
  path      String? // 路由路径
  component String? // 组件路径
  icon      String? // 图标
  order     Int     @default(0) // 排序
  isHidden  Boolean @default(false) // 是否隐藏
  isActive  Boolean @default(true)
  parentId  String? // 父菜单ID

  // 层级关系
  parent   Menu?  @relation("MenuHierarchy", fields: [parentId], references: [id])
  children Menu[] @relation("MenuHierarchy")

  // 权限关联
  menuPermissions MenuPermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([parentId])
  @@index([order])
  @@index([isActive])
  @@map("menus")
}

// 用户角色关联表
model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // ABAC 扩展属性
  context    Json?     @default("{}") // 上下文条件，如时间、地点等
  expiresAt  DateTime? // 角色分配过期时间
  assignedBy String? // 分配者ID
  assignedAt DateTime  @default(now())

  @@id([userId, roleId])
  @@index([expiresAt])
  @@map("user_roles")
}

// 角色权限关联表
model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // ABAC 扩展属性
  conditions Json?    @default("{}") // 权限生效条件
  assignedAt DateTime @default(now())

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ===== 审计与监控 =====
// 审计日志表
model AuditLog {
  id           String   @id @default(uuid())
  timestamp    DateTime @default(now())
  userId       String? // 操作用户ID
  actorType    String // 操作者类型
  actorId      String // 操作者ID
  action       String // 执行的操作
  resourceType String? // 操作的资源类型
  resourceId   String? // 操作的资源ID
  details      Json? // 操作详情
  status       String // 操作状态
  ipAddress    String? // IP地址
  userAgent    String? // 用户代理
  sessionId    String? // 会话ID

  user User? @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([status])
  @@map("audit_logs")
}
