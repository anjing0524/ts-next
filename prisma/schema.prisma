// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===== 用户管理 =====
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String?  @unique
  password  String   // bcrypt哈希，rounds=12
  firstName String?
  lastName  String?
  
  // 用户基础属性 (ABAC支持)
  department      String?   // 部门
  position        String?   // 岗位
  organization    String?   // 单位/组织
  workLocation    String?   // 工作地点
  employeeId      String?   @unique // 工号
  
  // 状态管理
  isActive      Boolean   @default(true)
  isLocked      Boolean   @default(false)
  loginAttempts Int       @default(0)
  lastLoginAt   DateTime?
  
  // 密码策略
  passwordExpiresAt DateTime?
  passwordHistory   Json?     // 存储最近5次密码哈希
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  userRoles         UserRole[]
  userPermissions   UserPermission[]  // 直接分配的权限
  userAttributes    UserAttribute[]   // ABAC用户属性
  accessTokens      AccessToken[]
  refreshTokens     RefreshToken[]
  authorizationCodes AuthorizationCode[]
  auditLogs         AuditLog[]
  
  @@map("users")
  @@index([username])
  @@index([email])
  @@index([isActive, department])
  @@index([employeeId])
}

// ===== RBAC权限模型 =====
model Role {
  id          String  @id @default(uuid())
  name        String  @unique  // 角色标识符 如: "super_admin", "employee"
  displayName String           // 显示名称 如: "超级管理员", "普通员工"
  description String?
  
  // 角色层次
  parentId String?
  parent   Role?   @relation("RoleHierarchy", fields: [parentId], references: [id])
  children Role[]  @relation("RoleHierarchy")
  
  // 状态管理
  isActive  Boolean @default(true)
  isSystem  Boolean @default(false) // 系统角色不可删除
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  userRoles       UserRole[]
  rolePermissions RolePermission[]
  
  @@map("roles")
  @@index([name])
  @@index([parentId])
  @@index([isActive])
}

model Permission {
  id          String @id @default(uuid())
  identifier  String @unique // 权限标识符: "category:resource:action"
  name        String         // 权限名称
  description String?
  
  // 权限分解
  category String  // system, app, api, data, page
  resource String  // 资源标识
  action   String  // 操作类型
  
  // 状态管理
  isActive Boolean @default(true)
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  rolePermissions RolePermission[]
  userPermissions UserPermission[]
  
  @@map("permissions")
  @@index([identifier])
  @@index([category, resource, action])
  @@index([isActive])
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String
  
  // 分配信息
  assignedBy String   // 分配者ID
  assignedAt DateTime @default(now())
  expiresAt  DateTime? // 角色过期时间
  
  // 状态
  isActive Boolean @default(true)
  
  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId])
  @@map("user_roles")
  @@index([userId, isActive])
  @@index([roleId])
  @@index([assignedAt])
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String
  
  // 分配信息
  assignedBy String   // 分配者ID
  assignedAt DateTime @default(now())
  
  // 关联关系
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
  @@index([roleId])
  @@index([permissionId])
}

model UserPermission {
  id           String @id @default(uuid())
  userId       String
  permissionId String
  
  // 分配信息
  assignedBy String   // 分配者ID
  assignedAt DateTime @default(now())
  expiresAt  DateTime? // 权限过期时间
  
  // 状态
  isActive Boolean @default(true)
  
  // 关联关系
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, permissionId])
  @@map("user_permissions")
  @@index([userId, isActive])
  @@index([permissionId])
}

// ===== ABAC策略模型 =====
model Policy {
  id          String @id @default(uuid())
  name        String @unique
  description String?
  
  // 基础策略规则
  rule     String  // 基于基本属性的JavaScript表达式
  effect   String  // ALLOW 或 DENY
  priority Int     // 优先级，数值越大优先级越高
  
  // 策略元数据
  category   String?  // 策略分类: department, position, time, location, ip
  version    String   @default("1.0")
  isActive   Boolean  @default(true)
  
  // 性能统计
  executionCount Int @default(0)
  avgExecutionMs Int @default(0)
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  policyEvaluations PolicyEvaluation[]
  
  @@map("policies")
  @@index([name])
  @@index([isActive, priority])
  @@index([category])
}

model UserAttribute {
  id         String @id @default(uuid())
  userId     String
  name       String // 基本属性名称: department, position, organization, workLocation
  value      String // 属性值
  dataType   String @default("string") // string类型即可
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, name])
  @@map("user_attributes")
  @@index([userId])
  @@index([name, value])
}

model Resource {
  id    String @id @default(uuid())
  type  String // 资源类型：document, project, system等
  identifier String @unique // 资源标识符
  name  String
  
  // 资源基本属性
  owner       String?  // 所有者用户ID
  department  String?  // 归属部门
  organization String? // 归属单位
  
  // 状态
  isActive Boolean @default(true)
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  resourceAttributes ResourceAttribute[]
  
  @@map("resources")
  @@index([type, identifier])
  @@index([owner])
  @@index([department, organization])
}

model ResourceAttribute {
  id         String @id @default(uuid())
  resourceId String
  name       String // 基本属性名称: owner, department, organization
  value      String // 属性值
  dataType   String @default("string")
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@unique([resourceId, name])
  @@map("resource_attributes")
  @@index([resourceId])
  @@index([name, value])
}

// ===== OAuth2.1模型 =====
model OAuthClient {
  id           String @id @default(uuid())
  clientId     String @unique
  clientSecret String? // 机密客户端才有Secret
  name         String
  description  String?
  
  // 客户端配置
  clientType    String   // "public" (SPA/Mobile) 或 "confidential" (Server)
  redirectUris  Json     // 重定向URI数组
  grantTypes    Json     // 支持的授权类型
  scopes        Json     // 允许的作用域
  
  // 安全设置
  accessTokenTTL  Int @default(3600)    // 访问令牌有效期(秒)
  refreshTokenTTL Int @default(604800)  // 刷新令牌有效期(秒)
  allowedIPs      Json?                 // IP白名单
  rateLimit       Int? @default(1000)   // 每小时请求限制
  
  // 状态管理
  isActive  Boolean @default(true)
  isBlocked Boolean @default(false)
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 关联关系
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]
  authorizationCodes AuthorizationCode[]
  
  @@map("oauth_clients")
  @@index([clientId])
  @@index([isActive])
}

model AccessToken {
  id       String @id @default(uuid())
  token    String @unique
  userId   String
  clientId String
  
  // 令牌信息
  scopes    Json     // 授权范围
  expiresAt DateTime
  
  // 令牌元数据
  userAgent String?
  ipAddress String?
  
  // 时间戳
  createdAt DateTime @default(now())
  usedAt    DateTime?
  
  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("access_tokens")
  @@index([token])
  @@index([userId, expiresAt])
  @@index([clientId, createdAt])
}

model RefreshToken {
  id             String @id @default(uuid())
  token          String @unique
  userId         String
  clientId       String
  accessTokenId  String? // 关联的访问令牌
  
  // 令牌信息
  scopes    Json     // 授权范围
  expiresAt DateTime
  
  // 时间戳
  createdAt DateTime @default(now())
  usedAt    DateTime?
  
  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
  @@index([token])
  @@index([userId, expiresAt])
  @@index([clientId])
}

model AuthorizationCode {
  id       String @id @default(uuid())
  code     String @unique
  userId   String
  clientId String
  
  // PKCE支持
  codeChallenge       String
  codeChallengeMethod String @default("S256")
  
  // 授权信息
  redirectUri String
  scopes      Json     // 授权范围
  state       String?  // 客户端状态
  
  // 有效性
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  
  // 时间戳
  createdAt DateTime @default(now())
  usedAt    DateTime?
  
  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("authorization_codes")
  @@index([code])
  @@index([userId, expiresAt])
  @@index([clientId])
  @@index([expiresAt, isUsed])
}

// ===== 权限缓存模型 =====
model PermissionCache {
  id          String @id @default(uuid())
  userId      String
  permission  String // 权限标识符
  resourceId  String? // 资源ID，为空表示通用权限
  contextHash String? // 上下文哈希，用于ABAC缓存
  
  // 缓存结果
  allowed  Boolean
  reason   String  // RBAC_ALLOWED, ABAC_ALLOWED, DENIED等
  ttl      Int     // 生存时间(秒)
  
  // 缓存元数据
  hitCount  Int @default(0)
  createdAt DateTime @default(now())
  expiresAt DateTime
  
  @@unique([userId, permission, resourceId, contextHash])
  @@map("permission_cache")
  @@index([userId, expiresAt])
  @@index([expiresAt])
}

// ===== 策略评估记录 =====
model PolicyEvaluation {
  id           String @id @default(uuid())
  policyId     String
  userId       String
  permission   String
  resourceId   String?
  
  // 评估结果
  result       Boolean  // 策略评估结果
  executionMs  Int      // 执行时间(毫秒)
  context      Json?    // 基本评估上下文: IP、时间、地点等
  
  // 时间戳
  evaluatedAt DateTime @default(now())
  
  // 关联关系
  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  
  @@map("policy_evaluations")
  @@index([policyId, evaluatedAt])
  @@index([userId, permission])
  @@index([evaluatedAt])
}

// ===== 审计日志 =====
model AuditLog {
  id      String @id @default(uuid())
  userId  String?
  
  // 操作信息
  action      String   // LOGIN, LOGOUT, PERMISSION_CHECK, ROLE_ASSIGN等
  resource    String?  // 操作的资源
  details     Json?    // 详细信息
  
  // 请求信息
  ipAddress   String?
  userAgent   String?
  
  // 结果信息
  success     Boolean
  errorMsg    String?
  riskLevel   String   @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL
  
  // 时间戳
  createdAt DateTime @default(now())
  
  // 关联关系
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("audit_logs")
  @@index([userId, action, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
  @@index([riskLevel, createdAt])
}

// ===== 系统配置 =====
model SystemConfig {
  id    String @id @default(uuid())
  key   String @unique
  value String
  description String?
  
  // 配置元数据
  category    String  @default("general")
  dataType    String  @default("string") // string, number, boolean, json
  isEncrypted Boolean @default(false)
  isReadonly  Boolean @default(false)
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("system_config")
  @@index([key])
  @@index([category])
}
