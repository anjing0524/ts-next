// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ================================
// 认证核心模型 (Authentication Core)
// ================================

// 用户表 - 认证系统的核心（内网环境，管理员创建用户）
model User {
  id           String    @id @default(cuid())
  username     String    @unique
  passwordHash String // BCrypt哈希存储
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  // 用户基本信息
  displayName         String? // 显示名称
  firstName           String? // 名
  lastName            String? // 姓
  avatar              String? // 头像URL
  organization        String? // 用户所属组织
  department          String? // 用户所属部门
  mustChangePassword  Boolean   @default(true) // 是否需要在下次登录时强制修改密码
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  createdBy           String? // 创建者ID（管理员）

  // 关联关系
  userRoles          UserRole[]
  authorizationCodes AuthorizationCode[]
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]
  auditLogs          AuditLog[]
  passwordHistories  PasswordHistory[]
  consentGrants      ConsentGrant[]
  revokedAuthJtis    RevokedAuthJti[]

  @@index([username])
  @@index([isActive])
  @@index([organization])
  @@index([department])
  @@map("users")
}

// OAuth客户端表
model OAuthClient {
  id                      String     @id @default(cuid())
  clientId                String     @unique // 客户端唯一标识符
  clientSecret            String? // 机密客户端的密钥 (BCrypt哈希存储)
  redirectUris            String // JSON字符串存储重定向URI列表
  grantTypes              String // JSON字符串存储此客户端允许的授权类型 (e.g., ["authorization_code", "client_credentials"])
  responseTypes           String // JSON字符串存储此客户端允许的响应类型 (e.g., ["code"])
  allowedScopes           String // JSON字符串存储此客户端允许请求的权限范围
  name                    String // 客户端名称 (对应文档中的 'name')
  description             String? // 客户端描述 (对应文档中的 'description')
  clientType              ClientType @default(PUBLIC) // 客户端类型: PUBLIC (公开) 或 CONFIDENTIAL (机密)
  logoUri                 String? // 客户端Logo的URL
  policyUri               String? // 客户端策略文档的URL
  tosUri                  String? // 客户端服务条款的URL
  jwksUri                 String? // 客户端JSON Web Key Set (JWKS) 的URL (用于JWT客户端断言等)
  tokenEndpointAuthMethod String     @default("client_secret_basic") // 令牌端点的客户端认证方法
  requirePkce             Boolean    @default(true) // 是否强制要求PKCE (Proof Key for Code Exchange)
  requireConsent          Boolean    @default(true) // 是否需要用户同意此客户端的授权请求
  ipWhitelist             String? // IP白名单 (JSON字符串格式，如 ["192.168.1.1", "10.0.0.0/8"])
  isActive                Boolean    @default(true) // 客户端是否激活
  createdAt               DateTime   @default(now()) // 创建时间
  updatedAt               DateTime   @updatedAt // 更新时间

  // 关联关系
  authorizationCodes        AuthorizationCode[]
  accessTokens              AccessToken[]
  refreshTokens             RefreshToken[]
  consentGrants             ConsentGrant[] // 用户对此客户端的同意记录
  accessTokenTtl            Int                 @default(3600) // 访问令牌生命周期（秒），对应文档 (原accessTokenLifetime)
  refreshTokenTtl           Int                 @default(2592000) // 刷新令牌生命周期（秒），对应文档 (原refreshTokenLifetime)
  authorizationCodeLifetime Int? // 授权码生命周期（秒）
  strictRedirectUriMatching Boolean             @default(true) // 是否严格匹配重定向URI
  allowLocalhostRedirect    Boolean             @default(false) // 是否允许重定向到localhost (开发时可能有用)
  requireHttpsRedirect      Boolean             @default(true) // 是否要求重定向URI使用HTTPS

  @@index([clientId])
  @@index([isActive])
  @@index([clientType])
  @@index([clientId, isActive])
  @@map("oauth_clients")
}

enum ClientType {
  PUBLIC // 公开客户端
  CONFIDENTIAL // 机密客户端
}

// 授权码表 (OAuth 2.1 Authorization Code)
model AuthorizationCode {
  id                  String   @id @default(cuid()) // 唯一标识符
  code                String   @unique // 授权码本身
  userId              String // 关联的用户ID
  clientId            String // 关联的OAuth客户端ID
  redirectUri         String // 授权时提供的重定向URI
  scope               String // JSON字符串存储授权的权限范围
  expiresAt           DateTime // 授权码过期时间
  codeChallenge       String? // PKCE代码挑战
  codeChallengeMethod String? // PKCE代码挑战方法 (e.g., "S256")
  nonce               String? // OIDC Nonce值，用于防止重放攻击
  isUsed              Boolean  @default(false) // 授权码是否已被使用
  createdAt           DateTime @default(now()) // 创建时间

  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@index([isUsed])
  @@map("authorization_codes")
}

// 访问令牌表
model AccessToken {
  id        String   @id @default(cuid()) // 唯一标识符
  token     String   @unique // 原始令牌字符串 (如果直接存储) - 注意：高安全性要求下通常存储哈希值
  tokenHash String?  @unique // 令牌的哈希值 (推荐用于安全查找和验证)
  userId    String? // 关联的用户ID (客户端凭证模式下可能为空)
  clientId  String // 关联的OAuth客户端ID
  scope     String // JSON字符串存储授权的权限范围
  expiresAt DateTime // 令牌过期时间
  // isRevoked Boolean  @default(false) // 访问令牌通常较短命，不推荐实现撤销逻辑，依赖过期。若需撤销，考虑JTI黑名单。
  // revokedAt DateTime?
  createdAt DateTime @default(now()) // 创建时间

  // 关联关系
  user   User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tokenHash]) // 为令牌哈希值创建索引以提高查询效率
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  // @@index([isRevoked])
  @@map("access_tokens")
}

// 刷新令牌表
model RefreshToken {
  id              String    @id @default(cuid()) // 唯一标识符
  token           String    @unique // 原始令牌字符串 (如果直接存储) - 注意：高安全性要求下通常存储哈希值
  tokenHash       String?   @unique // 令牌的哈希值 (推荐用于安全查找和验证)
  userId          String // 关联的用户ID
  clientId        String // 关联的OAuth客户端ID
  scope           String // JSON字符串存储授权的权限范围 (通常与原始访问令牌一致)
  expiresAt       DateTime // 令牌过期时间
  isRevoked       Boolean   @default(false) // 令牌是否已被撤销
  revokedAt       DateTime? // 令牌撤销时间
  createdAt       DateTime  @default(now()) // 创建时间
  previousTokenId String?   @unique // 可选: 用于刷新令牌轮换机制，指向被替换的旧令牌ID
  // replacedByTokenId String? @unique // 可选: 指向替换此令牌的新令牌ID (用于跟踪轮换链)

  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  // previousToken RefreshToken? @relation("RefreshTokenRotationPrevious", fields: [previousTokenId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_previous_refresh_token")
  // nextToken     RefreshToken? @relation("RefreshTokenRotationNext", fields: [replacedByTokenId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_next_refresh_token")

  @@index([tokenHash]) // 为令牌哈希值创建索引以提高查询效率
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("refresh_tokens")
}

// ================================
// 权限管理核心 (Permission Management Core)
// ================================

// 角色表
model Role {
  id          String   @id @default(cuid()) // 唯一标识符
  name        String   @unique // 角色唯一名称 (e.g., "admin", "editor")
  displayName String // 角色的显示名称 (本地化或UI友好名称)
  description String? // 角色描述
  isActive    Boolean  @default(true) // 角色是否激活
  createdAt   DateTime @default(now()) // 创建时间
  updatedAt   DateTime @updatedAt // 更新时间

  // 关联关系
  userRoles       UserRole[] // 关联到用户角色表
  rolePermissions RolePermission[] // 关联到角色权限表

  @@index([name])
  @@index([isActive])
  @@map("roles")
}

// 权限表 - 统一的权限资源表
model Permission {
  id          String         @id @default(cuid())
  name        String         @unique // 权限唯一标识
  displayName String // 显示名称
  description String? // 权限描述
  resource    String // 资源标识
  action      String // 操作类型 (read, write, delete, execute等)
  type        PermissionType @default(API) // 权限类型
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // 关联关系
  rolePermissions RolePermission[]

  // 类型化资源关联
  apiPermission  ApiPermission?
  menuPermission MenuPermission?
  dataPermission DataPermission?

  @@index([name])
  @@index([resource])
  @@index([action])
  @@index([type])
  @@index([isActive])
  @@map("permissions")
}

enum PermissionType {
  API // API权限
  MENU // 菜单权限
  DATA // 数据权限
}

enum HttpMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
  OPTIONS
  HEAD
}

// API权限详细信息表
model ApiPermission {
  id           String     @id @default(cuid()) // 唯一标识符
  permissionId String     @unique // 关联到主权限表 (Permission) 的ID
  httpMethod   HttpMethod // HTTP方法 (GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD)
  endpoint     String // API端点路径 (e.g., "/users/:id")
  rateLimit    Int? // API调用速率限制 (每分钟请求数，可选)

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@index([httpMethod])
  @@index([endpoint])
  @@map("api_permissions")
}

// 菜单权限详细信息表
model MenuPermission {
  id           String @id @default(cuid()) // 唯一标识符
  permissionId String @unique // 关联到主权限表 (Permission) 的ID
  menuId       String // 关联到菜单表 (Menu) 的ID

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  menu       Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId]) // 为menuId创建索引以提高查询效率
  @@map("menu_permissions")
}

// 数据权限详细信息表
model DataPermission {
  id           String  @id @default(cuid()) // 唯一标识符
  permissionId String  @unique // 关联到主权限表 (Permission) 的ID
  tableName    String // 目标数据表名
  columnName   String? // 目标列名 (可选，用于列级权限)
  conditions   String? // 数据过滤条件 (JSON格式，e.g., {"departmentId": "${user.departmentId}"})

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@index([tableName])
  @@index([columnName])
  @@map("data_permissions")
}

// 菜单表 - 独立的菜单资源表
model Menu {
  id        String  @id @default(cuid()) // 唯一标识符
  name      String // 菜单名称 (UI显示)
  key       String  @unique // 菜单唯一标识符 (程序中使用)
  path      String? // 前端路由路径
  component String? // 前端组件路径 (可选)
  icon      String? // 菜单图标 (可选)
  order     Int     @default(0) // 菜单排序字段
  isHidden  Boolean @default(false) // 菜单是否在UI中隐藏
  isActive  Boolean @default(true) // 菜单是否激活 (可用)
  parentId  String? // 父菜单ID (用于层级结构)

  // 层级关系
  parent   Menu?  @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction) // 父菜单
  children Menu[] @relation("MenuHierarchy") // 子菜单列表

  // 权限关联
  menuPermissions MenuPermission[] // 关联到菜单权限表

  createdAt DateTime @default(now()) // 创建时间
  updatedAt DateTime @updatedAt // 更新时间

  @@index([key])
  @@index([parentId])
  @@index([order])
  @@index([isActive])
  @@map("menus")
}

// 用户角色关联表
model UserRole {
  userId String // 用户ID
  roleId String // 角色ID
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // ABAC (Attribute-Based Access Control) 扩展属性
  context    String? // 上下文条件 (JSON格式, e.g., {"ip": "192.168.1.100", "timeOfDay": "09:00-17:00"})
  expiresAt  DateTime? // 此角色分配的过期时间
  assignedBy String? // 分配此角色的管理员用户ID
  assignedAt DateTime  @default(now()) // 分配时间

  @@id([userId, roleId]) // 复合主键
  @@index([expiresAt])
  @@map("user_roles")
}

// 角色权限关联表
model RolePermission {
  roleId       String // 角色ID
  permissionId String // 权限ID
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // ABAC (Attribute-Based Access Control) 扩展属性
  conditions String? // 权限生效的特定条件 (JSON格式, e.g., {"resourceOwner": true})
  assignedAt DateTime @default(now()) // 分配时间

  @@id([roleId, permissionId]) // 复合主键
  @@map("role_permissions")
}

// ===== 审计与监控 =====
// 审计日志表
model AuditLog {
  id           String   @id @default(uuid()) // 唯一标识符 (使用UUID以提高分布式环境下的兼容性)
  timestamp    DateTime @default(now()) // 日志记录时间
  userId       String? // 操作用户ID (如果操作由用户发起)
  actorType    String // 操作者类型 (e.g., "USER", "SYSTEM", "CLIENT_APP", "ADMIN")
  actorId      String // 操作者标识 (可以是用户ID, 系统进程ID, 或客户端ID)
  action       String // 执行的操作 (e.g., "USER_LOGIN", "CLIENT_CREATE", "PERMISSION_ASSIGN")
  resourceType String? // 操作影响的资源类型 (e.g., "User", "OAuthClient", "Role")
  resourceId   String? // 操作影响的资源ID
  details      String? // 操作详情 (JSON字符串存储结构化信息，如请求参数、变更内容)
  status       String // 操作状态 (e.g., "SUCCESS", "FAILURE", "PENDING", "DENIED")
  ipAddress    String? // 发起操作的IP地址
  userAgent    String? // 发起操作的用户代理

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull) // 关联用户，用户删除时审计日志中的userId置为NULL

  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([status])
  @@index([userId, timestamp]) // For user-specific audit trails
  @@map("audit_logs")
}

// ================================
// 密码历史 (Password History)
// ================================
// 记录用户密码变更历史，用于防止重复使用旧密码
model PasswordHistory {
  id           String   @id @default(cuid()) // 唯一标识符
  userId       String // 关联的用户ID
  passwordHash String // 已哈希的旧密码
  createdAt    DateTime @default(now()) // 此密码的创建时间 (即被替换的时间)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt]) // 为用户ID和创建时间创建复合索引
  @@map("password_histories")
}

// ================================
// OAuth Scopes (权限范围)
// ================================
// 定义系统中可用的OAuth权限范围
model Scope {
  id          String   @id @default(cuid()) // 唯一标识符
  name        String   @unique // Scope的名称 (e.g., "openid", "profile", "email", "user:read", "order:create")
  description String? // Scope的描述信息
  isPublic    Boolean  @default(false) // 此Scope是否对所有公开客户端可用 (无需特殊分配)
  isActive    Boolean  @default(true) // Scope是否激活可用
  createdAt   DateTime @default(now()) // 创建时间
  updatedAt   DateTime @updatedAt // 更新时间

  // 可选: 如果需要将Scope限制到特定客户端，可以添加关联表 ClientScope
  // clientScopes ClientScope[]

  @@map("scopes")
}

// ================================
// User Consent Grants (用户同意授权记录)
// ================================
// 记录用户对特定客户端授予的权限范围 (scopes)
model ConsentGrant {
  id        String    @id @default(cuid()) // 唯一标识符
  userId    String // 关联的用户ID
  clientId  String // 关联的OAuth客户端ID (这里是OAuthClient表的cuid)
  scopes    String // JSON数组字符串，存储用户同意授予的scope名称列表 (e.g., ["openid", "profile", "order:read"])
  issuedAt  DateTime  @default(now()) // 同意授权的颁发时间
  expiresAt DateTime? // 同意授权的过期时间 (可选，如果同意有有效期)
  revokedAt DateTime? // 同意授权被撤销的时间 (如果用户撤销了同意)

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId]) // 一个用户对一个客户端通常只有一个有效的同意记录 (可根据业务调整)
  @@map("consent_grants")
}

// =======================================
// 内网环境下不需要邮箱和手机验证功能
// 用户由管理员直接创建和管理
// =======================================

// =======================================
// Revoked V2 Auth JWTIs (已撤销的V2认证JTI)
// =======================================
// 用于将V2认证体系中的刷新令牌JTI加入黑名单 (实现刷新令牌的精确撤销)
model RevokedAuthJti {
  jti       String   @id // V2认证刷新令牌的JWT ID (JTI - JWT ID claim)
  userId    String // 此JTI所属的用户ID
  expiresAt DateTime // 此黑名单记录的过期时间 (应与原始刷新令牌的过期时间一致)
  createdAt DateTime @default(now()) // 黑名单记录创建时间

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // 为用户ID创建索引
  @@index([expiresAt]) // For cleaning up expired JTIs
  @@map("revoked_auth_jtis")
}

// 登录尝试记录
model LoginAttempt {
  id            String   @id @default(cuid()) // 唯一标识符
  userId        String? // 关联的用户ID (如果尝试与已知用户账户关联)
  username      String // 尝试登录时使用的用户名
  ipAddress     String? // 尝试登录的IP地址
  userAgent     String? // 尝试登录的用户代理 (浏览器或客户端信息)
  timestamp     DateTime @default(now()) // 登录尝试的时间戳
  successful    Boolean // 本次尝试是否成功
  failureReason String? // 登录失败的原因 (e.g., "WRONG_PASSWORD", "USER_NOT_FOUND", "ACCOUNT_LOCKED", "MFA_REQUIRED", "MFA_FAILED")

  // 关联用户 (可选，如果需要从用户模型导航到其登录尝试记录)
  // user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId]) // 为用户ID创建索引
  @@index([username])
  @@index([ipAddress])
  @@index([timestamp])
  @@map("login_attempts") // 数据库表名
}

// 系统配置
model SystemConfiguration {
  id          String   @id @default(cuid()) // 唯一标识符
  key         String   @unique // 配置项的键 (e.g., "siteName", "defaultLanguage", "maintenanceMode")
  value       String // 配置项的值 (建议存储为JSON字符串以支持复杂数据类型如对象或数组)
  description String? // 配置项的描述
  type        String   @default("string") // 配置值的预期类型 (e.g., "string", "number", "boolean", "json")
  isEditable  Boolean  @default(true) // 此配置项是否允许通过管理API进行编辑
  createdAt   DateTime @default(now()) // 创建时间
  updatedAt   DateTime @updatedAt // 更新时间

  @@map("system_configurations") // 数据库表名
}

// 安全策略
model SecurityPolicy {
  id        String     @id @default(cuid()) // 唯一标识符
  name      String     @unique // 策略名称 (e.g., "DefaultPasswordPolicy", "HighSecurityLoginPolicy")
  type      PolicyType // 策略类型 (关联到PolicyType枚举)
  policy    Json // 具体的策略配置 (JSON对象，其结构取决于策略类型)
  isActive  Boolean    @default(true) // 此策略是否当前激活生效
  createdAt DateTime   @default(now()) // 创建时间
  updatedAt DateTime   @updatedAt // 更新时间

  @@index([name, type]) // 为策略名称和类型创建复合索引
  @@map("security_policies") // 数据库表名
}

// ================================
// JTI Blacklist for Token Revocation (通用令牌黑名单)
// ================================
// 用于存储已撤销的JWT的JTI (JWT ID)，适用于访问令牌和刷新令牌的通用撤销机制
model TokenBlacklist {
  id        String   @id @default(cuid()) // 唯一标识符
  jti       String   @unique // JWT的ID (JTI claim)
  tokenType String // 令牌类型 (e.g., "access_token", "refresh_token", "id_token")
  expiresAt DateTime // 黑名单条目的过期时间 (应与原始令牌的过期时间一致，用于定期清理)
  createdAt DateTime @default(now()) // 黑名单条目创建时间

  @@index([jti]) // 为JTI创建索引以快速查找
  @@index([expiresAt]) // For cleaning up expired blacklist entries
  @@map("token_blacklist")
}

// 策略类型枚举
enum PolicyType {
  PASSWORD_STRENGTH // 密码强度策略
  PASSWORD_HISTORY // 密码历史策略
  PASSWORD_EXPIRATION // 密码过期策略
  LOGIN_SECURITY // 登录安全策略
  ACCESS_CONTROL // 访问控制策略
  CLIENT_SECURITY // OAuth客户端安全策略
  SCOPE_SECURITY // OAuth作用域安全策略
}
