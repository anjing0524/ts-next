// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ================================
// 认证核心模型 (Authentication Core)
// ================================

// 用户表 - 认证系统的核心
model User {
  id           String    @id @default(cuid())
  username     String    @unique
  passwordHash String // BCrypt哈希存储
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  // 用户基本信息
  email        String    @unique // Added: Email address
  firstName    String? // Added: First name
  lastName     String? // Added: Last name
  displayName  String? // 显示名称
  avatar       String? // 头像URL
  phone        String? // 手机号
  organization String? // 用户所属组织
  department   String? // 用户所属部门
  workLocation String? // 用户工作地点
  mustChangePassword Boolean @default(true) // 是否需要在下次登录时强制修改密码
  failedLoginAttempts Int      @default(0)
  lockedUntil         DateTime?

  // 关联关系
  userRoles          UserRole[]
  authorizationCodes AuthorizationCode[]
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]
  auditLogs          AuditLog[]
  passwordHistories  PasswordHistory[]
  consentGrants      ConsentGrant[] // Added relation to ConsentGrant
  passwordResetRequests PasswordResetRequest[] // Relation to password reset requests
  emailVerificationRequests EmailVerificationRequest[] // Relation to email verification requests

  // 用户邮箱验证状态 (User email verification status)
  emailVerified      Boolean   @default(false)
  // 用户手机验证状态 (User phone verification status)
  phoneVerified      Boolean   @default(false)

  phoneVerificationRequests PhoneVerificationRequest[] // Relation to phone verification requests
  revokedAuthJtis    RevokedAuthJti[] // Relation to revoked V2 Auth JTIs

  @@index([username])
  @@index([isActive])
  @@index([organization])
  @@index([department])
  @@map("users")
}

// OAuth客户端表
model OAuthClient {
  id                String     @id @default(cuid())
  clientId          String     @unique
  clientSecret      String? // 机密客户端的密钥 (BCrypt哈希存储)
  redirectUris      String     // JSON字符串存储重定向URI列表
  grantTypes        String     // JSON字符串存储授权类型
  responseTypes     String     // JSON字符串存储响应类型
  allowedScopes     String     // JSON字符串存储权限范围
  clientName        String? // 客户端名称
  clientDescription String? // 客户端描述
  clientType        ClientType @default(PUBLIC) // 客户端类型
  logoUri           String? // Added: URL of the client's logo
  policyUri         String? // Added: URL of the client's policy
  tosUri            String? // Added: URL of the client's terms of service
  jwksUri           String? // Added: URL of the client's JSON Web Key Set
  tokenEndpointAuthMethod String @default("client_secret_basic") // Added: Client authentication method for the token endpoint
  requirePkce       Boolean    @default(true) // Added: Whether PKCE is required for this client
  requireConsent    Boolean    @default(true) // Added: Whether user consent is required for this client
  ipWhitelist       String? // Added: IP whitelist (e.g., JSON string of IPs/ranges)
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // 关联关系
  authorizationCodes AuthorizationCode[]
  accessTokens       AccessToken[]
  refreshTokens      RefreshToken[]
  consentGrants      ConsentGrant[] // Added relation to ConsentGrant
  accessTokenLifetime Int? // 访问令牌生命周期（秒）
  refreshTokenLifetime Int? // 刷新令牌生命周期（秒）
  authorizationCodeLifetime Int? // 授权码生命周期（秒）
  strictRedirectUriMatching Boolean @default(true) // 严格重定向URI匹配
  allowLocalhostRedirect Boolean @default(false) // 允许localhost重定向 (开发时可能有用)
  requireHttpsRedirect Boolean @default(true) // 要求HTTPS重定向

  @@index([clientId])
  @@index([isActive])
  @@index([clientType])
  @@index([clientId, isActive])
  @@map("oauth_clients")
}

enum ClientType {
  PUBLIC // 公开客户端
  CONFIDENTIAL // 机密客户端
}

// 授权码表 (OAuth 2.1 Authorization Code)
model AuthorizationCode {
  id                  String   @id @default(cuid())
  code                String   @unique
  userId              String
  clientId            String
  redirectUri         String
  scope               String   // JSON字符串存储权限范围
  expiresAt           DateTime
  codeChallenge       String? // PKCE code challenge
  codeChallengeMethod String? // PKCE code challenge method
  isUsed              Boolean  @default(false)
  createdAt           DateTime @default(now())

  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@index([isUsed])
  @@map("authorization_codes")
}

// 访问令牌表
model AccessToken {
  id        String   @id @default(cuid())
  token     String   @unique // This field might be removed if only tokenHash is stored
  tokenHash String?  @unique // Hash of the token for secure lookup
  userId    String?  // Optional: if token is not user-specific (e.g. client_credentials)
  clientId  String
  scope     String   // JSON字符串存储权限范围
  expiresAt DateTime
  // isRevoked Boolean  @default(false) // Access tokens are typically not revoked, rely on short expiry. Consider if this field is truly needed.
  // revokedAt DateTime?
  createdAt DateTime @default(now())

  // 关联关系
  user   User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tokenHash]) // Index on tokenHash
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  // @@index([isRevoked])
  @@map("access_tokens")
}

// 刷新令牌表
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique // This field might be removed if only tokenHash is stored
  tokenHash String?  @unique // Hash of the token for secure lookup
  userId    String
  clientId  String
  scope     String   // JSON字符串存储权限范围
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  revokedAt DateTime? // Timestamp of revocation
  createdAt DateTime @default(now())
  previousTokenId String? @unique // Optional: To link rotated refresh tokens for advanced detection
                                 // If used, ensure it has a relation or is just an ID.
  // replacedByTokenId String? @unique // Optional: ID of the token that replaced this one.

  // 关联关系
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  // previousToken RefreshToken? @relation("RefreshTokenRotation", fields: [previousTokenId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  // nextToken     RefreshToken? @relation("RefreshTokenRotation", fields: [replacedByTokenId], references: [id], onDelete: NoAction, onUpdate: NoAction)


  @@index([tokenHash]) // Index on tokenHash
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("refresh_tokens")
}

// ================================
// 权限管理核心 (Permission Management Core)
// ================================

// 角色表
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String // 显示名称
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联关系
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@index([name])
  @@index([isActive])
  @@map("roles")
}

// 权限表 - 统一的权限资源表
model Permission {
  id          String         @id @default(cuid())
  name        String         @unique // 权限唯一标识
  displayName String // 显示名称
  description String? // 权限描述
  resource    String // 资源标识
  action      String // 操作类型 (read, write, delete, execute等)
  type        PermissionType @default(API) // 权限类型
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // 关联关系
  rolePermissions RolePermission[]

  // 类型化资源关联
  apiPermission  ApiPermission?
  menuPermission MenuPermission?
  dataPermission DataPermission?

  @@index([name])
  @@index([resource])
  @@index([action])
  @@index([type])
  @@index([isActive])
  @@map("permissions")
}

enum PermissionType {
  API // API权限
  MENU // 菜单权限
  DATA // 数据权限
}

enum HttpMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
  OPTIONS
  HEAD
}

// API权限详细信息表
model ApiPermission {
  id           String @id @default(cuid())
  permissionId String @unique
  httpMethod   HttpMethod // HTTP方法 (GET, POST, PUT, DELETE等)
  endpoint     String // API端点路径
  rateLimit    Int? // 速率限制 (每分钟请求数)

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@index([httpMethod])
  @@index([endpoint])
  @@map("api_permissions")
}

// 菜单权限详细信息表
model MenuPermission {
  id           String @id @default(cuid())
  permissionId String @unique
  menuId       String

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  menu       Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId])
  @@map("menu_permissions")
}

// 数据权限详细信息表
model DataPermission {
  id           String  @id @default(cuid())
  permissionId String  @unique
  tableName    String // 数据表名
  columnName   String? // 列名 (可选，用于列级权限)
  conditions   String? // 数据过滤条件 (JSON格式)

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@index([tableName])
  @@index([columnName])
  @@map("data_permissions")
}

// 菜单表 - 独立的菜单资源表
model Menu {
  id        String  @id @default(cuid())
  name      String // 菜单名称
  key       String  @unique // 菜单唯一标识
  path      String? // 路由路径
  component String? // 组件路径
  icon      String? // 图标
  order     Int     @default(0) // 排序
  isHidden  Boolean @default(false) // 是否隐藏
  isActive  Boolean @default(true)
  parentId  String? // 父菜单ID

  // 层级关系
  parent   Menu?  @relation("MenuHierarchy", fields: [parentId], references: [id])
  children Menu[] @relation("MenuHierarchy")

  // 权限关联
  menuPermissions MenuPermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([parentId])
  @@index([order])
  @@index([isActive])
  @@map("menus")
}

// 用户角色关联表
model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // ABAC 扩展属性
  context    String?     // 上下文条件，如时间、地点等
  expiresAt  DateTime? // 角色分配过期时间
  assignedBy String? // 分配者ID
  assignedAt DateTime  @default(now())

  @@id([userId, roleId])
  @@index([expiresAt])
  @@map("user_roles")
}

// 角色权限关联表
model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // ABAC 扩展属性
  conditions String?    // 权限生效条件
  assignedAt DateTime @default(now())

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ===== 审计与监控 =====
// 审计日志表
model AuditLog {
  id           String   @id @default(uuid()) // Using uuid() for AuditLog for broader compatibility
  timestamp    DateTime @default(now())
  userId       String? // 操作用户ID
  actorType    String // 操作者类型 (e.g., USER, SYSTEM, CLIENT_APP)
  actorId      String // 操作者ID (userId, system_process_id, clientId)
  action       String // 执行的操作 (e.g., LOGIN, USER_CREATE, ARTICLE_DELETE)
  resourceType String? // 操作的资源类型 (e.g., User, Article, Order)
  resourceId   String? // 操作的资源ID
  details      String? // 操作详情 (JSON string for structured details)
  status       String // 操作状态 (e.g., SUCCESS, FAILURE, PENDING)
  ipAddress    String? // IP地址
  userAgent    String? // 用户代理
  sessionId    String? // 会话ID (If applicable)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull) // SetNull to keep audit logs if user is deleted

  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([status])
  @@index([userId, timestamp]) // For user-specific audit trails
  @@map("audit_logs")
}

// ================================
// 密码历史 (Password History)
// ================================
model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("password_histories")
}

// ================================
// OAuth Scopes
// ================================
model Scope {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "openid", "profile", "order:read"
  description String?
  isPublic    Boolean @default(false) // Can public clients request this scope?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Optional: Relation to clients if scopes are restricted per client (advanced)
  // clientScopes ClientScope[]

  @@map("scopes")
}

// ================================
// User Consent Grants
// ================================
model ConsentGrant {
  id        String   @id @default(cuid())
  userId    String
  clientId  String   // This should be the Prisma CUID of the OAuthClient
  scopes    String   // JSON array of granted scope strings e.g., ["openid", "profile", "order:read"]
  issuedAt  DateTime @default(now())
  expiresAt DateTime? // Optional: if consents can expire
  revokedAt DateTime? // If consent is explicitly revoked

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade) // clientId here refers to OAuthClient.id (CUID)

  @@unique([userId, clientId]) // A user typically has one active consent grant per client
  @@map("consent_grants")
}

// =======================================
// Password Reset Request (密码重置请求)
// =======================================
model PasswordResetRequest {
  id        String   @id @default(cuid())
  userId    String   // 关联的用户ID (Associated User ID)
  token     String   @unique // 重置令牌，实际发送给用户的值 (Reset token, the actual value sent to the user)
  expiresAt DateTime // 令牌过期时间 (Token expiration time)
  createdAt DateTime @default(now()) // 创建时间 (Creation time)
  isUsed    Boolean  @default(false) // 令牌是否已被使用 (Whether the token has been used)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) // 关联到用户 (Relation to User)

  @@index([userId]) // 为用户ID创建索引 (Index for userId)
  // token is already unique, which creates an index.
  @@map("password_reset_requests") // 数据库表名 (Database table name)
}

// =======================================
// Email Verification Request (邮箱验证请求)
// =======================================
model EmailVerificationRequest {
  id        String   @id @default(cuid())
  userId    String   // 关联的用户ID (Associated User ID)
  email     String   // 待验证的邮箱地址 (Email address to be verified)
  token     String   @unique // 验证令牌 (Verification token)
  expiresAt DateTime // 令牌过期时间 (Token expiration time)
  createdAt DateTime @default(now()) // 创建时间 (Creation time)
  isUsed    Boolean  @default(false) // 令牌是否已被使用 (Whether the token has been used)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) // 关联到用户 (Relation to User)

  @@index([userId])
  @@index([email])
  // token is already unique, which creates an index.
  @@map("email_verification_requests") // 数据库表名 (Database table name)
}

// =======================================
// Phone Verification Request (手机验证请求)
// =======================================
model PhoneVerificationRequest {
  id        String   @id @default(cuid())
  userId    String   // 关联的用户ID (Associated User ID)
  phone     String   // 待验证的手机号 (Phone number to be verified)
  token     String   // 验证令牌/OTP (Verification token/OTP) - 注意：对于OTP，此字段可能不需要@unique，取决于查找策略
                     // (Note: For OTP, this field might not need @unique, depending on lookup strategy)
  expiresAt DateTime // 令牌过期时间 (Token expiration time)
  createdAt DateTime @default(now()) // 创建时间 (Creation time)
  isUsed    Boolean  @default(false) // 令牌是否已被使用 (Whether the token has been used)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) // 关联到用户 (Relation to User)

  @@index([userId])
  @@index([phone])
  @@index([userId, phone, token]) // 复合索引用于查找特定用户、手机和OTP的组合 (Compound index for user, phone, token lookup)
  @@index([token]) // 如果OTP需要通过token直接查找（例如，如果token是长随机字符串）
                   // (Index token if OTPs are directly looked up by token, e.g. if token is a long random string)
  @@map("phone_verification_requests") // 数据库表名 (Database table name)
}

// =======================================
// Revoked V2 Auth JWTIs (已撤销的V2认证JTI)
// =======================================
// Used to blacklist JTIs of V2 Auth Refresh Tokens
model RevokedAuthJti {
  jti       String   @id // JTI of the V2 Auth Refresh Token (JWT ID)
  userId    String   // User ID to whom this JTI belonged
  expiresAt DateTime // Expiry of this blacklist record (should match original refresh token's expiry)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt]) // For cleaning up expired JTIs
  @@map("revoked_auth_jtis")
}

// 登录尝试记录
model LoginAttempt {
  id          String   @id @default(cuid()) // 主键
  userId      String?  // 用户ID (如果尝试与已知用户关联)
  username    String   // 尝试登录的用户名
  ipAddress   String?  // IP地址
  userAgent   String?  // 用户代理
  timestamp   DateTime @default(now()) // 尝试时间
  successful  Boolean  // 是否成功
  failureReason String? // 失败原因 (e.g., WRONG_PASSWORD, USER_NOT_FOUND, ACCOUNT_LOCKED)

  // 关联用户 (可选，如果需要从用户导航到登录尝试)
  // user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([username])
  @@index([ipAddress])
  @@index([timestamp])
  @@map("login_attempts") // 数据库表名
}

// 系统配置
model SystemConfiguration {
  id          String   @id @default(cuid()) // 主键
  key         String   @unique // 配置键
  value       String   // 配置值 (建议存储为JSON字符串以支持复杂类型)
  description String?  // 配置描述
  type        String   @default("string") // 值类型: string, number, boolean, json
  isEditable  Boolean  @default(true)  // 是否可通过API编辑
  createdAt   DateTime @default(now()) // 创建时间
  updatedAt   DateTime @updatedAt // 更新时间

  @@map("system_configurations") // 数据库表名
}

// 安全策略
model SecurityPolicy {
  id        String   @id @default(cuid()) // 主键
  name      String   @unique //策略名称, 例如 "PasswordStrength", "LoginSecurity"
  type      PolicyType      // 策略类型
  policy    Json     // JSON对象，包含具体策略配置
  isActive  Boolean  @default(true) // 是否激活
  createdAt DateTime @default(now()) // 创建时间
  updatedAt DateTime @updatedAt // 更新时间

  @@index([name, type])
  @@map("security_policies") // 数据库表名
}

// 策略类型枚举
enum PolicyType {
  PASSWORD_STRENGTH    // 密码强度策略
  PASSWORD_HISTORY     // 密码历史策略
  PASSWORD_EXPIRATION  // 密码过期策略
  LOGIN_SECURITY       // 登录安全策略
  ACCESS_CONTROL       // 访问控制策略
  CLIENT_SECURITY      // OAuth客户端安全策略
  SCOPE_SECURITY       // OAuth作用域安全策略
}
