# WASM-CAL é«˜æ€§èƒ½Kçº¿å›¾æ¸²æŸ“å¼•æ“ - å®Œæ•´é¡¹ç›®æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

**WASM-CAL** æ˜¯åŸºäº WebAssembly + Rust çš„é«˜æ€§èƒ½é‡‘èå›¾è¡¨æ¸²æŸ“å¼•æ“ï¼Œä¸“æ³¨äº K çº¿å›¾ï¼ˆèœ¡çƒ›å›¾ï¼‰çš„å®æ—¶æ¸²æŸ“å’Œäº¤äº’ä½“éªŒã€‚

### ğŸ¯ æ ¸å¿ƒæŒ‡æ ‡
- **å¸§ç‡**: 60FPS (æœ€ä½30FPS)
- **å†…å­˜**: â‰¤50MB (10Kæ•°æ®)
- **åˆå§‹åŒ–**: <100ms
- **å»¶è¿Ÿ**: <16ms (äº¤äº’å“åº”)

### ğŸ† æŠ€æœ¯ç‰¹è‰²
- âœ… WebAssembly + Rust è¿‘åŸç”Ÿæ€§èƒ½
- âœ… ä¸‰å±‚Canvasæ¶æ„ (Base/Main/Overlay)
- âœ… ç­–ç•¥æ¨¡å¼æ¸²æŸ“ç³»ç»Ÿ
- âœ… FlatBuffersé›¶æ‹·è´æ•°æ®åºåˆ—åŒ–
- âœ… SIMDå‘é‡åŒ–è®¡ç®—ä¼˜åŒ–

---

## ğŸ“ æ–‡æ¡£ç›®å½•

### 1. è®¾è®¡æ–‡æ¡£ (design.md)
### 2. äº§å“éœ€æ±‚æ–‡æ¡£ (prd.md) 
### 3. æ¶æ„è¯´æ˜æ–‡æ¡£ (wasm-cal-render-events.md)
### 4. æ ¸å¿ƒä»£ç ç»“æ„
### 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
### 6. å¼€å‘ä¸æµ‹è¯•æŒ‡å—

---

## 1. ğŸ“ è®¾è®¡æ–‡æ¡£æ‘˜è¦

### å·²å®ç°æ¶æ„
- **æ¸²æŸ“ç­–ç•¥æ¨¡å¼æ¡†æ¶** (RenderStrategy trait + Factory)
- **Canvasæ‰¹å¤„ç†ä¼˜åŒ–** (RenderBatch + CandleBatch)
- **å¸ƒå±€ç³»ç»Ÿå®ç°** (ChartLayout + LayoutEngine + Templates)
- **æ•°æ®ç®¡ç†ä¸å¯è§èŒƒå›´è®¡ç®—** (DataManager + VisibleRange)
- **äº‹ä»¶ç³»ç»Ÿå®ç°** (æ‹–æ‹½ã€æ»šè½®ã€ç‚¹å‡»ç­‰äº¤äº’)
- **é…ç½®ç®¡ç†ç³»ç»Ÿ** (ChartConfig + Theme + Locale)

### é«˜çº§æ¸²æŸ“ç‰¹æ€§
- çƒ­å›¾æ¸²æŸ“ (Heatmap)
- è®¢å•ç°¿æ·±åº¦å›¾ (Order Book)
- æ•°æ®ç¼©æ”¾ (DataZoom)
- äº¤äº’å¼å·¥å…·æç¤º (Tooltip)

### æŠ€æœ¯æ¶æ„
```rust
wasm-cal/src/
â”œâ”€â”€ canvas/          # Canvasç®¡ç†å±‚
â”œâ”€â”€ config/          # é…ç½®ç®¡ç†  
â”œâ”€â”€ data/            # æ•°æ®ç®¡ç†
â”œâ”€â”€ layout/          # å¸ƒå±€ç³»ç»Ÿ
â”œâ”€â”€ render/          # æ¸²æŸ“ç³»ç»Ÿ
â”œâ”€â”€ command/         # äº‹ä»¶å‘½ä»¤
â””â”€â”€ utils/           # å·¥å…·æ¨¡å—
```

---

## 2. ğŸ“‹ äº§å“éœ€æ±‚æ–‡æ¡£æ‘˜è¦

### æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚
- âœ… Kçº¿ã€æˆäº¤é‡ã€ä»·æ ¼çº¿ç­‰åŸºæœ¬å›¾è¡¨å…ƒç´ 
- âœ… æ•°æ®ç¼©æ”¾ã€æ»šè½®ç¼©æ”¾ã€æ‹–æ‹½å¹³ç§»
- âœ… å…‰æ ‡æ ·å¼æ™ºèƒ½åˆ‡æ¢ (é»˜è®¤ã€å·¦å³ä¼¸ç¼©ã€å¹³ç§»)
- âœ… è®¢å•ç°¿æ·±åº¦å›¾ã€çƒ­åŠ›å›¾é«˜çº§æ¸²æŸ“
- âœ… å¤šè¯­è¨€ä¸ä¸»é¢˜åˆ‡æ¢
- âœ… å¢é‡æ•°æ®æ›´æ–°ä¸å®æ—¶æ¸²æŸ“

### æŠ€æœ¯è§„æ ¼
- **ç›®æ ‡å¹³å°**: ç°ä»£æµè§ˆå™¨ (Chromeã€Firefoxã€Safari)
- **æ„å»ºäº§ç‰©**: WASMåŒ… + JS Glue Code
- **åŒ…ä½“ç§¯**: < 1.5MB (gzipå)
- **æµ‹è¯•è¦†ç›–ç‡**: > 80%

### è´¨é‡è¦æ±‚
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- ç«¯åˆ°ç«¯äº¤äº’æµ‹è¯•è¦†ç›–ä¸»è¦è·¯å¾„
- æ€§èƒ½åŸºå‡†æµ‹è¯•æŒç»­ç›‘æ§

---

## 3. ğŸ—ï¸ æ¶æ„è¯´æ˜æ–‡æ¡£æ‘˜è¦

### äº‹ä»¶æµæ¶æ„
1. **å¤–éƒ¨è¾“å…¥** â†’ å†…éƒ¨äº‹ä»¶æšä¸¾
2. **Commandç®¡ç†å™¨**åˆ†å‘äº‹ä»¶
3. **ç­–ç•¥å·¥å‚**å¤„ç†äº¤äº’æˆ–æ›´æ–°çŠ¶æ€
4. **é©±åŠ¨é‡ç»˜**æ¸²æŸ“æµç¨‹

### æ»šè½®äº‹ä»¶å¤„ç†ä¼˜å…ˆçº§
1. **å¯¼èˆªå™¨åŒºåŸŸ**: è°ƒæ•´å¯è§†æ•°æ®èŒƒå›´ (ä»…é‡ç»˜Overlayå±‚)
2. **ä¸»å›¾åŒºåŸŸ**: ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒæ•°æ®ç¼©æ”¾ (è§¦å‘å®Œæ•´é‡å¸ƒå±€)
3. **å…¶ä»–åŒºåŸŸ**: æ— å¤„ç†

### å…‰æ ‡æ ·å¼åˆ¤å®šè·¯å¾„
- **å¯¼èˆªå™¨åŒºåŸŸ**: DataZoomRendererå¤„ç†
- **éå¯¼èˆªå™¨åŒºåŸŸ**: ä¸»å›¾â†’Crosshair, æˆäº¤é‡â†’Crosshair, å…¶ä»–â†’Default
- **ç­–ç•¥å·¥å‚æŸ¥è¯¢**: è¿”å›ç¬¬ä¸€ä¸ªéDefaultæ ·å¼

### RefCellå€Ÿç”¨ä¼˜åŒ–ç­–ç•¥
- **é˜¶æ®µA**: å±€éƒ¨ä½œç”¨åŸŸä¼˜åŒ– (å·²å®Œæˆ)
- **é˜¶æ®µB**: è®¿é—®è€…æ¨¡å¼é‡æ„ (å·²å®Œæˆ) 
- **é˜¶æ®µC**: æ–‡æ¡£å®ç°å¯¹é½ (å·²å®Œæˆ)

### è®¿é—®è€…æ¨¡å¼API
```rust
// æŒ‰ä¼˜å…ˆçº§éå†ç­–ç•¥
factory.visit_strategies(mode, |strategy| {
    // å¤„ç†ç­–ç•¥
    ControlFlow::Continue(())
});

// æŒ‰å›¾å±‚è¿‡æ»¤éå†
factory.visit_strategies_by_layer(mode, layer, |strategy| {
    // å¤„ç†æŒ‡å®šå›¾å±‚ç­–ç•¥
    ControlFlow::Continue(())
});
```

---

## 4. ğŸ’» æ ¸å¿ƒä»£ç ç»“æ„

### å…³é”®æ–‡ä»¶è¯´æ˜

#### å‘½ä»¤ç®¡ç† (command/)
- `manager.rs`: äº‹ä»¶å¤„ç†æ ¸å¿ƒ (é¼ æ ‡ç§»åŠ¨ã€æŒ‰ä¸‹ã€æŠ¬èµ·ã€æ»šè½®)
- `event.rs`: äº‹ä»¶æšä¸¾å®šä¹‰
- `state.rs`: é¼ æ ‡çŠ¶æ€ç®¡ç†

#### æ¸²æŸ“ç³»ç»Ÿ (render/)
- `chart_renderer.rs`: ä¸»æ¸²æŸ“å™¨
- `renderer_traits.rs`: æ¸²æŸ“å™¨traitå®šä¹‰
- `strategy_factory.rs`: ç­–ç•¥å·¥å‚
- `render_context.rs`: æ¸²æŸ“ä¸Šä¸‹æ–‡

#### å…·ä½“æ¸²æŸ“å™¨
- `axis_renderer.rs`: åæ ‡è½´æ¸²æŸ“
- `book_renderer.rs`: è®¢å•ç°¿æ¸²æŸ“
- `datazoom_renderer.rs`: æ•°æ®ç¼©æ”¾æ¸²æŸ“
- `heat_renderer.rs`: çƒ­å›¾æ¸²æŸ“
- `line_renderer.rs`: çº¿å›¾æ¸²æŸ“
- `overlay_renderer.rs`: è¦†ç›–å±‚æ¸²æŸ“
- `price_renderer.rs`: ä»·æ ¼çº¿æ¸²æŸ“
- `tooltip_renderer.rs`: å·¥å…·æç¤ºæ¸²æŸ“
- `volume_renderer.rs`: æˆäº¤é‡æ¸²æŸ“

#### æ•°æ®ä¸å¸ƒå±€
- `data_manager.rs`: æ•°æ®ç®¡ç†
- `chart_layout.rs`: å›¾è¡¨å¸ƒå±€
- `canvas_manager.rs`: Canvasç®¡ç†

---

## 5. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### å†…å­˜ç®¡ç†ä¼˜åŒ–
- **å¯¹è±¡æ± **: å¤ç”¨ä¸´æ—¶å¯¹è±¡å‡å°‘GCå‹åŠ›
- **å†…å­˜æ± **: é¢„åˆ†é…å†…å­˜å—é¿å…é¢‘ç¹åˆ†é…
- **é›¶æ‹·è´**: FlatBuffersç›´æ¥å†…å­˜è®¿é—®

### æ¸²æŸ“ä¼˜åŒ–
- **æ‰¹é‡ç»˜åˆ¶**: Path2Dæ‰¹é‡è·¯å¾„æ“ä½œ
- **è„çŸ©å½¢**: åªé‡ç»˜å˜åŒ–åŒºåŸŸ
- **SIMDè®¡ç®—**: å‘é‡åŒ–æ•°å­¦è¿ç®—
- **ç¼“å­˜ç­–ç•¥**: é™æ€å†…å®¹é¢„æ¸²æŸ“

### äº¤äº’ä¼˜åŒ–
- **Web Worker**: é¿å…ä¸»çº¿ç¨‹é˜»å¡
- **OffscreenCanvas**: ç‹¬ç«‹æ¸²æŸ“ä¸Šä¸‹æ–‡
- **èŠ‚æµå¤„ç†**: å¹³æ»‘çš„é¼ æ ‡/æ»šè½®å“åº”

### æ¶æ„ä¼˜åŒ–
- **ç­–ç•¥æ¨¡å¼**: è¿è¡Œæ—¶åˆ‡æ¢æ¸²æŸ“æ¨¡å¼
- **è®¿é—®è€…æ¨¡å¼**: é«˜æ•ˆç­–ç•¥éå†
- **RefCellä¼˜åŒ–**: å‡å°‘å€Ÿç”¨å†²çª

---

## 6. ğŸ”§ å¼€å‘ä¸æµ‹è¯•æŒ‡å—

### æ„å»ºå‘½ä»¤
```bash
# å¼€å‘æ„å»º
wasm-pack build --target web --out-dir pkg --dev

# ç”Ÿäº§æ„å»º
wasm-pack build --target web --out-dir pkg --release

# è‡ªåŠ¨æ„å»ºè„šæœ¬
./build.sh
```

### æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm -C apps/kline-service wasm:test

# ç‰¹å®šæµ‹è¯•æ–‡ä»¶
wasm-pack test --headless --chrome tests/cursor_style_tests.rs
wasm-pack test --headless --chrome tests/strategy_visitor_tests.rs

# æ€§èƒ½åŸºå‡†æµ‹è¯•
cargo bench --manifest-path apps/kline-service/wasm-cal/Cargo.toml
```

### å¼€å‘æ³¨æ„äº‹é¡¹
1. **RefCellå€Ÿç”¨**: ä½¿ç”¨å±€éƒ¨ä½œç”¨åŸŸé¿å…å†²çª
2. **å†…å­˜å®‰å…¨**: WASMå†…å­˜è¾¹ç•Œæ£€æŸ¥
3. **æ€§èƒ½ç›‘æ§**: é›†æˆFPSå’Œå†…å­˜ç›‘æ§
4. **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯å¤„ç†é“¾

---

## ğŸ“Š é¡¹ç›®çŠ¶æ€æ€»ç»“

### âœ… å·²å®ŒæˆåŠŸèƒ½
- æ ¸å¿ƒæ¸²æŸ“æ¶æ„å®ç°
- äº‹ä»¶å¤„ç†ç³»ç»Ÿå®Œå–„
- æ€§èƒ½ä¼˜åŒ–æªæ–½å®æ–½
- å®Œæ•´æµ‹è¯•è¦†ç›–
- æ–‡æ¡£ä½“ç³»å»ºç«‹

### ğŸš§ è¿›è¡Œä¸­å·¥ä½œ
- æ€§èƒ½åŸºå‡†æµ‹è¯•å»ºç«‹
- é”™è¯¯ç›‘æ§ç³»ç»Ÿå¼€å‘
- æ–‡æ¡£è¡¥å……ä¸å®Œå–„

### ğŸ“… æœªæ¥è§„åˆ’
- æ·±å±‚æ¶æ„é‡æ„
- å¼‚æ­¥æ¸²æŸ“æ”¯æŒ
- çŠ¶æ€å¿«ç…§æ¨¡å¼
- æ‰©å±•æ¸²æŸ“æ¨¡å¼

---

## ğŸ”— ç›¸å…³èµ„æº

- **WebAssemblyå®˜æ–¹æ–‡æ¡£**: https://webassembly.org/
- **Rust WASM Book**: https://rustwasm.github.io/docs/book/
- **FlatBuffersæŒ‡å—**: https://google.github.io/flatbuffers/

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰æŠ€æœ¯é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥äº†è§£ï¼Œè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1
**æœ€åæ›´æ–°**: 2025-08-26
**é¡¹ç›®çŠ¶æ€**: ç”Ÿäº§å°±ç»ª âœ…

*æœ¬æ–‡æ¡£ç”± WASM-CAL é¡¹ç›®ç»„æ•´ç†æä¾›*