---
description: 
globs: 
alwaysApply: true
---
# TypeScript Next.js 微服务项目开发规范

## 项目概述
本项目是基于 Next.js 15 的微服务架构，主要实现完善的 OAuth2 认证和 RBAC 权限管理系统。

## 技术栈
- **前端框架**: Next.js 15 with App Router
- **UI组件**: shadcn/ui + TailwindCSS
- **数据库**: Prisma + SQLite
- **测试框架**: Jest
- **认证系统**: OAuth2 + RBAC
- **WebAssembly**: Rust + wasm-pack (用于K线图计算)
- **包管理**: pnpm

## 服务架构
项目采用多服务架构：
- `oauth-service`: OAuth2认证服务
- `admin-portal`: 管理后台
- `flow-service`: 流程管理服务  
- `kline-service`: K线图服务
- `test-service`: 测试服务

## 开发工作流程

### 1. 文档驱动开发
- 所有功能开发前必须先完善 [docs/](mdc:docs) 目录下的相关文档
- 文档需要包含API设计、数据结构、业务逻辑等详细说明
- 确保文档符合需求后再进行代码实现

### 2. 测试驱动开发 (TDD)
- 每个API都必须有对应的单元测试
- 测试文件统一放在 [__tests__/](mdc:__tests__) 目录
- 使用 `pnpm test:coverage` 检查测试覆盖率
- 测试必须连接真实的Prisma数据库，不使用Mock

### 3. 编码标准
- 使用TypeScript，所有函数必须添加函数级注释
- 遵循软件设计最佳实践
- 重复的验证逻辑移到中间件处理
- 测试辅助函数统一放在 [__tests__/setup/test-helpers.ts](mdc:__tests__/setup/test-helpers.ts)

## 核心目录结构

### API路由
- 主API: `app/api/v2/`
- 各服务API: `apps/{service-name}/app/api/v2/`
- OAuth相关: `apps/oauth-service/app/api/v2/oauth/`

### 认证相关文件
- 中间件: [lib/auth/middleware/](mdc:lib/auth/middleware)
- OAuth2工具: [packages/lib/src/auth/](mdc:packages/lib/src/auth)
- 权限服务: [packages/lib/src/services/rbacService.ts](mdc:packages/lib/src/services/rbacService.ts)

### 数据库
- Schema: [packages/database/prisma/schema.prisma](mdc:packages/database/prisma/schema.prisma)
- 客户端: [packages/database/client.ts](mdc:packages/database/client.ts)

### 共享组件
- UI组件: [packages/ui/src/components/](mdc:packages/ui/src/components)
- 公共组件: [components/](mdc:components)

## 开发要求

### 代码质量
- 所有函数必须有中文注释
- 错误处理要完善，使用统一的错误处理机制
- 遵循TypeScript最佳实践
- 使用ESLint配置进行代码检查

### 测试要求
- API测试: `__tests__/api/`
- 集成测试: `__tests__/integration/`
- 单元测试: `__tests__/lib/`
- 性能测试: `__tests__/performance/`
- 所有测试必须通过并生成测试报告

### 文档要求
- 代码修改时必须同步更新相关文档
- 使用当前最新日期更新文档
- 文档应清晰描述功能、API接口、数据结构等

## 工作流程检查清单

### 开发新功能时：
1. [ ] 先在 `docs/` 中完善相关文档
2. [ ] 编写测试用例 (TDD)
3. [ ] 实现代码功能
4. [ ] 运行测试确保通过
5. [ ] 检查代码质量和注释
6. [ ] 更新相关文档

### 修改现有功能时：
1. [ ] 分析现有代码和测试
2. [ ] 更新相关文档
3. [ ] 修改测试用例
4. [ ] 修改代码实现
5. [ ] 确保所有测试通过
6. [ ] 验证不影响其他功能

## 特殊说明

### WebAssembly开发
- Rust代码位于 `apps/kline-service/src/wasm-cal/`
- 使用 `wasm-pack` 编译为WebAssembly
- 生成的类型文件位于 `src/generated/`

### 权限系统
- 实现基于RBAC模型的权限管理
- 权限检查在中间件中统一处理
- 用户角色和权限通过数据库管理

### OAuth2认证
- 支持完整的OAuth2认证流程
- 实现PKCE (Proof Key for Code Exchange)
- 支持多种授权类型 (authorization_code, client_credentials等)

## 注意事项
- 使用中文进行开发交流
- 复杂任务需要拆分执行
- 停止前必须确认任务完成
- 疑问时搜索最佳实践方案
- 始终学习最新文档和最佳实践
