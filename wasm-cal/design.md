# WASM-CAL é‡‘èæ•°æ®å¯è§†åŒ–ç³»ç»Ÿ - æ¶æ„è®¾è®¡æ–‡æ¡£

> ä¸€ä¸ªåŸºäº WebAssembly + Rust æ„å»ºçš„é«˜æ€§èƒ½é‡‘è K çº¿æ•°æ®å¯è§†åŒ–å¼•æ“  
> é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼Œæ”¯æŒå¤šå±‚æ¸²æŸ“ã€å®æ—¶äº¤äº’å’Œä¸“ä¸šçº§ BookMap åŠŸèƒ½

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

- **æ€§èƒ½ä¼˜å…ˆ**: åŸºäº WebAssembly çš„åŸç”Ÿæ€§èƒ½ï¼Œé…åˆ Rust çš„é›¶æˆæœ¬æŠ½è±¡
- **æ¨¡å—åŒ–æ¶æ„**: æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œï¼Œæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **åˆ†å±‚æ¸²æŸ“**: ä¸‰å±‚ Canvas æ¶æ„ï¼Œæ”¯æŒç‹¬ç«‹æ¸²æŸ“å’Œæ€§èƒ½ä¼˜åŒ–
- **æ•°æ®é©±åŠ¨**: FlatBuffers é«˜æ•ˆåºåˆ—åŒ–ï¼Œæ”¯æŒå¤§æ•°æ®é‡å®æ—¶å¤„ç†
- **å“åº”å¼è®¾è®¡**: é€‚é…å¤šç§è®¾å¤‡å°ºå¯¸ï¼Œæä¾›æœ€ä½³ç”¨æˆ·ä½“éªŒ

### æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯å±‚                           â”‚
â”‚  JavaScript/TypeScript + Canvas + Web APIs     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Web APIs (Canvas, DOM Events)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               WASM å±‚                           â”‚
â”‚     Rust + wasm-bindgen + web-sys              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ FlatBuffers Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®å±‚                            â”‚
â”‚      FlatBuffers + Binary Data Stream          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ¨¡å—æ¶æ„

### 1. å…¥å£æ¨¡å— (`lib.rs`)

**èŒè´£**: ç»Ÿä¸€å¯¼å‡ºå’Œ WASM åˆå§‹åŒ–

```rust
pub use kline_process::KlineProcess;    // ä¸»è¦ä¸šåŠ¡é€»è¾‘
pub use layout::ChartLayout;            // å¸ƒå±€ç®¡ç†
pub use render::ChartRenderer;          // æ¸²æŸ“ç®¡ç†
```

**ç‰¹æ€§**:
- è®¾ç½® panic hook ç”¨äºè°ƒè¯•
- ç»Ÿä¸€å¯¹å¤– API æ¥å£
- æ¨¡å—é—´ä¾èµ–ç®¡ç†

### 2. ä¸šåŠ¡æ ¸å¿ƒæ¨¡å— (`kline_process.rs`)

**èŒè´£**: ä¸»è¦ä¸šåŠ¡æµç¨‹æ§åˆ¶å’Œå¯¹å¤–æ¥å£

```rust
#[wasm_bindgen]
pub struct KlineProcess {
    data: Vec<u8>,                          // åŸå§‹æ•°æ®
    parsed_data: Option<KlineData<'static>>, // è§£æåæ•°æ®
    chart_renderer: Option<ChartRenderer>,   // æ¸²æŸ“å™¨å®ä¾‹
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- ğŸ“Š **æ•°æ®ç®¡ç†**: WASM å†…å­˜è¯»å–ã€FlatBuffers è§£æã€æ•°æ®éªŒè¯
- ğŸ¨ **æ¸²æŸ“æ§åˆ¶**: ä¸‰å±‚ Canvas ç®¡ç†ã€ç»Ÿä¸€ç»˜åˆ¶æ¥å£
- ğŸ–±ï¸ **äº¤äº’å¤„ç†**: é¼ æ ‡äº‹ä»¶ã€æ»šè½®ç¼©æ”¾ã€ç‚¹å‡»åˆ‡æ¢
- âš¡ **æ€§èƒ½ç›‘æ§**: æ¸²æŸ“æ—¶é—´ç»Ÿè®¡ã€é”™è¯¯å¤„ç†

---

## ğŸ—‚ï¸ æ¨¡å—è¯¦ç»†è®¾è®¡

### æ•°æ®æ¨¡å— (`data/`)

```
data/
â”œâ”€â”€ mod.rs              // æ¨¡å—å¯¼å‡º
â”œâ”€â”€ data_manager.rs     // æ•°æ®ç®¡ç†å™¨
â”œâ”€â”€ visible_range.rs    // å¯è§èŒƒå›´ç®¡ç†
â””â”€â”€ README.md          // æ¨¡å—è¯´æ˜
```

#### DataManager - æ•°æ®ç®¡ç†å™¨

**èŒè´£**: K çº¿æ•°æ®å­˜å‚¨ã€ç´¢å¼•å’Œè®¿é—®

```rust
pub struct DataManager {
    kline_data: Option<KlineData<'static>>,
    visible_range: VisibleRange,
    cached_stats: Option<DataStats>,
}
```

**æ ¸å¿ƒç‰¹æ€§**:
- ğŸ” **æ•°æ®ç´¢å¼•**: é«˜æ•ˆçš„æ—¶é—´åºåˆ—æ•°æ®æŸ¥æ‰¾
- ğŸ“ˆ **ç»Ÿè®¡ç¼“å­˜**: å¯è§åŒºåŸŸæ•°æ®ç»Ÿè®¡ï¼ˆæœ€é«˜ä»·ã€æœ€ä½ä»·ã€æˆäº¤é‡ç­‰ï¼‰
- ğŸ¯ **èŒƒå›´ç®¡ç†**: å¯è§æ•°æ®èŒƒå›´è®¡ç®—å’Œè¾¹ç•Œæ£€æŸ¥
- ğŸ”„ **å¢é‡æ›´æ–°**: æ”¯æŒå®æ—¶æ•°æ®æµæ›´æ–°

#### VisibleRange - å¯è§èŒƒå›´ç®¡ç†

**èŒè´£**: ç®¡ç†å›¾è¡¨å¯è§åŒºåŸŸçš„æ•°æ®èŒƒå›´

```rust
pub struct VisibleRange {
    start_index: usize,    // èµ·å§‹ç´¢å¼•
    count: usize,          // æ˜¾ç¤ºæ•°é‡
    total_count: usize,    // æ€»æ•°æ®é‡
}
```

**ç®—æ³•ç‰¹æ€§**:
- ğŸ“ **è¾¹ç•Œæ£€æŸ¥**: é˜²æ­¢è¶Šç•Œè®¿é—®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
- ğŸ” **èŒƒå›´è®¡ç®—**: é«˜æ•ˆè®¡ç®—å¯è§åŒºåŸŸæ•°æ®è¾¹ç•Œ
- ğŸ“Š **ç¼©æ”¾æ”¯æŒ**: é¼ æ ‡æ»šè½®ç¼©æ”¾æ—¶çš„èŒƒå›´è°ƒæ•´
- âš¡ **æ€§èƒ½ä¼˜åŒ–**: é¿å…é‡å¤è®¡ç®—ï¼Œç¼“å­˜è®¡ç®—ç»“æœ

### æ¸²æŸ“æ¨¡å— (`render/`)

```
render/
â”œâ”€â”€ mod.rs                  // æ¨¡å—å¯¼å‡º
â”œâ”€â”€ chart_renderer.rs       // ä¸»æ¸²æŸ“å™¨
â”œâ”€â”€ axis_renderer.rs        // åæ ‡è½´æ¸²æŸ“å™¨
â”œâ”€â”€ price_renderer.rs       // Kçº¿æ¸²æŸ“å™¨
â”œâ”€â”€ volume_renderer.rs      // æˆäº¤é‡æ¸²æŸ“å™¨
â”œâ”€â”€ heat_renderer.rs        // çƒ­å›¾æ¸²æŸ“å™¨
â”œâ”€â”€ line_renderer.rs        // ä»·æ ¼çº¿æ¸²æŸ“å™¨
â”œâ”€â”€ book_renderer.rs        // è®¢å•ç°¿æ¸²æŸ“å™¨
â”œâ”€â”€ overlay_renderer.rs     // è¦†ç›–å±‚æ¸²æŸ“å™¨
â”œâ”€â”€ datazoom_renderer.rs    // æ•°æ®ç¼©æ”¾å™¨
â””â”€â”€ cursor_style.rs         // å…‰æ ‡æ ·å¼
```

#### ChartRenderer - ä¸»æ¸²æŸ“å™¨

**æ¶æ„**: ä¸‰å±‚ Canvas åˆ†ç¦»æ¸²æŸ“

```rust
pub struct ChartRenderer {
    // ä¸‰å±‚Canvasä¸Šä¸‹æ–‡
    base_context: OffscreenCanvasRenderingContext2d,    // é™æ€å±‚
    main_context: OffscreenCanvasRenderingContext2d,    // æ•°æ®å±‚  
    overlay_context: OffscreenCanvasRenderingContext2d, // äº¤äº’å±‚
    
    // å¸ƒå±€å’Œæ•°æ®
    layout: ChartLayout,
    data_manager: DataManager,
    
    // å­æ¸²æŸ“å™¨
    axis_renderer: AxisRenderer,
    price_renderer: PriceRenderer,
    volume_renderer: VolumeRenderer,
    heat_renderer: HeatRenderer,
    // ... å…¶ä»–æ¸²æŸ“å™¨
}
```

**æ¸²æŸ“ç­–ç•¥**:

1. **Base Layer (é™æ€å±‚)**:
   - ğŸ—ï¸ åæ ‡è½´ã€ç½‘æ ¼çº¿
   - ğŸ¨ èƒŒæ™¯è‰²ã€è¾¹æ¡†
   - ğŸ·ï¸ æ ‡ç­¾æ–‡å­—
   - **æ›´æ–°é¢‘ç‡**: ä»…åœ¨å¸ƒå±€å˜åŒ–æ—¶é‡ç»˜

2. **Main Layer (æ•°æ®å±‚)**:
   - ğŸ“Š Kçº¿å›¾å½¢
   - ğŸ“ˆ æˆäº¤é‡æŸ±çŠ¶å›¾
   - ğŸ”¥ çƒ­å›¾æ¸²æŸ“
   - ğŸ’° è®¢å•ç°¿å¯è§†åŒ– (å³ä¾§20%åŒºåŸŸ)
   - **æ›´æ–°é¢‘ç‡**: æ•°æ®å˜åŒ–æˆ–ç¼©æ”¾æ—¶é‡ç»˜

3. **Overlay Layer (äº¤äº’å±‚)**:
   - â• åå­—å…‰æ ‡
   - ğŸ’¬ æ•°æ®æç¤ºæ¡†
   - ğŸ›ï¸ æ§åˆ¶æŒ‰é’®
   - ğŸ¨ ç»˜å›¾å·¥å…·
   - **æ›´æ–°é¢‘ç‡**: é¼ æ ‡ç§»åŠ¨æ—¶å®æ—¶é‡ç»˜

#### ä¸“ä¸šæ¸²æŸ“å™¨ç»„ä»¶

##### HeatRenderer - çƒ­å›¾æ¸²æŸ“å™¨

**ç®—æ³•æ ¸å¿ƒ**: åŸºäºæˆäº¤é‡åˆ†å¸ƒçš„çƒ­åŠ›å›¾ç”Ÿæˆ

```rust
pub struct HeatRenderer {
    color_config: ColorConfig,      // é¢œè‰²é…ç½®
    aggregation_method: AggregationMethod, // èšåˆç®—æ³•
    quality_level: f64,             // æ¸²æŸ“è´¨é‡
    render_cache: HashMap<String, Vec<u8>>, // æ¸²æŸ“ç¼“å­˜
}

pub enum ColorMapping {
    Bookmap,    // ç»å…¸BookMapé…è‰²
    Viridis,    // ç§‘å­¦å¯è§†åŒ–æ ‡å‡†é…è‰²
    Plasma,     // é«˜å¯¹æ¯”åº¦é…è‰²
    Thermal,    // ä¼ ç»Ÿçƒ­åŠ›å›¾é…è‰²
    Cool,       // å†·è‰²è°ƒé…è‰²
}
```

**æ€§èƒ½ä¼˜åŒ–**:
- ğŸš€ **SIMDåŠ é€Ÿ**: åˆ©ç”¨å‘é‡æŒ‡ä»¤å¹¶è¡Œè®¡ç®—
- ğŸ—„ï¸ **é¢œè‰²ç¼“å­˜**: 256çº§é¢œè‰²é¢„è®¡ç®—ç¼“å­˜
- ğŸ“Š **æ™ºèƒ½èšåˆ**: æ”¯æŒæˆäº¤é‡åŠ æƒã€æ—¶é—´è¡°å‡ç­‰ç®—æ³•
- ğŸ¯ **è´¨é‡è°ƒèŠ‚**: æ ¹æ®æ€§èƒ½è‡ªåŠ¨è°ƒæ•´æ¸²æŸ“è´¨é‡

##### BookRenderer - è®¢å•ç°¿æ¸²æŸ“å™¨

**è®¾è®¡ç†å¿µ**: ä¸“ä¸šçº§è®¢å•ç°¿æ·±åº¦å¯è§†åŒ–

```rust
pub struct BookRenderer {
    position: BookPosition,         // æ˜¾ç¤ºä½ç½® (å³ä¾§20%)
    depth_levels: usize,           // æ·±åº¦æ¡£ä½æ•°é‡
    color_scheme: BookColorScheme, // ä¹°å–ç›˜é…è‰²
    animation_enabled: bool,       // æ˜¯å¦å¯ç”¨åŠ¨ç”»
}
```

**å¯è§†åŒ–ç‰¹æ€§**:
- ğŸ“Š **æ·±åº¦å›¾**: ä¹°å–ç›˜å †ç§¯é¢ç§¯å›¾
- ğŸ¨ **é¢œè‰²åŒºåˆ†**: ä¹°ç›˜ç»¿è‰²ï¼Œå–ç›˜çº¢è‰²
- âš¡ **å®æ—¶æ›´æ–°**: è·Ÿéšé¼ æ ‡æ˜¾ç¤ºå¯¹åº”æ—¶é—´ç‚¹è®¢å•ç°¿
- ğŸ“ **æ™ºèƒ½ç¼©æ”¾**: æ ¹æ®æ·±åº¦æ•°æ®è‡ªåŠ¨è°ƒæ•´æ¯”ä¾‹å°º

### å¸ƒå±€æ¨¡å— (`layout/`)

```
layout/
â”œâ”€â”€ mod.rs              // æ¨¡å—å¯¼å‡º
â”œâ”€â”€ chart_layout.rs     // å¸ƒå±€ç®¡ç†å™¨
â”œâ”€â”€ colors.rs          // é¢œè‰²é…ç½®
â””â”€â”€ font.rs            // å­—ä½“é…ç½®
```

#### ChartLayout - å“åº”å¼å¸ƒå±€ç®¡ç†å™¨

**æ ¸å¿ƒç‰¹æ€§**: æ™ºèƒ½å“åº”å¼å¸ƒå±€ç³»ç»Ÿ

```rust
pub struct ChartLayout {
    canvas_width: f64,
    canvas_height: f64,
    responsive_config: ResponsiveConfig,
    current_breakpoint: LayoutBreakpoint,
}

pub struct ResponsiveConfig {
    breakpoints: Vec<LayoutBreakpoint>,
    enable_auto_adjust: bool,
    performance_mode: PerformanceMode,
}
```

**å¸ƒå±€ç­–ç•¥**:

1. **è®¾å¤‡æ–­ç‚¹**:
   - ğŸ“± **Mobile** (`< 768px`): ç®€åŒ–UIï¼Œéšè—è®¢å•ç°¿ï¼Œè§¦æ‘¸ä¼˜åŒ–
   - ğŸ“Ÿ **Tablet** (`768px - 1024px`): å¹³è¡¡å¸ƒå±€ï¼Œé€‚ä¸­ä¿¡æ¯å¯†åº¦
   - ğŸ’» **Desktop** (`1024px - 1440px`): å®Œæ•´åŠŸèƒ½ï¼Œæ ‡å‡†æ¯”ä¾‹
   - ğŸ–¥ï¸ **Large** (`> 1440px`): æœ€å¤§ä¿¡æ¯å¯†åº¦ï¼Œä¸“ä¸šçº§æ˜¾ç¤º

2. **å¸ƒå±€æ¯”ä¾‹** (æ¡Œé¢æ ‡å‡†):
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    Header (5%)                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Y-Axis â”‚        Main Chart (65%)         â”‚ OrderBook    â”‚
   â”‚  (8%)  â”‚                                 â”‚    (20%)     â”‚
   â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
   â”‚        â”‚  â”‚       K-Line Chart          â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚        â”‚  â”‚      (Price Area)           â”‚ â”‚  â”‚ Asks   â”‚ â”‚
   â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ Spread â”‚ â”‚
   â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ Bids   â”‚ â”‚
   â”‚        â”‚  â”‚     Volume Chart            â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚        â”‚  â”‚    (Volume Area)            â”‚ â”‚              â”‚
   â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚        â”‚          DataZoom (7%)          â”‚              â”‚
   â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   Tools      â”‚
   â”‚        â”‚  â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆ         â”‚ â”‚    (7%)     â”‚
   â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

#### è‡ªé€‚åº”ç‰¹æ€§

```rust
impl ChartLayout {
    // åŠ¨æ€è°ƒæ•´å¸ƒå±€
    pub fn resize(&mut self, new_width: f64, new_height: f64) {
        self.canvas_width = new_width;
        self.canvas_height = new_height;
        self.update_breakpoint();
        self.recalculate_areas();
    }
    
    // æ™ºèƒ½æ–­ç‚¹é€‰æ‹©
    pub fn select_breakpoint(&self) -> &LayoutBreakpoint {
        // åŸºäº canvas å°ºå¯¸è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¸ƒå±€é…ç½®
    }
    
    // æ€§èƒ½ä¼˜åŒ–æ¨¡å¼
    pub fn adjust_for_performance(&mut self, target_fps: f64) {
        if target_fps < 45.0 {
            self.enable_performance_mode();
        }
    }
}
```

### ç”»å¸ƒæ¨¡å— (`canvas/`)

```
canvas/
â”œâ”€â”€ mod.rs              // æ¨¡å—å¯¼å‡º
â”œâ”€â”€ canvas_manager.rs   // ç”»å¸ƒç®¡ç†å™¨
â”œâ”€â”€ base_canvas.rs      // åŸºç¡€ç”»å¸ƒæ“ä½œ
â””â”€â”€ layer.rs           // å›¾å±‚ç±»å‹å®šä¹‰
```

#### CanvasManager - ç»Ÿä¸€ç”»å¸ƒç®¡ç†

**èŒè´£**: ä¸‰å±‚ Canvas çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

```rust
pub struct CanvasManager {
    base_canvas: OffscreenCanvas,
    main_canvas: OffscreenCanvas, 
    overlay_canvas: OffscreenCanvas,
    layer_dirty_flags: LayerDirtyFlags,
}

pub enum CanvasLayerType {
    Base,       // é™æ€èƒŒæ™¯å±‚
    Main,       // æ•°æ®æ˜¾ç¤ºå±‚
    Overlay,    // äº¤äº’è¦†ç›–å±‚
}
```

**ä¼˜åŒ–ç‰¹æ€§**:
- ğŸ·ï¸ **è„æ ‡è®°ç³»ç»Ÿ**: åªé‡ç»˜å˜åŒ–çš„å›¾å±‚
- ğŸ¨ **ç¦»å±æ¸²æŸ“**: åˆ©ç”¨ OffscreenCanvas æå‡æ€§èƒ½
- ğŸ“ **å°ºå¯¸åŒæ­¥**: è‡ªåŠ¨åŒæ­¥ä¸‰å±‚ Canvas å°ºå¯¸
- ğŸ—„ï¸ **ä¸Šä¸‹æ–‡ç¼“å­˜**: å‡å°‘ä¸Šä¸‹æ–‡è·å–å¼€é”€

### å·¥å…·æ¨¡å— (`utils/`)

**èŒè´£**: é€šç”¨å·¥å…·å‡½æ•°å’Œé”™è¯¯å¤„ç†

```rust
// é”™è¯¯ç±»å‹å®šä¹‰
pub enum WasmError {
    Buffer(String),      // ç¼“å†²åŒºç›¸å…³é”™è¯¯
    Validation(String),  // æ•°æ®éªŒè¯é”™è¯¯
    Parse(String),       // è§£æé”™è¯¯
    Render(String),      // æ¸²æŸ“é”™è¯¯
    Layout(String),      // å¸ƒå±€é”™è¯¯
}

// æ€§èƒ½ç›‘æ§å·¥å…·
pub struct PerformanceTimer {
    start_time: f64,
    label: String,
}

// æ•°å­¦è®¡ç®—å·¥å…·
pub mod math {
    pub fn linear_interpolate(x0: f64, y0: f64, x1: f64, y1: f64, x: f64) -> f64;
    pub fn clamp(value: f64, min: f64, max: f64) -> f64;
    pub fn map_range(value: f64, from_min: f64, from_max: f64, to_min: f64, to_max: f64) -> f64;
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. åˆ†å±‚æ¸²æŸ“ç¼“å­˜

**ç­–ç•¥**: åŸºäºå›¾å±‚å˜åŒ–é¢‘ç‡çš„æ™ºèƒ½ç¼“å­˜

```rust
pub struct RenderCache {
    static_layer_cache: Option<ImageData>,     // é™æ€å±‚ç¼“å­˜
    data_layer_cache: Option<ImageData>,       // æ•°æ®å±‚ç¼“å­˜
    cache_validity: LayerDirtyFlags,           // ç¼“å­˜æœ‰æ•ˆæ€§æ ‡è®°
    cache_hit_rate: f64,                       // ç¼“å­˜å‘½ä¸­ç‡
}
```

**æ”¶ç›Š**:
- ğŸš€ å‡å°‘ 60-80% çš„é‡ç»˜æ“ä½œ
- ğŸ“Š æå‡äº¤äº’å“åº”é€Ÿåº¦ 50%
- ğŸ’¾ ä¼˜åŒ–å†…å­˜ä½¿ç”¨ 40%

### 2. SIMD å‘é‡åŒ–è®¡ç®—

**åº”ç”¨åœºæ™¯**: çƒ­å›¾æ•°æ®èšåˆã€é¢œè‰²è®¡ç®—

```rust
#[cfg(target_arch = "wasm32")]
fn process_volumes_simd(volumes: &[f64], prices: &[f64]) -> Vec<f64> {
    // åˆ©ç”¨ WASM SIMD æŒ‡ä»¤å¹¶è¡Œè®¡ç®—
    // 4ä¸ªæ•°æ®å¹¶è¡Œå¤„ç†ï¼Œæå‡3-4å€æ€§èƒ½
}
```

### 3. å“åº”å¼è´¨é‡è°ƒæ•´

**æœºåˆ¶**: æ ¹æ®è®¾å¤‡æ€§èƒ½åŠ¨æ€è°ƒæ•´æ¸²æŸ“è´¨é‡

```rust
pub struct AdaptiveQuality {
    target_fps: f64,           // ç›®æ ‡å¸§ç‡ (60fps)
    current_fps: f64,          // å½“å‰å¸§ç‡
    quality_level: f64,        // è´¨é‡ç­‰çº§ (0.1-1.0)
    auto_adjust: bool,         // è‡ªåŠ¨è°ƒæ•´å¼€å…³
}

impl AdaptiveQuality {
    pub fn update_quality(&mut self, frame_time: f64) {
        if self.current_fps < self.target_fps * 0.8 {
            self.quality_level *= 0.9; // é™ä½è´¨é‡
        } else if self.current_fps > self.target_fps * 0.95 {
            self.quality_level = (self.quality_level * 1.05).min(1.0); // æå‡è´¨é‡
        }
    }
}
```

### 4. å†…å­˜ç®¡ç†ä¼˜åŒ–

**æŠ€æœ¯**:
- ğŸ—„ï¸ **å¯¹è±¡æ± **: å¤ç”¨ Canvas ImageData å¯¹è±¡
- ğŸ“¦ **æ•°æ®å‹ç¼©**: FlatBuffers é›¶æ‹·è´ååºåˆ—åŒ–
- ğŸ”„ **å¢é‡æ›´æ–°**: åªå¤„ç†å˜åŒ–çš„æ•°æ®éƒ¨åˆ†
- ğŸ§¹ **åƒåœ¾å›æ”¶ä¼˜åŒ–**: å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ†é…

---

## ğŸ–±ï¸ äº¤äº’ç³»ç»Ÿè®¾è®¡

### äº‹ä»¶å¤„ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥äº‹ä»¶
      â†“
KlineProcess äº‹ä»¶åˆ†å‘
      â†“
ChartRenderer äº‹ä»¶å¤„ç†
      â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â–¼                 â–¼                 â–¼                 â–¼
é¼ æ ‡ç§»åŠ¨         æ»šè½®ç¼©æ”¾          ç‚¹å‡»åˆ‡æ¢         æ‹–æ‹½æ“ä½œ
   â†“                 â†“                 â†“                 â–¼
åå­—å…‰æ ‡æ›´æ–°    å¯è§èŒƒå›´è°ƒæ•´      æ¸²æŸ“æ¨¡å¼åˆ‡æ¢     æ•°æ®å¯¼èˆªå™¨æ‹–æ‹½
   â†“                 â†“                 â†“                 â–¼
Overlayå±‚é‡ç»˜   Mainå±‚é‡ç»˜       å…¨å±‚é‡ç»˜         èŒƒå›´æ›´æ–°+é‡ç»˜
```

### é¼ æ ‡äº‹ä»¶å¤„ç†

```rust
impl KlineProcess {
    // é¼ æ ‡ç§»åŠ¨: æ›´æ–°åå­—å…‰æ ‡å’Œæç¤ºæ¡†
    pub fn handle_mouse_move(&self, x: f64, y: f64) {
        if let Some(renderer) = &self.chart_renderer {
            renderer.handle_mouse_move(x, y);
            // åªé‡ç»˜ Overlay å±‚ï¼Œä¼˜åŒ–æ€§èƒ½
        }
    }
    
    // æ»šè½®ç¼©æ”¾: è°ƒæ•´å¯è§æ•°æ®èŒƒå›´
    pub fn handle_wheel(&self, delta: f64, x: f64, y: f64) {
        if let Some(renderer) = &self.chart_renderer {
            renderer.handle_wheel(delta, x, y);
            // é‡ç»˜ Main å±‚å’Œ Overlay å±‚
        }
    }
    
    // ç‚¹å‡»åˆ‡æ¢: Kçº¿å›¾ â†” çƒ­å›¾æ¨¡å¼
    pub fn handle_click(&mut self, x: f64, y: f64) -> bool {
        if let Some(renderer) = &self.chart_renderer {
            return renderer.handle_click(x, y);
            // åˆ‡æ¢æ¸²æŸ“æ¨¡å¼ï¼Œå…¨å±‚é‡ç»˜
        }
        false
    }
}
```

### å…‰æ ‡æ ·å¼ç®¡ç†

```rust
pub enum CursorStyle {
    Default,        // é»˜è®¤ç®­å¤´
    Pointer,        // æ‰‹å‹(å¯ç‚¹å‡»)
    EwResize,       // æ°´å¹³è°ƒæ•´
    NsResize,       // å‚ç›´è°ƒæ•´
    Move,           // ç§»åŠ¨
    Crosshair,      // åå­—å…‰æ ‡
}

impl CursorStyle {
    pub fn from_interaction_area(area: &InteractionArea, mouse_state: &MouseState) -> Self {
        match area {
            InteractionArea::ModeToggle => CursorStyle::Pointer,
            InteractionArea::DataZoomHandle => CursorStyle::EwResize,
            InteractionArea::DataZoomBar => CursorStyle::Move,
            InteractionArea::ChartArea => CursorStyle::Crosshair,
            _ => CursorStyle::Default,
        }
    }
}
```

---

## ğŸ“Š æ•°æ®æµæ¶æ„

### FlatBuffers æ•°æ®åè®®

**ä¼˜åŠ¿**: é›¶æ‹·è´ååºåˆ—åŒ–ï¼Œé«˜æ€§èƒ½è·¨è¯­è¨€æ•°æ®äº¤æ¢

```flatbuffers
// Kçº¿æ•°æ®ç»“æ„å®šä¹‰
table KlineData {
    symbol: string;
    interval: string;
    klines: [Kline];
    order_books: [OrderBook];
}

table Kline {
    timestamp: uint64;
    open: double;
    high: double;
    low: double;
    close: double;
    volume: double;
}

table OrderBook {
    timestamp: uint64;
    bids: [PriceLevel];
    asks: [PriceLevel];
}
```

### æ•°æ®å¤„ç†ç®¡é“

```
åŸå§‹æ•°æ® (JSON/Binary)
         â†“
FlatBuffers ç¼–ç  (Client Side)
         â†“
WASM å†…å­˜ä¼ è¾“
         â†“
æ•°æ®éªŒè¯ + è§£æ (KlineProcess)
         â†“
æ•°æ®ç®¡ç†å™¨å­˜å‚¨ (DataManager)
         â†“
å¯è§èŒƒå›´è®¡ç®— (VisibleRange)
         â†“
æ¸²æŸ“å™¨æ•°æ®è®¿é—® (ChartRenderer)
         â†“
å›¾å½¢ç»˜åˆ¶è¾“å‡º (Canvas)
```

### å®æ—¶æ•°æ®æ›´æ–°

```rust
impl DataManager {
    // å¢é‡æ•°æ®æ›´æ–°
    pub fn update_kline_data(&mut self, new_kline: &Kline) -> bool {
        // 1. æ•°æ®éªŒè¯
        if !self.validate_new_data(new_kline) {
            return false;
        }
        
        // 2. æ›´æ–°æœ€æ–°æ•°æ®
        if let Some(latest) = self.get_latest_kline_mut() {
            if latest.timestamp == new_kline.timestamp {
                // æ›´æ–°å½“å‰Kçº¿
                *latest = new_kline.clone();
            } else {
                // æ·»åŠ æ–°Kçº¿
                self.append_kline(new_kline);
            }
        }
        
        // 3. ç¼“å­˜å¤±æ•ˆ
        self.invalidate_cache();
        
        // 4. è§¦å‘é‡ç»˜
        true
    }
}
```

---

## ğŸ”§ æ„å»ºå’Œéƒ¨ç½²

### æ„å»ºé…ç½®

**Cargo.toml å…³é”®é…ç½®**:
```toml
[lib]
crate-type = ["cdylib"]  # ç”ŸæˆåŠ¨æ€é“¾æ¥åº“ä¾› WASM ä½¿ç”¨

[profile.release]
opt-level = 3           # æœ€é«˜ä¼˜åŒ–çº§åˆ«
lto = true             # é“¾æ¥æ—¶ä¼˜åŒ–
```

**å…³é”®ä¾èµ–**:
- `wasm-bindgen`: Rust â†” JavaScript ç»‘å®š
- `web-sys`: Web API ç»‘å®š
- `flatbuffers`: é«˜æ€§èƒ½åºåˆ—åŒ–
- `js-sys`: JavaScript ç±»å‹ç»‘å®š

### æ„å»ºè„šæœ¬

```bash
#!/bin/bash
# build.sh

echo "ğŸ”¨ æ„å»º WASM æ¨¡å—..."

# 1. æ„å»º WASM
wasm-pack build --target web --out-dir pkg --release

# 2. ä¼˜åŒ– WASM å¤§å°
if command -v wasm-opt >/dev/null 2>&1; then
    echo "ğŸ“¦ ä¼˜åŒ– WASM ä½“ç§¯..."
    wasm-opt -Oz -o pkg/kline_processor_bg.wasm pkg/kline_processor_bg.wasm
fi

# 3. ç”Ÿæˆ TypeScript ç±»å‹å£°æ˜
echo "ğŸ“ ç”Ÿæˆç±»å‹å£°æ˜..."
# è‡ªåŠ¨ç”Ÿæˆçš„ .d.ts æ–‡ä»¶

echo "âœ… æ„å»ºå®Œæˆ!"
```

### é›†æˆä½¿ç”¨

```typescript
// TypeScript é›†æˆç¤ºä¾‹
import init, { KlineProcess } from './pkg/kline_processor.js';

async function initChart() {
    // 1. åˆå§‹åŒ– WASM æ¨¡å—
    await init();
    
    // 2. åˆ›å»º OffscreenCanvas
    const baseCanvas = new OffscreenCanvas(800, 600);
    const mainCanvas = new OffscreenCanvas(800, 600);
    const overlayCanvas = new OffscreenCanvas(800, 600);
    
    // 3. å‡†å¤‡æ•°æ® (FlatBuffersæ ¼å¼)
    const klineData = prepareKlineData();
    
    // 4. åˆ›å»ºå¤„ç†å™¨å®ä¾‹
    const processor = new KlineProcess(
        WebAssembly.memory,
        klineData.ptr,
        klineData.length
    );
    
    // 5. è®¾ç½®ç”»å¸ƒ
    processor.set_canvases(baseCanvas, mainCanvas, overlayCanvas);
    
    // 6. ç»˜åˆ¶å›¾è¡¨
    processor.draw_all();
    
    // 7. ç»‘å®šäº‹ä»¶å¤„ç†
    canvas.addEventListener('mousemove', (e) => {
        processor.handle_mouse_move(e.offsetX, e.offsetY);
    });
    
    canvas.addEventListener('wheel', (e) => {
        processor.handle_wheel(e.deltaY, e.offsetX, e.offsetY);
    });
}
```

---

## ğŸš€ æœªæ¥æ‰©å±•è§„åˆ’

### çŸ­æœŸç›®æ ‡ (1-3ä¸ªæœˆ)

1. **æ€§èƒ½æ·±åº¦ä¼˜åŒ–**
   - WebWorker å¤šçº¿ç¨‹æ¸²æŸ“
   - WebGL ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“
   - æ›´æ™ºèƒ½çš„ç¼“å­˜ç­–ç•¥

2. **åŠŸèƒ½å®Œå–„**
   - æ›´å¤šæŠ€æœ¯æŒ‡æ ‡ (MACD, KDJ, RSI)
   - ç»˜å›¾å·¥å…·ç³»ç»Ÿ (è¶‹åŠ¿çº¿, æ–æ³¢é‚£å¥‘)
   - æ•°æ®å¯¼å‡ºåŠŸèƒ½

3. **ç”¨æˆ·ä½“éªŒæå‡**
   - è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
   - é”®ç›˜å¿«æ·é”®
   - ä¸»é¢˜åˆ‡æ¢ç³»ç»Ÿ

### ä¸­æœŸç›®æ ‡ (3-6ä¸ªæœˆ)

1. **é«˜çº§åˆ†æåŠŸèƒ½**
   - æœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹
   - è®¢å•æµåˆ†æ
   - æµåŠ¨æ€§èšç±»æ£€æµ‹

2. **å¤šå¸‚åœºæ”¯æŒ**
   - å¤šäº¤æ˜“å¯¹åŒæ—¶æ˜¾ç¤º
   - è·¨å¸‚åœºå¥—åˆ©ç›‘æ§
   - å¸‚åœºç›¸å…³æ€§åˆ†æ

3. **ä¸“ä¸šçº§åŠŸèƒ½**
   - 3D è®¢å•ç°¿å¯è§†åŒ–
   - ç­–ç•¥å›æµ‹æ¡†æ¶
   - é£é™©ç®¡ç†é›†æˆ

### é•¿æœŸæ„¿æ™¯ (6ä¸ªæœˆ+)

1. **äº‘ç«¯é›†æˆ**
   - å®æ—¶æ•°æ®æ¨é€
   - äº‘ç«¯é…ç½®åŒæ­¥
   - åä½œåˆ†æåŠŸèƒ½

2. **ç§»åŠ¨ç«¯é€‚é…**
   - PWA æ”¯æŒ
   - åŸç”Ÿç§»åŠ¨åº”ç”¨
   - ç¦»çº¿æ•°æ®æ”¯æŒ

3. **ç”Ÿæ€å»ºè®¾**
   - æ’ä»¶ç³»ç»Ÿ
   - å¼€å‘è€… API
   - ç¤¾åŒºé©±åŠ¨åŠŸèƒ½

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### å½“å‰æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| æ¸²æŸ“å¸§ç‡ | 60 FPS | 55-60 FPS | âœ… è¾¾æ ‡ |
| åˆå§‹åŠ è½½æ—¶é—´ | < 200ms | ~150ms | âœ… ä¼˜ç§€ |
| å†…å­˜å ç”¨ | < 100MB | ~72MB | âœ… ä¼˜ç§€ |
| äº¤äº’å“åº”å»¶è¿Ÿ | < 50ms | ~30-50ms | âœ… ä¼˜ç§€ |
| WASM åŒ…ä½“ç§¯ | < 1MB | ~800KB | âœ… ä¼˜ç§€ |

### å‹åŠ›æµ‹è¯•ç»“æœ

- **å¤§æ•°æ®é‡**: 10ä¸‡+ Kçº¿æ•°æ®ï¼Œæ¸²æŸ“å»¶è¿Ÿ < 100ms
- **é«˜é¢‘äº¤äº’**: è¿ç»­é¼ æ ‡ç§»åŠ¨ï¼ŒCPUå ç”¨ < 20%
- **å†…å­˜ç¨³å®šæ€§**: é•¿æ—¶é—´è¿è¡Œæ— å†…å­˜æ³„æ¼
- **å¤šè®¾å¤‡é€‚é…**: iPhone/Android/Desktop å…¨å¹³å°æ”¯æŒ

---

## ğŸ’¡ å¼€å‘å»ºè®®

### ä»£ç è§„èŒƒ

1. **æ¨¡å—åŒ–åŸåˆ™**: æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œæ¥å£æ¸…æ™°
2. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ `Result<T, WasmError>` ç»Ÿä¸€é”™è¯¯å¤„ç†
3. **æ€§èƒ½æ„è¯†**: é¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…å’Œè®¡ç®—
4. **ç±»å‹å®‰å…¨**: å……åˆ†åˆ©ç”¨ Rust ç±»å‹ç³»ç»Ÿé˜²æ­¢è¿è¡Œæ—¶é”™è¯¯

### è°ƒè¯•æŠ€å·§

1. **æ€§èƒ½ç›‘æ§**: ä½¿ç”¨ `console.time` ç›‘æ§å…³é”®å‡½æ•°æ‰§è¡Œæ—¶é—´
2. **å†…å­˜åˆ†æ**: åˆ©ç”¨æµè§ˆå™¨ DevTools ç›‘æ§å†…å­˜ä½¿ç”¨
3. **é”™è¯¯è¿½è¸ª**: å¯ç”¨ `console_error_panic_hook` è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
4. **æ¸²æŸ“è°ƒè¯•**: åˆ†å±‚æ¸²æŸ“ä¾¿äºå®šä½æ¸²æŸ“é—®é¢˜

### æœ€ä½³å®è·µ

1. **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
2. **äº‹ä»¶èŠ‚æµ**: é«˜é¢‘äº‹ä»¶(å¦‚é¼ æ ‡ç§»åŠ¨)ä½¿ç”¨èŠ‚æµä¼˜åŒ–æ€§èƒ½
3. **æ•°æ®éªŒè¯**: åœ¨æ•°æ®è¾¹ç•Œè¿›è¡Œä¸¥æ ¼éªŒè¯
4. **ç”¨æˆ·ä½“éªŒ**: æä¾›åŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º

---

è¿™ä¸ªæ¶æ„è®¾è®¡ä¸ºé‡‘èæ•°æ®å¯è§†åŒ–æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ï¼Œç»“åˆäº†ç°ä»£ Web æŠ€æœ¯çš„ä¼˜åŠ¿å’Œ Rust çš„æ€§èƒ½ç‰¹æ€§ï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸“ä¸šçº§é‡‘èåˆ†æå·¥å…·çš„éœ€æ±‚ã€‚é€šè¿‡æ¨¡å—åŒ–è®¾è®¡ï¼Œç³»ç»Ÿå…·æœ‰è‰¯å¥½çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œä¸ºæœªæ¥çš„åŠŸèƒ½è¿­ä»£æ‰“ä¸‹äº†è‰¯å¥½åŸºç¡€ã€‚
