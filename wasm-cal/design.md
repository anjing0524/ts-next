### Design 金融数据分析系统

1. **数据获取与处理层**

   - 采用 FlatBuffers 进行高效序列化，减少内存占用和序列化开销
   - 通过 WASM 内存共享机制实现 JavaScript 与 WASM 模块间的数据传递
   - 实现数据验证机制，确保数据完整性和格式正确性
   - 支持从 WASM 内存中读取和解析 K 线数据，包括时间戳、价格、成交量等信息
   - 数据管理器 (`DataManager`) 负责管理 K 线数据和可见范围，提供数据访问接口
   - 订单簿数据管理器 (`OrderBookManager`) 负责管理订单簿数据，提供按时间戳查询订单簿快照的接口

2. **数据处理与可见范围管理**

   - `VisibleRange` 类负责封装和管理可见数据范围的计算，包括起始索引、数量和结束索引
   - 支持安全的边界检查和范围计算，防止越界访问
   - 实现缩放、移动等操作，优化用户交互体验
   - 计算可见区域的数据范围（最低价、最高价、最大成交量）
   - 缓存数据范围计算结果，避免重复计算，提高性能
   - 支持鼠标滚轮事件处理，实现数据缩放功能

3. **数据可视化层**

   - 三层 Canvas 架构：
     - 背景层 (`Base`): 绘制静态元素（坐标轴、网格线、背景色等）
     - 数据层 (`Main`): 绘制主要图表元素（K线、成交量、热图等），预留右侧20%宽度区域用于订单簿可视化
     - 交互层 (`Overlay`): 绘制交互元素（十字光标、提示框、切换按钮等）和订单簿可视化（占用Main层右侧20%宽度）
   - 支持多种渲染模式：
     - `KMAP`: K线图和成交量图模式
     - `HEATMAP`: 热图和成交量图模式
   - 模块化渲染组件：
     - `AxisRenderer`: 负责绘制坐标轴和网格
     - `PriceRenderer`: 负责绘制K线图
     - `VolumeRenderer`: 负责绘制成交量图
     - `HeatRenderer`: 负责绘制热图
     - `LineRenderer`: 负责绘制价格线（最新价、买一价、卖一价）
     - `OverlayRenderer`: 负责绘制交互元素
     - `DataZoomRenderer`: 负责绘制数据缩放导航器
     - `BookRenderer`: 负责绘制订单簿可视化（在Overlay层，但占用Main层右侧20%宽度）
   - 优化渲染性能：
     - 使用 OffscreenCanvas 进行离屏渲染
     - 实现视口渲染，只渲染可见区域
     - 批量绘制操作，减少绘制调用次数
     - 缓存计算结果，避免重复计算

4. **交互系统**

   - 鼠标事件处理：
     - 移动事件：更新十字光标位置，显示数据提示框，更新订单簿可视化
     - 点击事件：支持模式切换（K线图/热图）
     - 拖动事件：支持数据缩放导航器的拖动操作
     - 滚轮事件：支持数据缩放
   - 数据缩放功能：
     - 通过 DataZoom 导航器实现数据范围的可视化调整
     - 支持拖动左右手柄调整可见范围
     - 支持拖动中间区域平移可见范围
   - 模式切换：
     - 支持 K 线图和热图模式之间的切换
     - 根据当前模式应用相应的布局和渲染策略
   - 订单簿交互：
     - 鼠标悬停时显示对应时间点的订单簿快照
     - 支持订单簿深度可视化，买卖盘采用不同颜色区分
     - 提供订单簿数据筛选功能，可调整显示档位数量
     - 支持订单簿数据导出功能

5. **系统架构**

   - 模块化设计：
     - 数据管理模块：负责数据存储和可见范围管理
     - 订单簿管理模块：负责订单簿数据的存储和查询
     - 布局模块：负责图表布局计算和坐标映射
     - 渲染模块：负责各种图表元素的绘制
     - 交互模块：负责用户交互事件处理
   - 错误处理：
     - 使用 `WasmError` 枚举类型进行错误处理
     - 支持数据验证、解析错误、渲染错误等异常情况
   - 性能优化：
     - 使用 OffscreenCanvas 进行离屏渲染
     - 实现数据范围缓存，避免重复计算
     - 批量绘制操作，减少绘制调用次数
     - 使用 FlatBuffers 进行高效序列化

6. **Overlay层详细设计**

   - 订单簿可视化组件 (`BookRenderer`):
     - 功能：在Main层显示订单簿数据可视化，但占用Main层右侧20%宽度
     - 实现：
       - 在Main层右侧20%宽度区域显示订单簿深度图
       - 买卖盘采用不同颜色区分（买盘通常为绿色，卖盘通常为红色）
       - 支持显示多个档位的订单簿数据
       - 根据鼠标位置动态更新显示的订单簿时间点
       - 提供订单簿数据筛选和缩放功能
       - 与Main层数据区域保持视觉一致性，但独立于Main层渲染
   - 模式特定Tooltip设计:
     - `KMAP`模式Tooltip:
       - 显示当前鼠标位置对应的K线数据（开盘价、收盘价、最高价、最低价、成交量）
       - 显示技术指标数据（如已实现的MA、MACD等）
       - 显示当前时间点的订单簿汇总数据（买一卖一价格和数量）
       - 提供订单簿详细视图的入口
     - `HEATMAP`模式Tooltip:
       - 显示当前鼠标位置对应的热图数据（价格区间、成交量分布）
       - 显示当前时间点的订单簿汇总数据
       - 提供订单簿详细视图的入口
   - 交互元素:
     - 十字光标：跟随鼠标移动，显示当前数据点
     - 数据提示框：根据当前模式显示相应的数据信息
     - 模式切换按钮：在KMAP和HEATMAP模式之间切换
     - 订单簿控制面板：提供订单簿显示控制选项（档位数量、显示位置等）

7. **未来扩展方向**

   - 支持更多技术指标计算：MA、MACD、KDJ、RSI 等
   - 实现自定义指标系统，允许用户定义分析逻辑
   - 支持更多图表类型：面积图、柱状图等
   - 添加数据导出功能，支持多种格式导出
   - 优化大数据量下的渲染性能
   - 支持更多交互方式，如触摸事件、键盘快捷键等
   - 增强订单簿可视化功能：
     - 支持订单簿热力图显示
     - 提供订单簿数据回放功能
     - 支持订单簿数据对比分析
     - 实现订单簿异常检测和标记
