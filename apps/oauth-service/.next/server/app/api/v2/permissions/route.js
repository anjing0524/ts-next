"use strict";(()=>{var e={};e.id=583,e.ids=[583],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1161:(e,s,t)=>{t.r(s),t.d(s,{patchFetch:()=>T,routeModule:()=>R,serverHooks:()=>S,workAsyncStorage:()=>N,workUnitAsyncStorage:()=>v});var i={};t.r(i),t.d(i,{GET:()=>E,POST:()=>P});var r=t(9227),a=t(9044),n=t(1131),o=t(7642),d=t(8891),p=t(6330),u=t(4633),m=t(9776),c=t(7200);let l=c.z.object({httpMethod:c.z.nativeEnum(p.HttpMethod),endpoint:c.z.string().startsWith("/","API端点路径必须以'/'开头 (Endpoint path must start with '/')"),rateLimit:c.z.number().int().positive().optional()}),I=c.z.object({menuId:c.z.string().cuid("无效的菜单ID格式 (Invalid Menu ID format: must be a CUID)")}),y=c.z.object({tableName:c.z.string().min(1,"表名不能为空 (Table name cannot be empty)"),columnName:c.z.string().optional(),conditions:c.z.string().optional()}),g=c.z.object({name:c.z.string().min(3,"权限名称至少需要3个字符 (Permission name must be at least 3 characters long)").max(100,"权限名称不能超过100个字符 (Permission name cannot exceed 100 characters long)").regex(/^[a-zA-Z0-9_:-]+$/,"权限名称格式无效，只能包含字母、数字、下划线、冒号和连字符 (Invalid permission name format. Allowed: letters, numbers, underscore, colon, hyphen)"),displayName:c.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(150,"显示名称不能超过150字符"),description:c.z.string().max(255,"描述信息不能超过255字符").optional(),type:c.z.nativeEnum(p.PermissionType),resource:c.z.string().min(1,"资源标识不能为空 (Resource identifier cannot be empty)").max(200,"资源标识不能超过200字符"),action:c.z.string().min(1,"操作不能为空 (Action cannot be empty)").max(50,"操作名称不能超过50字符"),isActive:c.z.boolean().optional().default(!0),apiDetails:l.optional(),menuDetails:I.optional(),dataDetails:y.optional()}).superRefine((e,s)=>{e.type!==p.PermissionType.API||e.apiDetails||s.addIssue({code:c.z.ZodIssueCode.custom,message:"API类型的权限必须提供apiDetails对象 (For API type permission, 'apiDetails' object must be provided)",path:["apiDetails"]}),e.type!==p.PermissionType.MENU||e.menuDetails||s.addIssue({code:c.z.ZodIssueCode.custom,message:"MENU类型的权限必须提供menuDetails对象 (For MENU type permission, 'menuDetails' object must be provided)",path:["menuDetails"]}),e.type!==p.PermissionType.DATA||e.dataDetails||s.addIssue({code:c.z.ZodIssueCode.custom,message:"DATA类型的权限必须提供dataDetails对象 (For DATA type permission, 'dataDetails' object must be provided)",path:["dataDetails"]})});async function A(e){let{searchParams:s}=new URL(e.url),t=parseInt(s.get("page")||"1",10),i=parseInt(s.get("pageSize")||"10",10);i=Math.min(Math.max(i,1),100);let r=s.get("name"),a=s.get("type"),n=s.get("resource"),u=s.get("action"),m={};r&&(m.name={contains:r,mode:"insensitive"}),a&&Object.values(p.PermissionType).includes(a)&&(m.type=a),n&&(m.resource={contains:n,mode:"insensitive"}),u&&(m.action={contains:u,mode:"insensitive"});try{let e=await d.A.permission.findMany({where:m,include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0},skip:(t-1)*i,take:i,orderBy:{createdAt:"desc"}}),s=await d.A.permission.count({where:m});return o.NextResponse.json({data:e,pagination:{page:t,pageSize:i,totalItems:s,totalPages:Math.ceil(s/i)}})}catch(e){return console.error("列出权限失败 (Failed to list permissions):",e),o.NextResponse.json({message:"获取权限列表时发生错误 (An error occurred while retrieving permissions list)"},{status:500})}}async function x(e){let s,t=e.user,i=e.ip||e.headers?.get("x-forwarded-for"),r=e.headers?.get("user-agent");try{s=await e.json()}catch(e){return await m.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"PERMISSION_CREATE_FAILURE_INVALID_JSON",status:"FAILURE",ipAddress:i,userAgent:r,errorMessage:"Invalid JSON request body for permission creation.",details:JSON.stringify({error:e.message})}),o.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let a=g.safeParse(s);if(!a.success)return await m.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"PERMISSION_CREATE_FAILURE_VALIDATION",status:"FAILURE",ipAddress:i,userAgent:r,errorMessage:"Permission creation payload validation failed.",details:JSON.stringify({issues:a.error.format(),receivedBody:s})}),o.NextResponse.json({message:"创建权限的输入数据验证失败 (Permission creation input validation failed)",errors:a.error.format()},{status:400});let{name:n,displayName:u,description:c,type:l,resource:I,action:y,isActive:A,apiDetails:x,menuDetails:E,dataDetails:P}=a.data;try{let e=await d.A.permission.findUnique({where:{name:n}});if(e)return await m.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"PERMISSION_CREATE_FAILURE_CONFLICT",status:"FAILURE",ipAddress:i,userAgent:r,errorMessage:`Permission name "${n}" already exists.`,resourceType:"Permission",resourceId:e.id,details:JSON.stringify({name:n})}),o.NextResponse.json({message:`权限名称 "${n}" 已存在 (Permission name "${n}" already exists)`},{status:409});let s=await d.A.$transaction(async e=>{let s=await e.permission.create({data:{name:n,displayName:u,description:c,type:l,resource:I,action:y,isActive:A}});if(l===p.PermissionType.API&&x)await e.apiPermission.create({data:{permissionId:s.id,...x}});else if(l===p.PermissionType.MENU&&E){let t=await e.menu.count({where:{id:E.menuId}});if(0===t)throw Error(`关联的菜单ID "${E.menuId}" 无效或不存在 (The associated Menu ID "${E.menuId}" is invalid or does not exist)`);await e.menuPermission.create({data:{permissionId:s.id,menuId:E.menuId}})}else l===p.PermissionType.DATA&&P&&await e.dataPermission.create({data:{permissionId:s.id,...P}});return s}),a=await d.A.permission.findUnique({where:{id:s.id},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});return await m.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"PERMISSION_CREATE_SUCCESS",status:"SUCCESS",resourceType:"Permission",resourceId:s.id,ipAddress:i,userAgent:r,details:JSON.stringify({permissionId:s.id,name:s.name,type:s.type,resource:s.resource,action:s.action,apiDetails:x,menuDetails:E,dataDetails:P})}),o.NextResponse.json(a,{status:201})}catch(d){console.error("创建权限失败 (Failed to create permission):",d);let e="An unexpected server error occurred during permission creation",s="PERMISSION_CREATE_FAILURE_DB_ERROR",a=500;return d instanceof p.Prisma.PrismaClientKnownRequestError&&"P2002"===d.code?(e=`Permission name "${n}" already exists due to a database constraint`,s="PERMISSION_CREATE_FAILURE_CONFLICT_DB",a=409):d.message.includes("菜单ID")&&(e=d.message,s="PERMISSION_CREATE_FAILURE_INVALID_MENU_ID",a=400),await m.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:s,status:"FAILURE",ipAddress:i,userAgent:r,errorMessage:e,details:JSON.stringify({name:n,displayName:u,type:l,resource:I,action:y,apiDetailsAttempted:x,menuDetailsAttempted:E,dataDetailsAttempted:P,error:d.message,errorCode:d.code})}),o.NextResponse.json({message:e},{status:a})}}let E=(0,u.PS)("permissions:list")(A),P=(0,u.PS)("permissions:create")(x),R=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v2/permissions/route",pathname:"/api/v2/permissions",filename:"route",bundlePath:"app/api/v2/permissions/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/permissions/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:N,workUnitAsyncStorage:v,serverHooks:S}=R;function T(){return(0,n.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:v})}},1204:e=>{e.exports=require("string_decoder")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),i=s.X(0,[938,176,578,935,200,813,776,633],()=>t(1161));module.exports=i})();