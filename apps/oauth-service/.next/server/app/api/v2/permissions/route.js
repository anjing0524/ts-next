(()=>{var e={};e.id=583,e.ids=[583],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function s(e){var s=Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}s.keys=()=>[],s.resolve=s,s.id=4997,e.exports=s},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,s,t)=>{"use strict";t.d(s,{z:()=>i});var r=t(96330);let i=globalThis.prisma??new r.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,s,t)=>{"use strict";t.d(s,{prisma:()=>r.z}),t(96330);var r=t(24958),i=t(50488),o=t.n(i),a=t(5433);o().config();let n={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},u=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:n.host,port:n.port,user:n.user,database:n.database}),a.createPool(n));async function c(){if(u&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await u.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await c(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,s,t)=>{"use strict";t.d(s,{B9:()=>r.B9,Uj:()=>r.Uj}),t(44325),t(18354);var r=t(84327);t(43281),t(55807),t(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,s,t)=>{"use strict";t.d(s,{A:()=>u});var r=t(55511);let i={randomUUID:r.randomUUID},o=new Uint8Array(256),a=o.length,n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let u=function(e,s,t){if(i.randomUUID&&!s&&!e)return i.randomUUID();let u=(e=e||{}).random??e.rng?.()??(a>o.length-16&&((0,r.randomFillSync)(o),a=0),o.slice(a,a+=16));if(u.length<16)throw Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,s){if((t=t||0)<0||t+16>s.length)throw RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)s[t+e]=u[e];return s}return function(e,s=0){return(n[e[s+0]]+n[e[s+1]]+n[e[s+2]]+n[e[s+3]]+"-"+n[e[s+4]]+n[e[s+5]]+"-"+n[e[s+6]]+n[e[s+7]]+"-"+n[e[s+8]]+n[e[s+9]]+"-"+n[e[s+10]]+n[e[s+11]]+n[e[s+12]]+n[e[s+13]]+n[e[s+14]]+n[e[s+15]]).toLowerCase()}(u)}},91161:(e,s,t)=>{"use strict";t.r(s),t.d(s,{patchFetch:()=>w,routeModule:()=>E,serverHooks:()=>S,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>b});var r={};t.r(r),t.d(r,{GET:()=>v,POST:()=>A});var i=t(19227),o=t(39044),a=t(11131),n=t(57642),u=t(34621),c=t(96330),p=t(43281),d=t(38738),l=t(44325),m=t(67200);let g=m.z.object({httpMethod:m.z.nativeEnum(c.HttpMethod),endpoint:m.z.string().startsWith("/","API端点路径必须以'/'开头 (Endpoint path must start with '/')"),rateLimit:m.z.number().int().positive().optional()}),I=m.z.object({menuId:m.z.string().cuid("无效的菜单ID格式 (Invalid Menu ID format: must be a CUID)")}),x=m.z.object({tableName:m.z.string().min(1,"表名不能为空 (Table name cannot be empty)"),columnName:m.z.string().optional(),conditions:m.z.string().optional()}),y=m.z.object({name:m.z.string().min(3,"权限名称至少需要3个字符 (Permission name must be at least 3 characters long)").max(100,"权限名称不能超过100个字符 (Permission name cannot exceed 100 characters long)").regex(/^[a-zA-Z0-9_:-]+$/,"权限名称格式无效，只能包含字母、数字、下划线、冒号和连字符 (Invalid permission name format. Allowed: letters, numbers, underscore, colon, hyphen)"),displayName:m.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(150,"显示名称不能超过150字符"),description:m.z.string().max(255,"描述信息不能超过255字符").optional(),type:m.z.nativeEnum(c.PermissionType),resource:m.z.string().min(1,"资源标识不能为空 (Resource identifier cannot be empty)").max(200,"资源标识不能超过200字符"),action:m.z.string().min(1,"操作不能为空 (Action cannot be empty)").max(50,"操作名称不能超过50字符"),isActive:m.z.boolean().optional().default(!0),apiDetails:g.optional(),menuDetails:I.optional(),dataDetails:x.optional()}).superRefine((e,s)=>{e.type!==c.PermissionType.API||e.apiDetails||s.addIssue({code:m.z.ZodIssueCode.custom,message:"API类型的权限必须提供apiDetails对象 (For API type permission, 'apiDetails' object must be provided)",path:["apiDetails"]}),e.type!==c.PermissionType.MENU||e.menuDetails||s.addIssue({code:m.z.ZodIssueCode.custom,message:"MENU类型的权限必须提供menuDetails对象 (For MENU type permission, 'menuDetails' object must be provided)",path:["menuDetails"]}),e.type!==c.PermissionType.DATA||e.dataDetails||s.addIssue({code:m.z.ZodIssueCode.custom,message:"DATA类型的权限必须提供dataDetails对象 (For DATA type permission, 'dataDetails' object must be provided)",path:["dataDetails"]})});async function h(e,s){let{searchParams:t}=new URL(e.url),r=parseInt(t.get("page")||"1",10),i=parseInt(t.get("pageSize")||"10",10);i=Math.min(Math.max(i,1),100);let o=t.get("name"),a=t.get("type"),p=t.get("resource"),d=t.get("action"),l={};o&&(l.name={contains:o}),a&&Object.values(c.PermissionType).includes(a)&&(l.type=a),p&&(l.resource={contains:p}),d&&(l.action={contains:d});try{let e=await u.prisma.permission.findMany({where:l,include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0},skip:(r-1)*i,take:i,orderBy:{createdAt:"desc"}}),s=await u.prisma.permission.count({where:l});return n.NextResponse.json({data:e,pagination:{page:r,pageSize:i,totalItems:s,totalPages:Math.ceil(s/i)}})}catch(e){return console.error("列出权限失败 (Failed to list permissions):",e),n.NextResponse.json({message:"获取权限列表时发生错误 (An error occurred while retrieving permissions list)"},{status:500})}}async function P(e,{authContext:s}){let t,r=s.user_id,i=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,o=e.headers.get("user-agent")||void 0;try{t=await e.json()}catch(e){return await l.PC.logAuditEvent({userId:r,action:"PERMISSION_CREATE_FAILURE_INVALID_JSON",success:!1,ipAddress:i,userAgent:o,errorMessage:"Invalid JSON request body for permission creation.",metadata:{error:e.message}}),n.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let a=y.safeParse(t);if(!a.success)return await l.PC.logAuditEvent({userId:r,action:"PERMISSION_CREATE_FAILURE_VALIDATION",success:!1,ipAddress:i,userAgent:o,errorMessage:"Permission creation payload validation failed.",metadata:{issues:a.error.format(),receivedBody:t}}),n.NextResponse.json({message:"创建权限的输入数据验证失败 (Permission creation input validation failed)",errors:a.error.format()},{status:400});let{name:p,displayName:d,description:m,type:g,resource:I,action:x,isActive:h,apiDetails:P,menuDetails:v,dataDetails:A}=a.data;try{let e=await u.prisma.permission.findUnique({where:{name:p}});if(e)return await l.PC.logAuditEvent({userId:r,action:"PERMISSION_CREATE_FAILURE_CONFLICT",resource:`Permission:${e.id}`,success:!1,ipAddress:i,userAgent:o,errorMessage:`Permission name "${p}" already exists.`,metadata:{name:p}}),n.NextResponse.json({message:`权限名称 "${p}" 已存在 (Permission name "${p}" already exists)`},{status:409});let s=await u.prisma.$transaction(async e=>{let s=await e.permission.create({data:{name:p,displayName:d,description:m,type:g,resource:I,action:x,isActive:h}});if(g===c.PermissionType.API&&P)await e.apiPermission.create({data:{permissionId:s.id,...P}});else if(g===c.PermissionType.MENU&&v){let t=await e.menu.count({where:{id:v.menuId}});if(0===t)throw Error(`关联的菜单ID "${v.menuId}" 无效或不存在 (The associated Menu ID "${v.menuId}" is invalid or does not exist)`);await e.menuPermission.create({data:{permissionId:s.id,menuId:v.menuId}})}else g===c.PermissionType.DATA&&A&&await e.dataPermission.create({data:{permissionId:s.id,...A}});return s}),t=await u.prisma.permission.findUnique({where:{id:s.id},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});return await l.PC.logAuditEvent({userId:r,action:"PERMISSION_CREATE_SUCCESS",resource:`Permission:${s.id}`,success:!0,ipAddress:i,userAgent:o,metadata:{permissionId:s.id,name:s.name,type:s.type,resource:s.resource,action:s.action,apiDetails:P,menuDetails:v,dataDetails:A}}),n.NextResponse.json(t,{status:201})}catch(r){console.error("创建权限失败 (Failed to create permission):",r);let e="An unexpected server error occurred during permission creation",s="PERMISSION_CREATE_FAILURE_DB_ERROR",t=500;return r instanceof c.Prisma.PrismaClientKnownRequestError&&"P2002"===r.code?(e=`Permission name "${p}" already exists due to a database constraint`,s="PERMISSION_CREATE_FAILURE_CONFLICT_DB",t=409):r.message.includes("菜单ID")&&(e=r.message,s="PERMISSION_CREATE_FAILURE_INVALID_MENU_ID",t=400),await l.PC.logAuditEvent({userId:performingAdmin?.id,action:s,success:!1,ipAddress:i,userAgent:o,errorMessage:e,metadata:{name:p,displayName:d,type:g,resource:I,action:x,apiDetailsAttempted:P,menuDetailsAttempted:v,dataDetailsAttempted:A,error:r.message,errorCode:r.code}}),n.NextResponse.json({message:e},{status:t})}}let v=(0,d.Uj)((0,p.ru)(h,{requiredPermissions:["permission:list"]})),A=(0,d.Uj)((0,p.ru)(P,{requiredPermissions:["permission:create"]})),E=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/permissions/route",pathname:"/api/v2/permissions",filename:"route",bundlePath:"app/api/v2/permissions/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/permissions/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:f,workUnitAsyncStorage:b,serverHooks:S}=E;function w(){return(0,a.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:b})}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[938,176,733,200,344,706,855,281],()=>t(91161));module.exports=r})();