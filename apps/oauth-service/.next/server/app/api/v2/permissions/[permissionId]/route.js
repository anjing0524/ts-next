"use strict";(()=>{var e={};e.id=996,e.ids=[996],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},23040:(e,t,i)=>{i.d(t,{i:()=>o});var s=i(88022),r=i(55937),n=i(46159),a=i(1047);function o(e){let t,i;if("string"!=typeof e)throw new a.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:o,length:d}=e.split(".");if(5===d)throw new a.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==d)throw new a.Dp("Invalid JWT");if(!o)throw new a.Dp("JWTs must contain a payload");try{t=(0,s.D)(o)}catch{throw new a.Dp("Failed to base64url decode the payload")}try{i=JSON.parse(r.D0.decode(t))}catch{throw new a.Dp("Failed to parse the decoded payload as JSON")}if(!(0,n.A)(i))throw new a.Dp("Invalid JWT Claims Set");return i}},24931:(e,t,i)=>{i.d(t,{CE:()=>s.CE,Fw:()=>s.Fw,gz:()=>s.gz,j1:()=>s.j1});var s=i(55807)},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31551:(e,t,i)=>{i.d(t,{B:()=>u});var s=i(23040),r=i(97151),n=i(27819),a=i(1047),o=i(34621),d=i(24931);class u{static async authenticateClient(e,t){let i=t.get("client_id"),s=t.get("client_secret"),r=t.get("client_assertion_type"),n=t.get("client_assertion"),a=e.headers.get("authorization");if(a&&a.toLowerCase().startsWith("basic "))try{let e=a.slice(6),[t,r]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&r&&(i=i||t,s=s||r)}catch{throw new d.gz("Invalid Basic authentication header format.",d.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===r&&n)return await this.authenticateWithJWT(n,e);if(i&&s)return await this.authenticateWithSecret(i,s);if(i&&!s){let e=await o.prisma.oAuthClient.findUnique({where:{clientId:i,isActive:!0}});if(!e)throw new d.gz("Client not found.",d.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new d.gz("客户端不是公开客户端，需要身份验证",d.Fw.InvalidClient,401);return e}throw new d.gz("Client authentication required but not provided or method not supported.",d.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let s=await o.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!s)throw new d.gz("Invalid client ID or client not active.",d.Fw.InvalidClient,401);if("PUBLIC"===s.clientType)throw new d.gz("公开客户端试图使用密钥进行身份验证",d.Fw.InvalidClient,400);if(!s.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new d.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(i.t.bind(i,5486,23));if(!await e.compare(t,s.clientSecret))throw new d.gz("客户端密钥无效",d.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new d.j1("客户端密钥验证期间发生错误")}return s}static async authenticateWithJWT(e,t){try{let i=s.i(e);if(!i.iss||!i.sub||i.iss!==i.sub)throw new d.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",d.Fw.InvalidClient,400);let a=i.iss,u=await o.prisma.oAuthClient.findUnique({where:{clientId:a,isActive:!0}});if(!u)throw new d.gz("Client specified in JWT assertion not found or not active.",d.Fw.InvalidClient,401);if(!u.jwksUri)throw new d.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let l=this.getTokenEndpointUrl(t),c=r.RD(new URL(u.jwksUri));return await n.V(e,c,{issuer:a,audience:l,algorithms:["RS256","ES256","PS256"]}),u}catch(i){console.error("Client JWT assertion validation failed:",i);let e="Client assertion validation failed.",t=d.Fw.InvalidClient;if(i instanceof a.n)e="Client assertion has expired.",t=d.Fw.InvalidGrant;else if(i instanceof a.ie)e=`Client assertion claim validation failed: ${i.claim} ${i.reason}.`;else if(i instanceof a.h2)e="Client assertion signature verification failed.";else if(i instanceof d.j1)throw i;throw new d.gz(e,t,400,void 0,{originalError:i.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),i=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),s=e.headers.get("x-forwarded-host")||t.host,r=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${i}://${s}${r}`}}},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51041:(e,t,i)=>{i.d(t,{P:()=>o,B:()=>s.B});var s=i(31551),r=i(55511),n=i(34621),a=i(84344);class o{static validateRedirectUri(e,t){return t.includes(e)}static validateResponseType(e,t=["code"]){return t.includes(e)}static generateState(){return r.randomBytes(32).toString("base64url")}static generateNonce(){return r.randomBytes(32).toString("base64url")}static generateAuthorizationCode(){return r.randomBytes(32).toString("hex")}static async logAuditEvent(e){try{let t="SYSTEM",i="system";if(e.userId)t="USER",i=e.userId;else if(e.clientId){t="CLIENT";let s=await n.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});i=s?s.clientId:e.clientId}let s=e.success;void 0===s&&(s=e.status?"SUCCESS"===e.status:!e.errorMessage),await n.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:i||"unknown",status:s?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:this.buildDetailsJson(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}}static buildDetailsJson(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let i=JSON.parse(e.details);t={...t,...i}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}static async getUserPermissions(e){try{let t=await a.S.getUserPermissions(e),i=new Set(t?.permissions||[]);return Array.from(i)}catch(e){return console.error("Error getting user permissions:",e),[]}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63385:(e,t,i)=>{i.r(t),i.d(t,{patchFetch:()=>N,routeModule:()=>A,serverHooks:()=>x,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>R});var s={};i.r(s),i.d(s,{DELETE:()=>S,GET:()=>P,PUT:()=>y});var r=i(19227),n=i(39044),a=i(11131),o=i(57642),d=i(93952),u=i(96330),l=i(96800),c=i(28064),p=i(51041),m=i(67200);let h=m.z.object({httpMethod:m.z.nativeEnum(u.HttpMethod).optional(),endpoint:m.z.string().startsWith("/","API端点路径必须以'/'开头 (Endpoint path must start with '/')").optional(),rateLimit:m.z.number().int().positive().optional().nullable()}),f=m.z.object({menuId:m.z.string().cuid("无效的菜单ID格式 (Invalid Menu ID format: must be a CUID)").optional()}),w=m.z.object({tableName:m.z.string().min(1,"表名不能为空 (Table name cannot be empty)").optional(),columnName:m.z.string().optional().nullable(),conditions:m.z.string().optional().nullable()}),g=m.z.object({displayName:m.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(150,"显示名称长度不能超过150字符").optional(),description:m.z.string().max(255,"描述信息长度不能超过255字符").optional().nullable(),resource:m.z.string().min(1,"资源标识不能为空 (Resource identifier cannot be empty)").max(200,"资源标识长度不能超过200字符").optional(),action:m.z.string().min(1,"操作不能为空 (Action cannot be empty)").max(50,"操作名称长度不能超过50字符").optional(),isActive:m.z.boolean().optional(),apiDetails:h.optional(),menuDetails:f.optional(),dataDetails:w.optional()});async function I(e,t){let{permissionId:i}=t.params,s=void 0,r=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,n=e.headers.get("user-agent")||void 0;try{let e=await d.z.permission.findUnique({where:{id:i},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});if(!e)return await p.P.logAuditEvent({userId:s?.id,action:"PERMISSION_READ_FAILURE_NOT_FOUND",resource:`Permission:${i}`,ipAddress:r,userAgent:n,success:!1,errorMessage:"Permission definition not found.",metadata:{permissionId:i}}),o.NextResponse.json({message:"权限定义未找到 (Permission definition not found)"},{status:404});return await p.P.logAuditEvent({userId:s?.id,action:"PERMISSION_READ_SUCCESS",resource:`Permission:${i}`,ipAddress:r,userAgent:n,success:!0,metadata:{permissionId:i,permissionName:e.name,permissionType:e.type}}),o.NextResponse.json(e)}catch(e){return console.error(`获取权限 ${i} 详情失败 (Failed to fetch permission details for ID ${i}):`,e),await p.P.logAuditEvent({userId:s?.id,action:"PERMISSION_READ_FAILURE_DB_ERROR",resource:`Permission:${i}`,ipAddress:r,userAgent:n,success:!1,errorMessage:`Failed to fetch permission details for ID ${i}.`,metadata:{permissionId:i,error:e.message}}),o.NextResponse.json({message:"获取权限定义详情时发生错误 (An error occurred while retrieving permission definition details)"},{status:500})}}async function v(e,t){let i,{permissionId:s}=t.params,r=void 0,n=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,a=e.headers.get("user-agent")||void 0;try{i=await e.json()}catch(e){return await p.P.logAuditEvent({userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_INVALID_JSON",resource:`Permission:${s}`,success:!1,ipAddress:n,userAgent:a,errorMessage:"Invalid JSON request body for permission update.",metadata:{error:e.message}}),o.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let l=g.safeParse(i);if(!l.success)return await p.P.logAuditEvent({userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_VALIDATION",resource:`Permission:${s}`,success:!1,ipAddress:n,userAgent:a,errorMessage:"Permission update payload validation failed.",metadata:{issues:l.error.format(),receivedBody:i}}),o.NextResponse.json({message:"更新权限的输入数据验证失败 (Permission update input validation failed)",errors:l.error.format()},{status:400});let c=l.data;if(0===Object.keys(c).length)return await p.P.logAuditEvent({userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_EMPTY_BODY",resource:`Permission:${s}`,success:!1,ipAddress:n,userAgent:a,errorMessage:"Request body empty for permission update."}),o.NextResponse.json({message:"请求体中至少需要一个待更新的字段 (At least one field to update is required in the request body)"},{status:400});try{let e=await d.z.permission.findUnique({where:{id:s}});if(!e)return await p.P.logAuditEvent({userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_NOT_FOUND",resource:`Permission:${s}`,success:!1,ipAddress:n,userAgent:a,errorMessage:"Permission definition not found to update."}),o.NextResponse.json({message:"权限定义未找到，无法更新 (Permission definition not found, cannot update)"},{status:404});if(c.name||c.type)return await p.P.logAuditEvent({userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_IMMUTABLE_FIELDS",resource:`Permission:${s}`,success:!1,ipAddress:n,userAgent:a,errorMessage:"Attempted to modify immutable fields (name or type) of a permission.",metadata:{attemptedName:c.name,attemptedType:c.type,currentName:e.name,currentType:e.type}}),o.NextResponse.json({message:'权限的 "name" (名称) 和 "type" (类型) 字段不可修改 (The "name" and "type" fields of a permission cannot be changed)'},{status:400});let t=await d.z.$transaction(async t=>{let i={};void 0!==c.displayName&&(i.displayName=c.displayName),void 0!==c.description&&(i.description=c.description),void 0!==c.resource&&(i.resource=c.resource),void 0!==c.action&&(i.action=c.action),void 0!==c.isActive&&(i.isActive=c.isActive);let r=e;if(Object.keys(i).length>0&&(r=await t.permission.update({where:{id:s},data:i})),e.type===u.PermissionType.API&&c.apiDetails)await t.apiPermission.update({where:{permissionId:s},data:c.apiDetails});else if(e.type===u.PermissionType.MENU&&c.menuDetails){if(c.menuDetails.menuId){let e=await t.menu.count({where:{id:c.menuDetails.menuId}});if(0===e)throw Error(`关联的菜单ID "${c.menuDetails.menuId}" 无效或不存在 (The associated Menu ID "${c.menuDetails.menuId}" is invalid or does not exist)`)}await t.menuPermission.update({where:{permissionId:s},data:c.menuDetails})}else e.type===u.PermissionType.DATA&&c.dataDetails&&await t.dataPermission.update({where:{permissionId:s},data:c.dataDetails});return r}),i=await d.z.permission.findUnique({where:{id:t.id},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});return await p.P.logAuditEvent({userId:r?.id,action:"PERMISSION_UPDATE_SUCCESS",resource:`Permission:${s}`,success:!0,ipAddress:n,userAgent:a,metadata:{permissionId:s,updatedFields:Object.keys(c),originalName:e.name}}),o.NextResponse.json(i)}catch(d){console.error(`更新权限 ${s} 失败 (Failed to update permission ID ${s}):`,d);let e="An error occurred while updating permission definition",t="PERMISSION_UPDATE_FAILURE_DB_ERROR",i=500;return d.message.includes("菜单ID")&&(e=d.message,t="PERMISSION_UPDATE_FAILURE_INVALID_MENU_ID",i=400),await p.P.logAuditEvent({userId:r?.id,action:t,success:!1,ipAddress:n,userAgent:a,errorMessage:e,metadata:{error:d.message,errorCode:d.code,attemptedUpdateData:c}}),o.NextResponse.json({message:e},{status:i})}}async function E(e,t){let{permissionId:i}=t.params,s=void 0,r=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,n=e.headers.get("user-agent")||void 0;try{let e=await d.z.permission.findUnique({where:{id:i}});if(!e)return await p.P.logAuditEvent({userId:s?.id,action:"PERMISSION_DELETE_FAILURE_NOT_FOUND",resource:`Permission:${i}`,success:!1,ipAddress:r,userAgent:n,errorMessage:"Permission definition not found to delete."}),o.NextResponse.json({message:"权限定义未找到，无法删除 (Permission definition not found, cannot delete)"},{status:404});let t=await d.z.rolePermission.count({where:{permissionId:i}});if(t>0)return await p.P.logAuditEvent({userId:s?.id,action:"PERMISSION_DELETE_FAILURE_IN_USE",resource:`Permission:${i}`,success:!1,ipAddress:r,userAgent:n,errorMessage:`Permission "${e.name}" is still in use by ${t} roles.`,metadata:{permissionName:e.name,rolesCount:t}}),o.NextResponse.json({message:`权限 "${e.name}" 仍被 ${t} 个角色使用，无法删除 (Permission "${e.name}" is still in use by ${t} roles and cannot be deleted)`},{status:409});return await d.z.$transaction(async t=>{e.type===u.PermissionType.API?await t.apiPermission.deleteMany({where:{permissionId:i}}):e.type===u.PermissionType.MENU?await t.menuPermission.deleteMany({where:{permissionId:i}}):e.type===u.PermissionType.DATA&&await t.dataPermission.deleteMany({where:{permissionId:i}}),await t.permission.delete({where:{id:i}})}),await p.P.logAuditEvent({userId:s?.id,action:"PERMISSION_DELETE_SUCCESS",resource:`Permission:${i}`,success:!0,ipAddress:r,userAgent:n,metadata:{deletedPermissionId:i,permissionName:e.name}}),new o.NextResponse(null,{status:204})}catch(d){console.error(`删除权限 ${i} 失败 (Failed to delete permission ID ${i}):`,d);let e="An error occurred while deleting permission definition",t="PERMISSION_DELETE_FAILURE_DB_ERROR",a=500;return d instanceof u.Prisma.PrismaClientKnownRequestError&&"P2003"===d.code&&(e="Cannot delete permission as it might still be referenced by other system records",t="PERMISSION_DELETE_FAILURE_FOREIGN_KEY",a=409),await p.P.logAuditEvent({userId:s?.id,action:t,success:!1,ipAddress:r,userAgent:n,errorMessage:e,metadata:{error:d.message,permissionId:i}}),o.NextResponse.json({message:e},{status:a})}}let P=(0,c.Uj)((0,l.ru)(async(e,t)=>{let i=new URL(e.url).pathname.split("/");return I(e,{params:{permissionId:i[i.length-1]||""}})},{requiredPermissions:["permissions:read"]})),y=(0,c.Uj)((0,l.ru)(async(e,t)=>{let i=new URL(e.url).pathname.split("/");return v(e,{params:{permissionId:i[i.length-1]||""}})},{requiredPermissions:["permissions:update"]})),S=(0,c.Uj)((0,l.ru)(async(e,t)=>{let i=new URL(e.url).pathname.split("/");return E(e,{params:{permissionId:i[i.length-1]||""}})},{requiredPermissions:["permissions:delete"]})),A=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/permissions/[permissionId]/route",pathname:"/api/v2/permissions/[permissionId]",filename:"route",bundlePath:"app/api/v2/permissions/[permissionId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/permissions/[permissionId]/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:_,workUnitAsyncStorage:R,serverHooks:x}=A;function N(){return(0,a.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:R})}},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},93952:(e,t,i)=>{i.d(t,{z:()=>s.prisma});var s=i(34621)},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")},96800:(e,t,i)=>{i.d(t,{NC:()=>d,ru:()=>u});var s=i(57642),r=i(97151),n=i(27819),a=i(1047),o=i(24958);async function d(e,t={}){let i,u=e.headers.get("authorization");if(!u||!u.startsWith("Bearer "))return t.allowPublicAccess?{success:!0}:{success:!1,response:s.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let l=u.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let t=r.RD(new URL(e)),s=process.env.JWT_ISSUER,a=process.env.JWT_AUDIENCE;if(!s||!a)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");i=(await n.V(l,t,{issuer:s,audience:a,algorithms:["RS256"]})).payload}catch(t){console.error("JWT 验证失败 (JWT validation failed):",t);let e="Token validation failed";return t instanceof a.n?e=`Token expired at ${new Date(1e3*t.payload.exp).toISOString()}`:t instanceof a.ie?e=`Token claim validation failed: ${t.claim} ${t.reason}`:t instanceof a.T0||t instanceof a._L?e="Invalid token algorithm or key issue.":t instanceof Error&&(t.message.includes("JWKS")||t.message.includes("configured"))&&(e=`Token validation setup error: ${t.message}`),{success:!1,response:s.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let c=i.sub,p=i.client_id,m=i.scope?.split(" ")||[],h=i.permissions||[];if(t.requiredScopes&&t.requiredScopes.length>0&&!t.requiredScopes.every(e=>m.includes(e)))return{success:!1,response:s.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${t.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${t.requiredScopes.join(" ")}"`}})};if(t.requiredPermissions&&t.requiredPermissions.length>0&&!t.requiredPermissions.every(e=>h.includes(e)))return{success:!1,response:s.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${t.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let f={user_id:c,client_id:p,scopes:m,permissions:h,tokenPayload:i};if(t.requireUserContext&&c)try{let e=await o.z.user.findUnique({where:{id:c,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(f.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("获取用户信息失败 (Failed to fetch user information):",e)}return{success:!0,context:f}}function u(e,t={}){return async function(i){let r=await d(i,t);return r.success?r.context?e(i,r.context):s.NextResponse.json({error:"authentication_failed",error_description:"Authentication context missing"},{status:500}):r.response||s.NextResponse.json({error:"authentication_failed",error_description:"Authentication failed"},{status:401})}}new(i(28064)).n1(o.z)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[938,176,344,196,578,987,466,855,119,64],()=>i(63385));module.exports=s})();