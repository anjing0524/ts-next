"use strict";(()=>{var e={};e.id=996,e.ids=[996],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1630:e=>{e.exports=require("http")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},2412:e=>{e.exports=require("assert")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3385:(e,s,t)=>{t.r(s),t.d(s,{patchFetch:()=>_,routeModule:()=>U,serverHooks:()=>O,workAsyncStorage:()=>T,workUnitAsyncStorage:()=>f});var i={};t.r(i),t.d(i,{DELETE:()=>S,GET:()=>A,PUT:()=>g});var r=t(9227),o=t(9044),a=t(1131),n=t(7642),d=t(8891),u=t(6330),p=t(9565),m=t(9776),c=t(7200);let l=c.z.object({httpMethod:c.z.nativeEnum(u.HttpMethod).optional(),endpoint:c.z.string().startsWith("/","API端点路径必须以'/'开头 (Endpoint path must start with '/')").optional(),rateLimit:c.z.number().int().positive().optional().nullable()}),I=c.z.object({menuId:c.z.string().cuid("无效的菜单ID格式 (Invalid Menu ID format: must be a CUID)").optional()}),E=c.z.object({tableName:c.z.string().min(1,"表名不能为空 (Table name cannot be empty)").optional(),columnName:c.z.string().optional().nullable(),conditions:c.z.string().optional().nullable()}),y=c.z.object({displayName:c.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(150,"显示名称长度不能超过150字符").optional(),description:c.z.string().max(255,"描述信息长度不能超过255字符").optional().nullable(),resource:c.z.string().min(1,"资源标识不能为空 (Resource identifier cannot be empty)").max(200,"资源标识长度不能超过200字符").optional(),action:c.z.string().min(1,"操作不能为空 (Action cannot be empty)").max(50,"操作名称长度不能超过50字符").optional(),isActive:c.z.boolean().optional(),apiDetails:l.optional(),menuDetails:I.optional(),dataDetails:E.optional()});async function N(e,s){let{permissionId:t}=s.params,i=e.user,r=e.ip||e.headers?.get("x-forwarded-for"),o=e.headers?.get("user-agent");try{let e=await d.A.permission.findUnique({where:{id:t},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});if(!e)return await m.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"PERMISSION_READ_FAILURE_NOT_FOUND",status:"FAILURE",resourceType:"Permission",resourceId:t,ipAddress:r,userAgent:o,errorMessage:"Permission definition not found."}),n.NextResponse.json({message:"权限定义未找到 (Permission definition not found)"},{status:404});return await m.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"PERMISSION_READ_SUCCESS",status:"SUCCESS",resourceType:"Permission",resourceId:t,ipAddress:r,userAgent:o,details:JSON.stringify({permissionName:e.name,permissionType:e.type})}),n.NextResponse.json(e)}catch(e){return console.error(`获取权限 ${t} 详情失败 (Failed to fetch permission details for ID ${t}):`,e),await m.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"PERMISSION_READ_FAILURE_DB_ERROR",status:"FAILURE",resourceType:"Permission",resourceId:t,ipAddress:r,userAgent:o,errorMessage:`Failed to fetch permission details for ID ${t}.`,details:JSON.stringify({error:e.message})}),n.NextResponse.json({message:"获取权限定义详情时发生错误 (An error occurred while retrieving permission definition details)"},{status:500})}}async function R(e,s){let t,{permissionId:i}=s.params,r=e.user,o=e.ip||e.headers?.get("x-forwarded-for"),a=e.headers?.get("user-agent");try{t=await e.json()}catch(e){return await m.PC.logAuditEvent({actorType:r?.id?"USER":"UNKNOWN_ACTOR",actorId:r?.id||"anonymous",userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_INVALID_JSON",status:"FAILURE",resourceType:"Permission",resourceId:i,ipAddress:o,userAgent:a,errorMessage:"Invalid JSON request body for permission update.",details:JSON.stringify({error:e.message})}),n.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let p=y.safeParse(t);if(!p.success)return await m.PC.logAuditEvent({actorType:r?.id?"USER":"UNKNOWN_ACTOR",actorId:r?.id||"anonymous",userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_VALIDATION",status:"FAILURE",resourceType:"Permission",resourceId:i,ipAddress:o,userAgent:a,errorMessage:"Permission update payload validation failed.",details:JSON.stringify({issues:p.error.format(),receivedBody:t})}),n.NextResponse.json({message:"更新权限的输入数据验证失败 (Permission update input validation failed)",errors:p.error.format()},{status:400});let c=p.data;if(0===Object.keys(c).length)return await m.PC.logAuditEvent({actorType:r?.id?"USER":"UNKNOWN_ACTOR",actorId:r?.id||"anonymous",userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_EMPTY_BODY",status:"FAILURE",resourceType:"Permission",resourceId:i,ipAddress:o,userAgent:a,errorMessage:"Request body empty for permission update."}),n.NextResponse.json({message:"请求体中至少需要一个待更新的字段 (At least one field to update is required in the request body)"},{status:400});try{let e=await d.A.permission.findUnique({where:{id:i}});if(!e)return await m.PC.logAuditEvent({actorType:r?.id?"USER":"UNKNOWN_ACTOR",actorId:r?.id||"anonymous",userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_NOT_FOUND",status:"FAILURE",resourceType:"Permission",resourceId:i,ipAddress:o,userAgent:a,errorMessage:"Permission definition not found to update."}),n.NextResponse.json({message:"权限定义未找到，无法更新 (Permission definition not found, cannot update)"},{status:404});if(c.name||c.type)return await m.PC.logAuditEvent({actorType:r?.id?"USER":"UNKNOWN_ACTOR",actorId:r?.id||"anonymous",userId:r?.id,action:"PERMISSION_UPDATE_FAILURE_IMMUTABLE_FIELDS",status:"FAILURE",resourceType:"Permission",resourceId:i,ipAddress:o,userAgent:a,errorMessage:"Attempted to modify immutable fields (name or type) of a permission.",details:JSON.stringify({attemptedName:c.name,attemptedType:c.type,currentName:e.name,currentType:e.type})}),n.NextResponse.json({message:'权限的 "name" (名称) 和 "type" (类型) 字段不可修改 (The "name" and "type" fields of a permission cannot be changed)'},{status:400});let s=await d.A.$transaction(async s=>{let t={};void 0!==c.displayName&&(t.displayName=c.displayName),void 0!==c.description&&(t.description=c.description),void 0!==c.resource&&(t.resource=c.resource),void 0!==c.action&&(t.action=c.action),void 0!==c.isActive&&(t.isActive=c.isActive);let r=e;if(Object.keys(t).length>0&&(r=await s.permission.update({where:{id:i},data:t})),e.type===u.PermissionType.API&&c.apiDetails)await s.apiPermission.update({where:{permissionId:i},data:c.apiDetails});else if(e.type===u.PermissionType.MENU&&c.menuDetails){if(c.menuDetails.menuId){let e=await s.menu.count({where:{id:c.menuDetails.menuId}});if(0===e)throw Error(`关联的菜单ID "${c.menuDetails.menuId}" 无效或不存在 (The associated Menu ID "${c.menuDetails.menuId}" is invalid or does not exist)`)}await s.menuPermission.update({where:{permissionId:i},data:c.menuDetails})}else e.type===u.PermissionType.DATA&&c.dataDetails&&await s.dataPermission.update({where:{permissionId:i},data:c.dataDetails});return r}),t=await d.A.permission.findUnique({where:{id:s.id},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});return await m.PC.logAuditEvent({actorType:r?.id?"USER":"UNKNOWN_ACTOR",actorId:r?.id||"anonymous",userId:r?.id,action:"PERMISSION_UPDATE_SUCCESS",status:"SUCCESS",resourceType:"Permission",resourceId:i,ipAddress:o,userAgent:a,details:JSON.stringify({permissionId:i,updatedFields:Object.keys(c),originalName:e.name})}),n.NextResponse.json(t)}catch(d){console.error(`更新权限 ${i} 失败 (Failed to update permission ID ${i}):`,d);let e="An error occurred while updating permission definition",s="PERMISSION_UPDATE_FAILURE_DB_ERROR",t=500;return d.message.includes("菜单ID")&&(e=d.message,s="PERMISSION_UPDATE_FAILURE_INVALID_MENU_ID",t=400),await m.PC.logAuditEvent({actorType:r?.id?"USER":"UNKNOWN_ACTOR",actorId:r?.id||"anonymous",userId:r?.id,action:s,status:"FAILURE",resourceType:"Permission",resourceId:i,ipAddress:o,userAgent:a,errorMessage:e,details:JSON.stringify({error:d.message,errorCode:d.code,attemptedUpdateData:c})}),n.NextResponse.json({message:e},{status:t})}}async function P(e,s){let{permissionId:t}=s.params,i=e.user,r=e.ip||e.headers?.get("x-forwarded-for"),o=e.headers?.get("user-agent");try{let e=await d.A.permission.findUnique({where:{id:t}});if(!e)return await m.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"PERMISSION_DELETE_FAILURE_NOT_FOUND",status:"FAILURE",resourceType:"Permission",resourceId:t,ipAddress:r,userAgent:o,errorMessage:"Permission definition not found to delete."}),n.NextResponse.json({message:"权限定义未找到，无法删除 (Permission definition not found, cannot delete)"},{status:404});let s=await d.A.rolePermission.count({where:{permissionId:t}});if(s>0)return await m.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"PERMISSION_DELETE_FAILURE_IN_USE",status:"FAILURE",resourceType:"Permission",resourceId:t,ipAddress:r,userAgent:o,errorMessage:`Permission "${e.name}" is still in use by ${s} roles.`,details:JSON.stringify({permissionName:e.name,rolesCount:s})}),n.NextResponse.json({message:`权限 "${e.name}" 仍被 ${s} 个角色使用，无法删除 (Permission "${e.name}" is still in use by ${s} roles and cannot be deleted)`},{status:409});return await d.A.$transaction(async s=>{e.type===u.PermissionType.API?await s.apiPermission.deleteMany({where:{permissionId:t}}):e.type===u.PermissionType.MENU?await s.menuPermission.deleteMany({where:{permissionId:t}}):e.type===u.PermissionType.DATA&&await s.dataPermission.deleteMany({where:{permissionId:t}}),await s.permission.delete({where:{id:t}})}),await m.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"PERMISSION_DELETE_SUCCESS",status:"SUCCESS",resourceType:"Permission",resourceId:t,ipAddress:r,userAgent:o,details:JSON.stringify({deletedPermissionId:t,permissionName:e.name})}),new n.NextResponse(null,{status:204})}catch(d){console.error(`删除权限 ${t} 失败 (Failed to delete permission ID ${t}):`,d);let e="An error occurred while deleting permission definition",s="PERMISSION_DELETE_FAILURE_DB_ERROR",a=500;return d instanceof u.Prisma.PrismaClientKnownRequestError&&"P2003"===d.code&&(e="Cannot delete permission as it might still be referenced by other system records",s="PERMISSION_DELETE_FAILURE_FOREIGN_KEY",a=409),await m.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:s,status:"FAILURE",resourceType:"Permission",resourceId:t,ipAddress:r,userAgent:o,errorMessage:e,details:JSON.stringify({error:d.message,permissionNameAttemptedDelete:permission?.name||"N/A"})}),n.NextResponse.json({message:e},{status:a})}}let A=(0,p.PS)("permissions:read")(N),g=(0,p.PS)("permissions:update")(R),S=(0,p.PS)("permissions:delete")(P),U=new r.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/permissions/[permissionId]/route",pathname:"/api/v2/permissions/[permissionId]",filename:"route",bundlePath:"app/api/v2/permissions/[permissionId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/permissions/[permissionId]/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:T,workUnitAsyncStorage:f,serverHooks:O}=U;function _(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:f})}},3873:e=>{e.exports=require("path")},3997:e=>{e.exports=require("tty")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4985:e=>{e.exports=require("dns")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},5591:e=>{e.exports=require("https")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var s=require("../../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),i=s.X(0,[938,344,176,578,434,200,470,776,565],()=>t(3385));module.exports=i})();