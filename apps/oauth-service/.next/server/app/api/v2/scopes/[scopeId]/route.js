"use strict";(()=>{var e={};e.id=792,e.ids=[792],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},84252:(e,s,r)=>{r.r(s),r.d(s,{patchFetch:()=>w,routeModule:()=>R,serverHooks:()=>N,workAsyncStorage:()=>S,workUnitAsyncStorage:()=>j});var t={};r.r(t),r.d(t,{DELETE:()=>v,GET:()=>f,PATCH:()=>q});var o=r(19227),n=r(39044),i=r(11131),a=r(57642),u=r(67200),c=r(93952),p=r(96800),d=r(28064),l=r(96330);let m=u.z.object({description:u.z.string().max(500,"描述长度不超过500字符").optional().nullable(),isPublic:u.z.boolean().optional(),isActive:u.z.boolean().optional()});async function x(e,s){let{scopeId:r}=s.params;if(!u.z.string().cuid().safeParse(r).success)return a.NextResponse.json({message:"无效的Scope ID格式 (Invalid Scope ID format)"},{status:400});try{let e=await c.z.scope.findUnique({where:{id:r}});if(!e)return a.NextResponse.json({message:"权限范围未找到 (Scope not found)"},{status:404});return a.NextResponse.json(e)}catch(e){return console.error(`获取Scope ${r} 失败:`,e),a.NextResponse.json({message:"获取Scope详情失败 (Error fetching scope details)"},{status:500})}}let f=(0,d.Uj)((0,p.ru)(async(e,s)=>{let r=new URL(e.url).pathname.split("/");return x(e,{params:{scopeId:r[r.length-1]||""},authContext:s})},{requiredPermissions:["scopes:read"]}));async function h(e,s){let r,{scopeId:t}=s.params;if(!u.z.string().cuid().safeParse(t).success)return a.NextResponse.json({message:"无效的Scope ID格式"},{status:400});try{r=await e.json()}catch(e){return a.NextResponse.json({error:"Invalid request body",message:"Failed to parse JSON body."},{status:400})}let o=m.safeParse(r);if(!o.success)return a.NextResponse.json({error:"Validation failed",issues:o.error.issues},{status:400});let n=o.data;if(0===Object.keys(n).length)return a.NextResponse.json({message:"No fields provided for update."},{status:400});if(n.name)return a.NextResponse.json({message:"Scope name cannot be changed."},{status:400});try{let e=await c.z.scope.update({where:{id:t},data:n});return a.NextResponse.json(e)}catch(e){if(console.error(`更新Scope ${t} 失败:`,e),e instanceof l.Prisma.PrismaClientKnownRequestError&&"P2025"===e.code)return a.NextResponse.json({message:"权限范围未找到，无法更新 (Scope not found, cannot update)"},{status:404});return a.NextResponse.json({message:"更新Scope失败 (Error updating scope)"},{status:500})}}let q=(0,d.Uj)((0,p.ru)(async(e,s)=>{let r=new URL(e.url).pathname.split("/");return h(e,{params:{scopeId:r[r.length-1]||""}})},{requiredPermissions:["scopes:update"]}));async function g(e,s){let{scopeId:r}=s.params;if(!u.z.string().cuid().safeParse(r).success)return a.NextResponse.json({message:"无效的Scope ID格式"},{status:400});try{let e=await c.z.scope.findUnique({where:{id:r}});if(!e)return a.NextResponse.json({message:"权限范围未找到，无法删除 (Scope not found, cannot delete)"},{status:404});let s=await c.z.oAuthClient.count({where:{allowedScopes:{contains:`"${e.name}"`}}});if(s>0)return a.NextResponse.json({message:`Scope "${e.name}" is still in use by ${s} client(s) and cannot be deleted.`},{status:409});return await c.z.scope.delete({where:{id:r}}),new a.NextResponse(null,{status:204})}catch(e){if(console.error(`删除Scope ${r} 失败:`,e),e instanceof l.Prisma.PrismaClientKnownRequestError&&"P2025"===e.code)return a.NextResponse.json({message:"权限范围未找到，无法删除 (Scope not found, P2025)"},{status:404});return a.NextResponse.json({message:"删除Scope失败 (Error deleting scope)"},{status:500})}}let v=(0,d.Uj)((0,p.ru)(async(e,s)=>{let r=new URL(e.url).pathname.split("/");return g(e,{params:{scopeId:r[r.length-1]||""}})},{requiredPermissions:["scopes:delete"]})),R=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/scopes/[scopeId]/route",pathname:"/api/v2/scopes/[scopeId]",filename:"route",bundlePath:"app/api/v2/scopes/[scopeId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/scopes/[scopeId]/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:S,workUnitAsyncStorage:j,serverHooks:N}=R;function w(){return(0,i.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:j})}},91645:e=>{e.exports=require("net")},93952:(e,s,r)=>{r.d(s,{z:()=>t.prisma});var t=r(34621)},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")},96800:(e,s,r)=>{r.d(s,{NC:()=>u,ru:()=>c});var t=r(57642),o=r(97151),n=r(27819),i=r(1047),a=r(24958);async function u(e,s={}){let r,c=e.headers.get("authorization");if(!c||!c.startsWith("Bearer "))return s.allowPublicAccess?{success:!0}:{success:!1,response:t.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let p=c.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let s=o.RD(new URL(e)),t=process.env.JWT_ISSUER,i=process.env.JWT_AUDIENCE;if(!t||!i)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");r=(await n.V(p,s,{issuer:t,audience:i,algorithms:["RS256"]})).payload}catch(s){console.error("JWT 验证失败 (JWT validation failed):",s);let e="Token validation failed";return s instanceof i.n?e=`Token expired at ${new Date(1e3*s.payload.exp).toISOString()}`:s instanceof i.ie?e=`Token claim validation failed: ${s.claim} ${s.reason}`:s instanceof i.T0||s instanceof i._L?e="Invalid token algorithm or key issue.":s instanceof Error&&(s.message.includes("JWKS")||s.message.includes("configured"))&&(e=`Token validation setup error: ${s.message}`),{success:!1,response:t.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let d=r.sub,l=r.client_id,m=r.scope?.split(" ")||[],x=r.permissions||[];if(s.requiredScopes&&s.requiredScopes.length>0&&!s.requiredScopes.every(e=>m.includes(e)))return{success:!1,response:t.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${s.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${s.requiredScopes.join(" ")}"`}})};if(s.requiredPermissions&&s.requiredPermissions.length>0&&!s.requiredPermissions.every(e=>x.includes(e)))return{success:!1,response:t.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${s.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let f={user_id:d,client_id:l,scopes:m,permissions:x,tokenPayload:r};if(s.requireUserContext&&d)try{let e=await a.z.user.findUnique({where:{id:d,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(f.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("获取用户信息失败 (Failed to fetch user information):",e)}return{success:!0,context:f}}function c(e,s={}){return async function(r){let o=await u(r,s);return o.success?o.context?e(r,o.context):t.NextResponse.json({error:"authentication_failed",error_description:"Authentication context missing"},{status:500}):o.response||t.NextResponse.json({error:"authentication_failed",error_description:"Authentication failed"},{status:401})}}new(r(28064)).n1(a.z)}};var s=require("../../../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[938,176,344,196,578,987,466,855,119,64],()=>r(84252));module.exports=t})();