(()=>{var e={};e.id=792,e.ids=[792],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function s(e){var s=Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}s.keys=()=>[],s.resolve=s,s.id=4997,e.exports=s},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,s,t)=>{"use strict";t.d(s,{z:()=>o});var r=t(96330);let o=globalThis.prisma??new r.PrismaClient},26273:(e,s,t)=>{"use strict";t.r(s),t.d(s,{patchFetch:()=>P,routeModule:()=>y,serverHooks:()=>w,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>b});var r={};t.r(r),t.d(r,{DELETE:()=>S,GET:()=>h,PUT:()=>q});var o=t(19227),n=t(39044),i=t(11131),a=t(57642),u=t(67200),c=t(34621),p=t(43281),l=t(38738),d=t(96330);let x=u.z.object({description:u.z.string().max(500,"描述长度不超过500字符").optional().nullable(),isPublic:u.z.boolean().optional(),isActive:u.z.boolean().optional()});async function g(e,{params:s,authContext:t}){let{scopeId:r}=s;if(!u.z.string().cuid().safeParse(r).success)return a.NextResponse.json({message:"无效的Scope ID格式 (Invalid Scope ID format)"},{status:400});try{let e=await c.prisma.scope.findUnique({where:{id:r}});if(!e)return a.NextResponse.json({message:"权限范围未找到 (Scope not found)"},{status:404});return a.NextResponse.json(e)}catch(e){return console.error(`获取Scope ${r} 失败:`,e),a.NextResponse.json({message:"获取Scope详情失败 (Error fetching scope details)"},{status:500})}}async function m(e,{params:s,authContext:t}){let r,{scopeId:o}=s;if(!u.z.string().cuid().safeParse(o).success)return a.NextResponse.json({message:"无效的Scope ID格式"},{status:400});try{r=await e.json()}catch(e){return a.NextResponse.json({error:"Invalid request body",message:"Failed to parse JSON body."},{status:400})}let n=x.safeParse(r);if(!n.success)return a.NextResponse.json({error:"Validation failed",issues:n.error.issues},{status:400});let i=n.data;if(0===Object.keys(i).length)return a.NextResponse.json({message:"No fields provided for update."},{status:400});if(i.name)return a.NextResponse.json({message:"Scope name cannot be changed."},{status:400});try{let e=await c.prisma.scope.update({where:{id:o},data:i});return a.NextResponse.json(e)}catch(e){if(console.error(`更新Scope ${o} 失败:`,e),e instanceof d.Prisma.PrismaClientKnownRequestError&&"P2025"===e.code)return a.NextResponse.json({message:"权限范围未找到，无法更新 (Scope not found, cannot update)"},{status:404});return a.NextResponse.json({message:"更新Scope失败 (Error updating scope)"},{status:500})}}async function f(e,{params:s,authContext:t}){let{scopeId:r}=s;if(!u.z.string().cuid().safeParse(r).success)return a.NextResponse.json({message:"无效的Scope ID格式"},{status:400});try{let e=await c.prisma.scope.findUnique({where:{id:r}});if(!e)return a.NextResponse.json({message:"权限范围未找到，无法删除 (Scope not found, cannot delete)"},{status:404});let s=await c.prisma.oAuthClient.count({where:{allowedScopes:{contains:`"${e.name}"`}}});if(s>0)return a.NextResponse.json({message:`Scope "${e.name}" is still in use by ${s} client(s) and cannot be deleted.`},{status:409});return await c.prisma.scope.delete({where:{id:r}}),new a.NextResponse(null,{status:204})}catch(e){if(console.error(`删除Scope ${r} 失败:`,e),e instanceof d.Prisma.PrismaClientKnownRequestError&&"P2025"===e.code)return a.NextResponse.json({message:"权限范围未找到，无法删除 (Scope not found, P2025)"},{status:404});return a.NextResponse.json({message:"删除Scope失败 (Error deleting scope)"},{status:500})}}let h=(0,l.Uj)((0,p.ru)(g,{requiredPermissions:["scope:read"]})),q=(0,l.Uj)((0,p.ru)(m,{requiredPermissions:["scope:update"]})),S=(0,l.Uj)((0,p.ru)(f,{requiredPermissions:["scope:delete"]})),y=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/scopes/[scopeId]/route",pathname:"/api/v2/scopes/[scopeId]",filename:"route",bundlePath:"app/api/v2/scopes/[scopeId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/scopes/[scopeId]/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:v,workUnitAsyncStorage:b,serverHooks:w}=y;function P(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:b})}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,s,t)=>{"use strict";t.d(s,{prisma:()=>r.z}),t(96330);var r=t(24958),o=t(50488),n=t.n(o),i=t(5433);n().config();let a={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},u=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:a.host,port:a.port,user:a.user,database:a.database}),i.createPool(a));async function c(){if(u&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await u.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await c(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,s,t)=>{"use strict";t.d(s,{B9:()=>r.B9,Uj:()=>r.Uj}),t(44325),t(18354);var r=t(84327);t(43281),t(55807),t(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,s,t)=>{"use strict";t.d(s,{A:()=>u});var r=t(55511);let o={randomUUID:r.randomUUID},n=new Uint8Array(256),i=n.length,a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));let u=function(e,s,t){if(o.randomUUID&&!s&&!e)return o.randomUUID();let u=(e=e||{}).random??e.rng?.()??(i>n.length-16&&((0,r.randomFillSync)(n),i=0),n.slice(i,i+=16));if(u.length<16)throw Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,s){if((t=t||0)<0||t+16>s.length)throw RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)s[t+e]=u[e];return s}return function(e,s=0){return(a[e[s+0]]+a[e[s+1]]+a[e[s+2]]+a[e[s+3]]+"-"+a[e[s+4]]+a[e[s+5]]+"-"+a[e[s+6]]+a[e[s+7]]+"-"+a[e[s+8]]+a[e[s+9]]+"-"+a[e[s+10]]+a[e[s+11]]+a[e[s+12]]+a[e[s+13]]+a[e[s+14]]+a[e[s+15]]).toLowerCase()}(u)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var s=require("../../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[938,176,733,200,344,706,855,281],()=>t(26273));module.exports=r})();