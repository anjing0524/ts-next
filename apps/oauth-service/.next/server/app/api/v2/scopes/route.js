(()=>{var e={};e.id=174,e.ids=[174],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function s(e){var s=Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}s.keys=()=>[],s.resolve=s,s.id=4997,e.exports=s},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,s,r)=>{"use strict";r.d(s,{z:()=>o});var t=r(96330);let o=globalThis.prisma??new t.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,s,r)=>{"use strict";r.d(s,{prisma:()=>t.z}),r(96330);var t=r(24958),o=r(50488),i=r.n(o),a=r(5433);i().config();let n={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},c=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:n.host,port:n.port,user:n.user,database:n.database}),a.createPool(n));async function u(){if(c&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await c.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await u(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await u(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await u(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,s,r)=>{"use strict";r.d(s,{B9:()=>t.B9,Uj:()=>t.Uj}),r(44325),r(18354);var t=r(84327);r(43281),r(55807),r(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,s,r)=>{"use strict";r.d(s,{A:()=>c});var t=r(55511);let o={randomUUID:t.randomUUID},i=new Uint8Array(256),a=i.length,n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let c=function(e,s,r){if(o.randomUUID&&!s&&!e)return o.randomUUID();let c=(e=e||{}).random??e.rng?.()??(a>i.length-16&&((0,t.randomFillSync)(i),a=0),i.slice(a,a+=16));if(c.length<16)throw Error("Random bytes length must be >= 16");if(c[6]=15&c[6]|64,c[8]=63&c[8]|128,s){if((r=r||0)<0||r+16>s.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)s[r+e]=c[e];return s}return function(e,s=0){return(n[e[s+0]]+n[e[s+1]]+n[e[s+2]]+n[e[s+3]]+"-"+n[e[s+4]]+n[e[s+5]]+"-"+n[e[s+6]]+n[e[s+7]]+"-"+n[e[s+8]]+n[e[s+9]]+"-"+n[e[s+10]]+n[e[s+11]]+n[e[s+12]]+n[e[s+13]]+n[e[s+14]]+n[e[s+15]]).toLowerCase()}(c)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},97422:(e,s,r)=>{"use strict";r.r(s),r.d(s,{patchFetch:()=>w,routeModule:()=>q,serverHooks:()=>S,workAsyncStorage:()=>b,workUnitAsyncStorage:()=>v});var t={};r.r(t),r.d(t,{GET:()=>f,POST:()=>y});var o=r(19227),i=r(39044),a=r(11131),n=r(57642),c=r(67200),u=r(34621),l=r(43281),p=r(38738),d=r(96330);let m=c.z.object({name:c.z.string().min(3,"Scope name must be at least 3 characters long / 范围名称至少需要3个字符").max(100,"Scope name must be at most 100 characters long / 范围名称长度不超过100字符").regex(/^[a-zA-Z0-9_:-]+$/,"Scope name can only contain alphanumeric characters, underscores, colons, and hyphens / 范围名称只能包含字母数字、下划线、冒号和连字符"),description:c.z.string().max(500,"Description must be at most 500 characters long / 描述长度不超过500字符").optional().nullable(),isPublic:c.z.boolean().default(!1).optional(),isActive:c.z.boolean().default(!0).optional()}),x=c.z.object({page:c.z.coerce.number().int().min(1).default(1),limit:c.z.coerce.number().int().min(1).max(100).default(10),name:c.z.string().optional(),isActive:c.z.preprocess(e=>"true"===e||"false"!==e&&void 0,c.z.boolean().optional())});async function g(e,s){let{searchParams:r}=new URL(e.url),t={};r.forEach((e,s)=>{t[s]=e});let o=x.safeParse(t);if(!o.success)return n.NextResponse.json({error:"Validation failed",issues:o.error.issues},{status:400});let{page:i,limit:a,name:c,isActive:l}=o.data,p={};c&&(p.name={contains:c}),void 0!==l&&(p.isActive=l);try{let e=await u.prisma.scope.findMany({where:p,orderBy:{name:"asc"},skip:(i-1)*a,take:a}),s=await u.prisma.scope.count({where:p});return n.NextResponse.json({data:e,pagination:{page:i,pageSize:a,totalItems:s,totalPages:Math.ceil(s/a)}})}catch(e){return console.error("Failed to list scopes:",e),n.NextResponse.json({message:"Error listing scopes."},{status:500})}}async function h(e,s){let r;try{r=await e.json()}catch(e){return n.NextResponse.json({error:"Invalid request body",message:"Failed to parse JSON body."},{status:400})}let t=m.safeParse(r);if(!t.success)return n.NextResponse.json({error:"Validation failed",issues:t.error.issues},{status:400});let{name:o,description:i,isPublic:a,isActive:c}=t.data;try{if(await u.prisma.scope.findUnique({where:{name:o}}))return n.NextResponse.json({message:`Scope name "${o}" already exists.`},{status:409});let e=await u.prisma.scope.create({data:{name:o,description:i,isPublic:a,isActive:c}});return n.NextResponse.json(e,{status:201})}catch(e){if(console.error("Failed to create scope:",e),e instanceof d.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code)return n.NextResponse.json({message:`Scope name "${o}" already exists (race condition).`},{status:409});return n.NextResponse.json({message:"Error creating scope."},{status:500})}}let f=(0,p.Uj)((0,l.ru)(g,{requiredPermissions:["scope:list"]})),y=(0,p.Uj)((0,l.ru)(h,{requiredPermissions:["scope:create"]})),q=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/v2/scopes/route",pathname:"/api/v2/scopes",filename:"route",bundlePath:"app/api/v2/scopes/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/scopes/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:b,workUnitAsyncStorage:v,serverHooks:S}=q;function w(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:v})}}};var s=require("../../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[938,176,733,200,344,706,855,281],()=>r(97422));module.exports=t})();