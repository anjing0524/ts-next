"use strict";(()=>{var e={};e.id=174,e.ids=[174],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},93952:(e,r,s)=>{s.d(r,{z:()=>t.prisma});var t=s(34621)},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")},96800:(e,r,s)=>{s.d(r,{NC:()=>u,ru:()=>c});var t=s(57642),o=s(97151),i=s(27819),n=s(1047),a=s(24958);async function u(e,r={}){let s,c=e.headers.get("authorization");if(!c||!c.startsWith("Bearer "))return r.allowPublicAccess?{success:!0}:{success:!1,response:t.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let p=c.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let r=o.RD(new URL(e)),t=process.env.JWT_ISSUER,n=process.env.JWT_AUDIENCE;if(!t||!n)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");s=(await i.V(p,r,{issuer:t,audience:n,algorithms:["RS256"]})).payload}catch(r){console.error("JWT 验证失败 (JWT validation failed):",r);let e="Token validation failed";return r instanceof n.n?e=`Token expired at ${new Date(1e3*r.payload.exp).toISOString()}`:r instanceof n.ie?e=`Token claim validation failed: ${r.claim} ${r.reason}`:r instanceof n.T0||r instanceof n._L?e="Invalid token algorithm or key issue.":r instanceof Error&&(r.message.includes("JWKS")||r.message.includes("configured"))&&(e=`Token validation setup error: ${r.message}`),{success:!1,response:t.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let l=s.sub,d=s.client_id,m=s.scope?.split(" ")||[],x=s.permissions||[];if(r.requiredScopes&&r.requiredScopes.length>0&&!r.requiredScopes.every(e=>m.includes(e)))return{success:!1,response:t.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${r.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${r.requiredScopes.join(" ")}"`}})};if(r.requiredPermissions&&r.requiredPermissions.length>0&&!r.requiredPermissions.every(e=>x.includes(e)))return{success:!1,response:t.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${r.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let f={user_id:l,client_id:d,scopes:m,permissions:x,tokenPayload:s};if(r.requireUserContext&&l)try{let e=await a.z.user.findUnique({where:{id:l,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(f.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("获取用户信息失败 (Failed to fetch user information):",e)}return{success:!0,context:f}}function c(e,r={}){return async function(s){let o=await u(s,r);return o.success?o.context?e(s,o.context):t.NextResponse.json({error:"authentication_failed",error_description:"Authentication context missing"},{status:500}):o.response||t.NextResponse.json({error:"authentication_failed",error_description:"Authentication failed"},{status:401})}}new(s(28064)).n1(a.z)},97422:(e,r,s)=>{s.r(r),s.d(r,{patchFetch:()=>S,routeModule:()=>g,serverHooks:()=>j,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>y});var t={};s.r(t),s.d(t,{GET:()=>h,POST:()=>q});var o=s(19227),i=s(39044),n=s(11131),a=s(57642),u=s(67200),c=s(93952),p=s(96800),l=s(28064),d=s(96330);let m=u.z.object({name:u.z.string().min(3,"Scope name must be at least 3 characters long / 范围名称至少需要3个字符").max(100,"Scope name must be at most 100 characters long / 范围名称长度不超过100字符").regex(/^[a-zA-Z0-9_:-]+$/,"Scope name can only contain alphanumeric characters, underscores, colons, and hyphens / 范围名称只能包含字母数字、下划线、冒号和连字符"),description:u.z.string().max(500,"Description must be at most 500 characters long / 描述长度不超过500字符").optional().nullable(),isPublic:u.z.boolean().default(!1).optional(),isActive:u.z.boolean().default(!0).optional()}),x=u.z.object({page:u.z.coerce.number().int().min(1).default(1),limit:u.z.coerce.number().int().min(1).max(100).default(10),name:u.z.string().optional(),isActive:u.z.preprocess(e=>"true"===e||"false"!==e&&void 0,u.z.boolean().optional())});async function f(e,r){let{searchParams:s}=new URL(e.url),t={};s.forEach((e,r)=>{t[r]=e});let o=x.safeParse(t);if(!o.success)return a.NextResponse.json({error:"Validation failed",issues:o.error.issues},{status:400});let{page:i,limit:n,name:u,isActive:p}=o.data,l={};u&&(l.name={contains:u}),void 0!==p&&(l.isActive=p);try{let e=await c.z.scope.findMany({where:l,orderBy:{name:"asc"},skip:(i-1)*n,take:n}),r=await c.z.scope.count({where:l});return a.NextResponse.json({data:e,pagination:{page:i,pageSize:n,totalItems:r,totalPages:Math.ceil(r/n)}})}catch(e){return console.error("Failed to list scopes:",e),a.NextResponse.json({message:"Error listing scopes."},{status:500})}}let h=(0,l.Uj)((0,p.ru)(f,{requiredPermissions:["scopes:list"]}));async function v(e,r){let s;try{s=await e.json()}catch(e){return a.NextResponse.json({error:"Invalid request body",message:"Failed to parse JSON body."},{status:400})}let t=m.safeParse(s);if(!t.success)return a.NextResponse.json({error:"Validation failed",issues:t.error.issues},{status:400});let{name:o,description:i,isPublic:n,isActive:u}=t.data;try{if(await c.z.scope.findUnique({where:{name:o}}))return a.NextResponse.json({message:`Scope name "${o}" already exists.`},{status:409});let e=await c.z.scope.create({data:{name:o,description:i,isPublic:n,isActive:u}});return a.NextResponse.json(e,{status:201})}catch(e){if(console.error("Failed to create scope:",e),e instanceof d.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code)return a.NextResponse.json({message:`Scope name "${o}" already exists (race condition).`},{status:409});return a.NextResponse.json({message:"Error creating scope."},{status:500})}}let q=(0,l.Uj)((0,p.ru)(v,{requiredPermissions:["scopes:create"]})),g=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/v2/scopes/route",pathname:"/api/v2/scopes",filename:"route",bundlePath:"app/api/v2/scopes/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/scopes/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:R,workUnitAsyncStorage:y,serverHooks:j}=g;function S(){return(0,n.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:y})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[938,176,344,196,578,987,466,855,119,64],()=>s(97422));module.exports=t})();