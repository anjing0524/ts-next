"use strict";(()=>{var e={};e.id=964,e.ids=[964],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},23040:(e,r,t)=>{t.d(r,{i:()=>a});var s=t(88022),i=t(55937),n=t(46159),o=t(1047);function a(e){let r,t;if("string"!=typeof e)throw new o.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:a,length:l}=e.split(".");if(5===l)throw new o.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==l)throw new o.Dp("Invalid JWT");if(!a)throw new o.Dp("JWTs must contain a payload");try{r=(0,s.D)(a)}catch{throw new o.Dp("Failed to base64url decode the payload")}try{t=JSON.parse(i.D0.decode(r))}catch{throw new o.Dp("Failed to parse the decoded payload as JSON")}if(!(0,n.A)(t))throw new o.Dp("Invalid JWT Claims Set");return t}},24931:(e,r,t)=>{t.d(r,{CE:()=>s.CE,Fw:()=>s.Fw,gz:()=>s.gz,j1:()=>s.j1});var s=t(55807)},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31551:(e,r,t)=>{t.d(r,{B:()=>d});var s=t(23040),i=t(97151),n=t(27819),o=t(1047),a=t(34621),l=t(24931);class d{static async authenticateClient(e,r){let t=r.get("client_id"),s=r.get("client_secret"),i=r.get("client_assertion_type"),n=r.get("client_assertion"),o=e.headers.get("authorization");if(o&&o.toLowerCase().startsWith("basic "))try{let e=o.slice(6),[r,i]=Buffer.from(e,"base64").toString("utf-8").split(":");r&&i&&(t=t||r,s=s||i)}catch{throw new l.gz("Invalid Basic authentication header format.",l.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===i&&n)return await this.authenticateWithJWT(n,e);if(t&&s)return await this.authenticateWithSecret(t,s);if(t&&!s){let e=await a.prisma.oAuthClient.findUnique({where:{clientId:t,isActive:!0}});if(!e)throw new l.gz("Client not found.",l.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new l.gz("客户端不是公开客户端，需要身份验证",l.Fw.InvalidClient,401);return e}throw new l.gz("Client authentication required but not provided or method not supported.",l.Fw.InvalidClient,401)}static async authenticateWithSecret(e,r){let s=await a.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!s)throw new l.gz("Invalid client ID or client not active.",l.Fw.InvalidClient,401);if("PUBLIC"===s.clientType)throw new l.gz("公开客户端试图使用密钥进行身份验证",l.Fw.InvalidClient,400);if(!s.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new l.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(t.t.bind(t,5486,23));if(!await e.compare(r,s.clientSecret))throw new l.gz("客户端密钥无效",l.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new l.j1("客户端密钥验证期间发生错误")}return s}static async authenticateWithJWT(e,r){try{let t=s.i(e);if(!t.iss||!t.sub||t.iss!==t.sub)throw new l.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",l.Fw.InvalidClient,400);let o=t.iss,d=await a.prisma.oAuthClient.findUnique({where:{clientId:o,isActive:!0}});if(!d)throw new l.gz("Client specified in JWT assertion not found or not active.",l.Fw.InvalidClient,401);if(!d.jwksUri)throw new l.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let u=this.getTokenEndpointUrl(r),c=i.RD(new URL(d.jwksUri));return await n.V(e,c,{issuer:o,audience:u,algorithms:["RS256","ES256","PS256"]}),d}catch(t){console.error("Client JWT assertion validation failed:",t);let e="Client assertion validation failed.",r=l.Fw.InvalidClient;if(t instanceof o.n)e="Client assertion has expired.",r=l.Fw.InvalidGrant;else if(t instanceof o.ie)e=`Client assertion claim validation failed: ${t.claim} ${t.reason}.`;else if(t instanceof o.h2)e="Client assertion signature verification failed.";else if(t instanceof l.j1)throw t;throw new l.gz(e,r,400,void 0,{originalError:t.message})}}static getTokenEndpointUrl(e){let r=new URL(e.url),t=e.headers.get("x-forwarded-proto")||r.protocol.slice(0,-1),s=e.headers.get("x-forwarded-host")||r.host,i=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${t}://${s}${i}`}}},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45463:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>v,serverHooks:()=>_,workAsyncStorage:()=>S,workUnitAsyncStorage:()=>R});var s={};t.r(s),t.d(s,{GET:()=>w,POST:()=>I});var i=t(19227),n=t(39044),o=t(11131),a=t(57642),l=t(93952),d=t(96330),u=t(96800),c=t(28064),p=t(51041),m=t(67200);let h=m.z.object({permissionIds:m.z.array(m.z.string().cuid("无效的权限ID格式 (Invalid permission ID format: must be a CUID)")).min(0,"权限ID列表可以为空，表示移除所有权限 (Permission IDs array can be empty to remove all permissions)")});async function g(e,r){let{roleId:t}=r.params,s=void 0,i=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,n=e.headers.get("user-agent")||void 0;try{let e=await l.z.role.findUnique({where:{id:t},include:{rolePermissions:{include:{permission:!0},orderBy:{permission:{name:"asc"}}}}});if(!e)return await p.P.logAuditEvent({userId:s?.id,action:"ROLE_PERMISSIONS_LIST_FAILURE_ROLE_NOT_FOUND",resource:`Role:${t}`,success:!1,ipAddress:i,userAgent:n,errorMessage:"Role not found when trying to list its permissions."}),a.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});let r=e.rolePermissions.map(e=>e.permission).filter(e=>null!==e&&!0===e.isActive);return await p.P.logAuditEvent({userId:s?.id,action:"ROLE_PERMISSIONS_LIST_SUCCESS",resource:`Role:${t}`,success:!0,ipAddress:i,userAgent:n,metadata:{roleName:e.name,listedPermissionsCount:r.length}}),a.NextResponse.json({permissions:r})}catch(e){return console.error(`列出角色 ${t} 的权限失败 (Failed to list permissions for role ${t}):`,e),await p.P.logAuditEvent({userId:s?.id,action:"ROLE_PERMISSIONS_LIST_FAILURE_DB_ERROR",resource:`Role:${t}`,success:!1,ipAddress:i,userAgent:n,errorMessage:`Failed to list permissions for role ${t}.`,metadata:{error:e.message}}),a.NextResponse.json({message:"获取角色权限列表时发生错误 (An error occurred while retrieving role permissions)"},{status:500})}}async function f(e,r){let t,{roleId:s}=r.params,i=void 0,n=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,o=e.headers.get("user-agent")||void 0;try{t=await e.json()}catch(e){return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_INVALID_JSON",resource:`Role:${s}`,success:!1,ipAddress:n,userAgent:o,errorMessage:"Invalid JSON request body for assigning permissions.",metadata:{error:e.message}}),a.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let u=h.safeParse(t);if(!u.success)return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_VALIDATION",resource:`Role:${s}`,success:!1,ipAddress:n,userAgent:o,errorMessage:"Assigning permissions input validation failed.",metadata:{issues:u.error.format(),receivedBody:t}}),a.NextResponse.json({message:"分配权限的请求数据验证失败 (Assigning permissions input validation failed)",errors:u.error.format()},{status:400});let{permissionIds:c}=u.data;try{let e=await l.z.role.findUnique({where:{id:s}});if(!e)return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_ROLE_NOT_FOUND",resource:`Role:${s}`,success:!1,ipAddress:n,userAgent:o,errorMessage:"Role not found, cannot assign permissions."}),a.NextResponse.json({message:"角色未找到，无法分配权限 (Role not found, cannot assign permissions)"},{status:404});let r=await l.z.permission.findMany({where:{id:{in:c},isActive:!0}});if(r.length!==c.length){let t=r.map(e=>e.id),l=c.filter(e=>!t.includes(e));return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_INVALID_IDS",resource:`Role:${s}`,success:!1,ipAddress:n,userAgent:o,errorMessage:"Some permission IDs are invalid or inactive.",metadata:{roleName:e.name,requestedPIDs:c,invalidPIDs:l}}),a.NextResponse.json({message:`以下权限ID无效或当前未激活: ${l.join(", ")} (Following permission IDs are invalid or currently inactive: ${l.join(", ")})`},{status:400})}await l.z.$transaction(async e=>{if(await e.rolePermission.deleteMany({where:{roleId:s}}),c.length>0){let r=c.map(e=>({roleId:s,permissionId:e}));await e.rolePermission.createMany({data:r})}});let t=(await l.z.rolePermission.findMany({where:{roleId:s},include:{permission:!0}})).map(e=>e.permission).filter(e=>null!==e&&e.isActive);return a.NextResponse.json({message:"权限已成功分配给角色 (Permissions have been successfully assigned to the role)",assignedPermissions:t})}catch(l){console.error(`为角色 ${s} 分配权限失败 (Failed to assign permissions to role ${s}):`,l);let e="An unexpected server error occurred while assigning permissions",r="ROLE_PERMISSIONS_ASSIGN_FAILURE_DB_ERROR",t=500;return l instanceof d.Prisma.PrismaClientKnownRequestError&&"P2003"===l.code&&(e="Failed to assign permissions: one or more provided permission IDs are invalid (foreign key constraint).",r="ROLE_PERMISSIONS_ASSIGN_FAILURE_FK_CONSTRAINT",t=400),await p.P.logAuditEvent({userId:i?.id,action:r,success:!1,ipAddress:n,userAgent:o,errorMessage:e,metadata:{roleId:s,requestedPIDs:c,error:l.message,errorCode:l.code}}),a.NextResponse.json({message:e},{status:t})}}let w=(0,c.Uj)((0,u.ru)(async(e,r)=>{let t=new URL(e.url).pathname.split("/");return g(e,{params:{roleId:t[t.length-2]||""},authContext:r})},{requiredPermissions:["roles:permissions:read"]})),I=(0,c.Uj)((0,u.ru)(async(e,r)=>{let t=new URL(e.url).pathname.split("/");return f(e,{params:{roleId:t[t.length-2]||""},authContext:r})},{requiredPermissions:["roles:permissions:assign"]})),v=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/roles/[roleId]/permissions/route",pathname:"/api/v2/roles/[roleId]/permissions",filename:"route",bundlePath:"app/api/v2/roles/[roleId]/permissions/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/[roleId]/permissions/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:S,workUnitAsyncStorage:R,serverHooks:_}=v;function x(){return(0,o.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:R})}},51041:(e,r,t)=>{t.d(r,{P:()=>a,B:()=>s.B});var s=t(31551),i=t(55511),n=t(34621),o=t(84344);class a{static validateRedirectUri(e,r){return r.includes(e)}static validateResponseType(e,r=["code"]){return r.includes(e)}static generateState(){return i.randomBytes(32).toString("base64url")}static generateNonce(){return i.randomBytes(32).toString("base64url")}static generateAuthorizationCode(){return i.randomBytes(32).toString("hex")}static async logAuditEvent(e){try{let r="SYSTEM",t="system";if(e.userId)r="USER",t=e.userId;else if(e.clientId){r="CLIENT";let s=await n.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});t=s?s.clientId:e.clientId}let s=e.success;void 0===s&&(s=e.status?"SUCCESS"===e.status:!e.errorMessage),await n.prisma.auditLog.create({data:{action:e.action,actorType:r,actorId:t||"unknown",status:s?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:this.buildDetailsJson(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}}static buildDetailsJson(e){let r={};if(e.metadata&&(r={...r,...e.metadata}),e.errorMessage&&(r.errorMessage=e.errorMessage),e.details)try{let t=JSON.parse(e.details);r={...r,...t}}catch{r.rawDetails=e.details}return Object.keys(r).length>0?JSON.stringify(r):null}static async getUserPermissions(e){try{let r=await o.S.getUserPermissions(e),t=new Set(r?.permissions||[]);return Array.from(t)}catch(e){return console.error("Error getting user permissions:",e),[]}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},93952:(e,r,t)=>{t.d(r,{z:()=>s.prisma});var s=t(34621)},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")},96800:(e,r,t)=>{t.d(r,{NC:()=>l,ru:()=>d});var s=t(57642),i=t(97151),n=t(27819),o=t(1047),a=t(24958);async function l(e,r={}){let t,d=e.headers.get("authorization");if(!d||!d.startsWith("Bearer "))return r.allowPublicAccess?{success:!0}:{success:!1,response:s.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let u=d.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let r=i.RD(new URL(e)),s=process.env.JWT_ISSUER,o=process.env.JWT_AUDIENCE;if(!s||!o)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");t=(await n.V(u,r,{issuer:s,audience:o,algorithms:["RS256"]})).payload}catch(r){console.error("JWT 验证失败 (JWT validation failed):",r);let e="Token validation failed";return r instanceof o.n?e=`Token expired at ${new Date(1e3*r.payload.exp).toISOString()}`:r instanceof o.ie?e=`Token claim validation failed: ${r.claim} ${r.reason}`:r instanceof o.T0||r instanceof o._L?e="Invalid token algorithm or key issue.":r instanceof Error&&(r.message.includes("JWKS")||r.message.includes("configured"))&&(e=`Token validation setup error: ${r.message}`),{success:!1,response:s.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let c=t.sub,p=t.client_id,m=t.scope?.split(" ")||[],h=t.permissions||[];if(r.requiredScopes&&r.requiredScopes.length>0&&!r.requiredScopes.every(e=>m.includes(e)))return{success:!1,response:s.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${r.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${r.requiredScopes.join(" ")}"`}})};if(r.requiredPermissions&&r.requiredPermissions.length>0&&!r.requiredPermissions.every(e=>h.includes(e)))return{success:!1,response:s.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${r.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let g={user_id:c,client_id:p,scopes:m,permissions:h,tokenPayload:t};if(r.requireUserContext&&c)try{let e=await a.z.user.findUnique({where:{id:c,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(g.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("获取用户信息失败 (Failed to fetch user information):",e)}return{success:!0,context:g}}function d(e,r={}){return async function(t){let i=await l(t,r);return i.success?i.context?e(t,i.context):s.NextResponse.json({error:"authentication_failed",error_description:"Authentication context missing"},{status:500}):i.response||s.NextResponse.json({error:"authentication_failed",error_description:"Authentication failed"},{status:401})}}new(t(28064)).n1(a.z)}};var r=require("../../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[938,176,344,196,578,987,466,855,119,64],()=>t(45463));module.exports=s})();