"use strict";(()=>{var e={};e.id=964,e.ids=[964],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1630:e=>{e.exports=require("http")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},2412:e=>{e.exports=require("assert")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},3997:e=>{e.exports=require("tty")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4985:e=>{e.exports=require("dns")},5463:(e,r,s)=>{s.r(r),s.d(r,{patchFetch:()=>O,routeModule:()=>N,serverHooks:()=>E,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>A});var i={};s.r(i),s.d(i,{GET:()=>S,POST:()=>g});var o=s(9227),t=s(9044),n=s(1131),a=s(7642),d=s(8891),u=s(6330),p=s(9565),l=s(9776),c=s(7200);let I=c.z.object({permissionIds:c.z.array(c.z.string().cuid("无效的权限ID格式 (Invalid permission ID format: must be a CUID)")).min(0,"权限ID列表可以为空，表示移除所有权限 (Permission IDs array can be empty to remove all permissions)")});async function m(e,r){let{roleId:s}=r.params,i=e.user,o=e.ip||e.headers?.get("x-forwarded-for"),t=e.headers?.get("user-agent");try{let e=await d.A.role.findUnique({where:{id:s},include:{rolePermissions:{include:{permission:!0},orderBy:{permission:{name:"asc"}}}}});if(!e)return await l.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"ROLE_PERMISSIONS_LIST_FAILURE_ROLE_NOT_FOUND",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:o,userAgent:t,errorMessage:"Role not found when trying to list its permissions."}),a.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});let r=e.rolePermissions.map(e=>e.permission).filter(e=>null!==e&&!0===e.isActive);return await l.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"ROLE_PERMISSIONS_LIST_SUCCESS",status:"SUCCESS",resourceType:"Role",resourceId:s,ipAddress:o,userAgent:t,details:JSON.stringify({roleName:e.name,listedPermissionsCount:r.length})}),a.NextResponse.json({permissions:r})}catch(e){return console.error(`列出角色 ${s} 的权限失败 (Failed to list permissions for role ${s}):`,e),await l.PC.logAuditEvent({actorType:i?.id?"USER":"UNKNOWN_ACTOR",actorId:i?.id||"anonymous",userId:i?.id,action:"ROLE_PERMISSIONS_LIST_FAILURE_DB_ERROR",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:o,userAgent:t,errorMessage:`Failed to list permissions for role ${s}.`,details:JSON.stringify({error:e.message})}),a.NextResponse.json({message:"获取角色权限列表时发生错误 (An error occurred while retrieving role permissions)"},{status:500})}}async function R(e,r){let s,{roleId:i}=r.params,o=e.user,t=e.ip||e.headers?.get("x-forwarded-for"),n=e.headers?.get("user-agent");try{s=await e.json()}catch(e){return await l.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_INVALID_JSON",status:"FAILURE",resourceType:"Role",resourceId:i,ipAddress:t,userAgent:n,errorMessage:"Invalid JSON request body for assigning permissions.",details:JSON.stringify({error:e.message})}),a.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let p=I.safeParse(s);if(!p.success)return await l.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_VALIDATION",status:"FAILURE",resourceType:"Role",resourceId:i,ipAddress:t,userAgent:n,errorMessage:"Assigning permissions input validation failed.",details:JSON.stringify({issues:p.error.format(),receivedBody:s})}),a.NextResponse.json({message:"分配权限的请求数据验证失败 (Assigning permissions input validation failed)",errors:p.error.format()},{status:400});let{permissionIds:c}=p.data;try{let e=await d.A.role.findUnique({where:{id:i}});if(!e)return await l.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_ROLE_NOT_FOUND",status:"FAILURE",resourceType:"Role",resourceId:i,ipAddress:t,userAgent:n,errorMessage:"Role not found, cannot assign permissions."}),a.NextResponse.json({message:"角色未找到，无法分配权限 (Role not found, cannot assign permissions)"},{status:404});let r=await d.A.permission.findMany({where:{id:{in:c},isActive:!0}});if(r.length!==c.length){let s=r.map(e=>e.id),d=c.filter(e=>!s.includes(e));return await l.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_INVALID_IDS",status:"FAILURE",resourceType:"Role",resourceId:i,ipAddress:t,userAgent:n,errorMessage:"Some permission IDs are invalid or inactive.",details:JSON.stringify({roleName:e.name,requestedPIDs:c,invalidPIDs:d})}),a.NextResponse.json({message:`以下权限ID无效或当前未激活: ${d.join(", ")} (Following permission IDs are invalid or currently inactive: ${d.join(", ")})`},{status:400})}await d.A.$transaction(async e=>{if(await e.rolePermission.deleteMany({where:{roleId:i}}),c.length>0){let r=c.map(e=>({roleId:i,permissionId:e}));await e.rolePermission.createMany({data:r})}});let s=(await d.A.rolePermission.findMany({where:{roleId:i},include:{permission:!0}})).map(e=>e.permission).filter(e=>null!==e&&e.isActive);return a.NextResponse.json({message:"权限已成功分配给角色 (Permissions have been successfully assigned to the role)",assignedPermissions:s})}catch(d){console.error(`为角色 ${i} 分配权限失败 (Failed to assign permissions to role ${i}):`,d);let e="An unexpected server error occurred while assigning permissions",r="ROLE_PERMISSIONS_ASSIGN_FAILURE_DB_ERROR",s=500;return d instanceof u.Prisma.PrismaClientKnownRequestError&&"P2003"===d.code&&(e="Failed to assign permissions: one or more provided permission IDs are invalid (foreign key constraint).",r="ROLE_PERMISSIONS_ASSIGN_FAILURE_FK_CONSTRAINT",s=400),await l.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:r,status:"FAILURE",resourceType:"Role",resourceId:i,ipAddress:t,userAgent:n,errorMessage:e,details:JSON.stringify({roleName:role?.name,requestedPIDs:c,error:d.message,errorCode:d.code})}),a.NextResponse.json({message:e},{status:s})}}let S=(0,p.PS)("roles:permissions:read")(m),g=(0,p.PS)("roles:permissions:assign")(R),N=new o.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/v2/roles/[roleId]/permissions/route",pathname:"/api/v2/roles/[roleId]/permissions",filename:"route",bundlePath:"app/api/v2/roles/[roleId]/permissions/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/[roleId]/permissions/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:y,workUnitAsyncStorage:A,serverHooks:E}=N;function O(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:A})}},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},5591:e=>{e.exports=require("https")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var r=require("../../../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),i=r.X(0,[938,344,176,578,434,200,470,776,565],()=>s(5463));module.exports=i})();