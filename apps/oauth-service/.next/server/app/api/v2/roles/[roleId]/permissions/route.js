(()=>{var e={};e.id=964,e.ids=[964],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function s(e){var s=Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}s.keys=()=>[],s.resolve=s,s.id=4997,e.exports=s},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,s,r)=>{"use strict";r.d(s,{z:()=>o});var t=r(96330);let o=globalThis.prisma??new t.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,s,r)=>{"use strict";r.d(s,{prisma:()=>t.z}),r(96330);var t=r(24958),o=r(50488),i=r.n(o),n=r(5433);i().config();let a={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},u=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:a.host,port:a.port,user:a.user,database:a.database}),n.createPool(a));async function l(){if(u&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await u.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await l(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await l(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await l(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,s,r)=>{"use strict";r.d(s,{B9:()=>t.B9,Uj:()=>t.Uj}),r(44325),r(18354);var t=r(84327);r(43281),r(55807),r(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,s,r)=>{"use strict";r.d(s,{A:()=>u});var t=r(55511);let o={randomUUID:t.randomUUID},i=new Uint8Array(256),n=i.length,a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));let u=function(e,s,r){if(o.randomUUID&&!s&&!e)return o.randomUUID();let u=(e=e||{}).random??e.rng?.()??(n>i.length-16&&((0,t.randomFillSync)(i),n=0),i.slice(n,n+=16));if(u.length<16)throw Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,s){if((r=r||0)<0||r+16>s.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)s[r+e]=u[e];return s}return function(e,s=0){return(a[e[s+0]]+a[e[s+1]]+a[e[s+2]]+a[e[s+3]]+"-"+a[e[s+4]]+a[e[s+5]]+"-"+a[e[s+6]]+a[e[s+7]]+"-"+a[e[s+8]]+a[e[s+9]]+"-"+a[e[s+10]]+a[e[s+11]]+a[e[s+12]]+a[e[s+13]]+a[e[s+14]]+a[e[s+15]]).toLowerCase()}(u)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96333:(e,s,r)=>{"use strict";r.r(s),r.d(s,{patchFetch:()=>y,routeModule:()=>R,serverHooks:()=>_,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>f});var t={};r.r(t),r.d(t,{GET:()=>x,POST:()=>v});var o=r(19227),i=r(39044),n=r(11131),a=r(57642),u=r(34621),l=r(96330),c=r(43281),d=r(38738),p=r(44325),m=r(67200);let g=m.z.object({permissionIds:m.z.array(m.z.string().cuid("无效的权限ID格式 (Invalid permission ID format: must be a CUID)")).min(0,"权限ID列表可以为空，表示移除所有权限 (Permission IDs array can be empty to remove all permissions)")});async function I(e,s){let{roleId:r}=s.params,t=void 0,o=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,i=e.headers.get("user-agent")||void 0;try{let e=await u.prisma.role.findUnique({where:{id:r},include:{rolePermissions:{include:{permission:!0},orderBy:{permission:{name:"asc"}}}}});if(!e)return await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_PERMISSIONS_LIST_FAILURE_ROLE_NOT_FOUND",resource:`Role:${r}`,success:!1,ipAddress:o,userAgent:i,errorMessage:"Role not found when trying to list its permissions."}),a.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});let s=e.rolePermissions.map(e=>e.permission).filter(e=>null!==e&&!0===e.isActive);return await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_PERMISSIONS_LIST_SUCCESS",resource:`Role:${r}`,success:!0,ipAddress:o,userAgent:i,metadata:{roleName:e.name,listedPermissionsCount:s.length}}),a.NextResponse.json({permissions:s})}catch(e){return console.error(`列出角色 ${r} 的权限失败 (Failed to list permissions for role ${r}):`,e),await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_PERMISSIONS_LIST_FAILURE_DB_ERROR",resource:`Role:${r}`,success:!1,ipAddress:o,userAgent:i,errorMessage:`Failed to list permissions for role ${r}.`,metadata:{error:e.message}}),a.NextResponse.json({message:"获取角色权限列表时发生错误 (An error occurred while retrieving role permissions)"},{status:500})}}async function S(e,s){let r,{roleId:t}=s.params,o=void 0,i=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,n=e.headers.get("user-agent")||void 0;try{r=await e.json()}catch(e){return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_INVALID_JSON",resource:`Role:${t}`,success:!1,ipAddress:i,userAgent:n,errorMessage:"Invalid JSON request body for assigning permissions.",metadata:{error:e.message}}),a.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let c=g.safeParse(r);if(!c.success)return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_VALIDATION",resource:`Role:${t}`,success:!1,ipAddress:i,userAgent:n,errorMessage:"Assigning permissions input validation failed.",metadata:{issues:c.error.format(),receivedBody:r}}),a.NextResponse.json({message:"分配权限的请求数据验证失败 (Assigning permissions input validation failed)",errors:c.error.format()},{status:400});let{permissionIds:d}=c.data;try{let e=await u.prisma.role.findUnique({where:{id:t}});if(!e)return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_ROLE_NOT_FOUND",resource:`Role:${t}`,success:!1,ipAddress:i,userAgent:n,errorMessage:"Role not found, cannot assign permissions."}),a.NextResponse.json({message:"角色未找到，无法分配权限 (Role not found, cannot assign permissions)"},{status:404});let s=await u.prisma.permission.findMany({where:{id:{in:d},isActive:!0}});if(s.length!==d.length){let r=s.map(e=>e.id),u=d.filter(e=>!r.includes(e));return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PERMISSIONS_ASSIGN_FAILURE_INVALID_IDS",resource:`Role:${t}`,success:!1,ipAddress:i,userAgent:n,errorMessage:"Some permission IDs are invalid or inactive.",metadata:{roleName:e.name,requestedPIDs:d,invalidPIDs:u}}),a.NextResponse.json({message:`以下权限ID无效或当前未激活: ${u.join(", ")} (Following permission IDs are invalid or currently inactive: ${u.join(", ")})`},{status:400})}await u.prisma.$transaction(async e=>{if(await e.rolePermission.deleteMany({where:{roleId:t}}),d.length>0){let s=d.map(e=>({roleId:t,permissionId:e}));await e.rolePermission.createMany({data:s})}});let r=(await u.prisma.rolePermission.findMany({where:{roleId:t},include:{permission:!0}})).map(e=>e.permission).filter(e=>null!==e&&e.isActive);return a.NextResponse.json({message:"权限已成功分配给角色 (Permissions have been successfully assigned to the role)",assignedPermissions:r})}catch(u){console.error(`为角色 ${t} 分配权限失败 (Failed to assign permissions to role ${t}):`,u);let e="An unexpected server error occurred while assigning permissions",s="ROLE_PERMISSIONS_ASSIGN_FAILURE_DB_ERROR",r=500;return u instanceof l.Prisma.PrismaClientKnownRequestError&&"P2003"===u.code&&(e="Failed to assign permissions: one or more provided permission IDs are invalid (foreign key constraint).",s="ROLE_PERMISSIONS_ASSIGN_FAILURE_FK_CONSTRAINT",r=400),await p.PC.logAuditEvent({userId:o?.id,action:s,success:!1,ipAddress:i,userAgent:n,errorMessage:e,metadata:{roleId:t,requestedPIDs:d,error:u.message,errorCode:u.code}}),a.NextResponse.json({message:e},{status:r})}}let x=(0,d.Uj)((0,c.ru)(async(e,s)=>I(e,{params:s.params,authContext:s.authContext}),{requiredPermissions:["roles:permissions:read"]})),v=(0,d.Uj)((0,c.ru)(async(e,s)=>S(e,{params:s.params,authContext:s.authContext}),{requiredPermissions:["roles:permissions:assign"]})),R=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/v2/roles/[roleId]/permissions/route",pathname:"/api/v2/roles/[roleId]/permissions",filename:"route",bundlePath:"app/api/v2/roles/[roleId]/permissions/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/[roleId]/permissions/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:h,workUnitAsyncStorage:f,serverHooks:_}=R;function y(){return(0,n.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:f})}}};var s=require("../../../../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[938,176,733,200,344,706,855,281],()=>r(96333));module.exports=t})();