(()=>{var e={};e.id=436,e.ids=[436],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=4997,e.exports=r},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12110:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>q,routeModule:()=>y,serverHooks:()=>E,workAsyncStorage:()=>I,workUnitAsyncStorage:()=>f});var t={};s.r(t),s.d(t,{GET:()=>v,POST:()=>R});var o=s(19227),i=s(39044),a=s(11131),n=s(57642),l=s(34621),u=s(96330),c=s(43281),d=s(38738),p=s(44325),m=s(67200);let g=m.z.object({name:m.z.string().min(3,"角色名称至少需要3个字符 (Role name must be at least 3 characters long)").max(50,"角色名称不能超过50个字符 (Role name cannot exceed 50 characters long)").regex(/^[a-zA-Z0-9_:-]+$/,"角色名称只能包含字母、数字、下划线、冒号和连字符 (Role name can only contain letters, numbers, underscores, colons, and hyphens)"),displayName:m.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(100,"显示名称不能超过100个字符 (Display name cannot exceed 100 characters long)"),description:m.z.string().max(255,"描述信息不能超过255个字符 (Description cannot exceed 255 characters long)").optional().nullable(),isActive:m.z.boolean().optional().default(!0),permissionIds:m.z.array(m.z.string().cuid("无效的权限ID格式 (Invalid Permission ID format: must be a CUID)")).optional().default([])});async function x(e,r){let{searchParams:s}=new URL(e.url),t=parseInt(s.get("page")||"1",10),o=parseInt(s.get("pageSize")||"10",10);o=Math.min(Math.max(o,1),100);let i=s.get("name"),a=s.get("isActive"),u={};i&&(u.name={contains:i}),null!==a&&(u.isActive="true"===a);try{let e=await l.prisma.role.findMany({where:u,include:{rolePermissions:{include:{permission:!0}}},skip:(t-1)*o,take:o,orderBy:{createdAt:"desc"}}),r=await l.prisma.role.count({where:u}),s=e.map(e=>{let{rolePermissions:r,...s}=e;return{...s,permissions:r.map(e=>e.permission)}});return n.NextResponse.json({data:s,pagination:{page:t,pageSize:o,totalItems:r,totalPages:Math.ceil(r/o)}})}catch(e){return console.error("列出角色失败 (Failed to list roles):",e),n.NextResponse.json({message:"获取角色列表失败 (Failed to retrieve roles list)"},{status:500})}}async function h(e,r){let s,t=r.authContext.user_id,o=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,i=e.headers.get("user-agent")||void 0;try{s=await e.json()}catch(e){return await p.PC.logAuditEvent({userId:t,action:"ROLE_CREATE_FAILURE_INVALID_JSON",success:!1,ipAddress:o,userAgent:i,errorMessage:"Invalid JSON request body for role creation.",metadata:{error:e.message}}),n.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let a=g.safeParse(s);if(!a.success)return await p.PC.logAuditEvent({userId:t,action:"ROLE_CREATE_FAILURE_VALIDATION",success:!1,ipAddress:o,userAgent:i,errorMessage:"Role creation payload validation failed.",metadata:{issues:a.error.format(),receivedBody:s}}),n.NextResponse.json({message:"创建角色验证失败 (Role creation input validation failed)",errors:a.error.format()},{status:400});let{name:c,displayName:d,description:m,isActive:x,permissionIds:h}=a.data;try{let e=await l.prisma.role.findUnique({where:{name:c}});if(e)return await p.PC.logAuditEvent({userId:t,action:"ROLE_CREATE_FAILURE_CONFLICT",resource:`Role:${e.id}`,success:!1,ipAddress:o,userAgent:i,errorMessage:`Role name "${c}" already exists.`,metadata:{name:c}}),n.NextResponse.json({message:`角色名称 "${c}" 已存在 (Role name "${c}" already exists)`},{status:409});if(h&&h.length>0){let e=await l.prisma.permission.findMany({where:{id:{in:h}},select:{id:!0}});if(e.length!==h.length){let r=h.filter(r=>!e.some(e=>e.id===r));return await p.PC.logAuditEvent({userId:t,action:"ROLE_CREATE_FAILURE_INVALID_PERMISSIONS",success:!1,ipAddress:o,userAgent:i,errorMessage:"Invalid or non-existent permissionIds provided.",metadata:{providedIds:h,notFoundIds:r}}),n.NextResponse.json({message:`提供了无效或不存在的权限ID (Invalid or non-existent permissionIds provided): ${r.join(", ")}`},{status:400})}}let r=await l.prisma.$transaction(async e=>{let r=await e.role.create({data:{name:c,displayName:d,description:m||null,isActive:x}});if(h&&h.length>0){let s=h.map(e=>({roleId:r.id,permissionId:e}));await e.rolePermission.createMany({data:s})}return r}),{rolePermissions:s,...a}=await l.prisma.role.findUnique({where:{id:r.id},include:{rolePermissions:{include:{permission:!0}}}}),u={...a,permissions:s.map(e=>e.permission)};return await p.PC.logAuditEvent({userId:t,action:"ROLE_CREATE_SUCCESS",resource:`Role:${r.id}`,success:!0,ipAddress:o,userAgent:i,metadata:{roleId:r.id,name:r.name,displayName:r.displayName,permissionIds:h}}),n.NextResponse.json(u,{status:201})}catch(s){console.error("创建角色失败 (Failed to create role):",s);let e="An unexpected server error occurred during role creation",r="ROLE_CREATE_FAILURE_DB_ERROR";if(s instanceof u.Prisma.PrismaClientKnownRequestError&&"P2002"===s.code&&(e=`Role name "${c}" already exists due to a database constraint`,r="ROLE_CREATE_FAILURE_CONFLICT_DB"),await p.PC.logAuditEvent({userId:t,action:r,success:!1,ipAddress:o,userAgent:i,errorMessage:e,metadata:{name:c,displayName:d,permissionIds:h,error:s.message,errorCode:s.code}}),s instanceof u.Prisma.PrismaClientKnownRequestError&&"P2002"===s.code)return n.NextResponse.json({message:e},{status:409});return n.NextResponse.json({message:"创建角色时发生服务器错误 (An unexpected server error occurred during role creation)"},{status:500})}}let v=(0,d.Uj)((0,c.ru)(x,{requiredPermissions:["role:list"]})),R=(0,d.Uj)((0,c.ru)(h,{requiredPermissions:["role:create"]})),y=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/v2/roles/route",pathname:"/api/v2/roles",filename:"route",bundlePath:"app/api/v2/roles/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:I,workUnitAsyncStorage:f,serverHooks:E}=y;function q(){return(0,a.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:f})}},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,r,s)=>{"use strict";s.d(r,{z:()=>o});var t=s(96330);let o=globalThis.prisma??new t.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,r,s)=>{"use strict";s.d(r,{prisma:()=>t.z}),s(96330);var t=s(24958),o=s(50488),i=s.n(o),a=s(5433);i().config();let n={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},l=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:n.host,port:n.port,user:n.user,database:n.database}),a.createPool(n));async function u(){if(l&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await l.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await u(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await u(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await u(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,r,s)=>{"use strict";s.d(r,{B9:()=>t.B9,Uj:()=>t.Uj}),s(44325),s(18354);var t=s(84327);s(43281),s(55807),s(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,r,s)=>{"use strict";s.d(r,{A:()=>l});var t=s(55511);let o={randomUUID:t.randomUUID},i=new Uint8Array(256),a=i.length,n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let l=function(e,r,s){if(o.randomUUID&&!r&&!e)return o.randomUUID();let l=(e=e||{}).random??e.rng?.()??(a>i.length-16&&((0,t.randomFillSync)(i),a=0),i.slice(a,a+=16));if(l.length<16)throw Error("Random bytes length must be >= 16");if(l[6]=15&l[6]|64,l[8]=63&l[8]|128,r){if((s=s||0)<0||s+16>r.length)throw RangeError(`UUID byte range ${s}:${s+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[s+e]=l[e];return r}return function(e,r=0){return(n[e[r+0]]+n[e[r+1]]+n[e[r+2]]+n[e[r+3]]+"-"+n[e[r+4]]+n[e[r+5]]+"-"+n[e[r+6]]+n[e[r+7]]+"-"+n[e[r+8]]+n[e[r+9]]+"-"+n[e[r+10]]+n[e[r+11]]+n[e[r+12]]+n[e[r+13]]+n[e[r+14]]+n[e[r+15]]).toLowerCase()}(l)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[938,176,733,200,344,706,855,281],()=>s(12110));module.exports=t})();