"use strict";(()=>{var e={};e.id=436,e.ids=[436],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},8442:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>v,routeModule:()=>y,serverHooks:()=>N,workAsyncStorage:()=>E,workUnitAsyncStorage:()=>A});var s={};t.r(s),t.d(s,{GET:()=>x,POST:()=>I});var a=t(9227),i=t(9044),o=t(1131),n=t(7642),d=t(8891),l=t(6330),u=t(4633),p=t(9776),c=t(7200);let m=c.z.object({name:c.z.string().min(3,"角色名称至少需要3个字符 (Role name must be at least 3 characters long)").max(50,"角色名称不能超过50个字符 (Role name cannot exceed 50 characters long)").regex(/^[a-zA-Z0-9_:-]+$/,"角色名称只能包含字母、数字、下划线、冒号和连字符 (Role name can only contain letters, numbers, underscores, colons, and hyphens)"),displayName:c.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(100,"显示名称不能超过100个字符 (Display name cannot exceed 100 characters long)"),description:c.z.string().max(255,"描述信息不能超过255个字符 (Description cannot exceed 255 characters long)").optional().nullable(),isActive:c.z.boolean().optional().default(!0),permissionIds:c.z.array(c.z.string().cuid("无效的权限ID格式 (Invalid Permission ID format: must be a CUID)")).optional().default([])});async function R(e){let{searchParams:r}=new URL(e.url),t=parseInt(r.get("page")||"1",10),s=parseInt(r.get("pageSize")||"10",10);s=Math.min(Math.max(s,1),100);let a=r.get("name"),i=r.get("isActive"),o={};a&&(o.name={contains:a,mode:"insensitive"}),null!==i&&(o.isActive="true"===i);try{let e=await d.A.role.findMany({where:o,include:{rolePermissions:{include:{permission:!0}}},skip:(t-1)*s,take:s,orderBy:{createdAt:"desc"}}),r=await d.A.role.count({where:o}),a=e.map(e=>{let{rolePermissions:r,...t}=e;return{...t,permissions:r.map(e=>e.permission)}});return n.NextResponse.json({data:a,pagination:{page:t,pageSize:s,totalItems:r,totalPages:Math.ceil(r/s)}})}catch(e){return console.error("列出角色失败 (Failed to list roles):",e),n.NextResponse.json({message:"获取角色列表失败 (Failed to retrieve roles list)"},{status:500})}}async function g(e){let r,t=e.user,s=e.ip||e.headers?.get("x-forwarded-for"),a=e.headers?.get("user-agent");try{r=await e.json()}catch(e){return await p.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"ROLE_CREATE_FAILURE_INVALID_JSON",status:"FAILURE",ipAddress:s,userAgent:a,errorMessage:"Invalid JSON request body for role creation.",details:JSON.stringify({error:e.message})}),n.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let i=m.safeParse(r);if(!i.success)return await p.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"ROLE_CREATE_FAILURE_VALIDATION",status:"FAILURE",ipAddress:s,userAgent:a,errorMessage:"Role creation payload validation failed.",details:JSON.stringify({issues:i.error.format(),receivedBody:r})}),n.NextResponse.json({message:"创建角色验证失败 (Role creation input validation failed)",errors:i.error.format()},{status:400});let{name:o,displayName:u,description:c,isActive:R,permissionIds:g}=i.data;try{let e=await d.A.role.findUnique({where:{name:o}});if(e)return await p.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"ROLE_CREATE_FAILURE_CONFLICT",status:"FAILURE",ipAddress:s,userAgent:a,errorMessage:`Role name "${o}" already exists.`,resourceType:"Role",resourceId:e.id,details:JSON.stringify({name:o})}),n.NextResponse.json({message:`角色名称 "${o}" 已存在 (Role name "${o}" already exists)`},{status:409});if(g&&g.length>0){let e=await d.A.permission.findMany({where:{id:{in:g}},select:{id:!0}});if(e.length!==g.length){let r=g.filter(r=>!e.some(e=>e.id===r));return await p.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"ROLE_CREATE_FAILURE_INVALID_PERMISSIONS",status:"FAILURE",ipAddress:s,userAgent:a,errorMessage:"Invalid or non-existent permissionIds provided.",details:JSON.stringify({providedIds:g,notFoundIds:r})}),n.NextResponse.json({message:`提供了无效或不存在的权限ID (Invalid or non-existent permissionIds provided): ${r.join(", ")}`},{status:400})}}let r=await d.A.$transaction(async e=>{let r=await e.role.create({data:{name:o,displayName:u,description:c||null,isActive:R}});if(g&&g.length>0){let t=g.map(e=>({roleId:r.id,permissionId:e}));await e.rolePermission.createMany({data:t})}return r}),{rolePermissions:i,...l}=await d.A.role.findUnique({where:{id:r.id},include:{rolePermissions:{include:{permission:!0}}}}),m={...l,permissions:i.map(e=>e.permission)};return await p.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:"ROLE_CREATE_SUCCESS",status:"SUCCESS",resourceType:"Role",resourceId:r.id,ipAddress:s,userAgent:a,details:JSON.stringify({roleId:r.id,name:r.name,displayName:r.displayName,permissionIds:g})}),n.NextResponse.json(m,{status:201})}catch(i){console.error("创建角色失败 (Failed to create role):",i);let e="An unexpected server error occurred during role creation",r="ROLE_CREATE_FAILURE_DB_ERROR";if(i instanceof l.Prisma.PrismaClientKnownRequestError&&"P2002"===i.code&&(e=`Role name "${o}" already exists due to a database constraint`,r="ROLE_CREATE_FAILURE_CONFLICT_DB"),await p.PC.logAuditEvent({actorType:t?.id?"USER":"UNKNOWN_ACTOR",actorId:t?.id||"anonymous",userId:t?.id,action:r,status:"FAILURE",ipAddress:s,userAgent:a,errorMessage:e,details:JSON.stringify({name:o,displayName:u,permissionIds:g,error:i.message,errorCode:i.code})}),i instanceof l.Prisma.PrismaClientKnownRequestError&&"P2002"===i.code)return n.NextResponse.json({message:e},{status:409});return n.NextResponse.json({message:"创建角色时发生服务器错误 (An unexpected server error occurred during role creation)"},{status:500})}}let x=(0,u.PS)("roles:list")(R),I=(0,u.PS)("roles:create")(g),y=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/v2/roles/route",pathname:"/api/v2/roles",filename:"route",bundlePath:"app/api/v2/roles/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:E,workUnitAsyncStorage:A,serverHooks:N}=y;function v(){return(0,o.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:A})}},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[938,176,578,935,200,813,776,633],()=>t(8442));module.exports=s})();