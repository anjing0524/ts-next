(()=>{var e={};e.id=102,e.ids=[102],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=4997,e.exports=r},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,r,s)=>{"use strict";s.d(r,{z:()=>o});var t=s(96330);let o=globalThis.prisma??new t.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,r,s)=>{"use strict";s.d(r,{prisma:()=>t.z}),s(96330);var t=s(24958),o=s(50488),a=s.n(o),i=s(5433);a().config();let n={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},l=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:n.host,port:n.port,user:n.user,database:n.database}),i.createPool(n));async function u(){if(l&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await l.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await u(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await u(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await u(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,r,s)=>{"use strict";s.d(r,{B9:()=>t.B9,Uj:()=>t.Uj}),s(44325),s(18354);var t=s(84327);s(91154),s(55807),s(65776),s(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},60102:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>y,routeModule:()=>f,serverHooks:()=>L,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>w});var t={};s.r(t),s.d(t,{DELETE:()=>x,GET:()=>I,PATCH:()=>A});var o=s(19227),a=s(39044),i=s(11131),n=s(57642),l=s(34621),u=s(96330),d=s(91154),c=s(38738),p=s(44325),m=s(67200);m.z.object({displayName:m.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(100,"显示名称不能超过100个字符 (Display name cannot exceed 100 characters long)").optional(),description:m.z.string().max(255,"描述信息不能超过255个字符 (Description cannot exceed 255 characters long)").optional().nullable(),isActive:m.z.boolean().optional()});let g=["SYSTEM_ADMIN","USER","USER_ADMIN","PERMISSION_ADMIN","CLIENT_ADMIN","AUDIT_ADMIN"];async function E(e,r){let{roleId:s}=r.params,t=void 0,o=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,a=e.headers.get("user-agent")||void 0;try{let e=await l.prisma.role.findUnique({where:{id:s},include:{rolePermissions:{include:{permission:!0}}}});if(!e)return await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_READ_FAILURE_NOT_FOUND",resource:`Role:${s}`,success:!1,ipAddress:o,userAgent:a,errorMessage:"Role not found."}),n.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});let{rolePermissions:r,...i}=e,u={...i,permissions:r.map(e=>e.permission)};return await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_READ_SUCCESS",resource:`Role:${s}`,success:!0,ipAddress:o,userAgent:a,metadata:{roleName:e.name,returnedFields:Object.keys(u)}}),n.NextResponse.json(u)}catch(e){return console.error(`获取角色 ${s} 详情失败 (Failed to fetch role details for ID ${s}):`,e),await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_READ_FAILURE_DB_ERROR",resource:`Role:${s}`,success:!1,ipAddress:o,userAgent:a,errorMessage:`Failed to fetch role details for ID ${s}.`,metadata:{error:e.message}}),n.NextResponse.json({message:`获取角色详情时发生错误 (An error occurred while retrieving role details for ID ${s})`},{status:500})}}async function R(e,r){let{roleId:s}=r.params,t=void 0,o=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,a=e.headers.get("user-agent")||void 0;try{let e=await l.prisma.role.findUnique({where:{id:s}});if(!e)return await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_DELETE_FAILURE_NOT_FOUND",resource:`Role:${s}`,success:!1,ipAddress:o,userAgent:a,errorMessage:"Role not found to delete."}),n.NextResponse.json({message:"角色未找到，无法删除 (Role not found, cannot delete)"},{status:404});if(g.includes(e.name))return await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_DELETE_FAILURE_CORE_SYSTEM_ROLE",resource:`Role:${s}`,success:!1,ipAddress:o,userAgent:a,errorMessage:`Attempted to delete core system role: ${e.name}.`,metadata:{roleName:e.name}}),n.NextResponse.json({message:`核心系统角色 "${e.name}" 不能被删除 (Core system role "${e.name}" cannot be deleted)`},{status:403});let r=await l.prisma.userRole.count({where:{roleId:s}});if(r>0)return await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_DELETE_FAILURE_IN_USE",resource:`Role:${s}`,success:!1,ipAddress:o,userAgent:a,errorMessage:`Role "${e.name}" is still in use by ${r} users.`,metadata:{roleName:e.name,userCount:r}}),n.NextResponse.json({message:`角色 "${e.name}" 仍被 ${r} 个用户使用，无法删除 (Role "${e.name}" is still in use by ${r} users and cannot be deleted)`},{status:409});return await l.prisma.role.delete({where:{id:s}}),await p.PC.logAuditEvent({userId:t?.id,action:"ROLE_DELETE_SUCCESS",resource:`Role:${s}`,success:!0,ipAddress:o,userAgent:a,metadata:{deletedRoleId:s,roleName:e.name}}),new n.NextResponse(null,{status:204})}catch(i){console.error(`删除角色 ${s} 失败 (Failed to delete role ${s}):`,i);let e=`An error occurred while deleting role for ID ${s}`,r="ROLE_DELETE_FAILURE_DB_ERROR";if(i instanceof u.Prisma.PrismaClientKnownRequestError&&"P2003"===i.code&&(e="Cannot delete role as it is still referenced by other records (e.g., permission assignments)",r="ROLE_DELETE_FAILURE_FOREIGN_KEY"),await p.PC.logAuditEvent({userId:t?.id,action:r,success:!1,ipAddress:o,userAgent:a,errorMessage:e,metadata:{error:i.message,roleId:s}}),"ROLE_DELETE_FAILURE_FOREIGN_KEY"===r)return n.NextResponse.json({message:e},{status:409});return n.NextResponse.json({message:`删除角色时发生错误 (An error occurred while deleting role for ID ${s})`},{status:500})}}let I=(0,c.Uj)((0,d.ru)(async(e,r)=>{let s=new URL(e.url).pathname.split("/");return E(e,{params:{roleId:s[s.length-1]||""},authContext:r})},{requiredPermissions:["roles:read"]})),h=m.z.object({displayName:m.z.string().min(1).max(100).optional(),description:m.z.string().max(255).optional().nullable(),isActive:m.z.boolean().optional(),permissionIds:m.z.array(m.z.string().cuid("无效的权限ID格式")).optional()});async function _(e,r){let s,{roleId:t}=r.params,o=void 0,a=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,i=e.headers.get("user-agent")||void 0;try{s=await e.json()}catch(e){return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PATCH_FAILURE_INVALID_JSON",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Invalid JSON request body for role patch.",metadata:{error:e.message}}),n.NextResponse.json({message:"无效的JSON请求体"},{status:400})}let u=h.safeParse(s);if(!u.success)return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PATCH_FAILURE_VALIDATION",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Role patch payload validation failed.",metadata:{issues:u.error.format(),receivedBody:s}}),n.NextResponse.json({message:"更新角色信息验证失败",errors:u.error.format()},{status:400});let{displayName:d,description:c,isActive:m,permissionIds:E}=u.data;if(0===Object.keys(u.data).length)return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PATCH_FAILURE_EMPTY_BODY",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"At least one field to update is required for PATCH."}),n.NextResponse.json({message:"请求体中至少需要一个待更新的字段"},{status:400});try{let e=await l.prisma.role.findUnique({where:{id:t}});if(!e)return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PATCH_FAILURE_NOT_FOUND",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Role not found to patch."}),n.NextResponse.json({message:"角色未找到，无法更新"},{status:404});if(g.includes(e.name)&&!1===m&&"SYSTEM_ADMIN"===e.name)return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PATCH_FAILURE_SYSTEM_ROLE_DEACTIVATION",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Attempted to deactivate SYSTEM_ADMIN role via PATCH.",metadata:{roleName:e.name}}),n.NextResponse.json({message:"禁止操作：不能停用 SYSTEM_ADMIN 角色"},{status:403});if(s.name&&s.name!==e.name)return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PATCH_FAILURE_NAME_MODIFICATION",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Modifying the role name is not allowed (PATCH).",metadata:{attemptedName:s.name,currentName:e.name}}),n.NextResponse.json({message:"禁止操作：不允许修改角色名称"},{status:400});let r=await l.prisma.$transaction(async e=>{let r={};if(void 0!==d&&(r.displayName=d),void 0!==c&&(r.description=c),void 0!==m&&(r.isActive=m),Object.keys(r).length>0&&await e.role.update({where:{id:t},data:r}),void 0!==E){if(E.length>0){let r=await e.permission.count({where:{id:{in:E}}});if(r!==E.length)throw Error(`One or more provided permissionIds are invalid or do not exist. Found ${r} valid IDs out of ${E.length}.`)}await e.rolePermission.deleteMany({where:{roleId:t}}),E.length>0&&await e.rolePermission.createMany({data:E.map(e=>({roleId:t,permissionId:e}))})}return e.role.findUnique({where:{id:t},include:{rolePermissions:{include:{permission:!0}}}})});if(!r)throw Error("Role update failed post-transaction somehow.");let{rolePermissions:R,...I}=r,h={...I,permissions:R.map(e=>e.permission)};return await p.PC.logAuditEvent({userId:o?.id,action:"ROLE_PATCH_SUCCESS",resource:`Role:${t}`,success:!0,ipAddress:a,userAgent:i,metadata:{roleId:t,updatedFields:Object.keys(u.data),assignedPermissionIds:E}}),n.NextResponse.json(h)}catch(l){console.error(`更新角色 ${t} 失败:`,l);let e=`An error occurred while patching role for ID ${t}`,r="ROLE_PATCH_FAILURE_DB_ERROR",s=500;return l.message.toLowerCase().includes("permissionids are invalid")&&(e=l.message,r="ROLE_PATCH_FAILURE_INVALID_PERMISSIONS_IN_TX",s=400),await p.PC.logAuditEvent({userId:o?.id,action:r,success:!1,ipAddress:a,userAgent:i,errorMessage:e,metadata:{error:l.message,errorCode:l.code,attemptedData:u.data}}),n.NextResponse.json({message:e},{status:s})}}let A=(0,c.Uj)((0,d.ru)(async(e,r)=>{let s=new URL(e.url).pathname.split("/");return _(e,{params:{roleId:s[s.length-1]||""}})},{requiredPermissions:["roles:update"]})),x=(0,c.Uj)((0,d.ru)(async(e,r)=>{let s=new URL(e.url).pathname.split("/");return R(e,{params:{roleId:s[s.length-1]||""}})},{requiredPermissions:["roles:delete"]})),f=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v2/roles/[roleId]/route",pathname:"/api/v2/roles/[roleId]",filename:"route",bundlePath:"app/api/v2/roles/[roleId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/[roleId]/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:v,workUnitAsyncStorage:w,serverHooks:L}=f;function y(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:w})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,r,s)=>{"use strict";s.d(r,{A:()=>l});var t=s(55511);let o={randomUUID:t.randomUUID},a=new Uint8Array(256),i=a.length,n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let l=function(e,r,s){if(o.randomUUID&&!r&&!e)return o.randomUUID();let l=(e=e||{}).random??e.rng?.()??(i>a.length-16&&((0,t.randomFillSync)(a),i=0),a.slice(i,i+=16));if(l.length<16)throw Error("Random bytes length must be >= 16");if(l[6]=15&l[6]|64,l[8]=63&l[8]|128,r){if((s=s||0)<0||s+16>r.length)throw RangeError(`UUID byte range ${s}:${s+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[s+e]=l[e];return r}return function(e,r=0){return(n[e[r+0]]+n[e[r+1]]+n[e[r+2]]+n[e[r+3]]+"-"+n[e[r+4]]+n[e[r+5]]+"-"+n[e[r+6]]+n[e[r+7]]+"-"+n[e[r+8]]+n[e[r+9]]+"-"+n[e[r+10]]+n[e[r+11]]+n[e[r+12]]+n[e[r+13]]+n[e[r+14]]+n[e[r+15]]).toLowerCase()}(l)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[938,176,200,229,344,304,706,855,154],()=>s(60102));module.exports=t})();