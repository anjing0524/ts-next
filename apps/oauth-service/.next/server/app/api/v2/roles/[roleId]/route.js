"use strict";(()=>{var e={};e.id=102,e.ids=[102],e.modules={102:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>S,routeModule:()=>y,serverHooks:()=>U,workAsyncStorage:()=>O,workUnitAsyncStorage:()=>T});var s={};t.r(s),t.d(s,{DELETE:()=>_,GET:()=>m,PATCH:()=>g});var o=t(9227),a=t(9044),i=t(1131),n=t(7642),d=t(8891),u=t(6330),l=t(4633),c=t(9776),p=t(7200);p.z.object({displayName:p.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(100,"显示名称不能超过100个字符 (Display name cannot exceed 100 characters long)").optional(),description:p.z.string().max(255,"描述信息不能超过255个字符 (Description cannot exceed 255 characters long)").optional().nullable(),isActive:p.z.boolean().optional()});let R=["SYSTEM_ADMIN","USER","USER_ADMIN","PERMISSION_ADMIN","CLIENT_ADMIN","AUDIT_ADMIN"];async function E(e,r){let{roleId:t}=r.params,s=e.user,o=e.ip||e.headers?.get("x-forwarded-for"),a=e.headers?.get("user-agent");try{let e=await d.A.role.findUnique({where:{id:t},include:{rolePermissions:{include:{permission:!0}}}});if(!e)return await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:"ROLE_READ_FAILURE_NOT_FOUND",status:"FAILURE",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,errorMessage:"Role not found."}),n.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});let{rolePermissions:r,...i}=e,u={...i,permissions:r.map(e=>e.permission)};return await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:"ROLE_READ_SUCCESS",status:"SUCCESS",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,details:JSON.stringify({roleName:e.name,returnedFields:Object.keys(u)})}),n.NextResponse.json(u)}catch(e){return console.error(`获取角色 ${t} 详情失败 (Failed to fetch role details for ID ${t}):`,e),await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:"ROLE_READ_FAILURE_DB_ERROR",status:"FAILURE",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,errorMessage:`Failed to fetch role details for ID ${t}.`,details:JSON.stringify({error:e.message})}),n.NextResponse.json({message:`获取角色详情时发生错误 (An error occurred while retrieving role details for ID ${t})`},{status:500})}}async function I(e,r){let{roleId:t}=r.params,s=e.user,o=e.ip||e.headers?.get("x-forwarded-for"),a=e.headers?.get("user-agent");try{let e=await d.A.role.findUnique({where:{id:t}});if(!e)return await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:"ROLE_DELETE_FAILURE_NOT_FOUND",status:"FAILURE",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,errorMessage:"Role not found to delete."}),n.NextResponse.json({message:"角色未找到，无法删除 (Role not found, cannot delete)"},{status:404});if(R.includes(e.name))return await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:"ROLE_DELETE_FAILURE_CORE_SYSTEM_ROLE",status:"FAILURE",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,errorMessage:`Attempted to delete core system role: ${e.name}.`,details:JSON.stringify({roleName:e.name})}),n.NextResponse.json({message:`核心系统角色 "${e.name}" 不能被删除 (Core system role "${e.name}" cannot be deleted)`},{status:403});let r=await d.A.userRole.count({where:{roleId:t}});if(r>0)return await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:"ROLE_DELETE_FAILURE_IN_USE",status:"FAILURE",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,errorMessage:`Role "${e.name}" is still in use by ${r} users.`,details:JSON.stringify({roleName:e.name,userCount:r})}),n.NextResponse.json({message:`角色 "${e.name}" 仍被 ${r} 个用户使用，无法删除 (Role "${e.name}" is still in use by ${r} users and cannot be deleted)`},{status:409});return await d.A.role.delete({where:{id:t}}),await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:"ROLE_DELETE_SUCCESS",status:"SUCCESS",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,details:JSON.stringify({deletedRoleId:t,roleName:e.name})}),new n.NextResponse(null,{status:204})}catch(i){console.error(`删除角色 ${t} 失败 (Failed to delete role ${t}):`,i);let e=`An error occurred while deleting role for ID ${t}`,r="ROLE_DELETE_FAILURE_DB_ERROR";if(i instanceof u.Prisma.PrismaClientKnownRequestError&&"P2003"===i.code&&(e="Cannot delete role as it is still referenced by other records (e.g., permission assignments)",r="ROLE_DELETE_FAILURE_FOREIGN_KEY"),await c.PC.logAuditEvent({actorType:s?.id?"USER":"UNKNOWN_ACTOR",actorId:s?.id||"anonymous",userId:s?.id,action:r,status:"FAILURE",resourceType:"Role",resourceId:t,ipAddress:o,userAgent:a,errorMessage:e,details:JSON.stringify({error:i.message,roleNameAttemptedDelete:roleToDelete?.name||"N/A"})}),"ROLE_DELETE_FAILURE_FOREIGN_KEY"===r)return n.NextResponse.json({message:e},{status:409});return n.NextResponse.json({message:`删除角色时发生错误 (An error occurred while deleting role for ID ${t})`},{status:500})}}let m=(0,l.PS)("roles:read")(E),N=p.z.object({displayName:p.z.string().min(1).max(100).optional(),description:p.z.string().max(255).optional().nullable(),isActive:p.z.boolean().optional(),permissionIds:p.z.array(p.z.string().cuid("无效的权限ID格式")).optional()});async function A(e,r){let t,{roleId:s}=r.params,o=e.user,a=e.ip||e.headers?.get("x-forwarded-for"),i=e.headers?.get("user-agent");try{t=await e.json()}catch(e){return await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PATCH_FAILURE_INVALID_JSON",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,errorMessage:"Invalid JSON request body for role patch.",details:JSON.stringify({error:e.message})}),n.NextResponse.json({message:"无效的JSON请求体"},{status:400})}let u=N.safeParse(t);if(!u.success)return await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PATCH_FAILURE_VALIDATION",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,errorMessage:"Role patch payload validation failed.",details:JSON.stringify({issues:u.error.format(),receivedBody:t})}),n.NextResponse.json({message:"更新角色信息验证失败",errors:u.error.format()},{status:400});let{displayName:l,description:p,isActive:E,permissionIds:I}=u.data;if(0===Object.keys(u.data).length)return await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PATCH_FAILURE_EMPTY_BODY",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,errorMessage:"At least one field to update is required for PATCH."}),n.NextResponse.json({message:"请求体中至少需要一个待更新的字段"},{status:400});try{let e=await d.A.role.findUnique({where:{id:s}});if(!e)return await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PATCH_FAILURE_NOT_FOUND",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,errorMessage:"Role not found to patch."}),n.NextResponse.json({message:"角色未找到，无法更新"},{status:404});if(R.includes(e.name)&&!1===E&&"SYSTEM_ADMIN"===e.name)return await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PATCH_FAILURE_SYSTEM_ROLE_DEACTIVATION",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,errorMessage:"Attempted to deactivate SYSTEM_ADMIN role via PATCH.",details:JSON.stringify({roleName:e.name})}),n.NextResponse.json({message:"禁止操作：不能停用 SYSTEM_ADMIN 角色"},{status:403});if(t.name&&t.name!==e.name)return await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PATCH_FAILURE_NAME_MODIFICATION",status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,errorMessage:"Modifying the role name is not allowed (PATCH).",details:JSON.stringify({attemptedName:t.name,currentName:e.name})}),n.NextResponse.json({message:"禁止操作：不允许修改角色名称"},{status:400});let r=await d.A.$transaction(async e=>{let r={};if(void 0!==l&&(r.displayName=l),void 0!==p&&(r.description=p),void 0!==E&&(r.isActive=E),Object.keys(r).length>0&&await e.role.update({where:{id:s},data:r}),void 0!==I){if(I.length>0){let r=await e.permission.count({where:{id:{in:I}}});if(r!==I.length)throw Error(`One or more provided permissionIds are invalid or do not exist. Found ${r} valid IDs out of ${I.length}.`)}await e.rolePermission.deleteMany({where:{roleId:s}}),I.length>0&&await e.rolePermission.createMany({data:I.map(e=>({roleId:s,permissionId:e}))})}return e.role.findUnique({where:{id:s},include:{rolePermissions:{include:{permission:!0}}}})});if(!r)throw Error("Role update failed post-transaction somehow.");let{rolePermissions:m,...N}=r,A={...N,permissions:m.map(e=>e.permission)};return await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:"ROLE_PATCH_SUCCESS",status:"SUCCESS",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,details:JSON.stringify({roleId:s,updatedFields:Object.keys(u.data),assignedPermissionIds:I})}),n.NextResponse.json(A)}catch(d){console.error(`更新角色 ${s} 失败:`,d);let e=`An error occurred while patching role for ID ${s}`,r="ROLE_PATCH_FAILURE_DB_ERROR",t=500;return d.message.toLowerCase().includes("permissionids are invalid")&&(e=d.message,r="ROLE_PATCH_FAILURE_INVALID_PERMISSIONS_IN_TX",t=400),await c.PC.logAuditEvent({actorType:o?.id?"USER":"UNKNOWN_ACTOR",actorId:o?.id||"anonymous",userId:o?.id,action:r,status:"FAILURE",resourceType:"Role",resourceId:s,ipAddress:a,userAgent:i,errorMessage:e,details:JSON.stringify({error:d.message,errorCode:d.code,attemptedData:u.data})}),n.NextResponse.json({message:e},{status:t})}}let g=(0,l.PS)("roles:update")(A),_=(0,l.PS)("roles:delete")(I),y=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v2/roles/[roleId]/route",pathname:"/api/v2/roles/[roleId]",filename:"route",bundlePath:"app/api/v2/roles/[roleId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/[roleId]/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:O,workUnitAsyncStorage:T,serverHooks:U}=y;function S(){return(0,i.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:T})}},846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[938,176,578,935,200,813,776,633],()=>t(102));module.exports=s})();