(()=>{var e={};e.id=102,e.ids=[102],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=4997,e.exports=r},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,r,s)=>{"use strict";s.d(r,{z:()=>o});var t=s(96330);let o=globalThis.prisma??new t.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,r,s)=>{"use strict";s.d(r,{prisma:()=>t.z}),s(96330);var t=s(24958),o=s(50488),a=s.n(o),i=s(5433);a().config();let n={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},u=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:n.host,port:n.port,user:n.user,database:n.database}),i.createPool(n));async function d(){if(u&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await u.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await d(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await d(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await d(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,r,s)=>{"use strict";s.d(r,{B9:()=>t.B9,Uj:()=>t.Uj}),s(44325),s(18354);var t=s(84327);s(43281),s(55807),s(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},60102:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>T,routeModule:()=>w,serverHooks:()=>S,workAsyncStorage:()=>P,workUnitAsyncStorage:()=>N});var t={};s.r(t),s.d(t,{DELETE:()=>v,GET:()=>f,PATCH:()=>x,PUT:()=>h});var o=s(19227),a=s(39044),i=s(11131),n=s(57642),u=s(34621),d=s(43281),l=s(38738),c=s(44325),p=s(67200);let m=p.z.object({displayName:p.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(100,"显示名称不能超过100个字符 (Display name cannot exceed 100 characters long)").optional(),description:p.z.string().max(255,"描述信息不能超过255个字符 (Description cannot exceed 255 characters long)").optional().nullable(),isActive:p.z.boolean().optional()}),g=m.extend({permissionIds:p.z.array(p.z.string().cuid("无效的权限ID格式 (Invalid Permission ID format: must be a CUID)")).optional()}),E=["SYSTEM_ADMIN","USER","USER_ADMIN","PERMISSION_ADMIN","CLIENT_ADMIN","AUDIT_ADMIN"];async function R(e,{authContext:r,params:s}){let{roleId:t}=s,o=r.user_id,a=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,i=e.headers.get("user-agent")||void 0;try{let e=await u.prisma.role.findUnique({where:{id:t},include:{rolePermissions:{include:{permission:!0}}}});if(!e)return await c.PC.logAuditEvent({userId:o,action:"ROLE_READ_FAILURE_NOT_FOUND",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Role not found."}),n.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});let{rolePermissions:r,...s}=e,d={...s,permissions:r.map(e=>e.permission)};return await c.PC.logAuditEvent({userId:o,action:"ROLE_READ_SUCCESS",resource:`Role:${t}`,success:!0,ipAddress:a,userAgent:i,metadata:{roleName:e.name,returnedFields:Object.keys(d)}}),n.NextResponse.json(d)}catch(e){return console.error(`获取角色 ${t} 详情失败 (Failed to fetch role details for ID ${t}):`,e),await c.PC.logAuditEvent({userId:o,action:"ROLE_READ_FAILURE_DB_ERROR",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:`Failed to fetch role details for ID ${t}.`,metadata:{error:e.message}}),n.NextResponse.json({message:`获取角色详情时发生错误 (An error occurred while retrieving role details for ID ${t})`},{status:500})}}async function I(e,{authContext:r,params:s}){let t,{roleId:o}=s,a=r.user_id,i=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,d=e.headers.get("user-agent")||void 0;try{t=await e.json()}catch(e){return await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_FAILURE_INVALID_JSON",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Invalid JSON request body for role update (PUT).",metadata:{error:e.message}}),n.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let l=m.safeParse(t);if(!l.success)return await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_FAILURE_VALIDATION",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Role update payload validation failed (PUT).",metadata:{issues:l.error.format(),receivedBody:t}}),n.NextResponse.json({message:"更新角色信息验证失败 (Role update input validation failed)",errors:l.error.format()},{status:400});if(0===Object.keys(l.data).length)return await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_FAILURE_EMPTY_BODY",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"At least one field to update is required (PUT)."}),n.NextResponse.json({message:"请求体中至少需要一个待更新的字段 (At least one field to update is required in the request body)"},{status:400});try{let e=await u.prisma.role.findUnique({where:{id:o}});if(!e)return await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_FAILURE_NOT_FOUND",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Role not found to update (PUT)."}),n.NextResponse.json({message:"角色未找到，无法更新 (Role not found, cannot update)"},{status:404});if(E.includes(e.name)&&!1===l.data.isActive&&"SYSTEM_ADMIN"===e.name)return await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_FAILURE_SYSTEM_ROLE_DEACTIVATION",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Attempted to deactivate SYSTEM_ADMIN role.",metadata:{roleName:e.name}}),n.NextResponse.json({message:"禁止操作：不能停用 SYSTEM_ADMIN 角色 (Forbidden: Cannot deactivate the SYSTEM_ADMIN role)"},{status:403});if(t.name&&t.name!==e.name)return await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_FAILURE_NAME_MODIFICATION",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Modifying the role name is not allowed.",metadata:{attemptedName:t.name,currentName:e.name}}),n.NextResponse.json({message:"禁止操作：不允许修改角色名称 (Forbidden: Modifying the role name is not allowed)"},{status:400});let{rolePermissions:r,...s}=await u.prisma.role.update({where:{id:o},data:l.data,include:{rolePermissions:{include:{permission:!0}}}}),p={...s,permissions:r.map(e=>e.permission)};return await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_SUCCESS",resource:`Role:${o}`,success:!0,ipAddress:i,userAgent:d,metadata:{updatedData:l.data}}),n.NextResponse.json(p)}catch(e){return console.error(`更新角色 ${o} 失败 (Failed to update role ${o}):`,e),await c.PC.logAuditEvent({userId:a,action:"ROLE_UPDATE_FAILURE_SERVER_ERROR",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Server error during role update (PUT).",metadata:{error:e.message}}),n.NextResponse.json({message:`更新角色时发生服务器错误 (Server error occurred while updating role for ID ${o})`},{status:500})}}async function A(e,{authContext:r,params:s}){let{roleId:t}=s,o=r.user_id,a=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,i=e.headers.get("user-agent")||void 0;try{let e=await u.prisma.role.findUnique({where:{id:t}});if(!e)return await c.PC.logAuditEvent({userId:o,action:"ROLE_DELETE_FAILURE_NOT_FOUND",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Role not found to delete."}),n.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});if(E.includes(e.name))return await c.PC.logAuditEvent({userId:o,action:"ROLE_DELETE_FAILURE_CORE_SYSTEM_ROLE",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Attempted to delete a core system role.",metadata:{roleName:e.name}}),n.NextResponse.json({message:"禁止操作：不能删除核心系统角色 (Forbidden: Cannot delete core system roles)"},{status:403});let r=await u.prisma.userRole.count({where:{roleId:t}});if(r>0)return await c.PC.logAuditEvent({userId:o,action:"ROLE_DELETE_FAILURE_IN_USE",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Role is still assigned to users.",metadata:{usersCount:r}}),n.NextResponse.json({message:`角色正在使用中，无法删除 (Role is in use by ${r} users and cannot be deleted)`},{status:409});return await u.prisma.$transaction(async e=>{await e.rolePermission.deleteMany({where:{roleId:t}}),await e.role.delete({where:{id:t}})}),await c.PC.logAuditEvent({userId:o,action:"ROLE_DELETE_SUCCESS",resource:`Role:${t}`,success:!0,ipAddress:a,userAgent:i,metadata:{deletedRoleName:e.name}}),new n.NextResponse(null,{status:204})}catch(e){return console.error(`删除角色 ${t} 失败 (Failed to delete role ${t}):`,e),await c.PC.logAuditEvent({userId:o,action:"ROLE_DELETE_FAILURE_SERVER_ERROR",resource:`Role:${t}`,success:!1,ipAddress:a,userAgent:i,errorMessage:"Server error during role deletion.",metadata:{error:e.message}}),n.NextResponse.json({message:`删除角色时发生错误 (An error occurred while deleting role for ID ${t})`},{status:500})}}async function _(e,{authContext:r,params:s}){let t,{roleId:o}=s,a=r.user_id,i=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,d=e.headers.get("user-agent")||void 0;try{t=await e.json()}catch(e){return await c.PC.logAuditEvent({userId:a,action:"ROLE_PATCH_FAILURE_INVALID_JSON",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Invalid JSON request body for role patch.",metadata:{error:e.message}}),n.NextResponse.json({message:"无效的JSON请求体"},{status:400})}let l=g.safeParse(t);if(!l.success)return await c.PC.logAuditEvent({userId:a,action:"ROLE_PATCH_FAILURE_VALIDATION",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Role patch payload validation failed.",metadata:{issues:l.error.format(),receivedBody:t}}),n.NextResponse.json({message:"更新角色信息验证失败",errors:l.error.format()},{status:400});let{displayName:p,description:m,isActive:R,permissionIds:I}=l.data;if(0===Object.keys(l.data).length)return await c.PC.logAuditEvent({userId:a,action:"ROLE_PATCH_FAILURE_EMPTY_BODY",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"At least one field to update is required for PATCH."}),n.NextResponse.json({message:"请求体中至少需要一个待更新的字段"},{status:400});try{let e=await u.prisma.role.findUnique({where:{id:o}});if(!e)return await c.PC.logAuditEvent({userId:a,action:"ROLE_PATCH_FAILURE_NOT_FOUND",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Role not found to patch."}),n.NextResponse.json({message:"角色未找到，无法更新"},{status:404});if(E.includes(e.name)&&!1===R&&"SYSTEM_ADMIN"===e.name)return await c.PC.logAuditEvent({userId:a,action:"ROLE_PATCH_FAILURE_SYSTEM_ROLE_DEACTIVATION",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Attempted to deactivate SYSTEM_ADMIN role via PATCH.",metadata:{roleName:e.name}}),n.NextResponse.json({message:"禁止操作：不能停用 SYSTEM_ADMIN 角色"},{status:403});if(t.name&&t.name!==e.name)return await c.PC.logAuditEvent({userId:a,action:"ROLE_PATCH_FAILURE_NAME_MODIFICATION",resource:`Role:${o}`,success:!1,ipAddress:i,userAgent:d,errorMessage:"Modifying the role name is not allowed (PATCH).",metadata:{attemptedName:t.name,currentName:e.name}}),n.NextResponse.json({message:"禁止操作：不允许修改角色名称"},{status:400});let r=await u.prisma.$transaction(async e=>{let r={};if(void 0!==p&&(r.displayName=p),void 0!==m&&(r.description=m),void 0!==R&&(r.isActive=R),Object.keys(r).length>0&&await e.role.update({where:{id:o},data:r}),void 0!==I){if(I.length>0&&await e.permission.count({where:{id:{in:I}}})!==I.length)throw Error("One or more provided permissionIds are invalid or do not exist.");await e.rolePermission.deleteMany({where:{roleId:o}}),I.length>0&&await e.rolePermission.createMany({data:I.map(e=>({roleId:o,permissionId:e}))})}return e.role.findUnique({where:{id:o},include:{rolePermissions:{include:{permission:!0}}}})});if(!r)throw Error("Role update failed post-transaction.");let{rolePermissions:s,...g}=r,A={...g,permissions:s.map(e=>e.permission)};return await c.PC.logAuditEvent({userId:a,action:"ROLE_PATCH_SUCCESS",resource:`Role:${o}`,success:!0,ipAddress:i,userAgent:d,metadata:{roleId:o,updatedFields:Object.keys(l.data),assignedPermissionIds:I}}),n.NextResponse.json(A)}catch(t){console.error(`更新角色 ${o} 失败:`,t);let e=`An error occurred while patching role for ID ${o}`,r="ROLE_PATCH_FAILURE_DB_ERROR",s=500;return t.message.toLowerCase().includes("permissionids are invalid")&&(e=t.message,r="ROLE_PATCH_FAILURE_INVALID_PERMISSIONS_IN_TX",s=400),await c.PC.logAuditEvent({userId:a,action:r,success:!1,ipAddress:i,userAgent:d,errorMessage:e,metadata:{error:t.message,errorCode:t.code,attemptedData:l.data}}),n.NextResponse.json({message:e},{status:s})}}let f=(0,l.Uj)((0,d.ru)(R,{requiredPermissions:["role:read"]})),h=(0,l.Uj)((0,d.ru)(I,{requiredPermissions:["role:update"]})),v=(0,l.Uj)((0,d.ru)(A,{requiredPermissions:["role:delete"]})),x=(0,l.Uj)((0,d.ru)(_,{requiredPermissions:["role:update"]})),w=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v2/roles/[roleId]/route",pathname:"/api/v2/roles/[roleId]",filename:"route",bundlePath:"app/api/v2/roles/[roleId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/[roleId]/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:P,workUnitAsyncStorage:N,serverHooks:S}=w;function T(){return(0,i.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:N})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,r,s)=>{"use strict";s.d(r,{A:()=>u});var t=s(55511);let o={randomUUID:t.randomUUID},a=new Uint8Array(256),i=a.length,n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let u=function(e,r,s){if(o.randomUUID&&!r&&!e)return o.randomUUID();let u=(e=e||{}).random??e.rng?.()??(i>a.length-16&&((0,t.randomFillSync)(a),i=0),a.slice(i,i+=16));if(u.length<16)throw Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,r){if((s=s||0)<0||s+16>r.length)throw RangeError(`UUID byte range ${s}:${s+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[s+e]=u[e];return r}return function(e,r=0){return(n[e[r+0]]+n[e[r+1]]+n[e[r+2]]+n[e[r+3]]+"-"+n[e[r+4]]+n[e[r+5]]+"-"+n[e[r+6]]+n[e[r+7]]+"-"+n[e[r+8]]+n[e[r+9]]+"-"+n[e[r+10]]+n[e[r+11]]+n[e[r+12]]+n[e[r+13]]+n[e[r+14]]+n[e[r+15]]).toLowerCase()}(u)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[938,176,733,200,344,706,855,281],()=>s(60102));module.exports=t})();