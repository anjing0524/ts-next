"use strict";(()=>{var e={};e.id=102,e.ids=[102],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},23040:(e,t,r)=>{r.d(t,{i:()=>n});var s=r(88022),i=r(55937),a=r(46159),o=r(1047);function n(e){let t,r;if("string"!=typeof e)throw new o.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:n,length:l}=e.split(".");if(5===l)throw new o.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==l)throw new o.Dp("Invalid JWT");if(!n)throw new o.Dp("JWTs must contain a payload");try{t=(0,s.D)(n)}catch{throw new o.Dp("Failed to base64url decode the payload")}try{r=JSON.parse(i.D0.decode(t))}catch{throw new o.Dp("Failed to parse the decoded payload as JSON")}if(!(0,a.A)(r))throw new o.Dp("Invalid JWT Claims Set");return r}},24931:(e,t,r)=>{r.d(t,{CE:()=>s.CE,Fw:()=>s.Fw,gz:()=>s.gz,j1:()=>s.j1});var s=r(55807)},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31551:(e,t,r)=>{r.d(t,{B:()=>d});var s=r(23040),i=r(97151),a=r(27819),o=r(1047),n=r(34621),l=r(24931);class d{static async authenticateClient(e,t){let r=t.get("client_id"),s=t.get("client_secret"),i=t.get("client_assertion_type"),a=t.get("client_assertion"),o=e.headers.get("authorization");if(o&&o.toLowerCase().startsWith("basic "))try{let e=o.slice(6),[t,i]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&i&&(r=r||t,s=s||i)}catch{throw new l.gz("Invalid Basic authentication header format.",l.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===i&&a)return await this.authenticateWithJWT(a,e);if(r&&s)return await this.authenticateWithSecret(r,s);if(r&&!s){let e=await n.prisma.oAuthClient.findUnique({where:{clientId:r,isActive:!0}});if(!e)throw new l.gz("Client not found.",l.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new l.gz("客户端不是公开客户端，需要身份验证",l.Fw.InvalidClient,401);return e}throw new l.gz("Client authentication required but not provided or method not supported.",l.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let s=await n.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!s)throw new l.gz("Invalid client ID or client not active.",l.Fw.InvalidClient,401);if("PUBLIC"===s.clientType)throw new l.gz("公开客户端试图使用密钥进行身份验证",l.Fw.InvalidClient,400);if(!s.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new l.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(r.t.bind(r,5486,23));if(!await e.compare(t,s.clientSecret))throw new l.gz("客户端密钥无效",l.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new l.j1("客户端密钥验证期间发生错误")}return s}static async authenticateWithJWT(e,t){try{let r=s.i(e);if(!r.iss||!r.sub||r.iss!==r.sub)throw new l.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",l.Fw.InvalidClient,400);let o=r.iss,d=await n.prisma.oAuthClient.findUnique({where:{clientId:o,isActive:!0}});if(!d)throw new l.gz("Client specified in JWT assertion not found or not active.",l.Fw.InvalidClient,401);if(!d.jwksUri)throw new l.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let u=this.getTokenEndpointUrl(t),c=i.RD(new URL(d.jwksUri));return await a.V(e,c,{issuer:o,audience:u,algorithms:["RS256","ES256","PS256"]}),d}catch(r){console.error("Client JWT assertion validation failed:",r);let e="Client assertion validation failed.",t=l.Fw.InvalidClient;if(r instanceof o.n)e="Client assertion has expired.",t=l.Fw.InvalidGrant;else if(r instanceof o.ie)e=`Client assertion claim validation failed: ${r.claim} ${r.reason}.`;else if(r instanceof o.h2)e="Client assertion signature verification failed.";else if(r instanceof l.j1)throw r;throw new l.gz(e,t,400,void 0,{originalError:r.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),r=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),s=e.headers.get("x-forwarded-host")||t.host,i=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${r}://${s}${i}`}}},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51041:(e,t,r)=>{r.d(t,{P:()=>n,B:()=>s.B});var s=r(31551),i=r(55511),a=r(34621),o=r(84344);class n{static validateRedirectUri(e,t){return t.includes(e)}static validateResponseType(e,t=["code"]){return t.includes(e)}static generateState(){return i.randomBytes(32).toString("base64url")}static generateNonce(){return i.randomBytes(32).toString("base64url")}static generateAuthorizationCode(){return i.randomBytes(32).toString("hex")}static async logAuditEvent(e){try{let t="SYSTEM",r="system";if(e.userId)t="USER",r=e.userId;else if(e.clientId){t="CLIENT";let s=await a.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});r=s?s.clientId:e.clientId}let s=e.success;void 0===s&&(s=e.status?"SUCCESS"===e.status:!e.errorMessage),await a.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:r||"unknown",status:s?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:this.buildDetailsJson(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}}static buildDetailsJson(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let r=JSON.parse(e.details);t={...t,...r}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}static async getUserPermissions(e){try{let t=await o.S.getUserPermissions(e),r=new Set(t?.permissions||[]);return Array.from(r)}catch(e){return console.error("Error getting user permissions:",e),[]}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},60102:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>S,routeModule:()=>_,serverHooks:()=>y,workAsyncStorage:()=>A,workUnitAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{DELETE:()=>v,GET:()=>f,PATCH:()=>R});var i=r(19227),a=r(39044),o=r(11131),n=r(57642),l=r(93952),d=r(96330),u=r(96800),c=r(28064),p=r(51041),m=r(67200);m.z.object({displayName:m.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(100,"显示名称不能超过100个字符 (Display name cannot exceed 100 characters long)").optional(),description:m.z.string().max(255,"描述信息不能超过255个字符 (Description cannot exceed 255 characters long)").optional().nullable(),isActive:m.z.boolean().optional()});let g=["SYSTEM_ADMIN","USER","USER_ADMIN","PERMISSION_ADMIN","CLIENT_ADMIN","AUDIT_ADMIN"];async function h(e,t){let{roleId:r}=t.params,s=void 0,i=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,a=e.headers.get("user-agent")||void 0;try{let e=await l.z.role.findUnique({where:{id:r},include:{rolePermissions:{include:{permission:!0}}}});if(!e)return await p.P.logAuditEvent({userId:s?.id,action:"ROLE_READ_FAILURE_NOT_FOUND",resource:`Role:${r}`,success:!1,ipAddress:i,userAgent:a,errorMessage:"Role not found."}),n.NextResponse.json({message:"角色未找到 (Role not found)"},{status:404});let{rolePermissions:t,...o}=e,d={...o,permissions:t.map(e=>e.permission)};return await p.P.logAuditEvent({userId:s?.id,action:"ROLE_READ_SUCCESS",resource:`Role:${r}`,success:!0,ipAddress:i,userAgent:a,metadata:{roleName:e.name,returnedFields:Object.keys(d)}}),n.NextResponse.json(d)}catch(e){return console.error(`获取角色 ${r} 详情失败 (Failed to fetch role details for ID ${r}):`,e),await p.P.logAuditEvent({userId:s?.id,action:"ROLE_READ_FAILURE_DB_ERROR",resource:`Role:${r}`,success:!1,ipAddress:i,userAgent:a,errorMessage:`Failed to fetch role details for ID ${r}.`,metadata:{error:e.message}}),n.NextResponse.json({message:`获取角色详情时发生错误 (An error occurred while retrieving role details for ID ${r})`},{status:500})}}async function w(e,t){let{roleId:r}=t.params,s=void 0,i=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,a=e.headers.get("user-agent")||void 0;try{let e=await l.z.role.findUnique({where:{id:r}});if(!e)return await p.P.logAuditEvent({userId:s?.id,action:"ROLE_DELETE_FAILURE_NOT_FOUND",resource:`Role:${r}`,success:!1,ipAddress:i,userAgent:a,errorMessage:"Role not found to delete."}),n.NextResponse.json({message:"角色未找到，无法删除 (Role not found, cannot delete)"},{status:404});if(g.includes(e.name))return await p.P.logAuditEvent({userId:s?.id,action:"ROLE_DELETE_FAILURE_CORE_SYSTEM_ROLE",resource:`Role:${r}`,success:!1,ipAddress:i,userAgent:a,errorMessage:`Attempted to delete core system role: ${e.name}.`,metadata:{roleName:e.name}}),n.NextResponse.json({message:`核心系统角色 "${e.name}" 不能被删除 (Core system role "${e.name}" cannot be deleted)`},{status:403});let t=await l.z.userRole.count({where:{roleId:r}});if(t>0)return await p.P.logAuditEvent({userId:s?.id,action:"ROLE_DELETE_FAILURE_IN_USE",resource:`Role:${r}`,success:!1,ipAddress:i,userAgent:a,errorMessage:`Role "${e.name}" is still in use by ${t} users.`,metadata:{roleName:e.name,userCount:t}}),n.NextResponse.json({message:`角色 "${e.name}" 仍被 ${t} 个用户使用，无法删除 (Role "${e.name}" is still in use by ${t} users and cannot be deleted)`},{status:409});return await l.z.role.delete({where:{id:r}}),await p.P.logAuditEvent({userId:s?.id,action:"ROLE_DELETE_SUCCESS",resource:`Role:${r}`,success:!0,ipAddress:i,userAgent:a,metadata:{deletedRoleId:r,roleName:e.name}}),new n.NextResponse(null,{status:204})}catch(o){console.error(`删除角色 ${r} 失败 (Failed to delete role ${r}):`,o);let e=`An error occurred while deleting role for ID ${r}`,t="ROLE_DELETE_FAILURE_DB_ERROR";if(o instanceof d.Prisma.PrismaClientKnownRequestError&&"P2003"===o.code&&(e="Cannot delete role as it is still referenced by other records (e.g., permission assignments)",t="ROLE_DELETE_FAILURE_FOREIGN_KEY"),await p.P.logAuditEvent({userId:s?.id,action:t,success:!1,ipAddress:i,userAgent:a,errorMessage:e,metadata:{error:o.message,roleId:r}}),"ROLE_DELETE_FAILURE_FOREIGN_KEY"===t)return n.NextResponse.json({message:e},{status:409});return n.NextResponse.json({message:`删除角色时发生错误 (An error occurred while deleting role for ID ${r})`},{status:500})}}let f=(0,c.Uj)((0,u.ru)(async(e,t)=>{let r=new URL(e.url).pathname.split("/");return h(e,{params:{roleId:r[r.length-1]||""},authContext:t})},{requiredPermissions:["roles:read"]})),E=m.z.object({displayName:m.z.string().min(1).max(100).optional(),description:m.z.string().max(255).optional().nullable(),isActive:m.z.boolean().optional(),permissionIds:m.z.array(m.z.string().cuid("无效的权限ID格式")).optional()});async function I(e,t){let r,{roleId:s}=t.params,i=void 0,a=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,o=e.headers.get("user-agent")||void 0;try{r=await e.json()}catch(e){return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PATCH_FAILURE_INVALID_JSON",resource:`Role:${s}`,success:!1,ipAddress:a,userAgent:o,errorMessage:"Invalid JSON request body for role patch.",metadata:{error:e.message}}),n.NextResponse.json({message:"无效的JSON请求体"},{status:400})}let d=E.safeParse(r);if(!d.success)return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PATCH_FAILURE_VALIDATION",resource:`Role:${s}`,success:!1,ipAddress:a,userAgent:o,errorMessage:"Role patch payload validation failed.",metadata:{issues:d.error.format(),receivedBody:r}}),n.NextResponse.json({message:"更新角色信息验证失败",errors:d.error.format()},{status:400});let{displayName:u,description:c,isActive:m,permissionIds:h}=d.data;if(0===Object.keys(d.data).length)return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PATCH_FAILURE_EMPTY_BODY",resource:`Role:${s}`,success:!1,ipAddress:a,userAgent:o,errorMessage:"At least one field to update is required for PATCH."}),n.NextResponse.json({message:"请求体中至少需要一个待更新的字段"},{status:400});try{let e=await l.z.role.findUnique({where:{id:s}});if(!e)return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PATCH_FAILURE_NOT_FOUND",resource:`Role:${s}`,success:!1,ipAddress:a,userAgent:o,errorMessage:"Role not found to patch."}),n.NextResponse.json({message:"角色未找到，无法更新"},{status:404});if(g.includes(e.name)&&!1===m&&"SYSTEM_ADMIN"===e.name)return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PATCH_FAILURE_SYSTEM_ROLE_DEACTIVATION",resource:`Role:${s}`,success:!1,ipAddress:a,userAgent:o,errorMessage:"Attempted to deactivate SYSTEM_ADMIN role via PATCH.",metadata:{roleName:e.name}}),n.NextResponse.json({message:"禁止操作：不能停用 SYSTEM_ADMIN 角色"},{status:403});if(r.name&&r.name!==e.name)return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PATCH_FAILURE_NAME_MODIFICATION",resource:`Role:${s}`,success:!1,ipAddress:a,userAgent:o,errorMessage:"Modifying the role name is not allowed (PATCH).",metadata:{attemptedName:r.name,currentName:e.name}}),n.NextResponse.json({message:"禁止操作：不允许修改角色名称"},{status:400});let t=await l.z.$transaction(async e=>{let t={};if(void 0!==u&&(t.displayName=u),void 0!==c&&(t.description=c),void 0!==m&&(t.isActive=m),Object.keys(t).length>0&&await e.role.update({where:{id:s},data:t}),void 0!==h){if(h.length>0){let t=await e.permission.count({where:{id:{in:h}}});if(t!==h.length)throw Error(`One or more provided permissionIds are invalid or do not exist. Found ${t} valid IDs out of ${h.length}.`)}await e.rolePermission.deleteMany({where:{roleId:s}}),h.length>0&&await e.rolePermission.createMany({data:h.map(e=>({roleId:s,permissionId:e}))})}return e.role.findUnique({where:{id:s},include:{rolePermissions:{include:{permission:!0}}}})});if(!t)throw Error("Role update failed post-transaction somehow.");let{rolePermissions:w,...f}=t,E={...f,permissions:w.map(e=>e.permission)};return await p.P.logAuditEvent({userId:i?.id,action:"ROLE_PATCH_SUCCESS",resource:`Role:${s}`,success:!0,ipAddress:a,userAgent:o,metadata:{roleId:s,updatedFields:Object.keys(d.data),assignedPermissionIds:h}}),n.NextResponse.json(E)}catch(l){console.error(`更新角色 ${s} 失败:`,l);let e=`An error occurred while patching role for ID ${s}`,t="ROLE_PATCH_FAILURE_DB_ERROR",r=500;return l.message.toLowerCase().includes("permissionids are invalid")&&(e=l.message,t="ROLE_PATCH_FAILURE_INVALID_PERMISSIONS_IN_TX",r=400),await p.P.logAuditEvent({userId:i?.id,action:t,success:!1,ipAddress:a,userAgent:o,errorMessage:e,metadata:{error:l.message,errorCode:l.code,attemptedData:d.data}}),n.NextResponse.json({message:e},{status:r})}}let R=(0,c.Uj)((0,u.ru)(async(e,t)=>{let r=new URL(e.url).pathname.split("/");return I(e,{params:{roleId:r[r.length-1]||""}})},{requiredPermissions:["roles:update"]})),v=(0,c.Uj)((0,u.ru)(async(e,t)=>{let r=new URL(e.url).pathname.split("/");return w(e,{params:{roleId:r[r.length-1]||""}})},{requiredPermissions:["roles:delete"]})),_=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v2/roles/[roleId]/route",pathname:"/api/v2/roles/[roleId]",filename:"route",bundlePath:"app/api/v2/roles/[roleId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/roles/[roleId]/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:A,workUnitAsyncStorage:x,serverHooks:y}=_;function S(){return(0,o.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:x})}},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},93952:(e,t,r)=>{r.d(t,{z:()=>s.prisma});var s=r(34621)},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")},96800:(e,t,r)=>{r.d(t,{NC:()=>l,ru:()=>d});var s=r(57642),i=r(97151),a=r(27819),o=r(1047),n=r(24958);async function l(e,t={}){let r,d=e.headers.get("authorization");if(!d||!d.startsWith("Bearer "))return t.allowPublicAccess?{success:!0}:{success:!1,response:s.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let u=d.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let t=i.RD(new URL(e)),s=process.env.JWT_ISSUER,o=process.env.JWT_AUDIENCE;if(!s||!o)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");r=(await a.V(u,t,{issuer:s,audience:o,algorithms:["RS256"]})).payload}catch(t){console.error("JWT 验证失败 (JWT validation failed):",t);let e="Token validation failed";return t instanceof o.n?e=`Token expired at ${new Date(1e3*t.payload.exp).toISOString()}`:t instanceof o.ie?e=`Token claim validation failed: ${t.claim} ${t.reason}`:t instanceof o.T0||t instanceof o._L?e="Invalid token algorithm or key issue.":t instanceof Error&&(t.message.includes("JWKS")||t.message.includes("configured"))&&(e=`Token validation setup error: ${t.message}`),{success:!1,response:s.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let c=r.sub,p=r.client_id,m=r.scope?.split(" ")||[],g=r.permissions||[];if(t.requiredScopes&&t.requiredScopes.length>0&&!t.requiredScopes.every(e=>m.includes(e)))return{success:!1,response:s.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${t.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${t.requiredScopes.join(" ")}"`}})};if(t.requiredPermissions&&t.requiredPermissions.length>0&&!t.requiredPermissions.every(e=>g.includes(e)))return{success:!1,response:s.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${t.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let h={user_id:c,client_id:p,scopes:m,permissions:g,tokenPayload:r};if(t.requireUserContext&&c)try{let e=await n.z.user.findUnique({where:{id:c,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(h.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("获取用户信息失败 (Failed to fetch user information):",e)}return{success:!0,context:h}}function d(e,t={}){return async function(r){let i=await l(r,t);return i.success?i.context?e(r,i.context):s.NextResponse.json({error:"authentication_failed",error_description:"Authentication context missing"},{status:500}):i.response||s.NextResponse.json({error:"authentication_failed",error_description:"Authentication failed"},{status:401})}}new(r(28064)).n1(n.z)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[938,176,344,196,578,987,466,855,119,64],()=>r(60102));module.exports=s})();