"use strict";(()=>{var e={};e.id=245,e.ids=[245,890],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},15547:(e,t,i)=>{i.d(t,{_P:()=>n,s0:()=>r});let r=36e5,n=Symbol.for("constructDateFrom")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},23040:(e,t,i)=>{i.d(t,{i:()=>s});var r=i(88022),n=i(55937),o=i(46159),a=i(1047);function s(e){let t,i;if("string"!=typeof e)throw new a.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:s,length:d}=e.split(".");if(5===d)throw new a.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==d)throw new a.Dp("Invalid JWT");if(!s)throw new a.Dp("JWTs must contain a payload");try{t=(0,r.D)(s)}catch{throw new a.Dp("Failed to base64url decode the payload")}try{i=JSON.parse(n.D0.decode(t))}catch{throw new a.Dp("Failed to parse the decoded payload as JSON")}if(!(0,o.A)(i))throw new a.Dp("Invalid JWT Claims Set");return i}},24931:(e,t,i)=>{i.d(t,{CE:()=>r.CE,Fw:()=>r.Fw,gz:()=>r.gz,j1:()=>r.j1});var r=i(55807)},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},29368:(e,t,i)=>{i.r(t),i.d(t,{patchFetch:()=>C,routeModule:()=>m,serverHooks:()=>_,workAsyncStorage:()=>I,workUnitAsyncStorage:()=>y});var r={};i.r(r),i.d(r,{GET:()=>g,POST:()=>v});var n=i(19227),o=i(39044),a=i(11131),s=i(57642),d=i(93952),c=i(51041),l=i(50595),u=i(71890),p=i(89343),h=i(24931);async function w(e){let t=e.user;if(!t||!t.id)throw new h.j1("User context not found after permission check.");let i=t.id,r=await d.z.user.findUnique({where:{id:i,isActive:!0}});if(!r)throw new h.CE("Authenticated user not found or inactive. Please re-authenticate.","AUTH_USER_INVALID_CONSENT_GET",{userId:i});let{searchParams:n}=new URL(e.url),o=n.get("client_id"),a=n.get("redirect_uri"),u=n.get("scope"),p=n.get("state"),w=n.get("response_type"),f=n.get("code_challenge"),g=n.get("code_challenge_method"),v=n.get("nonce");if(!o||!a||!u||!w)throw new h.gz("Missing required parameters from authorization server.",h.Fw.InvalidRequest,400,void 0,{missing:[!o&&"client_id",!a&&"redirect_uri",!u&&"scope",!w&&"response_type"].filter(Boolean)});if("code"!==w)throw new h.gz('Invalid response_type from authorization server: must be "code".',h.Fw.InvalidRequest,400,void 0,{responseType:w});let m=await d.z.oAuthClient.findUnique({where:{clientId:o}});if(!m||!m.isActive)throw new h.gz("Third-party client not found or is not active.",h.Fw.InvalidRequest,403,void 0,{clientId:o});let I=[];try{if(I=JSON.parse(m.redirectUris),!Array.isArray(I))throw Error("Redirect URIs are not an array.")}catch(e){throw console.error(`Failed to parse redirectUris for client ${o}:`,e),new h.j1("Server error: Invalid client configuration for redirectUris.",{clientId:o})}if(!c.P.validateRedirectUri(a,I))throw new h.gz("Provided redirect_uri is not registered for this client.",h.Fw.InvalidRequest,400,void 0,{redirectUri:a,registered:I});let y=l.e8.parseScopes(u),_=(await d.z.scope.findMany({where:{name:{in:y},isActive:!0}})).map(e=>({name:e.name,description:e.description||"No description available for this permission."}));if(_.length!==y.length){let e=_.map(e=>e.name),t=y.filter(t=>!e.includes(t));throw new h.gz(`The following requested permissions are invalid or inactive: ${t.join(", ")}. Please contact the application developer.`,h.Fw.InvalidRequest,400,void 0,{missingScopes:t})}let C={client:{id:m.clientId,name:m.name||m.clientId,logoUri:m.logoUri},requested_scopes:_,user:{id:r.id,username:r.username},consent_form_action_url:"/api/v2/oauth/consent",client_id:o,redirect_uri:a,scope:u,state:p||void 0,response_type:w,code_challenge:f||void 0,code_challenge_method:g||void 0,nonce:v||void 0};return s.NextResponse.json({success:!0,data:C,message:"Consent data retrieved successfully."},{status:200})}async function f(e){let t,i=e.user;if(!i||!i.id)throw new h.j1("User context not found after permission check.");let r=i.id,n=await d.z.user.findUnique({where:{id:r,isActive:!0}});if(!n)throw new h.CE("Authenticated user not found or inactive.","AUTH_USER_INVALID_CONSENT_POST",{userId:r});let o=e.headers.get("content-type");if(o?.includes("application/x-www-form-urlencoded"))t=await e.formData();else if(o?.includes("application/json"))t=await e.json();else throw new h.gz("Unsupported Content-Type. Please use application/x-www-form-urlencoded or application/json.",h.Fw.InvalidRequest,415,void 0,{});let a="function"==typeof t.get?t.get("decision"):t.decision,p="function"==typeof t.get?t.get("client_id"):t.client_id,w="function"==typeof t.get?t.get("scope"):t.scope,f="function"==typeof t.get?t.get("state"):t.state,g="function"==typeof t.get?t.get("redirect_uri"):t.redirect_uri,v="function"==typeof t.get?t.get("response_type"):t.response_type,m="function"==typeof t.get?t.get("code_challenge"):t.code_challenge,I="function"==typeof t.get?t.get("code_challenge_method"):t.code_challenge_method,y="function"==typeof t.get?t.get("nonce"):t.nonce;if(!a||!p||!w||!g||!v)throw new h.gz("Missing required form fields from consent submission.",h.Fw.InvalidRequest,400,void 0,{missing:[!a&&"decision",!p&&"client_id",!w&&"scope",!g&&"redirect_uri",!v&&"response_type"].filter(Boolean)});if("code"!==v)throw new h.gz('Invalid response_type submitted from consent form: must be "code".',h.Fw.InvalidRequest,400,void 0,{responseType:v});let _=await d.z.oAuthClient.findUnique({where:{clientId:p}});if(!_||!_.isActive)throw new h.gz("Client specified in consent form not found or is not active.",h.Fw.InvalidRequest,403,void 0,{clientId:p});let C=[];try{C=JSON.parse(_.redirectUris)}catch(e){}if(!c.P.validateRedirectUri(g,C))throw new h.gz("Invalid redirect_uri submitted from consent form for this client.",h.Fw.InvalidRequest,400,void 0,{redirectUri:g});let U=new URL(g);if(f&&U.searchParams.set("state",f),"deny"===a)return U.searchParams.set("error",h.Fw.AccessDenied),U.searchParams.set("error_description","The user denied access to the requested resources."),s.NextResponse.redirect(U.toString(),302);if("allow"===a){let e=l.e8.parseScopes(w);await d.z.consentGrant.upsert({where:{userId_clientId:{userId:n.id,clientId:_.id}},update:{scopes:l.e8.formatScopes(e),issuedAt:new Date,revokedAt:null},create:{userId:n.id,clientId:_.id,scopes:l.e8.formatScopes(e)}});let t=await (0,u.storeAuthorizationCode)(n.id,_.id,g,m||void 0,I||void 0,l.e8.formatScopes(e),_.authorizationCodeLifetime||void 0,y||void 0);return U.searchParams.set("code",t.code),s.NextResponse.redirect(U.toString(),302)}throw new h.gz('Invalid decision value submitted. Must be "allow" or "deny".',h.Fw.InvalidRequest,400,void 0,{decision:a})}let g=(0,p.U)(w),v=(0,p.U)(f),m=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/oauth/consent/route",pathname:"/api/v2/oauth/consent",filename:"route",bundlePath:"app/api/v2/oauth/consent/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/consent/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:I,workUnitAsyncStorage:y,serverHooks:_}=m;function C(){return(0,a.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:y})}},31551:(e,t,i)=>{i.d(t,{B:()=>c});var r=i(23040),n=i(97151),o=i(27819),a=i(1047),s=i(34621),d=i(24931);class c{static async authenticateClient(e,t){let i=t.get("client_id"),r=t.get("client_secret"),n=t.get("client_assertion_type"),o=t.get("client_assertion"),a=e.headers.get("authorization");if(a&&a.toLowerCase().startsWith("basic "))try{let e=a.slice(6),[t,n]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&n&&(i=i||t,r=r||n)}catch{throw new d.gz("Invalid Basic authentication header format.",d.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===n&&o)return await this.authenticateWithJWT(o,e);if(i&&r)return await this.authenticateWithSecret(i,r);if(i&&!r){let e=await s.prisma.oAuthClient.findUnique({where:{clientId:i,isActive:!0}});if(!e)throw new d.gz("Client not found.",d.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new d.gz("客户端不是公开客户端，需要身份验证",d.Fw.InvalidClient,401);return e}throw new d.gz("Client authentication required but not provided or method not supported.",d.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let r=await s.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!r)throw new d.gz("Invalid client ID or client not active.",d.Fw.InvalidClient,401);if("PUBLIC"===r.clientType)throw new d.gz("公开客户端试图使用密钥进行身份验证",d.Fw.InvalidClient,400);if(!r.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new d.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(i.t.bind(i,5486,23));if(!await e.compare(t,r.clientSecret))throw new d.gz("客户端密钥无效",d.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new d.j1("客户端密钥验证期间发生错误")}return r}static async authenticateWithJWT(e,t){try{let i=r.i(e);if(!i.iss||!i.sub||i.iss!==i.sub)throw new d.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",d.Fw.InvalidClient,400);let a=i.iss,c=await s.prisma.oAuthClient.findUnique({where:{clientId:a,isActive:!0}});if(!c)throw new d.gz("Client specified in JWT assertion not found or not active.",d.Fw.InvalidClient,401);if(!c.jwksUri)throw new d.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let l=this.getTokenEndpointUrl(t),u=n.RD(new URL(c.jwksUri));return await o.V(e,u,{issuer:a,audience:l,algorithms:["RS256","ES256","PS256"]}),c}catch(i){console.error("Client JWT assertion validation failed:",i);let e="Client assertion validation failed.",t=d.Fw.InvalidClient;if(i instanceof a.n)e="Client assertion has expired.",t=d.Fw.InvalidGrant;else if(i instanceof a.ie)e=`Client assertion claim validation failed: ${i.claim} ${i.reason}.`;else if(i instanceof a.h2)e="Client assertion signature verification failed.";else if(i instanceof d.j1)throw i;throw new d.gz(e,t,400,void 0,{originalError:i.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),i=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),r=e.headers.get("x-forwarded-host")||t.host,n=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${i}://${r}${n}`}}},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47625:(e,t,i)=>{i.d(t,{a:()=>n});var r=i(47923);function n(e,t){return(0,r.w)(t||e,e)}},47923:(e,t,i)=>{i.d(t,{w:()=>n});var r=i(15547);function n(e,t){return"function"==typeof e?e(t):e&&"object"==typeof e&&r._P in e?e[r._P](t):e instanceof Date?new e.constructor(t):new Date(t)}},49039:(e,t,i)=>{i.d(t,{A:()=>o});var r=i(47923),n=i(47625);function o(e,t,i){return(0,r.w)(i?.in||e,+(0,n.a)(e)+t)}},51041:(e,t,i)=>{i.d(t,{P:()=>s,B:()=>r.B});var r=i(31551),n=i(55511),o=i(34621),a=i(84344);class s{static validateRedirectUri(e,t){return t.includes(e)}static validateResponseType(e,t=["code"]){return t.includes(e)}static generateState(){return n.randomBytes(32).toString("base64url")}static generateNonce(){return n.randomBytes(32).toString("base64url")}static generateAuthorizationCode(){return n.randomBytes(32).toString("hex")}static async logAuditEvent(e){try{let t="SYSTEM",i="system";if(e.userId)t="USER",i=e.userId;else if(e.clientId){t="CLIENT";let r=await o.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});i=r?r.clientId:e.clientId}let r=e.success;void 0===r&&(r=e.status?"SUCCESS"===e.status:!e.errorMessage),await o.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:i||"unknown",status:r?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:this.buildDetailsJson(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}}static buildDetailsJson(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let i=JSON.parse(e.details);t={...t,...i}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}static async getUserPermissions(e){try{let t=await a.S.getUserPermissions(e),i=new Set(t?.permissions||[]);return Array.from(i)}catch(e){return console.error("Error getting user permissions:",e),[]}}}},55511:e=>{e.exports=require("crypto")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},71890:(e,t,i)=>{i.r(t),i.d(t,{DEFAULT_AUTHORIZATION_CODE_LIFETIME_SECONDS:()=>c,generateSecureRandomString:()=>l,storeAuthorizationCode:()=>u,validateAuthorizationCode:()=>p});var r=i(34621),n=i(49039),o=i(55511),a=i.n(o),s=i(55807),d=i(96330);let c=600;function l(e=32){return a().randomBytes(e).toString("hex")}async function u(e,t,i,o,a,d,p=c,h){var w;if("S256"!==a)throw new s.yI(`Unsupported code challenge method: ${a}. Only 'S256' is supported.`,{codeChallengeMethod:a},"UNSUPPORTED_CHALLENGE_METHOD");let f=l(32),g=(w=new Date,(0,n.A)(w,1e3*p,void 0));try{return await r.prisma.authorizationCode.create({data:{code:f,userId:e,clientId:t,redirectUri:i,scope:d,codeChallenge:o,codeChallengeMethod:a,expiresAt:g,isUsed:!1,nonce:h||null}})}catch(t){console.error("Failed to store authorization code:",t);let e=t instanceof Error?t.message:String(t);throw new s.iF("Database error while storing authorization code.",{originalError:e})}}async function p(e,t,i,n){let o=null;try{if(!(o=await r.prisma.authorizationCode.findUnique({where:{code:e}})))throw new s.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(o.isUsed)throw await r.prisma.authorizationCode.delete({where:{id:o.id}}),new s.jz("Invalid authorization code: Code has already been used.",{code:e},"AUTH_CODE_USED");if(o.expiresAt<new Date)throw await r.prisma.authorizationCode.delete({where:{id:o.id}}),new s.BX("Invalid authorization code: Code has expired.",{code:e,expiresAt:o.expiresAt});if(o.clientId!==t)throw new s.yI("Invalid authorization code: Client ID mismatch.",{expected:t,actual:o.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(o.redirectUri!==i)throw new s.yI("Invalid authorization code: Redirect URI mismatch.",{expected:i,actual:o.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===o.codeChallengeMethod){if(a().createHash("sha256").update(n).digest("base64url")!==o.codeChallenge)throw new s.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new s.yI(`Unsupported code challenge method in stored code: ${o.codeChallengeMethod}. Only 'S256' is supported.`,{storedMethod:o.codeChallengeMethod},"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await r.prisma.authorizationCode.update({where:{id:o.id},data:{isUsed:!0}})}catch(t){if(t instanceof s.Cf)throw t;console.error("Error during authorization code validation:",t);let e=t instanceof Error?t.message:String(t);if(t instanceof d.Prisma.PrismaClientKnownRequestError)throw new s.iF(`Database error during authorization code validation: ${e}`,{originalError:e,code:t.code});throw new s.iF("Database error during authorization code validation.",{originalError:e})}}},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},84344:(e,t,i)=>{i.d(t,{S:()=>n});var r=i(24958);class n{static async getUserPermissions(e){let t=await r.z.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{include:{role:{include:{rolePermissions:{include:{permission:!0}}}}}}}});if(!t)return null;let i=t.userRoles.map(e=>e.role.name),n=new Set;return t.userRoles.forEach(e=>{e.role.rolePermissions.forEach(e=>{n.add(e.permission.name)})}),{userId:t.id,roles:i,permissions:Array.from(n),organizationContext:{organization:t.organization||void 0,department:t.department||void 0}}}}},89343:(e,t,i)=>{i.d(t,{U:()=>r.Uj});var r=i(60123)},91645:e=>{e.exports=require("net")},93952:(e,t,i)=>{i.d(t,{z:()=>r.prisma});var r=i(34621)},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[938,176,196,578,987,855,119],()=>i(29368));module.exports=r})();