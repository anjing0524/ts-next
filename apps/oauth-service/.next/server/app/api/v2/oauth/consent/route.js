"use strict";(()=>{var e={};e.id=245,e.ids=[245,930],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1630:e=>{e.exports=require("http")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},2412:e=>{e.exports=require("assert")},2930:(e,t,r)=>{r.r(t),r.d(t,{DEFAULT_AUTHORIZATION_CODE_LIFETIME_SECONDS:()=>d,generateSecureRandomString:()=>c,storeAuthorizationCode:()=>u,validateAuthorizationCode:()=>l});var i=r(8891),o=r(9039),n=r(5511),s=r.n(n),a=r(4931);let d=600;function c(e=32){return s().randomBytes(e).toString("hex")}async function u(e,t,r,n,s,l,p=d,h){var w;if("S256"!==s)throw new a.j1(`Unsupported code challenge method: ${s}. Only 'S256' is supported.`);let f=c(32),v=(w=new Date,(0,o.A)(w,1e3*p,void 0));try{return await i.z.authorizationCode.create({data:{code:f,userId:e,clientId:t,redirectUri:r,scope:l,codeChallenge:n,codeChallengeMethod:s,expiresAt:v,isUsed:!1,nonce:h||null}})}catch(e){throw console.error("Failed to store authorization code:",e),new a.Cf("Database error while storing authorization code.",500,"DB_STORE_AUTH_CODE_FAILED")}}async function l(e,t,r,o){let n=null;try{if(!(n=await i.z.authorizationCode.findUnique({where:{code:e}})))throw new a.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(n.isUsed)throw await i.z.authorizationCode.delete({where:{id:n.id}}),new a.Pb("Invalid authorization code: Code has already been used.",400,"AUTH_CODE_USED");if(n.expiresAt<new Date)throw await i.z.authorizationCode.delete({where:{id:n.id}}),new a.Pb("Invalid authorization code: Code has expired.",400,"AUTH_CODE_EXPIRED");if(n.clientId!==t)throw new a.yI("Invalid authorization code: Client ID mismatch.",{expected:t,actual:n.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(n.redirectUri!==r)throw new a.yI("Invalid authorization code: Redirect URI mismatch.",{expected:r,actual:n.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===n.codeChallengeMethod){if(s().createHash("sha256").update(o).digest("base64url")!==n.codeChallenge)throw new a.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new a.j1(`Unsupported code challenge method in stored code: ${n.codeChallengeMethod}. Only 'S256' is supported.`,void 0,"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await i.z.authorizationCode.update({where:{id:n.id},data:{isUsed:!0}})}catch(e){if(e instanceof a.Cf)throw e;if(console.error("Error during authorization code validation:",e),e instanceof Prisma.PrismaClientKnownRequestError)throw new a.Cf(`Database error during authorization code validation: ${e.message}`,500,`DB_VALIDATE_AUTH_CODE_PRISMA_${e.code}`);throw new a.Cf("Database error during authorization code validation.",500,"DB_VALIDATE_AUTH_CODE_FAILED")}}},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},3997:e=>{e.exports=require("tty")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4985:e=>{e.exports=require("dns")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},5591:e=>{e.exports=require("https")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9343:(e,t,r)=>{r.d(t,{U:()=>i.Uj});var i=r(3117)},9368:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>C,routeModule:()=>_,serverHooks:()=>I,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>m});var i={};r.r(i),r.d(i,{GET:()=>f,POST:()=>v});var o=r(9227),n=r(9044),s=r(1131),a=r(7642),d=r(8891),c=r(9776),u=r(2930),l=r(9343),p=r(4931);async function h(e){let t=e.user;if(!t||!t.id)throw new p.j1("User context not found after permission check.");let r=t.id,i=await d.z.user.findUnique({where:{id:r,isActive:!0}});if(!i)throw new p.CE("Authenticated user not found or inactive. Please re-authenticate.","AUTH_USER_INVALID_CONSENT_GET",{userId:r});let{searchParams:o}=new URL(e.url),n=o.get("client_id"),s=o.get("redirect_uri"),u=o.get("scope"),l=o.get("state"),h=o.get("response_type"),w=o.get("code_challenge"),f=o.get("code_challenge_method"),v=o.get("nonce");if(!n||!s||!u||!h)throw new p.gz("Missing required parameters from authorization server.",p.Fw.InvalidRequest,400,void 0,{missing:[!n&&"client_id",!s&&"redirect_uri",!u&&"scope",!h&&"response_type"].filter(Boolean)});if("code"!==h)throw new p.gz('Invalid response_type from authorization server: must be "code".',p.Fw.InvalidRequest,400,void 0,{responseType:h});let _=await d.z.oAuthClient.findUnique({where:{clientId:n}});if(!_||!_.isActive)throw new p.gz("Third-party client not found or is not active.",p.Fw.InvalidRequest,403,void 0,{clientId:n});let g=[];try{if(g=JSON.parse(_.redirectUris),!Array.isArray(g))throw Error("Redirect URIs are not an array.")}catch(e){throw console.error(`Failed to parse redirectUris for client ${n}:`,e),new p.j1("Server error: Invalid client configuration for redirectUris.",{clientId:n})}if(!c.PC.validateRedirectUri(s,g))throw new p.gz("Provided redirect_uri is not registered for this client.",p.Fw.InvalidRequest,400,void 0,{redirectUri:s,registered:g});let m=c.e8.parseScopes(u),I=(await d.z.scope.findMany({where:{name:{in:m},isActive:!0}})).map(e=>({name:e.name,description:e.description||"No description available for this permission."}));if(I.length!==m.length){let e=I.map(e=>e.name),t=m.filter(t=>!e.includes(t));throw new p.gz(`The following requested permissions are invalid or inactive: ${t.join(", ")}. Please contact the application developer.`,p.Fw.InvalidRequest,400,void 0,{missingScopes:t})}let C={client:{id:_.clientId,name:_.name||_.clientId,logoUri:_.logoUri},requested_scopes:I,user:{id:i.id,username:i.username},consent_form_action_url:"/api/v2/oauth/consent",client_id:n,redirect_uri:s,scope:u,state:l||void 0,response_type:h,code_challenge:w||void 0,code_challenge_method:f||void 0,nonce:v||void 0};return a.NextResponse.json({success:!0,data:C,message:"Consent data retrieved successfully."},{status:200})}async function w(e){let t,r=e.user;if(!r||!r.id)throw new p.j1("User context not found after permission check.");let i=r.id,o=await d.z.user.findUnique({where:{id:i,isActive:!0}});if(!o)throw new p.CE("Authenticated user not found or inactive.","AUTH_USER_INVALID_CONSENT_POST",{userId:i});let n=e.headers.get("content-type");if(n?.includes("application/x-www-form-urlencoded"))t=await e.formData();else if(n?.includes("application/json"))t=await e.json();else throw new p.gz("Unsupported Content-Type. Please use application/x-www-form-urlencoded or application/json.",p.Fw.InvalidRequest,415,void 0,{});let s="function"==typeof t.get?t.get("decision"):t.decision,l="function"==typeof t.get?t.get("client_id"):t.client_id,h="function"==typeof t.get?t.get("scope"):t.scope,w="function"==typeof t.get?t.get("state"):t.state,f="function"==typeof t.get?t.get("redirect_uri"):t.redirect_uri,v="function"==typeof t.get?t.get("response_type"):t.response_type,_="function"==typeof t.get?t.get("code_challenge"):t.code_challenge,g="function"==typeof t.get?t.get("code_challenge_method"):t.code_challenge_method,m="function"==typeof t.get?t.get("nonce"):t.nonce;if(!s||!l||!h||!f||!v)throw new p.gz("Missing required form fields from consent submission.",p.Fw.InvalidRequest,400,void 0,{missing:[!s&&"decision",!l&&"client_id",!h&&"scope",!f&&"redirect_uri",!v&&"response_type"].filter(Boolean)});if("code"!==v)throw new p.gz('Invalid response_type submitted from consent form: must be "code".',p.Fw.InvalidRequest,400,void 0,{responseType:v});let I=await d.z.oAuthClient.findUnique({where:{clientId:l}});if(!I||!I.isActive)throw new p.gz("Client specified in consent form not found or is not active.",p.Fw.InvalidRequest,403,void 0,{clientId:l});let C=[];try{C=JSON.parse(I.redirectUris)}catch(e){}if(!c.PC.validateRedirectUri(f,C))throw new p.gz("Invalid redirect_uri submitted from consent form for this client.",p.Fw.InvalidRequest,400,void 0,{redirectUri:f});let U=new URL(f);if(w&&U.searchParams.set("state",w),"deny"===s)return U.searchParams.set("error",p.Fw.AccessDenied),U.searchParams.set("error_description","The user denied access to the requested resources."),a.NextResponse.redirect(U.toString(),302);if("allow"===s){let e=c.e8.parseScopes(h);await d.z.consentGrant.upsert({where:{userId_clientId:{userId:o.id,clientId:I.id}},update:{scopes:c.e8.formatScopes(e),issuedAt:new Date,revokedAt:null},create:{userId:o.id,clientId:I.id,scopes:c.e8.formatScopes(e)}});let t=await (0,u.storeAuthorizationCode)(o.id,I.id,f,_||void 0,g||void 0,c.e8.formatScopes(e),I.authorizationCodeLifetime||void 0,m||void 0);return U.searchParams.set("code",t.code),a.NextResponse.redirect(U.toString(),302)}throw new p.gz('Invalid decision value submitted. Must be "allow" or "deny".',p.Fw.InvalidRequest,400,void 0,{decision:s})}let f=(0,l.U)(h),v=(0,l.U)(w),_=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/oauth/consent/route",pathname:"/api/v2/oauth/consent",filename:"route",bundlePath:"app/api/v2/oauth/consent/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/consent/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:g,workUnitAsyncStorage:m,serverHooks:I}=_;function C(){return(0,s.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:m})}},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,344,176,578,434,470,776,555],()=>r(9368));module.exports=i})();