"use strict";(()=>{var e={};e.id=245,e.ids=[245,930],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},2930:(e,t,r)=>{r.r(t),r.d(t,{DEFAULT_AUTHORIZATION_CODE_LIFETIME_SECONDS:()=>d,generateSecureRandomString:()=>c,storeAuthorizationCode:()=>u,validateAuthorizationCode:()=>l});var i=r(8891),o=r(9039),n=r(5511),a=r.n(n),s=r(4931);let d=600;function c(e=32){return a().randomBytes(e).toString("hex")}async function u(e,t,r,n,a,l,p=d,h){var f;if("S256"!==a)throw new s.j1(`Unsupported code challenge method: ${a}. Only 'S256' is supported.`);let w=c(32),_=(f=new Date,(0,o.A)(f,1e3*p,void 0));try{return await i.z.authorizationCode.create({data:{code:w,userId:e,clientId:t,redirectUri:r,scope:l,codeChallenge:n,codeChallengeMethod:a,expiresAt:_,isUsed:!1,nonce:h||null}})}catch(e){throw console.error("Failed to store authorization code:",e),new s.Cf("Database error while storing authorization code.",500,"DB_STORE_AUTH_CODE_FAILED")}}async function l(e,t,r,o){let n=null;try{if(!(n=await i.z.authorizationCode.findUnique({where:{code:e}})))throw new s.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(n.isUsed)throw await i.z.authorizationCode.delete({where:{id:n.id}}),new s.Pb("Invalid authorization code: Code has already been used.",400,"AUTH_CODE_USED");if(n.expiresAt<new Date)throw await i.z.authorizationCode.delete({where:{id:n.id}}),new s.Pb("Invalid authorization code: Code has expired.",400,"AUTH_CODE_EXPIRED");if(n.clientId!==t)throw new s.yI("Invalid authorization code: Client ID mismatch.",{expected:t,actual:n.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(n.redirectUri!==r)throw new s.yI("Invalid authorization code: Redirect URI mismatch.",{expected:r,actual:n.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===n.codeChallengeMethod){if(a().createHash("sha256").update(o).digest("base64url")!==n.codeChallenge)throw new s.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new s.j1(`Unsupported code challenge method in stored code: ${n.codeChallengeMethod}. Only 'S256' is supported.`,void 0,"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await i.z.authorizationCode.update({where:{id:n.id},data:{isUsed:!0}})}catch(e){if(e instanceof s.Cf)throw e;if(console.error("Error during authorization code validation:",e),e instanceof Prisma.PrismaClientKnownRequestError)throw new s.Cf(`Database error during authorization code validation: ${e.message}`,500,`DB_VALIDATE_AUTH_CODE_PRISMA_${e.code}`);throw new s.Cf("Database error during authorization code validation.",500,"DB_VALIDATE_AUTH_CODE_FAILED")}}},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9343:(e,t,r)=>{r.d(t,{U:()=>i.Uj});var i=r(3117)},9368:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>E,routeModule:()=>v,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>I});var i={};r.r(i),r.d(i,{GET:()=>w,POST:()=>_});var o=r(9227),n=r(9044),a=r(1131),s=r(7642),d=r(8891),c=r(9776),u=r(2930),l=r(9343),p=r(4931);async function h(e){let t=e.user;if(!t||!t.id)throw new p.j1("User context not found after permission check.","SERVER_SETUP_ERROR_CONSENT_GET",{authUser:t});let r=t.id,i=await d.z.user.findUnique({where:{id:r,isActive:!0}});if(!i)throw new p.CE("Authenticated user not found or inactive. Please re-authenticate.","AUTH_USER_INVALID_CONSENT_GET",{userId:r});let{searchParams:o}=new URL(e.url),n=o.get("client_id"),a=o.get("redirect_uri"),u=o.get("scope"),l=o.get("state"),h=o.get("response_type"),f=o.get("code_challenge"),w=o.get("code_challenge_method"),_=o.get("nonce");if(!n||!a||!u||!h)throw new p.yI("Missing required parameters from authorization server.",p.Fw.InvalidRequest,{missing:[!n&&"client_id",!a&&"redirect_uri",!u&&"scope",!h&&"response_type"].filter(Boolean)});if("code"!==h)throw new p.yI('Invalid response_type from authorization server: must be "code".',p.Fw.UnsupportedResponseType,{responseType:h});let v=await d.z.oAuthClient.findUnique({where:{clientId:n}});if(!v||!v.isActive)throw new p.gz("Third-party client not found or is not active.",p.Fw.InvalidClient,403,void 0,{clientId:n});let g=[];try{if(g=JSON.parse(v.redirectUris),!Array.isArray(g))throw Error("Redirect URIs are not an array.")}catch(e){throw console.error(`Failed to parse redirectUris for client ${n}:`,e),new p.j1("Server error: Invalid client configuration for redirectUris.","CLIENT_CONFIG_REDIRECT_URI_INVALID_CONSENT_GET",{clientId:n})}if(!c.PC.validateRedirectUri(a,g))throw new p.yI("Provided redirect_uri is not registered for this client.",p.Fw.InvalidRequest,{redirectUri:a,registered:g});let I=c.e8.parseScopes(u),m=(await d.z.scope.findMany({where:{name:{in:I},isActive:!0}})).map(e=>({name:e.name,description:e.description||"No description available for this permission."}));if(m.length!==I.length){let e=m.map(e=>e.name),t=I.filter(t=>!e.includes(t));throw new p.yI(`The following requested permissions are invalid or inactive: ${t.join(", ")}. Please contact the application developer.`,p.Fw.InvalidScope,{missingScopes:t})}let E={client:{id:v.clientId,name:v.clientName||v.clientId,logoUri:v.logoUri},requested_scopes:m,user:{id:i.id,username:i.username},consent_form_action_url:"/api/v2/oauth/consent",client_id:n,redirect_uri:a,scope:u,state:l||void 0,response_type:h,code_challenge:f||void 0,code_challenge_method:w||void 0,nonce:_||void 0};return s.NextResponse.json({success:!0,data:E,message:"Consent data retrieved successfully."},{status:200})}async function f(e){let t,r=e.user;if(!r||!r.id)throw new p.Cf("User context not found after permission check.",500,"SERVER_SETUP_ERROR_CONSENT_POST");let i=r.id,o=await d.z.user.findUnique({where:{id:i,isActive:!0}});if(!o)throw new p.CE("Authenticated user not found or inactive.","AUTH_USER_INVALID_CONSENT_POST",{userId:i});let n=e.headers.get("content-type");if(n?.includes("application/x-www-form-urlencoded"))t=await e.formData();else if(n?.includes("application/json"))t=await e.json();else throw new p.yI("Unsupported Content-Type. Please use application/x-www-form-urlencoded or application/json.","UNSUPPORTED_MEDIA_TYPE_CONSENT_POST",415);let a="function"==typeof t.get?t.get("decision"):t.decision,l="function"==typeof t.get?t.get("client_id"):t.client_id,h="function"==typeof t.get?t.get("scope"):t.scope,f="function"==typeof t.get?t.get("state"):t.state,w="function"==typeof t.get?t.get("redirect_uri"):t.redirect_uri,_="function"==typeof t.get?t.get("response_type"):t.response_type,v="function"==typeof t.get?t.get("code_challenge"):t.code_challenge,g="function"==typeof t.get?t.get("code_challenge_method"):t.code_challenge_method,I="function"==typeof t.get?t.get("nonce"):t.nonce;if(!a||!l||!h||!w||!_)throw new p.yI("Missing required form fields from consent submission.",p.Fw.InvalidRequest,{missing:[!a&&"decision",!l&&"client_id",!h&&"scope",!w&&"redirect_uri",!_&&"response_type"].filter(Boolean)});if("code"!==_)throw new p.yI('Invalid response_type submitted from consent form: must be "code".',p.Fw.UnsupportedResponseType,{responseType:_});let m=await d.z.oAuthClient.findUnique({where:{clientId:l}});if(!m||!m.isActive)throw new p.gz("Client specified in consent form not found or is not active.",p.Fw.InvalidClient,403,void 0,{clientId:l});let E=[];try{E=JSON.parse(m.redirectUris)}catch(e){}if(!c.PC.validateRedirectUri(w,E))throw new p.yI("Invalid redirect_uri submitted from consent form for this client.",p.Fw.InvalidRequest,{redirectUri:w});let C=new URL(w);if(f&&C.searchParams.set("state",f),"deny"===a)return C.searchParams.set("error",p.Fw.AccessDenied),C.searchParams.set("error_description","The user denied access to the requested resources."),s.NextResponse.redirect(C.toString(),302);if("allow"===a){let e=c.e8.parseScopes(h);await d.z.consentGrant.upsert({where:{userId_clientId:{userId:o.id,clientId:m.id}},update:{scopes:c.e8.formatScopes(e),issuedAt:new Date,revokedAt:null},create:{userId:o.id,clientId:m.id,scopes:c.e8.formatScopes(e)}});let t=await (0,u.storeAuthorizationCode)(o.id,m.id,w,v||void 0,g||void 0,c.e8.formatScopes(e),m.authorizationCodeLifetime||void 0,I||void 0);return C.searchParams.set("code",t.code),s.NextResponse.redirect(C.toString(),302)}throw new p.yI('Invalid decision value submitted. Must be "allow" or "deny".',p.Fw.InvalidRequest,{decision:a})}let w=(0,l.U)(h),_=(0,l.U)(f),v=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/oauth/consent/route",pathname:"/api/v2/oauth/consent",filename:"route",bundlePath:"app/api/v2/oauth/consent/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/consent/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:g,workUnitAsyncStorage:I,serverHooks:m}=v;function E(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:I})}},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,176,578,935,813,776,555],()=>r(9368));module.exports=i})();