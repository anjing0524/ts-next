(()=>{var e={};e.id=245,e.ids=[245],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=4997,e.exports=t},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});var i=r(96330);let s=globalThis.prisma??new i.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},29368:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>w,serverHooks:()=>_,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>v});var i={};r.r(i),r.d(i,{GET:()=>g,POST:()=>h});var s=r(19227),o=r(39044),n=r(11131),a=r(57642),c=r(34621),d=r(44325),l=r(60123),u=r(55807);async function p(e){let t=e.user;if(!t||!t.id)throw new u.j1("User context not found after permission check.");let r=t.id,i=await c.prisma.user.findUnique({where:{id:r,isActive:!0}});if(!i)throw new u.CE("Authenticated user not found or inactive. Please re-authenticate.","AUTH_USER_INVALID_CONSENT_GET",{userId:r});let{searchParams:s}=new URL(e.url),o=s.get("client_id"),n=s.get("redirect_uri"),l=s.get("scope"),p=s.get("state"),f=s.get("response_type"),g=s.get("code_challenge"),h=s.get("code_challenge_method"),w=s.get("nonce");if(!o||!n||!l||!f)throw new u.gz("Missing required parameters from authorization server.",u.Fw.InvalidRequest,400,void 0,{missing:[!o&&"client_id",!n&&"redirect_uri",!l&&"scope",!f&&"response_type"].filter(Boolean)});if("code"!==f)throw new u.gz('Invalid response_type from authorization server: must be "code".',u.Fw.InvalidRequest,400,void 0,{responseType:f});let m=await c.prisma.oAuthClient.findUnique({where:{clientId:o}});if(!m||!m.isActive)throw new u.gz("Third-party client not found or is not active.",u.Fw.InvalidRequest,403,void 0,{clientId:o});let v=[];try{if(v=JSON.parse(m.redirectUris),!Array.isArray(v))throw Error("Redirect URIs are not an array.")}catch(e){throw console.error(`Failed to parse redirectUris for client ${o}:`,e),new u.j1("Server error: Invalid client configuration for redirectUris.",{clientId:o})}if(!d.PC.validateRedirectUri(n,v))throw new u.gz("Provided redirect_uri is not registered for this client.",u.Fw.InvalidRequest,400,void 0,{redirectUri:n,registered:v});let _=d.e8.parseScopes(l),y=(await c.prisma.scope.findMany({where:{name:{in:_},isActive:!0}})).map(e=>({name:e.name,description:e.description||"No description available for this permission."}));if(y.length!==_.length){let e=y.map(e=>e.name),t=_.filter(t=>!e.includes(t));throw new u.gz(`The following requested permissions are invalid or inactive: ${t.join(", ")}. Please contact the application developer.`,u.Fw.InvalidRequest,400,void 0,{missingScopes:t})}let x={client:{id:m.clientId,name:m.name||m.clientId,logoUri:m.logoUri},requested_scopes:y,user:{id:i.id,username:i.username},consent_form_action_url:"/api/v2/oauth/consent",client_id:o,redirect_uri:n,scope:l,state:p||void 0,response_type:f,code_challenge:g||void 0,code_challenge_method:h||void 0,nonce:w||void 0};return a.NextResponse.json({success:!0,data:x,message:"Consent data retrieved successfully."},{status:200})}async function f(e){let t,i=e.user;if(!i||!i.id)throw new u.j1("User context not found after permission check.");let s=i.id,o=await c.prisma.user.findUnique({where:{id:s,isActive:!0}});if(!o)throw new u.CE("Authenticated user not found or inactive.","AUTH_USER_INVALID_CONSENT_POST",{userId:s});let n=e.headers.get("content-type");if(n?.includes("application/x-www-form-urlencoded"))t=await e.formData();else if(n?.includes("application/json"))t=await e.json();else throw new u.gz("Unsupported Content-Type. Please use application/x-www-form-urlencoded or application/json.",u.Fw.InvalidRequest,415,void 0,{});let l="function"==typeof t.get?t.get("decision"):t.decision,p="function"==typeof t.get?t.get("client_id"):t.client_id,f="function"==typeof t.get?t.get("scope"):t.scope,g="function"==typeof t.get?t.get("state"):t.state,h="function"==typeof t.get?t.get("redirect_uri"):t.redirect_uri,w="function"==typeof t.get?t.get("response_type"):t.response_type,m="function"==typeof t.get?t.get("code_challenge"):t.code_challenge,v="function"==typeof t.get?t.get("code_challenge_method"):t.code_challenge_method,_="function"==typeof t.get?t.get("nonce"):t.nonce;if(!l||!p||!f||!h||!w)throw new u.gz("Missing required form fields from consent submission.",u.Fw.InvalidRequest,400,void 0,{missing:[!l&&"decision",!p&&"client_id",!f&&"scope",!h&&"redirect_uri",!w&&"response_type"].filter(Boolean)});if("code"!==w)throw new u.gz('Invalid response_type submitted from consent form: must be "code".',u.Fw.InvalidRequest,400,void 0,{responseType:w});let y=await c.prisma.oAuthClient.findUnique({where:{clientId:p}});if(!y||!y.isActive)throw new u.gz("Client specified in consent form not found or is not active.",u.Fw.InvalidRequest,403,void 0,{clientId:p});let x=[];try{x=JSON.parse(y.redirectUris)}catch(e){}if(!d.PC.validateRedirectUri(h,x))throw new u.gz("Invalid redirect_uri submitted from consent form for this client.",u.Fw.InvalidRequest,400,void 0,{redirectUri:h});let I=new URL(h);if(g&&I.searchParams.set("state",g),"deny"===l)return I.searchParams.set("error",u.Fw.AccessDenied),I.searchParams.set("error_description","The user denied access to the requested resources."),a.NextResponse.redirect(I.toString(),302);if("allow"===l){let t=d.e8.parseScopes(f);await c.prisma.consentGrant.upsert({where:{userId_clientId:{userId:o.id,clientId:y.id}},update:{scopes:d.e8.formatScopes(t),issuedAt:new Date,revokedAt:null},create:{userId:o.id,clientId:y.id,scopes:d.e8.formatScopes(t)}});let{storeAuthorizationCode:i}=await r.e(890).then(r.bind(r,71890)),s=await i(o.id,y.id,h,m||"",v||"S256",d.e8.formatScopes(t),600,_);return I.searchParams.set("code",s.code),await d.PC.logAuditEvent({userId:o.id,clientId:y.clientId,action:"CONSENT_GRANTED_AUTH_CODE_ISSUED",success:!0,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,metadata:{client_id:y.clientId,grantedScopes:d.e8.formatScopes(t),hasPKCE:!!m,hasNonce:!!_}}),a.NextResponse.redirect(I.toString(),302)}throw new u.gz('Invalid decision value submitted. Must be "allow" or "deny".',u.Fw.InvalidRequest,400,void 0,{decision:l})}let g=(0,l.Uj)(p),h=(0,l.Uj)(f),w=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/oauth/consent/route",pathname:"/api/v2/oauth/consent",filename:"route",bundlePath:"app/api/v2/oauth/consent/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/consent/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:m,workUnitAsyncStorage:v,serverHooks:_}=w;function y(){return(0,n.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:v})}},33873:e=>{"use strict";e.exports=require("path")},34621:(e,t,r)=>{"use strict";r.d(t,{prisma:()=>i.z}),r(96330);var i=r(24958),s=r(50488),o=r.n(s),n=r(5433);o().config();let a={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},c=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:a.host,port:a.port,user:a.user,database:a.database}),n.createPool(a));async function d(){if(c&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await c.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await d(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await d(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await d(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},41204:e=>{"use strict";e.exports=require("string_decoder")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},90483:(e,t,r)=>{"use strict";r.d(t,{A:()=>c});var i=r(55511);let s={randomUUID:i.randomUUID},o=new Uint8Array(256),n=o.length,a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));let c=function(e,t,r){if(s.randomUUID&&!t&&!e)return s.randomUUID();let c=(e=e||{}).random??e.rng?.()??(n>o.length-16&&((0,i.randomFillSync)(o),n=0),o.slice(n,n+=16));if(c.length<16)throw Error("Random bytes length must be >= 16");if(c[6]=15&c[6]|64,c[8]=63&c[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=c[e];return t}return function(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}(c)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,176,200,229,706,855],()=>r(29368));module.exports=i})();