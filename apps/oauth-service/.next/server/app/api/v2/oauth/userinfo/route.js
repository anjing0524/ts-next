"use strict";(()=>{var e={};e.id=324,e.ids=[324],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3404:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>_,routeModule:()=>q,serverHooks:()=>T,workAsyncStorage:()=>A,workUnitAsyncStorage:()=>I});var i={};r.r(i),r.d(i,{GET:()=>S});var s=r(19227),n=r(39044),o=r(11131),a=r(57642),l=r(34621),d=r(60123),c=r(28064),u=r(96800);let p={allowedOrigins:["*"],allowedMethods:["GET","POST","PUT","DELETE","OPTIONS","PATCH"],allowedHeaders:["Content-Type","Authorization","X-Requested-With","Accept","Origin","Access-Control-Request-Method","Access-Control-Request-Headers"],allowCredentials:!0,maxAge:86400};function h(e,t){return!!e&&(!!(t.includes("*")||t.includes(e))||t.some(t=>{if(t.includes("*")){let r=t.replace(/\*/g,".*");return RegExp(`^${r}$`).test(e)}return!1}))}function f(e,t,r){let i=t.headers.get("origin");return i&&h(i,r.allowedOrigins||p.allowedOrigins)&&e.headers.set("Access-Control-Allow-Origin",i),e.headers.set("Access-Control-Allow-Methods",(r.allowedMethods||p.allowedMethods).join(", ")),e.headers.set("Access-Control-Allow-Headers",(r.allowedHeaders||p.allowedHeaders).join(", ")),r.allowCredentials&&e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Expose-Headers","Content-Length, Content-Type"),e}r(86933);let w={maxRequests:100,windowMs:9e5,keyType:"ip",message:"请求过于频繁，请稍后再试 (Too many requests, please try again later)",includeHeaders:!0};function m(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip"),i=e.headers.get("cf-connecting-ip");return t?t.split(",")[0]?.trim()||"127.0.0.1":r||i||"127.0.0.1"}function g(e,t,r,i){if(e.headers.set("X-RateLimit-Limit",t.toString()),e.headers.set("X-RateLimit-Remaining",Math.max(0,r).toString()),e.headers.set("X-RateLimit-Reset",i.toString()),r<=0){let t=Math.ceil((i-Date.now())/1e3);e.headers.set("Retry-After",t.toString())}return e}r(51041);c.L3.generateCodeVerifier,c.L3.generateCodeChallenge,c.L3.verifyCodeChallenge,c.L3.validateCodeVerifier,c.L3.isSupportedChallengeMethod,c.L3.validatePKCEParams;var v=r(24931),x=r(67200);let C=x.z.object({sub:x.z.string(),name:x.z.string().optional(),given_name:x.z.string().optional(),family_name:x.z.string().optional(),preferred_username:x.z.string().optional(),picture:x.z.string().url().optional(),updated_at:x.z.number().int().positive().optional(),organization:x.z.string().optional(),department:x.z.string().optional(),email:x.z.string().email().optional(),email_verified:x.z.boolean().optional(),phone_number:x.z.string().optional(),phone_number_verified:x.z.boolean().optional()});async function y(e){let t=await (0,u.NC)(e,{allowPublicAccess:!1,requiredScopes:["openid"]});if(!t.success){if(t.response)return t.response;throw new v.gz("Authentication failed for UserInfo endpoint.",v.Fw.InvalidToken,401)}if(!t.context)throw new v.gz("Authentication context missing after successful authentication.",v.Fw.ServerError,500);let{user:r,scopes:i}=t.context,s=r?.id;if(!s)throw new v.gz("User ID not found in access token.",v.Fw.InvalidToken,401);if(!i?.includes("openid"))throw new v.gz('Insufficient scope. The "openid" scope is required to access UserInfo endpoint.',v.Fw.InsufficientScope,403,void 0,{requiredScope:"openid",providedScopes:i});let n=await l.prisma.user.findUnique({where:{id:s,isActive:!0}});if(!n)throw new v.gz("User not found or inactive.",v.Fw.InvalidToken,404,void 0,{userId:s});let o={sub:n.id};i.includes("profile")&&(o.name=n.firstName&&n.lastName?`${n.firstName} ${n.lastName}`.trim():void 0,o.given_name=n.firstName||void 0,o.family_name=n.lastName||void 0,o.preferred_username=n.username||void 0,o.picture=n.avatar||void 0,o.updated_at=n.updatedAt?Math.floor(n.updatedAt.getTime()/1e3):void 0,o.organization=n.organization||void 0,o.department=n.department||void 0),i.includes("email")&&(o.email=void 0,o.email_verified=void 0),i.includes("phone")&&(o.phone_number=void 0,o.phone_number_verified=void 0),Object.keys(o).forEach(e=>{void 0===o[e]&&delete o[e]});let d=C.safeParse(o);if(!d.success)throw console.error("UserInfo response validation failed:",d.error),new v.gz("Failed to generate valid user information response.",v.Fw.ServerError,500,void 0,{validationErrors:d.error.flatten().fieldErrors});return a.NextResponse.json({success:!0,data:d.data,message:"User information retrieved successfully."},{status:200,headers:{"Content-Type":"application/json","Cache-Control":"no-store, no-cache, max-age=0, must-revalidate",Pragma:"no-cache"}})}let S=(0,d.Uj)(y),q=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/oauth/userinfo/route",pathname:"/api/v2/oauth/userinfo",filename:"route",bundlePath:"app/api/v2/oauth/userinfo/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/userinfo/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:A,workUnitAsyncStorage:I,serverHooks:T}=q;function _(){return(0,o.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:I})}},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},23040:(e,t,r)=>{r.d(t,{i:()=>a});var i=r(88022),s=r(55937),n=r(46159),o=r(1047);function a(e){let t,r;if("string"!=typeof e)throw new o.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:a,length:l}=e.split(".");if(5===l)throw new o.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==l)throw new o.Dp("Invalid JWT");if(!a)throw new o.Dp("JWTs must contain a payload");try{t=(0,i.D)(a)}catch{throw new o.Dp("Failed to base64url decode the payload")}try{r=JSON.parse(s.D0.decode(t))}catch{throw new o.Dp("Failed to parse the decoded payload as JSON")}if(!(0,n.A)(r))throw new o.Dp("Invalid JWT Claims Set");return r}},24931:(e,t,r)=>{r.d(t,{CE:()=>i.CE,Fw:()=>i.Fw,gz:()=>i.gz,j1:()=>i.j1});var i=r(55807)},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31551:(e,t,r)=>{r.d(t,{B:()=>d});var i=r(23040),s=r(97151),n=r(27819),o=r(1047),a=r(34621),l=r(24931);class d{static async authenticateClient(e,t){let r=t.get("client_id"),i=t.get("client_secret"),s=t.get("client_assertion_type"),n=t.get("client_assertion"),o=e.headers.get("authorization");if(o&&o.toLowerCase().startsWith("basic "))try{let e=o.slice(6),[t,s]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&s&&(r=r||t,i=i||s)}catch{throw new l.gz("Invalid Basic authentication header format.",l.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===s&&n)return await this.authenticateWithJWT(n,e);if(r&&i)return await this.authenticateWithSecret(r,i);if(r&&!i){let e=await a.prisma.oAuthClient.findUnique({where:{clientId:r,isActive:!0}});if(!e)throw new l.gz("Client not found.",l.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new l.gz("客户端不是公开客户端，需要身份验证",l.Fw.InvalidClient,401);return e}throw new l.gz("Client authentication required but not provided or method not supported.",l.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let i=await a.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!i)throw new l.gz("Invalid client ID or client not active.",l.Fw.InvalidClient,401);if("PUBLIC"===i.clientType)throw new l.gz("公开客户端试图使用密钥进行身份验证",l.Fw.InvalidClient,400);if(!i.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new l.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(r.t.bind(r,5486,23));if(!await e.compare(t,i.clientSecret))throw new l.gz("客户端密钥无效",l.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new l.j1("客户端密钥验证期间发生错误")}return i}static async authenticateWithJWT(e,t){try{let r=i.i(e);if(!r.iss||!r.sub||r.iss!==r.sub)throw new l.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",l.Fw.InvalidClient,400);let o=r.iss,d=await a.prisma.oAuthClient.findUnique({where:{clientId:o,isActive:!0}});if(!d)throw new l.gz("Client specified in JWT assertion not found or not active.",l.Fw.InvalidClient,401);if(!d.jwksUri)throw new l.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let c=this.getTokenEndpointUrl(t),u=s.RD(new URL(d.jwksUri));return await n.V(e,u,{issuer:o,audience:c,algorithms:["RS256","ES256","PS256"]}),d}catch(r){console.error("Client JWT assertion validation failed:",r);let e="Client assertion validation failed.",t=l.Fw.InvalidClient;if(r instanceof o.n)e="Client assertion has expired.",t=l.Fw.InvalidGrant;else if(r instanceof o.ie)e=`Client assertion claim validation failed: ${r.claim} ${r.reason}.`;else if(r instanceof o.h2)e="Client assertion signature verification failed.";else if(r instanceof l.j1)throw r;throw new l.gz(e,t,400,void 0,{originalError:r.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),r=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),i=e.headers.get("x-forwarded-host")||t.host,s=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${r}://${i}${s}`}}},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51041:(e,t,r)=>{r.d(t,{P:()=>a,B:()=>i.B});var i=r(31551),s=r(55511),n=r(34621),o=r(84344);class a{static validateRedirectUri(e,t){return t.includes(e)}static validateResponseType(e,t=["code"]){return t.includes(e)}static generateState(){return s.randomBytes(32).toString("base64url")}static generateNonce(){return s.randomBytes(32).toString("base64url")}static generateAuthorizationCode(){return s.randomBytes(32).toString("hex")}static async logAuditEvent(e){try{let t="SYSTEM",r="system";if(e.userId)t="USER",r=e.userId;else if(e.clientId){t="CLIENT";let i=await n.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});r=i?i.clientId:e.clientId}let i=e.success;void 0===i&&(i=e.status?"SUCCESS"===e.status:!e.errorMessage),await n.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:r||"unknown",status:i?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:this.buildDetailsJson(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}}static buildDetailsJson(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let r=JSON.parse(e.details);t={...t,...r}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}static async getUserPermissions(e){try{let t=await o.S.getUserPermissions(e),r=new Set(t?.permissions||[]);return Array.from(r)}catch(e){return console.error("Error getting user permissions:",e),[]}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")},96800:(e,t,r)=>{r.d(t,{NC:()=>l,ru:()=>d});var i=r(57642),s=r(97151),n=r(27819),o=r(1047),a=r(24958);async function l(e,t={}){let r,d=e.headers.get("authorization");if(!d||!d.startsWith("Bearer "))return t.allowPublicAccess?{success:!0}:{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let c=d.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let t=s.RD(new URL(e)),i=process.env.JWT_ISSUER,o=process.env.JWT_AUDIENCE;if(!i||!o)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");r=(await n.V(c,t,{issuer:i,audience:o,algorithms:["RS256"]})).payload}catch(t){console.error("JWT 验证失败 (JWT validation failed):",t);let e="Token validation failed";return t instanceof o.n?e=`Token expired at ${new Date(1e3*t.payload.exp).toISOString()}`:t instanceof o.ie?e=`Token claim validation failed: ${t.claim} ${t.reason}`:t instanceof o.T0||t instanceof o._L?e="Invalid token algorithm or key issue.":t instanceof Error&&(t.message.includes("JWKS")||t.message.includes("configured"))&&(e=`Token validation setup error: ${t.message}`),{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let u=r.sub,p=r.client_id,h=r.scope?.split(" ")||[],f=r.permissions||[];if(t.requiredScopes&&t.requiredScopes.length>0&&!t.requiredScopes.every(e=>h.includes(e)))return{success:!1,response:i.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${t.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${t.requiredScopes.join(" ")}"`}})};if(t.requiredPermissions&&t.requiredPermissions.length>0&&!t.requiredPermissions.every(e=>f.includes(e)))return{success:!1,response:i.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${t.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let w={user_id:u,client_id:p,scopes:h,permissions:f,tokenPayload:r};if(t.requireUserContext&&u)try{let e=await a.z.user.findUnique({where:{id:u,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(w.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("获取用户信息失败 (Failed to fetch user information):",e)}return{success:!0,context:w}}function d(e,t={}){return async function(r){let s=await l(r,t);return s.success?s.context?e(r,s.context):i.NextResponse.json({error:"authentication_failed",error_description:"Authentication context missing"},{status:500}):s.response||i.NextResponse.json({error:"authentication_failed",error_description:"Authentication failed"},{status:401})}}new(r(28064)).n1(a.z)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,176,344,196,578,987,466,855,119,64],()=>r(3404));module.exports=i})();