"use strict";(()=>{var e={};e.id=324,e.ids=[324],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1630:e=>{e.exports=require("http")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},2412:e=>{e.exports=require("assert")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3117:(e,r,t)=>{t.d(r,{FB:()=>l,Uj:()=>c});var o=t(7642),n=t(5807),s=t(5511);let i={randomUUID:s.randomUUID},a=new Uint8Array(256),u=a.length,d=[];for(let e=0;e<256;++e)d.push((e+256).toString(16).slice(1));let p=function(e,r,t){if(i.randomUUID&&!r&&!e)return i.randomUUID();let o=(e=e||{}).random??e.rng?.()??(u>a.length-16&&((0,s.randomFillSync)(a),u=0),a.slice(u,u+=16));if(o.length<16)throw Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,r){if((t=t||0)<0||t+16>r.length)throw RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[t+e]=o[e];return r}return function(e,r=0){return(d[e[r+0]]+d[e[r+1]]+d[e[r+2]]+d[e[r+3]]+"-"+d[e[r+4]]+d[e[r+5]]+"-"+d[e[r+6]]+d[e[r+7]]+"-"+d[e[r+8]]+d[e[r+9]]+"-"+d[e[r+10]]+d[e[r+11]]+d[e[r+12]]+d[e[r+13]]+d[e[r+14]]+d[e[r+15]]).toLowerCase()}(o)};function c(e){return async(r,t)=>{let s=p();r.requestId=s;try{return await e(r,t)}catch(t){let e=s||p();if(function(e,r,t){let o={timestamp:new Date().toISOString(),requestId:t||"N/A",message:e.message||"An unknown error occurred.",name:e.name||"Error"};r&&(o.url=r.url,o.method=r.method,o.ip=r.headers.get("x-forwarded-for")||r.headers.get("x-real-ip")||"unknown",o.userAgent=r.headers.get("user-agent")),e instanceof n.Cf?(o.code=e.code,o.status=e.status,e.context&&(o.context=e.context)):(o.code="UNHANDLED_EXCEPTION",o.status=500),e.stack&&(o.stack=e.stack.split("\n").map(e=>e.trim())),console.error(JSON.stringify(o,null,2))}(t,r,e),t instanceof n.Cf){let r=t.toApiResponse();return r.error&&(r.error.details={...r.error.details,requestId:e}),o.NextResponse.json(r,{status:t.status})}return o.NextResponse.json({success:!1,error:{code:"INTERNAL_SERVER_ERROR",message:"An unexpected internal server error occurred.",details:{requestId:e}}},{status:500})}}}function l(e){return async(r,...t)=>{try{return await e(r,...t)}catch(e){if(console.error("API route error:",e),e instanceof n.Cf)return o.NextResponse.json({success:!1,error:e.code,message:e.message},{status:e.status});return o.NextResponse.json({success:!1,error:"INTERNAL_SERVER_ERROR",message:"An unexpected error occurred"},{status:500})}}}},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},3997:e=>{e.exports=require("tty")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4985:e=>{e.exports=require("dns")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},5591:e=>{e.exports=require("https")},5741:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>q,routeModule:()=>x,serverHooks:()=>w,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>v});var o={};t.r(o),t.d(o,{GET:()=>g});var n=t(9227),s=t(9044),i=t(1131),a=t(7642),u=t(8891),d=t(9343),p=t(9565),c=t(4931),l=t(7200);let f=l.z.object({sub:l.z.string(),name:l.z.string().optional(),given_name:l.z.string().optional(),family_name:l.z.string().optional(),preferred_username:l.z.string().optional(),picture:l.z.string().url().optional(),updated_at:l.z.number().int().positive().optional(),organization:l.z.string().optional(),department:l.z.string().optional()});async function m(e){let r=await (0,p.NC)(e,{allowPublicAccess:!1,requiredScopes:["openid"]});if(!r.success){if(r.response)return r.response;throw new c.gz("Authentication failed for UserInfo endpoint.",c.Fw.InvalidToken,401)}if(!r.context)throw new c.gz("Authentication context missing after successful authentication.",c.Fw.ServerError,500);let{userId:t,scopes:o}=r.context;if(!t)throw new c.gz("User ID not found in access token.",c.Fw.InvalidToken,401);if(!o?.includes("openid"))throw new c.gz('Insufficient scope. The "openid" scope is required to access UserInfo endpoint.',c.Fw.InsufficientScope,403,void 0,{requiredScope:"openid",providedScopes:o});let n=await u.z.user.findUnique({where:{id:t,isActive:!0}});if(!n)throw new c.gz("User not found or inactive.",c.Fw.InvalidToken,404,void 0,{userId:t});let s={sub:n.id};o.includes("profile")&&(s.name=n.firstName&&n.lastName?`${n.firstName} ${n.lastName}`.trim():void 0,s.given_name=n.firstName||void 0,s.family_name=n.lastName||void 0,s.preferred_username=n.username||void 0,s.picture=n.picture||void 0,s.updated_at=n.updatedAt?Math.floor(n.updatedAt.getTime()/1e3):void 0,"organization"in n&&(s.organization=n.organization||void 0),"department"in n&&(s.department=n.department||void 0)),o.includes("email")&&(s.email=n.email||void 0,s.email_verified=n.emailVerified||!1),o.includes("phone")&&"phone"in n&&(s.phone_number=n.phone||void 0,s.phone_number_verified=n.phoneVerified||!1),Object.keys(s).forEach(e=>{void 0===s[e]&&delete s[e]});let i=f.safeParse(s);if(!i.success)throw console.error("UserInfo response validation failed:",i.error),new c.gz("Failed to generate valid user information response.",c.Fw.ServerError,500,void 0,{validationErrors:i.error.flatten().fieldErrors});return a.NextResponse.json({success:!0,data:i.data,message:"User information retrieved successfully."},{status:200,headers:{"Content-Type":"application/json","Cache-Control":"no-store, no-cache, max-age=0, must-revalidate",Pragma:"no-cache"}})}let g=(0,d.U)(m),x=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/v2/oauth/userinfo/route",pathname:"/api/v2/oauth/userinfo",filename:"route",bundlePath:"app/api/v2/oauth/userinfo/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/userinfo/route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:h,workUnitAsyncStorage:v,serverHooks:w}=x;function q(){return(0,i.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:v})}},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9343:(e,r,t)=>{t.d(r,{U:()=>o.Uj});var o=t(3117)},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[938,344,176,578,434,200,470,776,565],()=>t(5741));module.exports=o})();