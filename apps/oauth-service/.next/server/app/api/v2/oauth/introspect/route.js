"use strict";(()=>{var e={};e.id=748,e.ids=[748],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3117:(e,t,r)=>{r.d(t,{FB:()=>l,Uj:()=>p});var s=r(7642),n=r(5807),i=r(5511);let o={randomUUID:i.randomUUID},a=new Uint8Array(256),u=a.length,c=[];for(let e=0;e<256;++e)c.push((e+256).toString(16).slice(1));let d=function(e,t,r){if(o.randomUUID&&!t&&!e)return o.randomUUID();let s=(e=e||{}).random??e.rng?.()??(u>a.length-16&&((0,i.randomFillSync)(a),u=0),a.slice(u,u+=16));if(s.length<16)throw Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=s[e];return t}return function(e,t=0){return(c[e[t+0]]+c[e[t+1]]+c[e[t+2]]+c[e[t+3]]+"-"+c[e[t+4]]+c[e[t+5]]+"-"+c[e[t+6]]+c[e[t+7]]+"-"+c[e[t+8]]+c[e[t+9]]+"-"+c[e[t+10]]+c[e[t+11]]+c[e[t+12]]+c[e[t+13]]+c[e[t+14]]+c[e[t+15]]).toLowerCase()}(s)};function p(e){return async(t,r)=>{let i=d();t.requestId=i;try{return await e(t,r)}catch(r){let e=i||d();if(function(e,t,r){let s={timestamp:new Date().toISOString(),requestId:r||"N/A",message:e.message||"An unknown error occurred.",name:e.name||"Error"};t&&(s.url=t.url,s.method=t.method,s.ip=t.headers.get("x-forwarded-for")||t.headers.get("x-real-ip")||"unknown",s.userAgent=t.headers.get("user-agent")),e instanceof n.Cf?(s.code=e.code,s.status=e.status,e.context&&(s.context=e.context)):(s.code="UNHANDLED_EXCEPTION",s.status=500),e.stack&&(s.stack=e.stack.split("\n").map(e=>e.trim())),console.error(JSON.stringify(s,null,2))}(r,t,e),r instanceof n.Cf){let t=r.toApiResponse();return t.error&&(t.error.details={...t.error.details,requestId:e}),s.NextResponse.json(t,{status:r.status})}return s.NextResponse.json({success:!1,error:{code:"INTERNAL_SERVER_ERROR",message:"An unexpected internal server error occurred.",details:{requestId:e}}},{status:500})}}}function l(e){return async(t,...r)=>{try{return await e(t,...r)}catch(e){if(console.error("API route error:",e),e instanceof n.Cf)return s.NextResponse.json({success:!1,error:e.code,message:e.message},{status:e.status});return s.NextResponse.json({success:!1,error:"INTERNAL_SERVER_ERROR",message:"An unexpected error occurred"},{status:500})}}}},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},4075:e=>{e.exports=require("zlib")},4470:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>q,routeModule:()=>h,serverHooks:()=>R,workAsyncStorage:()=>k,workUnitAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{POST:()=>v});var n=r(9227),i=r(9044),o=r(1131),a=r(7642),u=r(8891),c=r(9343),d=r(9776),p=r(7200);let l=p.z.object({token:p.z.string({required_error:"token is required.",invalid_type_error:"token must be a string."}).min(1,"token cannot be empty."),token_type_hint:p.z.enum(["access_token","refresh_token"]).optional()}),f=p.z.object({active:p.z.literal(!0),scope:p.z.string().optional(),client_id:p.z.string().optional(),username:p.z.string().optional(),token_type:p.z.string().optional(),exp:p.z.number().int().positive().optional(),iat:p.z.number().int().positive().optional(),nbf:p.z.number().int().positive().optional(),sub:p.z.string().optional(),aud:p.z.union([p.z.string(),p.z.array(p.z.string())]).optional(),iss:p.z.string().optional(),jti:p.z.string().optional(),permissions:p.z.array(p.z.string()).optional()}),m=p.z.object({active:p.z.literal(!1)});p.z.union([f,m]);var x=r(4931);async function g(e){if("application/x-www-form-urlencoded"!==e.headers.get("content-type"))throw new x.gz("Unsupported Media Type. Please use application/x-www-form-urlencoded.",x.Fw.InvalidRequest,415,void 0,{expectedContentType:"application/x-www-form-urlencoded"});let t=new URLSearchParams(await e.text()),r={};t.forEach((e,t)=>{r[t]=e});let s=await d.Bu.authenticateClient(e,t);console.log(`Introspection request authenticated for client: ${s.clientId}`);let n=l.safeParse(r);if(!n.success)throw new x.gz(n.error.errors[0]?.message||"Invalid introspection request parameters.",x.Fw.InvalidRequest,400,void 0,{issues:n.error.flatten().fieldErrors});if(n.data.client_id&&n.data.client_id!==s.clientId)throw new x.gz("client_id in body does not match authenticated client.",x.Fw.InvalidRequest,400);let{token:i,token_type_hint:o}=n.data,c=null;if("access_token"===o||!o){let e=await d.DU.verifyAccessToken(i);if(e.valid&&e.payload){let t=e.payload;if(t.jti&&await u.z.tokenBlacklist.findUnique({where:{jti:t.jti}}))return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is blacklisted."},{status:200});let r=await u.z.accessToken.findFirst({where:{tokenHash:d.DU.getTokenHash(i),expiresAt:{gt:new Date}},include:{user:!0}});r&&t.sub===r.userId&&(c={active:!0,scope:(t.scope||r.scope)??void 0,client_id:t.client_id,username:r.user?.username||void 0,sub:t.sub,aud:t.aud??void 0,iss:t.iss,exp:t.exp,iat:t.iat,jti:t.jti,token_type:"Bearer",user_id:r.userId??void 0,permissions:t.permissions??void 0})}}if(!c&&("refresh_token"===o||!o)){let e=await d.DU.verifyRefreshToken(i);if(e.valid&&e.payload){let t=e.payload;if(t.jti&&await u.z.tokenBlacklist.findUnique({where:{jti:t.jti}}))return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is blacklisted."},{status:200});let r=await u.z.refreshToken.findFirst({where:{tokenHash:d.DU.getTokenHash(i),isRevoked:!1,expiresAt:{gt:new Date}},include:{user:!0}});r&&t.sub===r.userId&&(c={active:!0,scope:(t.scope||r.scope)??void 0,client_id:t.client_id,username:r.user?.username||void 0,sub:t.sub,aud:t.aud??void 0,iss:t.iss,exp:t.exp,iat:t.iat,jti:t.jti,token_type:"refresh_token",user_id:r.userId??void 0})}}if(c){if(!c.client_id)return console.warn("Active token introspection, but client_id could not be determined from token payload. Marking inactive."),a.NextResponse.json({success:!0,data:{active:!1},message:"Token details inconsistent (missing client_id in token)."},{status:200});let e=f.safeParse(c);if(e.success)return a.NextResponse.json({success:!0,data:e.data,message:"Token is active."},{status:200});throw console.error("Introspection active response schema validation failed:",e.error.flatten()),new x.Cf("Internal server error processing token details for active token.",500,"INTROSPECTION_SCHEMA_ERROR_ACTIVE",{zodIssues:e.error.flatten().fieldErrors})}return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is not active."},{status:200})}let v=(0,c.U)(g),h=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/v2/oauth/introspect/route",pathname:"/api/v2/oauth/introspect",filename:"route",bundlePath:"app/api/v2/oauth/introspect/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/introspect/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:k,workUnitAsyncStorage:w,serverHooks:R}=h;function q(){return(0,o.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:w})}},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9343:(e,t,r)=>{r.d(t,{U:()=>s.Uj});var s=r(3117)},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[938,176,578,935,200,813,776],()=>r(4470));module.exports=s})();