(()=>{var e={};e.id=748,e.ids=[748],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=4997,e.exports=t},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},23040:(e,t,i)=>{"use strict";i.d(t,{i:()=>a});var s=i(88022),r=i(55937),o=i(46159),n=i(1047);function a(e){let t,i;if("string"!=typeof e)throw new n.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:a,length:l}=e.split(".");if(5===l)throw new n.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==l)throw new n.Dp("Invalid JWT");if(!a)throw new n.Dp("JWTs must contain a payload");try{t=(0,s.D)(a)}catch{throw new n.Dp("Failed to base64url decode the payload")}try{i=JSON.parse(r.D0.decode(t))}catch{throw new n.Dp("Failed to parse the decoded payload as JSON")}if(!(0,o.A)(i))throw new n.Dp("Invalid JWT Claims Set");return i}},24931:(e,t,i)=>{"use strict";i.d(t,{Fw:()=>s.Fw,gz:()=>s.gz,j1:()=>s.j1});var s=i(55807)},24958:(e,t,i)=>{"use strict";i.d(t,{z:()=>r});var s=i(96330);let r=globalThis.prisma??new s.PrismaClient},27650:(e,t,i)=>{"use strict";i.d(t,{B:()=>c});var s=i(23040),r=i(97151),o=i(27819),n=i(1047),a=i(34621),l=i(24931);class c{static async authenticateClient(e,t){let i=t.get("client_id"),s=t.get("client_secret"),r=t.get("client_assertion_type"),o=t.get("client_assertion"),n=e.headers.get("authorization");if(n&&n.toLowerCase().startsWith("basic "))try{let e=n.slice(6),[t,r]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&r&&(i=i||t,s=s||r)}catch{throw new l.gz("Invalid Basic authentication header format.",l.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===r&&o)return await this.authenticateWithJWT(o,e);if(i&&s)return await this.authenticateWithSecret(i,s);if(i&&!s){let e=await a.prisma.oAuthClient.findUnique({where:{clientId:i,isActive:!0}});if(!e)throw new l.gz("Client not found.",l.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new l.gz("客户端不是公开客户端，需要身份验证",l.Fw.InvalidClient,401);return e}throw new l.gz("Client authentication required but not provided or method not supported.",l.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let s=await a.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!s)throw new l.gz("Invalid client ID or client not active.",l.Fw.InvalidClient,401);if("PUBLIC"===s.clientType)throw new l.gz("公开客户端试图使用密钥进行身份验证",l.Fw.InvalidClient,400);if(!s.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new l.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(i.t.bind(i,5486,23));if(!await e.compare(t,s.clientSecret))throw new l.gz("客户端密钥无效",l.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new l.j1("客户端密钥验证期间发生错误")}return s}static async authenticateWithJWT(e,t){try{let i=s.i(e);if(!i.iss||!i.sub||i.iss!==i.sub)throw new l.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",l.Fw.InvalidClient,400);let n=i.iss,c=await a.prisma.oAuthClient.findUnique({where:{clientId:n,isActive:!0}});if(!c)throw new l.gz("Client specified in JWT assertion not found or not active.",l.Fw.InvalidClient,401);if(!c.jwksUri)throw new l.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let u=this.getTokenEndpointUrl(t),d=r.RD(new URL(c.jwksUri));return await o.V(e,d,{issuer:n,audience:u,algorithms:["RS256","ES256","PS256"]}),c}catch(i){console.error("Client JWT assertion validation failed:",i);let e="Client assertion validation failed.",t=l.Fw.InvalidClient;if(i instanceof n.n)e="Client assertion has expired.",t=l.Fw.InvalidGrant;else if(i instanceof n.ie)e=`Client assertion claim validation failed: ${i.claim} ${i.reason}.`;else if(i instanceof n.h2)e="Client assertion signature verification failed.";else if(i instanceof l.j1)throw i;throw new l.gz(e,t,400,void 0,{originalError:i.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),i=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),s=e.headers.get("x-forwarded-host")||t.host,r=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${i}://${s}${r}`}}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34470:(e,t,i)=>{"use strict";i.r(t),i.d(t,{patchFetch:()=>T,routeModule:()=>x,serverHooks:()=>b,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>k});var s={};i.r(s),i.d(s,{POST:()=>m});var r=i(19227),o=i(39044),n=i(11131),a=i(57642),l=i(34621),c=i(89343),u=i(27650),d=i(44325),p=i(67200);let w=p.z.object({token:p.z.string({required_error:"token is required.",invalid_type_error:"token must be a string."}).min(1,"token cannot be empty."),token_type_hint:p.z.enum(["access_token","refresh_token"]).optional(),client_id:p.z.string().optional()}),h=p.z.object({active:p.z.literal(!0),scope:p.z.string().optional(),client_id:p.z.string(),username:p.z.string().optional(),token_type:p.z.string().optional(),exp:p.z.number().int().positive().optional(),iat:p.z.number().int().positive().optional(),nbf:p.z.number().int().positive().optional(),sub:p.z.string().optional(),aud:p.z.union([p.z.string(),p.z.array(p.z.string())]).optional(),iss:p.z.string().optional(),jti:p.z.string().optional(),permissions:p.z.array(p.z.string()).optional(),user_id:p.z.string().optional()}),f=p.z.object({active:p.z.literal(!1)});p.z.union([h,f]);var v=i(24931);async function g(e){if("application/x-www-form-urlencoded"!==e.headers.get("content-type"))throw new v.gz("Unsupported Media Type. Please use application/x-www-form-urlencoded.",v.Fw.InvalidRequest,415,void 0,{expectedContentType:"application/x-www-form-urlencoded"});let t=new URLSearchParams(await e.text()),i={};t.forEach((e,t)=>{i[t]=e});let s=new FormData;t.forEach((e,t)=>{s.append(t,e)});let r=await u.B.authenticateClient(e,s);console.log(`Introspection request authenticated for client: ${r.clientId}`);let o=w.safeParse(i);if(!o.success)throw new v.gz(o.error.errors[0]?.message||"Invalid introspection request parameters.",v.Fw.InvalidRequest,400,void 0,{issues:o.error.flatten().fieldErrors});if(o.data.client_id&&o.data.client_id!==r.clientId)throw new v.gz("client_id in body does not match authenticated client.",v.Fw.InvalidRequest,400);let{token:n,token_type_hint:c}=o.data,p=null;if("access_token"===c||!c){let e=await d.DU.verifyAccessToken(n);if(e.valid&&e.payload){let t=e.payload;if(t.jti&&await l.prisma.tokenBlacklist.findUnique({where:{jti:t.jti}}))return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is blacklisted."},{status:200});let i=await l.prisma.accessToken.findFirst({where:{tokenHash:d.DU.getTokenHash(n),expiresAt:{gt:new Date}},include:{user:!0}});i&&t.sub===i.userId&&(p={active:!0,scope:(t.scope||i.scope)??void 0,client_id:t.client_id,username:i.user?.username||void 0,sub:t.sub,aud:t.aud??void 0,iss:t.iss,exp:t.exp,iat:t.iat,jti:t.jti,token_type:"Bearer",user_id:i.userId??void 0,permissions:t.permissions??void 0})}}if(!p&&("refresh_token"===c||!c)){let e=await d.DU.verifyRefreshToken(n);if(e.valid&&e.payload){let t=e.payload;if(t.jti&&await l.prisma.tokenBlacklist.findUnique({where:{jti:t.jti}}))return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is blacklisted."},{status:200});let i=await l.prisma.refreshToken.findFirst({where:{tokenHash:d.DU.getTokenHash(n),isRevoked:!1,expiresAt:{gt:new Date}},include:{user:!0}});i&&t.sub===i.userId&&(p={active:!0,scope:(t.scope||i.scope)??void 0,client_id:t.client_id,username:i.user?.username||void 0,sub:t.sub,aud:t.aud??void 0,iss:t.iss,exp:t.exp,iat:t.iat,jti:t.jti,token_type:"refresh_token",user_id:i.userId??void 0})}}if(p){if(!p.client_id)return console.warn("Active token introspection, but client_id could not be determined from token payload. Marking inactive."),a.NextResponse.json({success:!0,data:{active:!1},message:"Token details inconsistent (missing client_id in token)."},{status:200});let e=h.safeParse(p);if(e.success)return a.NextResponse.json({success:!0,data:e.data,message:"Token is active."},{status:200});throw console.error("Introspection active response schema validation failed:",e.error.flatten()),new v.j1("Internal server error processing token details for active token.",{zodIssues:e.error.flatten().fieldErrors})}return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is not active."},{status:200})}let m=(0,c.U)(g),x=new r.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/oauth/introspect/route",pathname:"/api/v2/oauth/introspect",filename:"route",bundlePath:"app/api/v2/oauth/introspect/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/introspect/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:k,serverHooks:b}=x;function T(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:k})}},34621:(e,t,i)=>{"use strict";i.d(t,{prisma:()=>s.z}),i(96330);var s=i(24958),r=i(50488),o=i.n(r),n=i(5433);o().config();let a={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},l=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:a.host,port:a.port,user:a.user,database:a.database}),n.createPool(a));async function c(){if(l&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await l.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await c(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},41204:e=>{"use strict";e.exports=require("string_decoder")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},83997:e=>{"use strict";e.exports=require("tty")},89343:(e,t,i)=>{"use strict";i.d(t,{U:()=>s.Uj});var s=i(60123)},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[938,176,733,200,578,987,706,855],()=>i(34470));module.exports=s})();