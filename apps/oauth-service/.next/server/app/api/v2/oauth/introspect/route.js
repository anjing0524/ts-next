"use strict";(()=>{var e={};e.id=748,e.ids=[748],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34470:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>_,routeModule:()=>w,serverHooks:()=>z,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{POST:()=>h});var i=r(19227),o=r(39044),n=r(11131),a=r(57642),p=r(93952),u=r(89343),d=r(49922),c=r(50595),l=r(67200);let v=l.z.object({token:l.z.string({required_error:"token is required.",invalid_type_error:"token must be a string."}).min(1,"token cannot be empty."),token_type_hint:l.z.enum(["access_token","refresh_token"]).optional(),client_id:l.z.string().optional()}),x=l.z.object({active:l.z.literal(!0),scope:l.z.string().optional(),client_id:l.z.string(),username:l.z.string().optional(),token_type:l.z.string().optional(),exp:l.z.number().int().positive().optional(),iat:l.z.number().int().positive().optional(),nbf:l.z.number().int().positive().optional(),sub:l.z.string().optional(),aud:l.z.union([l.z.string(),l.z.array(l.z.string())]).optional(),iss:l.z.string().optional(),jti:l.z.string().optional(),permissions:l.z.array(l.z.string()).optional(),user_id:l.z.string().optional()}),f=l.z.object({active:l.z.literal(!1)});l.z.union([x,f]);var k=r(24931);async function m(e){if("application/x-www-form-urlencoded"!==e.headers.get("content-type"))throw new k.gz("Unsupported Media Type. Please use application/x-www-form-urlencoded.",k.Fw.InvalidRequest,415,void 0,{expectedContentType:"application/x-www-form-urlencoded"});let t=new URLSearchParams(await e.text()),r={};t.forEach((e,t)=>{r[t]=e});let s=new FormData;t.forEach((e,t)=>{s.append(t,e)});let i=await d.Bu.authenticateClient(e,s);console.log(`Introspection request authenticated for client: ${i.clientId}`);let o=v.safeParse(r);if(!o.success)throw new k.gz(o.error.errors[0]?.message||"Invalid introspection request parameters.",k.Fw.InvalidRequest,400,void 0,{issues:o.error.flatten().fieldErrors});if(o.data.client_id&&o.data.client_id!==i.clientId)throw new k.gz("client_id in body does not match authenticated client.",k.Fw.InvalidRequest,400);let{token:n,token_type_hint:u}=o.data,l=null;if("access_token"===u||!u){let e=await c.DU.verifyAccessToken(n);if(e.valid&&e.payload){let t=e.payload;if(t.jti&&await p.z.tokenBlacklist.findUnique({where:{jti:t.jti}}))return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is blacklisted."},{status:200});let r=await p.z.accessToken.findFirst({where:{tokenHash:c.DU.getTokenHash(n),expiresAt:{gt:new Date}},include:{user:!0}});r&&t.sub===r.userId&&(l={active:!0,scope:(t.scope||r.scope)??void 0,client_id:t.client_id,username:r.user?.username||void 0,sub:t.sub,aud:t.aud??void 0,iss:t.iss,exp:t.exp,iat:t.iat,jti:t.jti,token_type:"Bearer",user_id:r.userId??void 0,permissions:t.permissions??void 0})}}if(!l&&("refresh_token"===u||!u)){let e=await c.DU.verifyRefreshToken(n);if(e.valid&&e.payload){let t=e.payload;if(t.jti&&await p.z.tokenBlacklist.findUnique({where:{jti:t.jti}}))return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is blacklisted."},{status:200});let r=await p.z.refreshToken.findFirst({where:{tokenHash:c.DU.getTokenHash(n),isRevoked:!1,expiresAt:{gt:new Date}},include:{user:!0}});r&&t.sub===r.userId&&(l={active:!0,scope:(t.scope||r.scope)??void 0,client_id:t.client_id,username:r.user?.username||void 0,sub:t.sub,aud:t.aud??void 0,iss:t.iss,exp:t.exp,iat:t.iat,jti:t.jti,token_type:"refresh_token",user_id:r.userId??void 0})}}if(l){if(!l.client_id)return console.warn("Active token introspection, but client_id could not be determined from token payload. Marking inactive."),a.NextResponse.json({success:!0,data:{active:!1},message:"Token details inconsistent (missing client_id in token)."},{status:200});let e=x.safeParse(l);if(e.success)return a.NextResponse.json({success:!0,data:e.data,message:"Token is active."},{status:200});throw console.error("Introspection active response schema validation failed:",e.error.flatten()),new k.j1("Internal server error processing token details for active token.",{zodIssues:e.error.flatten().fieldErrors})}return a.NextResponse.json({success:!0,data:{active:!1},message:"Token is not active."},{status:200})}let h=(0,u.U)(m),w=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/oauth/introspect/route",pathname:"/api/v2/oauth/introspect",filename:"route",bundlePath:"app/api/v2/oauth/introspect/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/introspect/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:q,serverHooks:z}=w;function _(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:q})}},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},89343:(e,t,r)=>{r.d(t,{U:()=>s.Uj});var s=r(60123)},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[938,176,344,196,578,987,466,855,119,64,922],()=>r(34470));module.exports=s})();