"use strict";(()=>{var e={};e.id=740,e.ids=[740],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1630:e=>{e.exports=require("http")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},2412:e=>{e.exports=require("assert")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},3997:e=>{e.exports=require("tty")},4075:e=>{e.exports=require("zlib")},4300:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>b,routeModule:()=>U,serverHooks:()=>N,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>R});var i={};r.r(i),r.d(i,{POST:()=>A});var a=r(9227),n=r(9044),s=r(1131),o=r(7642),d=r(8891),c=r(6330),l=r(9776),u=r(4654),p=r(3952),_=r(7625);function I(e,t,r){let i=(0,_.a)(e,r?.in);return isNaN(t)?(0,p.w)(r?.in||e,NaN):(t&&i.setDate(i.getDate()+t),i)}var h=r(4931),f=r(9343),g=r(7200);let w=g.z.string({required_error:"client_id is required.",invalid_type_error:"client_id must be a string."}).min(1,"client_id cannot be empty."),v=g.z.string({required_error:"client_secret is required for confidential clients.",invalid_type_error:"client_secret must be a string."}).min(1,"client_secret cannot be empty."),k=g.z.string().optional(),T=g.z.object({grant_type:g.z.literal("authorization_code"),code:g.z.string({required_error:"code is required."}).min(1,"code cannot be empty."),redirect_uri:g.z.string({required_error:"redirect_uri is required."}).url({message:"redirect_uri must be a valid URL."}),client_id:w,code_verifier:g.z.string({required_error:"code_verifier is required for PKCE."}).min(43,"code_verifier must be at least 43 characters for PKCE.").max(128,"code_verifier must be at most 128 characters.")}),E=g.z.object({grant_type:g.z.literal("client_credentials"),scope:k,client_id:w.optional(),client_secret:v.optional()}),m=g.z.object({grant_type:g.z.literal("refresh_token"),refresh_token:g.z.string({required_error:"refresh_token is required."}).min(1,"refresh_token cannot be empty."),scope:k,client_id:w.optional(),client_secret:v.optional()});async function y(e){let t=await e.formData(),r=t.get("grant_type"),i={};t.forEach((e,t)=>{i[t]=e});let a=await l.Bu.authenticateClient(e,t);if(!i.client_id&&a.clientId&&(i.client_id=a.clientId),!r)throw new h.gz("grant_type is required.",h.Fw.InvalidRequest);switch(r){case"authorization_code":{let e=T.safeParse(i);if(!e.success)throw new h.gz(e.error.errors[0]?.message||"Invalid parameters for authorization_code grant.",h.Fw.InvalidRequest,400,void 0,e.error.flatten().fieldErrors);return await S(e.data,a)}case"refresh_token":{let e=m.safeParse(i);if(!e.success)throw new h.gz(e.error.errors[0]?.message||"Invalid parameters for refresh_token grant.",h.Fw.InvalidRequest,400,void 0,e.error.flatten().fieldErrors);return await C(e.data,a)}case"client_credentials":{let e=E.safeParse(i);if(!e.success)throw new h.gz(e.error.errors[0]?.message||"Invalid parameters for client_credentials grant.",h.Fw.InvalidRequest,400,void 0,e.error.flatten().fieldErrors);return await z(e.data,a)}default:throw new h.gz(`Unsupported grant_type: ${r}`,h.Fw.UnsupportedGrantType)}}g.z.discriminatedUnion("grant_type",[T,E,m]),g.z.object({access_token:g.z.string().min(1),token_type:g.z.literal("Bearer"),expires_in:g.z.number().int().positive(),refresh_token:g.z.string().min(1).optional(),scope:g.z.string().optional()}),g.z.object({error:g.z.string().min(1),error_description:g.z.string().optional(),error_uri:g.z.string().url().optional()});let A=(0,f.U)(y);async function S(e,t){let i,a;if(e.client_id&&e.client_id!==t.clientId)throw new h.gz("client_id in body does not match authenticated client.",h.Fw.InvalidRequest);let{code:n,redirect_uri:s,code_verifier:c}=e,p=void 0,_=void 0;try{let e=await d.A.authorizationCode.findUnique({where:{code:n},include:{client:!0,user:!0}});if(!e||e.expiresAt<new Date)throw new h.gz("Invalid or expired authorization code",h.Fw.InvalidGrant,400);if(e.isUsed)throw new h.gz("Authorization code has already been used",h.Fw.InvalidGrant,400);i=await r.e(930).then(r.bind(r,2930)).then(e=>e.validateAuthorizationCode(n,t.id,s,c))}catch(e){if(e instanceof h.CE||e instanceof h.Pb||e instanceof h.yI||e instanceof h.v3)throw await l.PC.logAuditEvent({clientId:t.id,action:"TOKEN_AUTH_CODE_VALIDATION_FAILURE",ipAddress:p,userAgent:_,success:!1,errorMessage:e.message,metadata:{grantType:"authorization_code",errorName:e.name,errorCode:e.code||e.errorCode||h.Fw.InvalidGrant,context:e.context,codeUsed:n}}),new h.gz(e.message,h.Fw.InvalidGrant,e.status,void 0,e.context);throw console.error("Unexpected error during authorization code validation:",e),await l.PC.logAuditEvent({actorType:"SYSTEM",actorId:"tokenEndpoint",clientId:t.clientId,action:"TOKEN_AUTH_CODE_UNEXPECTED_ERROR",status:"FAILURE",ipAddress:p,userAgent:_,errorMessage:"Authorization code validation failed due to an unexpected server error.",details:JSON.stringify({grantType:"authorization_code",originalErrorName:e.name,originalMessage:e.message,codeUsed:n})}),new h.gz("Authorization code validation failed due to an unexpected server error.",h.Fw.ServerError,500,void 0,{originalErrorName:e.name,originalMessage:e.message})}let f=await d.A.user.findUnique({where:{id:i.userId}});if(!f||!f.isActive)throw await l.PC.logAuditEvent({userId:i.userId,actorType:"USER",actorId:i.userId,clientId:t.clientId,action:"TOKEN_AUTH_CODE_USER_INVALID",status:"FAILURE",ipAddress:p,userAgent:_,errorMessage:"User associated with authorization code not found or inactive.",details:JSON.stringify({grantType:"authorization_code",userId:i.userId,codeUsed:i.id})}),new h.gz("User associated with authorization code not found or inactive.",h.Fw.InvalidGrant);let g=await l.PC.getUserPermissions(i.userId),w=l.e8.parseScopes(i.scope),v=await l.DU.createAccessToken({client_id:t.clientId,user_id:i.userId,scope:i.scope,permissions:g}),k=await l.DU.createRefreshToken({client_id:t.clientId,user_id:i.userId,scope:i.scope});w.includes("openid")&&f&&(a=await l.DU.createIdToken(f,t,i.nonce||void 0));let T=t.accessTokenTtl||3600,E=t.refreshTokenTtl?Math.ceil(t.refreshTokenTtl/86400):30;try{await d.A.$transaction([d.A.accessToken.create({data:{token:v,tokenHash:l.DU.getTokenHash(v),userId:i.userId,clientId:t.id,scope:i.scope,expiresAt:(0,u.L)(new Date,T/3600)}}),d.A.refreshToken.create({data:{token:k,tokenHash:l.DU.getTokenHash(k),userId:i.userId,clientId:t.id,scope:i.scope,expiresAt:I(new Date,E)}})]),await l.PC.logAuditEvent({userId:i.userId,actorType:"USER",actorId:i.userId,clientId:t.clientId,action:"TOKEN_ISSUED_AUTH_CODE",status:"SUCCESS",ipAddress:p,userAgent:_,details:JSON.stringify({grantType:"authorization_code",scope:i.scope,accessTokenJti:(await l.DU.decodeTokenPayload(v,process.env.JWT_ACCESS_TOKEN_SECRET||"")).jti,refreshTokenJti:(await l.DU.decodeTokenPayload(k,process.env.JWT_REFRESH_TOKEN_SECRET||"")).jti,idTokenJti:a?(await l.DU.decodeTokenPayload(a,t.clientSecret||process.env.ID_TOKEN_SECRET||"")).jti:void 0})})}catch(e){throw console.error("Failed to store tokens for authorization_code grant:",e),await l.PC.logAuditEvent({userId:i?.userId,actorType:"SYSTEM",actorId:"tokenEndpoint",clientId:t.clientId,action:"TOKEN_AUTH_CODE_DB_STORE_FAILURE",status:"FAILURE",ipAddress:p,userAgent:_,errorMessage:"Failed to store tokens due to a database issue.",details:JSON.stringify({grantType:"authorization_code",userId:i?.userId,errorName:e.name,errorMessage:e.message})}),new h.gz("Failed to store tokens due to a server issue.",h.Fw.ServerError,500)}let m={access_token:v,token_type:"Bearer",expires_in:T,refresh_token:k,scope:i.scope,...a&&{id_token:a}};return o.NextResponse.json(m)}async function C(e,t){let r,i;if(e.client_id&&e.client_id!==t.clientId)throw new h.gz("client_id in body does not match authenticated client for refresh_token grant.",h.Fw.InvalidRequest);let{refresh_token:a,scope:n}=e;try{r=await l.DU.verifyAndDecodeRefreshToken(a,t)}catch(r){let e="Invalid refresh token.";throw r instanceof h.Pb?e=r.message:"JWSSignatureVerificationFailed"===r.name||"JWSInvalid"===r.name?e="Refresh token signature validation failed.":"JWTExpired"===r.name?e="Refresh token has expired (JWT validation).":r.message&&"string"==typeof r.message&&r.message.includes("client_id")?e=r.message:console.warn("Refresh token JWT decoding/basic validation failed:",r.name,r.message),await l.PC.logAuditEvent({clientId:t.clientId,action:"refresh_token_jwt_invalid",resource:"/api/v2/oauth/token",success:!1,errorMessage:`Invalid refresh token provided: ${e}`,metadata:{errorName:r.name,grant_type:"refresh_token"}}),new h.gz(e,h.Fw.InvalidGrant,void 0,void 0,{detail:`Initial JWT validation: ${e}`})}if(!r.jti)throw console.error("Refresh token is missing JTI. This is a critical issue."),await l.PC.logAuditEvent({userId:r.sub,clientId:t.clientId,action:"refresh_token_missing_jti",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Refresh token is missing JTI.",metadata:{client_id:t.clientId}}),new h.gz("Invalid refresh token: JTI missing.",h.Fw.InvalidGrant,void 0,void 0,{detail:"JTI missing from refresh token payload"});if(await d.A.tokenBlacklist.findUnique({where:{jti:r.jti}}))throw await l.PC.logAuditEvent({userId:r.sub,clientId:t.clientId,action:"refresh_token_jti_blacklisted",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Attempted to use a blacklisted refresh token JTI.",metadata:{jti:r.jti,client_id:t.clientId}}),new h.gz("Token has been revoked.",h.Fw.InvalidGrant,void 0,void 0,{detail:"Refresh token JTI is blacklisted."});let s=l.DU.getTokenHash(a),c=await d.A.refreshToken.findUnique({where:{tokenHash:s},include:{user:!0}});if(!c)throw await l.PC.logAuditEvent({userId:r.sub,clientId:t.clientId,action:"refresh_token_not_in_db_after_valid_jwt_jti",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Valid refresh token (JWT structure and JTI not blacklisted) not found in database.",metadata:{jti:r.jti,client_id:t.clientId,tokenHash:s}}),new h.gz("Refresh token not found in database despite valid structure.",h.Fw.InvalidGrant);if(c.isRevoked)throw await l.PC.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_already_rotated_or_db_revoked",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Attempted to use a refresh token that is marked as revoked in the database (likely rotated).",metadata:{jti:r.jti,storedTokenId:c.id,client_id:t.clientId}}),new h.gz("Refresh token has been used or specifically revoked.",h.Fw.InvalidGrant,void 0,void 0,{detail:"This refresh token instance is no longer valid."});if(c.expiresAt<new Date)throw await l.PC.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_db_expired",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Refresh token found to be expired based on database record.",metadata:{jti:r.jti,storedTokenId:c.id,client_id:t.clientId,expiry:c.expiresAt}}),new h.gz("Refresh token expired (database record).",h.Fw.InvalidGrant);if(c.clientId!==t.id)throw await l.PC.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_client_mismatch_db",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Refresh token record in DB belongs to a different client.",metadata:{jti:r.jti,storedTokenClientId:c.clientId,authenticatedClientId:t.id}}),new h.gz("Refresh token was not issued to this client (database validation).",h.Fw.InvalidGrant);if(!c.userId||!c.user)throw new h.gz("User information missing from refresh token record or user data inconsistent.",h.Fw.InvalidGrant);if(!c.user.isActive)throw await l.PC.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_user_inactive_db",resource:"/api/v2/oauth/token",success:!1,errorMessage:"User associated with refresh token is inactive (database check).",metadata:{jti:r.jti,userId:c.userId}}),new h.gz("User associated with refresh token is inactive.",h.Fw.InvalidGrant);let p=l.e8.parseScopes(c.scope||""),_=c.scope||"";if(n){let e=l.e8.parseScopes(n);if(e.some(e=>!p.includes(e)))throw new h.gz("Requested scope exceeds originally granted scope.",h.Fw.InvalidScope);_=l.e8.formatScopes(e)}let f=l.e8.parseScopes(_),g=await l.PC.getUserPermissions(c.userId),w=await l.DU.createAccessToken({client_id:t.clientId,user_id:c.userId,scope:_,permissions:g});f.includes("openid")&&c.user&&(i=await l.DU.createIdToken(c.user,t,void 0));let v=t.accessTokenTtl||3600,k=t.refreshTokenTtl?Math.ceil(t.refreshTokenTtl/86400):30,T=await l.DU.createRefreshToken({client_id:t.clientId,user_id:c.userId,scope:_});try{await d.A.$transaction([d.A.accessToken.create({data:{token:w,tokenHash:l.DU.getTokenHash(w),userId:c.userId,clientId:t.id,scope:_,expiresAt:(0,u.L)(new Date,v/3600)}}),d.A.refreshToken.update({where:{id:c.id},data:{isRevoked:!0,revokedAt:new Date}}),d.A.refreshToken.create({data:{token:T,tokenHash:l.DU.getTokenHash(T),userId:c.userId,clientId:t.id,scope:_,expiresAt:I(new Date,k),previousTokenId:c.id}})]),await l.PC.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_rotated_successfully",resource:"/api/v2/oauth/token",success:!0,metadata:{old_refresh_token_id:c.id,new_refresh_token_jti:(await l.DU.decodeTokenPayload(T,process.env.JWT_REFRESH_TOKEN_SECRET||"")).jti,new_access_token_jti:(await l.DU.decodeTokenPayload(w,process.env.JWT_ACCESS_TOKEN_SECRET||"")).jti,granted_scope:_}})}catch(e){throw console.error("Failed to rotate refresh token and store new tokens:",e),await l.PC.logAuditEvent({userId:c?.userId||r?.sub,clientId:t.clientId,action:"refresh_token_rotation_failed_db_error",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Database transaction failed during refresh token rotation.",metadata:{error:e?.message||String(e),old_refresh_token_id:c?.id,jti_of_token_presented:r?.jti}}),new h.gz("Failed to process token refresh due to a server issue.",h.Fw.ServerError,500)}let E={access_token:w,token_type:"Bearer",expires_in:v,refresh_token:T,scope:_||"",...i&&{id_token:i}};return o.NextResponse.json(E)}async function z(e,t){let r;if(e.client_id&&e.client_id!==t.clientId)throw new h.gz("client_id in body does not match authenticated client for client_credentials grant.",h.Fw.InvalidRequest);let i=void 0,a=void 0;if(t.clientType===c.ClientType.PUBLIC)throw await l.PC.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_PUBLIC_CLIENT_DENIED",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:"Public clients are not permitted to use the client_credentials grant type.",details:JSON.stringify({grantType:"client_credentials"})}),new h.gz("Public clients are not permitted to use the client_credentials grant type.",h.Fw.UnauthorizedClient);let n=e.scope,s=[];try{t.allowedScopes&&(s=JSON.parse(t.allowedScopes),Array.isArray(s)||(s=[]))}catch(e){console.error("Failed to parse client.allowedScopes for client_credentials",t.id,e),s=[]}if(n){let e=l.e8.parseScopes(n),s=await l.e8.validateScopes(e,t);if(!s.valid)throw await l.PC.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_SCOPE_INVALID",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:s.error_description||"Requested scope is invalid or not allowed for this client.",details:JSON.stringify({grantType:"client_credentials",requestedScope:n,invalidScopes:s.invalidScopes})}),new h.gz(s.error_description||"Requested scope is invalid or not allowed for this client.",h.Fw.InvalidScope);r=l.e8.formatScopes(e)}else if(s.length>0){let e=await l.e8.validateScopes(s,t);if(!e.valid)throw console.warn(`Client ${t.clientId} has default scopes that are no longer valid: ${e.invalidScopes.join(", ")}`),await l.PC.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_DEFAULT_SCOPE_INVALID",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:"Client default scopes are currently invalid. Please check client configuration.",details:JSON.stringify({grantType:"client_credentials",defaultScopes:s,invalidScopes:e.invalidScopes})}),new h.gz("Client default scopes are currently invalid. Please check client configuration.",h.Fw.InvalidScope);r=l.e8.formatScopes(s)}let p=await l.DU.createAccessToken({client_id:t.clientId,scope:r,permissions:[]}),_=t.accessTokenTtl||3600;try{await d.A.accessToken.create({data:{token:p,tokenHash:l.DU.getTokenHash(p),clientId:t.id,userId:void 0,scope:r||void 0,expiresAt:(0,u.L)(new Date,_/3600)}}),await l.PC.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_ISSUED_CLIENT_CREDENTIALS",status:"SUCCESS",ipAddress:i,userAgent:a,details:JSON.stringify({grantType:"client_credentials",scope:r,accessTokenJti:(await l.DU.decodeTokenPayload(p,process.env.JWT_ACCESS_TOKEN_SECRET||"")).jti})})}catch(e){throw console.error("Failed to store client credentials access token:",e),await l.PC.logAuditEvent({actorType:"SYSTEM",actorId:"tokenEndpoint",clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_DB_STORE_FAILURE",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:"Failed to store access token due to a database issue.",details:JSON.stringify({grantType:"client_credentials",errorName:e.name,errorMessage:e.message})}),new h.gz("Failed to store access token due to a server issue.",h.Fw.ServerError,500)}let I={access_token:p,token_type:"Bearer",expires_in:_,scope:r||""};return o.NextResponse.json(I)}let U=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/oauth/token/route",pathname:"/api/v2/oauth/token",filename:"route",bundlePath:"app/api/v2/oauth/token/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/token/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:x,workUnitAsyncStorage:R,serverHooks:N}=U;function b(){return(0,s.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:R})}},4631:e=>{e.exports=require("tls")},4654:(e,t,r)=>{r.d(t,{L:()=>n});var i=r(9039),a=r(5547);function n(e,t,r){return(0,i.A)(e,t*a.s0,r)}},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4985:e=>{e.exports=require("dns")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},5591:e=>{e.exports=require("https")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9343:(e,t,r)=>{r.d(t,{U:()=>i.Uj});var i=r(3117)},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,344,176,578,434,200,470,776,555],()=>r(4300));module.exports=i})();