"use strict";(()=>{var e={};e.id=740,e.ids=[740],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},23040:(e,t,r)=>{r.d(t,{i:()=>o});var i=r(88022),a=r(55937),n=r(46159),s=r(1047);function o(e){let t,r;if("string"!=typeof e)throw new s.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:o,length:d}=e.split(".");if(5===d)throw new s.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==d)throw new s.Dp("Invalid JWT");if(!o)throw new s.Dp("JWTs must contain a payload");try{t=(0,i.D)(o)}catch{throw new s.Dp("Failed to base64url decode the payload")}try{r=JSON.parse(a.D0.decode(t))}catch{throw new s.Dp("Failed to parse the decoded payload as JSON")}if(!(0,n.A)(r))throw new s.Dp("Invalid JWT Claims Set");return r}},24931:(e,t,r)=>{r.d(t,{CE:()=>i.CE,Fw:()=>i.Fw,gz:()=>i.gz,j1:()=>i.j1});var i=r(55807)},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31551:(e,t,r)=>{r.d(t,{B:()=>c});var i=r(23040),a=r(97151),n=r(27819),s=r(1047),o=r(34621),d=r(24931);class c{static async authenticateClient(e,t){let r=t.get("client_id"),i=t.get("client_secret"),a=t.get("client_assertion_type"),n=t.get("client_assertion"),s=e.headers.get("authorization");if(s&&s.toLowerCase().startsWith("basic "))try{let e=s.slice(6),[t,a]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&a&&(r=r||t,i=i||a)}catch{throw new d.gz("Invalid Basic authentication header format.",d.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===a&&n)return await this.authenticateWithJWT(n,e);if(r&&i)return await this.authenticateWithSecret(r,i);if(r&&!i){let e=await o.prisma.oAuthClient.findUnique({where:{clientId:r,isActive:!0}});if(!e)throw new d.gz("Client not found.",d.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new d.gz("客户端不是公开客户端，需要身份验证",d.Fw.InvalidClient,401);return e}throw new d.gz("Client authentication required but not provided or method not supported.",d.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let i=await o.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!i)throw new d.gz("Invalid client ID or client not active.",d.Fw.InvalidClient,401);if("PUBLIC"===i.clientType)throw new d.gz("公开客户端试图使用密钥进行身份验证",d.Fw.InvalidClient,400);if(!i.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new d.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(r.t.bind(r,5486,23));if(!await e.compare(t,i.clientSecret))throw new d.gz("客户端密钥无效",d.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new d.j1("客户端密钥验证期间发生错误")}return i}static async authenticateWithJWT(e,t){try{let r=i.i(e);if(!r.iss||!r.sub||r.iss!==r.sub)throw new d.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",d.Fw.InvalidClient,400);let s=r.iss,c=await o.prisma.oAuthClient.findUnique({where:{clientId:s,isActive:!0}});if(!c)throw new d.gz("Client specified in JWT assertion not found or not active.",d.Fw.InvalidClient,401);if(!c.jwksUri)throw new d.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let l=this.getTokenEndpointUrl(t),u=a.RD(new URL(c.jwksUri));return await n.V(e,u,{issuer:s,audience:l,algorithms:["RS256","ES256","PS256"]}),c}catch(r){console.error("Client JWT assertion validation failed:",r);let e="Client assertion validation failed.",t=d.Fw.InvalidClient;if(r instanceof s.n)e="Client assertion has expired.",t=d.Fw.InvalidGrant;else if(r instanceof s.ie)e=`Client assertion claim validation failed: ${r.claim} ${r.reason}.`;else if(r instanceof s.h2)e="Client assertion signature verification failed.";else if(r instanceof d.j1)throw r;throw new d.gz(e,t,400,void 0,{originalError:r.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),r=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),i=e.headers.get("x-forwarded-host")||t.host,a=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${r}://${i}${a}`}}},33873:e=>{e.exports=require("path")},34300:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>F,routeModule:()=>b,serverHooks:()=>D,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>x});var i={};r.r(i),r.d(i,{POST:()=>C});var a=r(19227),n=r(39044),s=r(11131),o=r(57642),d=r(34621),c=r(96330),l=r(50595),u=r(51041),p=r(44654),h=r(47923),w=r(47625);function _(e,t,r){let i=(0,w.a)(e,r?.in);return isNaN(t)?(0,h.w)(r?.in||e,NaN):(t&&i.setDate(i.getDate()+t),i)}var f=r(55807),I=r(86933),g=r(67200);let v=g.z.string({required_error:"client_id is required.",invalid_type_error:"client_id must be a string."}).min(1,"client_id cannot be empty."),k=g.z.string({required_error:"client_secret is required for confidential clients.",invalid_type_error:"client_secret must be a string."}).min(1,"client_secret cannot be empty."),m=g.z.string().optional(),T=g.z.object({grant_type:g.z.literal("authorization_code"),code:g.z.string({required_error:"code is required."}).min(1,"code cannot be empty."),redirect_uri:g.z.string({required_error:"redirect_uri is required."}).url({message:"redirect_uri must be a valid URL."}),client_id:v,code_verifier:g.z.string({required_error:"code_verifier is required for PKCE."}).min(43,"code_verifier must be at least 43 characters for PKCE.").max(128,"code_verifier must be at most 128 characters.")}),E=g.z.object({grant_type:g.z.literal("client_credentials"),scope:m,client_id:v.optional(),client_secret:k.optional()}),y=g.z.object({grant_type:g.z.literal("refresh_token"),refresh_token:g.z.string({required_error:"refresh_token is required."}).min(1,"refresh_token cannot be empty."),scope:m,client_id:v.optional(),client_secret:k.optional()});async function S(e){let t=await e.formData(),r=t.get("grant_type"),i={};t.forEach((e,t)=>{i[t]=e});let a=await u.B.authenticateClient(e,t);if(!i.client_id&&a.clientId&&(i.client_id=a.clientId),!r)throw new f.gz("grant_type is required.",f.Fw.InvalidRequest);switch(r){case"authorization_code":{let e=T.safeParse(i);if(!e.success)throw new f.gz(e.error.errors[0]?.message||"Invalid parameters for authorization_code grant.",f.Fw.InvalidRequest,400,void 0,e.error.flatten().fieldErrors);return await A(e.data,a)}case"refresh_token":{let e=y.safeParse(i);if(!e.success)throw new f.gz(e.error.errors[0]?.message||"Invalid parameters for refresh_token grant.",f.Fw.InvalidRequest,400,void 0,e.error.flatten().fieldErrors);return await U(e.data,a)}case"client_credentials":{let e=E.safeParse(i);if(!e.success)throw new f.gz(e.error.errors[0]?.message||"Invalid parameters for client_credentials grant.",f.Fw.InvalidRequest,400,void 0,e.error.flatten().fieldErrors);return await z(e.data,a)}default:throw new f.gz(`Unsupported grant_type: ${r}`,f.Fw.UnsupportedGrantType)}}g.z.discriminatedUnion("grant_type",[T,E,y]),g.z.object({access_token:g.z.string().min(1),token_type:g.z.literal("Bearer"),expires_in:g.z.number().int().positive(),refresh_token:g.z.string().min(1).optional(),scope:g.z.string().optional()}),g.z.object({error:g.z.string().min(1),error_description:g.z.string().optional(),error_uri:g.z.string().url().optional()});let C=(0,I.Uj)(S);async function A(e,t){let i,a;if(e.client_id&&e.client_id!==t.clientId)throw new f.gz("client_id in body does not match authenticated client.",f.Fw.InvalidRequest);let{code:n,redirect_uri:s,code_verifier:c}=e,h=void 0,w=void 0;try{let e=await d.prisma.authorizationCode.findUnique({where:{code:n},include:{client:!0,user:!0}});if(!e||e.expiresAt<new Date)throw new f.gz("Invalid or expired authorization code",f.Fw.InvalidGrant,400);if(e.isUsed)throw new f.gz("Authorization code has already been used",f.Fw.InvalidGrant,400);i=await r.e(890).then(r.bind(r,71890)).then(e=>e.validateAuthorizationCode(n,t.id,s,c))}catch(e){if(e instanceof f.CE||e instanceof f.Pb||e instanceof f.yI||e instanceof f.v3)throw await u.P.logAuditEvent({clientId:t.id,action:"TOKEN_AUTH_CODE_VALIDATION_FAILURE",ipAddress:h,userAgent:w,success:!1,errorMessage:e.message,metadata:{grantType:"authorization_code",errorName:e.name,errorCode:e.code||e.errorCode||f.Fw.InvalidGrant,context:e.context,codeUsed:n}}),new f.gz(e.message,f.Fw.InvalidGrant,e.status,void 0,e.context);throw console.error("Unexpected error during authorization code validation:",e),await u.P.logAuditEvent({actorType:"SYSTEM",actorId:"tokenEndpoint",clientId:t.clientId,action:"TOKEN_AUTH_CODE_UNEXPECTED_ERROR",status:"FAILURE",ipAddress:h,userAgent:w,errorMessage:"Authorization code validation failed due to an unexpected server error.",details:JSON.stringify({grantType:"authorization_code",originalErrorName:e.name,originalMessage:e.message,codeUsed:n})}),new f.gz("Authorization code validation failed due to an unexpected server error.",f.Fw.ServerError,500,void 0,{originalErrorName:e.name,originalMessage:e.message})}let I=await d.prisma.user.findUnique({where:{id:i.userId}});if(!I||!I.isActive)throw await u.P.logAuditEvent({userId:i.userId,actorType:"USER",actorId:i.userId,clientId:t.clientId,action:"TOKEN_AUTH_CODE_USER_INVALID",status:"FAILURE",ipAddress:h,userAgent:w,errorMessage:"User associated with authorization code not found or inactive.",details:JSON.stringify({grantType:"authorization_code",userId:i.userId,codeUsed:i.id})}),new f.gz("User associated with authorization code not found or inactive.",f.Fw.InvalidGrant);let g=await u.P.getUserPermissions(i.userId),v=l.e8.parseScopes(i.scope),k=await l.DU.createAccessToken({client_id:t.clientId,user_id:i.userId,scope:i.scope,permissions:g}),m=await l.DU.createRefreshToken({client_id:t.clientId,user_id:i.userId,scope:i.scope,token_type:"refresh_token"});v.includes("openid")&&I&&(a=await l.DU.createIdToken({sub:I.id,aud:t.clientId,name:I.displayName||I.username||void 0,nonce:i.nonce||void 0}));let T=t.accessTokenTtl||3600,E=t.refreshTokenTtl?Math.ceil(t.refreshTokenTtl/86400):30;try{await d.prisma.$transaction([d.prisma.accessToken.create({data:{token:k,tokenHash:l.DU.getTokenHash(k),userId:i.userId,clientId:t.id,scope:i.scope,expiresAt:(0,p.L)(new Date,T/3600)}}),d.prisma.refreshToken.create({data:{token:m,tokenHash:l.DU.getTokenHash(m),userId:i.userId,clientId:t.id,scope:i.scope,expiresAt:_(new Date,E)}})]),await u.P.logAuditEvent({userId:i.userId,actorType:"USER",actorId:i.userId,clientId:t.clientId,action:"TOKEN_ISSUED_AUTH_CODE",status:"SUCCESS",ipAddress:h,userAgent:w,details:JSON.stringify({grantType:"authorization_code",scope:i.scope,accessTokenJti:(await l.DU.decodeTokenPayload(k,process.env.JWT_ACCESS_TOKEN_SECRET||"")).jti,refreshTokenJti:(await l.DU.decodeTokenPayload(m,process.env.JWT_REFRESH_TOKEN_SECRET||"")).jti,idTokenJti:a?(await l.DU.decodeTokenPayload(a,t.clientSecret||process.env.ID_TOKEN_SECRET||"")).jti:void 0})})}catch(e){throw console.error("Failed to store tokens for authorization_code grant:",e),await u.P.logAuditEvent({userId:i?.userId,actorType:"SYSTEM",actorId:"tokenEndpoint",clientId:t.clientId,action:"TOKEN_AUTH_CODE_DB_STORE_FAILURE",status:"FAILURE",ipAddress:h,userAgent:w,errorMessage:"Failed to store tokens due to a database issue.",details:JSON.stringify({grantType:"authorization_code",userId:i?.userId,errorName:e.name,errorMessage:e.message})}),new f.gz("Failed to store tokens due to a server issue.",f.Fw.ServerError,500)}let y={access_token:k,token_type:"Bearer",expires_in:T,refresh_token:m,scope:i.scope,...a&&{id_token:a}};return o.NextResponse.json(y)}async function U(e,t){let r,i;if(e.client_id&&e.client_id!==t.clientId)throw new f.gz("client_id in body does not match authenticated client for refresh_token grant.",f.Fw.InvalidRequest);let{refresh_token:a,scope:n}=e;try{r=await l.DU.verifyAndDecodeRefreshToken(a,t)}catch(r){let e="Invalid refresh token.";throw r instanceof f.Pb?e=r.message:"JWSSignatureVerificationFailed"===r.name||"JWSInvalid"===r.name?e="Refresh token signature validation failed.":"JWTExpired"===r.name?e="Refresh token has expired (JWT validation).":r.message&&"string"==typeof r.message&&r.message.includes("client_id")?e=r.message:console.warn("Refresh token JWT decoding/basic validation failed:",r.name,r.message),await u.P.logAuditEvent({clientId:t.clientId,action:"refresh_token_jwt_invalid",resource:"/api/v2/oauth/token",success:!1,errorMessage:`Invalid refresh token provided: ${e}`,metadata:{errorName:r.name,grant_type:"refresh_token"}}),new f.gz(e,f.Fw.InvalidGrant,void 0,void 0,{detail:`Initial JWT validation: ${e}`})}if(!r.jti)throw console.error("Refresh token is missing JTI. This is a critical issue."),await u.P.logAuditEvent({userId:r.sub,clientId:t.clientId,action:"refresh_token_missing_jti",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Refresh token is missing JTI.",metadata:{client_id:t.clientId}}),new f.gz("Invalid refresh token: JTI missing.",f.Fw.InvalidGrant,void 0,void 0,{detail:"JTI missing from refresh token payload"});if(await d.prisma.tokenBlacklist.findUnique({where:{jti:r.jti}}))throw await u.P.logAuditEvent({userId:r.sub,clientId:t.clientId,action:"refresh_token_jti_blacklisted",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Attempted to use a blacklisted refresh token JTI.",metadata:{jti:r.jti,client_id:t.clientId}}),new f.gz("Token has been revoked.",f.Fw.InvalidGrant,void 0,void 0,{detail:"Refresh token JTI is blacklisted."});let s=l.DU.getTokenHash(a),c=await d.prisma.refreshToken.findUnique({where:{tokenHash:s},include:{user:!0}});if(!c)throw await u.P.logAuditEvent({userId:r.sub,clientId:t.clientId,action:"refresh_token_not_in_db_after_valid_jwt_jti",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Valid refresh token (JWT structure and JTI not blacklisted) not found in database.",metadata:{jti:r.jti,client_id:t.clientId,tokenHash:s}}),new f.gz("Refresh token not found in database despite valid structure.",f.Fw.InvalidGrant);if(c.isRevoked)throw await u.P.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_already_rotated_or_db_revoked",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Attempted to use a refresh token that is marked as revoked in the database (likely rotated).",metadata:{jti:r.jti,storedTokenId:c.id,client_id:t.clientId}}),new f.gz("Refresh token has been used or specifically revoked.",f.Fw.InvalidGrant,void 0,void 0,{detail:"This refresh token instance is no longer valid."});if(c.expiresAt<new Date)throw await u.P.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_db_expired",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Refresh token found to be expired based on database record.",metadata:{jti:r.jti,storedTokenId:c.id,client_id:t.clientId,expiry:c.expiresAt}}),new f.gz("Refresh token expired (database record).",f.Fw.InvalidGrant);if(c.clientId!==t.id)throw await u.P.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_client_mismatch_db",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Refresh token record in DB belongs to a different client.",metadata:{jti:r.jti,storedTokenClientId:c.clientId,authenticatedClientId:t.id}}),new f.gz("Refresh token was not issued to this client (database validation).",f.Fw.InvalidGrant);if(!c.userId||!c.user)throw new f.gz("User information missing from refresh token record or user data inconsistent.",f.Fw.InvalidGrant);if(!c.user.isActive)throw await u.P.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_user_inactive_db",resource:"/api/v2/oauth/token",success:!1,errorMessage:"User associated with refresh token is inactive (database check).",metadata:{jti:r.jti,userId:c.userId}}),new f.gz("User associated with refresh token is inactive.",f.Fw.InvalidGrant);let h=l.e8.parseScopes(c.scope||""),w=c.scope||"";if(n){let e=l.e8.parseScopes(n);if(e.some(e=>!h.includes(e)))throw new f.gz("Requested scope exceeds originally granted scope.",f.Fw.InvalidScope);w=l.e8.formatScopes(e)}let I=l.e8.parseScopes(w),g=await u.P.getUserPermissions(c.userId),v=await l.DU.createAccessToken({client_id:t.clientId,user_id:c.userId,scope:w,permissions:g});I.includes("openid")&&c.user&&(i=await l.DU.createIdToken({sub:c.user.id,aud:t.clientId,name:c.user.displayName||c.user.username||void 0}));let k=t.accessTokenTtl||3600,m=t.refreshTokenTtl?Math.ceil(t.refreshTokenTtl/86400):30,T=await l.DU.createRefreshToken({client_id:t.clientId,user_id:c.userId,scope:w,token_type:"refresh_token"});try{await d.prisma.$transaction([d.prisma.accessToken.create({data:{token:v,tokenHash:l.DU.getTokenHash(v),userId:c.userId,clientId:t.id,scope:w||"",expiresAt:(0,p.L)(new Date,k/3600)}}),d.prisma.refreshToken.update({where:{id:c.id},data:{isRevoked:!0,revokedAt:new Date}}),d.prisma.refreshToken.create({data:{token:T,tokenHash:l.DU.getTokenHash(T),userId:c.userId,clientId:t.id,scope:w||"",expiresAt:_(new Date,m),previousTokenId:c.id}})]),await u.P.logAuditEvent({userId:c.userId,clientId:t.clientId,action:"refresh_token_rotated_successfully",resource:"/api/v2/oauth/token",success:!0,metadata:{old_refresh_token_id:c.id,new_refresh_token_jti:(await l.DU.decodeTokenPayload(T,process.env.JWT_REFRESH_TOKEN_SECRET||"")).jti,new_access_token_jti:(await l.DU.decodeTokenPayload(v,process.env.JWT_ACCESS_TOKEN_SECRET||"")).jti,granted_scope:w}})}catch(e){throw console.error("Failed to rotate refresh token and store new tokens:",e),await u.P.logAuditEvent({userId:c?.userId||r?.sub,clientId:t.clientId,action:"refresh_token_rotation_failed_db_error",resource:"/api/v2/oauth/token",success:!1,errorMessage:"Database transaction failed during refresh token rotation.",metadata:{error:e?.message||String(e),old_refresh_token_id:c?.id,jti_of_token_presented:r?.jti}}),new f.gz("Failed to process token refresh due to a server issue.",f.Fw.ServerError,500)}let E={access_token:v,token_type:"Bearer",expires_in:k,refresh_token:T,scope:w||"",...i&&{id_token:i}};return o.NextResponse.json(E)}async function z(e,t){let r;if(e.client_id&&e.client_id!==t.clientId)throw new f.gz("client_id in body does not match authenticated client for client_credentials grant.",f.Fw.InvalidRequest);let i=void 0,a=void 0;if(t.clientType===c.ClientType.PUBLIC)throw await u.P.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_PUBLIC_CLIENT_DENIED",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:"Public clients are not permitted to use the client_credentials grant type.",details:JSON.stringify({grantType:"client_credentials"})}),new f.gz("Public clients are not permitted to use the client_credentials grant type.",f.Fw.UnauthorizedClient);let n=e.scope,s=[];try{t.allowedScopes&&(s=JSON.parse(t.allowedScopes),Array.isArray(s)||(s=[]))}catch(e){console.error("Failed to parse client.allowedScopes for client_credentials",t.id,e),s=[]}if(n){let e=l.e8.parseScopes(n),s=await l.e8.validateScopes(e,t);if(!s.valid)throw await u.P.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_SCOPE_INVALID",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:s.error_description||"Requested scope is invalid or not allowed for this client.",details:JSON.stringify({grantType:"client_credentials",requestedScope:n,invalidScopes:s.invalidScopes})}),new f.gz(s.error_description||"Requested scope is invalid or not allowed for this client.",f.Fw.InvalidScope);r=l.e8.formatScopes(e)}else if(s.length>0){let e=await l.e8.validateScopes(s,t);if(!e.valid)throw console.warn(`Client ${t.clientId} has default scopes that are no longer valid: ${e.invalidScopes.join(", ")}`),await u.P.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_DEFAULT_SCOPE_INVALID",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:"Client default scopes are currently invalid. Please check client configuration.",details:JSON.stringify({grantType:"client_credentials",defaultScopes:s,invalidScopes:e.invalidScopes})}),new f.gz("Client default scopes are currently invalid. Please check client configuration.",f.Fw.InvalidScope);r=l.e8.formatScopes(s)}let h=await l.DU.createAccessToken({client_id:t.clientId,scope:r,permissions:[]}),w=t.accessTokenTtl||3600;try{await d.prisma.accessToken.create({data:{token:h,tokenHash:l.DU.getTokenHash(h),clientId:t.id,userId:void 0,scope:r||"",expiresAt:(0,p.L)(new Date,w/3600)}}),await u.P.logAuditEvent({actorType:"CLIENT",actorId:t.clientId,clientId:t.clientId,action:"TOKEN_ISSUED_CLIENT_CREDENTIALS",status:"SUCCESS",ipAddress:i,userAgent:a,details:JSON.stringify({grantType:"client_credentials",scope:r,accessTokenJti:(await l.DU.decodeTokenPayload(h,process.env.JWT_ACCESS_TOKEN_SECRET||"")).jti})})}catch(e){throw console.error("Failed to store client credentials access token:",e),await u.P.logAuditEvent({actorType:"SYSTEM",actorId:"tokenEndpoint",clientId:t.clientId,action:"TOKEN_CLIENT_CREDENTIALS_DB_STORE_FAILURE",status:"FAILURE",ipAddress:i,userAgent:a,errorMessage:"Failed to store access token due to a database issue.",details:JSON.stringify({grantType:"client_credentials",errorName:e.name,errorMessage:e.message})}),new f.gz("Failed to store access token due to a server issue.",f.Fw.ServerError,500)}let _={access_token:h,token_type:"Bearer",expires_in:w,scope:r??""};return o.NextResponse.json(_)}let b=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/oauth/token/route",pathname:"/api/v2/oauth/token",filename:"route",bundlePath:"app/api/v2/oauth/token/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/token/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:R,workUnitAsyncStorage:x,serverHooks:D}=b;function F(){return(0,s.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:x})}},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51041:(e,t,r)=>{r.d(t,{P:()=>o,B:()=>i.B});var i=r(31551),a=r(55511),n=r(34621),s=r(84344);class o{static validateRedirectUri(e,t){return t.includes(e)}static validateResponseType(e,t=["code"]){return t.includes(e)}static generateState(){return a.randomBytes(32).toString("base64url")}static generateNonce(){return a.randomBytes(32).toString("base64url")}static generateAuthorizationCode(){return a.randomBytes(32).toString("hex")}static async logAuditEvent(e){try{let t="SYSTEM",r="system";if(e.userId)t="USER",r=e.userId;else if(e.clientId){t="CLIENT";let i=await n.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});r=i?i.clientId:e.clientId}let i=e.success;void 0===i&&(i=e.status?"SUCCESS"===e.status:!e.errorMessage),await n.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:r||"unknown",status:i?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:this.buildDetailsJson(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}}static buildDetailsJson(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let r=JSON.parse(e.details);t={...t,...r}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}static async getUserPermissions(e){try{let t=await s.S.getUserPermissions(e),r=new Set(t?.permissions||[]);return Array.from(r)}catch(e){return console.error("Error getting user permissions:",e),[]}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},84344:(e,t,r)=>{r.d(t,{S:()=>a});var i=r(24958);class a{static async getUserPermissions(e){let t=await i.z.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{include:{role:{include:{rolePermissions:{include:{permission:!0}}}}}}}});if(!t)return null;let r=t.userRoles.map(e=>e.role.name),a=new Set;return t.userRoles.forEach(e=>{e.role.rolePermissions.forEach(e=>{a.add(e.permission.name)})}),{userId:t.id,roles:r,permissions:Array.from(a),organizationContext:{organization:t.organization||void 0,department:t.department||void 0}}}}},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,176,344,196,578,987,855,119,874],()=>r(34300));module.exports=i})();