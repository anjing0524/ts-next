"use strict";(()=>{var e={};e.id=970,e.ids=[890,970],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},15547:(e,t,r)=>{r.d(t,{_P:()=>a,s0:()=>i});let i=36e5,a=Symbol.for("constructDateFrom")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},23040:(e,t,r)=>{r.d(t,{i:()=>s});var i=r(88022),a=r(55937),n=r(46159),o=r(1047);function s(e){let t,r;if("string"!=typeof e)throw new o.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:s,length:l}=e.split(".");if(5===l)throw new o.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==l)throw new o.Dp("Invalid JWT");if(!s)throw new o.Dp("JWTs must contain a payload");try{t=(0,i.D)(s)}catch{throw new o.Dp("Failed to base64url decode the payload")}try{r=JSON.parse(a.D0.decode(t))}catch{throw new o.Dp("Failed to parse the decoded payload as JSON")}if(!(0,n.A)(r))throw new o.Dp("Invalid JWT Claims Set");return r}},24931:(e,t,r)=>{r.d(t,{CE:()=>i.CE,Fw:()=>i.Fw,gz:()=>i.gz,j1:()=>i.j1});var i=r(55807)},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31551:(e,t,r)=>{r.d(t,{B:()=>d});var i=r(23040),a=r(97151),n=r(27819),o=r(1047),s=r(34621),l=r(24931);class d{static async authenticateClient(e,t){let r=t.get("client_id"),i=t.get("client_secret"),a=t.get("client_assertion_type"),n=t.get("client_assertion"),o=e.headers.get("authorization");if(o&&o.toLowerCase().startsWith("basic "))try{let e=o.slice(6),[t,a]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&a&&(r=r||t,i=i||a)}catch{throw new l.gz("Invalid Basic authentication header format.",l.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===a&&n)return await this.authenticateWithJWT(n,e);if(r&&i)return await this.authenticateWithSecret(r,i);if(r&&!i){let e=await s.prisma.oAuthClient.findUnique({where:{clientId:r,isActive:!0}});if(!e)throw new l.gz("Client not found.",l.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new l.gz("å®¢æˆ·ç«¯ä¸æ˜¯å…¬å¼€å®¢æˆ·ç«¯ï¼Œéœ€è¦èº«ä»½éªŒè¯",l.Fw.InvalidClient,401);return e}throw new l.gz("Client authentication required but not provided or method not supported.",l.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let i=await s.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!i)throw new l.gz("Invalid client ID or client not active.",l.Fw.InvalidClient,401);if("PUBLIC"===i.clientType)throw new l.gz("å…¬å¼€å®¢æˆ·ç«¯è¯•å›¾ä½¿ç”¨å¯†é’¥è¿›è¡Œèº«ä»½éªŒè¯",l.Fw.InvalidClient,400);if(!i.clientSecret)throw console.error(`å®¢æˆ·ç«¯ ${e} åœ¨æ•°æ®åº“ä¸­ç¼ºå°‘å®¢æˆ·ç«¯å¯†é’¥`),new l.j1("æ­¤å®¢æˆ·ç«¯æœªé…ç½®å®¢æˆ·ç«¯å¯†é’¥");try{let e=await Promise.resolve().then(r.t.bind(r,5486,23));if(!await e.compare(t,i.clientSecret))throw new l.gz("å®¢æˆ·ç«¯å¯†é’¥æ— æ•ˆ",l.Fw.InvalidClient,401)}catch(e){throw console.error("å®¢æˆ·ç«¯å¯†é’¥éªŒè¯æœŸé—´bcrypt.compareå‘ç”Ÿé”™è¯¯:",e),new l.j1("å®¢æˆ·ç«¯å¯†é’¥éªŒè¯æœŸé—´å‘ç”Ÿé”™è¯¯")}return i}static async authenticateWithJWT(e,t){try{let r=i.i(e);if(!r.iss||!r.sub||r.iss!==r.sub)throw new l.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",l.Fw.InvalidClient,400);let o=r.iss,d=await s.prisma.oAuthClient.findUnique({where:{clientId:o,isActive:!0}});if(!d)throw new l.gz("Client specified in JWT assertion not found or not active.",l.Fw.InvalidClient,401);if(!d.jwksUri)throw new l.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let c=this.getTokenEndpointUrl(t),u=a.RD(new URL(d.jwksUri));return await n.V(e,u,{issuer:o,audience:c,algorithms:["RS256","ES256","PS256"]}),d}catch(r){console.error("Client JWT assertion validation failed:",r);let e="Client assertion validation failed.",t=l.Fw.InvalidClient;if(r instanceof o.n)e="Client assertion has expired.",t=l.Fw.InvalidGrant;else if(r instanceof o.ie)e=`Client assertion claim validation failed: ${r.claim} ${r.reason}.`;else if(r instanceof o.h2)e="Client assertion signature verification failed.";else if(r instanceof l.j1)throw r;throw new l.gz(e,t,400,void 0,{originalError:r.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),r=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),i=e.headers.get("x-forwarded-host")||t.host,a=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${r}://${i}${a}`}}},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},43258:(e,t,r)=>{r.d(t,{A:()=>w});var i=r(19668),a=r.n(i);r(36344);var n=r(33873),o=r.n(n),s=r(29021),l=r.n(s);let d=o().join(process.cwd(),"logs");l().existsSync(d)||l().mkdirSync(d,{recursive:!0});let c=a().format.combine(a().format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),a().format.printf(({timestamp:e,level:t,message:r})=>`${e} [${t.toUpperCase()}]: ${r}`)),u=a().format.combine(a().format.timestamp({format:"YYYY-MM-DD HH:mm:ss.SSS"}),a().format.colorize({all:!0}),a().format.printf(({timestamp:e,level:t,message:r})=>{let i=t.padEnd(15);return`ðŸ•’ ${e} | ${i} | ${r}`})),h=new(a()).transports.DailyRotateFile({filename:o().join(d,"%DATE%.log"),datePattern:"YYYY-MM-DD",maxSize:"20m",maxFiles:"14d",format:c}),p=new(a()).transports.Console({format:u}),w=a().createLogger({level:"info",transports:[p,h]})},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47625:(e,t,r)=>{r.d(t,{a:()=>a});var i=r(47923);function a(e,t){return(0,i.w)(t||e,e)}},47923:(e,t,r)=>{r.d(t,{w:()=>a});var i=r(15547);function a(e,t){return"function"==typeof e?e(t):e&&"object"==typeof e&&i._P in e?e[i._P](t):e instanceof Date?new e.constructor(t):new Date(t)}},49039:(e,t,r)=>{r.d(t,{A:()=>n});var i=r(47923),a=r(47625);function n(e,t,r){return(0,i.w)(r?.in||e,+(0,a.a)(e)+t)}},49157:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>E,serverHooks:()=>A,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>y});var i={};r.r(i),r.d(i,{GET:()=>U});var a=r(19227),n=r(39044),o=r(11131),s=r(57642),l=r(79551),d=r(34621),c=r(50595),u=r(51041),h=r(97151),p=r(27819),w=r(67200);let g=w.z.object({client_id:w.z.string({required_error:"client_id is required.",invalid_type_error:"client_id must be a string."}).min(1,"client_id cannot be empty."),redirect_uri:w.z.string({required_error:"redirect_uri is required.",invalid_type_error:"redirect_uri must be a string."}).url({message:"redirect_uri must be a valid URL."}),response_type:w.z.literal("code",{errorMap:()=>({message:'response_type must be "code".'})}),scope:w.z.string({required_error:"scope is required.",invalid_type_error:"scope must be a string."}).min(1,"scope cannot be empty."),state:w.z.string().optional(),code_challenge:w.z.string({required_error:"code_challenge is required for PKCE.",invalid_type_error:"code_challenge must be a string."}).min(43,"code_challenge must be at least 43 characters for S256 (Base64url-encoded SHA-256 hash).").max(128,"code_challenge must be at most 128 characters (PKCE spec limit)."),code_challenge_method:w.z.literal("S256",{errorMap:()=>({message:'code_challenge_method must be "S256".'})}),nonce:w.z.string().optional()});var m=r(71890),f=r(86933),v=r(55807);let _=process.env.AUTH_CENTER_LOGIN_PAGE_URL||"/login",I=process.env.AUTH_CENTER_UI_AUDIENCE||"urn:auth-center:ui",C=process.env.AUTH_CENTER_UI_CLIENT_ID||"auth-center-admin-client";async function S(e){let{searchParams:t}=new l.URL(e.url),r=(e,t,r,i)=>{try{let a=new l.URL(e);return a.searchParams.set("error",t),a.searchParams.set("error_description",r),i&&a.searchParams.set("state",i),s.NextResponse.redirect(a.toString(),302)}catch(r){throw console.error("CRITICAL: buildErrorRedirect called with invalid baseRedirectUri",e,r),new v.j1(`Server error: Could not construct redirect URL due to invalid base redirect URI. Original error: ${t}`,{code:"REDIRECT_URI_CONSTRUCTION_FAILED"})}},i={};t.forEach((e,t)=>{i[t]=e});let a=g.safeParse(i);if(!a.success){let e=a.error.errors[0],t=e?`Invalid authorization request: ${e.path.join(".")} - ${e.message}`:"Invalid authorization request: Validation failed";throw new v.yI(t,{issues:a.error.flatten().fieldErrors,state:i.state},v.Fw.InvalidRequest)}let{client_id:n,redirect_uri:o,response_type:w,scope:f,state:S,code_challenge:U,code_challenge_method:E,nonce:R}=a.data,y=await d.prisma.oAuthClient.findUnique({where:{clientId:n}});if(!y||!y.isActive)throw new v.gz("Client not found or not active.",v.Fw.InvalidClient,400);if(y.requirePkce&&(!U||!E))throw new v.gz("PKCE is required for this client. code_challenge and code_challenge_method must be provided.",v.Fw.InvalidRequest,400);if(E&&"S256"!==E)throw new v.gz("Unsupported code_challenge_method. Only S256 is supported.",v.Fw.InvalidRequest,400);let A=[];try{if(A=JSON.parse(y.redirectUris||"[]"),!Array.isArray(A))throw Error("Redirect URIs are not an array.")}catch(e){throw console.error("Failed to parse third-party client's redirectUris:",y.redirectUris,e),new v.j1("Invalid client configuration for redirectUris.",{clientId:n,code:"CLIENT_CONFIG_REDIRECT_URI_INVALID"})}if(!A.includes(o))throw new v.gz("Invalid redirect_uri.",v.Fw.InvalidRequest,400,void 0,{provided:o,expected:A});if(("PUBLIC"===y.clientType||y.requirePkce)&&(!U||!E))return await u.P.logAuditEvent({clientId:y.clientId,action:"AUTH_CODE_PKCE_REQUIRED_MISSING_PARAMS",success:!1,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,errorMessage:"PKCE (code_challenge and code_challenge_method) is required for this client but one or both were missing.",metadata:{client_id:y.clientId,clientType:y.clientType,requirePkceField:y.requirePkce,hasCodeChallenge:!!U,hasCodeChallengeMethod:!!E}}),r(o,v.Fw.InvalidRequest,"PKCE (code_challenge and code_challenge_method) is required for this client.",S);if(U&&!c.L3.validateCodeChallenge(U))return await u.P.logAuditEvent({clientId:y.clientId,action:"AUTH_CODE_PKCE_INVALID_CHALLENGE_FORMAT",success:!1,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,errorMessage:"Invalid PKCE code_challenge format.",metadata:{client_id:y.clientId,code_challenge_provided:U}}),r(o,v.Fw.InvalidRequest,"Invalid code_challenge format.",S);if(!f)return r(o,v.Fw.InvalidScope,"Scope parameter is required.",S);let x=c.e8.parseScopes(f),T=await c.e8.validateScopes(x,y);if(!T.valid){let e=T.error_description||`Invalid or not allowed scope(s): ${T.invalidScopes.join(", ")}.`;return r(o,v.Fw.InvalidScope,e,S)}let q=x.filter(e=>!T.invalidScopes.includes(e)),z=null,P=e.cookies.get("auth_center_session_token")?.value;if(P)try{let e=process.env.JWKS_URI;if(!e)throw new v.j1("JWKS_URI not configured for internal auth.",{code:"CONFIG_JWKS_URI_MISSING"});let t=h.RD(new l.URL(e)),r=process.env.JWT_ISSUER;if(!r)throw new v.j1("JWT_ISSUER not configured for internal auth.",{code:"CONFIG_JWT_ISSUER_MISSING"});let{payload:i}=await p.V(P,t,{issuer:r,audience:I,algorithms:["RS256"]});i&&i.sub&&(z=await d.prisma.user.findUnique({where:{id:i.sub,isActive:!0}}))}catch(e){console.warn("Auth Center UI session token verification failed during /authorize:",e.message)}if(!z){let t=new l.URL(_,e.nextUrl.origin);return t.search=new URLSearchParams({client_id:C,redirect_uri:e.nextUrl.href,response_type:"code",scope:"openid profile email auth-center:interact",...S&&{state_passthrough:S},...R&&{nonce_passthrough:R}}).toString(),console.log(`User not authenticated with Auth Center. Redirecting to Auth Center login: ${t.toString()}`),s.NextResponse.redirect(t.toString(),302)}console.log(`User ${z.id} authenticated to Auth Center UI. Continuing /authorize flow for client ${n}.`);let D=await d.prisma.consentGrant.findFirst({where:{userId:z.id,clientId:y.id}}),b=!1;if(D){let e=c.e8.parseScopes(D.scopes);b=q.every(t=>e.includes(t))}if(!b){let t=new l.URL("/api/v2/oauth/consent",e.nextUrl.origin);return t.searchParams.set("client_id",n),t.searchParams.set("redirect_uri",o),t.searchParams.set("scope",c.e8.formatScopes(q)),S&&t.searchParams.set("state",S),t.searchParams.set("response_type",w),U&&t.searchParams.set("code_challenge",U),E&&t.searchParams.set("code_challenge_method",E),R&&t.searchParams.set("nonce",R),console.log(`Redirecting user ${z.id} to consent page for client ${y.clientId}`),s.NextResponse.redirect(t.toString(),302)}console.log(`User ${z.id} already consented for client ${y.clientId}. Issuing code.`);let F=await (0,m.storeAuthorizationCode)(z.id,y.id,o,U,E,c.e8.formatScopes(q),y.authorizationCodeLifetime||void 0,R||void 0),L=new l.URL(o);return L.searchParams.set("code",F.code),S&&L.searchParams.set("state",S),s.NextResponse.redirect(L.toString(),302)}let U=(0,f.Uj)(S),E=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v2/oauth/authorize/route",pathname:"/api/v2/oauth/authorize",filename:"route",bundlePath:"app/api/v2/oauth/authorize/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/authorize/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:R,workUnitAsyncStorage:y,serverHooks:A}=E;function x(){return(0,o.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:y})}},51041:(e,t,r)=>{r.d(t,{P:()=>s,B:()=>i.B});var i=r(31551),a=r(55511),n=r(34621),o=r(84344);class s{static validateRedirectUri(e,t){return t.includes(e)}static validateResponseType(e,t=["code"]){return t.includes(e)}static generateState(){return a.randomBytes(32).toString("base64url")}static generateNonce(){return a.randomBytes(32).toString("base64url")}static generateAuthorizationCode(){return a.randomBytes(32).toString("hex")}static async logAuditEvent(e){try{let t="SYSTEM",r="system";if(e.userId)t="USER",r=e.userId;else if(e.clientId){t="CLIENT";let i=await n.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});r=i?i.clientId:e.clientId}let i=e.success;void 0===i&&(i=e.status?"SUCCESS"===e.status:!e.errorMessage),await n.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:r||"unknown",status:i?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:this.buildDetailsJson(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}}static buildDetailsJson(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let r=JSON.parse(e.details);t={...t,...r}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}static async getUserPermissions(e){try{let t=await o.S.getUserPermissions(e),r=new Set(t?.permissions||[]);return Array.from(r)}catch(e){return console.error("Error getting user permissions:",e),[]}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},71890:(e,t,r)=>{r.r(t),r.d(t,{DEFAULT_AUTHORIZATION_CODE_LIFETIME_SECONDS:()=>d,generateSecureRandomString:()=>c,storeAuthorizationCode:()=>u,validateAuthorizationCode:()=>h});var i=r(34621),a=r(49039),n=r(55511),o=r.n(n),s=r(55807),l=r(96330);let d=600;function c(e=32){return o().randomBytes(e).toString("hex")}async function u(e,t,r,n,o,l,h=d,p){var w;if("S256"!==o)throw new s.yI(`Unsupported code challenge method: ${o}. Only 'S256' is supported.`,{codeChallengeMethod:o},"UNSUPPORTED_CHALLENGE_METHOD");let g=c(32),m=(w=new Date,(0,a.A)(w,1e3*h,void 0));try{return await i.prisma.authorizationCode.create({data:{code:g,userId:e,clientId:t,redirectUri:r,scope:l,codeChallenge:n,codeChallengeMethod:o,expiresAt:m,isUsed:!1,nonce:p||null}})}catch(t){console.error("Failed to store authorization code:",t);let e=t instanceof Error?t.message:String(t);throw new s.iF("Database error while storing authorization code.",{originalError:e})}}async function h(e,t,r,a){let n=null;try{if(!(n=await i.prisma.authorizationCode.findUnique({where:{code:e}})))throw new s.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(n.isUsed)throw await i.prisma.authorizationCode.delete({where:{id:n.id}}),new s.jz("Invalid authorization code: Code has already been used.",{code:e},"AUTH_CODE_USED");if(n.expiresAt<new Date)throw await i.prisma.authorizationCode.delete({where:{id:n.id}}),new s.BX("Invalid authorization code: Code has expired.",{code:e,expiresAt:n.expiresAt});if(n.clientId!==t)throw new s.yI("Invalid authorization code: Client ID mismatch.",{expected:t,actual:n.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(n.redirectUri!==r)throw new s.yI("Invalid authorization code: Redirect URI mismatch.",{expected:r,actual:n.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===n.codeChallengeMethod){if(o().createHash("sha256").update(a).digest("base64url")!==n.codeChallenge)throw new s.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new s.yI(`Unsupported code challenge method in stored code: ${n.codeChallengeMethod}. Only 'S256' is supported.`,{storedMethod:n.codeChallengeMethod},"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await i.prisma.authorizationCode.update({where:{id:n.id},data:{isUsed:!0}})}catch(t){if(t instanceof s.Cf)throw t;console.error("Error during authorization code validation:",t);let e=t instanceof Error?t.message:String(t);if(t instanceof l.Prisma.PrismaClientKnownRequestError)throw new s.iF(`Database error during authorization code validation: ${e}`,{originalError:e,code:t.code});throw new s.iF("Database error during authorization code validation.",{originalError:e})}}},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},84344:(e,t,r)=>{r.d(t,{S:()=>a});var i=r(24958);class a{static async getUserPermissions(e){let t=await i.z.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{include:{role:{include:{rolePermissions:{include:{permission:!0}}}}}}}});if(!t)return null;let r=t.userRoles.map(e=>e.role.name),a=new Set;return t.userRoles.forEach(e=>{e.role.rolePermissions.forEach(e=>{a.add(e.permission.name)})}),{userId:t.id,roles:r,permissions:Array.from(a),organizationContext:{organization:t.organization||void 0,department:t.department||void 0}}}}},86933:(e,t,r)=>{r.d(t,{B9:()=>n,Uj:()=>i.Uj}),r(43258);var i=r(60123);class a{static{this.store=new Map}static{this.cleanupInterval=null}static startCleanupTimer(){this.cleanupInterval||(this.cleanupInterval=setInterval(()=>{let e=Date.now(),t=[];for(let[r,i]of this.store.entries())e-i.lastRequest>864e5&&t.push(r);t.forEach(e=>this.store.delete(e))},3e5))}static stopCleanupTimer(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}static getClientIP(e){let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0];return e?e.trim():"unknown"}let r=e.headers.get("x-real-ip");if(r)return r;let i=e.headers.get("cf-connecting-ip");return i||"unknown"}static generateKey(e,t){let r,{keyType:i="ip",keyPrefix:a="rate_limit"}=t;switch(i){case"ip":default:r=this.getClientIP(e);break;case"client":let n=e.headers.get("authorization"),o=null;if(n?.includes("client_id=")){let e=n.split("client_id=")[1];e&&(o=e.split(" ")[0]||null)}let s=e.nextUrl.searchParams.get("client_id");r=o||s||this.getClientIP(e);break;case"user":let l=e.headers.get("user-agent")||"unknown";r=`${this.getClientIP(e)}-${l.slice(0,50)}`}return`${a}:${i}:${r}`}static checkRateLimit(e,t){this.startCleanupTimer();let r=Date.now(),{maxRequests:i,windowMs:a}=t,n=this.store.get(e);if(!n)return n={count:1,windowStart:r,lastRequest:r},this.store.set(e,n),{allowed:!0,remaining:i-1,resetTime:r+a,limit:i};if(r-n.windowStart>=a)return n.count=1,n.windowStart=r,n.lastRequest=r,{allowed:!0,remaining:i-1,resetTime:r+a,limit:i};if(n.lastRequest=r,n.count>=i){let e=n.windowStart+a,t=e-r;return{allowed:!1,remaining:0,resetTime:e,limit:i,retryAfter:t}}return n.count++,{allowed:!0,remaining:i-n.count,resetTime:n.windowStart+a,limit:i}}static applyRateLimit(e,t){let r=this.generateKey(e,t);return this.checkRateLimit(r,t)}static resetRateLimit(e){this.store.delete(e)}static getRateLimitStatus(e,t){let r=this.store.get(e),i=Date.now();if(!r||i-r.windowStart>=t.windowMs)return{allowed:!0,remaining:t.maxRequests,resetTime:i+t.windowMs,limit:t.maxRequests};let a=r.windowStart+t.windowMs,n=Math.max(0,t.maxRequests-r.count),o=r.count<t.maxRequests;return{allowed:o,remaining:n,resetTime:a,limit:t.maxRequests,retryAfter:o?void 0:a-i}}static clearAll(){this.store.clear()}static getRecordCount(){return this.store.size}}function n(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,176,344,196,578,987,855,119],()=>r(49157));module.exports=i})();