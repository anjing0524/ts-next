"use strict";(()=>{var e={};e.id=970,e.ids=[930,970],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1630:e=>{e.exports=require("http")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},2412:e=>{e.exports=require("assert")},2930:(e,r,t)=>{t.r(r),t.d(r,{DEFAULT_AUTHORIZATION_CODE_LIFETIME_SECONDS:()=>d,generateSecureRandomString:()=>c,storeAuthorizationCode:()=>l,validateAuthorizationCode:()=>u});var i=t(8891),o=t(9039),a=t(5511),n=t.n(a),s=t(4931);let d=600;function c(e=32){return n().randomBytes(e).toString("hex")}async function l(e,r,t,a,n,u,h=d,p){var _;if("S256"!==n)throw new s.j1(`Unsupported code challenge method: ${n}. Only 'S256' is supported.`);let g=c(32),I=(_=new Date,(0,o.A)(_,1e3*h,void 0));try{return await i.z.authorizationCode.create({data:{code:g,userId:e,clientId:r,redirectUri:t,scope:u,codeChallenge:a,codeChallengeMethod:n,expiresAt:I,isUsed:!1,nonce:p||null}})}catch(e){throw console.error("Failed to store authorization code:",e),new s.Cf("Database error while storing authorization code.",500,"DB_STORE_AUTH_CODE_FAILED")}}async function u(e,r,t,o){let a=null;try{if(!(a=await i.z.authorizationCode.findUnique({where:{code:e}})))throw new s.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(a.isUsed)throw await i.z.authorizationCode.delete({where:{id:a.id}}),new s.Pb("Invalid authorization code: Code has already been used.",400,"AUTH_CODE_USED");if(a.expiresAt<new Date)throw await i.z.authorizationCode.delete({where:{id:a.id}}),new s.Pb("Invalid authorization code: Code has expired.",400,"AUTH_CODE_EXPIRED");if(a.clientId!==r)throw new s.yI("Invalid authorization code: Client ID mismatch.",{expected:r,actual:a.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(a.redirectUri!==t)throw new s.yI("Invalid authorization code: Redirect URI mismatch.",{expected:t,actual:a.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===a.codeChallengeMethod){if(n().createHash("sha256").update(o).digest("base64url")!==a.codeChallenge)throw new s.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new s.j1(`Unsupported code challenge method in stored code: ${a.codeChallengeMethod}. Only 'S256' is supported.`,void 0,"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await i.z.authorizationCode.update({where:{id:a.id},data:{isUsed:!0}})}catch(e){if(e instanceof s.Cf)throw e;if(console.error("Error during authorization code validation:",e),e instanceof Prisma.PrismaClientKnownRequestError)throw new s.Cf(`Database error during authorization code validation: ${e.message}`,500,`DB_VALIDATE_AUTH_CODE_PRISMA_${e.code}`);throw new s.Cf("Database error during authorization code validation.",500,"DB_VALIDATE_AUTH_CODE_FAILED")}}},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{e.exports=require("path")},3997:e=>{e.exports=require("tty")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4985:e=>{e.exports=require("dns")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},5591:e=>{e.exports=require("https")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9157:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>U,serverHooks:()=>S,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>A});var i={};t.r(i),t.d(i,{GET:()=>E});var o=t(9227),a=t(9044),n=t(1131),s=t(7642),d=t(9551),c=t(8891),l=t(9776),u=t(7151),h=t(2229),p=t(7200);let _=p.z.object({client_id:p.z.string({required_error:"client_id is required.",invalid_type_error:"client_id must be a string."}).min(1,"client_id cannot be empty."),redirect_uri:p.z.string({required_error:"redirect_uri is required.",invalid_type_error:"redirect_uri must be a string."}).url({message:"redirect_uri must be a valid URL."}),response_type:p.z.literal("code",{errorMap:()=>({message:'response_type must be "code".'})}),scope:p.z.string({required_error:"scope is required.",invalid_type_error:"scope must be a string."}).min(1,"scope cannot be empty."),state:p.z.string().optional(),code_challenge:p.z.string({required_error:"code_challenge is required for PKCE.",invalid_type_error:"code_challenge must be a string."}).min(43,"code_challenge must be at least 43 characters for S256 (Base64url-encoded SHA-256 hash).").max(128,"code_challenge must be at most 128 characters (PKCE spec limit)."),code_challenge_method:p.z.literal("S256",{errorMap:()=>({message:'code_challenge_method must be "S256".'})}),nonce:p.z.string().optional()});var g=t(2930),I=t(9343),w=t(4931);let v=process.env.AUTH_CENTER_LOGIN_PAGE_URL||"/login",f=process.env.AUTH_CENTER_UI_AUDIENCE||"urn:auth-center:ui",C=process.env.AUTH_CENTER_UI_CLIENT_ID||"auth-center-admin-client";async function m(e){let{searchParams:r}=new d.URL(e.url),t=(e,r,t,i)=>{try{let o=new d.URL(e);return o.searchParams.set("error",r),o.searchParams.set("error_description",t),i&&o.searchParams.set("state",i),s.NextResponse.redirect(o.toString(),302)}catch(t){throw console.error("CRITICAL: buildErrorRedirect called with invalid baseRedirectUri",e,t),new w.j1(`Server error: Could not construct redirect URL due to invalid base redirect URI. Original error: ${r}`,{code:"REDIRECT_URI_CONSTRUCTION_FAILED"})}},i={};r.forEach((e,r)=>{i[r]=e});let o=_.safeParse(i);if(!o.success){let e=o.error.errors[0],r=e?`Invalid authorization request: ${e.path.join(".")} - ${e.message}`:"Invalid authorization request: Validation failed";throw new w.yI(r,{issues:o.error.flatten().fieldErrors,state:i.state},w.Fw.InvalidRequest)}let{client_id:a,redirect_uri:n,response_type:p,scope:I,state:m,code_challenge:E,code_challenge_method:U,nonce:R}=o.data,A=await c.z.oAuthClient.findUnique({where:{clientId:a}});if(!A||!A.isActive)throw new w.gz("Client not found or not active.",w.Fw.InvalidClient,400);if(A.requirePkce&&(!E||!U))throw new w.gz("PKCE is required for this client. code_challenge and code_challenge_method must be provided.",w.Fw.InvalidRequest,400);if(U&&"S256"!==U)throw new w.gz("Unsupported code_challenge_method. Only S256 is supported.",w.Fw.InvalidRequest,400);let S=[];try{if(S=JSON.parse(A.redirectUris||"[]"),!Array.isArray(S))throw Error("Redirect URIs are not an array.")}catch(e){throw console.error("Failed to parse third-party client's redirectUris:",A.redirectUris,e),new w.j1("Invalid client configuration for redirectUris.",{clientId:a,code:"CLIENT_CONFIG_REDIRECT_URI_INVALID"})}if(!S.includes(n))throw new w.gz("Invalid redirect_uri.",w.Fw.InvalidRequest,400,void 0,{provided:n,expected:S});if(("PUBLIC"===A.clientType||A.requirePkce)&&(!E||!U))return await l.PC.logAuditEvent({clientId:A.clientId,action:"AUTH_CODE_PKCE_REQUIRED_MISSING_PARAMS",success:!1,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,errorMessage:"PKCE (code_challenge and code_challenge_method) is required for this client but one or both were missing.",metadata:{client_id:A.clientId,clientType:A.clientType,requirePkceField:A.requirePkce,hasCodeChallenge:!!E,hasCodeChallengeMethod:!!U}}),t(n,w.Fw.InvalidRequest,"PKCE (code_challenge and code_challenge_method) is required for this client.",m);if(E&&!l.L3.validateCodeChallenge(E))return await l.PC.logAuditEvent({clientId:A.clientId,action:"AUTH_CODE_PKCE_INVALID_CHALLENGE_FORMAT",success:!1,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,errorMessage:"Invalid PKCE code_challenge format.",metadata:{client_id:A.clientId,code_challenge_provided:E}}),t(n,w.Fw.InvalidRequest,"Invalid code_challenge format.",m);if(!I)return t(n,w.Fw.InvalidScope,"Scope parameter is required.",m);let x=l.e8.parseScopes(I),q=await l.e8.validateScopes(x,A);if(!q.valid){let e=q.error_description||`Invalid or not allowed scope(s): ${q.invalidScopes.join(", ")}.`;return t(n,w.Fw.InvalidScope,e,m)}let z=x.filter(e=>!q.invalidScopes.includes(e)),T=null,P=e.cookies.get("auth_center_session_token")?.value;if(P)try{let e=process.env.JWKS_URI;if(!e)throw new w.j1("JWKS_URI not configured for internal auth.",{code:"CONFIG_JWKS_URI_MISSING"});let r=u.RD(new d.URL(e)),t=process.env.JWT_ISSUER;if(!t)throw new w.j1("JWT_ISSUER not configured for internal auth.",{code:"CONFIG_JWT_ISSUER_MISSING"});let{payload:i}=await h.V(P,r,{issuer:t,audience:f,algorithms:["RS256"]});i&&i.sub&&(T=await c.z.user.findUnique({where:{id:i.sub,isActive:!0}}))}catch(e){console.warn("Auth Center UI session token verification failed during /authorize:",e.message)}if(!T){let r=new d.URL(v,e.nextUrl.origin);return r.search=new URLSearchParams({client_id:C,redirect_uri:e.nextUrl.href,response_type:"code",scope:"openid profile email auth-center:interact",...m&&{state_passthrough:m},...R&&{nonce_passthrough:R}}).toString(),console.log(`User not authenticated with Auth Center. Redirecting to Auth Center login: ${r.toString()}`),s.NextResponse.redirect(r.toString(),302)}console.log(`User ${T.id} authenticated to Auth Center UI. Continuing /authorize flow for client ${a}.`);let y=await c.z.consentGrant.findFirst({where:{userId:T.id,clientId:A.id}}),D=!1;if(y){let e=l.e8.parseScopes(y.scopes);D=z.every(r=>e.includes(r))}if(!D){let r=new d.URL("/api/v2/oauth/consent",e.nextUrl.origin);return r.searchParams.set("client_id",a),r.searchParams.set("redirect_uri",n),r.searchParams.set("scope",l.e8.formatScopes(z)),m&&r.searchParams.set("state",m),r.searchParams.set("response_type",p),E&&r.searchParams.set("code_challenge",E),U&&r.searchParams.set("code_challenge_method",U),R&&r.searchParams.set("nonce",R),console.log(`Redirecting user ${T.id} to consent page for client ${A.clientId}`),s.NextResponse.redirect(r.toString(),302)}console.log(`User ${T.id} already consented for client ${A.clientId}. Issuing code.`);let O=await (0,g.storeAuthorizationCode)(T.id,A.id,n,E,U,l.e8.formatScopes(z),A.authorizationCodeLifetime||void 0,R||void 0),b=new d.URL(n);return b.searchParams.set("code",O.code),m&&b.searchParams.set("state",m),s.NextResponse.redirect(b.toString(),302)}let E=(0,I.U)(m),U=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v2/oauth/authorize/route",pathname:"/api/v2/oauth/authorize",filename:"route",bundlePath:"app/api/v2/oauth/authorize/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/authorize/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:R,workUnitAsyncStorage:A,serverHooks:S}=U;function x(){return(0,n.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:A})}},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9343:(e,r,t)=>{t.d(r,{U:()=>i.Uj});var i=t(3117)},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[938,344,176,578,434,200,470,776,555],()=>t(9157));module.exports=i})();