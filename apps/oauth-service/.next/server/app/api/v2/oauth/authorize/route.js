"use strict";(()=>{var e={};e.id=970,e.ids=[970],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33165:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>S,routeModule:()=>q,serverHooks:()=>C,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>U});var i={};t.r(i),t.d(i,{GET:()=>x});var s=t(19227),o=t(39044),a=t(11131),n=t(57642),d=t(79551),c=t(34621),l=t(44325),u=t(97151),p=t(27819),h=t(67200);let _=h.z.object({client_id:h.z.string({required_error:"client_id is required.",invalid_type_error:"client_id must be a string."}).min(1,"client_id cannot be empty."),redirect_uri:h.z.string({required_error:"redirect_uri is required.",invalid_type_error:"redirect_uri must be a string."}).url({message:"redirect_uri must be a valid URL."}),response_type:h.z.literal("code",{errorMap:()=>({message:'response_type must be "code".'})}),scope:h.z.string({required_error:"scope is required.",invalid_type_error:"scope must be a string."}).min(1,"scope cannot be empty."),state:h.z.string().optional(),code_challenge:h.z.string({required_error:"code_challenge is required for PKCE.",invalid_type_error:"code_challenge must be a string."}).min(43,"code_challenge must be at least 43 characters for S256 (Base64url-encoded SHA-256 hash).").max(128,"code_challenge must be at most 128 characters (PKCE spec limit)."),code_challenge_method:h.z.literal("S256",{errorMap:()=>({message:'code_challenge_method must be "S256".'})}),nonce:h.z.string().optional()});var g=t(29468),I=t(55807);let m=process.env.AUTH_CENTER_LOGIN_PAGE_URL||"/login",v=process.env.AUTH_CENTER_UI_AUDIENCE||"urn:auth-center:ui",f=process.env.AUTH_CENTER_UI_CLIENT_ID||"auth-center-admin-client";async function w(e){let{searchParams:r}=new d.URL(e.url),i=(e,r,t,i)=>{try{let s=new d.URL(e);return s.searchParams.set("error",r),s.searchParams.set("error_description",t),i&&s.searchParams.set("state",i),n.NextResponse.redirect(s.toString(),302)}catch(t){throw console.error("CRITICAL: buildErrorRedirect called with invalid baseRedirectUri",e,t),new I.j1(`Server error: Could not construct redirect URL due to invalid base redirect URI. Original error: ${r}`,{code:"REDIRECT_URI_CONSTRUCTION_FAILED"})}},s={};r.forEach((e,r)=>{s[r]=e});let o=_.safeParse(s);if(!o.success){let e=o.error.errors[0],r=e?`Invalid authorization request: ${e.path.join(".")} - ${e.message}`:"Invalid authorization request: Validation failed";throw new I.yI(r,{issues:o.error.flatten().fieldErrors,state:s.state},I.Fw.InvalidRequest)}let{client_id:a,redirect_uri:h,response_type:g,scope:w,state:x,code_challenge:q,code_challenge_method:R,nonce:U}=o.data,C=await c.prisma.oAuthClient.findUnique({where:{clientId:a}});if(!C||!C.isActive)throw new I.gz("Client not found or not active.",I.Fw.InvalidClient,400);if(C.requirePkce&&(!q||!R))throw new I.gz("PKCE is required for this client. code_challenge and code_challenge_method must be provided.",I.Fw.InvalidRequest,400);if(R&&"S256"!==R)throw new I.gz("Unsupported code_challenge_method. Only S256 is supported.",I.Fw.InvalidRequest,400);let S=[];try{if(S=JSON.parse(C.redirectUris||"[]"),!Array.isArray(S))throw Error("Redirect URIs are not an array.")}catch(e){throw console.error("Failed to parse third-party client's redirectUris:",C.redirectUris,e),new I.j1("Invalid client configuration for redirectUris.",{clientId:a,code:"CLIENT_CONFIG_REDIRECT_URI_INVALID"})}if(!S.includes(h))throw new I.gz("Invalid redirect_uri.",I.Fw.InvalidRequest,400,void 0,{provided:h,expected:S});if(("PUBLIC"===C.clientType||C.requirePkce)&&(!q||!R))return await l.PC.logAuditEvent({clientId:C.clientId,action:"AUTH_CODE_PKCE_REQUIRED_MISSING_PARAMS",success:!1,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,errorMessage:"PKCE (code_challenge and code_challenge_method) is required for this client but one or both were missing.",metadata:{client_id:C.clientId,clientType:C.clientType,requirePkceField:C.requirePkce,hasCodeChallenge:!!q,hasCodeChallengeMethod:!!R}}),i(h,I.Fw.InvalidRequest,"PKCE (code_challenge and code_challenge_method) is required for this client.",x);if(q&&!l.L3.validateCodeChallenge(q))return await l.PC.logAuditEvent({clientId:C.clientId,action:"AUTH_CODE_PKCE_INVALID_CHALLENGE_FORMAT",success:!1,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,errorMessage:"Invalid PKCE code_challenge format.",metadata:{client_id:C.clientId,code_challenge_provided:q}}),i(h,I.Fw.InvalidRequest,"Invalid code_challenge format.",x);if(!w)return i(h,I.Fw.InvalidScope,"Scope parameter is required.",x);let E=l.e8.parseScopes(w),A=await l.e8.validateScopes(E,C);if(!A.valid){let e=A.error_description||`Invalid or not allowed scope(s): ${A.invalidScopes.join(", ")}.`;return i(h,I.Fw.InvalidScope,e,x)}let P=E.filter(e=>!A.invalidScopes.includes(e)),y=null,b=e.cookies.get("auth_center_session_token")?.value;if(b)try{let e=process.env.JWKS_URI;if(!e)throw new I.j1("JWKS_URI not configured for internal auth.",{code:"CONFIG_JWKS_URI_MISSING"});let r=u.RD(new d.URL(e)),t=process.env.JWT_ISSUER;if(!t)throw new I.j1("JWT_ISSUER not configured for internal auth.",{code:"CONFIG_JWT_ISSUER_MISSING"});let{payload:i}=await p.V(b,r,{issuer:t,audience:v,algorithms:["RS256"]});i&&i.sub&&(y=await c.prisma.user.findUnique({where:{id:i.sub,isActive:!0}}))}catch(e){console.warn("Auth Center UI session token verification failed during /authorize:",e.message)}if(!y){let r=new d.URL(m,e.nextUrl.origin);return r.search=new URLSearchParams({client_id:f,redirect_uri:e.nextUrl.href,response_type:"code",scope:"openid profile email auth-center:interact",...x&&{state_passthrough:x},...U&&{nonce_passthrough:U}}).toString(),console.log(`User not authenticated with Auth Center. Redirecting to Auth Center login: ${r.toString()}`),n.NextResponse.redirect(r.toString(),302)}console.log(`User ${y.id} authenticated to Auth Center UI. Continuing /authorize flow for client ${a}.`);let T=await c.prisma.consentGrant.findFirst({where:{userId:y.id,clientId:C.id}}),N=!1;if(T){let e=l.e8.parseScopes(T.scopes);N=P.every(r=>e.includes(r))}if(!N){let r=new d.URL("/api/v2/oauth/consent",e.nextUrl.origin);return r.searchParams.set("client_id",a),r.searchParams.set("redirect_uri",h),r.searchParams.set("scope",l.e8.formatScopes(P)),x&&r.searchParams.set("state",x),r.searchParams.set("response_type",g),q&&r.searchParams.set("code_challenge",q),R&&r.searchParams.set("code_challenge_method",R),U&&r.searchParams.set("nonce",U),console.log(`Redirecting user ${y.id} to consent page for client ${C.clientId}`),n.NextResponse.redirect(r.toString(),302)}console.log(`User ${y.id} already consented for client ${C.clientId}. Issuing code.`);let{storeAuthorizationCode:z}=await t.e(890).then(t.bind(t,71890)),L=await z(y.id,C.id,h,q||"",R||"S256",l.e8.formatScopes(P),600,U),F=new d.URL(h);return F.searchParams.set("code",L.code),x&&F.searchParams.set("state",x),await l.PC.logAuditEvent({userId:y.id,clientId:C.clientId,action:"AUTHORIZATION_CODE_ISSUED",success:!0,ipAddress:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",userAgent:e.headers.get("user-agent")||void 0,metadata:{client_id:C.clientId,scope:l.e8.formatScopes(P),hasPKCE:!!q,hasNonce:!!U}}),console.log(`Authorization code issued for user ${y.id} and client ${C.clientId}`),n.NextResponse.redirect(F.toString(),302)}let x=(0,g.Uj)(w),q=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/oauth/authorize/route",pathname:"/api/v2/oauth/authorize",filename:"route",bundlePath:"app/api/v2/oauth/authorize/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/authorize/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:R,workUnitAsyncStorage:U,serverHooks:C}=q;function S(){return(0,a.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:U})}},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[938,176,733,200,344,578,987,706,855,300],()=>t(33165));module.exports=i})();