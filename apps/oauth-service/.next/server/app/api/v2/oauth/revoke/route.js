"use strict";(()=>{var e={};e.id=419,e.ids=[419],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1204:e=>{e.exports=require("string_decoder")},1645:e=>{e.exports=require("net")},1820:e=>{e.exports=require("os")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3117:(e,t,r)=>{r.d(t,{FB:()=>p,Uj:()=>l});var s=r(7642),n=r(5807),o=r(5511);let i={randomUUID:o.randomUUID},a=new Uint8Array(256),d=a.length,c=[];for(let e=0;e<256;++e)c.push((e+256).toString(16).slice(1));let u=function(e,t,r){if(i.randomUUID&&!t&&!e)return i.randomUUID();let s=(e=e||{}).random??e.rng?.()??(d>a.length-16&&((0,o.randomFillSync)(a),d=0),a.slice(d,d+=16));if(s.length<16)throw Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=s[e];return t}return function(e,t=0){return(c[e[t+0]]+c[e[t+1]]+c[e[t+2]]+c[e[t+3]]+"-"+c[e[t+4]]+c[e[t+5]]+"-"+c[e[t+6]]+c[e[t+7]]+"-"+c[e[t+8]]+c[e[t+9]]+"-"+c[e[t+10]]+c[e[t+11]]+c[e[t+12]]+c[e[t+13]]+c[e[t+14]]+c[e[t+15]]).toLowerCase()}(s)};function l(e){return async(t,r)=>{let o=u();t.requestId=o;try{return await e(t,r)}catch(r){let e=o||u();if(function(e,t,r){let s={timestamp:new Date().toISOString(),requestId:r||"N/A",message:e.message||"An unknown error occurred.",name:e.name||"Error"};t&&(s.url=t.url,s.method=t.method,s.ip=t.headers.get("x-forwarded-for")||t.headers.get("x-real-ip")||"unknown",s.userAgent=t.headers.get("user-agent")),e instanceof n.Cf?(s.code=e.code,s.status=e.status,e.context&&(s.context=e.context)):(s.code="UNHANDLED_EXCEPTION",s.status=500),e.stack&&(s.stack=e.stack.split("\n").map(e=>e.trim())),console.error(JSON.stringify(s,null,2))}(r,t,e),r instanceof n.Cf){let t=r.toApiResponse();return t.error&&(t.error.details={...t.error.details,requestId:e}),s.NextResponse.json(t,{status:r.status})}return s.NextResponse.json({success:!1,error:{code:"INTERNAL_SERVER_ERROR",message:"An unexpected internal server error occurred.",details:{requestId:e}}},{status:500})}}}function p(e){return async(t,...r)=>{try{return await e(t,...r)}catch(e){if(console.error("API route error:",e),e instanceof n.Cf)return s.NextResponse.json({success:!1,error:e.code,message:e.message},{status:e.status});return s.NextResponse.json({success:!1,error:"INTERNAL_SERVER_ERROR",message:"An unexpected error occurred"},{status:500})}}}},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3784:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>_,routeModule:()=>w,serverHooks:()=>v,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>x});var n=r(9227),o=r(9044),i=r(1131),a=r(7642),d=r(8891),c=r(9343),u=r(9776),l=r(3040),p=r(7200);let f=p.z.object({token:p.z.string({required_error:"token is required.",invalid_type_error:"token must be a string."}).min(1,"token cannot be empty."),token_type_hint:p.z.enum(["access_token","refresh_token"]).optional(),client_id:p.z.string().min(1,"client_id cannot be empty if provided.").optional()});var h=r(4931);async function k(e){if("application/x-www-form-urlencoded"!==e.headers.get("content-type"))throw new h.gz("Unsupported Media Type. Please use application/x-www-form-urlencoded.",h.Fw.InvalidRequest,415,void 0,{expectedContentType:"application/x-www-form-urlencoded"});let t=new URLSearchParams(await e.text()),r={};t.forEach((e,t)=>{r[t]=e});let s=await u.Bu.authenticateClient(e,t);if(s||r.client_id,!s)throw new h.gz("Client authentication or identification failed unexpectedly after initial check.",h.Fw.InvalidClient,401);console.log(`Token revocation request authenticated for client: ${s.clientId}`);let n=f.safeParse(r);if(!n.success)throw new h.gz(n.error.errors[0]?.message||"Invalid revocation request parameters.",h.Fw.InvalidRequest,400,void 0,{issues:n.error.flatten().fieldErrors});if(n.data.client_id&&n.data.client_id!==s.clientId)throw new h.gz("client_id in body does not match authenticated client.",h.Fw.InvalidRequest,400);let{token:o,token_type_hint:i}=n.data,c=u.DU.getTokenHash(o),p=!1,k={type:"unknown",idForLog:"unknown"},x=null;try{x=l.i(o)}catch(e){console.warn("Revocation: Token provided is not a valid JWT, proceeding with hash-based lookup.",{error:e.message})}let w=x?.jti||null;if("access_token"===i||!i){let e=await d.z.accessToken.findFirst({where:{tokenHash:c,clientId:s.id}});if(e){let t=w||e.id;await d.z.tokenBlacklist.upsert({where:{jti:t},create:{jti:t,tokenType:"access_token",expiresAt:e.expiresAt},update:{expiresAt:e.expiresAt}}),p=!0,k={type:"access_token",idForLog:e.id},console.log(`Access token (ID: ${e.id}) for client ${s.clientId} blacklisted.`)}}if(!p&&("refresh_token"===i||!i)){let e=await d.z.refreshToken.findFirst({where:{tokenHash:c,clientId:s.id}});if(e&&!e.isRevoked){let t=w||e.id;await d.z.$transaction(async r=>{if(await r.refreshToken.update({where:{id:e.id},data:{isRevoked:!0,revokedAt:new Date}}),await r.tokenBlacklist.upsert({where:{jti:t},create:{jti:t,tokenType:"refresh_token",expiresAt:e.expiresAt},update:{expiresAt:e.expiresAt}}),p=!0,k={type:"refresh_token",idForLog:e.id},console.log(`Refresh token (ID: ${e.id}) for client ${s.clientId} revoked and blacklisted.`),e.userId){let t=await r.accessToken.findMany({where:{userId:e.userId,clientId:s.id,expiresAt:{gt:new Date}}});if(t.length>0){for(let e of t.map(e=>({jti:e.id,tokenType:"access_token",expiresAt:e.expiresAt})))await r.tokenBlacklist.upsert({where:{jti:e.jti},create:e,update:{expiresAt:e.expiresAt}});console.log(`Cascaded revocation: ${t.length} access tokens blacklisted for user ${e.userId}.`)}}})}}return await AuthorizationUtils.logAuditEvent({clientId:s.id,action:"token_revocation_attempt",resource:`token_type_hint:${i||"any"}`,ipAddress:e.headers.get("x-forwarded-for")||e.ip||void 0,userAgent:e.headers.get("user-agent")||void 0,success:!0,metadata:{token_hash_prefix:c.substring(0,10),token_found_and_processed_as:p?k.type:"none",actually_revoked_in_db:p}}),a.NextResponse.json({success:!0,message:"Token revocation request processed.",data:null},{status:200})}let x=(0,c.U)(k),w=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/oauth/revoke/route",pathname:"/api/v2/oauth/revoke",filename:"route",bundlePath:"app/api/v2/oauth/revoke/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/revoke/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:m,serverHooks:v}=w;function _(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:m})}},3873:e=>{e.exports=require("path")},4075:e=>{e.exports=require("zlib")},4631:e=>{e.exports=require("tls")},4735:e=>{e.exports=require("events")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5486:e=>{e.exports=require("bcrypt")},5511:e=>{e.exports=require("crypto")},6136:e=>{e.exports=require("timers")},6330:e=>{e.exports=require("@prisma/client")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},9021:e=>{e.exports=require("fs")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9343:(e,t,r)=>{r.d(t,{U:()=>s.Uj});var s=r(3117)},9428:e=>{e.exports=require("buffer")},9551:e=>{e.exports=require("url")},9771:e=>{e.exports=require("process")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[938,176,578,935,200,813,776],()=>r(3784));module.exports=s})();