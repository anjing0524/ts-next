"use strict";(()=>{var e={};e.id=419,e.ids=[419],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},19771:e=>{e.exports=require("process")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},74075:e=>{e.exports=require("zlib")},77598:e=>{e.exports=require("node:crypto")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},89343:(e,t,r)=>{r.d(t,{U:()=>i.Uj});var i=r(60123)},91645:e=>{e.exports=require("net")},93784:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>v,serverHooks:()=>_,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>q});var i={};r.r(i),r.d(i,{POST:()=>f});var o=r(19227),s=r(39044),n=r(11131),a=r(57642),d=r(93952),p=r(49922),c=r(51041),u=r(89343),l=r(23040),k=r(67200);let x=k.z.object({token:k.z.string({required_error:"token is required.",invalid_type_error:"token must be a string."}).min(1,"token cannot be empty."),token_type_hint:k.z.enum(["access_token","refresh_token"]).optional(),client_id:k.z.string().min(1,"client_id cannot be empty if provided.").optional()});var h=r(24931);async function w(e){if("application/x-www-form-urlencoded"!==e.headers.get("content-type"))throw new h.gz("Unsupported Media Type. Please use application/x-www-form-urlencoded.",h.Fw.InvalidRequest,415,void 0,{expectedContentType:"application/x-www-form-urlencoded"});let t=new URLSearchParams(await e.text()),r={};t.forEach((e,t)=>{r[t]=e});let i=new FormData;t.forEach((e,t)=>{i.append(t,e)});let o=await p.Bu.authenticateClient(e,i);if(o||r.client_id,!o)throw new h.gz("Client authentication or identification failed unexpectedly after initial check.",h.Fw.InvalidClient,401);console.log(`Token revocation request authenticated for client: ${o.clientId}`);let s=x.safeParse(r);if(!s.success)throw new h.gz(s.error.errors[0]?.message||"Invalid revocation request parameters.",h.Fw.InvalidRequest,400,void 0,{issues:s.error.flatten().fieldErrors});if(s.data.client_id&&s.data.client_id!==o.clientId)throw new h.gz("client_id in body does not match authenticated client.",h.Fw.InvalidRequest,400);let{token:n,token_type_hint:u}=s.data,k=p.DU.getTokenHash(n),w=!1,f={type:"unknown",idForLog:"unknown"},v=null;try{v=l.i(n)}catch(e){console.warn("Revocation: Token provided is not a valid JWT, proceeding with hash-based lookup.",{error:e.message})}let g=v?.jti||null;if("access_token"===u||!u){let e=await d.z.accessToken.findFirst({where:{tokenHash:k,clientId:o.id}});if(e){let t=g||e.id;await d.z.tokenBlacklist.upsert({where:{jti:t},create:{jti:t,tokenType:"access_token",expiresAt:e.expiresAt},update:{expiresAt:e.expiresAt}}),w=!0,f={type:"access_token",idForLog:e.id},console.log(`Access token (ID: ${e.id}) for client ${o.clientId} blacklisted.`)}}if(!w&&("refresh_token"===u||!u)){let e=await d.z.refreshToken.findFirst({where:{tokenHash:k,clientId:o.id}});if(e&&!e.isRevoked){let t=g||e.id;await d.z.$transaction(async r=>{if(await r.refreshToken.update({where:{id:e.id},data:{isRevoked:!0,revokedAt:new Date}}),await r.tokenBlacklist.upsert({where:{jti:t},create:{jti:t,tokenType:"refresh_token",expiresAt:e.expiresAt},update:{expiresAt:e.expiresAt}}),w=!0,f={type:"refresh_token",idForLog:e.id},console.log(`Refresh token (ID: ${e.id}) for client ${o.clientId} revoked and blacklisted.`),e.userId){let t=await r.accessToken.findMany({where:{userId:e.userId,clientId:o.id,expiresAt:{gt:new Date}}});if(t.length>0){for(let e of t.map(e=>({jti:e.id,tokenType:"access_token",expiresAt:e.expiresAt})))await r.tokenBlacklist.upsert({where:{jti:e.jti},create:e,update:{expiresAt:e.expiresAt}});console.log(`Cascaded revocation: ${t.length} access tokens blacklisted for user ${e.userId}.`)}}})}}return await c.P.logAuditEvent({clientId:o.id,action:"token_revocation_attempt",resource:`token_type_hint:${u||"any"}`,ipAddress:e.headers.get("x-forwarded-for")||void 0,userAgent:e.headers.get("user-agent")||void 0,success:!0,metadata:{token_hash_prefix:k.substring(0,10),token_found_and_processed_as:w?f.type:"none",actually_revoked_in_db:w}}),a.NextResponse.json({success:!0,message:"Token revocation request processed.",data:null},{status:200})}let f=(0,u.U)(w),v=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/v2/oauth/revoke/route",pathname:"/api/v2/oauth/revoke",filename:"route",bundlePath:"app/api/v2/oauth/revoke/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/revoke/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:g,workUnitAsyncStorage:q,serverHooks:_}=v;function y(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:q})}},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[938,176,344,196,578,987,466,855,119,64,922],()=>r(93784));module.exports=i})();