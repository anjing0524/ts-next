(()=>{var e={};e.id=419,e.ids=[419],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=4997,e.exports=t},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},23040:(e,t,i)=>{"use strict";i.d(t,{i:()=>a});var r=i(88022),s=i(55937),o=i(46159),n=i(1047);function a(e){let t,i;if("string"!=typeof e)throw new n.Dp("JWTs must use Compact JWS serialization, JWT must be a string");let{1:a,length:l}=e.split(".");if(5===l)throw new n.Dp("Only JWTs using Compact JWS serialization can be decoded");if(3!==l)throw new n.Dp("Invalid JWT");if(!a)throw new n.Dp("JWTs must contain a payload");try{t=(0,r.D)(a)}catch{throw new n.Dp("Failed to base64url decode the payload")}try{i=JSON.parse(s.D0.decode(t))}catch{throw new n.Dp("Failed to parse the decoded payload as JSON")}if(!(0,o.A)(i))throw new n.Dp("Invalid JWT Claims Set");return i}},24931:(e,t,i)=>{"use strict";i.d(t,{Fw:()=>r.Fw,gz:()=>r.gz,j1:()=>r.j1});var r=i(55807)},24958:(e,t,i)=>{"use strict";i.d(t,{z:()=>s});var r=i(96330);let s=globalThis.prisma??new r.PrismaClient},27650:(e,t,i)=>{"use strict";i.d(t,{B:()=>c});var r=i(23040),s=i(97151),o=i(27819),n=i(1047),a=i(34621),l=i(24931);class c{static async authenticateClient(e,t){let i=t.get("client_id"),r=t.get("client_secret"),s=t.get("client_assertion_type"),o=t.get("client_assertion"),n=e.headers.get("authorization");if(n&&n.toLowerCase().startsWith("basic "))try{let e=n.slice(6),[t,s]=Buffer.from(e,"base64").toString("utf-8").split(":");t&&s&&(i=i||t,r=r||s)}catch{throw new l.gz("Invalid Basic authentication header format.",l.Fw.InvalidClient,401)}if("urn:ietf:params:oauth:client-assertion-type:jwt-bearer"===s&&o)return await this.authenticateWithJWT(o,e);if(i&&r)return await this.authenticateWithSecret(i,r);if(i&&!r){let e=await a.prisma.oAuthClient.findUnique({where:{clientId:i,isActive:!0}});if(!e)throw new l.gz("Client not found.",l.Fw.InvalidClient,401);if("PUBLIC"!==e.clientType)throw new l.gz("客户端不是公开客户端，需要身份验证",l.Fw.InvalidClient,401);return e}throw new l.gz("Client authentication required but not provided or method not supported.",l.Fw.InvalidClient,401)}static async authenticateWithSecret(e,t){let r=await a.prisma.oAuthClient.findUnique({where:{clientId:e,isActive:!0}});if(!r)throw new l.gz("Invalid client ID or client not active.",l.Fw.InvalidClient,401);if("PUBLIC"===r.clientType)throw new l.gz("公开客户端试图使用密钥进行身份验证",l.Fw.InvalidClient,400);if(!r.clientSecret)throw console.error(`客户端 ${e} 在数据库中缺少客户端密钥`),new l.j1("此客户端未配置客户端密钥");try{let e=await Promise.resolve().then(i.t.bind(i,5486,23));if(!await e.compare(t,r.clientSecret))throw new l.gz("客户端密钥无效",l.Fw.InvalidClient,401)}catch(e){throw console.error("客户端密钥验证期间bcrypt.compare发生错误:",e),new l.j1("客户端密钥验证期间发生错误")}return r}static async authenticateWithJWT(e,t){try{let i=r.i(e);if(!i.iss||!i.sub||i.iss!==i.sub)throw new l.gz("Invalid JWT assertion: iss and sub claims are required and must be identical (client_id).",l.Fw.InvalidClient,400);let n=i.iss,c=await a.prisma.oAuthClient.findUnique({where:{clientId:n,isActive:!0}});if(!c)throw new l.gz("Client specified in JWT assertion not found or not active.",l.Fw.InvalidClient,401);if(!c.jwksUri)throw new l.j1("Client is not configured for JWT assertion-based authentication (missing jwks_uri).",{missingJwksUri:!0});let d=this.getTokenEndpointUrl(t),u=s.RD(new URL(c.jwksUri));return await o.V(e,u,{issuer:n,audience:d,algorithms:["RS256","ES256","PS256"]}),c}catch(i){console.error("Client JWT assertion validation failed:",i);let e="Client assertion validation failed.",t=l.Fw.InvalidClient;if(i instanceof n.n)e="Client assertion has expired.",t=l.Fw.InvalidGrant;else if(i instanceof n.ie)e=`Client assertion claim validation failed: ${i.claim} ${i.reason}.`;else if(i instanceof n.h2)e="Client assertion signature verification failed.";else if(i instanceof l.j1)throw i;throw new l.gz(e,t,400,void 0,{originalError:i.message})}}static getTokenEndpointUrl(e){let t=new URL(e.url),i=e.headers.get("x-forwarded-proto")||t.protocol.slice(0,-1),r=e.headers.get("x-forwarded-host")||t.host,s=process.env.OAUTH_TOKEN_ENDPOINT_PATH||"/api/v2/oauth/token";return`${i}://${r}${s}`}}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,t,i)=>{"use strict";i.d(t,{prisma:()=>r.z}),i(96330);var r=i(24958),s=i(50488),o=i.n(s),n=i(5433);o().config();let a={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},l=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:a.host,port:a.port,user:a.user,database:a.database}),n.createPool(a));async function c(){if(l&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await l.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await c(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},41204:e=>{"use strict";e.exports=require("string_decoder")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},83997:e=>{"use strict";e.exports=require("tty")},89343:(e,t,i)=>{"use strict";i.d(t,{U:()=>r.Uj});var r=i(60123)},91645:e=>{"use strict";e.exports=require("net")},93784:(e,t,i)=>{"use strict";i.r(t),i.d(t,{patchFetch:()=>_,routeModule:()=>k,serverHooks:()=>y,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>x});var r={};i.r(r),i.d(r,{POST:()=>g});var s=i(19227),o=i(39044),n=i(11131),a=i(57642),l=i(34621),c=i(44325),d=i(27650),u=i(89343),p=i(23040),h=i(67200);let w=h.z.object({token:h.z.string({required_error:"token is required.",invalid_type_error:"token must be a string."}).min(1,"token cannot be empty."),token_type_hint:h.z.enum(["access_token","refresh_token"]).optional(),client_id:h.z.string().min(1,"client_id cannot be empty if provided.").optional()});var f=i(24931);async function v(e){if("application/x-www-form-urlencoded"!==e.headers.get("content-type"))throw new f.gz("Unsupported Media Type. Please use application/x-www-form-urlencoded.",f.Fw.InvalidRequest,415,void 0,{expectedContentType:"application/x-www-form-urlencoded"});let t=new URLSearchParams(await e.text()),i={};t.forEach((e,t)=>{i[t]=e});let r=new FormData;t.forEach((e,t)=>{r.append(t,e)});let s=await d.B.authenticateClient(e,r);if(s||i.client_id,!s)throw new f.gz("Client authentication or identification failed unexpectedly after initial check.",f.Fw.InvalidClient,401);console.log(`Token revocation request authenticated for client: ${s.clientId}`);let o=w.safeParse(i);if(!o.success)throw new f.gz(o.error.errors[0]?.message||"Invalid revocation request parameters.",f.Fw.InvalidRequest,400,void 0,{issues:o.error.flatten().fieldErrors});if(o.data.client_id&&o.data.client_id!==s.clientId)throw new f.gz("client_id in body does not match authenticated client.",f.Fw.InvalidRequest,400);let{token:n,token_type_hint:u}=o.data,h=c.DU.getTokenHash(n),v=!1,g={type:"unknown",idForLog:"unknown"},k=null;try{k=p.i(n)}catch(e){console.warn("Revocation: Token provided is not a valid JWT, proceeding with hash-based lookup.",{error:e.message})}let m=k?.jti||null;if("access_token"===u||!u){let e=await l.prisma.accessToken.findFirst({where:{tokenHash:h,clientId:s.id}});if(e){let t=m||e.id;await l.prisma.tokenBlacklist.upsert({where:{jti:t},create:{jti:t,tokenType:"access_token",expiresAt:e.expiresAt},update:{expiresAt:e.expiresAt}}),v=!0,g={type:"access_token",idForLog:e.id},console.log(`Access token (ID: ${e.id}) for client ${s.clientId} blacklisted.`)}}if(!v&&("refresh_token"===u||!u)){let e=await l.prisma.refreshToken.findFirst({where:{tokenHash:h,clientId:s.id}});if(e&&!e.isRevoked){let t=m||e.id;await l.prisma.$transaction(async i=>{if(await i.refreshToken.update({where:{id:e.id},data:{isRevoked:!0,revokedAt:new Date}}),await i.tokenBlacklist.upsert({where:{jti:t},create:{jti:t,tokenType:"refresh_token",expiresAt:e.expiresAt},update:{expiresAt:e.expiresAt}}),v=!0,g={type:"refresh_token",idForLog:e.id},console.log(`Refresh token (ID: ${e.id}) for client ${s.clientId} revoked and blacklisted.`),e.userId){let t=await i.accessToken.findMany({where:{userId:e.userId,clientId:s.id,expiresAt:{gt:new Date}}});if(t.length>0){for(let e of t.map(e=>({jti:e.id,tokenType:"access_token",expiresAt:e.expiresAt})))await i.tokenBlacklist.upsert({where:{jti:e.jti},create:e,update:{expiresAt:e.expiresAt}});console.log(`Cascaded revocation: ${t.length} access tokens blacklisted for user ${e.userId}.`)}}})}}return await c.PC.logAuditEvent({clientId:s.id,action:"token_revocation_attempt",resource:`token_type_hint:${u||"any"}`,ipAddress:e.headers.get("x-forwarded-for")||void 0,userAgent:e.headers.get("user-agent")||void 0,success:!0,metadata:{token_hash_prefix:h.substring(0,10),token_found_and_processed_as:v?g.type:"none",actually_revoked_in_db:v}}),a.NextResponse.json({success:!0,message:"Token revocation request processed.",data:null},{status:200})}let g=(0,u.U)(v),k=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/oauth/revoke/route",pathname:"/api/v2/oauth/revoke",filename:"route",bundlePath:"app/api/v2/oauth/revoke/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/oauth/revoke/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:m,workUnitAsyncStorage:x,serverHooks:y}=k;function _(){return(0,n.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:x})}},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[938,176,733,200,578,987,706,855],()=>i(93784));module.exports=r})();