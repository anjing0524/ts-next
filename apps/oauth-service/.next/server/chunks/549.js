exports.id=549,exports.ids=[549],exports.modules={4997:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=4997,e.exports=t},24931:(e,t,i)=>{"use strict";i.d(t,{Fw:()=>r.Fw,gz:()=>r.gz,j1:()=>r.j1});var r=i(55807)},24958:(e,t,i)=>{"use strict";i.d(t,{z:()=>s});var r=i(96330);let s=globalThis.prisma??new r.PrismaClient},34621:(e,t,i)=>{"use strict";i.d(t,{prisma:()=>r.z}),i(96330);var r=i(24958),s=i(50488),n=i.n(s),o=i(5433);n().config();let a={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},l=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:a.host,port:a.port,user:a.user,database:a.database}),o.createPool(a));async function c(){if(l&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await l.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await c(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await c(),process.exit(1)})},38738:(e,t,i)=>{"use strict";i.d(t,{B9:()=>r.B9,Uj:()=>r.Uj}),i(44325),i(18354);var r=i(84327);i(43281),i(55807),i(34621)},90483:(e,t,i)=>{"use strict";i.d(t,{A:()=>l});var r=i(55511);let s={randomUUID:r.randomUUID},n=new Uint8Array(256),o=n.length,a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));let l=function(e,t,i){if(s.randomUUID&&!t&&!e)return s.randomUUID();let l=(e=e||{}).random??e.rng?.()??(o>n.length-16&&((0,r.randomFillSync)(n),o=0),n.slice(o,o+=16));if(l.length<16)throw Error("Random bytes length must be >= 16");if(l[6]=15&l[6]|64,l[8]=63&l[8]|128,t){if((i=i||0)<0||i+16>t.length)throw RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[i+e]=l[e];return t}return function(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}(l)}},91022:(e,t,i)=>{"use strict";i.d(t,{X:()=>u});var r=i(96330),s=i(34621),n=i(44325),o=i(24931),a=i(55511),l=i.n(a),c=i(5486),d=i.n(c);class u{static async createClient(e,t){try{u.validateCreateParams(e);let i=u.generateClientId(),o=null;e.clientType===r.ClientType.CONFIDENTIAL&&(o=u.generateClientSecret());let a=await s.prisma.oAuthClient.create({data:{clientId:i,clientSecret:o?await d().hash(o,12):null,name:e.name,description:e.description,clientType:e.clientType,redirectUris:JSON.stringify(e.redirectUris),grantTypes:JSON.stringify(e.grantTypes),responseTypes:JSON.stringify(e.responseTypes),allowedScopes:JSON.stringify(e.allowedScopes),logoUri:e.logoUri,policyUri:e.policyUri,tosUri:e.tosUri,requirePkce:e.requirePkce??!0,requireConsent:e.requireConsent??!0,ipWhitelist:e.ipWhitelist?JSON.stringify(e.ipWhitelist):null,accessTokenTtl:e.accessTokenTtl??3600,refreshTokenTtl:e.refreshTokenTtl??2592e3,authorizationCodeLifetime:e.authorizationCodeLifetime??600}});return await n.PC.logAuditEvent({userId:t.userId,clientId:a.id,action:"client_created",resource:`client:${a.clientId}`,ipAddress:t.ipAddress,userAgent:t.userAgent,success:!0,metadata:{clientName:e.name,clientType:e.clientType}}),{...a,clientSecret:o}}catch(e){throw await n.PC.logAuditEvent({userId:t.userId,action:"client_create_failed",resource:"client:unknown",ipAddress:t.ipAddress,userAgent:t.userAgent,success:!1,errorMessage:e instanceof Error?e.message:"Unknown error"}),new o.gz("Failed to create OAuth client",o.Fw.ServerError,500,e instanceof Error?e.message:void 0)}}static async getClientById(e){try{return await s.prisma.oAuthClient.findUnique({where:{id:e}})}catch(e){throw new o.gz("Failed to retrieve client",o.Fw.ServerError,500,e instanceof Error?e.message:void 0)}}static async getClientByClientId(e){try{return await s.prisma.oAuthClient.findUnique({where:{clientId:e}})}catch(e){throw new o.gz("Failed to retrieve client",o.Fw.ServerError,500,e instanceof Error?e.message:void 0)}}static async getClients(e={}){try{let t={};e.clientType&&(t.clientType=e.clientType),void 0!==e.isActive&&(t.isActive=e.isActive),e.name&&(t.name={contains:e.name,mode:"insensitive"});let[i,r]=await Promise.all([s.prisma.oAuthClient.findMany({where:t,skip:e.offset??0,take:e.limit??50,orderBy:{createdAt:"desc"}}),s.prisma.oAuthClient.count({where:t})]);return{clients:i,total:r}}catch(e){throw new o.gz("Failed to query clients",o.Fw.ServerError,500,e instanceof Error?e.message:void 0)}}static async updateClient(e,t,i){try{if(!await u.getClientById(e))throw new o.gz("Client not found",o.Fw.InvalidClient,404);u.validateUpdateParams(t);let r={};void 0!==t.name&&(r.name=t.name),void 0!==t.description&&(r.description=t.description),void 0!==t.redirectUris&&(r.redirectUris=JSON.stringify(t.redirectUris)),void 0!==t.grantTypes&&(r.grantTypes=JSON.stringify(t.grantTypes)),void 0!==t.responseTypes&&(r.responseTypes=JSON.stringify(t.responseTypes)),void 0!==t.allowedScopes&&(r.allowedScopes=JSON.stringify(t.allowedScopes)),void 0!==t.logoUri&&(r.logoUri=t.logoUri),void 0!==t.policyUri&&(r.policyUri=t.policyUri),void 0!==t.tosUri&&(r.tosUri=t.tosUri),void 0!==t.requirePkce&&(r.requirePkce=t.requirePkce),void 0!==t.requireConsent&&(r.requireConsent=t.requireConsent),void 0!==t.ipWhitelist&&(r.ipWhitelist=t.ipWhitelist?JSON.stringify(t.ipWhitelist):null),void 0!==t.accessTokenTtl&&(r.accessTokenTtl=t.accessTokenTtl),void 0!==t.refreshTokenTtl&&(r.refreshTokenTtl=t.refreshTokenTtl),void 0!==t.authorizationCodeLifetime&&(r.authorizationCodeLifetime=t.authorizationCodeLifetime),void 0!==t.isActive&&(r.isActive=t.isActive);let a=await s.prisma.oAuthClient.update({where:{id:e},data:r});return await n.PC.logAuditEvent({userId:i.userId,clientId:a.id,action:"client_updated",resource:`client:${a.clientId}`,ipAddress:i.ipAddress,userAgent:i.userAgent,success:!0,metadata:{updatedFields:Object.keys(r)}}),a}catch(t){if(await n.PC.logAuditEvent({userId:i.userId,action:"client_update_failed",resource:`client:${e}`,ipAddress:i.ipAddress,userAgent:i.userAgent,success:!1,errorMessage:t instanceof Error?t.message:"Unknown error"}),t instanceof o.gz)throw t;throw new o.gz("Failed to update OAuth client",o.Fw.ServerError,500,t instanceof Error?t.message:void 0)}}static async deleteClient(e,t){try{let i=await u.getClientById(e);if(!i)throw new o.gz("Client not found",o.Fw.InvalidClient,404);await s.prisma.oAuthClient.delete({where:{id:e}}),await n.PC.logAuditEvent({userId:t.userId,clientId:i.id,action:"client_deleted",resource:`client:${i.clientId}`,ipAddress:t.ipAddress,userAgent:t.userAgent,success:!0,metadata:{clientName:i.name}})}catch(i){if(await n.PC.logAuditEvent({userId:t.userId,action:"client_delete_failed",resource:`client:${e}`,ipAddress:t.ipAddress,userAgent:t.userAgent,success:!1,errorMessage:i instanceof Error?i.message:"Unknown error"}),i instanceof o.gz)throw i;throw new o.gz("Failed to delete OAuth client",o.Fw.ServerError,500,i instanceof Error?i.message:void 0)}}static async rotateClientSecret(e,t){try{let i=await u.getClientById(e);if(!i)throw new o.gz("Client not found",o.Fw.InvalidClient,404);if(i.clientType!==r.ClientType.CONFIDENTIAL)throw new o.gz("Public clients do not have secrets",o.Fw.InvalidClient,400);let a=u.generateClientSecret(),l=await d().hash(a,12);return await s.prisma.oAuthClient.update({where:{id:e},data:{clientSecret:l}}),await n.PC.logAuditEvent({userId:t.userId,clientId:i.id,action:"client_secret_rotated",resource:`client:${i.clientId}`,ipAddress:t.ipAddress,userAgent:t.userAgent,success:!0}),a}catch(i){if(await n.PC.logAuditEvent({userId:t.userId,action:"client_secret_rotation_failed",resource:`client:${e}`,ipAddress:t.ipAddress,userAgent:t.userAgent,success:!1,errorMessage:i instanceof Error?i.message:"Unknown error"}),i instanceof o.gz)throw i;throw new o.gz("Failed to rotate client secret",o.Fw.ServerError,500,i instanceof Error?i.message:void 0)}}static validateCreateParams(e){if(!e.name||0===e.name.trim().length)throw new o.gz("Client name is required",o.Fw.InvalidRequest,400);if(!e.redirectUris||0===e.redirectUris.length)throw new o.gz("At least one redirect URI is required",o.Fw.InvalidRequest,400);for(let t of e.redirectUris)try{new URL(t)}catch{throw new o.gz(`Invalid redirect URI: ${t}`,o.Fw.InvalidRequest,400)}if(!e.grantTypes||0===e.grantTypes.length)throw new o.gz("At least one grant type is required",o.Fw.InvalidRequest,400);if(!e.allowedScopes||0===e.allowedScopes.length)throw new o.gz("At least one allowed scope is required",o.Fw.InvalidRequest,400)}static validateUpdateParams(e){if(void 0!==e.name&&0===e.name.trim().length)throw new o.gz("Client name cannot be empty",o.Fw.InvalidRequest,400);if(void 0!==e.redirectUris){if(0===e.redirectUris.length)throw new o.gz("At least one redirect URI is required",o.Fw.InvalidRequest,400);for(let t of e.redirectUris)try{new URL(t)}catch{throw new o.gz(`Invalid redirect URI: ${t}`,o.Fw.InvalidRequest,400)}}}static generateClientId(){return`client_${l().randomBytes(16).toString("hex")}`}static generateClientSecret(){return l().randomBytes(32).toString("base64url")}}}};