"use strict";exports.id=281,exports.ids=[281],exports.modules={746:(e,t,r)=>{class s{static{this.store=new Map}static{this.cleanupInterval=null}static startCleanupTimer(){this.cleanupInterval||(this.cleanupInterval=setInterval(()=>{let e=Date.now(),t=[];for(let[r,s]of this.store.entries())e-s.lastRequest>864e5&&t.push(r);t.forEach(e=>this.store.delete(e))},3e5))}static stopCleanupTimer(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}static getClientIP(e){let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0];return e?e.trim():"unknown"}let r=e.headers.get("x-real-ip");if(r)return r;let s=e.headers.get("cf-connecting-ip");return s||"unknown"}static generateKey(e,t){let r,{keyType:s="ip",keyPrefix:i="rate_limit"}=t;switch(s){case"ip":default:r=this.getClientIP(e);break;case"client":let n=e.headers.get("authorization"),a=null;if(n?.includes("client_id=")){let e=n.split("client_id=")[1];e&&(a=e.split(" ")[0]||null)}let o=e.nextUrl.searchParams.get("client_id");r=a||o||this.getClientIP(e);break;case"user":let c=e.headers.get("user-agent")||"unknown";r=`${this.getClientIP(e)}-${c.slice(0,50)}`}return`${i}:${s}:${r}`}static checkRateLimit(e,t){this.startCleanupTimer();let r=Date.now(),{maxRequests:s,windowMs:i}=t,n=this.store.get(e);if(!n)return n={count:1,windowStart:r,lastRequest:r},this.store.set(e,n),{allowed:!0,remaining:s-1,resetTime:r+i,limit:s};if(r-n.windowStart>=i)return n.count=1,n.windowStart=r,n.lastRequest=r,{allowed:!0,remaining:s-1,resetTime:r+i,limit:s};if(n.lastRequest=r,n.count>=s){let e=n.windowStart+i,t=e-r;return{allowed:!1,remaining:0,resetTime:e,limit:s,retryAfter:t}}return n.count++,{allowed:!0,remaining:s-n.count,resetTime:n.windowStart+i,limit:s}}static applyRateLimit(e,t){let r=this.generateKey(e,t);return this.checkRateLimit(r,t)}static resetRateLimit(e){this.store.delete(e)}static getRateLimitStatus(e,t){let r=this.store.get(e),s=Date.now();if(!r||s-r.windowStart>=t.windowMs)return{allowed:!0,remaining:t.maxRequests,resetTime:s+t.windowMs,limit:t.maxRequests};let i=r.windowStart+t.windowMs,n=Math.max(0,t.maxRequests-r.count),a=r.count<t.maxRequests;return{allowed:a,remaining:n,resetTime:i,limit:t.maxRequests,retryAfter:a?void 0:i-s}}static clearAll(){this.store.clear()}static getRecordCount(){return this.store.size}}},18354:(e,t,r)=>{r.d(t,{n:()=>n,S:()=>a.S});var s=r(43258),i=r(50802);class n{constructor(e){this.prisma=e,this.cache=i.yk.getCache(),s.A.info("PermissionService initialized with cache manager")}async getUserEffectivePermissions(e){let t=`user:${e}:permissions`;try{let r=await this.cache.get(t);if(r)return s.A.debug(`[Cache HIT] Permissions for user ${e}`),new Set(r)}catch(e){s.A.error("Error reading from cache:",e)}s.A.debug(`[DB Fetch] Fetching permissions from DB for user ${e}`);let r=await this.prisma.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{where:{role:{isActive:!0},OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},include:{role:{include:{rolePermissions:{where:{permission:{isActive:!0}},include:{permission:!0}}}}}}}});if(!r){let r=new Set;return await this.cache.set(t,[],900),s.A.debug(`[Cache SET] Empty permissions for user ${e} stored in cache.`),r}let i=new Set;r.userRoles.forEach(e=>{e.role&&e.role.isActive&&(e.expiresAt&&e.expiresAt.getTime()<=Date.now()||e.role.rolePermissions.forEach(e=>{e.permission&&e.permission.isActive&&e.permission.name&&i.add(e.permission.name)}))});let n=Array.from(i);return await this.cache.set(t,n,900),s.A.debug(`[Cache SET] Permissions for user ${e} stored in cache.`),i}async clearUserPermissionCache(e){let t=`user:${e}:permissions`;try{await this.cache.del(t),s.A.info(`[Cache Cleared] Permissions for user ${e}`)}catch(e){s.A.error(`[PermissionService] Cache DEL error for key ${t}:`,e)}}async clearCachesAffectedByRoleChange(e){s.A.info(`[Cache Invalidation] Role ${e} changed. Clearing all user permission caches.`);try{await this.cache.clear(),s.A.debug("[Cache] All user permission caches cleared due to role change.")}catch(e){s.A.error("[PermissionService] Error clearing caches after role change:",e)}}async checkPermission(e,t){return!!t&&(await this.getUserEffectivePermissions(e)).has(t)}async checkBatchPermissions(e,t){if(!t||0===t.length)return[];let r=await this.getUserEffectivePermissions(e),s=[];for(let e of t){if(!e.name){s.push({id:e.id,allowed:!1,reasonCode:"INVALID_REQUEST_FORMAT",message:"Request missing canonical permission name."});continue}let t=r.has(e.name),i="",n="PERMISSION_DENIED";t?(i="Operation allowed.",n="PERMISSION_GRANTED"):0===r.size?(i="User has no effective permissions.",n="NO_PERMISSIONS"):(i=`Permission '${e.name}' denied or not found in user's effective permissions.`,n="PERMISSION_DENIED"),s.push({id:e.id,allowed:t,reasonCode:n,message:i})}return s}}var a=r(83125)},43258:(e,t,r)=>{r.d(t,{A:()=>f});var s=r(19668),i=r.n(s);r(36344);var n=r(33873),a=r.n(n),o=r(29021),c=r.n(o);let l=a().join(process.cwd(),"logs");c().existsSync(l)||c().mkdirSync(l,{recursive:!0});let u=i().format.combine(i().format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),i().format.printf(({timestamp:e,level:t,message:r})=>`${e} [${t.toUpperCase()}]: ${r}`)),d=i().format.combine(i().format.timestamp({format:"YYYY-MM-DD HH:mm:ss.SSS"}),i().format.colorize({all:!0}),i().format.printf(({timestamp:e,level:t,message:r})=>{let s=t.padEnd(15);return`üïí ${e} | ${s} | ${r}`})),h=new(i()).transports.DailyRotateFile({filename:a().join(l,"%DATE%.log"),datePattern:"YYYY-MM-DD",maxSize:"20m",maxFiles:"14d",format:u}),m=new(i()).transports.Console({format:d}),f=i().createLogger({level:"info",transports:[m,h]})},43281:(e,t,r)=>{let s;r.d(t,{authenticateBearer:()=>k,ru:()=>R});var i=r(57642),n=r(37067),a=r(44708),o=r(78474),c=r(13941),l=r(64763);let u=async(e,t,r)=>{let s;switch(e.protocol){case"https:":s=a.get;break;case"http:":s=n.get;break;default:throw TypeError("Unsupported URL protocol.")}let{agent:i,headers:u}=r,d=s(e.href,{agent:i,timeout:t,headers:u}),[h]=await Promise.race([(0,o.once)(d,"response"),(0,o.once)(d,"timeout")]);if(!h)throw d.destroy(),new c.xb;if(200!==h.statusCode)throw new c.i4("Expected 200 OK from the JSON Web Key Set HTTP response");let m=[];for await(let e of h)m.push(e);try{return JSON.parse(l.D0.decode((0,l.xW)(...m)))}catch{throw new c.i4("Failed to parse the JSON Web Key Set HTTP response as JSON")}};var d=r(74528),h=r(96277);function m(e){return(0,h.A)(e)}function f(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))}class p{_jwks;_cached=new WeakMap;constructor(e){if(!function(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(m)}(e))throw new c.Dm("JSON Web Key Set malformed");this._jwks=f(e)}async getKey(e,t){let{alg:r,kid:s}={...e,...t?.header},i=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new c.T0('Unsupported "alg" value for a JSON Web Key Set')}}(r),n=this._jwks.keys.filter(e=>{let t=i===e.kty;if(t&&"string"==typeof s&&(t=s===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv;break;case"Ed25519":t="Ed25519"===e.crv;break;case"EdDSA":t="Ed25519"===e.crv||"Ed448"===e.crv}return t}),{0:a,length:o}=n;if(0===o)throw new c.BT;if(1!==o){let e=new c.$4,{_cached:t}=this;throw e[Symbol.asyncIterator]=async function*(){for(let e of n)try{yield await w(t,e,r)}catch{}},e}return w(this._cached,a,r)}}async function w(e,t,r){let s=e.get(t)||e.set(t,{}).get(t);if(void 0===s[r]){let e=await (0,d.Og)({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new c.Dm("JSON Web Key Set members must be public keys");s[r]=e}return s[r]}function g(e){let t=new p(e),r=async(e,r)=>t.getKey(e,r);return Object.defineProperties(r,{jwks:{value:()=>f(t._jwks),enumerable:!0,configurable:!1,writable:!1}}),r}"undefined"!=typeof navigator&&navigator.userAgent?.startsWith?.("Mozilla/5.0 ")||(s="jose/v5.10.0");let y=Symbol();class _{_url;_timeoutDuration;_cooldownDuration;_cacheMaxAge;_jwksTimestamp;_pendingFetch;_options;_local;_cache;constructor(e,t){if(!(e instanceof URL))throw TypeError("url must be an instance of URL");this._url=new URL(e.href),this._options={agent:t?.agent,headers:t?.headers},this._timeoutDuration="number"==typeof t?.timeoutDuration?t?.timeoutDuration:5e3,this._cooldownDuration="number"==typeof t?.cooldownDuration?t?.cooldownDuration:3e4,this._cacheMaxAge="number"==typeof t?.cacheMaxAge?t?.cacheMaxAge:6e5,t?.[y]!==void 0&&(this._cache=t?.[y],function(e,t){return!("object"!=typeof e||null===e||!("uat"in e)||"number"!=typeof e.uat||Date.now()-e.uat>=t)&&"jwks"in e&&!!(0,h.A)(e.jwks)&&!!Array.isArray(e.jwks.keys)&&!!Array.prototype.every.call(e.jwks.keys,h.A)}(t?.[y],this._cacheMaxAge)&&(this._jwksTimestamp=this._cache.uat,this._local=g(this._cache.jwks)))}coolingDown(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cooldownDuration}fresh(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cacheMaxAge}async getKey(e,t){this._local&&this.fresh()||await this.reload();try{return await this._local(e,t)}catch(r){if(r instanceof c.BT&&!1===this.coolingDown())return await this.reload(),this._local(e,t);throw r}}async reload(){this._pendingFetch&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this._pendingFetch=void 0);let e=new Headers(this._options.headers);s&&!e.has("User-Agent")&&(e.set("User-Agent",s),this._options.headers=Object.fromEntries(e.entries())),this._pendingFetch||=u(this._url,this._timeoutDuration,this._options).then(e=>{this._local=g(e),this._cache&&(this._cache.uat=Date.now(),this._cache.jwks=e),this._jwksTimestamp=Date.now(),this._pendingFetch=void 0}).catch(e=>{throw this._pendingFetch=void 0,e}),await this._pendingFetch}}var v=r(16654),S=r(24958),A=r(18354);async function k(e,t={}){let r,s=e.headers.get("authorization");if(!s||!s.startsWith("Bearer "))return t.allowPublicAccess?{success:!0}:{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let n=s.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI ÁéØÂ¢ÉÂèòÈáèÊú™ËÆæÁΩÆ (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let t=function(e,t){let r=new _(e,void 0),s=async(e,t)=>r.getKey(e,t);return Object.defineProperties(s,{coolingDown:{get:()=>r.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>r.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>r.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>!!r._pendingFetch,enumerable:!0,configurable:!1},jwks:{value:()=>r._local?.jwks(),enumerable:!0,configurable:!1,writable:!1}}),s}(new URL(e)),s=process.env.JWT_ISSUER,i=process.env.JWT_AUDIENCE;if(!s||!i)throw console.error("JWT_ISSUER Êàñ JWT_AUDIENCE ÁéØÂ¢ÉÂèòÈáèÊú™ËÆæÁΩÆ (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");r=(await v.V(n,t,{issuer:s,audience:i,algorithms:["RS256"]})).payload}catch(t){console.error("JWT È™åËØÅÂ§±Ë¥• (JWT validation failed):",t);let e="Token validation failed";return t instanceof c.n?e=`Token expired at ${new Date(1e3*t.payload.exp).toISOString()}`:t instanceof c.ie?e=`Token claim validation failed: ${t.claim} ${t.reason}`:t instanceof c.T0||t instanceof c._L?e="Invalid token algorithm or key issue.":t instanceof Error&&(t.message.includes("JWKS")||t.message.includes("configured"))&&(e=`Token validation setup error: ${t.message}`),{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let a=r.sub,o=r.client_id,l=r.scope?.split(" ")||[],u=r.permissions||[];if(t.requiredScopes&&t.requiredScopes.length>0&&!t.requiredScopes.every(e=>l.includes(e)))return{success:!1,response:i.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${t.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${t.requiredScopes.join(" ")}"`}})};if(t.requiredPermissions&&t.requiredPermissions.length>0){let e=await A.S.getUserPermissions(a);if(!e)return{success:!1,response:i.NextResponse.json({error:"access_denied",error_description:"User not found or has no permissions."},{status:403})};if(!t.requiredPermissions.every(t=>e.permissions.includes(t)))return{success:!1,response:i.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${t.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let d={user_id:a,client_id:o,scopes:l,permissions:u,tokenPayload:r};if(t.requireUserContext&&a)try{let e=await S.z.user.findUnique({where:{id:a,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(d.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥• (Failed to fetch user information):",e)}return{success:!0,context:d}}function R(e,t={}){return async function(r,s){let{success:n,context:a,response:o}=await k(r,t);return n&&a?e(r,{authContext:a,params:s?.params}):o||new i.NextResponse("Unauthorized",{status:401})}}new A.n(S.z);let b={allowedOrigins:["*"],allowedMethods:["GET","POST","PUT","DELETE","OPTIONS","PATCH"],allowedHeaders:["Content-Type","Authorization","X-Requested-With","Accept","Origin","Access-Control-Request-Method","Access-Control-Request-Headers"],allowCredentials:!0,maxAge:86400};function E(e,t){return!!e&&(!!(t.includes("*")||t.includes(e))||t.some(t=>{if(t.includes("*")){let r=t.replace(/\*/g,".*");return RegExp(`^${r}$`).test(e)}return!1}))}function T(e,t,r){let s=t.headers.get("origin");return s&&E(s,r.allowedOrigins||b.allowedOrigins)&&e.headers.set("Access-Control-Allow-Origin",s),e.headers.set("Access-Control-Allow-Methods",(r.allowedMethods||b.allowedMethods).join(", ")),e.headers.set("Access-Control-Allow-Headers",(r.allowedHeaders||b.allowedHeaders).join(", ")),r.allowCredentials&&e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Expose-Headers","Content-Length, Content-Type"),e}r(84327);let D={maxRequests:100,windowMs:9e5,keyType:"ip",message:"ËØ∑Ê±ÇËøá‰∫éÈ¢ëÁπÅÔºåËØ∑Á®çÂêéÂÜçËØï (Too many requests, please try again later)",includeHeaders:!0};function P(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip"),s=e.headers.get("cf-connecting-ip");return t?t.split(",")[0]?.trim()||"127.0.0.1":r||s||"127.0.0.1"}function C(e,t,r,s){if(e.headers.set("X-RateLimit-Limit",t.toString()),e.headers.set("X-RateLimit-Remaining",Math.max(0,r).toString()),e.headers.set("X-RateLimit-Reset",s.toString()),r<=0){let t=Math.ceil((s-Date.now())/1e3);e.headers.set("Retry-After",t.toString())}return e}r(44325)},84327:(e,t,r)=>{r.d(t,{B9:()=>i,Uj:()=>s.Uj}),r(43258);var s=r(60123);function i(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}r(93049),r(746)},93049:(e,t,r)=>{r(43258)}};