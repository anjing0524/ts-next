"use strict";exports.id=930,exports.ids=[930],exports.modules={2930:(e,t,o)=>{o.r(t),o.d(t,{DEFAULT_AUTHORIZATION_CODE_LIFETIME_SECONDS:()=>h,generateSecureRandomString:()=>c,storeAuthorizationCode:()=>s,validateAuthorizationCode:()=>l});var i=o(8891),a=o(9039),r=o(5511),n=o.n(r),d=o(4931);let h=600;function c(e=32){return n().randomBytes(e).toString("hex")}async function s(e,t,o,r,n,l,u=h,C){var _;if("S256"!==n)throw new d.j1(`Unsupported code challenge method: ${n}. Only 'S256' is supported.`);let w=c(32),E=(_=new Date,(0,a.A)(_,1e3*u,void 0));try{return await i.z.authorizationCode.create({data:{code:w,userId:e,clientId:t,redirectUri:o,scope:l,codeChallenge:r,codeChallengeMethod:n,expiresAt:E,isUsed:!1,nonce:C||null}})}catch(e){throw console.error("Failed to store authorization code:",e),new d.Cf("Database error while storing authorization code.",500,"DB_STORE_AUTH_CODE_FAILED")}}async function l(e,t,o,a){let r=null;try{if(!(r=await i.z.authorizationCode.findUnique({where:{code:e}})))throw new d.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(r.isUsed)throw await i.z.authorizationCode.delete({where:{id:r.id}}),new d.Pb("Invalid authorization code: Code has already been used.",400,"AUTH_CODE_USED");if(r.expiresAt<new Date)throw await i.z.authorizationCode.delete({where:{id:r.id}}),new d.Pb("Invalid authorization code: Code has expired.",400,"AUTH_CODE_EXPIRED");if(r.clientId!==t)throw new d.yI("Invalid authorization code: Client ID mismatch.",{expected:t,actual:r.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(r.redirectUri!==o)throw new d.yI("Invalid authorization code: Redirect URI mismatch.",{expected:o,actual:r.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===r.codeChallengeMethod){if(n().createHash("sha256").update(a).digest("base64url")!==r.codeChallenge)throw new d.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new d.j1(`Unsupported code challenge method in stored code: ${r.codeChallengeMethod}. Only 'S256' is supported.`,void 0,"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await i.z.authorizationCode.update({where:{id:r.id},data:{isUsed:!0}})}catch(e){if(e instanceof d.Cf)throw e;if(console.error("Error during authorization code validation:",e),e instanceof Prisma.PrismaClientKnownRequestError)throw new d.Cf(`Database error during authorization code validation: ${e.message}`,500,`DB_VALIDATE_AUTH_CODE_PRISMA_${e.code}`);throw new d.Cf("Database error during authorization code validation.",500,"DB_VALIDATE_AUTH_CODE_FAILED")}}}};