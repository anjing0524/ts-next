"use strict";exports.id=565,exports.ids=[565],exports.modules={9565:(e,s,r)=>{r.d(s,{NC:()=>l,PS:()=>p});var i=r(7642),o=r(7151),n=r(2229),t=r(1047),a=r(4958),c=r(9776);class u{static async getUserPermissions(e){let s=await a.z.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{include:{role:{include:{rolePermissions:{include:{permission:!0}}}}}}}});if(!s)return null;let r=s.userRoles.map(e=>e.role.name),i=new Set;return s.userRoles.forEach(e=>{e.role.rolePermissions.forEach(e=>{i.add(e.permission.name)})}),{userId:s.id,roles:r,permissions:Array.from(i),organizationContext:{organization:s.organization||void 0,department:s.department||void 0}}}}let d=new u;async function l(e,s={}){let r,a=e.headers.get("authorization");if(!a||!a.startsWith("Bearer "))return s.allowPublicAccess?{success:!0}:{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let u=a.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let s=o.RD(new URL(e)),i=process.env.JWT_ISSUER,t=process.env.JWT_AUDIENCE;if(!i||!t)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");r=(await n.V(u,s,{issuer:i,audience:t,algorithms:["RS256"]})).payload}catch(r){console.error("JWT 验证失败 (JWT validation failed):",r);let s="Token validation failed";return r instanceof t.n?s=`Token expired at ${new Date(1e3*r.payload.exp).toISOString()}`:r instanceof t.ie?s=`Token claim validation failed: ${r.claim} ${r.reason}`:r instanceof t.T0||r instanceof t._L?s="Invalid token algorithm or key issue.":r instanceof Error&&(r.message.includes("JWKS")||r.message.includes("configured"))&&(s=`Token validation setup error: ${r.message}`),await c.PC.logAuditEvent({action:"token_verification_failed_jwks",resource:e.url,ipAddress:e.headers.get("x-forwarded-for")||void 0,userAgent:e.headers.get("user-agent")||void 0,success:!1,errorMessage:s}),{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:s},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let d={user_id:r.sub!==r.client_id?r.sub:void 0,client_id:r.client_id,scopes:c.e8.parseScopes(r.scope),permissions:r.permissions||[],tokenPayload:r};return s.requireUserContext&&!d.user_id?{success:!1,response:i.NextResponse.json({error:"insufficient_scope",error_description:"User context required for this endpoint"},{status:403})}:s.requiredScopes&&s.requiredScopes.length>0&&!c.e8.hasAllScopes(d.scopes,s.requiredScopes)?(await c.PC.logAuditEvent({userId:d.user_id,clientId:d.client_id,action:"insufficient_scope",resource:e.url,ipAddress:e.headers.get("x-forwarded-for")||void 0,userAgent:e.headers.get("user-agent")||void 0,success:!1,errorMessage:`Required scopes: ${s.requiredScopes.join(", ")}`,metadata:{userScopes:d.scopes,requiredScopes:s.requiredScopes}}),{success:!1,response:i.NextResponse.json({error:"insufficient_scope",error_description:`Required scopes: ${s.requiredScopes.join(" ")}`,scope:s.requiredScopes.join(" ")},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${s.requiredScopes.join(" ")}"`}})}):s.requiredPermissions&&s.requiredPermissions.length>0&&!s.requiredPermissions.every(e=>d.permissions.includes(e))?(await c.PC.logAuditEvent({userId:d.user_id,clientId:d.client_id,action:"insufficient_permissions",resource:e.url,ipAddress:e.headers.get("x-forwarded-for")||void 0,userAgent:e.headers.get("user-agent")||void 0,success:!1,errorMessage:`Required permissions: ${s.requiredPermissions.join(", ")}`,metadata:{userPermissions:d.permissions,requiredPermissions:s.requiredPermissions}}),{success:!1,response:i.NextResponse.json({error:"forbidden",error_description:"Insufficient permissions for this resource"},{status:403})}):(await c.PC.logAuditEvent({userId:d.user_id,clientId:d.client_id,action:"api_access",resource:e.url,ipAddress:e.headers.get("x-forwarded-for")||void 0,userAgent:e.headers.get("user-agent")||void 0,success:!0,metadata:{scopes:d.scopes,permissions:d.permissions}}),{success:!0,context:d})}function p(e){return function(s){return async function(r,...t){let a,c=r.headers.get("Authorization");if(!c||!c.toLowerCase().startsWith("bearer "))return i.NextResponse.json({message:"未授权: 缺少或无效的 Authorization header (Unauthorized: Missing or invalid Authorization header)"},{status:401});let u=c.substring(7);if(!u)return i.NextResponse.json({message:"未授权: 缺少令牌 (Unauthorized: Missing token)"},{status:401});try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI 环境变量未设置 (JWKS_URI environment variable is not set)"),Error("认证服务配置错误 (Authentication service configuration error).");let s=o.RD(new URL(e)),r=process.env.JWT_ISSUER,i=process.env.JWT_AUDIENCE;if(!r||!i)throw console.error("JWT_ISSUER 或 JWT_AUDIENCE 环境变量未设置 (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("认证服务配置错误 (Authentication service configuration error).");let{payload:t}=await n.V(u,s,{issuer:r,audience:i,algorithms:["RS256"]});a=t}catch(e){return console.warn("requirePermission: OAuth Access Token 验证失败 (OAuth Access Token verification failed).",e.message),i.NextResponse.json({message:`未授权: ${e.message||"无效的OAuth令牌 (Invalid OAuth token)"}`},{status:401})}let l=a.sub;if(!l||"string"!=typeof l)return i.NextResponse.json({message:"未授权: 无效的令牌载荷 (无效的sub声明) (Unauthorized: Invalid token payload (missing or invalid sub claim for user ID))"},{status:401});let p=!1,m=a.permissions;return(m&&Array.isArray(m)?(p=m.includes(e),console.log(`requirePermission: 用户 '${l}' 通过令牌声明检查权限 '${e}'。结果: ${p} (User '${l}' checking permission '${e}' via token claims. Result: ${p})`)):(console.log(`requirePermission: 用户 '${l}' 的令牌中无 'permissions' 声明。通过 PermissionService 检查权限 '${e}'。(No 'permissions' claim in token for user '${l}'. Checking permission '${e}' via PermissionService.)`),p=await d.checkPermission(l,e)),p)?(r.user={id:l,userId:l,username:a.username||a.preferred_username||void 0,clientId:a.client_id||void 0,permissions:m||[],...a},s(r,...t)):(console.warn(`requirePermission: 用户 ${l} 无权限 '${e}'。(User ${l} does not have permission '${e}'.)`),i.NextResponse.json({message:`禁止访问: 您没有 '${e}' 权限访问此资源。(Forbidden: You do not have permission '${e}' to access this resource.)`},{status:403}))}}}}};