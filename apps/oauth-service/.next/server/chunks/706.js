"use strict";exports.id=706,exports.ids=[706],exports.modules={44325:(e,t,r)=>{r.d(t,{PC:()=>D,DU:()=>R,L3:()=>T,e8:()=>U});var i=r(74528),n=r(26338),s=r(16654),a=r(13941),o=r(22517),c=r(55511),l=r.n(c);function d(){let e=process.env.JWT_ISSUER;if(!e)throw Error("JWT_ISSUER environment variable is required");return e}function u(){let e=process.env.JWT_AUDIENCE;if(!e)throw Error("JWT_AUDIENCE environment variable is required");return e}async function h(){let e=process.env.JWT_PRIVATE_KEY;if(!e)throw Error("JWT_PRIVATE_KEY environment variable is required");try{return await i.Lf(e,"RS256")}catch(e){throw Error(`Failed to import JWT private key: ${e}`)}}async function f(){let e=process.env.JWT_PUBLIC_KEY;if(!e)throw Error("JWT_PUBLIC_KEY environment variable is required");try{return await i.jU(e,"RS256")}catch(e){throw Error(`Failed to import JWT public key: ${e}`)}}async function p(e,t){let r=t?.algorithm||process.env.JWT_ALGORITHM||"RS256",i=t?.keyId||process.env.JWT_KEY_ID||"default-kid",s={client_id:e.client_id,sub:e.user_id||e.client_id,aud:t?.audience||u(),iss:t?.issuer||d(),jti:c.randomUUID(),iat:Math.floor(Date.now()/1e3),scope:e.scope,permissions:e.permissions||[]};return Object.keys(s).forEach(e=>void 0===s[e]&&delete s[e]),await new n.P(s).setProtectedHeader({alg:r,kid:i}).setExpirationTime(t?.expiresIn||e.exp||"1h").sign(await h())}async function g(e,t){let r=t?.algorithm||process.env.JWT_ALGORITHM||"RS256",i=t?.keyId||process.env.JWT_KEY_ID||"default-kid",s={client_id:e.client_id,sub:e.user_id||e.client_id,aud:t?.audience||u(),iss:t?.issuer||d(),jti:c.randomUUID(),iat:Math.floor(Date.now()/1e3),scope:e.scope,token_type:"refresh_token"};return Object.keys(s).forEach(e=>void 0===s[e]&&delete s[e]),await new n.P(s).setProtectedHeader({alg:r,kid:i}).setExpirationTime(t?.expiresIn||"30d").sign(await h())}async function y(e,t){let r=t?.algorithm||process.env.JWT_ALGORITHM||"RS256",i=t?.keyId||process.env.JWT_KEY_ID||"default-kid",s={sub:e.sub,aud:e.aud,iss:t?.issuer||d(),iat:e.iat||Math.floor(Date.now()/1e3),exp:e.exp,nonce:e.nonce,email:e.email,name:e.name,picture:e.picture};return Object.keys(s).forEach(e=>void 0===s[e]&&delete s[e]),await new n.P(s).setProtectedHeader({alg:r,kid:i}).setExpirationTime(t?.expiresIn||"1h").sign(await h())}async function m(e,t){try{let r=await f(),{payload:i}=await s.V(e,r,{issuer:t?.issuer||d(),audience:t?.audience||u(),algorithms:[t?.algorithm||"RS256"]});return{valid:!0,payload:i}}catch(t){let e="Token verification failed";return t instanceof a.n?e="Token has expired":t instanceof a.Ye&&(e="Invalid token signature"),{valid:!1,error:e}}}async function v(e,t){try{let r=await f(),{payload:i}=await s.V(e,r,{issuer:t?.issuer||d(),audience:t?.audience||u(),algorithms:[t?.algorithm||"RS256"]});if("refresh_token"!==i.token_type)return{valid:!1,error:"Invalid token type, expected refresh_token"};return{valid:!0,payload:i}}catch(t){let e="Refresh token verification failed";return t instanceof a.n?e="Refresh token has expired":t instanceof a.Ye&&(e="Invalid refresh token signature"),{valid:!1,error:e}}}function w(e){try{return o.i(e)}catch(e){return console.error("Failed to decode token:",e),null}}async function S(e,t){let r=await v(e);if(!r.valid||!r.payload)throw Error(r.error||"Invalid refresh token");let i=r.payload;if(i.client_id!==t.clientId)throw Error("Refresh token was not issued to this client");return i}let R={getIssuer:d,getAudience:u,getRSAPrivateKeyForSigning:h,getRSAPublicKeyForVerification:f,createAccessToken:p,createRefreshToken:g,createIdToken:y,verifyAccessToken:m,verifyRefreshToken:v,decodeToken:w,getTokenHash:function(e){return c.createHash("sha256").update(e).digest("hex")},isTokenNearExpiry:function(e,t=300){let r=w(e);if(!r||!r.exp)return!1;let i=Math.floor(Date.now()/1e3);return r.exp-i<t},getSubjectFromToken:function(e){let t=w(e);return t?.sub||null},getScopesFromToken:function(e){let t=w(e);return t&&t.scope&&"string"==typeof t.scope?t.scope.split(" ").filter(e=>e):[]},decodeTokenPayload:async function e(e,t){if(!t)try{return o.i(e)}catch(e){throw Error("Invalid token format")}try{let r=new TextEncoder().encode(t),{payload:i}=await s.V(e,r);return i}catch(e){if("ERR_JWT_EXPIRED"===e.code)throw Error("Token has expired");throw Error("Invalid token")}},verifyAndDecodeRefreshToken:S,extractTokenFromHeader:function(e){return e.startsWith("Bearer ")?e.substring(7):null}};function E(){return l().randomBytes(32).toString("base64url")}function _(e){return l().createHash("sha256").update(e).digest("base64url")}function I(e,t,r="S256"){return"S256"!==r?(console.warn(`PKCEUtils: Unsupported code_challenge_method: ${r}`),!1):_(e)===t}function k(e){return/^[A-Za-z0-9\-._~]{43,128}$/.test(e)}function C(e){return"S256"===e||"plain"===e}let T={generateCodeVerifier:E,generateCodeChallenge:_,verifyCodeChallenge:I,validateCodeChallenge:function(e){return/^[A-Za-z0-9\-._~]{43,128}$/.test(e)},validateCodeVerifier:k,isSupportedChallengeMethod:C,validatePKCEParams:function(e){let{codeVerifier:t,codeChallenge:r,codeChallengeMethod:i}=e;return r&&!i?{isValid:!1,error:"code_challenge_method is required when code_challenge is provided"}:i&&!C(i)?{isValid:!1,error:`Unsupported code_challenge_method: ${i}`}:t&&!k(t)?{isValid:!1,error:"Invalid code_verifier format"}:t&&r&&i&&!I(t,r,i)?{isValid:!1,error:"code_verifier does not match code_challenge"}:{isValid:!0}},generatePKCEPair:function(){let e=E(),t=_(e);return{codeVerifier:e,codeChallenge:t,codeChallengeMethod:"S256"}}};function x(e){return e?e.split(" ").filter(e=>e.length>0):[]}function P(e){return/^[!-~]+$/.test(e)&&!/[\s"\\]/.test(e)}function A(e){return["openid","profile","email","address","phone"].includes(e)}let U={parseScopes:x,formatScopes:function(e){return e.join(" ")},hasScope:function(e,t){return e.includes(t)},hasAnyScope:function(e,t){return t.some(t=>e.includes(t))},hasAllScopes:function(e,t){return t.every(t=>e.includes(t))},isValidScopeFormat:P,validateScopeFormats:function(e){let t=e.filter(e=>!P(e));return{valid:0===t.length,invalidScopes:t}},validateScopes:function(e,t){if(0===e.length)return{valid:!0,invalidScopes:[]};if(Array.isArray(t)){let r=e.filter(e=>!t.includes(e));return{valid:0===r.length,invalidScopes:r,error_description:r.length>0?`Requested scope(s) not in allowed list: ${r.join(", ")}`:void 0}}return t.id&&void 0!==t.allowedScopes?(async()=>{let i=[];if(t.allowedScopes)try{i=JSON.parse(t.allowedScopes),Array.isArray(i)||(i=[])}catch(e){console.error("Failed to parse client.allowedScopes for client ID:",t.id,e),i=[]}let n=e.filter(e=>!i.includes(e));if(n.length>0)return{valid:!1,invalidScopes:n,error_description:`Requested scope(s) not allowed for this client: ${n.join(", ")}`};try{let{prisma:t}=await Promise.resolve().then(r.bind(r,34621)),i=(await t.scope.findMany({where:{name:{in:e},isActive:!0}})).map(e=>e.name),n=e.filter(e=>!i.includes(e));return{valid:0===n.length,invalidScopes:n,error_description:n.length>0?`Requested scope(s) not found in system: ${n.join(", ")}`:void 0}}catch(e){return console.warn("Database validation not available, falling back to client-only validation"),{valid:!0,invalidScopes:[]}}})():(async()=>{let r=[],i=t.allowedScopes||t.clientScopes||t.scopes||"";try{i&&(r="string"==typeof i?x(i):Array.isArray(i)?i:[])}catch(t){return console.error("Error parsing client scopes:",t),{valid:!1,invalidScopes:e,error_description:"Failed to parse client allowed scopes"}}let n=e.filter(e=>!r.includes(e));return{valid:0===n.length,invalidScopes:n,error_description:n.length>0?`Requested scope(s) not in allowed list: ${n.join(", ")}`:void 0}})()},filterValidScopes:function(e,t){return e.filter(e=>t.includes(e))},isOpenIdConnectScope:A,extractOpenIdConnectScopes:function(e){return e.filter(A)},extractCustomScopes:function(e){return e.filter(e=>!A(e))},isOpenIdConnectRequest:function(e){return e.includes("openid")},normalizeScopes:function(e){return[...new Set(e)].sort()},intersectScopes:function(e,t){let r=new Set(e);return t.filter(e=>r.has(e))},unionScopes:function(e,t){return[...new Set([...e,...t])]},differenceScopes:function(e,t){let r=new Set(t);return e.filter(e=>!r.has(e))}};var b=r(34621),J=r(83125);let D={validateRedirectUri:function(e,t){return t.includes(e)},validateResponseType:function(e,t=["code"]){return t.includes(e)},generateState:function(){return c.randomBytes(32).toString("base64url")},generateNonce:function(){return c.randomBytes(32).toString("base64url")},generateAuthorizationCode:function(){return c.randomBytes(32).toString("hex")},logAuditEvent:async function(e){try{let t="SYSTEM",r="system";if(e.userId)t="USER",r=e.userId;else if(e.clientId){t="CLIENT";let i=await b.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});r=i?i.clientId:e.clientId}let i=e.success;void 0===i&&(i=e.status?"SUCCESS"===e.status:!e.errorMessage),await b.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:r||"system",status:i?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:function(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let r=JSON.parse(e.details);t={...t,...r}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}},getUserPermissions:async function(e){try{let t=await J.S.getUserPermissions(e),r=t?.permissions||[],i=new Set(r.filter(e=>"string"==typeof e));return Array.from(i)}catch(e){return console.error("Error getting user permissions:",e),[]}}};r(5486);var W=r(67200);r(24958),W.z.string().min(8,"Password must be at least 8 characters long.").refine(e=>{let t=[/[a-z]/,/[A-Z]/,/[0-9]/,RegExp(`[${"!@#$%^&*()_+-=[]{};:'\",.<>/?`~".replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}]`)],r=0;for(let i of t)i.test(e)&&r++;return r>=2},"Password must contain characters from at least two of the following categories: uppercase letters, lowercase letters, numbers, and special characters.")},50802:(e,t,r)=>{r.d(t,{PP:()=>u,yk:()=>d});var i=r(84448),n=r.n(i),s=r(21560);let a={info:(...e)=>{console.log("[CACHE-INFO]",...e)},error:(...e)=>{console.error("[CACHE-ERROR]",...e)}};class o{constructor(e){this.client=e}async get(e){try{let t=await this.client.get(e);return t?JSON.parse(t):null}catch(e){return a.error("Redis get error:",e),null}}async set(e,t,r){try{let i=JSON.stringify(t);r?await this.client.setex(e,r,i):await this.client.set(e,i)}catch(e){a.error("Redis set error:",e)}}async del(e){try{await this.client.del(e)}catch(e){a.error("Redis del error:",e)}}async clear(){try{await this.client.flushdb()}catch(e){a.error("Redis clear error:",e)}}async exists(e){try{let t=await this.client.exists(e);return 1===t}catch(e){return a.error("Redis exists error:",e),!1}}}class c{constructor(e){this.cache=new s.q({max:e.max,ttl:e.ttl?1e3*e.ttl:void 0})}async get(e){return this.cache.get(e)||null}async set(e,t,r){r?this.cache.set(e,t,{ttl:1e3*r}):this.cache.set(e,t)}async del(e){this.cache.delete(e)}async clear(){this.cache.clear()}async exists(e){return this.cache.has(e)}}class l{constructor(){this.initializeCache()}static getInstance(){return l.instance||(l.instance=new l),l.instance}initializeCache(){let e=process.env.REDIS_URL;if(e)try{this.redisClient=new(n())(e,{maxRetriesPerRequest:3,lazyConnect:!0}),this.redisClient.on("error",e=>{a.error("Redis connection error:",e),this.fallbackToLRU()}),this.redisClient.on("connect",()=>{a.info("Redis connected successfully")}),this.cache=new o(this.redisClient),a.info("Cache initialized with Redis")}catch(e){a.error("Failed to initialize Redis, falling back to LRU cache:",e),this.fallbackToLRU()}else this.fallbackToLRU()}fallbackToLRU(){this.cache=new c({max:1e3,ttl:3600}),a.info("Cache initialized with LRU cache")}getCache(){return this.cache}getRedisClient(){return this.redisClient}isUsingRedis(){return void 0!==this.redisClient}async close(){this.redisClient&&await this.redisClient.quit()}}let d=l.getInstance(),u=d.getCache()},83125:(e,t,r)=>{r.d(t,{S:()=>s});var i=r(24958),n=r(50802);class s{static async getUserPermissions(e){let t=`user-permissions:${e}`,r=await n.PP.get(t);if(r)return console.log(`[RBAC] Cache hit for user ${e}`),r;console.log(`[RBAC] Cache miss for user ${e}, fetching from DB...`);let s=await i.z.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{include:{role:{include:{rolePermissions:{include:{permission:!0}}}}}}}});if(!s)return null;let a=s.userRoles.map(e=>e.role.name),o=new Set;s.userRoles.forEach(e=>{e.role.rolePermissions.forEach(e=>{o.add(e.permission.name)})});let c={userId:s.id,roles:a,permissions:Array.from(o),organizationContext:{organization:s.organization||void 0,department:s.department||void 0}};return await n.PP.set(t,c,60),c}static async checkPermission(e,t){let r=await this.getUserPermissions(e);return!!r&&r.permissions.includes(t)}}}};