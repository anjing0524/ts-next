"use strict";exports.id=706,exports.ids=[706],exports.modules={44325:(e,t,r)=>{r.d(t,{PC:()=>W,DU:()=>_,L3:()=>A,e8:()=>U});var n=r(74528),i=r(26338),o=r(16654),s=r(13941),a=r(22517),l=r(55511),c=r.n(l);function d(){let e=process.env.JWT_ISSUER;if(!e)throw Error("JWT_ISSUER environment variable is required");return e}function u(){let e=process.env.JWT_AUDIENCE;if(!e)throw Error("JWT_AUDIENCE environment variable is required");return e}async function f(){let e=process.env.JWT_PRIVATE_KEY;if(!e)throw Error("JWT_PRIVATE_KEY environment variable is required");try{return await n.Lf(e,"RS256")}catch(e){throw Error(`Failed to import JWT private key: ${e}`)}}async function p(){let e=process.env.JWT_PUBLIC_KEY;if(!e)throw Error("JWT_PUBLIC_KEY environment variable is required");try{return await n.jU(e,"RS256")}catch(e){throw Error(`Failed to import JWT public key: ${e}`)}}async function h(e,t){let r=t?.algorithm||process.env.JWT_ALGORITHM||"RS256",n=t?.keyId||process.env.JWT_KEY_ID||"default-kid",o={client_id:e.client_id,sub:e.user_id||e.client_id,aud:t?.audience||u(),iss:t?.issuer||d(),jti:l.randomUUID(),iat:Math.floor(Date.now()/1e3),scope:e.scope,permissions:e.permissions||[]};return Object.keys(o).forEach(e=>void 0===o[e]&&delete o[e]),await new i.P(o).setProtectedHeader({alg:r,kid:n}).setExpirationTime(t?.expiresIn||e.exp||"1h").sign(await f())}async function v(e,t){let r=t?.algorithm||process.env.JWT_ALGORITHM||"RS256",n=t?.keyId||process.env.JWT_KEY_ID||"default-kid",o={client_id:e.client_id,sub:e.user_id||e.client_id,aud:t?.audience||u(),iss:t?.issuer||d(),jti:l.randomUUID(),iat:Math.floor(Date.now()/1e3),scope:e.scope,token_type:"refresh_token"};return Object.keys(o).forEach(e=>void 0===o[e]&&delete o[e]),await new i.P(o).setProtectedHeader({alg:r,kid:n}).setExpirationTime(t?.expiresIn||"30d").sign(await f())}async function m(e,t){let r=t?.algorithm||process.env.JWT_ALGORITHM||"RS256",n=t?.keyId||process.env.JWT_KEY_ID||"default-kid",o={sub:e.sub,aud:e.aud,iss:t?.issuer||d(),iat:e.iat||Math.floor(Date.now()/1e3),exp:e.exp,nonce:e.nonce,email:e.email,name:e.name,picture:e.picture};return Object.keys(o).forEach(e=>void 0===o[e]&&delete o[e]),await new i.P(o).setProtectedHeader({alg:r,kid:n}).setExpirationTime(t?.expiresIn||"1h").sign(await f())}async function g(e,t){try{let r=await p(),{payload:n}=await o.V(e,r,{issuer:t?.issuer||d(),audience:t?.audience||u(),algorithms:[t?.algorithm||"RS256"]});return{valid:!0,payload:n}}catch(t){let e="Token verification failed";return t instanceof s.n?e="Token has expired":t instanceof s.Ye&&(e="Invalid token signature"),{valid:!1,error:e}}}async function w(e,t){try{let r=await p(),{payload:n}=await o.V(e,r,{issuer:t?.issuer||d(),audience:t?.audience||u(),algorithms:[t?.algorithm||"RS256"]});if("refresh_token"!==n.token_type)return{valid:!1,error:"Invalid token type, expected refresh_token"};return{valid:!0,payload:n}}catch(t){let e="Refresh token verification failed";return t instanceof s.n?e="Refresh token has expired":t instanceof s.Ye&&(e="Invalid refresh token signature"),{valid:!1,error:e}}}function y(e){try{return a.i(e)}catch(e){return console.error("Failed to decode token:",e),null}}async function S(e,t){let r=await w(e);if(!r.valid||!r.payload)throw Error(r.error||"Invalid refresh token");let n=r.payload;if(n.client_id!==t.clientId)throw Error("Refresh token was not issued to this client");return n}let _={getIssuer:d,getAudience:u,getRSAPrivateKeyForSigning:f,getRSAPublicKeyForVerification:p,createAccessToken:h,createRefreshToken:v,createIdToken:m,verifyAccessToken:g,verifyRefreshToken:w,decodeToken:y,getTokenHash:function(e){return l.createHash("sha256").update(e).digest("hex")},isTokenNearExpiry:function(e,t=300){let r=y(e);if(!r||!r.exp)return!1;let n=Math.floor(Date.now()/1e3);return r.exp-n<t},getSubjectFromToken:function(e){let t=y(e);return t?.sub||null},getScopesFromToken:function(e){let t=y(e);return t&&t.scope&&"string"==typeof t.scope?t.scope.split(" ").filter(e=>e):[]},decodeTokenPayload:async function e(e,t){if(!t)try{return a.i(e)}catch(e){throw Error("Invalid token format")}try{let r=new TextEncoder().encode(t),{payload:n}=await o.V(e,r);return n}catch(e){if("ERR_JWT_EXPIRED"===e.code)throw Error("Token has expired");throw Error("Invalid token")}},verifyAndDecodeRefreshToken:S,extractTokenFromHeader:function(e){return e.startsWith("Bearer ")?e.substring(7):null}};function E(){return c().randomBytes(32).toString("base64url")}function I(e){return c().createHash("sha256").update(e).digest("base64url")}function k(e,t,r="S256"){return"S256"!==r?(console.warn(`PKCEUtils: Unsupported code_challenge_method: ${r}`),!1):I(e)===t}function T(e){return/^[A-Za-z0-9\-._~]{43,128}$/.test(e)}function R(e){return"S256"===e||"plain"===e}let A={generateCodeVerifier:E,generateCodeChallenge:I,verifyCodeChallenge:k,validateCodeChallenge:function(e){return/^[A-Za-z0-9\-._~]{43,128}$/.test(e)},validateCodeVerifier:T,isSupportedChallengeMethod:R,validatePKCEParams:function(e){let{codeVerifier:t,codeChallenge:r,codeChallengeMethod:n}=e;return r&&!n?{isValid:!1,error:"code_challenge_method is required when code_challenge is provided"}:n&&!R(n)?{isValid:!1,error:`Unsupported code_challenge_method: ${n}`}:t&&!T(t)?{isValid:!1,error:"Invalid code_verifier format"}:t&&r&&n&&!k(t,r,n)?{isValid:!1,error:"code_verifier does not match code_challenge"}:{isValid:!0}},generatePKCEPair:function(){let e=E(),t=I(e);return{codeVerifier:e,codeChallenge:t,codeChallengeMethod:"S256"}}};function x(e){return e?e.split(" ").filter(e=>e.length>0):[]}function b(e){return/^[!-~]+$/.test(e)&&!/[\s"\\]/.test(e)}function P(e){return["openid","profile","email","address","phone"].includes(e)}let U={parseScopes:x,formatScopes:function(e){return e.join(" ")},hasScope:function(e,t){return e.includes(t)},hasAnyScope:function(e,t){return t.some(t=>e.includes(t))},hasAllScopes:function(e,t){return t.every(t=>e.includes(t))},isValidScopeFormat:b,validateScopeFormats:function(e){let t=e.filter(e=>!b(e));return{valid:0===t.length,invalidScopes:t}},validateScopes:function(e,t){if(0===e.length)return{valid:!0,invalidScopes:[]};if(Array.isArray(t)){let r=e.filter(e=>!t.includes(e));return{valid:0===r.length,invalidScopes:r,error_description:r.length>0?`Requested scope(s) not in allowed list: ${r.join(", ")}`:void 0}}return t.id&&void 0!==t.allowedScopes?(async()=>{let n=[];if(t.allowedScopes)try{n=JSON.parse(t.allowedScopes),Array.isArray(n)||(n=[])}catch(e){console.error("Failed to parse client.allowedScopes for client ID:",t.id,e),n=[]}let i=e.filter(e=>!n.includes(e));if(i.length>0)return{valid:!1,invalidScopes:i,error_description:`Requested scope(s) not allowed for this client: ${i.join(", ")}`};try{let{prisma:t}=await Promise.resolve().then(r.bind(r,34621)),n=(await t.scope.findMany({where:{name:{in:e},isActive:!0}})).map(e=>e.name),i=e.filter(e=>!n.includes(e));return{valid:0===i.length,invalidScopes:i,error_description:i.length>0?`Requested scope(s) not found in system: ${i.join(", ")}`:void 0}}catch(e){return console.warn("Database validation not available, falling back to client-only validation"),{valid:!0,invalidScopes:[]}}})():(async()=>{let r=[],n=t.allowedScopes||t.clientScopes||t.scopes||"";try{n&&(r="string"==typeof n?x(n):Array.isArray(n)?n:[])}catch(t){return console.error("Error parsing client scopes:",t),{valid:!1,invalidScopes:e,error_description:"Failed to parse client allowed scopes"}}let i=e.filter(e=>!r.includes(e));return{valid:0===i.length,invalidScopes:i,error_description:i.length>0?`Requested scope(s) not in allowed list: ${i.join(", ")}`:void 0}})()},filterValidScopes:function(e,t){return e.filter(e=>t.includes(e))},isOpenIdConnectScope:P,extractOpenIdConnectScopes:function(e){return e.filter(P)},extractCustomScopes:function(e){return e.filter(e=>!P(e))},isOpenIdConnectRequest:function(e){return e.includes("openid")},normalizeScopes:function(e){return[...new Set(e)].sort()},intersectScopes:function(e,t){let r=new Set(e);return t.filter(e=>r.has(e))},unionScopes:function(e,t){return[...new Set([...e,...t])]},differenceScopes:function(e,t){let r=new Set(t);return e.filter(e=>!r.has(e))}};var C=r(34621),J=r(83125);let W={validateRedirectUri:function(e,t){return t.includes(e)},validateResponseType:function(e,t=["code"]){return t.includes(e)},generateState:function(){return l.randomBytes(32).toString("base64url")},generateNonce:function(){return l.randomBytes(32).toString("base64url")},generateAuthorizationCode:function(){return l.randomBytes(32).toString("hex")},logAuditEvent:async function(e){try{let t="SYSTEM",r="system";if(e.userId)t="USER",r=e.userId;else if(e.clientId){t="CLIENT";let n=await C.prisma.oAuthClient.findUnique({where:{id:e.clientId},select:{clientId:!0}});r=n?n.clientId:e.clientId}let n=e.success;void 0===n&&(n=e.status?"SUCCESS"===e.status:!e.errorMessage),await C.prisma.auditLog.create({data:{action:e.action,actorType:t,actorId:r||"system",status:n?"SUCCESS":"FAILURE",ipAddress:e.ipAddress||null,userAgent:e.userAgent||null,details:function(e){let t={};if(e.metadata&&(t={...t,...e.metadata}),e.errorMessage&&(t.errorMessage=e.errorMessage),e.details)try{let r=JSON.parse(e.details);t={...t,...r}}catch{t.rawDetails=e.details}return Object.keys(t).length>0?JSON.stringify(t):null}(e)||void 0}})}catch(e){console.error("Failed to log audit event:",e)}},getUserPermissions:async function(e){try{let t=await J.S.getUserPermissions(e),r=t?.permissions||[],n=new Set(r.filter(e=>"string"==typeof e));return Array.from(n)}catch(e){return console.error("Error getting user permissions:",e),[]}}};r(5486);var D=r(67200);r(24958),D.z.string().min(8,"Password must be at least 8 characters long.").refine(e=>{let t=[/[a-z]/,/[A-Z]/,/[0-9]/,RegExp(`[${"!@#$%^&*()_+-=[]{};:'\",.<>/?`~".replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}]`)],r=0;for(let n of t)n.test(e)&&r++;return r>=2},"Password must contain characters from at least two of the following categories: uppercase letters, lowercase letters, numbers, and special characters.")},83125:(e,t,r)=>{r.d(t,{S:()=>i});var n=r(24958);class i{static async getUserPermissions(e){let t=await n.z.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{include:{role:{include:{rolePermissions:{include:{permission:!0}}}}}}}});if(!t)return null;let r=t.userRoles.map(e=>e.role.name),i=new Set;return t.userRoles.forEach(e=>{e.role.rolePermissions.forEach(e=>{i.add(e.permission.name)})}),{userId:t.id,roles:r,permissions:Array.from(i),organizationContext:{organization:t.organization||void 0,department:t.department||void 0}}}}}};