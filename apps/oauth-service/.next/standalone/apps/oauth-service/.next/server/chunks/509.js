"use strict";exports.id=509,exports.ids=[509],exports.modules={71890:(e,o,i)=>{i.d(o,{storeAuthorizationCode:()=>c,validateAuthorizationCode:()=>h});var t=i(34621),r=i(49039),a=i(55511),n=i.n(a),d=i(55807),s=i(96330);async function c(e,o,i,a,s,h,l=600,u){var w;if("S256"!==s)throw new d.yI(`Unsupported code challenge method: ${s}. Only 'S256' is supported.`,{codeChallengeMethod:s},"UNSUPPORTED_CHALLENGE_METHOD");let C=function(e=32){return n().randomBytes(e).toString("hex")}(32),E=(w=new Date,(0,r.A)(w,1e3*l,void 0));try{return await t.prisma.authorizationCode.create({data:{code:C,userId:e,clientId:o,redirectUri:i,scope:h,codeChallenge:a,codeChallengeMethod:s,expiresAt:E,isUsed:!1,nonce:u||null}})}catch(o){console.error("Failed to store authorization code:",o);let e=o instanceof Error?o.message:String(o);throw new d.iF("Database error while storing authorization code.",{originalError:e})}}async function h(e,o,i,r){let a=null;try{if(!(a=await t.prisma.authorizationCode.findUnique({where:{code:e}})))throw new d.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(a.isUsed)throw await t.prisma.authorizationCode.delete({where:{id:a.id}}),new d.jz("Invalid authorization code: Code has already been used.",{code:e},"AUTH_CODE_USED");if(a.expiresAt<new Date)throw await t.prisma.authorizationCode.delete({where:{id:a.id}}),new d.BX("Invalid authorization code: Code has expired.",{code:e,expiresAt:a.expiresAt});if(a.clientId!==o)throw new d.yI("Invalid authorization code: Client ID mismatch.",{expected:o,actual:a.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(a.redirectUri!==i)throw new d.yI("Invalid authorization code: Redirect URI mismatch.",{expected:i,actual:a.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===a.codeChallengeMethod){if(n().createHash("sha256").update(r).digest("base64url")!==a.codeChallenge)throw new d.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new d.yI(`Unsupported code challenge method in stored code: ${a.codeChallengeMethod}. Only 'S256' is supported.`,{storedMethod:a.codeChallengeMethod},"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await t.prisma.authorizationCode.update({where:{id:a.id},data:{isUsed:!0}})}catch(o){if(o instanceof d.Cf)throw o;console.error("Error during authorization code validation:",o);let e=o instanceof Error?o.message:String(o);if(o instanceof s.Prisma.PrismaClientKnownRequestError)throw new d.iF(`Database error during authorization code validation: ${e}`,{originalError:e,code:o.code});throw new d.iF("Database error during authorization code validation.",{originalError:e})}}}};