"use strict";exports.id=154,exports.ids=[154],exports.modules={746:(e,t,s)=>{class i{static{this.store=new Map}static{this.cleanupInterval=null}static startCleanupTimer(){this.cleanupInterval||(this.cleanupInterval=setInterval(()=>{let e=Date.now(),t=[];for(let[s,i]of this.store.entries())e-i.lastRequest>864e5&&t.push(s);t.forEach(e=>this.store.delete(e))},3e5))}static stopCleanupTimer(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}static getClientIP(e){let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0];return e?e.trim():"unknown"}let s=e.headers.get("x-real-ip");if(s)return s;let i=e.headers.get("cf-connecting-ip");return i||"unknown"}static generateKey(e,t){let s,{keyType:i="ip",keyPrefix:r="rate_limit"}=t;switch(i){case"ip":default:s=this.getClientIP(e);break;case"client":let n=e.headers.get("authorization"),a=null;if(n?.includes("client_id=")){let e=n.split("client_id=")[1];e&&(a=e.split(" ")[0]||null)}let o=e.nextUrl.searchParams.get("client_id");s=a||o||this.getClientIP(e);break;case"user":let c=e.headers.get("user-agent")||"unknown";s=`${this.getClientIP(e)}-${c.slice(0,50)}`}return`${r}:${i}:${s}`}static checkRateLimit(e,t){this.startCleanupTimer();let s=Date.now(),{maxRequests:i,windowMs:r}=t,n=this.store.get(e);if(!n)return n={count:1,windowStart:s,lastRequest:s},this.store.set(e,n),{allowed:!0,remaining:i-1,resetTime:s+r,limit:i};if(s-n.windowStart>=r)return n.count=1,n.windowStart=s,n.lastRequest=s,{allowed:!0,remaining:i-1,resetTime:s+r,limit:i};if(n.lastRequest=s,n.count>=i){let e=n.windowStart+r,t=e-s;return{allowed:!1,remaining:0,resetTime:e,limit:i,retryAfter:t}}return n.count++,{allowed:!0,remaining:i-n.count,resetTime:n.windowStart+r,limit:i}}static applyRateLimit(e,t){let s=this.generateKey(e,t);return this.checkRateLimit(s,t)}static resetRateLimit(e){this.store.delete(e)}static getRateLimitStatus(e,t){let s=this.store.get(e),i=Date.now();if(!s||i-s.windowStart>=t.windowMs)return{allowed:!0,remaining:t.maxRequests,resetTime:i+t.windowMs,limit:t.maxRequests};let r=s.windowStart+t.windowMs,n=Math.max(0,t.maxRequests-s.count),a=s.count<t.maxRequests;return{allowed:a,remaining:n,resetTime:r,limit:t.maxRequests,retryAfter:a?void 0:r-i}}static clearAll(){this.store.clear()}static getRecordCount(){return this.store.size}}},18354:(e,t,s)=>{s.d(t,{n:()=>n});var i=s(43258),r=s(65776);class n{constructor(e){this.prisma=e,this.cache=r.yk.getCache(),i.A.info("PermissionService initialized with cache manager")}async getUserEffectivePermissions(e){let t=`user:${e}:permissions`;try{let s=await this.cache.get(t);if(s)return i.A.debug(`[Cache HIT] Permissions for user ${e}`),new Set(s)}catch(e){i.A.error("Error reading from cache:",e)}i.A.debug(`[DB Fetch] Fetching permissions from DB for user ${e}`);let s=await this.prisma.user.findUnique({where:{id:e,isActive:!0},include:{userRoles:{where:{role:{isActive:!0},OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},include:{role:{include:{rolePermissions:{where:{permission:{isActive:!0}},include:{permission:!0}}}}}}}});if(!s){let s=new Set;return await this.cache.set(t,[],900),i.A.debug(`[Cache SET] Empty permissions for user ${e} stored in cache.`),s}let r=new Set;s.userRoles.forEach(e=>{e.role&&e.role.isActive&&(e.expiresAt&&e.expiresAt.getTime()<=Date.now()||e.role.rolePermissions.forEach(e=>{e.permission&&e.permission.isActive&&e.permission.name&&r.add(e.permission.name)}))});let n=Array.from(r);return await this.cache.set(t,n,900),i.A.debug(`[Cache SET] Permissions for user ${e} stored in cache.`),r}async clearUserPermissionCache(e){let t=`user:${e}:permissions`;try{await this.cache.del(t),i.A.info(`[Cache Cleared] Permissions for user ${e}`)}catch(e){i.A.error(`[PermissionService] Cache DEL error for key ${t}:`,e)}}async clearCachesAffectedByRoleChange(e){i.A.info(`[Cache Invalidation] Role ${e} changed. Clearing all user permission caches.`);try{await this.cache.clear(),i.A.debug("[Cache] All user permission caches cleared due to role change.")}catch(e){i.A.error("[PermissionService] Error clearing caches after role change:",e)}}async checkPermission(e,t){return!!t&&(await this.getUserEffectivePermissions(e)).has(t)}async checkBatchPermissions(e,t){if(!t||0===t.length)return[];let s=await this.getUserEffectivePermissions(e),i=[];for(let e of t){if(!e.name){i.push({id:e.id,allowed:!1,reasonCode:"INVALID_REQUEST_FORMAT",message:"Request missing canonical permission name."});continue}let t=s.has(e.name),r="",n="PERMISSION_DENIED";t?(r="Operation allowed.",n="PERMISSION_GRANTED"):0===s.size?(r="User has no effective permissions.",n="NO_PERMISSIONS"):(r=`Permission '${e.name}' denied or not found in user's effective permissions.`,n="PERMISSION_DENIED"),i.push({id:e.id,allowed:t,reasonCode:n,message:r})}return i}}s(83125)},43258:(e,t,s)=>{s.d(t,{A:()=>f});var i=s(19668),r=s.n(i);s(36344);var n=s(33873),a=s.n(n),o=s(29021),c=s.n(o);let l=a().join(process.cwd(),"logs");c().existsSync(l)||c().mkdirSync(l,{recursive:!0});let d=r().format.combine(r().format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),r().format.printf(({timestamp:e,level:t,message:s})=>`${e} [${t.toUpperCase()}]: ${s}`)),u=r().format.combine(r().format.timestamp({format:"YYYY-MM-DD HH:mm:ss.SSS"}),r().format.colorize({all:!0}),r().format.printf(({timestamp:e,level:t,message:s})=>{let i=t.padEnd(15);return`ğŸ•’ ${e} | ${i} | ${s}`})),h=new(r()).transports.DailyRotateFile({filename:a().join(l,"%DATE%.log"),datePattern:"YYYY-MM-DD",maxSize:"20m",maxFiles:"14d",format:d}),m=new(r()).transports.Console({format:u}),f=r().createLogger({level:"info",transports:[m,h]})},65776:(e,t,s)=>{s.d(t,{yk:()=>d});var i=s(84448),r=s.n(i),n=s(57265),a=s(43258);class o{constructor(e){this.client=e}async get(e){try{let t=await this.client.get(e);return t?JSON.parse(t):null}catch(e){return a.A.error("Redis get error:",e),null}}async set(e,t,s){try{let i=JSON.stringify(t);s?await this.client.setex(e,s,i):await this.client.set(e,i)}catch(e){a.A.error("Redis set error:",e)}}async del(e){try{await this.client.del(e)}catch(e){a.A.error("Redis del error:",e)}}async clear(){try{await this.client.flushdb()}catch(e){a.A.error("Redis clear error:",e)}}async exists(e){try{let t=await this.client.exists(e);return 1===t}catch(e){return a.A.error("Redis exists error:",e),!1}}}class c{constructor(e){this.cache=new n.q({max:e.max,ttl:e.ttl?1e3*e.ttl:void 0})}async get(e){return this.cache.get(e)||null}async set(e,t,s){s?this.cache.set(e,t,{ttl:1e3*s}):this.cache.set(e,t)}async del(e){this.cache.delete(e)}async clear(){this.cache.clear()}async exists(e){return this.cache.has(e)}}class l{constructor(){this.initializeCache()}static getInstance(){return l.instance||(l.instance=new l),l.instance}initializeCache(){let e=process.env.REDIS_URL;if(e)try{this.redisClient=new(r())(e,{maxRetriesPerRequest:3,lazyConnect:!0}),this.redisClient.on("error",e=>{a.A.error("Redis connection error:",e),this.fallbackToLRU()}),this.redisClient.on("connect",()=>{a.A.info("Redis connected successfully")}),this.cache=new o(this.redisClient),a.A.info("Cache initialized with Redis")}catch(e){a.A.error("Failed to initialize Redis, falling back to LRU cache:",e),this.fallbackToLRU()}else this.fallbackToLRU()}fallbackToLRU(){this.cache=new c({max:1e3,ttl:3600}),a.A.info("Cache initialized with LRU cache")}getCache(){return this.cache}getRedisClient(){return this.redisClient}isUsingRedis(){return void 0!==this.redisClient}async close(){this.redisClient&&await this.redisClient.quit()}}let d=l.getInstance();d.getCache()},84327:(e,t,s)=>{s.d(t,{B9:()=>r,Uj:()=>i.Uj}),s(43258);var i=s(60123);function r(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}s(93049),s(746)},91154:(e,t,s)=>{s.d(t,{authenticateBearer:()=>c,ru:()=>l});var i=s(57642),r=s(38089),n=s(16654),a=s(13941),o=s(24958);async function c(e,t={}){let s,l=e.headers.get("authorization");if(!l||!l.startsWith("Bearer "))return t.allowPublicAccess?{success:!0}:{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:"Missing or invalid authorization header"},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let d=l.substring(7);try{let e=process.env.JWKS_URI;if(!e)throw console.error("JWKS_URI ç¯å¢ƒå˜é‡æœªè®¾ç½® (JWKS_URI environment variable is not set)"),Error("JWKS_URI not configured, cannot validate token.");let t=r.RD(new URL(e)),i=process.env.JWT_ISSUER,a=process.env.JWT_AUDIENCE;if(!i||!a)throw console.error("JWT_ISSUER æˆ– JWT_AUDIENCE ç¯å¢ƒå˜é‡æœªè®¾ç½® (JWT_ISSUER or JWT_AUDIENCE environment variable is not set)"),Error("JWT issuer or audience not configured, cannot validate token.");s=(await n.V(d,t,{issuer:i,audience:a,algorithms:["RS256"]})).payload}catch(t){console.error("JWT éªŒè¯å¤±è´¥ (JWT validation failed):",t);let e="Token validation failed";return t instanceof a.n?e=`Token expired at ${new Date(1e3*t.payload.exp).toISOString()}`:t instanceof a.ie?e=`Token claim validation failed: ${t.claim} ${t.reason}`:t instanceof a.T0||t instanceof a._L?e="Invalid token algorithm or key issue.":t instanceof Error&&(t.message.includes("JWKS")||t.message.includes("configured"))&&(e=`Token validation setup error: ${t.message}`),{success:!1,response:i.NextResponse.json({error:"invalid_token",error_description:e},{status:401,headers:{"WWW-Authenticate":'Bearer realm="API"'}})}}let u=s.sub,h=s.client_id,m=s.scope?.split(" ")||[],f=s.permissions||[];if(t.requiredScopes&&t.requiredScopes.length>0&&!t.requiredScopes.every(e=>m.includes(e)))return{success:!1,response:i.NextResponse.json({error:"insufficient_scope",error_description:`Required scope(s): ${t.requiredScopes.join(", ")}`},{status:403,headers:{"WWW-Authenticate":`Bearer realm="API", scope="${t.requiredScopes.join(" ")}"`}})};if(t.requiredPermissions&&t.requiredPermissions.length>0&&!t.requiredPermissions.every(e=>f.includes(e)))return{success:!1,response:i.NextResponse.json({error:"insufficient_permissions",error_description:`Required permission(s): ${t.requiredPermissions.join(", ")}`},{status:403,headers:{"WWW-Authenticate":'Bearer realm="API"'}})};let p={user_id:u,client_id:h,scopes:m,permissions:f,tokenPayload:s};if(t.requireUserContext&&u)try{let e=await o.z.user.findUnique({where:{id:u,isActive:!0},select:{id:!0,username:!0,firstName:!0,lastName:!0,avatar:!0}});e&&(p.user={id:e.id,username:e.username||void 0,firstName:e.firstName||void 0,lastName:e.lastName||void 0,avatar:e.avatar||void 0})}catch(e){console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ (Failed to fetch user information):",e)}return{success:!0,context:p}}function l(e,t={}){return async function(s){let r=await c(s,t);return r.success?r.context?e(s,r.context):i.NextResponse.json({error:"authentication_failed",error_description:"Authentication context missing"},{status:500}):r.response||i.NextResponse.json({error:"authentication_failed",error_description:"Authentication failed"},{status:401})}}new(s(18354)).n(o.z);let d={allowedOrigins:["*"],allowedMethods:["GET","POST","PUT","DELETE","OPTIONS","PATCH"],allowedHeaders:["Content-Type","Authorization","X-Requested-With","Accept","Origin","Access-Control-Request-Method","Access-Control-Request-Headers"],allowCredentials:!0,maxAge:86400};function u(e,t){return!!e&&(!!(t.includes("*")||t.includes(e))||t.some(t=>{if(t.includes("*")){let s=t.replace(/\*/g,".*");return RegExp(`^${s}$`).test(e)}return!1}))}function h(e,t,s){let i=t.headers.get("origin");return i&&u(i,s.allowedOrigins||d.allowedOrigins)&&e.headers.set("Access-Control-Allow-Origin",i),e.headers.set("Access-Control-Allow-Methods",(s.allowedMethods||d.allowedMethods).join(", ")),e.headers.set("Access-Control-Allow-Headers",(s.allowedHeaders||d.allowedHeaders).join(", ")),s.allowCredentials&&e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Expose-Headers","Content-Length, Content-Type"),e}s(84327);let m={maxRequests:100,windowMs:9e5,keyType:"ip",message:"è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯• (Too many requests, please try again later)",includeHeaders:!0};function f(e){let t=e.headers.get("x-forwarded-for"),s=e.headers.get("x-real-ip"),i=e.headers.get("cf-connecting-ip");return t?t.split(",")[0]?.trim()||"127.0.0.1":s||i||"127.0.0.1"}function p(e,t,s,i){if(e.headers.set("X-RateLimit-Limit",t.toString()),e.headers.set("X-RateLimit-Remaining",Math.max(0,s).toString()),e.headers.set("X-RateLimit-Reset",i.toString()),s<=0){let t=Math.ceil((i-Date.now())/1e3);e.headers.set("Retry-After",t.toString())}return e}s(44325)},93049:(e,t,s)=>{s(43258)}};