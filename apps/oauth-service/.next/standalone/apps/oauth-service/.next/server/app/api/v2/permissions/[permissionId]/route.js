(()=>{var e={};e.id=996,e.ids=[996],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},4997:e=>{function s(e){var s=Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}s.keys=()=>[],s.resolve=s,s.id=4997,e.exports=s},5486:e=>{"use strict";e.exports=require("bcrypt")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},24958:(e,s,t)=>{"use strict";t.d(s,{z:()=>i});var r=t(96330);let i=globalThis.prisma??new r.PrismaClient},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34621:(e,s,t)=>{"use strict";t.d(s,{prisma:()=>r.z}),t(96330);var r=t(24958),i=t(50488),o=t.n(i),n=t(5433);o().config();let a={host:process.env.MYSQL_HOST||"localhost",port:parseInt(process.env.MYSQL_PORT||"3306",10),user:process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"mydb",waitForConnections:!0,connectionLimit:10,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0,charset:"utf8mb4"},u=globalThis.mysqlPool||(console.log("正在初始化 MySQL 连接池...",{host:a.host,port:a.port,user:a.user,database:a.database}),n.createPool(a));async function d(){if(u&&!globalThis.isClosingPool)try{globalThis.isClosingPool=!0,console.log("正在关闭 MySQL 连接池..."),await u.end(),console.log("MySQL 连接池已成功关闭")}catch(e){throw console.error("关闭 MySQL 连接池时发生错误",e),globalThis.isClosingPool=!1,e}else globalThis.isClosingPool&&console.log("MySQL 连接池已经在关闭过程中，跳过重复关闭")}void 0===globalThis.isClosingPool&&(globalThis.isClosingPool=!1),process.on("SIGINT",async()=>{console.log("接收到 SIGINT 信号，准备关闭 MySQL 连接池"),await d(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("接收到 SIGTERM 信号，准备关闭 MySQL 连接池"),await d(),process.exit(0)}),process.on("uncaughtException",async e=>{console.error("未捕获的异常",e),await d(),process.exit(1)})},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},38738:(e,s,t)=>{"use strict";t.d(s,{B9:()=>r.B9,Uj:()=>r.Uj}),t(44325),t(18354);var r=t(84327);t(43281),t(55807),t(34621)},41204:e=>{"use strict";e.exports=require("string_decoder")},44708:e=>{"use strict";e.exports=require("node:https")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},62620:(e,s,t)=>{"use strict";t.r(s),t.d(s,{patchFetch:()=>D,routeModule:()=>w,serverHooks:()=>_,workAsyncStorage:()=>A,workUnitAsyncStorage:()=>R});var r={};t.r(r),t.d(r,{DELETE:()=>v,GET:()=>x,PUT:()=>S});var i=t(19227),o=t(39044),n=t(11131),a=t(57642),u=t(34621),d=t(96330),p=t(43281),l=t(38738),c=t(44325),m=t(67200);let g=m.z.object({httpMethod:m.z.nativeEnum(d.HttpMethod).optional(),endpoint:m.z.string().startsWith("/","API端点路径必须以'/'开头 (Endpoint path must start with '/')").optional(),rateLimit:m.z.number().int().positive().optional().nullable()}),I=m.z.object({menuId:m.z.string().cuid("无效的菜单ID格式 (Invalid Menu ID format: must be a CUID)").optional()}),P=m.z.object({tableName:m.z.string().min(1,"表名不能为空 (Table name cannot be empty)").optional(),columnName:m.z.string().optional().nullable(),conditions:m.z.string().optional().nullable()}),E=m.z.object({displayName:m.z.string().min(1,"显示名称不能为空 (Display name cannot be empty)").max(150,"显示名称长度不能超过150字符").optional(),description:m.z.string().max(255,"描述信息长度不能超过255字符").optional().nullable(),resource:m.z.string().min(1,"资源标识不能为空 (Resource identifier cannot be empty)").max(200,"资源标识长度不能超过200字符").optional(),action:m.z.string().min(1,"操作不能为空 (Action cannot be empty)").max(50,"操作名称长度不能超过50字符").optional(),isActive:m.z.boolean().optional(),apiDetails:g.optional(),menuDetails:I.optional(),dataDetails:P.optional()});async function f(e,{authContext:s,params:t}){let{permissionId:r}=t,i=s.user_id,o=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,n=e.headers.get("user-agent")||void 0;try{let e=await u.prisma.permission.findUnique({where:{id:r},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});if(!e)return await c.PC.logAuditEvent({userId:i,action:"PERMISSION_READ_FAILURE_NOT_FOUND",resource:`Permission:${r}`,ipAddress:o,userAgent:n,success:!1,errorMessage:"Permission definition not found.",metadata:{permissionId:r}}),a.NextResponse.json({message:"权限定义未找到 (Permission definition not found)"},{status:404});return await c.PC.logAuditEvent({userId:i,action:"PERMISSION_READ_SUCCESS",resource:`Permission:${r}`,ipAddress:o,userAgent:n,success:!0,metadata:{permissionId:r,permissionName:e.name,permissionType:e.type}}),a.NextResponse.json(e)}catch(e){return console.error(`获取权限 ${r} 详情失败 (Failed to fetch permission details for ID ${r}):`,e),await c.PC.logAuditEvent({userId:i,action:"PERMISSION_READ_FAILURE_DB_ERROR",resource:`Permission:${r}`,ipAddress:o,userAgent:n,success:!1,errorMessage:`Failed to fetch permission details for ID ${r}.`,metadata:{permissionId:r,error:e.message}}),a.NextResponse.json({message:"获取权限定义详情时发生错误 (An error occurred while retrieving permission definition details)"},{status:500})}}async function h(e,{authContext:s,params:t}){let r,{permissionId:i}=t,o=s.user_id,n=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,p=e.headers.get("user-agent")||void 0;try{r=await e.json()}catch(e){return await c.PC.logAuditEvent({userId:o,action:"PERMISSION_UPDATE_FAILURE_INVALID_JSON",resource:`Permission:${i}`,success:!1,ipAddress:n,userAgent:p,errorMessage:"Invalid JSON request body for permission update.",metadata:{error:e.message}}),a.NextResponse.json({message:"无效的JSON请求体 (Invalid JSON request body)"},{status:400})}let l=E.safeParse(r);if(!l.success)return await c.PC.logAuditEvent({userId:o,action:"PERMISSION_UPDATE_FAILURE_VALIDATION",resource:`Permission:${i}`,success:!1,ipAddress:n,userAgent:p,errorMessage:"Permission update payload validation failed.",metadata:{issues:l.error.format(),receivedBody:r}}),a.NextResponse.json({message:"更新权限的输入数据验证失败 (Permission update input validation failed)",errors:l.error.format()},{status:400});let m=l.data;if(0===Object.keys(m).length)return await c.PC.logAuditEvent({userId:o,action:"PERMISSION_UPDATE_FAILURE_EMPTY_BODY",resource:`Permission:${i}`,success:!1,ipAddress:n,userAgent:p,errorMessage:"Request body empty for permission update."}),a.NextResponse.json({message:"请求体中至少需要一个待更新的字段 (At least one field to update is required in the request body)"},{status:400});try{let e=await u.prisma.permission.findUnique({where:{id:i}});if(!e)return await c.PC.logAuditEvent({userId:o,action:"PERMISSION_UPDATE_FAILURE_NOT_FOUND",resource:`Permission:${i}`,success:!1,ipAddress:n,userAgent:p,errorMessage:"Permission definition not found to update."}),a.NextResponse.json({message:"权限定义未找到，无法更新 (Permission definition not found, cannot update)"},{status:404});if(m.name||m.type)return await c.PC.logAuditEvent({userId:o,action:"PERMISSION_UPDATE_FAILURE_IMMUTABLE_FIELDS",resource:`Permission:${i}`,success:!1,ipAddress:n,userAgent:p,errorMessage:"Attempted to modify immutable fields (name or type) of a permission.",metadata:{attemptedName:m.name,attemptedType:m.type,currentName:e.name,currentType:e.type}}),a.NextResponse.json({message:'权限的 "name" (名称) 和 "type" (类型) 字段不可修改 (The "name" and "type" fields of a permission cannot be changed)'},{status:400});let s=await u.prisma.$transaction(async s=>{let t={};void 0!==m.displayName&&(t.displayName=m.displayName),void 0!==m.description&&(t.description=m.description),void 0!==m.resource&&(t.resource=m.resource),void 0!==m.action&&(t.action=m.action),void 0!==m.isActive&&(t.isActive=m.isActive);let r=e;if(Object.keys(t).length>0&&(r=await s.permission.update({where:{id:i},data:t})),e.type===d.PermissionType.API&&m.apiDetails)await s.apiPermission.update({where:{permissionId:i},data:m.apiDetails});else if(e.type===d.PermissionType.MENU&&m.menuDetails){if(m.menuDetails.menuId){let e=await s.menu.count({where:{id:m.menuDetails.menuId}});if(0===e)throw Error(`关联的菜单ID "${m.menuDetails.menuId}" 无效或不存在 (The associated Menu ID "${m.menuDetails.menuId}" is invalid or does not exist)`)}await s.menuPermission.update({where:{permissionId:i},data:m.menuDetails})}else e.type===d.PermissionType.DATA&&m.dataDetails&&await s.dataPermission.update({where:{permissionId:i},data:m.dataDetails});return r}),t=await u.prisma.permission.findUnique({where:{id:s.id},include:{apiPermission:!0,menuPermission:{include:{menu:!0}},dataPermission:!0}});return await c.PC.logAuditEvent({userId:o,action:"PERMISSION_UPDATE_SUCCESS",resource:`Permission:${i}`,success:!0,ipAddress:n,userAgent:p,metadata:{permissionId:i,updatedFields:Object.keys(m),originalName:e.name}}),a.NextResponse.json(t)}catch(r){console.error(`更新权限 ${i} 失败 (Failed to update permission ID ${i}):`,r);let e="An error occurred while updating permission definition",s="PERMISSION_UPDATE_FAILURE_DB_ERROR",t=500;return r.message.includes("菜单ID")&&(e=r.message,s="PERMISSION_UPDATE_FAILURE_INVALID_MENU_ID",t=400),await c.PC.logAuditEvent({userId:o,action:s,success:!1,ipAddress:n,userAgent:p,errorMessage:e,metadata:{error:r.message,errorCode:r.code,attemptedUpdateData:m}}),a.NextResponse.json({message:e},{status:t})}}async function y(e,{authContext:s,params:t}){let{permissionId:r}=t,i=s.user_id,o=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||void 0,n=e.headers.get("user-agent")||void 0;try{let e=await u.prisma.permission.findUnique({where:{id:r},include:{rolePermissions:!0}});if(!e)return await c.PC.logAuditEvent({userId:i,action:"PERMISSION_DELETE_FAILURE_NOT_FOUND",resource:`Permission:${r}`,success:!1,ipAddress:o,userAgent:n,errorMessage:"Permission definition not found to delete."}),a.NextResponse.json({message:"权限定义未找到 (Permission definition not found)"},{status:404});let s=e.rolePermissions.length;if(s>0)return await c.PC.logAuditEvent({userId:i,action:"PERMISSION_DELETE_FAILURE_IN_USE",resource:`Permission:${r}`,success:!1,ipAddress:o,userAgent:n,errorMessage:`Permission "${e.name}" is still in use by ${s} roles.`,metadata:{permissionName:e.name,rolesCount:s}}),a.NextResponse.json({message:`此权限仍被 ${s} 个角色使用，无法删除 (This permission is still in use by ${s} roles and cannot be deleted)`},{status:409});return await u.prisma.$transaction(async s=>{e.type===d.PermissionType.API?await s.apiPermission.delete({where:{permissionId:r}}):e.type===d.PermissionType.MENU?await s.menuPermission.delete({where:{permissionId:r}}):e.type===d.PermissionType.DATA&&await s.dataPermission.delete({where:{permissionId:r}}),await s.permission.delete({where:{id:r}})}),await c.PC.logAuditEvent({userId:i,action:"PERMISSION_DELETE_SUCCESS",resource:`Permission:${r}`,success:!0,ipAddress:o,userAgent:n,metadata:{deletedPermissionName:e.name}}),new a.NextResponse(null,{status:204})}catch(u){console.error(`删除权限 ${r} 失败 (Failed to delete permission ID ${r}):`,u);let e="An error occurred while deleting permission definition",s="PERMISSION_DELETE_FAILURE_DB_ERROR",t=500;return u instanceof d.Prisma.PrismaClientKnownRequestError&&"P2003"===u.code&&(e="Cannot delete permission as it might still be referenced by other system records",s="PERMISSION_DELETE_FAILURE_FOREIGN_KEY",t=409),await c.PC.logAuditEvent({userId:i,action:s,success:!1,ipAddress:o,userAgent:n,errorMessage:e,metadata:{error:u.message,permissionId:r}}),a.NextResponse.json({message:e},{status:t})}}let x=(0,l.Uj)((0,p.ru)(f,{requiredPermissions:["permission:read"]})),S=(0,l.Uj)((0,p.ru)(h,{requiredPermissions:["permission:update"]})),v=(0,l.Uj)((0,p.ru)(y,{requiredPermissions:["permission:delete"]})),w=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v2/permissions/[permissionId]/route",pathname:"/api/v2/permissions/[permissionId]",filename:"route",bundlePath:"app/api/v2/permissions/[permissionId]/route"},resolvedPagePath:"/Users/liushuo/code/ts-next-template/apps/oauth-service/app/api/v2/permissions/[permissionId]/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:A,workUnitAsyncStorage:R,serverHooks:_}=w;function D(){return(0,n.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:R})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},90483:(e,s,t)=>{"use strict";t.d(s,{A:()=>u});var r=t(55511);let i={randomUUID:r.randomUUID},o=new Uint8Array(256),n=o.length,a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));let u=function(e,s,t){if(i.randomUUID&&!s&&!e)return i.randomUUID();let u=(e=e||{}).random??e.rng?.()??(n>o.length-16&&((0,r.randomFillSync)(o),n=0),o.slice(n,n+=16));if(u.length<16)throw Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,s){if((t=t||0)<0||t+16>s.length)throw RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)s[t+e]=u[e];return s}return function(e,s=0){return(a[e[s+0]]+a[e[s+1]]+a[e[s+2]]+a[e[s+3]]+"-"+a[e[s+4]]+a[e[s+5]]+"-"+a[e[s+6]]+a[e[s+7]]+"-"+a[e[s+8]]+a[e[s+9]]+"-"+a[e[s+10]]+a[e[s+11]]+a[e[s+12]]+a[e[s+13]]+a[e[s+14]]+a[e[s+15]]).toLowerCase()}(u)}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var s=require("../../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[938,176,733,200,344,706,855,281],()=>t(62620));module.exports=r})();