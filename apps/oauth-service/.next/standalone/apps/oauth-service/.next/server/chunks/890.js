"use strict";exports.id=890,exports.ids=[509,890],exports.modules={15547:(e,o,t)=>{t.d(o,{_P:()=>r,s0:()=>i});let i=36e5,r=Symbol.for("constructDateFrom")},47625:(e,o,t)=>{t.d(o,{a:()=>r});var i=t(47923);function r(e,o){return(0,i.w)(o||e,e)}},47923:(e,o,t)=>{t.d(o,{w:()=>r});var i=t(15547);function r(e,o){return"function"==typeof e?e(o):e&&"object"==typeof e&&i._P in e?e[i._P](o):e instanceof Date?new e.constructor(o):new Date(o)}},49039:(e,o,t)=>{t.d(o,{A:()=>a});var i=t(47923),r=t(47625);function a(e,o,t){return(0,i.w)(t?.in||e,+(0,r.a)(e)+o)}},71890:(e,o,t)=>{t.d(o,{storeAuthorizationCode:()=>s,validateAuthorizationCode:()=>h});var i=t(34621),r=t(49039),a=t(55511),n=t.n(a),d=t(55807),c=t(96330);async function s(e,o,t,a,c,h,l=600,u){var w;if("S256"!==c)throw new d.yI(`Unsupported code challenge method: ${c}. Only 'S256' is supported.`,{codeChallengeMethod:c},"UNSUPPORTED_CHALLENGE_METHOD");let C=function(e=32){return n().randomBytes(e).toString("hex")}(32),f=(w=new Date,(0,r.A)(w,1e3*l,void 0));try{return await i.prisma.authorizationCode.create({data:{code:C,userId:e,clientId:o,redirectUri:t,scope:h,codeChallenge:a,codeChallengeMethod:c,expiresAt:f,isUsed:!1,nonce:u||null}})}catch(o){console.error("Failed to store authorization code:",o);let e=o instanceof Error?o.message:String(o);throw new d.iF("Database error while storing authorization code.",{originalError:e})}}async function h(e,o,t,r){let a=null;try{if(!(a=await i.prisma.authorizationCode.findUnique({where:{code:e}})))throw new d.CE("Invalid authorization code: Code not found.","AUTH_CODE_NOT_FOUND");if(a.isUsed)throw await i.prisma.authorizationCode.delete({where:{id:a.id}}),new d.jz("Invalid authorization code: Code has already been used.",{code:e},"AUTH_CODE_USED");if(a.expiresAt<new Date)throw await i.prisma.authorizationCode.delete({where:{id:a.id}}),new d.BX("Invalid authorization code: Code has expired.",{code:e,expiresAt:a.expiresAt});if(a.clientId!==o)throw new d.yI("Invalid authorization code: Client ID mismatch.",{expected:o,actual:a.clientId},"AUTH_CODE_CLIENT_ID_MISMATCH");if(a.redirectUri!==t)throw new d.yI("Invalid authorization code: Redirect URI mismatch.",{expected:t,actual:a.redirectUri},"AUTH_CODE_REDIRECT_URI_MISMATCH");if("S256"===a.codeChallengeMethod){if(n().createHash("sha256").update(r).digest("base64url")!==a.codeChallenge)throw new d.v3("Invalid authorization code: PKCE verification failed.",void 0,"PKCE_VERIFICATION_FAILED")}else throw new d.yI(`Unsupported code challenge method in stored code: ${a.codeChallengeMethod}. Only 'S256' is supported.`,{storedMethod:a.codeChallengeMethod},"UNSUPPORTED_STORED_CHALLENGE_METHOD");return await i.prisma.authorizationCode.update({where:{id:a.id},data:{isUsed:!0}})}catch(o){if(o instanceof d.Cf)throw o;console.error("Error during authorization code validation:",o);let e=o instanceof Error?o.message:String(o);if(o instanceof c.Prisma.PrismaClientKnownRequestError)throw new d.iF(`Database error during authorization code validation: ${e}`,{originalError:e,code:o.code});throw new d.iF("Database error during authorization code validation.",{originalError:e})}}}};