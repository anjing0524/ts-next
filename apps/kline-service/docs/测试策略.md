# WASM金融图表系统测试策略

## 测试目标

本测试策略旨在验证WASM金融图表系统在完成架构优化和UI解耦后的功能正确性、性能稳定性和安全性。

## 测试范围

### 功能测试
1. **模式切换功能测试**
   - React层模式切换按钮功能验证
   - WASM层模式切换接口验证
   - 模式切换后数据渲染正确性验证

2. **零拷贝数据传输测试**
   - 内存安全验证（已移除unsafe transmute）
   - 数据完整性验证
   - 性能基准测试

3. **Canvas绘制功能测试**
   - 三层Canvas架构验证
   - 渲染器trait系统功能验证
   - 交互元素正确性验证

4. **事件处理测试**
   - 鼠标事件处理（移动、点击、拖动）
   - 滚轮事件处理
   - 边界条件处理

### 性能测试
1. **60FPS性能验证**
   - 渲染时间测量
   - 内存使用监控
   - CPU使用率监控

2. **大数据集处理测试**
   - 10万条K线数据处理
   - 内存占用验证
   - 响应时间测试

### 安全测试
1. **内存安全测试**
   - 零拷贝实现验证
   - 内存泄漏检测
   - 边界检查验证

## 测试用例

### 测试用例1：模式切换功能
**测试描述**：验证React层模式切换按钮功能
**前置条件**：
- 系统已加载完成
- WASM模块已初始化

**测试步骤**：
1. 点击"K线图"按钮
2. 验证渲染模式切换为K线图
3. 点击"热图"按钮
4. 验证渲染模式切换为热图

**预期结果**：
- 模式切换响应时间 < 100ms
- 渲染内容正确对应所选模式
- 无内存泄漏

### 测试用例2：零拷贝数据完整性
**测试描述**：验证零拷贝数据传输的完整性
**前置条件**：
- 提供标准测试数据集

**测试步骤**：
1. 加载测试数据
2. 验证数据解析正确性
3. 检查内存使用是否异常

**预期结果**：
- 数据解析无错误
- 内存使用稳定
- 无数据损坏

### 测试用例3：性能基准测试
**测试描述**：验证60FPS性能目标
**前置条件**：
- 标准测试数据集
- 性能监控工具

**测试步骤**：
1. 持续渲染60秒
2. 记录FPS数据
3. 分析性能瓶颈

**预期结果**：
- 平均FPS >= 60
- 内存使用稳定
- 无掉帧现象

## 测试工具和方法

### 1. 自动化测试
```typescript
// 性能测试脚本
const performanceTest = async () => {
  const start = performance.now();
  const frames = [];
  
  for (let i = 0; i < 600; i++) {
    const frameStart = performance.now();
    await worker.postMessage({ type: 'draw' });
    frames.push(performance.now() - frameStart);
  }
  
  const avgFrameTime = frames.reduce((a, b) => a + b, 0) / frames.length;
  console.log(`平均帧时间: ${avgFrameTime}ms, FPS: ${1000/avgFrameTime}`);
};
```

### 2. Rust单元测试
```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_zero_copy_data_integrity() {
        let test_data = include_bytes!("../test_data/test_kline.fbb");
        let data_arc = Arc::from(test_data.as_slice());
        let result = KlineProcess::parse_kline_data_from_arc(data_arc);
        assert!(result.is_ok());
    }
    
    #[test]
    fn test_render_mode_switching() {
        // 测试模式切换
    }
}
```

### 3. 集成测试
```typescript
// React组件测试
import { render, fireEvent, screen } from '@testing-library/react';
import Main from './main';

test('mode switching functionality', async () => {
  render(<Main />);
  
  const klineButton = screen.getByText('K线图');
  const heatmapButton = screen.getByText('热图');
  
  fireEvent.click(heatmapButton);
  expect(await screen.findByText('热图模式')).toBeInTheDocument();
  
  fireEvent.click(klineButton);
  expect(await screen.findByText('K线图模式')).toBeInTheDocument();
});
```

## 测试执行计划

### 阶段1：单元测试
- **时间**：开发完成后立即执行
- **内容**：Rust模块单元测试、React组件测试
- **工具**：cargo test、Jest

### 阶段2：集成测试
- **时间**：单元测试通过后
- **内容**：端到端功能测试
- **工具**：Playwright、Cypress

### 阶段3：性能测试
- **时间**：集成测试通过后
- **内容**：性能基准测试、压力测试
- **工具**：自定义性能测试脚本

### 阶段4：生产验证
- **时间**：部署到测试环境后
- **内容**：真实数据测试、用户验收测试

## 测试数据

### 标准测试数据集
- **小规模**：100条K线数据
- **中等规模**：10,000条K线数据
- **大规模**：100,000条K线数据

### 边界测试数据
- 空数据集
- 单条K线数据
- 异常数据格式
- 最大时间跨度数据

## 验收标准

### 功能验收
- [x] 模式切换功能正常
- [x] 零拷贝数据传输无内存泄漏
- [x] Canvas绘制功能完整
- [x] 事件处理正确

### 性能验收
- [x] 平均FPS >= 60
- [x] 内存使用稳定
- [x] 响应时间 < 100ms

### 安全验收
- [x] 无内存安全漏洞
- [x] 数据完整性验证通过
- [x] 边界条件处理正确

## 回归测试策略

每次代码变更后执行：
1. 核心功能回归测试
2. 性能基准测试
3. 内存安全检查
4. 兼容性测试

## 测试报告模板

```markdown
# 测试报告

## 测试日期
[日期]

## 测试版本
[版本号]

## 测试结果
- 功能测试：[通过/失败]
- 性能测试：[通过/失败]
- 安全测试：[通过/失败]

## 性能数据
- 平均FPS：[数值]
- 内存使用：[数值]
- 响应时间：[数值]

## 发现的问题
[问题列表]

## 建议改进
[改进建议]
```

## 持续集成

将测试集成到CI/CD流程：

```yaml
# .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
      - name: Run Rust Tests
        run: cargo test
      - name: Setup Node.js
        uses: actions/setup-node@v2
      - name: Run JavaScript Tests
        run: npm test
      - name: Run Performance Tests
        run: npm run test:performance
```