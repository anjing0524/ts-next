(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[302],{1815:(e,t,r)=>{Promise.resolve().then(r.bind(r,6171))},6171:(e,t,r)=>{"use strict";r.d(t,{default:()=>o});var a=r(5167),n=r(6343),s=r(2227);function o(){var e;let t,o=s.env.NEXT_PUBLIC_BASE_PATH||"/datamgr_flow",l=(0,n.useRef)(null),c=(0,n.useRef)(null),u=(0,n.useRef)(null),i=(0,n.useRef)(null),m=(0,n.useRef)({lastFrameTime:0,frameCount:0,fps:0}),[d,f]=(0,n.useState)(!0),[p,y]=(0,n.useState)(null),[v,w]=(0,n.useState)("default"),[b,g]=(0,n.useState)(!1),[h,C]=(0,n.useState)(0),x=(0,n.useCallback)(e=>{if(!u.current)return null;let t=u.current.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},[]),k=(0,n.useCallback)(e=>{i.current&&i.current.postMessage(e)},[]),E=(0,n.useCallback)(e=>{let t={initialized:()=>{if(!l.current||!c.current||!u.current){y("Canvas元素未找到"),f(!1);return}let t=l.current.transferControlToOffscreen(),r=c.current.transferControlToOffscreen(),a=u.current.transferControlToOffscreen();[t,r,a].forEach(e=>{e.width=1800,e.height=800}),e.postMessage({type:"draw",canvas:t,mainCanvas:r,overlayCanvas:a},[t,r,a])},drawComplete:()=>{f(!1)},error:e=>{y(e.error),f(!1)},cursorStyle:e=>{w(e.style)},mousedownHandled:e=>{e.handled&&g(!0)},mouseupHandled:e=>{e.isDragEnd&&g(!1)},mouseleaveHandled:e=>{e.needsRedraw&&g(!1)},clickHandled:e=>{e.modeChanged&&console.log("图表模式已切换")},performanceMetrics:e=>{e.renderTime&&console.log("渲染时间: ".concat(e.renderTime,"ms"))}};e.onmessage=e=>{try{let r=t[e.data.type];r?r(e.data):console.warn("未处理的消息类型: ".concat(e.data.type))}catch(e){console.error("Worker消息处理错误:",e),y("Worker消息处理错误: ".concat(e instanceof Error?e.message:"未知错误")),f(!1)}}},[1800,800]),T=(0,n.useCallback)(()=>{let e=performance.now(),t=m.current;t.frameCount++,e-t.lastFrameTime>=1e3&&(t.fps=Math.round(1e3*t.frameCount/(e-t.lastFrameTime)),t.frameCount=0,t.lastFrameTime=e,C(t.fps)),requestAnimationFrame(T)},[]);(0,n.useEffect)(()=>{let e=new AbortController,t=requestAnimationFrame(T),a="";return a="".concat(window.location.origin).concat(o,"/wasm-cal/kline_processor_bg.wasm"),(async()=>{try{let t=await fetch("".concat(o,"/api/kline"),{method:"POST",signal:e.signal,headers:{"Content-Type":"application/octet-stream"}});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));let n=new Worker(r.tu(new URL(r.p+r.u(5),r.b)),{type:void 0});i.current=n,n.onerror=e=>{y("Worker错误: ".concat(e.message)),f(!1)};let s=await t.arrayBuffer();n.postMessage({type:"init",buffer:s,wasmPath:a},[s]),E(n)}catch(r){let{name:e,message:t}=r;"AbortError"!==e&&(y(t),f(!1))}})(),()=>{if(e.abort(),i.current)try{i.current.terminate(),i.current=null}catch(e){console.error("终止Worker时出错:",e)}t&&cancelAnimationFrame(t)}},[E,T,o]);let N=(0,n.useCallback)(e=>{let t=x(e);t&&(k({type:"mousemove",x:t.x,y:t.y}),k({type:"getCursorStyle",x:t.x,y:t.y}))},[x,k]),_=(0,n.useCallback)(()=>{k({type:"mouseleave"})},[k]),j=(0,n.useCallback)((e=e=>{k({type:"wheel",deltaY:e.deltaY,x:e.nativeEvent.offsetX,y:e.nativeEvent.offsetY,isDragging:b})},t=!1,function(){for(var r=arguments.length,a=Array(r),n=0;n<r;n++)a[n]=arguments[n];t||(e(...a),t=!0,setTimeout(()=>t=!1,20))}),[k,b]),M=(0,n.useCallback)(e=>{let t=x(e);t&&k({type:"mousedown",x:t.x,y:t.y})},[x,k]),S=(0,n.useCallback)(e=>{let t=x(e);t&&k({type:"mouseup",x:t.x,y:t.y})},[x,k]),L=(0,n.useCallback)(e=>{let t=x(e);t&&k({type:"mousedrag",x:t.x,y:t.y})},[x,k]),R=(0,n.useCallback)(e=>{let t=x(e);t&&k({type:"click",x:t.x,y:t.y})},[x,k]),W=(0,n.useCallback)(e=>{console.error("K线图渲染错误:",e),y("渲染错误: ".concat(e.message)),f(!1)},[]);return(0,n.useEffect)(()=>{let e=e=>{(e.message.includes("Worker")||e.message.includes("Canvas"))&&(W(Error("全局错误: ".concat(e.message))),e.preventDefault())};return window.addEventListener("error",e),()=>{window.removeEventListener("error",e)}},[W]),(0,n.useEffect)(()=>{let e=()=>{b&&(k({type:"mouseup",x:-1,y:-1}),g(!1))},t=e=>{if(b&&l.current){let t=l.current.getBoundingClientRect(),r=e.clientX-t.left,a=e.clientY-t.top;r>=0&&r<=t.width&&a>=0&&a<=t.height&&k({type:"mousedrag",x:r,y:a})}};return window.addEventListener("mouseup",e),window.addEventListener("mousemove",t),()=>{window.removeEventListener("mouseup",e),window.removeEventListener("mousemove",t)}},[b,k]),(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"K 线图 (Web Worker + OffscreenCanvas)"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:["性能: ",h," FPS"]}),d&&(0,a.jsxs)("div",{className:"p-4 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mr-2"}),"正在加载和处理 K 线数据..."]}),p&&(0,a.jsxs)("div",{className:"p-4 text-red-600",children:["错误: ",p]}),(0,a.jsxs)("div",{className:"relative m-0 border-0 p-0",style:{cursor:v,width:"".concat(1800,"px"),height:"".concat(800,"px")},children:[(0,a.jsx)("canvas",{ref:l,className:"absolute top-0 left-0 m-0 border-0 p-0 z-10"}),(0,a.jsx)("canvas",{ref:c,className:"absolute top-0 left-0 w-full m-0 border-0 p-0 z-20 "}),(0,a.jsx)("canvas",{onMouseMove:b?L:N,onMouseLeave:_,onWheel:j,onMouseDown:M,onMouseUp:S,onClick:R,ref:u,className:"absolute top-0 left-0 w-full m-0 border-0 p-0 z-30 "})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[619,180,358],()=>t(1815)),_N_E=e.O()}]);