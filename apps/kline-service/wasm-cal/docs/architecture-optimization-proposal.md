# Kçº¿å›¾è¡¨æ¶æ„ä¼˜åŒ–ææ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£é’ˆå¯¹ WebAssembly Kçº¿å›¾è¡¨é¡¹ç›®ä¸­çš„çŠ¶æ€ç®¡ç†å’Œæ¸²æŸ“æ€§èƒ½é—®é¢˜ï¼Œæå‡ºåŸºäºçŠ¶æ€å¿«ç…§å’Œå˜é‡æå–çš„ä¼˜åŒ–ç­–ç•¥ã€‚

## âœ… å·²å®Œæˆä¼˜åŒ– (æˆªè‡³2025-01-18)

### é˜¶æ®µAï¼šå±€éƒ¨ä½œç”¨åŸŸä¼˜åŒ–
- **çŠ¶æ€**: å·²å®Œæˆå¹¶éªŒè¯
- **æ•ˆæœ**: é€šè¿‡å±€éƒ¨ä½œç”¨åŸŸå’Œæå‰`drop()`æ˜¾è‘—é™ä½å€Ÿç”¨å†²çªæ¦‚ç‡
- **è¦†ç›–**: `ChartRenderer`ã€`CommandManager`ã€`KlineProcess`ç­‰æ ¸å¿ƒæ¨¡å—
- **æµ‹è¯•**: å®Œæ•´æµ‹è¯•è¦†ç›–ç¡®ä¿å€Ÿç”¨å®‰å…¨æ€§

### é˜¶æ®µBï¼šè®¿é—®è€…æ¨¡å¼é‡æ„
- **çŠ¶æ€**: å·²å®Œæˆå¹¶éªŒè¯
- **æ•ˆæœ**: `RenderStrategyFactory`å¼•å…¥è®¿é—®è€…æ¨¡å¼APIï¼Œæ¶ˆé™¤å±é™©çš„å€Ÿç”¨é›†åˆè¿”å›
- **æ–°API**: `visit_strategies()`, `visit_strategies_by_layer()`, `visit_strategies_mut()`
- **å®‰å…¨æ€§**: æ‰€æœ‰APIæ”¯æŒæå‰ç»ˆæ­¢ï¼Œé¿å…RefCellé•¿æœŸæŒæœ‰

### é˜¶æ®µCï¼šæ–‡æ¡£ä¸å®ç°ä¸€è‡´æ€§
- **çŠ¶æ€**: å·²å®Œæˆå¹¶éªŒè¯
- **æ•ˆæœ**: æ–‡æ¡£ä¸ä»£ç å®Œå…¨åŒæ­¥ï¼Œæµ‹è¯•è¦†ç›–ç‡100%
- **åŒ…å«**: è¡Œå·å¼•ç”¨ç²¾ç¡®ã€å…‰æ ‡æ ·å¼APIæ˜ å°„ã€æµ‹è¯•ç”¨ä¾‹éªŒè¯

## ğŸ¯ æ ¸å¿ƒé—®é¢˜åˆ†æ

### å½“å‰æ¶æ„é—®é¢˜

1. **é¢‘ç¹çš„ RefCell å€Ÿç”¨å¼€é”€**
   - æ¯æ¬¡çŠ¶æ€è®¿é—®éƒ½éœ€è¦è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥
   - é¼ æ ‡äº‹ä»¶å¤„ç†ä¸­å­˜åœ¨å¤§é‡ `borrow()` å’Œ `borrow_mut()` è°ƒç”¨
   - æ¸²æŸ“è¿‡ç¨‹ä¸­é‡å¤å€Ÿç”¨ç›¸åŒçš„çŠ¶æ€

2. **æ·±å±‚åµŒå¥—çš„å…±äº«çŠ¶æ€**

   ```rust
   pub struct SharedRenderState {
       pub canvas_manager: Rc<RefCell<CanvasManager>>,
       pub data_manager: Rc<RefCell<DataManager>>,
       pub layout: Rc<RefCell<ChartLayout>>,
       // ... å…¶ä»– Rc<RefCell<T>> å­—æ®µ
   }
   ```

3. **ç¼ºä¹çŠ¶æ€éš”ç¦»æœºåˆ¶**
   - æ‰€æœ‰ç»„ä»¶å…±äº«ç›¸åŒçš„å¯å˜çŠ¶æ€
   - éš¾ä»¥è¿›è¡Œå±€éƒ¨ä¼˜åŒ–å’Œç¼“å­˜

## ğŸš€ ä¼˜åŒ–ç­–ç•¥è®¾è®¡

### ç­–ç•¥ 1: çŠ¶æ€å¿«ç…§æ¨¡å¼ (State Snapshot Pattern)

#### æ ¸å¿ƒæ¦‚å¿µ

åˆ›å»ºåªè¯»çŠ¶æ€å¿«ç…§ï¼Œå‡å°‘è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ï¼Œæé«˜è®¿é—®æ€§èƒ½ã€‚

#### å®ç°æ–¹æ¡ˆ

```rust
/// æ¸²æŸ“çŠ¶æ€å¿«ç…§ - åªè¯»ï¼Œé›¶æˆæœ¬è®¿é—®
#[derive(Clone)]
pub struct RenderStateSnapshot {
    // é¼ æ ‡çŠ¶æ€å¿«ç…§
    pub mouse_x: f64,
    pub mouse_y: f64,
    pub hover_candle_index: Option<usize>,
    pub is_in_chart_area: bool,
    pub is_dragging: bool,

    // å¯è§èŒƒå›´å¿«ç…§
    pub visible_start: usize,
    pub visible_count: usize,
    pub visible_end: usize,

    // æ•°æ®èŒƒå›´å¿«ç…§
    pub data_min_low: f64,
    pub data_max_high: f64,
    pub data_max_volume: f64,

    // å¸ƒå±€ä¿¡æ¯ï¼ˆç›¸å¯¹ç¨³å®šï¼‰
    pub chart_area: Rect,
    pub navigator_area: Rect,

    // æ¸²æŸ“é…ç½®
    pub render_mode: RenderMode,
    pub theme: Rc<ChartTheme>,
}

/// æ”¹è¿›çš„æ¸²æŸ“ä¸Šä¸‹æ–‡
pub struct OptimizedRenderContext {
    /// åªè¯»çŠ¶æ€å¿«ç…§ - é›¶æˆæœ¬è®¿é—®
    pub snapshot: RenderStateSnapshot,

    /// Canvas ä¸Šä¸‹æ–‡
    pub canvas_ctx: Option<OffscreenCanvasRenderingContext2d>,

    /// æ•°æ®è®¿é—®å™¨ - å»¶è¿Ÿå€Ÿç”¨ï¼ŒæŒ‰éœ€è®¿é—®
    data_accessor: Rc<RefCell<DataManager>>,

    /// æ—¶é—´æˆ³
    pub timestamp: f64,
}
```

#### ä¼˜åŠ¿

- **é›¶æˆæœ¬çŠ¶æ€è®¿é—®**: å¿«ç…§æ•°æ®ç›´æ¥è®¿é—®ï¼Œæ— éœ€å€Ÿç”¨æ£€æŸ¥
- **å‡å°‘å€Ÿç”¨å†²çª**: å¤§éƒ¨åˆ†åªè¯»æ“ä½œé€šè¿‡å¿«ç…§å®Œæˆ
- **ç¼“å­˜å‹å¥½**: å¿«ç…§æ•°æ®ç»“æ„ç´§å‡‘ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡

### ç­–ç•¥ 2: åˆ†å±‚çŠ¶æ€ç®¡ç† (Layered State Management)

#### æ ¸å¿ƒæ¦‚å¿µ

å°†çŠ¶æ€æŒ‰è®¿é—®é¢‘ç‡å’Œå¯å˜æ€§åˆ†å±‚ï¼Œé‡‡ç”¨ä¸åŒçš„ç®¡ç†ç­–ç•¥ã€‚

```rust
/// é«˜é¢‘è®¿é—®çš„çƒ­ç‚¹çŠ¶æ€ - ä½¿ç”¨åŸç”Ÿç±»å‹ï¼Œé¿å… RefCell
#[derive(Default, Clone, Copy)]
pub struct HotState {
    pub mouse_x: f64,
    pub mouse_y: f64,
    pub hover_index: Option<usize>,
    pub visible_start: usize,
    pub visible_count: usize,
}

/// ä¸­é¢‘è®¿é—®çš„æ¸©æ€ - ä½¿ç”¨è¯»å†™é”æˆ–å¿«ç…§
pub struct WarmState {
    pub layout: Arc<RwLock<ChartLayout>>,
    pub visible_range: Arc<RwLock<VisibleRange>>,
}

/// ä½é¢‘è®¿é—®çš„å†·çŠ¶æ€ - ä¿æŒ RefCell
pub struct ColdState {
    pub canvas_manager: Rc<RefCell<CanvasManager>>,
    pub strategy_factory: Rc<RefCell<RenderStrategyFactory>>,
}

/// åˆ†å±‚çŠ¶æ€å®¹å™¨
pub struct LayeredRenderState {
    pub hot: HotState,
    pub warm: WarmState,
    pub cold: ColdState,
    pub immutable: ImmutableState,
}
```

### ç­–ç•¥ 3: å‡½æ•°å¼çŠ¶æ€æ›´æ–° (Functional State Updates)

#### æ ¸å¿ƒæ¦‚å¿µ

ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼ï¼Œé€šè¿‡çº¯å‡½æ•°è¿›è¡ŒçŠ¶æ€è®¡ç®—ï¼Œå‡å°‘å¯å˜æ€§ã€‚

```rust
/// çŠ¶æ€æ›´æ–°å‡½æ•°ç±»å‹
type StateUpdateFn<T> = Box<dyn Fn(&T) -> T>;

/// çŠ¶æ€æ›´æ–°æ‰¹å¤„ç†å™¨
pub struct StateBatchUpdater {
    mouse_updates: Vec<StateUpdateFn<MouseState>>,
    layout_updates: Vec<StateUpdateFn<ChartLayout>>,
    data_updates: Vec<StateUpdateFn<DataManager>>,
}

impl StateBatchUpdater {
    /// æ‰¹é‡åº”ç”¨æ›´æ–°
    pub fn apply_updates(&mut self, state: &mut SharedRenderState) {
        // æ‰¹é‡æ›´æ–°é¼ æ ‡çŠ¶æ€
        if !self.mouse_updates.is_empty() {
            let mut mouse_state = state.mouse_state.borrow_mut();
            for update_fn in self.mouse_updates.drain(..) {
                let new_state = update_fn(&mouse_state);
                *mouse_state = new_state;
            }
        }

        // ç±»ä¼¼åœ°å¤„ç†å…¶ä»–çŠ¶æ€...
    }
}
```

## ğŸ› ï¸ å…·ä½“å®ç°è·¯çº¿å›¾

### é˜¶æ®µ 1: å¿«ç…§æœºåˆ¶å¼•å…¥ (1-2å¤©)

1. **åˆ›å»ºå¿«ç…§ç±»å‹å®šä¹‰**
   - å®šä¹‰ `RenderStateSnapshot` ç»“æ„
   - å®ç°å¿«ç…§åˆ›å»ºå’Œæ›´æ–°æœºåˆ¶

2. **é‡æ„æ¸²æŸ“ä¸Šä¸‹æ–‡**
   - ä¿®æ”¹ `UnifiedRenderContext` ä»¥æ”¯æŒå¿«ç…§
   - ä¿æŒå‘åå…¼å®¹æ€§

3. **æ›´æ–°æ ¸å¿ƒæ¸²æŸ“å™¨**
   - ä¿®æ”¹ `ChartRenderer::render` æ–¹æ³•ä½¿ç”¨å¿«ç…§
   - æ›´æ–°æ¸²æŸ“ç­–ç•¥æ¥å£

### é˜¶æ®µ 2: åˆ†å±‚çŠ¶æ€é‡æ„ (2-3å¤©)

1. **çƒ­ç‚¹çŠ¶æ€æå–**
   - è¯†åˆ«å¹¶æå–é«˜é¢‘è®¿é—®çš„çŠ¶æ€
   - å®ç°ç›´æ¥è®¿é—®æœºåˆ¶

2. **çŠ¶æ€è®¿é—®å±‚é‡æ„**
   - é‡æ„ `CommandManager` çš„çŠ¶æ€è®¿é—®æ¨¡å¼
   - ä¼˜åŒ–äº‹ä»¶å¤„ç†æµç¨‹

3. **æ€§èƒ½æµ‹è¯•ä¸è°ƒä¼˜**
   - å»ºç«‹æ€§èƒ½åŸºå‡†æµ‹è¯•
   - å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½æ•°æ®

### é˜¶æ®µ 3: é«˜çº§ä¼˜åŒ– (1-2å¤©)

1. **å†…å­˜å¸ƒå±€ä¼˜åŒ–**
   - ä¼˜åŒ–çŠ¶æ€ç»“æ„çš„å†…å­˜å¸ƒå±€
   - å‡å°‘å†…å­˜åˆ†é…å’Œå¤åˆ¶

2. **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**
   - å®ç°æ™ºèƒ½ç¼“å­˜å¤±æ•ˆæœºåˆ¶
   - ä¼˜åŒ–æ•°æ®èŒƒå›´è®¡ç®—ç¼“å­˜

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

### æ€§èƒ½æŒ‡æ ‡ç›®æ ‡

1. **çŠ¶æ€è®¿é—®æ€§èƒ½**: æå‡ 60-80%
   - å¿«ç…§è®¿é—®: O(1) ç›´æ¥è®¿é—®
   - å‡å°‘ RefCell å€Ÿç”¨æ£€æŸ¥å¼€é”€

2. **é¼ æ ‡äº‹ä»¶å“åº”**: æå‡ 40-60%
   - å‡å°‘äº‹ä»¶å¤„ç†ä¸­çš„çŠ¶æ€å€Ÿç”¨æ¬¡æ•°
   - ä¼˜åŒ–çŠ¶æ€æ›´æ–°æ‰¹å¤„ç†

3. **æ¸²æŸ“æ€§èƒ½**: æå‡ 30-50%
   - å‡å°‘æ¸²æŸ“è¿‡ç¨‹ä¸­çš„é‡å¤è®¡ç®—
   - ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–

1. **å‡å°‘ RefCell å¼€é”€**: èŠ‚çœ 10-20% å†…å­˜
2. **ä¼˜åŒ–çŠ¶æ€å¸ƒå±€**: æé«˜ç¼“å­˜å±€éƒ¨æ€§
3. **æ™ºèƒ½ç¼“å­˜ç®¡ç†**: å‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…

## ğŸ”§ å®æ–½æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§ä¿è¯

1. **æ¸è¿›å¼è¿ç§»**: ä¿æŒç°æœ‰ API å…¼å®¹æ€§
2. **ç‰¹æ€§å¼€å…³**: ä½¿ç”¨ feature flags æ§åˆ¶æ–°ç‰¹æ€§å¯ç”¨
3. **å›é€€æœºåˆ¶**: ä¿ç•™åŸæœ‰å®ç°ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ

### é£é™©æ§åˆ¶

1. **å¢é‡æµ‹è¯•**: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯¹åº”çš„æµ‹è¯•éªŒè¯
2. **æ€§èƒ½ç›‘æ§**: å»ºç«‹æŒç»­çš„æ€§èƒ½ç›‘æ§æœºåˆ¶
3. **ä»£ç å®¡æŸ¥**: ç¡®ä¿å†…å­˜å®‰å…¨å’Œçº¿ç¨‹å®‰å…¨

## ğŸ“ ç»“è®º

é€šè¿‡çŠ¶æ€å¿«ç…§æ¨¡å¼å’Œåˆ†å±‚çŠ¶æ€ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾è‘—æå‡ Kçº¿å›¾è¡¨çš„æ¸²æŸ“æ€§èƒ½ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå®‰å…¨æ€§ã€‚è¿™ç§ä¼˜åŒ–ç­–ç•¥å……åˆ†åˆ©ç”¨äº† Rust çš„é›¶æˆæœ¬æŠ½è±¡ç‰¹æ€§ï¼Œå®ç°äº†é«˜æ€§èƒ½çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-15  
**æœ€åæ›´æ–°**: 2025-01-15  
**è´Ÿè´£äºº**: æ¶æ„ä¼˜åŒ–å›¢é˜Ÿ
