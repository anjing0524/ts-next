# E2E测试策略文档

## 测试目标

验证admin-portal与oauth-service的完整集成，确保：
1. OAuth 2.1认证流程正确实现
2. RBAC权限系统有效工作
3. 管理功能正常运行
4. 错误处理机制健壮

## 测试范围

### 1. 认证流程测试
- 用户名/密码登录
- OAuth 2.1授权码流程（PKCE）
- 会话管理
- 登出功能
- 令牌刷新

### 2. 权限系统测试
- 角色权限验证
- 页面级权限控制
- 按钮级权限控制
- API权限验证
- 权限继承和覆盖

### 3. 管理功能测试
- 用户管理（CRUD）
- 角色管理（CRUD）
- 权限管理（CRUD）
- 客户端管理（CRUD）
- 审计日志查看

### 4. 集成测试
- 服务间通信
- 数据一致性
- 错误处理
- 性能表现

## 测试环境

### 服务配置
- oauth-service: localhost:3001
- admin-portal: localhost:3002
- 测试数据库: SQLite (test.db)

### 测试数据
- 预定义测试用户
- 标准角色和权限
- 测试OAuth客户端

## 测试执行策略

### 测试套件结构
```
tests/e2e/specs/
├── 01-authentication.spec.ts    # 认证流程测试
├── 02-permissions.spec.ts        # 权限系统测试
├── 03-user-management.spec.ts    # 用户管理测试
├── 04-role-management.spec.ts    # 角色管理测试
├── 05-client-management.spec.ts  # 客户端管理测试
├── 06-audit-logs.spec.ts         # 审计日志测试
└── 07-error-handling.spec.ts     # 错误处理测试
```

### 执行顺序
1. 按数字顺序执行测试套件
2. 每个套件内部并行执行
3. 失败时停止执行

### 数据管理
- 每个测试使用独立数据
- 测试前后清理数据
- 使用事务回滚

## 关键测试场景

### 认证场景
1. **成功登录流程**
   - 输入有效凭据
   - 验证重定向到仪表盘
   - 检查会话建立

2. **OAuth授权流程**
   - 触发OAuth流程
   - 在oauth-service登录
   - 同意授权
   - 验证令牌交换

3. **权限验证**
   - 不同角色用户登录
   - 验证可见菜单
   - 验证可操作按钮

### 管理场景
1. **用户创建**
   - 填写用户信息
   - 分配角色
   - 验证创建成功

2. **权限修改**
   - 编辑角色权限
   - 验证权限生效
   - 检查权限继承

## 测试报告

### 输出格式
- JSON格式详细报告
- 失败时截图和视频
- 测试执行追踪

### 指标监控
- 测试通过率
- 执行时间
- 失败原因分析

## 问题处理

### 常见问题
1. **服务启动失败**
   - 检查端口占用
   - 验证环境变量

2. **测试数据问题**
   - 重新初始化数据库
   - 检查数据一致性

3. **权限错误**
   - 验证角色配置
   - 检查权限映射

### 调试工具
- Playwright UI模式
- 浏览器开发者工具
- 数据库查看器