# OAuth2.1 + RBAC 认证授权中心产品需求文档

## 1. 项目概述

### 1.1 项目背景

构建一个专为**企业内网环境**设计的OAuth2.1认证授权中心，为内部应用和第三方服务提供统一的身份认证和细粒度权限控制。该系统将成为企业应用生态的核心基础设施，在企业网络安全边界保护下，专注于高效的身份验证和精细化权限控制。

基于API路由优化分析，系统将实现**95%的OAuth2.1标准合规性**，通过v2 API架构设计提供标准化、高性能的认证服务，并通过数据库优化实现**30%的性能提升**。

### 1.2 内网应用特点

- **安全边界保障**：依托企业网络安全边界，减少对外部攻击的防护假设
- **简化认证流程**：聚焦内网认证需求，去除不必要的外部安全措施
- **精细化权限管理**：管理用户可访问的菜单（页面）和API接口权限，支持Redis缓存优化
- **多场景支持**：支持认证中心认证、服务间认证、API Server服务认证、第三方客户端认证等典型场景
- **高性能要求**：内网环境下追求更高的认证和权限验证性能，目标实现毫秒级响应
- **标准化架构**：基于v2 API设计，消除80%的路由重复，提供RESTful标准接口
- **数据库优化**：通过索引优化和查询优化，实现30%的数据库性能提升

### 1.3 核心价值

- **统一认证入口**：所有应用使用统一的用户身份和登录流程，提升用户体验
- **细粒度权限控制**：基于RBAC角色权限模型，实现精确的访问控制，支持批量权限检查
- **标准化集成**：基于OAuth2.1标准（95%合规性），便于第三方系统集成，提高系统互操作性
- **高性能权限验证**：毫秒级权限检查，支持高并发场景，通过Redis缓存实现30%性能提升
- **多场景认证支持**：统一支持页面认证、服务间认证、API认证等多种场景
- **内网优化设计**：针对内网环境优化，简化安全流程，提升性能和易用性
- **v2 API架构**：提供标准化RESTful接口，消除路由重复，支持清晰的版本管理
- **完整审计追踪**：全面的操作日志和审计功能，确保合规性和安全监控

### 1.4 目标用户

- **系统管理员**：管理用户、角色、权限和客户端配置
- **应用开发者**：集成OAuth认证和权限验证到业务系统
- **最终用户**：通过统一入口访问各类企业应用
- **安全审计人员**：监控系统安全状态，进行合规审计

---

## 2. 功能需求

### 2.1 用户认证管理

#### 2.1.1 用户生命周期管理

**UC-2.1.1-001: 用户账户创建（管理员操作）**

- **说明**：系统不允许用户自主注册。所有用户账户均由管理员在用户管理界面创建。
- **前置条件**：操作者拥有管理员权限。
- **主要流程**：
  1. 管理员在用户管理界面发起创建新用户操作。
  2. 管理员填写用户基本信息（如：用户名、姓名、部门、岗位、组织等）。
  3. 系统生成初始密码（可选择系统自动生成或由管理员设置），初始密码需要符合密码策略。
  4. 管理员通过安全的内网渠道（如内部通讯工具）将初始密码告知用户。
  5. 用户首次登录时，系统应提示或要求用户修改初始密码。
  6. 系统记录用户创建操作的审计日志。
- **验收标准**：
  - 用户信息能够完整保存，并支持内网组织架构相关的属性（如部门、岗位、组织）。
  - 初始密码生成与设置符合内网环境下的密码策略要求。
  - 用户首次登录时有明确的密码修改引导和机制，新密码需符合安全策略。
  - 用户管理界面提供清晰的用户创建功能入口。

**UC-2.1.1-002: 用户登录**

- **说明**：用户访问受保护资源时，若未认证或认证过期，系统应引导用户至登录页面。登录过程需结合授权码（Authorization Code Grant）和PKCE流程。
- **前置条件**：用户账户已创建且状态为激活。
- **主要流程**：
  1. 用户尝试访问受保护的资源或直接访问登录入口。
  2. 系统检查当前用户的认证状态（例如，通过检查有效的会话令牌）。
  3. 若用户未认证或认证无效/过期，系统重定向用户至认证中心的登录页面。
  4. 登录页面提示用户输入用户名和密码。
  5. 用户提交凭据后，系统验证用户名、密码及账户状态（如是否锁定、是否激活）。
  6. 验证成功后，系统完成OAuth2.1授权流程（如颁发授权码），并最终将用户重定向至目标应用或其个人中心。
  7. 系统记录用户登录尝试（成功或失败）的审计日志。
- **验收标准**：
  - 连续登录失败达到3次，账户将被临时锁定15分钟，并记录相应的审计日志。
  - 成功登录后，系统应建立安全的会话（例如，通过颁发符合OAuth2.1标准的令牌）。
  - （可选，根据内网策略）对于识别为异地登录或在非常用设备上的登录尝试，系统可向用户发送安全提醒。

**UC-2.1.1-003: 认证中心自身登录（OAuth客户端模式）**

- **前置条件**：认证中心作为特殊的OAuth客户端已预注册
- **主要流程**：
  1. 用户访问认证中心管理界面或用户中心
  2. 系统检测到需要认证，重定向到OAuth授权端点
  3. 用户在授权页面输入用户名/密码进行身份验证
  4. 用户确认授权范围（如：用户信息读取、权限管理等）
  5. 系统生成授权码并重定向回认证中心回调地址
  6. 认证中心使用授权码换取访问令牌和刷新令牌
  7. 使用访问令牌建立用户会话，跳转到目标页面
  8. 系统记录完整的OAuth认证流程审计日志
- **验收标准**：
  - 认证中心自身遵循完整的OAuth2.1 + PKCE流程
  - 支持细粒度的权限授权（管理员权限、普通用户权限等）
  - 会话管理基于JWT令牌，支持令牌刷新
  - 提供统一的登录体验，与第三方应用登录流程一致
  - 支持单点登出，清理所有相关会话和令牌

**UC-2.1.1-004: 用户信息管理**

- **前置条件**：用户已成功登录认证中心，或操作者拥有管理员权限。
- **主要流程**：
  1. 用户或管理员访问用户信息管理的相关界面。
  2. 系统展示用户的基本信息（如姓名）和组织属性（如部门、岗位、工作地点）。
  3. 用户可修改授权范围内允许修改的个人信息（通常为非敏感信息）。
  4. 管理员可修改其管理范围内的用户信息，例如重置用户密码（生成新密码）。
  5. 信息更新后，系统保存更改并记录相应的审计日志。
- **验收标准**：
  - 普通用户仅能修改自身的非关键性、非敏感个人信息。
  - 管理员具备修改其管理范围内用户所有信息的权限，包括重置密码。
  - 对于关键用户信息字段的变更（如用户角色），系统可配置要求二次确认。

#### 2.1.2 密码策略（内网简化版）

**UC-2.1.2-001: 密码复杂度要求**

- **描述**：定义内网环境下的密码复杂度标准。
- **规则**：
  - 最小长度：建议8位或以上（可配置）。
  - 字符类型：建议包含大写字母、小写字母、数字、特殊字符中的至少2种组合（可配置）。
  - 弱密码检测：不允许使用常见的弱密码列表中的密码（如“123456”, “password”等）。
  - 用户信息关联：不允许密码与用户名或易获取的个人信息（如生日）过于相似。
- **验收标准**：
  - 用户在设置或修改密码时，系统强制校验密码是否符合复杂度要求。
  - 若密码不符合要求，系统应向用户提供清晰、具体的错误提示和修改建议。

**UC-2.1.2-002: 密码有效期与定期修改**

- **描述**：内网环境下，密码定期修改的策略可以相对宽松，但仍建议设置有效期。
- **规则**：
  - 密码有效期：例如180天（此参数应可配置）。
  - 修改提醒：在密码到期前的一定天数（如15天，可配置）开始提醒用户修改密码。
  - 过期处理：密码过期后，用户登录时将被强制引导至密码修改流程，完成修改后方可继续使用系统。
- **验收标准**：
  - 系统能够准确记录密码的最后设置时间，并据此计算有效期。
  - 密码到期前的提醒功能按配置正常触发。
  - 密码过期后的强制修改流程能够正确引导用户完成密码更新。

**UC-2.1.2-003: 密码历史记录**

- **描述**：防止用户在短期内重复使用最近使用过的密码，以增强账户安全。
- **规则**：
  - 历史记录数量：系统记录用户最近N次（例如5次，可配置）使用过的密码（需加密存储）。
  - 重复性检查：用户设置新密码时，新密码不得与历史记录中的密码相同。
- **验收标准**：
  - 系统能够安全、准确地存储和查询用户的密码历史记录。
  - 在用户设置新密码时，系统能有效比对新密码与历史密码，并阻止使用重复密码。

#### 2.1.3 账户安全

**UC-2.1.3-001: 账户锁定策略**

- **描述**：通过在多次连续登录失败后临时锁定账户，以防止针对用户密码的暴力破解尝试。
- **规则**：
  - 失败次数阈值：例如，连续登录失败3次（可配置）。
  - 锁定时长：账户将被锁定一段时间，例如15分钟（可配置）。
  - 锁定期间行为：在账户锁定期间，用户无法通过该账户登录系统。任何登录尝试都应提示账户已锁定以及预计的解锁时间。
- **验收标准**：
  - 账户锁定机制能够根据配置的失败次数阈值和锁定时长准确触发和自动解除。
  - 在账户锁定时，系统向用户提供清晰的锁定状态和解锁时间提示。

**UC-2.1.3-002: 会话管理**

- **描述**：确保用户登录后会话的安全性，防止会话被滥用或劫持。
- **规则**：
  - 会话超时：用户在一段时间内（例如30分钟，可配置）无任何操作，系统应自动结束其会话并要求重新登录。
  - 手动退出：用户应能通过明确的操作（如点击“退出登录”按钮）安全地结束当前会话。
  - 安全措施：采取必要的安全措施防止会话固定和劫持攻击，例如：
    - 使用HttpOnly和Secure标记会话Cookie。
    - 定期更新会话ID（如果适用）。
    - 避免在URL中传递会话标识。
- **验收标准**：
  - 会话超时机制按配置正常工作，闲置用户被自动登出。
  - 用户手动退出操作能够彻底清理当前会话信息，确保无法通过旧会话凭证再次访问。
  - 已实施有效的会话安全措施，并通过安全测试验证其有效性。

### 2.2 OAuth2.1认证服务

基于API路由优化分析，OAuth2.1认证服务将实现**95%的标准合规性**，支持完整的PKCE流程、标准化的端点设计，并通过v2 API架构提供高性能的认证服务。系统将提供标准化的OAuth2.1端点（`/api/v2/oauth/*`），支持强制PKCE、完整的用户同意管理和令牌生命周期管理。

#### 2.2.1 授权流程支持

**UC-2.2-001: 授权码模式 (Authorization Code Grant with PKCE)**

- **描述**：为Web应用（机密客户端）和原生/移动应用（公共客户端）提供安全的、基于重定向的用户授权流程。此模式是OAuth 2.1的核心，并强制使用PKCE (Proof Key for Code Exchange)。
- **主要流程**：
  1. **授权请求**：客户端（应用）将用户的浏览器重定向到认证中心的授权端点。请求中包含以下参数：
     - `response_type=code` (固定值，表示请求授权码)
     - `client_id` (客户端的唯一标识)
     - `redirect_uri` (授权成功后认证中心重定向回客户端的URI，必须与预注册的一致)
     - `scope` (请求的权限范围，通常是客户端自身被授予的API权限集合，例如 `order:read order:create product:read`)
       - `scope` 的格式为以空格分隔的权限标识字符串。权限标识的格式遵循 `资源名称:操作类型` 或 `资源组名:资源名称:操作类型`。
     - `state` (客户端生成的不透明值，用于防止CSRF攻击和关联请求与回调)
     - `code_challenge` (由 `code_verifier` 通过 `code_challenge_method` 计算得出的值)
     - `code_challenge_method=S256` (指定 `code_challenge` 的计算方法，SHA256是强制要求的)
  2. **用户认证与授权**：
     - 认证中心验证客户端身份（基于`client_id`）和请求参数的有效性（如`redirect_uri`是否匹配）。
     - 如果用户尚未在认证中心登录，则提示用户进行身份验证（参见UC-2.1.1-002）。
     - 认证中心向用户展示请求的权限范围（`scope`），并请求用户同意授权。
  3. **授权码颁发**：
     - 用户同意授权后，认证中心生成一个一次性的、短暂有效的授权码 (`code`)。
     - 认证中心将用户的浏览器重定向回客户端预注册的 `redirect_uri`，并在URL参数中携带授权码 (`code`) 和原始的 `state` 值。
  4. **令牌请求**：
     - 客户端从重定向的URL中获取授权码 (`code`)。
     - 客户端向认证中心的令牌端点发起POST请求，以授权码换取令牌。请求中包含以下参数：
       - `grant_type=authorization_code` (固定值)
       - `code` (获取到的授权码)
       - `redirect_uri` (与授权请求中使用的 `redirect_uri` 必须一致)
       - `client_id` (客户端的唯一标识)
       - `code_verifier` (原始的、高熵的随机字符串，用于PKCE验证)
       - 对于机密客户端，还需要进行客户端认证（如使用 `client_secret_basic`, `client_secret_post`, 或 `private_key_jwt`）。公共客户端不发送 `client_secret`。
  5. **令牌颁发**：
     - 认证中心验证授权码的有效性、`code_verifier` (通过 `code_challenge_method` 计算后与之前收到的 `code_challenge` 匹配) 以及客户端凭据（对于机密客户端）。
     - 验证通过后，认证中心颁发Access Token，通常还会颁发Refresh Token (可选但推荐，用于获取新的Access Token) 和ID Token (如果请求了 `openid` scope，用于身份验证)。
  6. **资源访问**：客户端使用获取到的Access Token向资源服务器请求访问受保护的资源。
- **验收标准**：
  - 完整、正确地支持PKCE (RFC 7636) 流程，有效防止授权码拦截攻击。
  - 明确区分并支持公共客户端（如SPA、移动应用）和机密客户端（如后端Web应用）。
  - 令牌（Access Token, Refresh Token, ID Token）的颁发、格式和校验严格符合OAuth 2.1 (及其引用的RFCs如RFC 6749, RFC 6750) 和OpenID Connect Core 1.0规范 (如果支持OIDC)。
  - 错误响应（如无效请求、无效客户端、无效授权码等）格式和状态码符合OAuth 2.1规范 (RFC 6749 Section 5.2)。
  - `state` 参数有效用于防止CSRF并关联请求。
  - `redirect_uri` 必须与客户端预注册的完全匹配。

**UC-2.2-002: 客户端凭据模式 (Client Credentials Grant)**

- **描述**：用于机器到机器（M2M）的认证场景，客户端代表自身（而非代表用户）请求访问受保护资源。此模式仅适用于机密客户端。
- **主要流程**：
  1. **令牌请求**：机密客户端向认证中心的令牌端点发起POST请求，请求中包含以下参数：
     - `grant_type=client_credentials` (固定值)
     - `client_id` (客户端的唯一标识)
     - `client_secret` (客户端的密钥，或其他客户端认证方式如JWT断言 - `client_assertion_type` 和 `client_assertion`)
     - `scope` (可选，请求的权限范围，通常是客户端自身被授予的权限)
  2. **客户端认证与令牌颁发**：
     - 认证中心验证客户端凭据（`client_id` 和 `client_secret` 或其他认证方式）。
     - 验证通过后，认证中心颁发Access Token。通常不颁发Refresh Token，因为客户端可以在需要时重新使用凭据获取新的Access Token。
- **验收标准**：
  - 此授权模式仅对已注册的机密客户端开放。
  - 客户端认证方式安全可靠（如支持 `client_secret_basic`, `client_secret_post`, `private_key_jwt`）。
  - 颁发的Access Token的范围（`scope`）应严格限于该客户端被授权访问的资源和操作。
  - 错误响应符合OAuth 2.1规范。

**UC-2.2-003: 令牌刷新 (Refresh Token Grant)**

- **描述**：允许客户端使用之前获取的Refresh Token向认证中心请求获取新的Access Token，而无需用户再次进行身份验证和授权。这有助于在Access Token过期后维持用户会话的连续性。
- **主要流程**：
  1. **令牌刷新请求**：客户端向认证中心的令牌端点发起POST请求，请求中包含以下参数：
     - `grant_type=refresh_token` (固定值)
     - `refresh_token` (之前获取到的有效Refresh Token)
     - `client_id` (客户端的唯一标识)
     - `client_secret` (对于机密客户端，需要进行客户端认证)
     - `scope` (可选，新请求的权限范围不能超出原始授权时授予的范围；如果省略，则默认为原始范围或由认证中心策略决定)
  2. **验证与新令牌颁发**：
     - 认证中心验证Refresh Token的有效性（如是否过期、是否已被吊销）和客户端凭据（对于机密客户端）。
     - 验证通过后，认证中心颁发一个新的Access Token。
     - 认证中心可以选择性地颁发一个新的Refresh Token (Refresh Token Rotation)，此时旧的Refresh Token可能会立即失效或在短暂的宽限期后失效。这是一种推荐的安全实践，有助于检测和缓解Refresh Token泄露的风险。
- **验收标准**：
  - Refresh Token具有合理的、可配置的有效期，并且支持在必要时（如安全事件、用户登出特定会话）进行吊销。
  - 通过Refresh Token获取的新Access Token的权限范围（`scope`）不得超过原始授权时授予的权限范围。
  - （推荐）支持Refresh Token轮换 (rotation) 策略，即每次使用Refresh Token时都可能返回一个新的Refresh Token，旧的Refresh Token随之失效。
  - Refresh Token应绑定到颁发给它的客户端，不能被其他客户端使用。
  - 错误响应（如无效Refresh Token、无效客户端）符合OAuth 2.1规范。

### 2.3 客户端管理

**UC-2.3-001: 客户端注册与配置**

- **前置条件**：操作者拥有管理员权限。
- **主要流程**：
  1. 管理员通过管理界面发起新客户端的注册流程。
  2. 管理员填写客户端的基本信息，包括：
     - 客户端名称（易于识别的名称）。
     - 客户端类型（例如：机密客户端 Confidential, 公共客户端 Public）。OAuth 2.1中不再支持隐式授权流程，因此主要区分这两类。
     - 重定向URI（一个或多个，用于授权码模式；必须是HTTPS，除非是本地开发localhost）。
     - 允许的授权类型（例如：`authorization_code`, `client_credentials`, `refresh_token`）。
     - 允许的授权范围（`scope`，客户端可以请求的权限集合）。
     - （可选）客户端Logo URI、应用主页URI等描述性信息。
  3. 对于机密客户端，系统生成客户端ID (`client_id`) 和客户端密钥 (`client_secret`)。客户端ID是公开的，客户端密钥必须安全存储和分发给客户端应用的开发者。
  4. 对于公共客户端，系统生成客户端ID (`client_id`)，不分配客户端密钥。
  5. 管理员可以查看、修改已注册客户端的配置信息（如更新重定向URI、调整允许的Scope等）。
  6. 管理员可以启用或禁用客户端。被禁用的客户端无法发起新的授权请求或使用现有令牌。
  7. 管理员可以删除不再需要的客户端注册信息。
  8. 所有客户端管理操作（注册、修改、禁用/启用、删除）均被记录到审计日志中。
- **验收标准**：
  - 客户端ID在认证中心内全局唯一。
  - 对于机密客户端，客户端密钥应具有足够的熵，并以安全的方式存储（例如哈希后存储，原始密钥仅在生成时显示一次）。
  - 重定向URI的校验必须严格，支持精确匹配，并可配置支持通配符（需谨慎使用，并明确其安全风险）。
  - 客户端的状态变更（启用/禁用）应能立即影响其授权和令牌验证行为。
  - 管理界面提供清晰、易用的客户端管理功能。

### 2.4 令牌管理

**UC-2.4-001: 令牌内省 (Token Introspection)**

- **描述**：允许受保护的资源服务器或其他授权方（如API网关、客户端自身）向认证中心查询一个Access Token或Refresh Token的元数据，以验证其有效性并获取相关信息。这对于不直接解析JWT令牌的场景（例如，使用不透明令牌或需要集中验证）非常有用。
- **主要流程**：
  1. 资源服务器或授权客户端向认证中心的令牌内省端点（通常是 `/introspect`）发起POST请求。
  2. 请求中包含要内省的令牌 (`token`)，以及可选的令牌类型提示 (`token_type_hint`，如 `access_token` 或 `refresh_token`，用于优化查找)。
  3. 请求方需要向内省端点进行身份验证（例如，使用其自身的客户端凭据或预共享密钥，具体取决于认证中心的策略）。
  4. 认证中心验证请求方的权限以及待内省令牌的有效性。
  5. 如果令牌有效，认证中心返回一个JSON对象，其中包含一个布尔值 `active: true` 以及其他令牌元数据，例如：
     - `scope` (令牌的授权范围)
     - `client_id` (颁发给的客户端ID)
     - `username` (用户标识，如果令牌与用户关联)
     - `sub` (主体标识，通常是用户ID)
     - `exp` (过期时间戳)
     - `iat` (颁发时间戳)
     - `iss` (颁发者)
     - `aud` (受众)
     - 其他自定义声明。
  6. 如果令牌无效（如过期、已吊销、不存在），认证中心返回 `active: false`。
- **验收标准**：
  - 令牌内省端点的实现应符合RFC 7662 (OAuth 2.0 Token Introspection) 规范。
  - 内省端点本身应受保护，仅允许已授权的资源服务器或客户端访问。
  - 返回的令牌元数据准确、完整，并与令牌颁发时的信息一致。
  - 对于无效或已吊销的令牌，内省结果明确指示其为非活动状态 (`active: false`)。

**UC-2.4-002: 令牌吊销 (Token Revocation)**

- **描述**：允许客户端或授权用户请求认证中心将特定的Access Token或Refresh Token标记为无效，使其不能再被用于访问资源或获取新的Access Token。这对于用户登出、客户端取消授权或检测到令牌泄露等场景至关重要。
- **主要流程**：
  1. 客户端或授权用户向认证中心的令牌吊销端点（通常是 `/revoke`）发起POST请求。
  2. 请求中包含要吊销的令牌 (`token`) 以及可选的令牌类型提示 (`token_type_hint`，如 `access_token` 或 `refresh_token`)。
  3. 请求方需要向吊销端点进行身份验证（例如，使用其客户端凭据，如果客户端正在吊销其自身的令牌）。
  4. 认证中心验证请求方的权限以及待吊销令牌的有效性。
  5. 如果验证通过，认证中心将该令牌（及其关联的令牌，如吊销Refresh Token时也应吊销其派生的Access Token）标记为已吊销。
  6. 吊销操作完成后，该令牌在后续的验证（如资源访问、令牌内省、令牌刷新）中应被视为无效。
- **验收标准**：
  - 令牌吊销端点的实现应符合RFC 7009 (OAuth 2.0 Token Revocation) 规范。
  - 吊销操作应能立即生效，确保已吊销的令牌无法再被成功使用。
  - 支持吊销Access Token和Refresh Token。
  - 客户端应能吊销其自身获取的令牌。
  - （可选）管理员应有能力吊销系统中的任何令牌。
  - 吊销操作应被记录到审计日志中。

### 2.5 RBAC（基于角色的访问控制）权限管理

基于API路由优化分析，RBAC权限管理将通过**Redis缓存优化**实现30%的性能提升，支持**批量权限检查**以减少数据库查询，并提供**毫秒级权限验证响应**。系统将支持细粒度的权限控制、层级角色管理和资源级权限，通过v2 API（`/api/v2/rbac/*`）提供标准化的权限管理接口。

#### 2.5.1 核心概念

- **用户 (User)**：系统中的认证个体，通常对应于企业内网中的员工账户。每个用户通过其唯一的标识（如用户ID或用户名）进行识别。
- **角色 (Role)**：权限的逻辑集合，代表了系统中的一种职责、岗位或用户分组。例如：“系统管理员”、“部门经理”、“普通员工”、“财务专员”等。用户通过被分配一个或多个角色来获得相应的权限。
- **权限 (Permission)**：对特定资源执行特定操作的许可，或访问特定菜单/页面的许可。权限是访问控制的基本单元，定义了“谁可以对什么做什么，或访问什么”。
  - **权限类型 (PermissionType)**: 权限分为 `API权限` 和 `菜单权限`。
    - **API权限 (API Permission)**: 控制对后端API接口的访问。标识格式建议采用 `资源名称:操作类型` 或 `资源组名:资源名称:操作类型`，例如：
      - `user:create` (创建用户API)
      - `order:read` (读取订单信息API)
      - `report:financial:generate` (生成财务类报表API)
      - 支持通配符：
        - `resource:*` (表示对指定资源的所有操作权限，如 `user:*`)
        - `group:resource:*` (表示对指定资源组下指定资源的所有操作权限)
        - `*:action` (不推荐，除非有明确的全局只读API场景)
    - **菜单权限 (Menu Permission)**: 控制用户对前端页面/菜单的访问。标识格式建议采用层级路径方式，例如：
      - `dashboard` (访问仪表盘页面)
      - `system_management` (访问系统管理模块主菜单)
      - `system_management/user_list` (访问系统管理下的用户列表页面)
      - `system_management/role_management/edit` (访问角色管理中的编辑功能页面/区域)
      - 支持通配符：
        - `menu_group/*` (表示对指定菜单组下所有菜单项的访问权限，如 `system_management/*`)
        - `*` (表示对所有菜单的访问权限，通常仅超级管理员拥有)
- **资源 (Resource)**：系统中受访问控制保护的对象、数据实体、服务或功能。例如：用户账户信息、订单数据、API端点、特定的管理功能模块、文件等。
- **操作 (Action/Operation)**：可以在资源上执行的具体动作。常见的操作类型包括：创建 (create/add)、读取 (read/view/get/list)、更新 (update/edit/modify)、删除 (delete/remove)、执行 (execute/run)、审批 (approve)、下载 (download) 等。

#### 2.5.2 角色与权限管理功能

**UC-2.5.2-001: 角色管理**

- **前置条件**：操作者拥有“角色管理”权限（通常是系统管理员或特定的权限管理员角色）。
- **主要流程**：
  1. **创建角色**：管理员可以创建新的角色，定义角色名称（需唯一）和描述。
  2. **编辑角色**：管理员可以修改已存在角色的名称和描述。
  3. **删除角色**：管理员可以删除不再需要的角色（需考虑角色被用户或策略使用时如何处理，如禁止删除或给出提示）。
  4. **为角色分配/撤销权限**：管理员可以从预定义的权限列表中选择一个或多个权限点，将其分配给特定角色；也可以从角色中移除已分配的权限。
  5. **查看角色信息**：管理员可以查看角色的详细信息，包括其拥有的权限列表以及被哪些用户所拥有。
- **验收标准**：
  - 角色名称在系统内必须唯一。
  - 角色的权限变更（增加、删除权限）应能实时或在合理延迟内反映到拥有该角色的用户的有效权限上。
  - （可选，根据复杂度需求）支持角色的层级关系或继承（例如，高级角色自动继承低级角色的所有权限）。如果支持，需要明确继承规则和冲突解决机制。
  - 角色删除时，应有明确的提示和确认机制，特别是当角色仍被用户或策略引用时。

**UC-2.5.2-002: 权限定义与管理**

- **前置条件**：通常由系统开发者或具有最高权限的管理员在系统初始化或版本更新时进行。
- **主要流程**：
  1. **定义API权限点**：
     - 根据业务需求和后端API接口，定义新的API权限点，遵循 `资源:操作` 或 `资源组:资源:操作` 的命名规范。
     - 为每个API权限点提供清晰的业务描述，说明该权限控制的具体API端点和操作。
     - API权限点需要注册到权限系统中，使其可以被角色分配和被API权限检查逻辑识别。
  2. **定义菜单权限点**：
     - 根据前端应用的页面和菜单结构，定义新的菜单权限点，遵循层级路径命名规范 (如 `system/user` 或 `report/sales/detail`)。
     - 为每个菜单权限点提供清晰的业务描述，说明该权限控制的具体页面或菜单项。
     - 菜单权限点需要注册到权限系统中，使其可以被角色分配和被前端用于控制菜单/页面显隐。
  3. **权限描述与分类**：可对两类权限点进行分类或分组，便于管理和查找。
- **验收标准**：
  - API权限点的定义应清晰、原子化，并准确反映其控制的API操作。
  - 菜单权限点的定义应清晰，并准确反映其控制的前端页面/菜单。
  - 两类权限点的命名规范一致，易于理解和维护。
  - API权限点应与后端API接口或业务逻辑中的权限校验点一一对应或有明确映射关系。
  - 菜单权限点应与前端路由或菜单组件的显隐逻辑对应。
  - 系统应提供机制（如配置文件、数据库表、管理界面）来管理和维护API权限点和菜单权限点列表。

**UC-2.5.2-003: 用户角色分配**

- **前置条件**：操作者拥有“用户角色分配”权限（通常是系统管理员或用户管理员）。
- **主要流程**：
  1. **为用户分配角色**：管理员可以选择一个或多个已定义的角色，将其分配给指定的用户账户。
  2. **从用户移除角色**：管理员可以从指定用户账户中移除一个或多个已分配的角色。
  3. **查看用户角色**：管理员或用户自身（取决于权限配置）可以查看特定用户当前拥有的角色列表。
- **验收标准**：
  - 一个用户可以同时拥有多个角色。
  - 用户的最终有效权限是其所有被分配角色所包含权限的并集。
  - 用户角色的变更（增加或移除角色）应能实时或在合理延迟内影响其最终的访问权限。
  - 管理界面提供便捷的用户角色分配和管理功能。

### 2.6 统一权限验证

#### 2.6.1 权限验证流程

**UC-2.6-001: 单项权限验证**

- **描述**：系统提供统一的权限验证接口，基于RBAC验证逻辑，为应用提供准确的访问控制决策。
- **主要流程**：
  1. 应用系统向权限验证服务发送权限验证请求，包含用户信息、目标资源和请求操作。
  2. 权限验证服务执行RBAC检查：根据用户的角色和角色权限，判断用户是否拥有执行该操作的权限。
  3. 根据RBAC验证结果，做出最终的 `allowed` 决策。
- **验收标准**：
  - 权限验证逻辑正确实现RBAC规则。
  - 权限验证响应时间在可接受范围内（如<100ms），支持高并发访问。
  - 验证结果包含足够的信息用于调试和审计（如匹配的角色、权限、决策原因）。

### 2.7 统一权限验证

### 2.7 统一权限验证服务

本节描述认证授权中心提供的统一权限验证接口和机制，供各业务应用系统集成和调用，以实现集中的权限决策。

**UC-2.7-001: 单项API权限验证**

- **API端点**：`POST /api/v1/auth/check`
- **请求体 (JSON)**：
  ```json
  {
    "subjectAttributes": {
      "userId": "string", // 必需，用户唯一标识
      "roles": ["string"], // 可选，用户拥有的角色列表，如果RBAC在中心处理
      "department": "string" // 可选，用户所属部门
      // ... 其他相关主体属性
    },
    "resourceAttributes": {
      "resourceId": "string", // 必需，被访问资源的唯一标识
      "resourceType": "string", // 可选，资源类型 (e.g., 'document', 'order')
      "owner": "string" // 可选，资源所有者
      // ... 其他相关资源属性
    },
    "action": {
      "type": "string" // 必需，尝试执行的操作 (e.g., 'read', 'write', 'delete')
    },
    "environmentAttributes": {
      // 可选，访问请求的环境上下文属性
      "ipAddress": "string",
      "timestamp": "ISO8601_datetime_string"
      // ... 其他相关环境属性
    }
  }
  ```
- **响应体 (JSON)**：
  ```json
  {
    "allowed": true, // 或者 false
    "reasonCode": "string", // 可选，权限决策的原因代码 (e.g., 'POLICY_MATCH_DENY', 'NO_APPLICABLE_POLICY', 'RBAC_PERMISSION_GRANTED')
    "message": "string", // 可选，更详细的描述信息
    "matchedPolicyIds": ["string"] // 可选，匹配到的策略ID列表 (用于调试和审计)
  }
  ```
- **核心逻辑**：
  1.  接收权限验证请求，包含主体、资源、操作及环境属性。
  2.  执行RBAC检查：根据用户角色（`subjectAttributes.roles` 或通过 `userId` 查询）判断是否拥有对 `resourceAttributes.resourceId` 执行 `action.type` 的直接权限或继承权限。
  3.  根据RBAC检查结果，做出最终的 `allowed` 决策。
- **验收标准**：
  - 权限验证逻辑正确执行RBAC规则。
  - API接口响应时间在P99下应小于50毫秒（不含网络延迟）。
  - 所有权限验证请求及其决策结果（包括关键属性和匹配的策略ID）应被详细记录到审计日志中，便于追踪和问题排查。
  - 接口支持通过HTTP头部传递认证凭证（如OAuth 2.1 Access Token）以识别调用方应用并进行限流等控制。

**UC-2.7-002: 批量API权限验证**

- **API端点**：`POST /api/v1/auth/check-batch`
- **请求体 (JSON)**：
  ```json
  {
    "subjectAttributes": {
      // 主体属性，对所有批量请求通用
      "userId": "string"
      // ... 其他通用主体属性
    },
    "requests": [
      {
        // 每个请求项结构与单项验证中的 resourceAttributes, action, environmentAttributes 类似
        "requestId": "string", // 可选，用于对应返回结果中的某一项
        "resourceAttributes": { "resourceId": "itemA", "resourceType": "type1" },
        "action": { "type": "read" },
        "environmentAttributes": {
          /* ... */
        }
      },
      {
        "requestId": "string",
        "resourceAttributes": { "resourceId": "itemB", "resourceType": "type2" },
        "action": { "type": "write" },
        "environmentAttributes": {
          /* ... */
        }
      }
      // ...更多请求项
    ]
  }
  ```
- **响应体 (JSON)**：
  ```json
  {
    "results": [
      {
        "requestId": "string", // 对应请求中的requestId
        "allowed": true, // 或者 false
        "reasonCode": "string",
        "message": "string",
        "matchedPolicyIds": ["string"]
      }
      // ...每个请求项的对应结果
    ]
  }
  ```
- **核心逻辑**：对请求列表中的每一个权限验证请求，独立执行与UC-2.7-001相同的验证逻辑。
- **验收标准**：
  - 支持一次性对多个权限请求进行验证，以提高网络效率。
  - 单次批量请求支持的验证项数量上限为100个（可配置）。
  - 对于100个验证项的批量请求，API接口响应时间在P99下应小于200毫秒（不含网络延迟）。
  - 每个验证项的决策结果独立，并能通过 `requestId` 与请求对应。
  - 批量请求的整体和单个验证项的审计日志记录应清晰。

**UC-2.7-003: 权限验证客户端SDK与中间件集成**

- **目标**：为各业务应用系统提供便捷的方式来集成和使用统一权限验证服务。
- **交付物**：
  1.  **客户端SDK**：针对主流编程语言（如Java, Node.js, Python, Go）提供客户端库。
      - 封装调用 `/api/v1/auth/check` 和 `/api/v1/auth/check-batch` 的逻辑。
      - 处理认证、请求构造、响应解析等细节。
      - 内置可配置的权限决策缓存机制（例如，基于TTL的内存缓存或分布式缓存适配），以减少对权限中心的不必要调用，提高应用性能。
      - 提供清晰的API和使用文档。
  2.  **框架中间件/拦截器** (可选，针对特定框架)：
      - 为常见Web框架（如Spring Boot/Cloud Gateway, Express.js, Django/Flask, Gin/Echo）提供即插即用的中间件或拦截器。
      - 自动拦截API请求（基于配置的路径匹配规则）。
      - 从请求中提取主体、资源、操作、环境等属性（需要可配置的属性提取逻辑）。
      - 调用客户端SDK进行权限验证。
      - 根据验证结果，自动允许请求继续或返回自定义的未授权响应 (e.g., HTTP 403 Forbidden)。
- **验收标准**：
  - 客户端SDK易于集成到应用中，配置项清晰明了。
  - SDK的权限缓存机制有效，并能显著降低对权限验证服务的调用频率，同时保证缓存失效的及时性（例如，通过订阅策略变更通知或合理的缓存过期时间）。
  - （若提供）框架中间件能够无缝集成，对应用代码的侵入性小。
  - 中间件的属性提取逻辑灵活可配，能适应不同应用的请求结构。
  - SDK和中间件对应用本身的性能影响应尽可能小。
  - 提供完整的集成示例文档和最佳实践指南。

### 2.8 管理界面 (Admin Console)

认证授权中心需要一个用户友好的Web管理界面，供管理员进行系统配置、用户管理、权限管理等操作。

#### 2.8.1 用户管理 (User Management)

**UC-2.8.1-001: 用户列表查看与筛选**

- **功能描述**：管理员可以查看系统内所有用户的列表。列表应展示关键用户信息，如用户ID、用户名、姓名、所属部门、状态（启用/禁用）、创建时间等。
- **主要流程**：
  1.  管理员访问用户管理页面。
  2.  系统默认显示第一页用户列表，按创建时间或用户名排序。
  3.  管理员可以使用筛选条件（如用户名、姓名、邮箱、手机号、所属部门、用户状态、角色）进行用户搜索和过滤。
  4.  管理员可以进行分页浏览。
- **验收标准**：
  - 用户列表显示信息准确、完整。
  - 筛选功能按预期工作，支持多条件组合查询。
  - 分页功能正常，响应快速。
  - 列表应能处理大量用户数据（例如，通过后端分页和索引优化）。
  - 用户列表加载时间在100个用户时应小于2秒。
  - 批量操作（如激活/禁用）应有进度提示和结果反馈。

**UC-2.8.1-002: 用户信息创建与编辑**

- **功能描述**：管理员可以创建新用户账户，或编辑已有用户的基本信息、账户状态、所属组织架构信息等。
- **主要流程 (创建)**：
  1.  管理员点击“创建用户”按钮。
  2.  填写用户信息表单（用户名、初始密码策略、姓名、邮箱、手机号、所属部门等）。
  3.  提交表单，系统创建用户账户。
- **主要流程 (编辑)**：
  1.  管理员在用户列表中选择一个用户，点击“编辑”按钮或查看详情。
  2.  在用户详情页修改用户信息（不允许直接修改密码，应提供重置密码功能）。
  3.  保存更改。
- **验收标准**：
  - 用户创建成功，新用户可以使用初始凭证登录（或按密码策略执行）。
  - 用户信息编辑成功，更改实时反映。
  - 用户名字段应唯一。
  - 邮箱、手机号等敏感信息格式校验正确。
  - 所有创建和修改操作均记录审计日志。
  - 用户详情页清晰展示用户基本信息、角色分配、权限列表（可预览）、登录历史。

**UC-2.8.1-003: 用户账户状态管理**

- **功能描述**：管理员可以启用或禁用用户账户，以及锁定或解锁用户账户。
- **主要流程**：
  1.  管理员在用户列表中选择一个或多个用户。
  2.  选择操作：“启用”、“禁用”、“锁定”、“解锁”。
  3.  确认操作。
- **验收标准**：
  - 禁用/锁定的用户无法登录系统。
  - 启用/解锁的用户可以正常登录。
  - 状态变更操作记录审计日志。

**UC-2.8.1-004: 用户密码重置**

- **功能描述**：管理员可以为用户重置密码。重置方式可以是生成随机密码发送给用户，或强制用户下次登录时修改密码。
- **主要流程**：
  1.  管理员在用户列表中选择一个用户，选择“重置密码”操作。
  2.  选择重置方式。
  3.  系统执行密码重置。
- **验收标准**：
  - 密码重置成功，用户可以使用新密码或按提示修改密码后登录。
  - 密码重置操作记录审计日志。
  - 重置后的密码符合密码策略要求。

**UC-2.8.1-005: 用户角色批量分配管理** (关联UC-2.5.2-003)

- **功能描述**：管理员可以在用户管理界面为用户批量分配或移除角色。
- **主要流程**：
  1.  管理员在用户列表中选择一个或多个用户。
  2.  选择“批量分配角色”操作。
  3.  在角色分配区域，从可用角色列表中选择角色添加给用户，或从用户已拥有角色列表中移除角色。
  4.  保存更改。
- **验收标准**：
  - 用户角色批量分配/移除操作成功，并实时影响用户权限。
  - 界面清晰展示用户当前角色和可用角色。

#### 2.8.2 角色与权限管理 (Role & Permission Management)

管理对象包括：角色、API权限、菜单权限。

**UC-2.8.2-001: 角色列表查看与筛选** (关联UC-2.5.2-001)

- **功能描述**：管理员可以查看系统内所有角色的列表。列表应展示角色名称、描述、创建时间、角色层级关系（如果支持）等。
- **主要流程**：
  1.  管理员访问角色管理页面。
  2.  系统显示角色列表，支持按名称、描述等筛选。
- **验收标准**：
  - 角色列表显示准确。
  - 筛选功能正常。
  - （若支持）角色层次关系可视化展示。

**UC-2.8.2-002: 角色创建与编辑** (关联UC-2.5.2-001)

- **功能描述**：管理员可以创建新角色或编辑已有角色的名称、描述和层级关系（如果支持）。
- **主要流程**：
  1.  管理员点击“创建角色”或在列表中选择角色编辑。
  2.  填写/修改角色名称（唯一）、描述、父角色（如果支持层级）。
  3.  保存。
- **验收标准**：
  - 角色创建/编辑成功，角色名称唯一。
  - 操作记录审计日志。

**UC-2.8.2-003: 角色权限分配管理** (关联UC-2.5.2-001)

- **功能描述**：管理员可以为选定的角色分配或移除权限点。界面应提供权限预览功能。
- **主要流程**：
  1.  管理员选择一个角色进行编辑。
  2.  界面展示系统所有可用权限点（可视化权限树，支持按类别展开/折叠）。
  3.  管理员勾选/取消勾选权限点，将其分配给角色或从角色中移除。
  4.  系统实时预览该角色变更后的有效权限列表。
  5.  保存更改。
- **验收标准**：
  - 权限分配/移除操作成功，实时影响拥有该角色的用户的权限。
  - 权限树清晰，易于查找和选择，支持批量权限分配。
  - 权限变更实时预览效果准确。

**UC-2.8.2-004: API权限点管理** (关联UC-2.5.2-002)

- **功能描述**：高级管理员或开发者可以查看、定义和管理系统中的API权限点。
- **主要流程**：
  1.  访问API权限点管理页面。
  2.  查看当前所有API权限点列表（标识符、名称、描述、分类、关联API端点等）。
  3.  （可选，根据实现方式）创建新的API权限点，定义其标识符、名称、描述和关联的API信息。
  4.  （可选）编辑或废弃不再使用的API权限点。
- **验收标准**：
  - API权限点列表展示清晰。
  - （若支持）API权限点创建和编辑功能符合规范，标识符唯一。
  - API权限点信息与后端API权限校验逻辑保持一致。

**UC-2.8.2-005: 菜单权限点管理** (关联UC-2.5.2-002)

- **功能描述**：高级管理员或开发者可以查看、定义和管理系统中的菜单权限点。
- **主要流程**：
  1.  访问菜单权限点管理页面。
  2.  查看当前所有菜单权限点列表（标识符、名称、描述、分类、前端路由/组件路径等）。
  3.  （可选，根据实现方式）创建新的菜单权限点，定义其标识符、名称、描述和关联的前端信息。
  4.  （可选）编辑或废弃不再使用的菜单权限点。
- **验收标准**：
  - 菜单权限点列表展示清晰。
  - （若支持）菜单权限点创建和编辑功能符合规范，标识符唯一。
  - 菜单权限点信息与前端菜单/页面显隐逻辑保持一致。

#### 2.8.3 OAuth 2.1 客户端管理 (Client Management)

**UC-2.8.3-001: OAuth客户端列表查看与筛选** (关联UC-2.3-001)

- **功能描述**：管理员可以查看所有已注册的OAuth 2.1客户端应用列表。
- **主要流程**：
  1.  管理员访问客户端管理页面。
  2.  列表显示客户端ID、客户端名称、应用类型、状态、授权统计、令牌使用情况等。
  3.  支持按客户端名称或ID筛选。
- **验收标准**：
  - 客户端列表显示准确。
  - 客户端使用统计实时更新。

**UC-2.8.3-002: OAuth客户端注册与编辑** (关联UC-2.3-001)

- **功能描述**：管理员可以注册新的OAuth客户端应用（表单化配置），或编辑已注册客户端的配置信息，包括安全设置如IP白名单。
- **主要流程 (注册)**：
  1.  点击“注册客户端”。
  2.  填写客户端信息：应用名称、应用类型（Web应用、单页应用、移动/原生应用、机器对机器）、重定向URI(s)、授权许可类型（Authorization Code, Client Credentials等）、所需Scope(s)、Logo URL (可选)、应用描述、IP白名单等。
  3.  系统生成Client ID，并根据应用类型和授权类型选择是否生成Client Secret (对于公共客户端如SPA，不应分配Secret)。
  4.  显示Client ID 和 Client Secret (如果生成)给管理员（Client Secret应只显示一次，并提示妥善保管）。
- **主要流程 (编辑)**：
  1.  选择客户端进行编辑。
  2.  修改上述可配置信息（Client ID通常不可修改，Client Secret可提供重置功能）。
  3.  保存更改。
- **验收标准**：
  - 新客户端注册成功，生成的Client ID全局唯一。
  - Client Secret安全生成和展示（一次性显示）。
  - 客户端配置信息（重定向URI、授权类型、Scope、IP白名单等）能被正确保存和应用到授权流程中。
  - 重定向URI格式校验严格。
  - 所有操作记录审计日志。

**UC-2.8.3-003: OAuth客户端状态管理** (关联UC-2.3-001)

- **功能描述**：管理员可以启用或禁用某个OAuth客户端。
- **主要流程**：
  1.  在客户端列表中选择一个客户端。
  2.  选择“启用”或“禁用”操作。
- **验收标准**：
  - 被禁用的客户端无法发起新的授权请求或获取令牌。
  - 状态变更操作记录审计日志。

#### 2.8.5 监控与审计 (Monitoring & Auditing)

**UC-2.8.5-001: 系统监控面板**

- **功能描述**：提供一个集中的监控面板，展示系统关键运行指标和安全事件。
- **监控指标**：
  - **认证统计**：登录成功率、失败尝试次数、失败原因分布、认证请求QPS、认证响应时间（P95, P99）、高峰时段用户活动。
  - **授权统计**：权限验证请求QPS、平均/P95/P99响应时间、缓存命中率、拒绝的请求数量及原因。
  - **令牌统计**：活动令牌数量、令牌颁发速率、令牌刷新速率。
  - **系统健康**：CPU/内存/磁盘使用率、网络流量、数据库连接数、错误率。
- **安全监控**：
  - 异常登录尝试告警（如暴力破解、异地登录）。
  - 权限提升尝试或异常权限访问告警。
  - 令牌滥用或泄露风险检测（如短时间内大量令牌请求）。
- **主要流程**：
  1.  管理员访问监控面板。
  2.  面板以图表、仪表盘等形式展示各项实时或准实时数据。
  3.  支持选择时间范围查看历史数据。
  4.  关键指标超出阈值时，系统应能产生告警（如邮件、Webhook通知）。
- **验收标准**：
  - 监控数据近实时更新（例如，延迟小于1分钟）。
  - 图表清晰易懂，能准确反映系统状态。
  - 支持按时间范围筛选和查看数据。
  - 告警机制配置灵活，通知及时准确。
  - 支持将监控数据导出（如CSV格式）。

**UC-2.8.5-002: 审计日志查询与管理**

- **功能描述**：提供全面的审计日志记录和查询功能，用于追踪操作、安全审计和问题排查。
- **日志类型**：
  - **认证日志**：用户登录尝试（成功/失败）、登出、密码修改、MFA验证等事件。
  - **授权日志**：权限验证请求（主体、资源、操作、环境、决策结果）、策略评估详情。
  - **管理操作日志**：管理员在管理界面执行的所有操作（用户创建/修改、角色分配、客户端注册、策略变更等）。
  - **系统事件日志**：系统启动/关闭、配置更改、错误和异常等。
- **主要流程**：
  1.  管理员访问审计日志查询页面。
  2.  通过多种条件筛选日志：时间范围、用户ID、客户端ID、事件类型、IP地址、操作结果等。
  3.  查看日志列表和每条日志的详细信息（时间戳、操作者、操作对象、具体内容、IP地址等）。
  4.  支持日志导出（如CSV、JSON格式）和生成简单报表。
- **验收标准**：
  - 所有关键操作均被记录到审计日志中，日志信息完整准确。
  - 日志查询功能强大，支持多维度组合查询，百万级日志查询响应时间应小于3秒。
  - 日志应具备防篡改机制（如数字签名或写入WORM存储）。
  - 日志存储周期可配置，并支持归档策略。
  - 敏感信息在日志中应进行脱敏处理（如密码不应明文记录）。

---

## 3. 非功能性需求

### 3.1 性能要求

- **权限验证响应时间** < 100ms (P99)
- **用户登录响应时间** < 2s (P95)
- **并发用户支持** ≥ 1000 活跃用户
- **权限验证QPS** ≥ 5000 请求/秒
- **系统可用性** ≥ 99.9% (年宕机时间 < 8.76小时)
- **数据库查询响应时间** < 50ms (P95)
- **缓存命中率** > 90%

### 3.2 安全要求（内网优化版）

- **数据传输**：内网TLS加密，支持企业内部证书
- **密码存储**：bcrypt哈希，salt轮数≥10（内网环境适度优化）
- **JWT签名**：RS256非对称加密，密钥轮换周期可配置
- **会话管理**：基于JWT的无状态会话管理
- **输入验证**：基础的输入验证和参数校验
- **敏感数据保护**：关键敏感字段加密存储
- **安全审计**：认证和权限操作的审计日志
- **内网安全**：依托企业网络边界，专注内部API和菜单权限控制

### 3.3 兼容性要求

- **浏览器支持**：Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **移动端支持**：iOS Safari 14+, Android Chrome 90+
- **OAuth客户端**：支持标准OAuth2.1客户端库集成
- **API版本**：提供API版本管理，向后兼容至少2个主版本
- **国际化支持**：界面支持中英文切换，可扩展其他语言

### 3.4 可扩展性要求

- **水平扩展**：支持多实例部署，无状态设计
- **模块化设计**：核心功能模块化，支持按需部署
- **自定义扩展**：支持自定义属性、策略规则和权限类型
- **多租户支持**：设计考虑未来多租户扩展可能性

---

## 4. 技术约束

### 4.1 技术栈要求

- **前端框架**：Next.js 15 (App Router)
- **后端语言**：TypeScript + Node.js
- **数据库**：MySQL 8.0+ (主数据库) + Redis 6+ (缓存)
- **ORM框架**：Prisma 6+
- **JWT处理**：jose库
- **UI组件**：Tailwind CSS + Shadcn UI

### 4.2 部署环境

- **容器化**：Docker + Docker Compose支持
- **云平台**：支持AWS/阿里云/腾讯云部署
- **负载均衡**：支持多实例水平扩展
- **监控告警**：集成Prometheus + Grafana监控
- **CI/CD**：支持自动化构建和部署

---

## 5. 验收标准

### 5.1 功能测试

- **OAuth2.1流程**：通过OAuth2.1标准测试套件验证
- **权限验证**：覆盖所有权限组合的测试用例
- **管理界面**：所有CRUD操作功能正常
- **API接口**：OpenAPI文档完整，自动化测试覆盖率≥90%
- **用户场景**：覆盖所有关键用户场景的端到端测试

### 5.2 性能测试

- **压力测试**：1000并发用户正常运行30分钟
- **权限验证**：10000次权限检查平均响应时间<50ms
- **内存使用**：单实例内存使用<2GB
- **数据库性能**：支持百万级用户数据的高效查询
- **缓存效率**：验证缓存策略有效性，命中率>90%

### 5.3 安全测试

- **渗透测试**：通过OWASP Top 10安全检查
- **令牌安全**：令牌泄露不导致系统完全失控
- **权限绕过**：不存在权限绕过漏洞
- **安全扫描**：通过自动化安全扫描工具检测
- **数据保护**：敏感数据正确加密和保护

---

## 6. 项目里程碑与计划 (Project Milestones & Plan)

以下是一个初步的项目里程碑计划，具体时间安排可根据团队规模和实际情况调整。

### 阶段一: 核心认证与授权基础 (预计 4-6 周)

- **目标**: 完成系统的核心认证功能和基础的RBAC授权框架（区分API与菜单权限），搭建可用的管理界面雏形。
- **主要任务**:
  - [ ] **需求细化与设计 (Week 1)**: 详细设计用户模型、认证流程、OAuth核心流程、RBAC模型（区分API与菜单权限）、数据库结构。
  - [ ] **环境搭建与技术验证 (Week 1)**: 搭建开发、测试环境，验证核心技术选型（OAuth库、ORM等）。
  - [ ] **用户认证模块 (UC-2.1.1, UC-2.1.2, UC-2.1.3) (Week 2-3)**: 实现用户创建（无邮箱）、登录、密码管理、账户安全策略（无MFA）。
  - [ ] **OAuth 2.1 服务模块 (UC-2.2.1, UC-2.2.2) (Week 3-4)**: 实现Authorization Code Grant, Client Credentials Grant，令牌颁发与校验，Scope明确为API权限集合。
  - [ ] **客户端管理模块 (UC-2.3) (Week 4)**: 实现客户端注册与管理基础功能。
  - [ ] **令牌管理模块 (UC-2.4) (Week 4)**: 实现令牌内省与吊销基础功能。
  - [ ] **RBAC权限管理模块 - 核心 (UC-2.5.1, UC-2.5.2) (Week 5)**: 实现角色、API权限点、菜单权限点定义，用户-角色、角色-权限（API/菜单）关联。
  - [ ] **管理界面 - 用户与客户端管理雏形 (UC-2.8.1, UC-2.8.3的部分功能) (Week 5-6)**: 实现用户列表、创建、编辑；客户端列表、注册。
  - [ ] **数据库模型设计与实现 (贯穿)**。
  - [ ] **单元测试与初步集成测试 (贯穿)**。
- **交付物**:
  - 可运行的核心认证服务和OAuth服务。
  - 基础的用户管理和客户端管理界面。
  - 详细设计文档（体现API与菜单权限分离）。

### 阶段二: 高级授权与管理功能完善 (预计 4-5 周)

- **目标**: 完善权限验证机制，丰富管理界面功能，加强系统安全性和可观测性。
- **主要任务**:
  - [ ] **统一权限验证模块 (UC-2.7) (Week 7-8)**: 实现单项和批量API权限验证接口，开发客户端SDK雏形。
  - [ ] **管理界面 - 角色权限管理 (UC-2.8.2) (Week 8-9)**: 实现角色权限分配界面。
  - [ ] **管理界面 - 监控与审计雏形 (UC-2.8.5) (Week 10)**: 实现基础的审计日志记录和查询，监控指标初步接入。
  - [ ] **权限中间件/SDK开发 (UC-2.7.3) (Week 10-11)**: 开发并测试至少一种语言的客户端SDK和框架中间件。
  - [ ] **安全加固 (贯穿)**: 落实3.2节中的安全要求，如输入验证、XSS/CSRF防护等（MFA已移除）。
  - [ ] **性能优化初步 (贯穿)**: 针对核心接口进行初步性能分析和优化，引入缓存机制。
- **交付物**:
  - 功能更完善的授权服务，支持RBAC。
  - 功能更丰富的管理界面。
  - 初版客户端SDK和中间件。
  - 安全性得到增强的系统。

### 阶段三: 测试、文档与交付准备 (预计 3-4 周)

- **目标**: 进行全面的系统测试，完善所有文档，修复缺陷，准备系统上线或交付。
- **主要任务**:
  - [ ] **全面集成测试与系统测试 (Week 12-13)**: 覆盖所有功能模块和典型用户场景。
  - [ ] **性能测试与调优 (Week 12)**: 执行详细的性能测试，根据结果进行调优，确保满足性能指标。
  - [ ] **安全测试与加固 (Week 13)**: 进行安全扫描和渗透测试（如果条件允许），修复发现的漏洞。
  - [ ] **文档编写与完善 (Week 12-14)**: 完成用户手册、管理员指南、API文档、运维文档等。
  - [ ] **Bug修复与回归测试 (贯穿)**。
  - [ ] **用户验收测试 (UAT) (Week 14)**: 邀请用户或利益相关者进行测试并收集反馈。
  - [ ] **部署演练与发布准备 (Week 14)**。
- **交付物**:
  - 经过全面测试、稳定可靠的认证授权系统。
  - 全套系统文档。
  - 测试报告（功能、性能、安全）。
  - 部署包和部署指南。

---

## 7. 风险评估与应对 (Risk Assessment & Mitigation)

| 风险类别         | 风险描述                                                                            | 可能性 | 影响程度 | 应对措施                                                                                                                              | 负责人     |
| :--------------- | :---------------------------------------------------------------------------------- | :----- | :------- | :------------------------------------------------------------------------------------------------------------------------------------ | :--------- |
| **技术风险**     | 对选型技术栈（如NestJS, Prisma, oidc-provider）的掌握程度不足，影响开发效率和质量。 | 中     | 中       | - 组织内部培训和知识分享。<br>- 鼓励团队成员学习官方文档和最佳实践。<br>- 在非核心模块先行试点。                                      | 技术负责人 |
| **项目管理风险** | 需求范围蔓延或频繁变更，导致项目延期。                                              | 中     | 高       | - 建立明确的需求变更控制流程。<br>- 定期与产品负责人沟通，确认需求优先级。<br>- 采用敏捷迭代开发，小步快跑，及时反馈。                | 项目经理   |
|                  | 核心开发人员流失或资源不足。                                                        | 低     | 高       | - 建立知识共享机制，避免单点故障。<br>- 培养备份人员。<br>- 及时招聘或调配资源。                                                      | 项目经理   |
| **安全风险**     | 系统存在未被发现的安全漏洞，导致数据泄露或服务被攻击。                              | 中     | 高       | - 严格遵循安全开发生命周期（SDL）。<br>- 代码审查，特别是安全相关模块。<br>- 定期进行安全扫描和渗透测试。<br>- 及时更新第三方依赖库。 | 安全负责人 |
|                  | OAuth客户端密钥或用户凭证管理不当导致泄露。                                         | 中     | 高       | - 强制执行强密码策略和MFA。<br>- 提供安全的客户端密钥管理机制（如一次性显示，支持轮换）。<br>- 对开发和运维人员进行安全意识培训。     | 安全负责人 |
| **集成风险**     | 与现有业务系统或身份源集成时，接口不兼容或流程复杂。                                | 中     | 中       | - 早期与相关系统负责人沟通，明确接口规范和集成方案。<br>- 进行充分的集成测试。<br>- 制定详细的集成计划和回滚方案。                    | 技术负责人 |
| **性能风险**     | 高并发场景下，系统性能不达标，影响用户体验。                                        | 中     | 高       | - 在设计阶段就考虑性能优化，如缓存策略、数据库优化。<br>- 进行充分的性能测试和压力测试。<br>- 监控关键性能指标，及时发现和解决瓶颈。  | 技术负责人 |
| **运维风险**     | 系统部署复杂，监控不到位，故障恢复慢。                                              | 低     | 中       | - 提供详细的部署和运维文档。<br>- 建立完善的监控告警体系。<br>- 制定应急预案和灾备方案。                                              | 运维负责人 |

---

## 8. 典型场景示例 (Typical Scenario Examples)

以下是一些典型的用户场景和异常场景，用于更好地理解系统的功能和流程。

### 8.1 典型用户与系统交互场景

**场景 8.1.1: 新员工入职与系统访问 (结合UC-2.1.1, UC-2.5.2, UC-2.8.1)**

1.  **HR管理员操作**: HR管理员（角色：HR_Admin）登录认证授权管理后台。
2.  在“用户管理”模块，为新员工John Doe创建一个账户，设置初始用户名，并分配初始角色“普通员工 (Employee)”。系统会生成一个一次性密码。
3.  **新员工John Doe操作**: John收到初始密码，首次登录系统。
4.  系统强制John修改初始密码。
5.  John成功登录后，访问内部应用A（一个OAuth客户端）。
6.  应用A将John重定向到认证授权中心进行登录和授权。
7.  John在认证中心确认授权（如果需要consent）。
8.  认证中心向应用A发放Access Token和ID Token。
9.  应用A使用Access Token代表John访问其被授权的API资源（例如，查看个人信息API、提交报销申请API）。权限验证服务会基于John的“Employee”角色及其关联的API权限进行校验。同时，应用A前端会根据John的菜单权限决定是否显示“个人信息查看”、“报销申请提交”等菜单项。

**场景 8.1.2: 后端服务间认证 (M2M - Machine to Machine) (结合UC-2.2.1, UC-2.3, UC-2.7)**

1.  **管理员操作**: 管理员在认证授权管理后台为“订单服务 (OrderService)”注册一个OAuth客户端，授权类型为“Client Credentials”，并为其分配必要的Scope，如 `orders:read` 和 `orders:write`。
2.  管理员将生成的Client ID和Client Secret安全地配置到“订单服务”中。
3.  **订单服务操作**: 当“订单服务”需要调用“库存服务 (InventoryService)”的受保护API（例如，查询商品库存）时：
    a. “订单服务”使用其Client ID和Client Secret向认证授权中心的令牌端点请求Access Token。
    b. 认证授权中心验证客户端凭证，并颁发一个具有相应Scope的Access Token。
4.  “订单服务”携带此Access Token调用“库存服务”的API。
5.  “库存服务”的权限中间件会调用认证授权中心的权限验证API (`/api/v1/auth/check`) 来验证该Access Token是否具有访问目标API所需的权限（例如，`inventory:read`）。

**场景 8.1.3: 管理员配置细粒度访问控制 (结合UC-2.5.2, UC-2.6.2, UC-2.8.2, UC-2.8.4)**

1.  **管理员操作**: 管理员（角色：Super_Admin）登录认证授权管理后台。
2.  **RBAC配置**:
    a. 创建一个新角色“财务经理 (Finance_Manager)”。
    b. 为“财务经理”角色分配权限点，如 `finance_report:view`, `payment:approve`。
3.  **ABAC策略配置 (示例)**: 为了实现“财务经理只能在办公网IP段内批准超过10000元的付款”，管理员创建一个ABAC策略：
    - **策略名称**: 大额支付审批IP限制
    - **主体条件**: `user.roles CONTAINS 'Finance_Manager'`
    - **资源条件**: `resource.type == 'payment' && resource.amount > 10000`
    - **操作条件**: `action.name == 'approve'`
    - **环境条件**: `env.ip_address IN ('192.168.1.0/24', '10.0.0.0/16')`
    - **效果**: Permit
    - **优先级**: 高于其他可能冲突的Deny策略。
4.  将用户Alice分配到“财务经理”角色。
5.  **权限验证**: 当Alice尝试从非办公网IP批准一笔15000元的付款时，即使其角色拥有 `payment:approve` 权限，ABAC策略也会因为环境条件不满足而导致最终权限被拒绝。

### 8.2 异常与边界场景处理

**场景 8.2.1: 用户忘记密码 (结合UC-2.1.1-004)**

1.  用户在登录页面点击“忘记密码”。
2.  输入注册时使用的邮箱地址。
3.  系统向该邮箱发送一封包含密码重置链接的邮件（链接应有时效性且一次性有效）。
4.  用户点击邮件中的链接，跳转到密码重置页面。
5.  用户输入新密码并确认，新密码需符合密码策略。
6.  密码重置成功，用户可以使用新密码登录。

**场景 8.2.2: Access Token 过期 (结合UC-2.2.2, UC-2.4.2)**

1.  用户正在使用应用A，其持有的Access Token已过期。
2.  当应用A使用过期的Access Token请求受保护资源时，资源服务器返回401 Unauthorized错误。
3.  应用A（客户端）应捕获此错误：
    a. 如果存在有效的Refresh Token，应用A静默地使用Refresh Token向认证授权中心的令牌端点请求新的Access Token和Refresh Token。
    b. 获取新令牌成功后，应用A使用新的Access Token重新尝试访问资源。
    c. 如果Refresh Token也已过期或无效，或者刷新失败，应用A应引导用户重新登录以获取新的令牌。

**场景 8.2.3: 尝试访问未授权资源 (结合UC-2.7)**

1.  用户John（角色：Employee）尝试访问一个需要“管理员 (Admin)”角色的管理功能API。
2.  API的权限中间件调用权限验证服务 (`/api/v1/auth/check`)，传递John的身份信息、目标资源和操作。
3.  权限验证服务根据John的角色和权限配置（以及任何适用的ABAC策略），判断其不具备所需权限。
4.  权限验证服务返回拒绝访问的决策。
5.  API向客户端返回403 Forbidden错误，并可能附带错误信息“权限不足”。

**场景 8.2.4: OAuth客户端密钥疑似泄露 (结合UC-2.3-001, UC-2.8.3)**

1.  管理员怀疑某个M2M客户端（如“报表服务”）的Client Secret已泄露。
2.  管理员登录认证授权管理后台，进入“客户端管理”模块。
3.  找到“报表服务”客户端的配置。
4.  执行“重置Client Secret”操作。系统生成一个新的Client Secret。
5.  管理员将新的Client Secret安全地更新到“报表服务”的配置中。
6.  （可选）管理员可以暂时禁用该客户端，直到密钥更新完成，以防止在过渡期间被滥用。
7.  旧的Client Secret立即失效。

---

## 9. v2 API架构设计

### 9.1 API版本管理

基于API路由优化分析，系统将实现清晰的API版本管理策略：

- **v1 API**：保持向后兼容性，逐步迁移现有功能
- **v2 API**：新的标准化架构，消除80%的路由重复
- **版本控制**：通过URL路径进行版本控制（如 `/api/v1/*` 和 `/api/v2/*`）

### 9.2 v2 API核心域

- **`/api/v2/auth/*`**：用户认证相关接口
- **`/api/v2/oauth/*`**：OAuth2.1标准认证接口
- **`/api/v2/users/*`**：用户管理接口
- **`/api/v2/rbac/*`**：角色权限管理接口
- **`/api/v2/system/*`**：系统管理接口
- **`/api/v2/audit/*`**：审计日志接口

### 9.3 RESTful标准化

所有v2 API将严格遵循RESTful设计原则：
- 使用标准HTTP方法（GET、POST、PUT、DELETE）
- 统一的响应格式和错误处理
- 清晰的资源命名和层级结构

---

## 10. 性能优化与监控

### 10.1 数据库性能优化

- **索引优化**：针对高频查询添加复合索引，实现30%性能提升
- **查询优化**：优化复杂查询语句，减少数据库负载
- **连接池管理**：优化数据库连接池配置

### 10.2 缓存策略

- **Redis权限缓存**：缓存用户权限信息，实现毫秒级权限验证
- **会话缓存**：优化用户会话管理
- **配置缓存**：缓存系统配置信息

### 10.3 性能监控指标

- **API响应时间**：P99 < 50ms（权限验证）
- **数据库性能**：查询响应时间监控
- **缓存命中率**：Redis缓存命中率 > 90%
- **系统吞吐量**：并发请求处理能力

### 10.4 审计与监控

- **完整审计追踪**：所有操作的详细日志记录
- **实时监控**：系统性能和安全状态监控
- **告警机制**：异常情况的及时通知
- **合规报告**：定期生成合规性报告

---
